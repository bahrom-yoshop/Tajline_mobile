import React, { useState, useEffect, useRef } from 'react';
import { Html5QrcodeScanner, Html5Qrcode, Html5QrcodeScannerState, Html5QrcodeScanType } from "html5-qrcode";
import './App.css';
import { Button } from './components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from './components/ui/card';
import { Input } from './components/ui/input';
import { Label } from './components/ui/label';
import { Tabs, TabsContent, TabsList, TabsTrigger } from './components/ui/tabs';
import { Badge } from './components/ui/badge';
import { Alert, AlertDescription } from './components/ui/alert';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from './components/ui/dialog';
import { Accordion, AccordionContent, AccordionItem, AccordionTrigger } from './components/ui/accordion';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from './components/ui/select';
import { Textarea } from './components/ui/textarea';
import { Checkbox } from './components/ui/checkbox';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from './components/ui/table';
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuSeparator, DropdownMenuTrigger } from './components/ui/dropdown-menu';
import DataPagination from './components/DataPagination'; // –ù–æ–≤—ã–π –∫–æ–º–ø–æ–Ω–µ–Ω—Ç –ø–∞–≥–∏–Ω–∞—Ü–∏–∏
import YandexMap from './components/YandexMap'; // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç
import CourierGPSTracker from './components/CourierGPSTracker'; // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç GPS –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
import CourierTrackingMap from './components/CourierTrackingMap'; // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç—ã –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–æ–≤
import CourierHistoryAnalytics from './components/CourierHistoryAnalytics'; // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∏—Å—Ç–æ—Ä–∏–∏ –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∫—É—Ä—å–µ—Ä–æ–≤
import RouteMap from './components/RouteMap'; // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç—ã –º–∞—Ä—à—Ä—É—Ç–∞ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≥—Ä—É–∑–∞
import SimpleRouteMap from './components/SimpleRouteMap'; // –ü—Ä–æ—Å—Ç–∞—è —Ç–µ—Å—Ç–æ–≤–∞—è –∫–∞—Ä—Ç–∞
import DevBadge from './components/DevBadge'; // –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –Ω–æ–º–µ—Ä–æ–≤ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
import DevControl from './components/DevControl'; // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞–º–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞
import { getDevNumber } from './constants/devNumbers'; // –°–∏—Å—Ç–µ–º–∞ –Ω—É–º–µ—Ä–∞—Ü–∏–∏
import { 
  Truck, Package, Users, Bell, Search, Plus, Edit, Trash2, CheckCircle, 
  Clock, MapPin, User, Shield, Warehouse, Menu, X, Building, 
  DollarSign, FileText, Grid3X3, Package2, Home, CreditCard, Printer, Zap, MessageCircle,
  QrCode, Camera, Download, Calculator, ShoppingCart, RefreshCw, Eye, XCircle, Save, Filter,
  ArrowUp, Ban, Settings, Copy, Minus, Palette, UserCheck, BarChart, Maximize, ArrowLeft, Edit3, BarChart3,
  Scan, Target, Circle, MousePointer, Phone, MessageSquare, Send, ExternalLink, UserX, Lock, Grid, List, RotateCw
} from 'lucide-react';

const BACKEND_URL = 'https://tajline-cargo-8.preview.emergentagent.com';
console.log('üîç DEBUG: HARDCODED BACKEND_URL:', BACKEND_URL);

function App() {
  const [user, setUser] = useState(null);
  const [token, setToken] = useState(localStorage.getItem('token'));
  // Navigation states
  const [activeTab, setActiveTab] = useState('dashboard');
  const [activeSection, setActiveSection] = useState('dashboard');
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [currentPage, setCurrentPage] = useState('main'); // 'main', 'cargo-placement'
  
  // –ù–û–í–û–ï: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–µ
  const [isInitializing, setIsInitializing] = useState(true);
  const [dataLoaded, setDataLoaded] = useState(false);
  
  const [notifications, setNotifications] = useState([]);
  const [warehouseNotifications, setWarehouseNotifications] = useState([]);
  const [allPickupRequests, setAllPickupRequests] = useState([]);
  const [pickupRequestsHistory, setPickupRequestsHistory] = useState([]);
  const [showCargoAcceptanceModal, setShowCargoAcceptanceModal] = useState(false);
  const [currentCargoNotification, setCurrentCargoNotification] = useState(null);
  const [showAllNotifications, setShowAllNotifications] = useState(false);
  const [showAllNewRequests, setShowAllNewRequests] = useState(false);
  const [showAllAcceptedRequests, setShowAllAcceptedRequests] = useState(false);
  const [cargoAcceptanceForm, setCargoAcceptanceForm] = useState({
    sender_full_name: '',
    sender_phone: '',
    sender_address: '',
    recipient_full_name: '',
    recipient_phone: '',
    recipient_address: '',
    cargo_items: [{ name: '', weight: '', price: '' }],
    payment_method: '',
    delivery_method: '',
    payment_status: 'not_paid',
    amount_paid: '',
    payment_notes: ''
  });

  // –ù–û–í–û–ï: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –º–∞—Ä—à—Ä—É—Ç–µ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –≥—Ä—É–∑–∞
  const [routeInfo, setRouteInfo] = useState({
    distance: '',
    duration: '',
    distanceValue: 0,
    durationValue: 0
  });

  const [cargo, setCargo] = useState([]);
  const [users, setUsers] = useState([]);
  const [usersPagination, setUsersPagination] = useState({}); // –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  const [usersPage, setUsersPage] = useState(1);
  const [usersPerPage, setUsersPerPage] = useState(25);
  const [warehouses, setWarehouses] = useState([]);
  const [warehousesStatistics, setWarehousesStatistics] = useState({}); // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∫–ª–∞–¥–æ–≤
  const [warehouseCargo, setWarehouseCargo] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState([]);
  const [trackingNumber, setTrackingNumber] = useState('');
  const [trackingResult, setTrackingResult] = useState(null);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const [userStatusModal, setUserStatusModal] = useState(false);
  const [userStatusData, setUserStatusData] = useState(null);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  const [loginErrorModal, setLoginErrorModal] = useState(false);
  const [loginErrorData, setLoginErrorData] = useState(null);
  
  // –¢–µ—Å—Ç–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ (–¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏)
  const [testModal, setTestModal] = useState(false);
  
  // Ref –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è React state batching –ø—Ä–∏ –æ—à–∏–±–∫–∞—Ö –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  const loginErrorRef = useRef({ modal: false, data: null });

  // –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞ (–§—É–Ω–∫—Ü–∏—è 1)
  const [clientDashboard, setClientDashboard] = useState(null);
  const [clientCargo, setClientCargo] = useState([]);
  const [clientCargoDetails, setClientCargoDetails] = useState(null);

  // –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (–§—É–Ω–∫—Ü–∏—è 2)
  const [operatorCreateForm, setOperatorCreateForm] = useState({
    full_name: '',
    phone: '',
    address: '',
    password: '',
    warehouse_id: ''
  });
  const [operatorCreationModal, setOperatorCreationModal] = useState(false);
  const [allOperators, setAllOperators] = useState([]);

  // –ù–û–í–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø –î–õ–Ø –ö–£–†–¨–ï–†–°–ö–û–ô –°–õ–£–ñ–ë–´ (–≠–¢–ê–ü 2)
  const [couriers, setCouriers] = useState([]);
  const [inactiveCouriers, setInactiveCouriers] = useState([]);
  const [couriersPagination, setCouriersPagination] = useState({});
  const [couriersPage, setCouriersPage] = useState(1);
  const [couriersPerPage, setCouriersPerPage] = useState(25);
  const [showInactiveCouriers, setShowInactiveCouriers] = useState(false); // –ù–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–æ–∫–∞–∑–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤
  const [courierCreateForm, setCourierCreateForm] = useState({
    full_name: '',
    phone: '',
    password: '',
    address: '',
    transport_type: 'car',
    transport_number: '',
    transport_capacity: '',
    assigned_warehouse_id: ''
  });
  const [courierCreateModal, setCourierCreateModal] = useState(false);
  const [selectedCourier, setSelectedCourier] = useState(null);
  const [courierProfileModal, setCourierProfileModal] = useState(false);
  
  // –ù–û–í–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø –î–õ–Ø –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù –ü–†–û–°–ú–û–¢–†–ê –ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ó–ê–Ø–í–û–ö
  const [requestViewModal, setRequestViewModal] = useState(false);
  const [requestEditModal, setRequestEditModal] = useState(false);
  const [selectedRequest, setSelectedRequest] = useState(null);
  const [senderContactModal, setSenderContactModal] = useState(false);
  const [contactSender, setContactSender] = useState(null);
  const [requestEditForm, setRequestEditForm] = useState({
    sender_full_name: '',
    sender_phone: '',
    sender_address: '',
    recipient_full_name: '',
    recipient_phone: '',
    recipient_address: '',
    cargo_items: [{
      name: '',
      weight: '',
      price_per_kg: '',
      total_price: ''
    }],
    total_weight: '',
    total_value: '',
    payment_method: 'not_paid',
    payment_received: false,
    delivery_method: 'pickup',
    pickup_address: '',
    pickup_date: '',
    pickup_time: '',
    special_instructions: ''
  });
  const [courierEditForm, setCourierEditForm] = useState({}); 
  const [courierEditModal, setCourierEditModal] = useState(false);
  const [courierRequests, setCourierRequests] = useState([]);
  const [availableCouriers, setAvailableCouriers] = useState([]);
  
  // –ù–û–í–û–ï: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ –º–µ–Ω—é –∫—É—Ä—å–µ—Ä–∞
  const [courierMobileMenuOpen, setCourierMobileMenuOpen] = useState(false);
  
  // –ù–û–í–û–ï: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–æ–π –∫–∞—Ä—Ç—ã
  const [isMapOpen, setIsMapOpen] = useState(false);
  
  // –ù–û–í–û–ï: –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —è—á–µ–π–∫–∞–º–∏
  const [cellManagementModal, setCellManagementModal] = useState(false);
  const [selectedWarehouseForCells, setSelectedWarehouseForCells] = useState(null);
  const [cellsLoading, setCellsLoading] = useState(false);
  const [cellEditForm, setCellEditForm] = useState({
    blocks_count: '',
    shelves_per_block: '',
    cells_per_shelf: ''
  });
  
  // –ù–û–í–û–ï: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ QR –∫–æ–¥–∞ —è—á–µ–π–∫–∏
  const [cellQRModal, setCellQRModal] = useState(false);
  const [isAcceptedMapOpen, setIsAcceptedMapOpen] = useState(false);
  
  // –ù–û–í–û–ï: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è GPS –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞
  const [courierTracking, setCourierTracking] = useState({
    isTracking: false,
    status: 'offline', // offline, online, on_route, at_pickup, at_delivery, busy
    lastUpdate: null,
    coordinates: null,
    accuracy: null,
    watchId: null,
    error: null,
    updateInterval: null
  });

  // –ù–û–í–û–ï: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ä–µ–∂–∏–º–∞ –∑–∞–±–æ—Ä–∞ –≥—Ä—É–∑–∞
  const [isPickupMode, setIsPickupMode] = useState(false);
  // –ù–û–í–û–ï: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Ñ–æ—Ä–º—ã –ø—Ä–∏—ë–º–∞ –≥—Ä—É–∑–∞ —á–µ—Ä–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
  const [showOperatorCargoForm, setShowOperatorCargoForm] = useState(false);
  const [senderPhones, setSenderPhones] = useState(['']); // –ú–∞—Å—Å–∏–≤ —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
  
  // –ù–û–í–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø –î–õ–Ø –£–õ–£–ß–®–ï–ù–ò–ô –ò–ù–¢–ï–†–§–ï–ô–°–ê –ö–£–†–¨–ï–†–ê
  const [courierChatModal, setCourierChatModal] = useState(false);
  const [courierProfileEditForm, setCourierProfileEditForm] = useState({
    full_name: '',
    phone: '',
    address: '',
    current_password: '',
    new_password: '',
    confirm_password: ''
  });

  // –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≥—Ä—É–∑–∞ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
  const [cargoOrderForm, setCargoOrderForm] = useState({
    cargo_name: '',
    description: '',
    weight: '',
    declared_value: '80', // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ú–æ—Å–∫–≤–∞ ‚Üí –î—É—à–∞–Ω–±–µ
    recipient_full_name: '',
    recipient_phone: '',
    recipient_address: '',
    recipient_city: '',
    route: 'moscow_dushanbe',
    delivery_type: 'standard',
    insurance_requested: false,
    insurance_value: '',
    packaging_service: false,
    home_pickup: false,
    home_delivery: false,
    fragile: false,
    temperature_sensitive: false,
    special_instructions: ''
  });
  const [deliveryOptions, setDeliveryOptions] = useState(null);
  const [costCalculation, setCostCalculation] = useState(null);
  const [isCalculating, setIsCalculating] = useState(false);
  const [cargoOrderResult, setCargoOrderResult] = useState(null);

  // –°–û–°–¢–û–Ø–ù–ò–Ø –î–õ–Ø –ü–ï–ß–ê–¢–ò QR –ö–û–î–û–í (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –≤—ã—à–µ –¥–ª—è —É—Å—Ç—Ä–∞–Ω–µ–Ω–∏—è –æ—à–∏–±–∫–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏)
  const [qrPrintMode, setQrPrintMode] = useState(false); // –†–µ–∂–∏–º –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–æ–≤
  const [selectedUnitsForPrint, setSelectedUnitsForPrint] = useState([]); // –í—ã–±—Ä–∞–Ω–Ω—ã–µ units –¥–ª—è –ø–µ—á–∞—Ç–∏
  const [qrPrintLayout, setQrPrintLayout] = useState('grid_3x3'); // –ú–∞–∫–µ—Ç –ø–µ—á–∞—Ç–∏
  const [qrGenerationProgress, setQrGenerationProgress] = useState(null); // –ü—Ä–æ–≥—Ä–µ—Å—Å –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR
  const [generatedQrBatch, setGeneratedQrBatch] = useState(null); // –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ QR –∫–æ–¥—ã
  const [printLayoutOptions, setPrintLayoutOptions] = useState(null); // –û–ø—Ü–∏–∏ –º–∞–∫–µ—Ç–æ–≤ –ø–µ—á–∞—Ç–∏
  const [selectedUnitForActions, setSelectedUnitForActions] = useState(null); // –í—ã–±—Ä–∞–Ω–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –¥–ª—è –¥–µ–π—Å—Ç–≤–∏–π

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ó–ê–ö–ê–ó–ê–ú–ò –ö–õ–ò–ï–ù–¢–û–í

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ–±—ä—è–≤–ª–µ–Ω–Ω–æ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –º–∞—Ä—à—Ä—É—Ç–∞
  const getDefaultDeclaredValue = (route) => {
    switch(route) {
      case 'moscow_khujand':
        return '60'; // –ú–æ—Å–∫–≤–∞ ‚Üí –•—É–¥–∂–∞–Ω–¥: 60 —Ä—É–±–ª–µ–π
      case 'moscow_dushanbe':
        return '80'; // –ú–æ—Å–∫–≤–∞ ‚Üí –î—É—à–∞–Ω–±–µ: 80 —Ä—É–±–ª–µ–π
      case 'moscow_kulob':
        return '80'; // –ú–æ—Å–∫–≤–∞ ‚Üí –ö—É–ª–æ–±: 80 —Ä—É–±–ª–µ–π 
      case 'moscow_kurgantyube':
        return '80'; // –ú–æ—Å–∫–≤–∞ ‚Üí –ö—É—Ä–≥–∞–Ω-–¢—é–±–µ: 80 —Ä—É–±–ª–µ–π
      case 'moscow_to_tajikistan':
        return '80'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –æ–±—â–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞
      default:
        return '80'; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é
    }
  };

  // –§–£–ù–ö–¶–ò–Ø –û–ß–ò–°–¢–ö–ò –í–°–ï–• –î–ê–ù–ù–´–• –ü–†–ò–õ–û–ñ–ï–ù–ò–Ø
  const clearAllAppData = () => {
    console.log('üßπ Clearing all app data...');
    setCargo([]);
    setUsers([]);
    setWarehouses([]);
    setOperatorCargo([]);
    setAvailableCargo([]);
    setCargoHistory([]);
    setUnpaidCargo([]);
    setPaymentHistory([]);
    setNotifications([]);
    setWarehouseNotifications([]);
    setAllPickupRequests([]);
    setPickupRequestsHistory([]);
    setUsersByRole({ user: [], admin: [], warehouse_operator: [] });
    setTransports([]);
    setSelectedTransport(null);
    setTransportCargoList([]);
    setAvailableCargoForTransport([]);
    setSelectedCargoForPlacement([]);
    setOperatorWarehouseBindings([]);
    setCouriers([]);
    setAcceptedRequests([]);
    setPickedRequests([]);
    setCancelledRequests([]);
    setAvailableCouriers([]);
    setCourierRequests([]);
    setClientCargo([]);
    setClientDashboard(null);
    setAllOperators([]);
    setCargoBreakdown([]);
    setDebtorsList([]);
    setWarehouseSchemeData([]);
    setWarehouseCells([]);
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—á–∏—Å—Ç–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    setOperatorDashboardAnalytics(null);
    setAdminDashboardAnalytics(null);
    setDataLoaded(false);
  };

  // –§–£–ù–ö–¶–ò–ò –£–ü–†–ê–í–õ–ï–ù–ò–Ø –Ø–ß–ï–ô–ö–ê–ú–ò –°–ö–õ–ê–î–ê
  const openCellManagement = (warehouse) => {
    setSelectedWarehouseForCells(warehouse);
    setCellEditForm({
      blocks_count: warehouse.blocks_count || '',
      shelves_per_block: warehouse.shelves_per_block || '',
      cells_per_shelf: warehouse.cells_per_shelf || ''
    });
    setCellManagementModal(true);
    fetchWarehouseCells(warehouse.id);
  };

  const fetchWarehouseCells = async (warehouseId) => {
    setCellsLoading(true);
    try {
      const response = await apiCall(`/api/warehouses/${warehouseId}/cells`, 'GET');
      setWarehouseCells(response.cells || []);
    } catch (error) {
      console.error('Error fetching warehouse cells:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —è—á–µ–µ–∫: ' + error.message, 'error');
      setWarehouseCells([]);
    } finally {
      setCellsLoading(false);
    }
  };

  const handleUpdateWarehouseStructure = async () => {
    if (!selectedWarehouseForCells) return;
    
    try {
      const updateData = {
        blocks_count: parseInt(cellEditForm.blocks_count),
        shelves_per_block: parseInt(cellEditForm.shelves_per_block),
        cells_per_shelf: parseInt(cellEditForm.cells_per_shelf)
      };
      
      await apiCall(`/api/warehouses/${selectedWarehouseForCells.id}/structure`, 'PUT', updateData);
      
      showAlert('–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∫–ª–∞–¥–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞', 'success');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
      fetchWarehouses();
      fetchWarehouseCells(selectedWarehouseForCells.id);
      
    } catch (error) {
      console.error('Error updating warehouse structure:', error);
      showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä—É–∫—Ç—É—Ä—ã: ' + error.message, 'error');
    }
  };

  const handleGenerateCellQR = async (cellId, cellLocation) => {
    try {
      setGeneratingSelectedCellQR(true);
      const response = await apiCall(`/api/warehouses/cells/${cellId}/qr`, 'GET');
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
      setSelectedCellQR({
        cellId: cellId,
        cellLocation: cellLocation,
        warehouseName: selectedWarehouseForCells?.name || '–°–∫–ª–∞–¥',
        qrCode: response.qr_code,
        qrData: response.qr_data
      });
      
      setCellQRModal(true);
      
    } catch (error) {
      console.error('Error generating cell QR:', error);
      showAlert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞: ' + error.message, 'error');
    } finally {
      setGeneratingSelectedCellQR(false);
    }
  };
  
  const handlePrintCellQR = () => {
    if (!selectedCellQR) return;
    
    // –°–æ–∑–¥–∞–µ–º —É–ª—É—á—à–µ–Ω–Ω—ã–π —à–∞–±–ª–æ–Ω –ø–µ—á–∞—Ç–∏ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º–∏ –æ—Ç—Å—Ç—É–ø–∞–º–∏
    const qrWindow = window.open('', '_blank');
    if (qrWindow) {
      qrWindow.document.write(`
        <html>
          <head>
            <title>QR –∫–æ–¥ —è—á–µ–π–∫–∏ ${selectedCellQR.cellLocation}</title>
            <style>
              body { 
                font-family: Arial, sans-serif; 
                text-align: center; 
                margin: 0;
                padding: 10px;
                background: white;
              }
              .qr-container { 
                display: inline-block;
                border: 1px solid #ddd;
                padding: 15px;
                background: white;
              }
              .cell-location { 
                font-size: 24px; 
                font-weight: bold; 
                margin-bottom: 5px;
                color: #333;
              }
              .qr-code { 
                margin: 5px 0;
              }
              .qr-data {
                font-size: 14px;
                color: #666;
                margin-top: 5px;
              }
              @media print {
                body { margin: 0; padding: 5px; }
                .qr-container { border: none; }
              }
            </style>
          </head>
          <body>
            <div class="qr-container">
              <div class="cell-location">${selectedCellQR.cellLocation}</div>
              <div class="qr-code">
                <img src="${selectedCellQR.qrCode}" alt="QR –∫–æ–¥ —è—á–µ–π–∫–∏" style="width: 200px; height: 200px;" />
              </div>
              <div class="qr-data">–ö–æ–¥: ${selectedCellQR.qrData || 'N/A'}</div>
            </div>
            <script>
              window.onload = function() {
                setTimeout(function() {
                  window.print();
                }, 500);
              }
            </script>
          </body>
        </html>
      `);
      qrWindow.document.close();
    }
  };

  const handleGenerateAllCellsQR = async () => {
    if (!selectedWarehouseForCells) return;
    
    try {
      const response = await apiCall(`/api/warehouses/${selectedWarehouseForCells.id}/cells/qr-batch`, 'GET');
      
      // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —Å –º–∞—Å—Å–æ–≤—ã–º–∏ QR –∫–æ–¥–∞–º–∏
      const qrWindow = window.open('', '_blank');
      if (qrWindow) {
        let qrContent = `
          <html>
            <head>
              <title>QR –∫–æ–¥—ã –≤—Å–µ—Ö —è—á–µ–µ–∫ - ${selectedWarehouseForCells.name}</title>
              <style>
                body { 
                  font-family: Arial, sans-serif; 
                  padding: 20px; 
                }
                .warehouse-title { 
                  text-align: center; 
                  font-size: 24px; 
                  font-weight: bold; 
                  margin-bottom: 30px; 
                }
                .qr-grid { 
                  display: grid; 
                  grid-template-columns: repeat(3, 1fr); 
                  gap: 20px; 
                  page-break-inside: avoid; 
                }
                .qr-item { 
                  text-align: center; 
                  border: 1px solid #ddd; 
                  padding: 10px; 
                  page-break-inside: avoid; 
                }
                .cell-label { 
                  font-weight: bold; 
                  margin-bottom: 5px; 
                }
                @media print { 
                  .qr-grid { grid-template-columns: repeat(2, 1fr); } 
                }
              </style>
            </head>
            <body>
              <div class="warehouse-title">QR –∫–æ–¥—ã —è—á–µ–µ–∫ - ${selectedWarehouseForCells.name}</div>
              <div class="qr-grid">
        `;
        
        response.qr_codes.forEach(item => {
          qrContent += `
            <div class="qr-item">
              <div class="cell-label">${item.cell_location}</div>
              <img src="${item.qr_code}" alt="QR –∫–æ–¥ ${item.cell_location}" style="max-width: 150px; height: auto;" />
            </div>
          `;
        });
        
        qrContent += `
              </div>
              <div style="text-align: center; margin-top: 20px;">
                <button onclick="window.print()">–ü–µ—á–∞—Ç—å –≤—Å–µ—Ö QR –∫–æ–¥–æ–≤</button>
              </div>
            </body>
          </html>
        `;
        
        qrWindow.document.write(qrContent);
        qrWindow.document.close();
      }
      
    } catch (error) {
      console.error('Error generating batch QR codes:', error);
      showAlert('–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤: ' + error.message, 'error');
    }
  };

  const handleDeleteSelectedCells = async () => {
    if (selectedCells.length === 0) {
      showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —è—á–µ–π–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'warning');
      return;
    }
    
    if (!confirm(`–£–¥–∞–ª–∏—Ç—å ${selectedCells.length} –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö —è—á–µ–µ–∫?`)) {
      return;
    }
    
    try {
      await apiCall(`/api/warehouses/${selectedWarehouseForCells.id}/cells/batch-delete`, 'POST', {
        cell_ids: selectedCells
      });
      
      showAlert(`–£–¥–∞–ª–µ–Ω–æ ${selectedCells.length} —è—á–µ–µ–∫`, 'success');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
      fetchWarehouseCells(selectedWarehouseForCells.id);
      fetchWarehouses();
      setSelectedCells([]);
      
    } catch (error) {
      console.error('Error deleting cells:', error);
      showAlert('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —è—á–µ–µ–∫: ' + error.message, 'error');
    }
  };

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ö–£–†–¨–ï–†–°–ö–û–ô –°–õ–£–ñ–ë–´ (–≠–¢–ê–ü 2)
  const fetchCouriers = async (page = 1, perPage = 25) => {
    try {
      // –û–ë–ù–û–í–õ–ï–ù–û: –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä show_inactive –¥–ª—è –ø–æ–∫–∞–∑–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤
      const params = new URLSearchParams({
        page: page.toString(),
        per_page: perPage.toString()
      });
      
      // –¢–æ–ª—å–∫–æ –∞–¥–º–∏–Ω—ã –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤
      if (showInactiveCouriers && user?.role === 'admin') {
        params.append('show_inactive', 'true');
      }
      
      const data = await apiCall(`/api/admin/couriers/list?${params.toString()}`);
      setCouriers(data.items || []);
      setCouriersPagination(data.pagination || {});
      
      console.log(`üìã –ó–∞–≥—Ä—É–∂–µ–Ω—ã –∫—É—Ä—å–µ—Ä—ã (—Å—Ç—Ä. ${page}): ${(data.items || []).length} –∫—É—Ä—å–µ—Ä–æ–≤${showInactiveCouriers ? ' (–≤–∫–ª—é—á–∞—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö)' : ' (—Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ)'}`);
    } catch (error) {
      console.error('Error fetching couriers:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∫—É—Ä—å–µ—Ä–æ–≤: ' + error.message, 'error');
    }
  };

  const handleCreateCourier = async (e) => {
    e.preventDefault();
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è —Ñ–æ—Ä–º—ã
    if (!courierCreateForm.full_name.trim()) {
      showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û –∫—É—Ä—å–µ—Ä–∞', 'error');
      return;
    }
    
    if (!courierCreateForm.phone.trim()) {
      showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∫—É—Ä—å–µ—Ä–∞', 'error');
      return;
    }
    
    if (!courierCreateForm.password.trim()) {
      showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–∞—Ä–æ–ª—å –∫—É—Ä—å–µ—Ä–∞', 'error');
      return;
    }
    
    if (!courierCreateForm.assigned_warehouse_id) {
      showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥ –¥–ª—è –∫—É—Ä—å–µ—Ä–∞', 'error');
      return;
    }

    try {
      const response = await apiCall('/api/admin/couriers/create', 'POST', courierCreateForm);
      
      showAlert('–ö—É—Ä—å–µ—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 'success');
      
      // –ü–æ–∫–∞–∑–∞—Ç—å —É—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      if (response.login_credentials) {
        showAlert(`–£—á–µ—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∫—É—Ä—å–µ—Ä–∞: ${response.login_credentials.phone} / ${response.login_credentials.password}`, 'info');
      }
      
      // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
      setCourierCreateForm({
        full_name: '',
        phone: '',
        password: '',
        address: '',
        transport_type: 'car',
        transport_number: '',
        transport_capacity: '',
        assigned_warehouse_id: ''
      });
      
      setCourierCreateModal(false);
      fetchCouriers(couriersPage, couriersPerPage);
      
    } catch (error) {
      console.error('Error creating courier:', error);
      showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞: ' + error.message, 'error');
    }
  };

  const handleViewCourierProfile = async (courierId) => {
    try {
      const data = await apiCall(`/api/admin/couriers/${courierId}`);
      setSelectedCourier(data);
      setCourierProfileModal(true);
    } catch (error) {
      console.error('Error fetching courier profile:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –∫—É—Ä—å–µ—Ä–∞: ' + error.message, 'error');
    }
  };

  const handleEditCourier = (courier) => {
    setCourierEditForm({
      full_name: courier.full_name,
      phone: courier.phone,
      address: courier.address,
      transport_type: courier.transport_type,
      transport_number: courier.transport_number,
      transport_capacity: courier.transport_capacity,
      assigned_warehouse_id: courier.assigned_warehouse_id,
      password: 'unchanged' // –ü–∞—Ä–æ–ª—å –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
    });
    setSelectedCourier(courier);
    setCourierEditModal(true);
  };

  const handleUpdateCourier = async (e) => {
    e.preventDefault();
    if (!selectedCourier) return;

    try {
      // –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–æ–ª—å –µ—Å–ª–∏ –æ–Ω –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è
      const updateData = { ...courierEditForm };
      if (updateData.password === 'unchanged') {
        delete updateData.password;
      }

      await apiCall(`/api/admin/couriers/${selectedCourier.id}`, 'PUT', updateData);
      
      showAlert('–ü—Ä–æ—Ñ–∏–ª—å –∫—É—Ä—å–µ—Ä–∞ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
      setCourierEditModal(false);
      fetchCouriers(couriersPage, couriersPerPage);
      
      // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç –ø—Ä–æ—Ñ–∏–ª—å, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
      if (courierProfileModal) {
        handleViewCourierProfile(selectedCourier.id);
      }
      
    } catch (error) {
      console.error('Error updating courier:', error);
      showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞: ' + error.message, 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤
  const fetchInactiveCouriers = async () => {
    try {
      console.log('üìã –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤...');
      const data = await apiCall('/api/admin/couriers/inactive');
      setInactiveCouriers(data.inactive_couriers || []);
      console.log(`üìã –ó–∞–≥—Ä—É–∂–µ–Ω—ã –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∫—É—Ä—å–µ—Ä—ã: ${(data.inactive_couriers || []).length} –∫—É—Ä—å–µ—Ä–æ–≤`);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤:', error);
      setInactiveCouriers([]);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤', 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫—É—Ä—å–µ—Ä–∞
  const handleActivateCourier = async (courierId, courierName) => {
    if (!window.confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫—É—Ä—å–µ—Ä–∞ "${courierName}"? –ü–æ—Å–ª–µ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫—É—Ä—å–µ—Ä —Å–º–æ–∂–µ—Ç —Å–Ω–æ–≤–∞ –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞—è–≤–∫–∏.`)) {
      return;
    }

    try {
      const response = await apiCall(`/api/admin/couriers/${courierId}/activate`, 'POST');
      showAlert(response.message || `–ö—É—Ä—å–µ—Ä "${courierName}" —É—Å–ø–µ—à–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω`, 'success');
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤ –±–µ–∑ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö
      const currentShowInactive = showInactiveCouriers;
      if (currentShowInactive) {
        // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –ø–æ–∫–∞–∑ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö
        setShowInactiveCouriers(false);
        
        // –ñ–¥–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è, –∑–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤
        setTimeout(async () => {
          await fetchCouriers();
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É
          setShowInactiveCouriers(currentShowInactive);
        }, 100);
      } else {
        // –ï—Å–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏—Å—å, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        await fetchCouriers();
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤
      await fetchInactiveCouriers();
      
      console.log(`‚úÖ –ö—É—Ä—å–µ—Ä ${courierName} –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω –∏ —Å–ø–∏—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã`);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫—É—Ä—å–µ—Ä–∞:', error);
      showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∫—É—Ä—å–µ—Ä–∞: ${error.message}`, 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –ø–æ–ª–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞
  const handlePermanentDeleteCourier = async (courierId, courierName) => {
    if (!window.confirm(`‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞ "${courierName}"!\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç:\n‚Ä¢ –î–∞–Ω–Ω—ã–µ –∫—É—Ä—å–µ—Ä–∞ –∏–∑ —Å–∏—Å—Ç–µ–º—ã\n‚Ä¢ –°–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è\n‚Ä¢ –ò—Å—Ç–æ—Ä–∏—é –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–π\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã?`)) {
      return;
    }

    // –î–≤–æ–π–Ω–æ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–ª—è –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è
    if (!window.confirm(`–ü–æ—Å–ª–µ–¥–Ω–µ–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ: —É–¥–∞–ª–∏—Ç—å –∫—É—Ä—å–µ—Ä–∞ "${courierName}" –ù–ê–í–°–ï–ì–î–ê?`)) {
      return;
    }

    try {
      const response = await apiCall(`/api/admin/couriers/${courierId}/permanent`, 'DELETE');
      showAlert(response.message || `–ö—É—Ä—å–µ—Ä "${courierName}" –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω –∏–∑ —Å–∏—Å—Ç–µ–º—ã`, 'success');
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–≤
      const currentShowInactive = showInactiveCouriers;
      if (currentShowInactive) {
        // –í—Ä–µ–º–µ–Ω–Ω–æ –æ—Ç–∫–ª—é—á–∞–µ–º –ø–æ–∫–∞–∑ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã—Ö
        setShowInactiveCouriers(false);
        
        // –ñ–¥–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è, –∑–∞—Ç–µ–º –∑–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤
        setTimeout(async () => {
          await fetchCouriers();
          // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é –Ω–∞—Å—Ç—Ä–æ–π–∫—É
          setShowInactiveCouriers(currentShowInactive);
        }, 100);
      } else {
        // –ï—Å–ª–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–ª–∏—Å—å, –ø—Ä–æ—Å—Ç–æ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
        await fetchCouriers();
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤
      await fetchInactiveCouriers();
      
      console.log(`‚úÖ –ö—É—Ä—å–µ—Ä ${courierName} –ø–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–µ–Ω –∏ —Å–ø–∏—Å–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã`);
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫—É—Ä—å–µ—Ä–∞:', error);
      showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫—É—Ä—å–µ—Ä–∞: ${error.message}`, 'error');
    }
  };
  const handleDeleteCourier = async (courier) => {
    try {
      console.log('üóëÔ∏è –ù–∞—á–∏–Ω–∞–µ–º —É–¥–∞–ª–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞:', courier.full_name);
      
      // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è
      const confirmDelete = window.confirm(
        `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∫—É—Ä—å–µ—Ä–∞ "${courier.full_name}"?\n\n` +
        `–¢–µ–ª–µ—Ñ–æ–Ω: ${courier.phone}\n` +
        `–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç: ${courier.transport_type} ${courier.transport_number}\n` +
        `–°–∫–ª–∞–¥: ${courier.assigned_warehouse_name}\n\n` +
        `–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`
      );
      
      if (!confirmDelete) {
        console.log('‚ùå –£–¥–∞–ª–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º');
        return;
      }
      
      console.log('üîÑ –í—ã–ø–æ–ª–Ω—è–µ–º –∑–∞–ø—Ä–æ—Å —É–¥–∞–ª–µ–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞ —Å ID:', courier.id);
      
      // –í—ã–ø–æ–ª–Ω—è–µ–º —É–¥–∞–ª–µ–Ω–∏–µ
      await apiCall(`/api/admin/couriers/${courier.id}`, 'DELETE');
      
      console.log('‚úÖ –ö—É—Ä—å–µ—Ä —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω:', courier.full_name);
      showAlert(`–ö—É—Ä—å–µ—Ä "${courier.full_name}" —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω!`, 'success');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫—É—Ä—å–µ—Ä–æ–≤
      await fetchCouriers(couriersPage, couriersPerPage);
      
      // –ï—Å–ª–∏ –±—ã–ª –æ—Ç–∫—Ä—ã—Ç –ø—Ä–æ—Ñ–∏–ª—å —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∫—É—Ä—å–µ—Ä–∞, –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
      if (courierProfileModal && selectedCourier?.id === courier.id) {
        setCourierProfileModal(false);
        setSelectedCourier(null);
      }
      
      // –ï—Å–ª–∏ –±—ã–ª –æ—Ç–∫—Ä—ã—Ç —Ä–µ–¥–∞–∫—Ç–æ—Ä —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –∫—É—Ä—å–µ—Ä–∞, –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
      if (courierEditModal && selectedCourier?.id === courier.id) {
        setCourierEditModal(false);
        setSelectedCourier(null);
      }
      
    } catch (error) {
      console.error('‚ùå Error deleting courier:', error);
      showAlert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞: ${error.message}`, 'error');
    }
  };

  const fetchAvailableCouriersForWarehouse = async (warehouseId) => {
    try {
      const data = await apiCall(`/api/admin/couriers/available/${warehouseId}`);
      setAvailableCouriers(data.couriers || []);
    } catch (error) {
      console.error('Error fetching available couriers:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤: ' + error.message, 'error');
    }
  };

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –õ–ò–ß–ù–û–ì–û –ö–ê–ë–ò–ù–ï–¢–ê –ö–£–†–¨–ï–†–ê (–≠–¢–ê–ü 3)
  const fetchCourierNewRequests = async () => {
    try {
      const data = await apiCall('/api/courier/requests/new');
      setCourierRequests(data.new_requests || []);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∫—É—Ä—å–µ—Ä–µ
      if (data.courier_info) {
        setSelectedCourier(data.courier_info);
      }
    } catch (error) {
      console.error('Error fetching courier new requests:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫: ' + error.message, 'error');
    }
  };

  const handleAcceptCourierRequest = async (requestId) => {
    try {
      const response = await apiCall(`/api/courier/requests/${requestId}/accept`, 'POST');
      
      showAlert('–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–±—Ä–∞—Ç—å –≥—Ä—É–∑.', 'success');
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å–ø–∏—Å–∫–∏ –∑–∞—è–≤–æ–∫ –¥–ª—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      await Promise.all([
        fetchCourierNewRequests(),     // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ (–∑–∞—è–≤–∫–∞ –∏—Å—á–µ–∑–Ω–µ—Ç –æ—Ç—Å—é–¥–∞)
        fetchAcceptedRequests(),       // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–Ω—è—Ç—ã–µ –∑–∞—è–≤–∫–∏ (–∑–∞—è–≤–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å)
        fetchPickedRequests(),         // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–±—Ä–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
        fetchCancelledRequests()       // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
      ]);
      
      // –ï—Å–ª–∏ —ç—Ç–æ –∑–∞—è–≤–∫–∞ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
      if (response?.request_type === 'pickup') {
        showAlert('–ó–∞—è–≤–∫–∞ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞ –ø—Ä–∏–Ω—è—Ç–∞! –í—ã –º–æ–∂–µ—Ç–µ –Ω–∞–π—Ç–∏ –µ—ë –≤ —Ä–∞–∑–¥–µ–ª–µ "–ü—Ä–∏–Ω—è—Ç—ã–µ –∑–∞—è–≤–∫–∏".', 'success');
      }
      
    } catch (error) {
      console.error('Error accepting courier request:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–∫–∏: ' + error.message, 'error');
    }
  };

  const handleCancelCourierRequest = async (requestId, reason = '–û—Ç–º–µ–Ω–µ–Ω–æ –∫—É—Ä—å–µ—Ä–æ–º') => {
    try {
      await apiCall(`/api/courier/requests/${requestId}/cancel`, 'POST', {
        reason: reason
      });
      
      showAlert('–ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞. –û–ø–µ—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ.', 'warning');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫
      fetchCourierNewRequests();
      
    } catch (error) {
      console.error('Error cancelling courier request:', error);
      showAlert('–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞—è–≤–∫–∏: ' + error.message, 'error');
    }
  };

  const fetchCourierRequestsHistory = async (page = 1, perPage = 20) => {
    try {
      const data = await apiCall(`/api/courier/requests/history?page=${page}&per_page=${perPage}`);
      return data;
    } catch (error) {
      console.error('Error fetching courier requests history:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞—è–≤–æ–∫: ' + error.message, 'error');
      return { items: [], pagination: {} };
    }
  };

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –†–ê–°–®–ò–†–ï–ù–ù–û–ì–û WORKFLOW –ö–£–†–¨–ï–†–ê (–≠–¢–ê–ü 2)
  const [acceptedRequests, setAcceptedRequests] = useState([]);
  const [pickedRequests, setPickedRequests] = useState([]);
  const [cancelledRequests, setCancelledRequests] = useState([]);
  const [selectedCargoForEdit, setSelectedCargoForEdit] = useState(null);
  const [courierCargoEditForm, setCourierCargoEditForm] = useState({
    cargo_name: '',
    weight: '',
    recipient_full_name: '',
    recipient_phone: '',
    recipient_address: '',
    delivery_method: 'pickup',
    payment_method: 'not_paid',
    declared_value: ''
  });

  const fetchAcceptedRequests = async () => {
    try {
      const data = await apiCall('/api/courier/requests/accepted');
      setAcceptedRequests(data.accepted_requests || []);
    } catch (error) {
      console.error('Error fetching accepted requests:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞—è–≤–æ–∫: ' + error.message, 'error');
    }
  };

  const fetchPickedRequests = async () => {
    try {
      const data = await apiCall('/api/courier/requests/picked');
      setPickedRequests(data.picked_requests || []);
    } catch (error) {
      console.error('Error fetching picked requests:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞–±—Ä–∞–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤: ' + error.message, 'error');
    }
  };
  
  const fetchCancelledRequests = async () => {
    try {
      const data = await apiCall('/api/courier/requests/cancelled');
      setCancelledRequests(data.cancelled_requests || []);
    } catch (error) {
      console.error('Error fetching cancelled requests:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫: ' + error.message, 'error');
    }
  };

  const handlePickupCargo = async (requestId) => {
    try {
      const response = await apiCall(`/api/courier/requests/${requestId}/pickup`, 'POST');
      
      showAlert('–ì—Ä—É–∑ –∑–∞–±—Ä–∞–Ω! –°—Ç–∞—Ç—É—Å –æ–±–Ω–æ–≤–ª–µ–Ω.', 'success');
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å–ø–∏—Å–∫–∏ –∑–∞—è–≤–æ–∫ –¥–ª—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      await Promise.all([
        fetchAcceptedRequests(),       // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–Ω—è—Ç—ã–µ –∑–∞—è–≤–∫–∏ (–∑–∞—è–≤–∫–∞ –∏—Å—á–µ–∑–Ω–µ—Ç –æ—Ç—Å—é–¥–∞)
        fetchPickedRequests(),         // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–±—Ä–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ (–∑–∞—è–≤–∫–∞ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å)  
        fetchCourierNewRequests(),     // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏
        fetchCancelledRequests()       // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
      ]);
      
      // –ï—Å–ª–∏ —ç—Ç–æ –∑–∞—è–≤–∫–∞ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
      if (response?.request_type === 'pickup') {
        showAlert('–ì—Ä—É–∑ –ø–æ –∑–∞—è–≤–∫–µ –Ω–∞ –∑–∞–±–æ—Ä –∑–∞–±—Ä–∞–Ω! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ —Å–¥–∞—Ç—å –µ–≥–æ –Ω–∞ —Å–∫–ª–∞–¥ –≤ —Ä–∞–∑–¥–µ–ª–µ "–ó–∞–±—Ä–∞–Ω–Ω—ã–µ –≥—Ä—É–∑—ã".', 'success');
      }
      
    } catch (error) {
      console.error('Error picking up cargo:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–±–æ—Ä–µ –≥—Ä—É–∑–∞: ' + error.message, 'error');
    }
  };

  const handleDeliverToWarehouse = async (requestId) => {
    try {
      const response = await apiCall(`/api/courier/requests/${requestId}/deliver-to-warehouse`, 'POST');
      
      showAlert('–ì—Ä—É–∑ —Å–¥–∞–Ω –Ω–∞ —Å–∫–ª–∞–¥! –ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω.', 'success');
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å–ø–∏—Å–∫–∏ –∑–∞—è–≤–æ–∫ –¥–ª—è —Ä–µ–∞–∫—Ç–∏–≤–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
      await Promise.all([
        fetchPickedRequests(),         // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–±—Ä–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ (–∑–∞—è–≤–∫–∞ –∏—Å—á–µ–∑–Ω–µ—Ç –æ—Ç—Å—é–¥–∞)
        fetchAcceptedRequests(),       // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–∏–Ω—è—Ç—ã–µ –∑–∞—è–≤–∫–∏
        fetchCourierNewRequests(),     // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏
        fetchCancelledRequests()       // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
      ]);
      
      // –ï—Å–ª–∏ —ç—Ç–æ –∑–∞—è–≤–∫–∞ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
      if (response?.request_type === 'pickup') {
        showAlert('–ì—Ä—É–∑ –ø–æ –∑–∞—è–≤–∫–µ –Ω–∞ –∑–∞–±–æ—Ä —Å–¥–∞–Ω –Ω–∞ —Å–∫–ª–∞–¥! –û–ø–µ—Ä–∞—Ç–æ—Ä –ø–æ–ª—É—á–∏—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –ø–æ—Å—Ç—É–ø–ª–µ–Ω–∏–∏ –≥—Ä—É–∑–∞.', 'success');
      } else {
        showAlert('–ì—Ä—É–∑ —Å–¥–∞–Ω –Ω–∞ —Å–∫–ª–∞–¥! –ó–∞–∫–∞–∑ –≤—ã–ø–æ–ª–Ω–µ–Ω.', 'success');
      }
      
    } catch (error) {
      console.error('Error delivering to warehouse:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–¥–∞—á–µ –≥—Ä—É–∑–∞: ' + error.message, 'error');
    }
  };

  const handleEditCargoInfo = (request) => {
    setSelectedCargoForEdit(request);
    setCourierCargoEditForm({
      cargo_name: request.cargo_name || '',
      weight: '', // –ë—É–¥–µ–º –∑–∞–ø–æ–ª–Ω—è—Ç—å –∫—É—Ä—å–µ—Ä–æ–º
      recipient_full_name: '', // –ë—É–¥–µ–º –∑–∞–ø–æ–ª–Ω—è—Ç—å –∫—É—Ä—å–µ—Ä–æ–º
      recipient_phone: '', // –ë—É–¥–µ–º –∑–∞–ø–æ–ª–Ω—è—Ç—å –∫—É—Ä—å–µ—Ä–æ–º
      recipient_address: '', // –ë—É–¥–µ–º –∑–∞–ø–æ–ª–Ω—è—Ç—å –∫—É—Ä—å–µ—Ä–æ–º
      delivery_method: request.delivery_method || 'pickup',
      payment_method: 'not_paid', // –ë—É–¥–µ–º –∑–∞–ø–æ–ª–Ω—è—Ç—å –∫—É—Ä—å–µ—Ä–æ–º
      declared_value: ''
    });
    setCargoEditModal(true);
  };

  const handleUpdateCargoInfo = async (e) => {
    e.preventDefault();
    if (!selectedCargoForEdit || !selectedCargoForEdit.id) return;

    try {
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ, –æ–∂–∏–¥–∞–µ–º–æ–º backend
      const updateData = {
        cargo_items: [{
          name: courierCargoEditForm.cargo_name,
          weight: courierCargoEditForm.weight,
          total_price: courierCargoEditForm.declared_value || 0
        }],
        recipient_full_name: courierCargoEditForm.recipient_full_name,
        recipient_phone: courierCargoEditForm.recipient_phone,
        recipient_address: courierCargoEditForm.recipient_address,
        delivery_method: courierCargoEditForm.delivery_method,
        payment_method: courierCargoEditForm.payment_method
      };

      await apiCall(`/api/courier/requests/${selectedCargoForEdit.id}/update`, 'PUT', updateData);
      
      showAlert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!', 'success');
      setCargoEditModal(false);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏ –∑–∞—è–≤–æ–∫
      fetchAcceptedRequests();
      fetchPickedRequests();
      
    } catch (error) {
      console.error('Error updating request info:', error);
      showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏: ' + error.message, 'error');
    }
  };

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–õ–£–ß–®–ï–ù–ò–ô –ò–ù–¢–ï–†–§–ï–ô–°–ê –ö–£–†–¨–ï–†–ê
  const handleOpenCourierProfile = () => {
    if (user) {
      setCourierProfileEditForm({
        full_name: user.full_name || '',
        phone: user.phone || '',
        address: user.address || '',
        current_password: '',
        new_password: '',
        confirm_password: ''
      });
      setCourierProfileModal(true);
    }
  };

  const handleUpdateCourierProfile = async (e) => {
    e.preventDefault();
    
    // –í–∞–ª–∏–¥–∞—Ü–∏—è
    if (courierProfileEditForm.new_password && courierProfileEditForm.new_password !== courierProfileEditForm.confirm_password) {
      showAlert('–ù–æ–≤—ã–µ –ø–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç', 'error');
      return;
    }
    
    try {
      const updateData = {
        full_name: courierProfileEditForm.full_name,
        phone: courierProfileEditForm.phone,
        address: courierProfileEditForm.address
      };
      
      // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–æ–ª—å –µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω
      if (courierProfileEditForm.new_password) {
        updateData.current_password = courierProfileEditForm.current_password;
        updateData.new_password = courierProfileEditForm.new_password;
      }
      
      await apiCall('/api/auth/profile/update', 'PUT', updateData);
      
      showAlert('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
      setCourierProfileModal(false);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      fetchUserData();
      
    } catch (error) {
      console.error('Error updating profile:', error);
      showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message, 'error');
    }
  };

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø GPS –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–Ø –ö–£–†–¨–ï–†–ê

  // –ó–∞–ø—É—Å–∫ GPS –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
  const startCourierTracking = async () => {
    if (!navigator.geolocation) {
      showAlert('–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º', 'error');
      return;
    }

    try {
      // –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const position = await getCurrentPosition();
      
      // –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
      setCourierTracking(prev => ({
        ...prev,
        isTracking: true,
        status: 'online',
        coordinates: {
          latitude: position.coords.latitude,
          longitude: position.coords.longitude
        },
        accuracy: position.coords.accuracy,
        lastUpdate: new Date(),
        error: null
      }));

      // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
      await sendLocationUpdate(position.coords, 'online');

      // –ó–∞–ø—É—Å—Ç–∏—Ç—å –ø–æ—Å—Ç–æ—è–Ω–Ω–æ–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
      const watchId = navigator.geolocation.watchPosition(
        async (position) => {
          const coords = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude
          };
          
          setCourierTracking(prev => ({
            ...prev,
            coordinates: coords,
            accuracy: position.coords.accuracy,
            lastUpdate: new Date(),
            error: null
          }));

          // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
          await sendLocationUpdate(position.coords, courierTracking.status);
        },
        (error) => {
          console.error('Geolocation error:', error);
          setCourierTracking(prev => ({
            ...prev,
            error: `–û—à–∏–±–∫–∞ –≥–µ–æ–ª–æ–∫–∞—Ü–∏–∏: ${error.message}`
          }));
        },
        {
          enableHighAccuracy: true,
          timeout: 15000,
          maximumAge: 30000
        }
      );

      // –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 30 —Å–µ–∫—É–Ω–¥
      const updateInterval = setInterval(async () => {
        if (courierTracking.coordinates) {
          await sendLocationUpdate(
            { 
              latitude: courierTracking.coordinates.latitude, 
              longitude: courierTracking.coordinates.longitude,
              accuracy: courierTracking.accuracy 
            }, 
            courierTracking.status
          );
        }
      }, 30000); // 30 —Å–µ–∫—É–Ω–¥

      setCourierTracking(prev => ({
        ...prev,
        watchId,
        updateInterval
      }));

      showAlert('GPS –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–ø—É—â–µ–Ω–æ', 'success');

    } catch (error) {
      console.error('Error starting tracking:', error);
      showAlert(`–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è: ${error.message}`, 'error');
      setCourierTracking(prev => ({
        ...prev,
        error: error.message
      }));
    }
  };

  // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ GPS –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
  const stopCourierTracking = async () => {
    // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å geolocation watch
    if (courierTracking.watchId) {
      navigator.geolocation.clearWatch(courierTracking.watchId);
    }

    // –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∏–Ω—Ç–µ—Ä–≤–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    if (courierTracking.updateInterval) {
      clearInterval(courierTracking.updateInterval);
    }

    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —Å—Ç–∞—Ç—É—Å offline
    if (courierTracking.coordinates) {
      await sendLocationUpdate(
        { 
          latitude: courierTracking.coordinates.latitude, 
          longitude: courierTracking.coordinates.longitude,
          accuracy: courierTracking.accuracy 
        }, 
        'offline'
      );
    }

    // –°–±—Ä–æ—Å–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
    setCourierTracking({
      isTracking: false,
      status: 'offline',
      lastUpdate: null,
      coordinates: null,
      accuracy: null,
      watchId: null,
      error: null,
      updateInterval: null
    });

    showAlert('GPS –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'info');
  };

  // –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∫—É—Ä—å–µ—Ä–∞
  const changeCourierStatus = async (newStatus) => {
    setCourierTracking(prev => ({
      ...prev,
      status: newStatus
    }));

    // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å –Ω–æ–≤—ã–º —Å—Ç–∞—Ç—É—Å–æ–º
    if (courierTracking.coordinates) {
      await sendLocationUpdate(
        { 
          latitude: courierTracking.coordinates.latitude, 
          longitude: courierTracking.coordinates.longitude,
          accuracy: courierTracking.accuracy 
        }, 
        newStatus
      );
    }

    const statusNames = {
      'online': '–°–≤–æ–±–æ–¥–µ–Ω',
      'on_route': '–ï–¥–µ—Ç –∫ –∫–ª–∏–µ–Ω—Ç—É', 
      'at_pickup': '–ù–∞ –º–µ—Å—Ç–µ –∑–∞–±–æ—Ä–∞',
      'at_delivery': '–ù–∞ –º–µ—Å—Ç–µ –¥–æ—Å—Ç–∞–≤–∫–∏',
      'busy': '–ó–∞–Ω—è—Ç'
    };

    showAlert(`–°—Ç–∞—Ç—É—Å –∏–∑–º–µ–Ω–µ–Ω –Ω–∞: ${statusNames[newStatus]}`, 'info');
  };

  // –ü–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—É—â—É—é –ø–æ–∑–∏—Ü–∏—é (Promise wrapper)
  const getCurrentPosition = () => {
    return new Promise((resolve, reject) => {
      navigator.geolocation.getCurrentPosition(resolve, reject, {
        enableHighAccuracy: true,
        timeout: 10000,
        maximumAge: 60000
      });
    });
  };

  // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  const sendLocationUpdate = async (coords, status) => {
    try {
      const locationData = {
        latitude: coords.latitude,
        longitude: coords.longitude,
        status: status,
        accuracy: coords.accuracy || null,
        speed: coords.speed || null,
        heading: coords.heading || null,
        current_address: null // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å reverse geocoding –ø–æ–∑–∂–µ
      };

      const response = await apiCall('/api/courier/location/update', 'POST', locationData);
      
      if (response) {
        console.log('Location updated successfully:', response);
      }
    } catch (error) {
      console.error('Error updating location:', error);
      setCourierTracking(prev => ({
        ...prev,
        error: `–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è: ${error.message}`
      }));
    }
  };

  // –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  const checkTrackingStatus = async () => {
    try {
      const response = await apiCall('/api/courier/location/status', 'GET');
      if (response && response.tracking_enabled) {
        setCourierTracking(prev => ({
          ...prev,
          status: response.status || 'offline',
          lastUpdate: response.last_updated ? new Date(response.last_updated) : null
        }));
      }
    } catch (error) {
      console.error('Error checking tracking status:', error);
    }
  };

  // useEffect –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–∏ –≤—Ö–æ–¥–µ –∫—É—Ä—å–µ—Ä–∞
  useEffect(() => {
    if (user && user.role === 'courier') {
      checkTrackingStatus();
    }
  }, [user]);

  // useEffect –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏
  useEffect(() => {
    return () => {
      if (courierTracking.watchId) {
        navigator.geolocation.clearWatch(courierTracking.watchId);
      }
      if (courierTracking.updateInterval) {
        clearInterval(courierTracking.updateInterval);
      }
    };
  }, [courierTracking.watchId, courierTracking.updateInterval]);

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –†–ï–ñ–ò–ú–û–ú –ó–ê–ë–û–†–ê –ì–†–£–ó–ê

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —Ä–µ–∂–∏–º–∞ –∑–∞–±–æ—Ä–∞ –≥—Ä—É–∑–∞
  const togglePickupMode = () => {
    setIsPickupMode(!isPickupMode);
    if (!isPickupMode) {
      // –ü—Ä–∏ –≤–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞ –∑–∞–±–æ—Ä–∞ - –æ—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      setOperatorCargoForm(prev => ({
        ...prev,
        pickup_required: true,
        delivery_method: 'courier_pickup',
        payment_method: 'not_paid'
      }));
      setSenderPhones(['']);
    } else {
      // –ü—Ä–∏ –≤—ã–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–∞ –∑–∞–±–æ—Ä–∞ - –≤–µ—Ä–Ω—É—Ç—å –æ–±—ã—á–Ω—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è
      setOperatorCargoForm(prev => ({
        ...prev,
        pickup_required: false,
        delivery_method: 'pickup'
      }));
      setSenderPhones(['']);
    }
  };

  // –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
  const addSenderPhone = () => {
    setSenderPhones([...senderPhones, '']);
  };

  // –£–¥–∞–ª–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
  const removeSenderPhone = (index) => {
    if (senderPhones.length > 1) {
      const newPhones = senderPhones.filter((_, i) => i !== index);
      setSenderPhones(newPhones);
      // –û–±–Ω–æ–≤–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
      setOperatorCargoForm(prev => ({
        ...prev,
        sender_phone: newPhones.join(', ')
      }));
    }
  };

  // –û–±–Ω–æ–≤–∏—Ç—å –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
  const updateSenderPhone = (index, value) => {
    const newPhones = [...senderPhones];
    newPhones[index] = value;
    setSenderPhones(newPhones);
    // –û–±–Ω–æ–≤–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–µ –ø–æ–ª–µ —Ç–µ–ª–µ—Ñ–æ–Ω–∞
    setOperatorCargoForm(prev => ({
      ...prev,
      sender_phone: newPhones.filter(phone => phone.trim()).join(', ')
    }));
  };

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞
  const handlePickupCargoSubmit = async (e) => {
    e.preventDefault();
    
    try {
      // –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä
      const pickupRequestData = {
        sender_full_name: operatorCargoForm.sender_full_name,
        sender_phone: senderPhones.filter(phone => phone.trim()).join(', '),
        pickup_address: operatorCargoForm.pickup_address,
        pickup_date: operatorCargoForm.pickup_date,
        pickup_time_from: operatorCargoForm.pickup_time_from,
        pickup_time_to: operatorCargoForm.pickup_time_to,
        destination: operatorCargoForm.cargo_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ', // –ò—Å–ø–æ–ª—å–∑—É–µ–º cargo_name –∫–∞–∫ destination
        courier_fee: operatorCargoForm.courier_fee,
        payment_method: operatorCargoForm.payment_method
      };

      const response = await apiCall('/api/admin/courier/pickup-request', 'POST', pickupRequestData);
      
      if (response && response.success) {
        showAlert(`–ó–∞—è–≤–∫–∞ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞! –ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏: ${response.request_id}`, 'success');
        
        // –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
        setOperatorCargoForm(prev => ({
          ...prev,
          sender_full_name: '',
          cargo_name: '',  // –û—á–∏—â–∞–µ–º –Ω–æ–≤–æ–µ –ø–æ–ª–µ
          pickup_address: '',
          pickup_date: '',
          pickup_time_from: '',
          pickup_time_to: '',
          courier_fee: '',
          payment_method: 'not_paid'
        }));
        setSenderPhones(['']);
        
        // –í—ã–π—Ç–∏ –∏–∑ —Ä–µ–∂–∏–º–∞ –∑–∞–±–æ—Ä–∞
        setIsPickupMode(false);
      }
    } catch (error) {
      console.error('Error creating pickup request:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞: ' + error.message, 'error');
    }
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã –ø—Ä–∏—ë–º–∞ –≥—Ä—É–∑–∞ —á–µ—Ä–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
  const handleOperatorCargoSubmit = async (e) => {
    e.preventDefault();
    
    try {
      console.log('üè¢ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏—ë–º–∞ –≥—Ä—É–∑–∞ —á–µ—Ä–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞');
      
      // –ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–∏—ë–º–∞ –≥—Ä—É–∑–∞ –Ω–∞–ø—Ä—è–º—É—é –Ω–∞ —Å–∫–ª–∞–¥
      const operatorCargoData = {
        // –û—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≥—Ä—É–∑–∞
        sender_full_name: operatorCargoForm.sender_full_name,
        sender_phone: operatorCargoForm.sender_phone,
        sender_address: operatorCargoForm.sender_address,
        recipient_full_name: operatorCargoForm.recipient_full_name,
        recipient_phone: operatorCargoForm.recipient_phone,
        recipient_address: operatorCargoForm.recipient_address,
        
        // –î–∞–Ω–Ω—ã–µ –≥—Ä—É–∑–æ–≤
        cargo_items: operatorCargoForm.cargo_items,
        total_weight: parseFloat(operatorCargoForm.total_weight) || 0,
        total_cost: parseFloat(operatorCargoForm.total_cost) || 0,
        
        // –°–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–∏—ë–º–∞ —á–µ—Ä–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        warehouse_id: operatorCargoForm.warehouse_id || user?.warehouse_id,
        processing_status: 'paid', // –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –≥—Ä—É–∑–∞
        status: 'awaiting_placement', // –ì–æ—Ç–æ–≤ –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é
        received_by_operator: user?.full_name || user?.user_number,
        received_at: new Date().toISOString(),
        
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        route: operatorCargoForm.route,
        special_instructions: operatorCargoForm.special_instructions || '–ü—Ä–∏–Ω—è—Ç —á–µ—Ä–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ',
        
        // –ù–û–í–û–ï: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—Ä—à—Ä—É—Ç–µ –¥–æ—Å—Ç–∞–≤–∫–∏
        delivery_route_info: routeInfo.distance ? {
          distance: routeInfo.distance,
          duration: routeInfo.duration,
          distance_value: routeInfo.distanceValue,
          duration_value: routeInfo.durationValue,
          calculated_at: new Date().toISOString(),
          warehouse_location: operatorWarehouses[0]?.location || '–î—É—à–∞–Ω–±–µ',
          warehouse_name: operatorWarehouses[0]?.name || '–°–∫–ª–∞–¥'
        } : null
      };
      
      console.log('üì¶ –î–∞–Ω–Ω—ã–µ –¥–ª—è –ø—Ä–∏—ë–º–∞ –≥—Ä—É–∑–∞ —á–µ—Ä–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:', operatorCargoData);
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–∑–∞ –Ω–∞–ø—Ä—è–º—É—é —á–µ—Ä–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
      const response = await apiCall('/api/operator/cargo/direct-accept', 'POST', operatorCargoData);
      
      if (response.success) {
        showAlert(`–ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω—è—Ç —á–µ—Ä–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞! –ù–æ–º–µ—Ä –≥—Ä—É–∑–∞: ${response.cargo_number}`, 'success');
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
        setOperatorCargoForm({
          sender_full_name: '',
          sender_phone: '',
          sender_address: '',
          recipient_full_name: '',
          recipient_phone: '',
          recipient_address: '',
          cargo_items: [{ name: '', weight: '', size: '', declared_value: '' }],
          total_weight: 0,
          total_cost: 0,
          warehouse_id: user?.warehouse_id || '',
          route: 'moscow_to_tajikistan',
          special_instructions: ''
        });
        
        // –ù–û–í–û–ï: –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Ä—à—Ä—É—Ç–µ
        setRouteInfo({
          distance: '',
          duration: '',
          distanceValue: 0,
          durationValue: 0
        });
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        setShowOperatorCargoForm(false);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
        await fetchAvailableCargoForPlacement();
        await fetchOperatorCargo();
        
      } else {
        showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏—ë–º–µ –≥—Ä—É–∑–∞: ${response.message}`, 'error');
      }
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏—ë–º–µ –≥—Ä—É–∑–∞ —á–µ—Ä–µ–∑ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:', error);
      showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏—ë–º–µ –≥—Ä—É–∑–∞: ${error.message}`, 'error');
    }
  };

  const handleOpenCourierChat = () => {
    setCourierChatModal(true);
  };

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –û –ü–û–°–¢–£–ü–ò–í–®–ò–• –ì–†–£–ó–ê–•
  const fetchWarehouseNotifications = async () => {
    try {
      const data = await apiCall('/api/operator/warehouse-notifications', 'GET');
      const notifications = data.notifications || [];
      
      // –§–∏–ª—å—Ç—Ä—É–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —á—Ç–æ–±—ã –∏—Å–∫–ª—é—á–∏—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
      const validNotifications = notifications.filter(notification => 
        notification && 
        notification.id && 
        typeof notification.id === 'string' &&
        notification.status !== 'sent_to_placement' // –ò—Å–∫–ª—é—á–∞–µ–º —É–∂–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –Ω–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ
      );
      
      setWarehouseNotifications(validNotifications);
    } catch (error) {
      console.error('Error fetching warehouse notifications:', error);
      // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –Ω–µ –æ—á–∏—â–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é
      if (warehouseNotifications.length === 0) {
        setWarehouseNotifications([]);
      }
    }
  };

  const handleAcceptWarehouseDelivery = async (notificationId) => {
    try {
      const response = await apiCall(`/api/operator/warehouse-notifications/${notificationId}/accept`, 'POST');
      
      showAlert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è!', 'success');
      
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      const notification = response.notification_data || warehouseNotifications.find(n => n.id === notificationId);
      
      if (notification) {
        // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—è–≤–∫–µ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞
        try {
          const modalResponse = await apiCall(`/api/operator/pickup-requests/${notification.pickup_request_id}`, 'GET');
          const modalData = modalResponse;
          
          console.log('Enhanced pickup request modal data:', modalData);
          
          // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ modal_data
          const senderData = modalData.sender_data || {};
          const recipientData = modalData.recipient_data || {};
          const cargoInfo = modalData.cargo_info || {};
          const paymentInfo = modalData.payment_info || {};
          const requestInfo = modalData.request_info || {};
          
          // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
          let processedCargoItems = [];
          
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –≥—Ä—É–∑–∞—Ö - —Å–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥—Ä—É–∑–∞
          if (cargoInfo.cargo_items && cargoInfo.cargo_items.length > 0) {
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ï—Å–ª–∏ –µ—Å—Ç—å –º–∞—Å—Å–∏–≤ cargo_items –∏–∑ backend, –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ –Ω–∞–ø—Ä—è–º—É—é
            processedCargoItems = cargoInfo.cargo_items.map((item, index) => ({
              name: item.name || `–ì—Ä—É–∑ ${index + 1}`,
              weight: item.weight ? String(item.weight) : '',
              price: item.price || item.total_price || item.value || ''
            }));
            console.log(`‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º cargo_items –∏–∑ backend: ${processedCargoItems.length} –≥—Ä—É–∑–æ–≤`);
          } else if (cargoInfo.cargo_name) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å cargo_name, –ø–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–±–∏—Ç—å –ø–æ –∑–∞–ø—è—Ç—ã–º –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –≥—Ä—É–∑—ã
            const cargoNames = cargoInfo.cargo_name.split(',').map(name => name.trim()).filter(name => name);
            if (cargoNames.length > 1) {
              // –ù–µ—Å–∫–æ–ª—å–∫–æ –≥—Ä—É–∑–æ–≤ - —Å–æ–∑–¥–∞–µ–º –æ—Ç–¥–µ–ª—å–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∫–∞–∂–¥–æ–≥–æ
              processedCargoItems = cargoNames.map((name, index) => ({
                name: name,
                weight: index === 0 && cargoInfo.weight ? String(cargoInfo.weight) : '', // –í–µ—Å —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –≥—Ä—É–∑–∞
                price: index === 0 && (cargoInfo.total_value || cargoInfo.declared_value) ? String(cargoInfo.total_value || cargoInfo.declared_value) : '' // –¶–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –≥—Ä—É–∑–∞
              }));
            } else {
              // –û–¥–∏–Ω –≥—Ä—É–∑
              processedCargoItems = [{
                name: cargoInfo.cargo_name,
                weight: cargoInfo.weight ? String(cargoInfo.weight) : '',
                price: cargoInfo.total_value ? String(cargoInfo.total_value) : cargoInfo.declared_value ? String(cargoInfo.declared_value) : ''
              }];
            }
          } else if (cargoInfo.destination) {
            // –ï—Å–ª–∏ –µ—Å—Ç—å —Ç–æ–ª—å–∫–æ destination, —Ç–∞–∫–∂–µ –ø–æ–ø—Ä–æ–±—É–µ–º —Ä–∞–∑–±–∏—Ç—å –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –≥—Ä—É–∑—ã
            const destinations = cargoInfo.destination.split(',').map(dest => dest.trim()).filter(dest => dest);
            if (destinations.length > 1) {
              processedCargoItems = destinations.map((name, index) => ({
                name: name,
                weight: index === 0 && cargoInfo.weight ? String(cargoInfo.weight) : '',
                price: index === 0 && (cargoInfo.total_value || cargoInfo.declared_value) ? String(cargoInfo.total_value || cargoInfo.declared_value) : ''
              }));
            } else {
              processedCargoItems = [{
                name: cargoInfo.destination,
                weight: cargoInfo.weight ? String(cargoInfo.weight) : '',
                price: cargoInfo.total_value ? String(cargoInfo.total_value) : cargoInfo.declared_value ? String(cargoInfo.declared_value) : ''
              }];
            }
          } else {
            // Fallback - —Å–æ–∑–¥–∞–µ–º –æ–¥–∏–Ω –ø—É—Å—Ç–æ–π –≥—Ä—É–∑
            processedCargoItems = [{
              name: '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–æ',
              weight: '',
              price: ''
            }];
          }
          
          setCargoAcceptanceForm({
            sender_full_name: senderData.sender_full_name || notification.sender_full_name || '',
            sender_phone: senderData.sender_phone || notification.sender_phone || '',
            sender_address: senderData.pickup_address || notification.pickup_address || '',
            recipient_full_name: recipientData.recipient_full_name || '',
            recipient_phone: recipientData.recipient_phone || '',
            recipient_address: recipientData.recipient_address || '',
            cargo_items: processedCargoItems,
            payment_method: paymentInfo.payment_method || notification.payment_method || 'cash',
            delivery_method: recipientData.delivery_method || 'pickup',
            payment_status: paymentInfo.payment_status || 'not_paid', // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã –æ—Ç –∫—É—Ä—å–µ—Ä–∞
            amount_paid: '',
            payment_notes: ''
          });
          
          console.log('=== –û–¢–õ–ê–î–ö–ê –ó–ê–ü–û–õ–ù–ï–ù–ò–Ø –§–û–†–ú–´ ===');
          console.log('modalData:', modalData);
          console.log('cargoInfo:', cargoInfo);
          console.log('processedCargoItems:', processedCargoItems);
          console.log('recipientData:', recipientData);
          console.log('senderData:', senderData);
          console.log('paymentInfo:', paymentInfo);
          console.log('–°–¢–ê–¢–£–° –û–ü–õ–ê–¢–´ –û–¢ –ö–£–†–¨–ï–†–ê:', paymentInfo.payment_status);
          
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–æ–≥–∞—â–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
          const enrichedNotification = {
            ...notification,
            // –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            modal_data: modalData,
            sender_data: senderData,
            recipient_data: recipientData,
            cargo_info: cargoInfo,
            payment_info: paymentInfo,
            request_info: requestInfo,
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–µ –ø–æ–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            id: notification.id,
            request_number: notification.request_number,
            courier_name: notification.courier_name,
            delivered_at: notification.delivered_at,
            courier_fee: notification.courier_fee
          };
          
          setCurrentCargoNotification(enrichedNotification);
          
        } catch (requestError) {
          console.error('Error fetching full pickup request:', requestError);
          // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –ø–æ–ª–Ω—É—é –∑–∞—è–≤–∫—É, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
          console.log('=== –û–¢–õ–ê–î–ö–ê: –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ===');
          console.log('notification:', notification);
          
          setCargoAcceptanceForm({
            sender_full_name: notification.sender_full_name || '',
            sender_phone: notification.sender_phone || '',
            sender_address: notification.pickup_address || '',
            recipient_full_name: '',
            recipient_phone: '',
            recipient_address: '',
            cargo_items: [{ 
              name: notification.destination || '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–æ', 
              weight: '', 
              price: '' 
            }],
            payment_method: notification.payment_method || 'cash',
            delivery_method: 'pickup',
            payment_status: notification.payment_status || 'not_paid', // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            amount_paid: '',
            payment_notes: ''
          });
          
          setCurrentCargoNotification(notification);
        }
      }
      
      // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø–æ–ª–Ω–æ–≥–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≥—Ä—É–∑–∞
      setShowCargoAcceptanceModal(true);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      await fetchWarehouseNotifications();
      
    } catch (error) {
      console.error('Error accepting warehouse delivery:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–µ–º–∫–µ –≥—Ä—É–∑–∞: ' + error.message, 'error');
    }
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –í–°–ï–• –ó–ê–Ø–í–û–ö –ù–ê –ó–ê–ë–û–†
  const fetchAllPickupRequests = async () => {
    try {
      const data = await apiCall('/api/operator/pickup-requests', 'GET');
      const pickupRequests = data.pickup_requests || [];
      
      // –í–∞–ª–∏–¥–∞—Ü–∏—è –∏ –æ—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ –Ω–∞ –∑–∞–±–æ—Ä
      const validatedRequests = pickupRequests.filter(request => {
        // –§–∏–ª—å—Ç—Ä—É–µ–º –∑–∞—è–≤–∫–∏ —Å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        if (!request || !request.id) {
          console.warn('–ù–∞–π–¥–µ–Ω–∞ –∑–∞—è–≤–∫–∞ –±–µ–∑ ID, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º:', request);
          return false;
        }
        
        // –ò—Å–ø—Ä–∞–≤–ª—è–µ–º –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–æ–∫
        if (!request.request_number || 
            request.request_number === 'undefined' || 
            request.request_number === 'null' ||
            request.request_number === '000000/00') {
          console.warn(`–ó–∞—è–≤–∫–∞ ${request.id} –∏–º–µ–µ—Ç –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä: ${request.request_number}, –∏—Å–ø—Ä–∞–≤–ª—è–µ–º`);
          request.request_number = `REQ-${request.id.slice(0, 8)}`;
        }
        
        return true;
      });
      
      setAllPickupRequests(validatedRequests);
      console.log(`–ó–∞–≥—Ä—É–∂–µ–Ω–æ ${validatedRequests.length} –≤–∞–ª–∏–¥–Ω—ã—Ö –∑–∞—è–≤–æ–∫ –Ω–∞ –∑–∞–±–æ—Ä`);
    } catch (error) {
      console.error('Error fetching all pickup requests:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∑–∞—è–≤–æ–∫ –Ω–∞ –∑–∞–±–æ—Ä: ' + error.message, 'error');
    }
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ü–û–õ–£–ß–ï–ù–ò–Ø –ò–°–¢–û–†–ò–ò –ó–ê–ë–û–†–ê –ì–†–£–ó–ê
  const fetchPickupRequestsHistory = async () => {
    try {
      const data = await apiCall('/api/operator/pickup-requests/history', 'GET');
      setPickupRequestsHistory(data.history_requests || []);
    } catch (error) {
      console.error('Error fetching pickup requests history:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞—è–≤–æ–∫ –Ω–∞ –∑–∞–±–æ—Ä: ' + error.message, 'error');
    }
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –ó–ê–í–ï–†–®–ï–ù–ò–Ø –û–§–û–†–ú–õ–ï–ù–ò–Ø –ì–†–£–ó–ê
  const handleCompleteCargoProcessing = async (notificationId, cargoDetails) => {
    try {
      console.log('üöÄ Starting cargo processing completion:', { notificationId, cargoDetails });
      
      const response = await apiCall(`/api/operator/warehouse-notifications/${notificationId}/complete`, 'POST', cargoDetails);
      
      console.log('‚úÖ Server response:', response);
      
      showAlert('–ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω –∏ –¥–æ–±–∞–≤–ª–µ–Ω –≤ —Å–∏—Å—Ç–µ–º—É!', 'success');
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª
      setShowCargoAcceptanceModal(false);
      setCurrentCargoNotification(null);
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
      setCargoAcceptanceForm({
        sender_full_name: '',
        sender_phone: '',
        sender_address: '',
        recipient_full_name: '',
        recipient_phone: '',
        recipient_address: '',
        cargo_items: [{ name: '', weight: '', price: '' }],
        payment_method: '',
        delivery_method: '',
        payment_status: 'not_paid'
      });
      
      console.log('üîÑ Starting data refresh...');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
      await Promise.all([
        fetchWarehouseNotifications(),
        fetchOperatorCargo(),
        fetchPickupRequestsHistory(),
        fetchAvailableCargoForPlacement() // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
      ]);
      
      console.log('‚úÖ Data refresh completed');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –≥—Ä—É–∑–∞—Ö
      if (response?.created_cargos?.length > 0) {
        const cargoNumbers = response.created_cargos.map(c => c.cargo_number).join(', ');
        showAlert(`–°–æ–∑–¥–∞–Ω–æ –≥—Ä—É–∑–æ–≤: ${response.total_items}. –ù–æ–º–µ—Ä–∞: ${cargoNumbers}. –ì—Ä—É–∑—ã –¥–æ—Å—Ç—É–ø–Ω—ã –≤ —Ä–∞–∑–¥–µ–ª–µ "–†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞".`, 'success');
      }
      
    } catch (error) {
      console.error('‚ùå Error completing cargo processing:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è: ' + error.message, 'error');
    }
  };
  
  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –û–ë–†–ê–ë–û–¢–ö–ò –ó–ê–Ø–í–û–ö –ù–ê –ó–ê–ë–û–† –ì–†–£–ó–ê
  const handlePrintPickupQR = (notification) => {
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–∞–ª–∏—á–∏–µ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–∞–Ω–Ω—ã—Ö
      if (!notification || !notification.request_number) {
        showAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è QR –∫–æ–¥–∞', 'error');
        return;
      }

      // –£–ø—Ä–æ—â–∞–µ–º QR –∫–æ–¥ - —Ç–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä –∑–∞—è–≤–∫–∏
      const qrData = notification.request_number;

      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–∞
      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
        return;
      }
      
      printWindow.document.write(`
        <html>
          <head>
            <title>QR –∫–æ–¥ –∑–∞—è–≤–∫–∏ ${notification.request_number || 'N/A'}</title>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
            <style>
              body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
              .qr-container { margin: 20px auto; }
              .request-info { margin: 10px 0; font-size: 14px; }
              #qrcode { margin: 20px auto; display: block; }
              .print-btn { 
                margin: 20px; 
                padding: 10px 20px; 
                font-size: 16px; 
                background: #007bff; 
                color: white; 
                border: none; 
                border-radius: 5px; 
                cursor: pointer; 
              }
              @media print { 
                body { margin: 0; }
                .print-btn { display: none; }
              }
            </style>
          </head>
          <body>
            <h2>QR –∫–æ–¥ –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞</h2>
            <div class="request-info">
              <strong>–ó–∞—è–≤–∫–∞ ‚Ññ:</strong> ${notification.request_number || 'N/A'}<br>
              <strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> ${notification.sender_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
              <strong>–ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞:</strong> ${notification.pickup_address || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
              <strong>–ö—É—Ä—å–µ—Ä:</strong> ${notification.courier_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
              <strong>–°–¥–∞–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥:</strong> ${notification.delivered_at ? new Date(notification.delivered_at).toLocaleString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
            </div>
            <div class="qr-container">
              <canvas id="qrcode" width="200" height="200"></canvas>
            </div>
            <button class="print-btn" onclick="window.print()">–ü–µ—á–∞—Ç—å</button>
            <div id="error-message" style="color: red; margin-top: 20px;"></div>
            
            <script>
              const qrData = "${qrData}";
              
              function generateQR() {
                try {
                  if (typeof QRious !== 'undefined') {
                    console.log('QRious library loaded, generating QR code...');
                    var qr = new QRious({
                      element: document.getElementById('qrcode'),
                      value: qrData,
                      size: 200
                    });
                    console.log('QR Code generated successfully for:', qrData);
                  } else {
                    console.log('QRious not loaded yet, retrying...');
                    setTimeout(generateQR, 200);
                  }
                } catch (error) {
                  console.error('Error generating QR code:', error);
                  document.getElementById('error-message').innerHTML = 
                    '<p>–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è QR –∫–æ–¥–∞: ' + error.message + '</p>' +
                    '<p>–î–∞–Ω–Ω—ã–µ –¥–ª—è QR: <strong>' + qrData + '</strong></p>';
                }
              }
              
              // –ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
              setTimeout(generateQR, 300);
              
              // Fallback - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ QR –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–ª—Å—è
              setTimeout(function() {
                var canvas = document.getElementById('qrcode');
                var ctx = canvas.getContext('2d');
                if (!ctx.getImageData(0, 0, 1, 1).data.some(channel => channel !== 0)) {
                  document.getElementById('error-message').innerHTML = 
                    '<p style="color: orange;">QR –∫–æ–¥ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω. –î–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏:</p>' +
                    '<p style="font-size: 18px; font-weight: bold;">' + qrData + '</p>';
                }
              }, 3000);
            </script>
          </body>
        </html>
      `);
      printWindow.document.close();
      
      showAlert('QR –∫–æ–¥ –∑–∞—è–≤–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–µ—á–∞—Ç—å', 'success');
    } catch (error) {
      console.error('Error printing pickup QR:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–∞: ' + error.message, 'error');
    }
  };

  const handlePrintPickupInvoice = (notification) => {
    try {
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—á–∞—Ç–∏ –Ω–∞–∫–ª–∞–¥–Ω–æ–π
      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
        return;
      }
      
      printWindow.document.write(`
        <html>
          <head>
            <title>–ù–∞–∫–ª–∞–¥–Ω–∞—è –∑–∞—è–≤–∫–∏ ${notification.request_number}</title>
            <style>
              body { font-family: Arial, sans-serif; font-size: 12px; margin: 20px; }
              h1 { font-size: 16px; text-align: center; margin-bottom: 20px; }
              .section { margin: 15px 0; }
              .section h3 { font-size: 14px; margin: 10px 0 5px 0; border-bottom: 1px solid #333; }
              .info-row { margin: 5px 0; }
              .info-label { font-weight: bold; display: inline-block; width: 150px; }
              .company-header { text-align: center; margin-bottom: 30px; }
              .signatures { margin-top: 40px; display: flex; justify-content: space-between; }
              .signature { text-align: center; }
              @media print { body { margin: 0; } }
            </style>
          </head>
          <body>
            <div class="company-header">
              <h1>TAJLINE.TJ</h1>
              <p>–ì—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∏ –ú–æ—Å–∫–≤–∞-–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω</p>
            </div>
            
            <h1>–ù–ê–ö–õ–ê–î–ù–ê–Ø –ó–ê–Ø–í–ö–ò –ù–ê –ó–ê–ë–û–† –ì–†–£–ó–ê ‚Ññ${notification.request_number}</h1>
            
            <div class="section">
              <h3>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ</h3>
              <div class="info-row">
                <span class="info-label">–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏:</span> ${notification.request_number}
              </div>
              <div class="info-row">
                <span class="info-label">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</span> ${new Date(notification.created_at || Date.now()).toLocaleString('ru-RU')}
              </div>
              <div class="info-row">
                <span class="info-label">–°–¥–∞–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥:</span> ${new Date(notification.delivered_at).toLocaleString('ru-RU')}
              </div>
            </div>
            
            <div class="section">
              <h3>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</h3>
              <div class="info-row">
                <span class="info-label">–§–ò–û:</span> ${notification.sender_full_name}
              </div>
              <div class="info-row">
                <span class="info-label">–¢–µ–ª–µ—Ñ–æ–Ω:</span> ${notification.sender_phone}
              </div>
              <div class="info-row">
                <span class="info-label">–ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞:</span> ${notification.pickup_address}
              </div>
            </div>
            
            <div class="section">
              <h3>–ö—É—Ä—å–µ—Ä</h3>
              <div class="info-row">
                <span class="info-label">–§–ò–û –∫—É—Ä—å–µ—Ä–∞:</span> ${notification.courier_name}
              </div>
              <div class="info-row">
                <span class="info-label">–ü–ª–∞—Ç–∞ –∫—É—Ä—å–µ—Ä—É:</span> ${notification.courier_fee || 0} ‚ÇΩ
              </div>
            </div>
            
            <div class="section">
              <h3>–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
              <div class="info-row">
                <span class="info-label">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞:</span> ${notification.destination || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
              </div>
              <div class="info-row">
                <span class="info-label">–°—Ç–∞—Ç—É—Å:</span> ${notification.status === 'in_processing' ? '–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è' : notification.status}
              </div>
            </div>
            
            <div class="signatures">
              <div class="signature">
                <p>–ü—Ä–∏–Ω—è–ª –æ–ø–µ—Ä–∞—Ç–æ—Ä:</p>
                <p>_________________</p>
                <p>(–ø–æ–¥–ø–∏—Å—å)</p>
              </div>
              <div class="signature">
                <p>–î–∞—Ç–∞: ${new Date().toLocaleDateString('ru-RU')}</p>
                <p>_________________</p>
                <p>(–¥–∞—Ç–∞)</p>
              </div>
            </div>
            
            <script>window.print();</script>
          </body>
        </html>
      `);
      printWindow.document.close();
      
      showAlert('–ù–∞–∫–ª–∞–¥–Ω–∞—è –∑–∞—è–≤–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø–µ—á–∞—Ç—å', 'success');
    } catch (error) {
      console.error('Error printing pickup invoice:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—á–∞—Ç–∏ –Ω–∞–∫–ª–∞–¥–Ω–æ–π: ' + error.message, 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
  const handleViewNotification = async (notification) => {
    try {
      console.log('üîç –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–∏–Ω—è—Ç–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', notification);
      
      // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—è–≤–∫–µ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞ (–µ—Å–ª–∏ –µ—Å—Ç—å pickup_request_id)
      let modalData = null;
      if (notification.pickup_request_id) {
        try {
          const modalResponse = await apiCall(`/api/operator/pickup-requests/${notification.pickup_request_id}`, 'GET');
          modalData = modalResponse;
          console.log('üìã –ü–æ–ª—É—á–µ–Ω—ã –¥–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä:', modalData);
        } catch (requestError) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∏:', requestError);
        }
      }
      
      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –ø—Ä–∏–Ω—è—Ç–∏—è –≥—Ä—É–∑–∞ –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
      if (modalData) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ modal_data
        const senderData = modalData.sender_data || {};
        const recipientData = modalData.recipient_data || {};
        const cargoInfo = modalData.cargo_info || {};
        const paymentInfo = modalData.payment_info || {};
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –≥—Ä—É–∑–∞—Ö - –ø—Ä–∞–≤–∏–ª—å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º —Ü–µ–Ω—É –ó–ê –ö–ì –æ—Ç –∫—É—Ä—å–µ—Ä–∞
        let processedCargoItems = [];
        if (cargoInfo.cargo_items && cargoInfo.cargo_items.length > 0) {
          processedCargoItems = cargoInfo.cargo_items.map((item, index) => ({
            name: item.name || item.cargo_name || `–ì—Ä—É–∑ ${index + 1}`,
            weight: item.weight ? String(item.weight) : '',
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º price_per_kg (—Ü–µ–Ω—É –∑–∞ –∫–≥), –∞ –Ω–µ –æ–±—â—É—é —Å—Ç–æ–∏–º–æ—Å—Ç—å
            price: item.price_per_kg ? String(item.price_per_kg) : (item.price || '')
          }));
          console.log('‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º cargo_items —Å price_per_kg –æ—Ç –∫—É—Ä—å–µ—Ä–∞:', processedCargoItems);
        } else {
          // –°–æ–∑–¥–∞–µ–º –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç –≥—Ä—É–∑–∞ –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
          const cargoName = cargoInfo.cargo_name || cargoInfo.destination || notification.destination || '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–æ';
          const cargoWeight = cargoInfo.weight ? String(cargoInfo.weight) : '';
          // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º price_per_kg (—Ü–µ–Ω—É –∑–∞ –∫–≥), –∫–æ—Ç–æ—Ä—É—é –∑–∞–ø–æ–ª–Ω–∏–ª –∫—É—Ä—å–µ—Ä
          const cargoPricePerKg = cargoInfo.price_per_kg || '';
          
          processedCargoItems = [{
            name: cargoName,
            weight: cargoWeight,
            price: cargoPricePerKg ? String(cargoPricePerKg) : ''
          }];
          
          console.log('‚úÖ –°–æ–∑–¥–∞–Ω –≥—Ä—É–∑ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–∞ —Å price_per_kg:', {
            name: cargoName,
            weight: cargoWeight, 
            price_per_kg: cargoPricePerKg,
            source: 'cargoInfo.price_per_kg –æ—Ç –∫—É—Ä—å–µ—Ä–∞'
          });
        }
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –∏–∑–≤–ª–µ–∫–∞–µ–º —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –æ—Ç –∫—É—Ä—å–µ—Ä–∞
        const courierPaymentMethod = paymentInfo.payment_method || notification.payment_method || 'cash';
        const courierPaymentStatus = paymentInfo.payment_status || notification.payment_status || 'not_paid';
        
        console.log('üí∞ –î–∞–Ω–Ω—ã–µ –æ–± –æ–ø–ª–∞—Ç–µ –æ—Ç –∫—É—Ä—å–µ—Ä–∞:', {
          payment_method: courierPaymentMethod,
          payment_status: courierPaymentStatus,
          courier_fee: paymentInfo.courier_fee
        });
        
        console.log('üìÖ –î–∞–Ω–Ω—ã–µ –æ –∑–∞–±–æ—Ä–µ –æ—Ç –∫—É—Ä—å–µ—Ä–∞:', {
          pickup_date: senderData.pickup_date,
          pickup_time_from: senderData.pickup_time_from,
          pickup_time_to: senderData.pickup_time_to,
          pickup_address: senderData.pickup_address
        });
        
        setCargoAcceptanceForm({
          sender_full_name: senderData.sender_full_name || notification.sender_full_name || '',
          sender_phone: senderData.sender_phone || notification.sender_phone || '',
          sender_address: senderData.pickup_address || notification.pickup_address || '',
          recipient_full_name: recipientData.recipient_full_name || '',
          recipient_phone: recipientData.recipient_phone || '',
          recipient_address: recipientData.recipient_address || '',
          cargo_items: processedCargoItems,
          payment_method: courierPaymentMethod, // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –æ—Ç –∫—É—Ä—å–µ—Ä–∞
          delivery_method: recipientData.delivery_method || 'pickup',
          payment_status: courierPaymentStatus, // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã –æ—Ç –∫—É—Ä—å–µ—Ä–∞
          amount_paid: '',
          payment_notes: ''
        });
        
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ–±–æ–≥–∞—â–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
        const enrichedNotification = {
          ...notification,
          modal_data: modalData,
          sender_data: senderData,
          recipient_data: recipientData,
          cargo_info: cargoInfo,
          payment_info: paymentInfo,
          isViewMode: true, // –§–ª–∞–≥ –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
          // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –æ –∑–∞–±–æ—Ä–µ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
          pickup_date: senderData.pickup_date,
          pickup_time_from: senderData.pickup_time_from, 
          pickup_time_to: senderData.pickup_time_to,
          courier_payment_method: courierPaymentMethod,
          courier_payment_status: courierPaymentStatus
        };
        
        setCurrentCargoNotification(enrichedNotification);
      } else {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –Ω–∞–ø—Ä—è–º—É—é
        console.log('üìã –ò—Å–ø–æ–ª—å–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞–ø—Ä—è–º—É—é –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', notification);
        
        setCargoAcceptanceForm({
          sender_full_name: notification.sender_full_name || '',
          sender_phone: notification.sender_phone || '',
          sender_address: notification.pickup_address || '',
          recipient_full_name: '',
          recipient_phone: '',
          recipient_address: '',
          cargo_items: [{ 
            name: notification.destination || '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–æ', 
            weight: '', 
            price: notification.price_per_kg || '' // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º price_per_kg –≤–º–µ—Å—Ç–æ total_value
          }],
          payment_method: notification.payment_method || 'cash', // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
          delivery_method: 'pickup',
          payment_status: notification.payment_status || 'not_paid', // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
          amount_paid: '',
          payment_notes: ''
        });
        
        setCurrentCargoNotification({
          ...notification,
          isViewMode: true, // –§–ª–∞–≥ –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
          courier_payment_method: notification.payment_method,
          courier_payment_status: notification.payment_status
        });
      }
      
      // –û—Ç–∫—Ä—ã–≤–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–Ω—è—Ç–∏—è –≥—Ä—É–∑–∞
      setShowCargoAcceptanceModal(true);
      
    } catch (error) {
      console.error('Error opening notification view:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ' + error.message, 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥—Ä—É–∑–∞
  const handleViewCargo = async (cargoItem) => {
    try {
      console.log('üîç –û—Ç–∫—Ä—ã–≤–∞–µ–º –ø—Ä–æ—Å–º–æ—Ç—Ä –≥—Ä—É–∑–∞:', cargoItem);
      
      // –°–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç, –ø–æ—Ö–æ–∂–∏–π –Ω–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ, –Ω–æ —Å –¥–∞–Ω–Ω—ã–º–∏ –≥—Ä—É–∑–∞
      const mockNotification = {
        id: cargoItem.id || cargoItem.cargo_number,
        request_number: cargoItem.cargo_number,
        courier_name: cargoItem.courier_name || '–ù–µ —É–∫–∞–∑–∞–Ω',
        delivered_at: cargoItem.created_at || new Date().toISOString(),
        pickup_address: cargoItem.sender_address || '–ù–µ —É–∫–∞–∑–∞–Ω',
        sender_full_name: cargoItem.sender_name || cargoItem.sender_full_name || '',
        sender_phone: cargoItem.sender_phone || '',
        recipient_full_name: cargoItem.recipient_name || cargoItem.recipient_full_name || '',
        recipient_phone: cargoItem.recipient_phone || '',
        destination: cargoItem.destination || cargoItem.recipient_address || '',
        courier_fee: cargoItem.courier_fee || 0,
        payment_method: cargoItem.payment_method || 'cash',
        isViewMode: true,
        isCargoMode: true // –§–ª–∞–≥ –¥–ª—è —É–∫–∞–∑–∞–Ω–∏—è, —á—Ç–æ —ç—Ç–æ –ø—Ä–æ—Å–º–æ—Ç—Ä –≥—Ä—É–∑–∞ (–Ω–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è)
      };
      
      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –≥—Ä—É–∑–∞
      setCargoAcceptanceForm({
        sender_full_name: cargoItem.sender_name || cargoItem.sender_full_name || '',
        sender_phone: cargoItem.sender_phone || '',
        sender_address: cargoItem.sender_address || cargoItem.pickup_address || '',
        recipient_full_name: cargoItem.recipient_name || cargoItem.recipient_full_name || '',
        recipient_phone: cargoItem.recipient_phone || '',
        recipient_address: cargoItem.recipient_address || cargoItem.destination || '',
        cargo_items: [{
          name: cargoItem.cargo_name || cargoItem.destination || '–ì—Ä—É–∑',
          weight: cargoItem.weight ? String(cargoItem.weight) : '',
          price: cargoItem.price_per_kg ? String(cargoItem.price_per_kg) : ''  // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –¢–æ–ª—å–∫–æ price_per_kg, –±–µ–∑ declared_value
        }],
        payment_method: cargoItem.payment_method || 'cash',
        delivery_method: cargoItem.delivery_method || 'pickup',
        payment_status: cargoItem.payment_status || 'not_paid',
        amount_paid: cargoItem.amount_paid || '',
        payment_notes: cargoItem.notes || ''
      });
      
      setCurrentCargoNotification(mockNotification);
      setShowCargoAcceptanceModal(true);
      
    } catch (error) {
      console.error('Error opening cargo view:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä—É–∑–∞: ' + error.message, 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Å–∫–ª–∞–¥–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
  const ensureWarehouseNumbers = async () => {
    if (user?.role === 'admin') {
      try {
        console.log('üîß –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ —Å–∫–ª–∞–¥–æ–≤ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ QR –∫–æ–¥–æ–≤...');
        const response = await apiCall('/api/admin/warehouses/update-id-numbers', 'POST');
        if (response.updated_count > 0) {
          console.log(`‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–æ–º–µ—Ä–∞ ${response.updated_count} —Å–∫–ª–∞–¥–æ–≤ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ QR –∫–æ–¥–æ–≤`);
        }
      } catch (error) {
        console.warn('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –Ω–æ–º–µ—Ä–∞ —Å–∫–ª–∞–¥–æ–≤:', error.message);
      }
    }
  };

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤ –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  const generateSpecificCellQR = async () => {
    if (!qrCellCode.block || !qrCellCode.shelf || !qrCellCode.cell) {
      showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è: –ë–ª–æ–∫, –ü–æ–ª–∫–∞, –Ø—á–µ–π–∫–∞', 'error');
      return;
    }

    try {
      const response = await apiCall('/api/warehouse/cell/generate-qr', 'POST', {
        warehouse_id: selectedWarehouseForQR.id,
        block: parseInt(qrCellCode.block),
        shelf: parseInt(qrCellCode.shelf),
        cell: parseInt(qrCellCode.cell),
        format: 'id' // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π ID —Ñ–æ—Ä–º–∞—Ç —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏ —Å–∫–ª–∞–¥–æ–≤
      });
      
      if (response && response.success && response.qr_code) {
        setGeneratedCellQR(response.qr_code);
        showAlert(`QR –∫–æ–¥ –¥–ª—è —è—á–µ–π–∫–∏ ${response.readable_name} —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ! –ö–æ–¥: ${response.cell_code}`, 'success');
      } else {
        showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å QR –∫–æ–¥', 'error');
      }
    } catch (error) {
      console.error('Error generating specific cell QR:', error);
      showAlert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è QR –∫–æ–¥–∞: ${error.message}`, 'error');
    }
  };

  const generateAllCellsQR = async () => {
    if (!selectedWarehouseForQR) {
      showAlert('–°–∫–ª–∞–¥ –Ω–µ –≤—ã–±—Ä–∞–Ω', 'error');
      return;
    }

    try {
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      setMassQRGeneration({
        isGenerating: true,
        progress: 0,
        total: 0,
        current: 0,
        results: []
      });

      showAlert('–ù–∞—á–∏–Ω–∞–µ—Ç—Å—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤ –¥–ª—è –≤—Å–µ—Ö —è—á–µ–µ–∫ —Å–∫–ª–∞–¥–∞...', 'info');
      
      // –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–∫–ª–∞–¥–∞
      console.log('üèóÔ∏è –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–∫–ª–∞–¥–∞ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏...');
      const structureResponse = await apiCall(`/api/warehouses/${selectedWarehouseForQR.id}/structure`, 'GET');
      
      if (!structureResponse || !structureResponse.blocks) {
        throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–∫–ª–∞–¥–∞');
      }

      const { blocks, shelves_per_block, cells_per_shelf } = structureResponse;
      const totalCells = blocks * shelves_per_block * cells_per_shelf;
      
      console.log(`üìä –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∫–ª–∞–¥–∞: ${blocks} –±–ª–æ–∫–æ–≤, ${shelves_per_block} –ø–æ–ª–æ–∫ –Ω–∞ –±–ª–æ–∫, ${cells_per_shelf} —è—á–µ–µ–∫ –Ω–∞ –ø–æ–ª–∫—É`);
      console.log(`üéØ –í—Å–µ–≥–æ —è—á–µ–µ–∫ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏: ${totalCells}`);

      setMassQRGeneration(prev => ({
        ...prev,
        total: totalCells
      }));

      const results = [];
      let currentCell = 0;

      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –∫–æ–¥—ã –¥–ª—è –≤—Å–µ—Ö —è—á–µ–µ–∫
      for (let block = 1; block <= blocks; block++) {
        for (let shelf = 1; shelf <= shelves_per_block; shelf++) {
          for (let cell = 1; cell <= cells_per_shelf; cell++) {
            currentCell++;
            
            try {
              console.log(`üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –∫–æ–¥ ${currentCell}/${totalCells}: –ë–ª–æ–∫ ${block}, –ü–æ–ª–∫–∞ ${shelf}, –Ø—á–µ–π–∫–∞ ${cell}`);
              
              const response = await apiCall('/api/warehouse/cell/generate-qr', 'POST', {
                warehouse_id: selectedWarehouseForQR.id,
                block: block,
                shelf: shelf,
                cell: cell,
                format: 'id' // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID —Ñ–æ—Ä–º–∞—Ç —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏ —Å–∫–ª–∞–¥–æ–≤
              });

              if (response && response.success) {
                results.push({
                  location: `–ë${block}-–ü${shelf}-–Ø${cell}`,
                  code: response.cell_code,
                  qr_image: response.qr_code,
                  readable_name: response.readable_name
                });
                
                console.log(`‚úÖ QR –∫–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: ${response.cell_code}`);
              } else {
                console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –¥–ª—è –ë${block}-–ü${shelf}-–Ø${cell}`);
              }

            } catch (cellError) {
              console.error(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –¥–ª—è –ë${block}-–ü${shelf}-–Ø${cell}:`, cellError);
            }

            // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
            const progress = Math.round((currentCell / totalCells) * 100);
            setMassQRGeneration(prev => ({
              ...prev,
              current: currentCell,
              progress: progress,
              results: [...results]
            }));

            // –ù–µ–±–æ–ª—å—à–∞—è –∑–∞–¥–µ—Ä–∂–∫–∞ —á—Ç–æ–±—ã –Ω–µ –ø–µ—Ä–µ–≥—Ä—É–∂–∞—Ç—å —Å–µ—Ä–≤–µ—Ä
            await new Promise(resolve => setTimeout(resolve, 100));
          }
        }
      }

      // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      setMassQRGeneration(prev => ({
        ...prev,
        isGenerating: false
      }));

      showAlert(`–ú–∞—Å—Å–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${results.length} QR –∫–æ–¥–æ–≤ –∏–∑ ${totalCells} —è—á–µ–µ–∫.`, 'success');
      console.log(`üéâ –ú–∞—Å—Å–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞: ${results.length}/${totalCells} QR –∫–æ–¥–æ–≤`);

    } catch (error) {
      console.error('Error generating all cells QR:', error);
      setMassQRGeneration(prev => ({
        ...prev,
        isGenerating: false
      }));
      showAlert(`–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤: ${error.message}`, 'error');
    }
  };

  const generateRangeQR = async () => {
    showAlert('–§—É–Ω–∫—Ü–∏—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–µ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏', 'info');
  };

  const downloadQRCode = (qrCodeData, filename) => {
    try {
      const link = document.createElement('a');
      link.href = qrCodeData;
      link.download = `${filename}.png`;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showAlert(`QR –∫–æ–¥ ${filename} —Å–∫–∞—á–∞–Ω —É—Å–ø–µ—à–Ω–æ!`, 'success');
    } catch (error) {
      console.error('Error downloading QR code:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ QR –∫–æ–¥–∞', 'error');
    }
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –≤—Å–µ—Ö QR –∫–æ–¥–æ–≤ –∫–∞–∫ ZIP –∞—Ä—Ö–∏–≤–∞
  const downloadAllQRCodes = async (results) => {
    try {
      showAlert('–ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∞—Ä—Ö–∏–≤–∞ —Å QR –∫–æ–¥–∞–º–∏...', 'info');
      
      // –°–æ–∑–¥–∞–µ–º ZIP –∞—Ä—Ö–∏–≤ —Å –ø–æ–º–æ—â—å—é JSZip (–µ—Å–ª–∏ –¥–æ—Å—Ç—É–ø–Ω–æ) –∏–ª–∏ –ø—Ä–æ—Å—Ç–æ —Å–∫–∞—á–∏–≤–∞–µ–º –æ–¥–∏–Ω –∑–∞ –¥—Ä—É–≥–∏–º
      for (let i = 0; i < results.length && i < 50; i++) { // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –¥–æ 50 QR –∫–æ–¥–æ–≤
        const result = results[i];
        const filename = `${selectedWarehouseForQR?.name}-${result.code}`;
        
        setTimeout(() => {
          downloadQRCode(result.qr_image, filename);
        }, i * 200); // –ó–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É —Å–∫–∞—á–∏–≤–∞–Ω–∏—è–º–∏
      }
      
      if (results.length > 50) {
        showAlert(`–°–∫–∞—á–∞–Ω–æ –ø–µ—Ä–≤—ã—Ö 50 QR –∫–æ–¥–æ–≤ –∏–∑ ${results.length}. –î–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ü–∏—é.`, 'info');
      } else {
        showAlert(`–°–∫–∞—á–∏–≤–∞–Ω–∏–µ ${results.length} QR –∫–æ–¥–æ–≤ –Ω–∞—á–∞—Ç–æ!`, 'success');
      }
      
    } catch (error) {
      console.error('Error downloading all QR codes:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ QR –∫–æ–¥–æ–≤', 'error');
    }
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ú–∞—Å—Å–æ–≤–∞—è –ø–µ—á–∞—Ç—å QR –∫–æ–¥–æ–≤
  const printAllQRCodes = (results) => {
    try {
      console.log('üñ®Ô∏è –ù–∞—á–∏–Ω–∞–µ–º –º–∞—Å—Å–æ–≤—É—é –ø–µ—á–∞—Ç—å QR –∫–æ–¥–æ–≤:', results.length);
      
      // –°–æ–∑–¥–∞–µ–º HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–µ—á–∞—Ç–∏
      const printWindow = window.open('', '_blank');
      
      let htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>QR –∫–æ–¥—ã —Å–∫–ª–∞–¥–∞ ${selectedWarehouseForQR?.name}</title>
          <style>
            body {
              font-family: Arial, sans-serif;
              margin: 20px;
              print-color-adjust: exact;
              -webkit-print-color-adjust: exact;
            }
            .header {
              text-align: center;
              margin-bottom: 30px;
              border-bottom: 2px solid #333;
              padding-bottom: 10px;
            }
            .qr-grid {
              display: grid;
              grid-template-columns: repeat(4, 1fr);
              gap: 20px;
              page-break-inside: avoid;
            }
            .qr-item {
              text-align: center;
              border: 1px solid #ddd;
              padding: 15px;
              border-radius: 8px;
              page-break-inside: avoid;
            }
            .qr-designation {
              font-weight: bold;
              font-size: 16px;
              color: #333;
              margin-bottom: 10px;
              background-color: #f0f8ff;
              padding: 5px;
              border-radius: 4px;
            }
            .qr-code {
              margin: 10px 0;
            }
            .qr-details {
              font-size: 12px;
              color: #666;
              margin-top: 8px;
            }
            .warehouse-info {
              background-color: #e8f4fd;
              padding: 10px;
              border-radius: 6px;
              margin-bottom: 10px;
              font-size: 14px;
            }
            @media print {
              .qr-grid {
                grid-template-columns: repeat(3, 1fr);
              }
              .qr-item {
                break-inside: avoid;
              }
            }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>QR –∫–æ–¥—ã —Å–∫–ª–∞–¥–∞: ${selectedWarehouseForQR?.name}</h1>
            <div class="warehouse-info">
              <strong>–ê–¥—Ä–µ—Å:</strong> ${selectedWarehouseForQR?.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
              <strong>–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Å–∫–ª–∞–¥–∞:</strong> ${selectedWarehouseForQR?.warehouse_id_number || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
              <strong>–í—Å–µ–≥–æ QR –∫–æ–¥–æ–≤:</strong> ${results.length}<br>
              <strong>–î–∞—Ç–∞ –ø–µ—á–∞—Ç–∏:</strong> ${new Date().toLocaleString('ru-RU')}
            </div>
          </div>
          <div class="qr-grid">
      `;

      // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π QR –∫–æ–¥ —Å –æ–±–æ–∑–Ω–∞—á–µ–Ω–∏–µ–º
      results.forEach((result, index) => {
        // –ò–∑–≤–ª–µ–∫–∞–µ–º –±–ª–æ–∫, –ø–æ–ª–∫—É, —è—á–µ–π–∫—É –∏–∑ location (–Ω–∞–ø—Ä–∏–º–µ—Ä "–ë1-–ü2-–Ø3")
        const locationMatch = result.location.match(/–ë(\d+)-–ü(\d+)-–Ø(\d+)/);
        const designation = locationMatch ? `–ë${locationMatch[1]}-–ü${locationMatch[2]}-–Ø${locationMatch[3]}` : result.location;
        
        htmlContent += `
          <div class="qr-item">
            <div class="qr-designation">${designation}</div>
            <div class="qr-code">
              <img src="${result.qr_image}" alt="QR Code ${result.code}" width="120" height="120">
            </div>
            <div class="qr-details">
              <strong>–ö–æ–¥:</strong> ${result.code}<br>
              <strong>–Ø—á–µ–π–∫–∞:</strong> ${result.readable_name || designation}
            </div>
          </div>
        `;
      });

      htmlContent += `
          </div>
        </body>
        </html>
      `;

      printWindow.document.write(htmlContent);
      printWindow.document.close();

      // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–µ—á–∞—Ç—å
      setTimeout(() => {
        printWindow.focus();
        printWindow.print();
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ—Å–ª–µ –ø–µ—á–∞—Ç–∏
        setTimeout(() => {
          printWindow.close();
        }, 1000);
      }, 2000);

      showAlert(`–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –ø–µ—á–∞—Ç–∏ ${results.length} QR –∫–æ–¥–æ–≤`, 'success');
      
    } catch (error) {
      console.error('Error printing all QR codes:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–æ–≤', 'error');
    }
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–µ—á–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ QR –∫–æ–¥–∞
  const printSingleQRCode = () => {
    try {
      if (!generatedCellQR || !qrCellCode.block || !qrCellCode.shelf || !qrCellCode.cell) {
        showAlert('QR –∫–æ–¥ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∏–ª–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –¥–∞–Ω–Ω—ã–µ —è—á–µ–π–∫–∏', 'error');
        return;
      }

      console.log('üñ®Ô∏è –ü–µ—á–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω–æ–≥–æ QR –∫–æ–¥–∞ –¥–ª—è —è—á–µ–π–∫–∏:', `–ë${qrCellCode.block}-–ü${qrCellCode.shelf}-–Ø${qrCellCode.cell}`);
      
      const designation = `–ë${qrCellCode.block}-–ü${qrCellCode.shelf}-–Ø${qrCellCode.cell}`;
      
      // –°–æ–∑–¥–∞–µ–º HTML —Å—Ç—Ä–∞–Ω–∏—Ü—É –¥–ª—è –ø–µ—á–∞—Ç–∏
      const printWindow = window.open('', '_blank');
      
      const htmlContent = `
        <!DOCTYPE html>
        <html>
        <head>
          <title>QR –∫–æ–¥ —è—á–µ–π–∫–∏ ${designation}</title>
          <style>
            body {
              font-family: Arial, sans-serif;
              margin: 40px;
              text-align: center;
              print-color-adjust: exact;
              -webkit-print-color-adjust: exact;
            }
            .header {
              margin-bottom: 30px;
              border-bottom: 2px solid #333;
              padding-bottom: 15px;
            }
            .warehouse-info {
              background-color: #e8f4fd;
              padding: 15px;
              border-radius: 8px;
              margin-bottom: 30px;
              font-size: 14px;
            }
            .qr-container {
              margin: 30px 0;
              padding: 20px;
              border: 2px solid #ddd;
              border-radius: 12px;
              display: inline-block;
            }
            .qr-designation {
              font-weight: bold;
              font-size: 24px;
              color: #333;
              margin-bottom: 20px;
              background-color: #f0f8ff;
              padding: 10px 20px;
              border-radius: 8px;
              border: 2px solid #4a90e2;
            }
            .qr-code {
              margin: 20px 0;
            }
            .qr-details {
              font-size: 14px;
              color: #666;
              margin-top: 15px;
            }
            .generated-code {
              font-family: monospace;
              background-color: #f5f5f5;
              padding: 8px 12px;
              border-radius: 4px;
              font-weight: bold;
            }
          </style>
        </head>
        <body>
          <div class="header">
            <h1>QR –∫–æ–¥ —è—á–µ–π–∫–∏ —Å–∫–ª–∞–¥–∞</h1>
          </div>
          
          <div class="warehouse-info">
            <strong>–°–∫–ª–∞–¥:</strong> ${selectedWarehouseForQR?.name || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
            <strong>–ê–¥—Ä–µ—Å:</strong> ${selectedWarehouseForQR?.address || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
            <strong>–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä —Å–∫–ª–∞–¥–∞:</strong> ${selectedWarehouseForQR?.warehouse_id_number || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
            <strong>–î–∞—Ç–∞ –ø–µ—á–∞—Ç–∏:</strong> ${new Date().toLocaleString('ru-RU')}
          </div>
          
          <div class="qr-container">
            <div class="qr-designation">${designation}</div>
            <div class="qr-code">
              <img src="${generatedCellQR}" alt="QR Code ${designation}" width="200" height="200">
            </div>
            <div class="qr-details">
              <div class="generated-code">
                –ö–æ–¥: ${selectedWarehouseForQR?.warehouse_id_number || '000'}-${String(qrCellCode.block).padStart(2, '0')}-${String(qrCellCode.shelf).padStart(2, '0')}-${String(qrCellCode.cell).padStart(3, '0')}
              </div>
            </div>
          </div>
        </body>
        </html>
      `;

      printWindow.document.write(htmlContent);
      printWindow.document.close();

      // –ñ–¥–µ–º –∑–∞–≥—Ä—É–∑–∫–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –ø–µ—á–∞—Ç—å
      setTimeout(() => {
        printWindow.focus();
        printWindow.print();
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–æ—Å–ª–µ –ø–µ—á–∞—Ç–∏
        setTimeout(() => {
          printWindow.close();
        }, 1000);
      }, 1500);

      showAlert(`–ü–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω –¥–æ–∫—É–º–µ–Ω—Ç –¥–ª—è –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–∞ —è—á–µ–π–∫–∏ ${designation}`, 'success');
      
    } catch (error) {
      console.error('Error printing single QR code:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–∞', 'error');
    }
  };

  const handleSendToPlacement = async (notification) => {
    try {
      // –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –¥–µ–π—Å—Ç–≤–∏—è
      const confirm = window.confirm(`–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É ‚Ññ${notification.request_number} –Ω–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ? –ü–æ—Å–ª–µ —ç—Ç–æ–≥–æ –∑–∞—è–≤–∫–∞ –±—É–¥–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∞ –∏–∑ —Ç–µ–∫—É—â–µ–≥–æ —Å–ø–∏—Å–∫–∞.`);
      if (!confirm) return;

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ backend –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
      const response = await apiCall(`/api/operator/warehouse-notifications/${notification.id}/send-to-placement`, 'POST');
      
      showAlert('–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ!', 'success');
      
      // –°–Ω–∞—á–∞–ª–∞ –æ–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ª–æ–∫–∞–ª—å–Ω–æ –¥–ª—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ–π —Ä–µ–∞–∫—Ü–∏–∏
      setWarehouseNotifications(prevNotifications => 
        prevNotifications.filter(n => n.id !== notification.id)
      );
      
      // –ó–∞—Ç–µ–º –¥–µ–ª–∞–µ–º –ø–æ–ª–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å —Å–µ—Ä–≤–µ—Ä–∞
      setTimeout(async () => {
        try {
          await Promise.all([
            fetchWarehouseNotifications(),
            fetchAvailableCargoForPlacement()
          ]);
        } catch (error) {
          // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –º–æ–ª—á–∞ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
          console.error('Error refreshing data:', error);
        }
      }, 500);
      
    } catch (error) {
      console.error('Error sending to placement:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ: ' + error.message, 'error');
    }
  };
  
  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ú–û–î–ê–õ–¨–ù–´–• –û–ö–û–ù –ü–†–û–°–ú–û–¢–†–ê –ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ó–ê–Ø–í–û–ö
  const handleViewRequest = (request) => {
    setSelectedRequest(request);
    setRequestViewModal(true);
  };
  
  const handleEditRequest = (request) => {
    setSelectedRequest(request);
    // –ü—Ä–µ–¥–∑–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∑–∞—è–≤–∫–∏
    setRequestEditForm({
      sender_full_name: request.sender_full_name || '',
      sender_phone: request.sender_phone || '',
      sender_address: request.pickup_address || '',
      recipient_full_name: request.recipient_full_name || '',
      recipient_phone: request.recipient_phone || '',
      recipient_address: request.recipient_address || '',
      cargo_items: [{
        name: request.cargo_name || '',
        weight: request.weight || '',
        price_per_kg: request.price_per_kg || '80',
        total_price: ((parseFloat(request.weight) || 0) * (parseFloat(request.price_per_kg) || 80)).toString()
      }],
      total_weight: request.weight || '',
      total_value: request.declared_value || '',
      payment_method: request.payment_method || 'not_paid',
      payment_received: request.payment_received || false,
      delivery_method: request.delivery_method || 'pickup',
      pickup_address: request.pickup_address || '',
      pickup_date: request.pickup_date || '',
      pickup_time: request.pickup_time || '',
      special_instructions: request.special_instructions || ''
    });
    setRequestEditModal(true);
  };
  
  const handleSaveEditedRequest = async (e) => {
    e.preventDefault();
    
    try {
      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –æ–±—â–∏–π –≤–µ—Å –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å –≤ —Ä—É–±–ª—è—Ö
      const totalWeight = requestEditForm.cargo_items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);
      const totalValue = requestEditForm.cargo_items.reduce((sum, item) => sum + (parseFloat(item.total_price) || 0), 0);
      
      const updateData = {
        ...requestEditForm,
        total_weight: totalWeight,
        total_value: totalValue
      };
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π endpoint –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ –∫—É—Ä—å–µ—Ä–æ–º
      await apiCall(`/api/courier/requests/${selectedRequest.id}/update`, 'PUT', updateData);
      
      showAlert('–ó–∞—è–≤–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
      setRequestEditModal(false);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏ –∑–∞—è–≤–æ–∫
      fetchAcceptedRequests();
      fetchPickedRequests();
      fetchCourierNewRequests();
      
    } catch (error) {
      console.error('Error updating request:', error);
      showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏: ' + error.message, 'error');
    }
  };
  
  const addRequestCargoItem = () => {
    setRequestEditForm({
      ...requestEditForm,
      cargo_items: [...requestEditForm.cargo_items, { name: '', weight: '', price_per_kg: '80', total_price: '' }]
    });
  };
  
  const removeRequestCargoItem = (index) => {
    const newItems = requestEditForm.cargo_items.filter((_, i) => i !== index);
    setRequestEditForm({
      ...requestEditForm,
      cargo_items: newItems
    });
  };
  
  const updateRequestCargoItem = (index, field, value) => {
    const newItems = [...requestEditForm.cargo_items];
    newItems[index][field] = value;
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á–µ—Ç –æ–±—â–µ–π —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –≤–µ—Å–∞ –∏–ª–∏ —Ü–µ–Ω—ã –∑–∞ –∫–≥
    if (field === 'weight' || field === 'price_per_kg') {
      const weight = parseFloat(field === 'weight' ? value : newItems[index].weight) || 0;
      const pricePerKg = parseFloat(field === 'price_per_kg' ? value : newItems[index].price_per_kg) || 0;
      newItems[index].total_price = (weight * pricePerKg).toFixed(2);
    }
    
    setRequestEditForm({
      ...requestEditForm,
      cargo_items: newItems
    });
  };
  
  const handlePrintLabel = () => {
    if (selectedRequest) {
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–∞–∫–ª–∞–¥–Ω—É—é
      const labelContent = `
        –ù–ê–ö–õ–ê–î–ù–ê–Ø ‚Ññ${selectedRequest.id}
        
        –û–¢–ü–†–ê–í–ò–¢–ï–õ–¨:
        –§–ò–û: ${selectedRequest.sender_full_name}
        –¢–µ–ª–µ—Ñ–æ–Ω: ${selectedRequest.sender_phone}
        –ê–¥—Ä–µ—Å: ${selectedRequest.pickup_address || selectedRequest.sender_address || ''}
        
        –ü–û–õ–£–ß–ê–¢–ï–õ–¨:
        –§–ò–û: ${selectedRequest.recipient_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}
        –¢–µ–ª–µ—Ñ–æ–Ω: ${selectedRequest.recipient_phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}
        –ê–¥—Ä–µ—Å: ${selectedRequest.recipient_address || '–ù–µ —É–∫–∞–∑–∞–Ω'}
        
        –ì–†–£–ó:
        –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ: ${selectedRequest.cargo_name}
        –í–µ—Å: ${selectedRequest.weight || '–ù–µ —É–∫–∞–∑–∞–Ω'} –∫–≥
        
        –ó–ê–ë–û–†:
        –î–∞—Ç–∞: ${selectedRequest.pickup_date 
          ? new Date(selectedRequest.pickup_date).toLocaleDateString('ru-RU')
          : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'
        }
        –í—Ä–µ–º—è: ${selectedRequest.pickup_time_from && selectedRequest.pickup_time_to 
          ? `${selectedRequest.pickup_time_from} - ${selectedRequest.pickup_time_to}`
          : (selectedRequest.pickup_time || '–ù–µ —É–∫–∞–∑–∞–Ω–æ')
        }
        –ê–¥—Ä–µ—Å: ${selectedRequest.pickup_address}
        
        –ö–£–†–¨–ï–†: ${user?.full_name}
        –¢–µ–ª–µ—Ñ–æ–Ω –∫—É—Ä—å–µ—Ä–∞: ${user?.phone}
        
        –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è: ${new Date().toLocaleString('ru-RU')}
      `;
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—á–∞—Ç–∏
      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
        return;
      }
      printWindow.document.write(`
        <html>
        <head>
          <title>–ù–∞–∫–ª–∞–¥–Ω–∞—è ‚Ññ${selectedRequest.id}</title>
          <style>
            body { font-family: Arial, sans-serif; font-size: 12px; margin: 20px; }
            h1 { font-size: 16px; text-align: center; }
            .section { margin: 10px 0; }
            .section h3 { font-size: 14px; margin: 5px 0; }
          </style>
        </head>
        <body>
          <h1>–ù–ê–ö–õ–ê–î–ù–ê–Ø ‚Ññ${selectedRequest.id}</h1>
          <hr>
          <pre style="white-space: pre-wrap; font-family: Arial;">${labelContent}</pre>
          <script>window.print();</script>
        </body>
        </html>
      `);
      printWindow.document.close();
      
      showAlert('–ù–∞–∫–ª–∞–¥–Ω–∞—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø–µ—á–∞—Ç—å', 'success');
    }
  };
  
  // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø–µ—á–∞—Ç—å QR –∫–æ–¥–∞ –∑–∞—è–≤–∫–∏
  const handlePrintQR = () => {
    if (selectedRequest) {
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –∫–æ–¥ –¢–û–õ–¨–ö–û —Å –Ω–æ–º–µ—Ä–æ–º –∑–∞—è–≤–∫–∏
      const requestNumber = selectedRequest.request_number || selectedRequest.id;
      const cargoName = selectedRequest.cargo_name || '–ì—Ä—É–∑';
      
      // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–µ—á–∞—Ç–∏ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–≥–æ QR –∫–æ–¥–∞
      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
        return;
      }
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–∞—à —É–ª—É—á—à–µ–Ω–Ω—ã–π API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR
      generateActualQRCode(requestNumber, 300, 'cargo_request').then(qrCodeImage => {
        printWindow.document.write(`
          <html>
          <head>
            <title>QR –∫–æ–¥ - ${requestNumber}</title>
            <meta charset="UTF-8">
            <style>
              @page {
                size: 90mm 100mm;
                margin: 3mm;
              }
              body { 
                font-family: Arial, sans-serif; 
                text-align: center; 
                margin: 0;
                padding: 5mm;
                background: white;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                min-height: 94mm;
              }
              .cargo-name {
                font-size: 14px;
                font-weight: bold;
                color: #000;
                margin-bottom: 8mm;
                word-wrap: break-word;
                max-width: 80mm;
                line-height: 1.2;
              }
              .qr-image {
                margin: 3mm 0;
              }
              .cargo-number {
                font-size: 12px;
                font-weight: bold;
                color: #000;
                margin-top: 8mm;
                font-family: 'Courier New', monospace;
                letter-spacing: 1px;
              }
            </style>
          </head>
          <body onload="window.print(); window.close();">
            <div class="cargo-name">${cargoName}</div>
            <img src="${qrCodeImage}" alt="QR –∫–æ–¥" class="qr-image" style="width: 60mm; height: 60mm;" />
            <div class="cargo-number">${requestNumber}</div>
          </body>
          </html>
        `);
        printWindow.document.close();
        
        showAlert('QR –∫–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–µ—á–∞—Ç—å', 'success');
      }).catch(error => {
        console.error('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR:', error);
        printWindow.close();
        showAlert('–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞', 'error');
      });
    }
  };
  
  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –°–í–Ø–ó–ò –° –û–¢–ü–†–ê–í–ò–¢–ï–õ–ï–ú
  const handleContactSender = (request) => {
    setContactSender({
      full_name: request.sender_full_name,
      phone: request.sender_phone,
      cargo_name: request.cargo_name,
      pickup_address: request.pickup_address
    });
    setSenderContactModal(true);
  };
  
  const handleWhatsApp = () => {
    if (contactSender?.phone) {
      const cleanPhone = contactSender.phone.replace(/[^\d]/g, '');
      const message = encodeURIComponent(
        `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –∫—É—Ä—å–µ—Ä, –ø—Ä–∏–µ–¥—É –∑–∞–±—Ä–∞—Ç—å –≥—Ä—É–∑ "${contactSender.cargo_name}" –ø–æ –∞–¥—Ä–µ—Å—É: ${contactSender.pickup_address}`
      );
      const whatsappUrl = `https://wa.me/${cleanPhone}?text=${message}`;
      window.open(whatsappUrl, '_blank');
      setSenderContactModal(false);
    }
  };
  
  const handleTelegram = () => {
    if (contactSender?.phone) {
      const cleanPhone = contactSender.phone.replace(/[^\d]/g, '');
      const message = encodeURIComponent(
        `–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –Ø –∫—É—Ä—å–µ—Ä, –ø—Ä–∏–µ–¥—É –∑–∞–±—Ä–∞—Ç—å –≥—Ä—É–∑ "${contactSender.cargo_name}" –ø–æ –∞–¥—Ä–µ—Å—É: ${contactSender.pickup_address}`
      );
      const telegramUrl = `https://t.me/+${cleanPhone}?text=${message}`;
      window.open(telegramUrl, '_blank');
      setSenderContactModal(false);
    }
  };
  
  const handleSenderOnlineChat = () => {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –≤—Å—Ç—Ä–æ–µ–Ω–Ω—ã–π —á–∞—Ç –∏–ª–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–∞—Ç–∞
    showAlert(`–û–Ω–ª–∞–π–Ω —á–∞—Ç —Å ${contactSender?.full_name} –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è`, 'info');
    setSenderContactModal(false);
  };
  
  const handlePhoneCall = () => {
    if (contactSender?.phone) {
      const phoneUrl = `tel:${contactSender.phone}`;
      window.location.href = phoneUrl;
      setSenderContactModal(false);
    }
  };
  
  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø –î–õ–Ø –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–Ø –û–¢–ú–ï–ù–ï–ù–ù–û–ô –ó–ê–Ø–í–ö–ò
  const handleRestoreRequest = async (requestId) => {
    try {
      await apiCall(`/api/courier/requests/${requestId}/restore`, 'PUT');
      
      showAlert('–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ –Ω–æ–≤—ã–µ –∑–∞—è–≤–∫–∏!', 'success');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å–ø–∏—Å–∫–∏ –∑–∞—è–≤–æ–∫
      fetchCourierNewRequests();
      fetchCancelledRequests();
      
    } catch (error) {
      console.error('Error restoring request:', error);
      showAlert('–û—à–∏–±–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏: ' + error.message, 'error');
    }
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞ –¥–ª—è –∑–∞—è–≤–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤—Å–µ—Ö –≥—Ä—É–∑–∞—Ö
  const handleGenerateRequestQR = async (cargoItem) => {
    try {
      console.log('üéØ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞ –¥–ª—è –∑–∞—è–≤–∫–∏:', cargoItem.cargo_number);
      
      setRequestQRLoading(true);
      
      // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞—è–≤–∫–µ –∏ –µ—ë –≥—Ä—É–∑–∞—Ö
      const response = await apiCall(`/api/operator/cargo/${cargoItem.id}/full-info`, 'GET');
      
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è QR –∫–æ–¥–∞
      const qrData = {
        request_number: cargoItem.cargo_number,
        sender: {
          name: cargoItem.sender_full_name,
          phone: cargoItem.sender_phone
        },
        recipient: {
          name: cargoItem.recipient_full_name,
          phone: cargoItem.recipient_phone,
          address: cargoItem.recipient_address
        },
        cargo_items: response.cargo_items || [{
          name: cargoItem.cargo_name,
          weight: cargoItem.weight,
          quantity: 1,
          total_amount: cargoItem.declared_value
        }],
        total_weight: cargoItem.weight,
        total_value: cargoItem.declared_value,
        status: cargoItem.processing_status,
        created_date: new Date(cargoItem.created_at).toLocaleDateString('ru-RU')
      };
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –∫–æ–¥ —Å –¥–∞–Ω–Ω—ã–º–∏ –∑–∞—è–≤–∫–∏
      const qrCodeImage = await generateActualQRCode(JSON.stringify(qrData), 300);
      
      setSelectedRequestForQR(cargoItem);
      setRequestQRCode({
        image: qrCodeImage,
        data: qrData,
        raw_data: JSON.stringify(qrData, null, 2)
      });
      setShowRequestQRModal(true);
      
      console.log('‚úÖ QR –∫–æ–¥ –∑–∞—è–≤–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ');
      showAlert('QR –∫–æ–¥ –∑–∞—è–≤–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!', 'success');
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞ –∑–∞—è–≤–∫–∏:', error);
      showAlert(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞: ${error.message}`, 'error');
    } finally {
      setRequestQRLoading(false);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–∞ –∑–∞—è–≤–∫–∏
  const handlePrintRequestQR = () => {
    if (!requestQRCode || !selectedRequestForQR) return;
    
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏', 'error');
      return;
    }
    
    printWindow.document.write(`
      <html>
        <head>
          <title>QR –ö–æ–¥ –ó–∞—è–≤–∫–∏ ‚Ññ${selectedRequestForQR.cargo_number}</title>
          <style>
            body { 
              font-family: Arial, sans-serif; 
              text-align: center; 
              margin: 0;
              padding: 20px;
              background: white;
            }
            .qr-container { 
              display: inline-block;
              border: 2px solid #333;
              padding: 20px;
              background: white;
              margin: 20px;
            }
            .qr-title { 
              font-size: 20px; 
              font-weight: bold; 
              margin-bottom: 15px;
              color: #333;
            }
            .qr-image { 
              margin: 15px 0;
            }
            .qr-info {
              text-align: left;
              font-size: 12px;
              margin-top: 15px;
              border-top: 1px solid #ddd;
              padding-top: 10px;
            }
            .info-row {
              margin: 5px 0;
            }
            @media print {
              body { margin: 0; padding: 10px; }
            }
          </style>
        </head>
        <body>
          <div class="qr-container">
            <div class="qr-title">QR –ö–û–î –ó–ê–Ø–í–ö–ò ‚Ññ${selectedRequestForQR.cargo_number}</div>
            <div class="qr-image">
              <img src="${requestQRCode.image}" alt="QR –∫–æ–¥ –∑–∞—è–≤–∫–∏" style="width: 250px; height: 250px;" />
            </div>
            <div class="qr-info">
              <div class="info-row"><strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> ${requestQRCode.data.sender.name}</div>
              <div class="info-row"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${requestQRCode.data.sender.phone}</div>
              <div class="info-row"><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> ${requestQRCode.data.recipient.name}</div>
              <div class="info-row"><strong>–ê–¥—Ä–µ—Å:</strong> ${requestQRCode.data.recipient.address}</div>
              <div class="info-row"><strong>–û–±—â–∏–π –≤–µ—Å:</strong> ${requestQRCode.data.total_weight} –∫–≥</div>
              <div class="info-row"><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> ${requestQRCode.data.total_value} ‚ÇΩ</div>
              <div class="info-row"><strong>–î–∞—Ç–∞:</strong> ${requestQRCode.data.created_date}</div>
              <div class="info-row"><strong>–ì—Ä—É–∑–æ–≤:</strong> ${requestQRCode.data.cargo_items.length} —à—Ç.</div>
            </div>
          </div>
          <script>
            window.onload = function() {
              setTimeout(function() {
                window.print();
              }, 500);
            }
          </script>
        </body>
      </html>
    `);
    printWindow.document.close();
    
    showAlert('QR –∫–æ–¥ –∑–∞—è–≤–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–µ—á–∞—Ç—å!', 'success');
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏ —Å —Ä–∞–∑–º–µ—Ä–æ–º –ø–µ—á–∞—Ç–∏ 90–º–º x 100–º–º
  const handleGenerateCargoNumberQR = async () => {
    try {
      setCargoNumberQRLoading(true);
      console.log('üéØ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞ –¥–ª—è –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏ (–ù–û–í–´–ô –†–ê–ë–û–ß–ò–ô –ú–ï–¢–û–î)');

      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞—è–≤–∫–∏ –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–≥–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è
      const today = new Date();
      const year = today.getFullYear().toString().slice(-2); // –ü–æ—Å–ª–µ–¥–Ω–∏–µ 2 —Ü–∏—Ñ—Ä—ã –≥–æ–¥–∞
      const month = (today.getMonth() + 1).toString().padStart(2, '0');
      const day = today.getDate().toString().padStart(2, '0');
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞—è–≤–∫–∏ —Å –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º —Å–ª—É—á–∞–π–Ω—ã—Ö —Ü–∏—Ñ—Ä –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏
      const baseNumber = `${year}${month}${day}`;
      const randomSuffix = Math.floor(Math.random() * 100).toString().padStart(2, '0');
      const uniqueCargoNumber = `${baseNumber}${randomSuffix}`;
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏
      setPreGeneratedCargoNumber(uniqueCargoNumber);
      
      console.log(`üì¶ –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞—è–≤–∫–∏: ${uniqueCargoNumber}`);

      // –°–æ–∑–¥–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è QR –∫–æ–¥–∞ –∑–∞—è–≤–∫–∏
      const requestData = {
        cargo_number: uniqueCargoNumber,
        sender_full_name: operatorCargoForm.sender_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω',
        recipient_full_name: operatorCargoForm.recipient_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω',
        recipient_address: operatorCargoForm.recipient_address || '–ù–µ —É–∫–∞–∑–∞–Ω',
        cargo_count: operatorCargoForm.cargo_items?.length || 1,
        generated_at: new Date().toISOString()
      };

      // –°–æ–∑–¥–∞–µ–º QR –∫–æ–¥ —Å –ù–û–í–´–ú –†–ê–ë–û–ß–ò–ú –§–û–†–ú–ê–¢–û–ú (–∫–∞–∫ –≤ —Å–ø–∏—Å–∫–µ –≥—Ä—É–∑–æ–≤)
      const qrCodeImage = await generateActualQRCode(requestData, 300, 'cargo_request');

      setCargoNumberQRCode({
        number: uniqueCargoNumber, // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä
        image: qrCodeImage,
        generated_at: new Date().toLocaleString('ru-RU'),
        request_data: requestData
      });
      setShowCargoNumberQRModal(true);

      console.log('‚úÖ QR –∫–æ–¥ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º –Ω–æ–º–µ—Ä–æ–º:', uniqueCargoNumber);
      showAlert(`QR –∫–æ–¥ –¥–ª—è –∑–∞—è–≤–∫–∏ ${uniqueCargoNumber} –≥–æ—Ç–æ–≤! –≠—Ç–æ—Ç –Ω–æ–º–µ—Ä –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω –ø—Ä–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏.`, 'success');

    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏:', error);
      showAlert(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞: ${error.message}`, 'error');
    } finally {
      setCargoNumberQRLoading(false);
    }
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–î–µ–π—Å—Ç–≤–∏—è" –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞
  const handleOpenCargoPlacementDetails = async (cargoItem) => {
    try {
      console.log('üîß –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–µ—Ç–∞–ª–µ–π —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –¥–ª—è –∑–∞—è–≤–∫–∏:', cargoItem.cargo_number);
      
      setPlacementDetailsLoading(true);
      setSelectedCargoForDetails(cargoItem);
      setShowPlacementDetailsModal(true);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏
      const response = await apiCall(`/api/operator/cargo/${cargoItem.id}/placement-status`, 'GET');
      
      console.log('üìã –ü–æ–ª—É—á–µ–Ω—ã –¥–µ—Ç–∞–ª–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:', response);
      setPlacementDetails(response);
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:', error);
      showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π —Ä–∞–∑–º–µ—â–µ–Ω–∏—è: ${error.message}`, 'error');
      setShowPlacementDetailsModal(false);
    } finally {
      setPlacementDetailsLoading(false);
    }
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –∑–∞—è–≤–æ–∫
  const handlePlacementStatusUpdate = async (cargoId) => {
    try {
      console.log('üîÑ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –¥–ª—è –∑–∞—è–≤–∫–∏:', cargoId);
      
      // –í—ã–∑—ã–≤–∞–µ–º API –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞
      const response = await apiCall(`/api/operator/cargo/${cargoId}/update-placement-status`, 'POST');
      
      console.log('‚úÖ –°—Ç–∞—Ç—É—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω:', response);
      
      // –ï—Å–ª–∏ –∑–∞—è–≤–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–∞, –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
      if (response.moved_to_cargo_list) {
        showAlert(response.message, 'success');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
        await fetchAvailableCargoForPlacement();
        
        // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π, –∑–∞–∫—Ä—ã–≤–∞–µ–º –µ–≥–æ
        if (showPlacementDetailsModal) {
          setShowPlacementDetailsModal(false);
          setSelectedCargoForDetails(null);
          setPlacementDetails(null);
        }
      } else {
        showAlert(response.message, 'info');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –¥–µ—Ç–∞–ª–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –µ—Å–ª–∏ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—Ç–∫—Ä—ã—Ç–æ
        if (showPlacementDetailsModal && selectedCargoForDetails?.id === cargoId) {
          await handleOpenCargoPlacementDetails(selectedCargoForDetails);
        }
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
        await fetchAvailableCargoForPlacement();
      }
      
      return response;
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:', error);
      showAlert(`–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞: ${error.message}`, 'error');
      return null;
    }
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É—Å–ø–µ—à–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞
  const handleSuccessfulPlacement = async (cargoId, placedCargoData) => {
    console.log('üéâ –ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω:', cargoId, placedCargoData);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
    await handlePlacementStatusUpdate(cargoId);
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
    showAlert('–ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥–µ!', 'success');
  };

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò: –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞ —Å–æ —Å–∫–∞–Ω–µ—Ä–æ–º

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ ID —Å–µ—Å—Å–∏–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const generatePlacementSessionId = () => {
    const sessionId = `session_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
    setPlacementSessionId(sessionId);
    return sessionId;
  };







  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const fetchPlacementHistory = async (sessionId) => {
    try {
      console.log('üìä –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –¥–ª—è —Å–µ—Å—Å–∏–∏:', sessionId);

      const params = sessionId ? { session_id: sessionId } : {};
      const response = await apiCall('/api/operator/placement/session-history', 'GET', null, params);

      if (response.success) {
        setPlacementHistory(response.history || []);
        setSessionStats(response.statistics || null);
        console.log('‚úÖ –ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–µ–Ω–∞:', response.history?.length, '–∑–∞–ø–∏—Å–µ–π');
      } else {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏:', response.error);
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:', error);
      showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∏—Å—Ç–æ—Ä–∏–∏: ${error.message}`, 'error');
    }
  };

  // –û—Ç–º–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const undoLastPlacement = async (sessionId) => {
    try {
      console.log('‚Ü©Ô∏è –û—Ç–º–µ–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≤ —Å–µ—Å—Å–∏–∏:', sessionId);
      setIsPlacementProcessing(true);

      const response = await apiCall(`/api/operator/placement/undo-last?session_id=${sessionId}`, 'DELETE');

      if (response.success) {
        const undoneInfo = response.undone_placement;
        showAlert(`‚Ü©Ô∏è –†–∞–∑–º–µ—â–µ–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ: ${undoneInfo.cargo_number} –∏–∑ ${undoneInfo.cell_address}`, 'info');
        
        // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
        await fetchPlacementHistory(sessionId);
        
        return undoneInfo;
      } else {
        showAlert(`‚ùå ${response.error}`, 'error');
        return null;
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:', error);
      showAlert(`–û—à–∏–±–∫–∞ –æ—Ç–º–µ–Ω—ã: ${error.message}`, 'error');
      return null;
    } finally {
      setIsPlacementProcessing(false);
    }
  };





  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Å—Å–∏–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const initializePlacementSession = async () => {
    const newSessionId = generatePlacementSessionId();
    setPlacementStep('scan-cargo');
    setScannerPlacementMode(true);
    setPlacementHistory([]);
    setSessionStats(null);
    console.log('üöÄ –°–µ—Å—Å–∏—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞:', newSessionId);
    
    // –£–õ–£–ß–®–ï–ù–ò–ï: –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    await fetchPlacementProgress();
    
    // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≥—Ä—É–∑–∞
    setTimeout(() => {
      const cargoInput = document.getElementById('cargo-qr-input');
      if (cargoInput) {
        cargoInput.focus();
      }
    }, 100);
  };

  // –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const finalizePlacementSession = () => {
    setScannerPlacementMode(false);
    setPlacementStep('idle');
    setCurrentCargoQR('');
    setCurrentCellQR('');
    setVerifiedCargo(null);
    setVerifiedCell(null);
    setPlacementSessionId(null);
    console.log('üèÅ –°–µ—Å—Å–∏—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞');
  };

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò: –ü–µ—á–∞—Ç—å QR –∫–æ–¥–æ–≤ –¥–ª—è Individual Units

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–ø—Ü–∏–π –º–∞–∫–µ—Ç–æ–≤ –ø–µ—á–∞—Ç–∏
  const fetchPrintLayoutOptions = async () => {
    try {
      console.log('üñ®Ô∏è –ó–∞–≥—Ä—É–∑–∫–∞ –æ–ø—Ü–∏–π –º–∞–∫–µ—Ç–æ–≤ –ø–µ—á–∞—Ç–∏...');

      const response = await apiCall('/api/operator/qr/print-layout', 'GET');

      if (response.success) {
        setPrintLayoutOptions(response.layout_options);
        console.log('‚úÖ –û–ø—Ü–∏–∏ –º–∞–∫–µ—Ç–æ–≤ –∑–∞–≥—Ä—É–∂–µ–Ω—ã:', Object.keys(response.layout_options));
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø—Ü–∏–π –ø–µ—á–∞—Ç–∏:', error);
      showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ–ø—Ü–∏–π –ø–µ—á–∞—Ç–∏: ${error.message}`, 'error');
    }
  };

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞ –¥–ª—è –æ–¥–Ω–æ–π –µ–¥–∏–Ω–∏—Ü—ã –≥—Ä—É–∑–∞
  const generateSingleQR = async (individualNumber) => {
    try {
      console.log('üñ®Ô∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –¥–ª—è –µ–¥–∏–Ω–∏—Ü—ã:', individualNumber);
      setQrGenerationProgress({ type: 'single', current: 0, total: 1 });

      const response = await apiCall('/api/operator/qr/generate-individual', 'POST', {
        individual_number: individualNumber
      });

      if (response.success) {
        console.log('‚úÖ QR –∫–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω:', response.qr_info);
        setQrGenerationProgress(null);
        return response.qr_info;
      } else {
        throw new Error(response.message || '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞');
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR:', error);
      setQrGenerationProgress(null);
      showAlert(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR: ${error.message}`, 'error');
      return null;
    }
  };

  // –ú–∞—Å—Å–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤
  const generateBatchQR = async (individualNumbers) => {
    try {
      console.log('üñ®Ô∏è –ú–∞—Å—Å–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR –¥–ª—è', individualNumbers.length, '–µ–¥–∏–Ω–∏—Ü');
      setQrGenerationProgress({ type: 'batch', current: 0, total: individualNumbers.length });

      const response = await apiCall('/api/operator/qr/generate-batch', 'POST', {
        individual_numbers: individualNumbers
      });

      if (response.success) {
        console.log('‚úÖ –ú–∞—Å—Å–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞:', response.total_generated, '—É—Å–ø–µ—à–Ω–æ');
        setGeneratedQrBatch(response);
        setQrGenerationProgress(null);
        
        if (response.total_failed > 0) {
          showAlert(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${response.total_generated} QR –∫–æ–¥–æ–≤. ${response.total_failed} –æ—à–∏–±–æ–∫.`, 'warning');
        } else {
          showAlert(`–£—Å–ø–µ—à–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${response.total_generated} QR –∫–æ–¥–æ–≤!`, 'success');
        }
        
        return response;
      } else {
        throw new Error(response.message || '–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤');
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR:', error);
      setQrGenerationProgress(null);
      showAlert(`–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR: ${error.message}`, 'error');
      return null;
    }
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–µ—á–∞—Ç–∏ QR –¥–ª—è –æ–¥–Ω–æ–π –µ–¥–∏–Ω–∏—Ü—ã
  const handlePrintSingleQR = async (unit) => {
    try {
      console.log('üñ®Ô∏è –ü–µ—á–∞—Ç—å QR –¥–ª—è –µ–¥–∏–Ω–∏—Ü—ã:', unit.individual_number);
      
      const qrInfo = await generateSingleQR(unit.individual_number);
      if (qrInfo) {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞
        setSelectedUnitsForPrint([{ ...unit, qr_info: qrInfo }]);
        setQrPrintMode(true);
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏ QR:', error);
      showAlert(`–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏ QR: ${error.message}`, 'error');
    }
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –º–∞—Å—Å–æ–≤–æ–π –ø–µ—á–∞—Ç–∏ QR
  const handleMassPrintQR = async () => {
    try {
      console.log('üñ®Ô∏è –ú–∞—Å—Å–æ–≤–∞—è –ø–µ—á–∞—Ç—å QR –¥–ª—è', individualUnitsForPlacement.length, '–µ–¥–∏–Ω–∏—Ü');
      
      if (individualUnitsForPlacement.length === 0) {
        showAlert('–ù–µ—Ç –µ–¥–∏–Ω–∏—Ü –¥–ª—è –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–æ–≤', 'warning');
        return;
      }

      const individualNumbers = individualUnitsForPlacement.map(unit => unit.individual_number);
      const batchResult = await generateBatchQR(individualNumbers);
      
      if (batchResult && batchResult.qr_batch.length > 0) {
        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É –º–∞—Å—Å–æ–≤–æ–π –ø–µ—á–∞—Ç–∏
        setQrPrintMode(true);
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –ø–µ—á–∞—Ç–∏ QR:', error);
      showAlert(`–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –ø–µ—á–∞—Ç–∏ QR: ${error.message}`, 'error');
    }
  };

  // –ü–µ—á–∞—Ç—å QR –∫–æ–¥–æ–≤ —á–µ—Ä–µ–∑ –±—Ä–∞—É–∑–µ—Ä
  const executePrint = (qrData, layout = 'grid_3x3') => {
    try {
      console.log('üñ®Ô∏è –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–µ—á–∞—Ç–∏ —Å –º–∞–∫–µ—Ç–æ–º:', layout);
      
      // –°–æ–∑–¥–∞–µ–º –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏
      const printWindow = window.open('', '_blank');
      
      // –ü–æ–ª—É—á–∞–µ–º –æ–ø—Ü–∏–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –º–∞–∫–µ—Ç–∞
      const layoutOption = printLayoutOptions?.[layout] || printLayoutOptions?.['grid_3x3'];
      const perPage = layoutOption?.per_page || 9;
      
      // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –ø–µ—á–∞—Ç–∏
      let printHTML = `
        <html>
          <head>
            <title>QR –ö–æ–¥—ã - TAJLINE.TJ</title>
            <style>
              body { 
                font-family: Arial, sans-serif; 
                margin: 20px; 
                print-color-adjust: exact;
              }
              .print-page { 
                page-break-after: always; 
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                align-items: flex-start;
              }
              .qr-item { 
                text-align: center; 
                margin: 10px;
                border: 1px solid #ddd;
                padding: 10px;
                display: inline-block;
              }
              .qr-single { width: 300px; }
              .qr-grid-2x2 { width: 200px; }
              .qr-grid-3x3 { width: 150px; }
              .qr-compact { width: 100px; }
              .qr-image { 
                max-width: 100%; 
                height: auto; 
              }
              .qr-info { 
                font-size: 12px; 
                margin-top: 5px;
                line-height: 1.2;
              }
              .qr-title { 
                font-weight: bold; 
                font-size: 10px;
                margin-bottom: 3px;
              }
              @media print {
                body { margin: 0; }
                .print-page { margin: 0; padding: 10mm; }
              }
            </style>
          </head>
          <body>
      `;
      
      // –î–æ–±–∞–≤–ª—è–µ–º QR –∫–æ–¥—ã
      const items = Array.isArray(qrData) ? qrData : [qrData];
      let currentPage = 0;
      
      items.forEach((item, index) => {
        if (index % perPage === 0) {
          if (index > 0) printHTML += '</div>'; // –ó–∞–∫—Ä—ã–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
          printHTML += '<div class="print-page">';
          currentPage++;
        }
        
        const qrBase64 = item.qr_info?.qr_base64 || item.qr_base64;
        const individualNumber = item.individual_number;
        const cargoName = item.cargo_name || item.qr_info?.cargo_name;
        
        printHTML += `
          <div class="qr-item qr-${layout}">
            <img src="data:image/png;base64,${qrBase64}" alt="QR Code" class="qr-image" />
            <div class="qr-title">${individualNumber}</div>
            ${layoutOption?.includes_info ? `
              <div class="qr-info">
                <div>–ì—Ä—É–∑: ${cargoName}</div>
                <div>–ó–∞—è–≤–∫–∞: ${individualNumber.split('/')[0]}</div>
              </div>
            ` : ''}
          </div>
        `;
      });
      
      printHTML += `
          </div>
        </body>
      </html>
      `;
      
      printWindow.document.write(printHTML);
      printWindow.document.close();
      
      // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—á–∞—Ç—å –ø–æ—Å–ª–µ –∑–∞–≥—Ä—É–∑–∫–∏
      printWindow.onload = () => {
        printWindow.print();
        printWindow.close();
      };
      
      console.log('‚úÖ –û–∫–Ω–æ –ø–µ—á–∞—Ç–∏ —Å–æ–∑–¥–∞–Ω–æ');
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏:', error);
      showAlert(`–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏: ${error.message}`, 'error');
    }
  };

  // –ó–∞–∫—Ä—ã—Ç–∏–µ —Ä–µ–∂–∏–º–∞ –ø–µ—á–∞—Ç–∏ QR
  const closePrintMode = () => {
    setQrPrintMode(false);
    setSelectedUnitsForPrint([]);
    setGeneratedQrBatch(null);
    setQrGenerationProgress(null);
  };

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –æ–ø—Ü–∏–π –ø–µ—á–∞—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
  useEffect(() => {
    if (user && user.role === 'warehouse_operator' && !printLayoutOptions) {
      fetchPrintLayoutOptions();
    }
  }, [user, printLayoutOptions]);
  
  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR –≥—Ä—É–∑–∞ (–Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
  const handleNewCargoQRScan = async (qrCode) => {
    console.log('üì± –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR –≥—Ä—É–∑–∞:', qrCode);
    
    if (!qrCode.trim()) return;

    try {
      setCurrentCargoQR(qrCode);
      setIsPlacementProcessing(true);

      const response = await apiCall('/api/operator/placement/verify-cargo', 'POST', {
        qr_code: qrCode.trim()
      });

      if (response.success) {
        setVerifiedCargo(response.cargo_info);
        showAlert(`‚úÖ –ì—Ä—É–∑ –ø—Ä–æ–≤–µ—Ä–µ–Ω: ${response.cargo_info.cargo_number}`, 'success');
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é —è—á–µ–π–∫–∏
        setPlacementStep('scan-cell');
        
        // –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ —è—á–µ–π–∫–∏ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
        setTimeout(() => {
          const cellInput = document.getElementById('cell-qr-input');
          if (cellInput) {
            cellInput.focus();
          }
        }, 100);
      } else {
        showAlert(`‚ùå ${response.error}`, 'error');
        setVerifiedCargo(null);
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥—Ä—É–∑–∞:', error);
      showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –≥—Ä—É–∑–∞: ${error.message}`, 'error');
      setVerifiedCargo(null);
    } finally {
      setIsPlacementProcessing(false);
    }
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR —è—á–µ–π–∫–∏ (–Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
  const handleNewCellQRScan = async (qrCode) => {
    console.log('üì± –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR —è—á–µ–π–∫–∏:', qrCode);
    
    if (!qrCode.trim() || !verifiedCargo) return;

    try {
      setCurrentCellQR(qrCode);
      setIsPlacementProcessing(true);

      const response = await apiCall('/api/operator/placement/verify-cell', 'POST', {
        qr_code: qrCode.trim()
      });

      if (response.success) {
        setVerifiedCell(response.cell_info);
        showAlert(`‚úÖ –Ø—á–µ–π–∫–∞ –ø—Ä–æ–≤–µ—Ä–µ–Ω–∞: ${response.cell_info.cell_address}`, 'success');
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞–∑–º–µ—â–∞–µ–º –≥—Ä—É–∑
        const sessionId = placementSessionId || generatePlacementSessionId();
        
        const placementResponse = await apiCall('/api/operator/placement/place-cargo', 'POST', {
          cargo_qr_code: currentCargoQR,
          cell_qr_code: qrCode,
          session_id: sessionId
        });

        if (placementResponse.success) {
          const placementInfo = placementResponse.placement_info;
          showAlert(`üéâ –ì—Ä—É–∑ ${placementInfo.cargo_number} —Ä–∞–∑–º–µ—â–µ–Ω –≤ ${placementInfo.cell_address}!`, 'success');
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
          await fetchPlacementHistory(sessionId);
          
          // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
          setCurrentCargoQR('');
          setCurrentCellQR('');
          setVerifiedCargo(null);
          setVerifiedCell(null);
          setPlacementStep('scan-cargo');

          // –í–æ–∑–≤—Ä–∞—â–∞–µ–º—Å—è –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é –≥—Ä—É–∑–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ü–∏–∫–ª–∞
          setTimeout(() => {
            const cargoInput = document.getElementById('cargo-qr-input');
            if (cargoInput) {
              cargoInput.focus();
            }
          }, 1000);
        } else {
          showAlert(`‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è: ${placementResponse.error}`, 'error');
        }
      } else {
        showAlert(`‚ùå ${response.error}`, 'error');
        setVerifiedCell(null);
      }
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —è—á–µ–π–∫–∏:', error);
      showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —è—á–µ–π–∫–∏: ${error.message}`, 'error');
      setVerifiedCell(null);
    } finally {
      setIsPlacementProcessing(false);
    }
  };

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø INDIVIDUAL UNITS

  // –†–∞–∑–º–µ—â–µ–Ω–∏–µ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –µ–¥–∏–Ω–∏—Ü—ã –≥—Ä—É–∑–∞
  const handlePlaceIndividualUnit = async (unit) => {
    try {
      console.log('üéØ –†–∞–∑–º–µ—â–µ–Ω–∏–µ individual unit:', unit.individual_number);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ–¥–∏–Ω–∏—Ü–∞ –µ—â–µ –Ω–µ —Ä–∞–∑–º–µ—â–µ–Ω–∞
      if (unit.is_placed) {
        showAlert('–≠—Ç–∞ –µ–¥–∏–Ω–∏—Ü–∞ –≥—Ä—É–∑–∞ —É–∂–µ —Ä–∞–∑–º–µ—â–µ–Ω–∞!', 'warning');
        return;
      }
      
      // –£–õ–£–ß–®–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π —É–ª—É—á—à–µ–Ω–Ω—ã–π API —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ–º —Å–∫–ª–∞–¥–∞
      const response = await apiCall('/api/operator/cargo/place-individual', 'POST', {
        individual_number: unit.individual_number,
        // warehouse_id –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        block_number: 1,
        shelf_number: 1,
        cell_number: 1
      });
      
      console.log('‚úÖ Individual unit —Ä–∞–∑–º–µ—â–µ–Ω:', response);
      
      // –£–õ–£–ß–®–ï–ù–ò–ï: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏
      if (response.cargo_name && response.application_progress) {
        const detailMessage = `‚úÖ –†–∞–∑–º–µ—â–µ–Ω –≥—Ä—É–∑: ${response.cargo_name}\nüì¶ –ó–∞—è–≤–∫–∞: ${response.application_number} (${response.application_progress.progress_text})\nüìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ${response.location_code}`;
        showAlert(detailMessage, 'success');
      } else {
        showAlert(`–ï–¥–∏–Ω–∏—Ü–∞ ${unit.individual_number} —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω–∞!`, 'success');
      }
      
      // –£–õ–£–ß–®–ï–ù–ò–ï: –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ –æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
      await fetchPlacementProgress();
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ individual units
      await fetchIndividualUnitsForPlacement(individualUnitsPage, individualUnitsPerPage, cargoTypeFilter, placementStatusFilter);
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è individual unit:', error);
      showAlert(`–û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è: ${error.message}`, 'error');
    }
  };

  // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è individual unit
  const handleOpenIndividualUnitActions = async (unit) => {
    try {
      console.log('üîß –û—Ç–∫—Ä—ã—Ç–∏–µ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è individual unit:', unit.individual_number);
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –µ–¥–∏–Ω–∏—Ü—É –¥–ª—è –ø–æ–∫–∞–∑–∞ –º–æ–¥–∞–ª–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π
      setSelectedUnitForActions(unit);
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–µ–π—Å—Ç–≤–∏–π:', error);
      showAlert(`–û—à–∏–±–∫–∞: ${error.message}`, 'error');
    }
  };

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò: QR –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ø–µ—á–∞—Ç—å –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –Ω–æ–º–µ—Ä–æ–≤

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞ –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –µ–¥–∏–Ω–∏—Ü—ã –≥—Ä—É–∑–∞
  const handleGenerateIndividualQR = async (individualNumber, cargoName) => {
    try {
      console.log('üîÑ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞ –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –µ–¥–∏–Ω–∏—Ü—ã (–ù–û–í–´–ô –ú–ï–¢–û–î):', individualNumber);
      
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π –º–µ—Ç–æ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ (–∫–∞–∫ –≤ —Ä–∞–±–æ—á–µ–π —Å–∏—Å—Ç–µ–º–µ)
      const qrCodeImage = await generateActualQRCode({
        individual_number: individualNumber,
        cargo_name: cargoName
      }, 300, 'individual_unit');
      
      // –°–æ–∑–¥–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–ª–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º QR –∫–æ–¥
      const qrData = {
        individual_number: individualNumber,
        cargo_name: cargoName,
        generated_at: new Date().toLocaleString('ru-RU'),
        qr_image: qrCodeImage
      };
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º QR –≤ –Ω–æ–≤–æ–º –æ–∫–Ω–µ —Å –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–º –¥–∏–∑–∞–π–Ω–æ–º (–∫–∞–∫ –≤ —Ä–∞–±–æ—á–µ–π —Å–∏—Å—Ç–µ–º–µ)
      const qrWindow = window.open('', '_blank', 'width=500,height=600');
      if (qrWindow) {
        qrWindow.document.write(`
          <html>
            <head>
              <title>QR –∫–æ–¥ - ${individualNumber}</title>
              <meta charset="UTF-8">
              <style>
                body { 
                  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
                  text-align: center; 
                  padding: 30px 20px;
                  background: #f8fafc;
                  color: #1e293b;
                  margin: 0;
                }
                .qr-container { 
                  background: white;
                  border-radius: 16px;
                  box-shadow: 0 10px 25px rgba(0,0,0,0.1);
                  padding: 30px;
                  margin: 20px auto;
                  max-width: 400px;
                  border: 1px solid #e2e8f0;
                }
                .system-header {
                  color: #3b82f6;
                  font-size: 14px;
                  font-weight: 600;
                  margin-bottom: 5px;
                  letter-spacing: 0.5px;
                }
                .qr-title { 
                  font-size: 24px; 
                  font-weight: 700; 
                  color: #0f172a;
                  margin-bottom: 8px;
                }
                .qr-subtitle {
                  font-size: 16px;
                  color: #64748b;
                  margin-bottom: 25px;
                  background: #f1f5f9;
                  padding: 8px 16px;
                  border-radius: 8px;
                  font-family: 'Courier New', monospace;
                }
                .qr-image {
                  border: 2px solid #e2e8f0;
                  border-radius: 12px;
                  background: white;
                  padding: 10px;
                  margin: 20px 0;
                }
                .cargo-info {
                  font-size: 18px;
                  font-weight: 600;
                  color: #059669;
                  margin: 15px 0;
                  padding: 12px;
                  background: #ecfdf5;
                  border-radius: 8px;
                  border: 1px solid #a7f3d0;
                }
                .meta-info {
                  font-size: 12px; 
                  color: #94a3b8; 
                  margin-top: 20px;
                  padding-top: 20px;
                  border-top: 1px solid #e2e8f0;
                }
                .scan-instruction {
                  font-size: 14px;
                  color: #475569;
                  background: #fef3c7;
                  padding: 12px;
                  border-radius: 8px;
                  margin: 15px 0;
                  border: 1px solid #fbbf24;
                }
                .success-badge {
                  background: #10b981;
                  color: white;
                  padding: 4px 8px;
                  border-radius: 6px;
                  font-size: 12px;
                  font-weight: 600;
                }
              </style>
            </head>
            <body>
              <div class="qr-container">
                <div class="system-header">–°–ò–°–¢–ï–ú–ê TAJLINE.TJ</div>
                <div class="qr-title">QR –ö–û–î –ì–†–£–ó–ê</div>
                <div class="success-badge">‚úÖ –†–ê–ë–û–¢–ê–Æ–©–ò–ô –§–û–†–ú–ê–¢</div>
                <div class="qr-subtitle">${individualNumber}</div>
                <img src="${qrCodeImage}" alt="QR –∫–æ–¥" class="qr-image" style="width: 280px; height: 280px;" />
                <div class="cargo-info">${cargoName}</div>
                <div class="scan-instruction">
                  üì± –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ —ç—Ç–æ—Ç QR –∫–æ–¥ –ª—é–±—ã–º —Å–∫–∞–Ω–µ—Ä–æ–º<br>
                  –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Ä–∞–±–æ—Ç–∞—é—â–µ–π —Å–∏—Å—Ç–µ–º—ã
                </div>
                <div class="meta-info">
                  –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: ${qrData.generated_at}<br>
                  –ú–µ—Ç–æ–¥: Backend API | –°–∏—Å—Ç–µ–º–∞: TAJLINE
                </div>
              </div>
            </body>
          </html>
        `);
        qrWindow.document.close();
      }
      
      showAlert(`QR –∫–æ–¥ –¥–ª—è ${individualNumber} —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω!`, 'success');
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞:', error);
      showAlert(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞: ${error.message}`, 'error');
    }
  };

  // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø–µ—á–∞—Ç—å QR –∫–æ–¥–∞ –¥–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –µ–¥–∏–Ω–∏—Ü—ã
  const handlePrintIndividualQR = async (individualNumber, cargoName) => {
    try {
      console.log('üñ®Ô∏è –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø–µ—á–∞—Ç—å QR –∫–æ–¥–∞:', individualNumber);
      
      // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –∫–æ–¥ –¥–ª—è –ø–µ—á–∞—Ç–∏
      const qrCodeImage = await generateActualQRCode({
        individual_number: individualNumber,
        cargo_name: cargoName
      }, 300, 'individual_unit');
      
      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏', 'error');
        return;
      }
      
      // –£–ü–†–û–©–ï–ù–ù–´–ô –î–ò–ó–ê–ô–ù: —Ç–æ–ª—å–∫–æ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞, QR –∫–æ–¥ –∏ –Ω–æ–º–µ—Ä
      printWindow.document.write(`
        <html>
          <head>
            <title>QR –∫–æ–¥ - ${individualNumber}</title>
            <meta charset="UTF-8">
            <style>
              @page {
                size: 90mm 100mm;
                margin: 3mm;
              }
              body { 
                font-family: Arial, sans-serif; 
                text-align: center; 
                margin: 0;
                padding: 5mm;
                background: white;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                min-height: 94mm;
              }
              .cargo-name {
                font-size: 14px;
                font-weight: bold;
                color: #000;
                margin-bottom: 8mm;
                word-wrap: break-word;
                max-width: 80mm;
                line-height: 1.2;
              }
              .qr-image {
                margin: 3mm 0;
              }
              .cargo-number {
                font-size: 12px;
                font-weight: bold;
                color: #000;
                margin-top: 8mm;
                font-family: 'Courier New', monospace;
                letter-spacing: 1px;
              }
            </style>
          </head>
          <body onload="window.print(); window.close();">
            <div class="cargo-name">${cargoName}</div>
            <img src="${qrCodeImage}" alt="QR –∫–æ–¥" class="qr-image" style="width: 60mm; height: 60mm;" />
            <div class="cargo-number">${individualNumber}</div>
          </body>
        </html>
      `);
      
      printWindow.document.close();
      
      showAlert(`QR –∫–æ–¥ ${individualNumber} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–µ—á–∞—Ç—å!`, 'success');
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–∞:', error);
      showAlert(`–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–∞: ${error.message}`, 'error');
    }
  };

  // –ú–∞—Å—Å–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤ –¥–ª—è —Ç–∏–ø–∞ –≥—Ä—É–∑–∞
  const handleGenerateMassQRForType = async (cargoType) => {
    try {
      console.log('üîÑ –ú–∞—Å—Å–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö QR –∫–æ–¥–æ–≤ –¥–ª—è —Ç–∏–ø–∞ –≥—Ä—É–∑–∞:', cargoType.type_number);
      
      const qrCodes = [];
      for (const unit of cargoType.individual_units || []) {
        const qrCodeImage = await generateActualQRCode({
          individual_number: unit.individual_number,
          cargo_name: cargoType.cargo_name
        }, 200, 'individual_unit');
        qrCodes.push({
          individual_number: unit.individual_number,
          qr_image: qrCodeImage,
          is_placed: unit.is_placed
        });
      }
      
      // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —Å –º–∞—Å—Å–æ–≤—ã–º–∏ QR –∫–æ–¥–∞–º–∏ –≤ —É–ª—É—á—à–µ–Ω–Ω–æ–º –¥–∏–∑–∞–π–Ω–µ
      const qrWindow = window.open('', '_blank', 'width=900,height=700');
      if (qrWindow) {
        qrWindow.document.write(`
          <html>
            <head>
              <title>QR –∫–æ–¥—ã - ${cargoType.type_number}</title>
              <meta charset="UTF-8">
              <style>
                body { 
                  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif; 
                  padding: 30px; 
                  background: #f8fafc;
                  color: #1e293b;
                  margin: 0;
                }
                .header {
                  text-align: center;
                  margin-bottom: 30px;
                  padding: 20px;
                  background: white;
                  border-radius: 16px;
                  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                }
                .system-title {
                  color: #3b82f6;
                  font-size: 14px;
                  font-weight: 600;
                  margin-bottom: 5px;
                }
                .main-title {
                  font-size: 28px;
                  font-weight: 700;
                  color: #0f172a;
                  margin: 10px 0;
                }
                .cargo-info {
                  font-size: 18px;
                  color: #059669;
                  font-weight: 600;
                }
                .qr-grid { 
                  display: grid; 
                  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
                  gap: 25px; 
                }
                .qr-item { 
                  text-align: center; 
                  background: white;
                  border-radius: 12px;
                  padding: 20px; 
                  box-shadow: 0 4px 15px rgba(0,0,0,0.1);
                  border: 1px solid #e2e8f0;
                }
                .qr-number { 
                  font-size: 16px; 
                  font-weight: 700; 
                  margin-bottom: 15px;
                  font-family: 'Courier New', monospace;
                  color: #1e293b;
                  background: #f1f5f9;
                  padding: 8px 12px;
                  border-radius: 8px;
                }
                .qr-image {
                  border: 2px solid #e2e8f0;
                  border-radius: 8px;
                  background: white;
                  padding: 8px;
                  margin: 15px 0;
                }
                .status-badge {
                  font-size: 12px;
                  padding: 6px 12px;
                  border-radius: 20px;
                  font-weight: 600;
                  margin-top: 10px;
                }
                .status-placed {
                  background: #d1fae5;
                  color: #047857;
                  border: 1px solid #a7f3d0;
                }
                .status-waiting {
                  background: #fef3c7;
                  color: #d97706;
                  border: 1px solid #fbbf24;
                }
                .footer {
                  text-align: center;
                  margin-top: 30px;
                  padding: 15px;
                  background: white;
                  border-radius: 12px;
                  color: #64748b;
                  font-size: 14px;
                }
                @media print {
                  body { background: white; }
                  .qr-item { 
                    page-break-inside: avoid;
                    box-shadow: none;
                    border: 1px solid #000;
                  }
                }
              </style>
            </head>
            <body>
              <div class="header">
                <div class="system-title">–°–ò–°–¢–ï–ú–ê TAJLINE.TJ</div>
                <div class="main-title">QR –ö–û–î–´ –ì–†–£–ó–ê</div>
                <div class="cargo-info">${cargoType.type_number} "${cargoType.cargo_name}"</div>
              </div>
              <div class="qr-grid">
                ${qrCodes.map(qr => `
                  <div class="qr-item">
                    <div class="qr-number">${qr.individual_number}</div>
                    <img src="${qr.qr_image}" class="qr-image" style="width: 180px; height: 180px;" />
                    <div class="status-badge ${qr.is_placed ? 'status-placed' : 'status-waiting'}">
                      ${qr.is_placed ? '‚úÖ –†–∞–∑–º–µ—â–µ–Ω–æ' : '‚è≥ –ñ–¥—ë—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ'}
                    </div>
                  </div>
                `).join('')}
              </div>
              <div class="footer">
                –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ: ${new Date().toLocaleString('ru-RU')} | –°–∏—Å—Ç–µ–º–∞: TAJLINE v2.0<br>
                QR –∫–æ–¥—ã —Å–æ–¥–µ—Ä–∂–∞—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ JSON –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ª—É—á—à–µ–≥–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
              </div>
            </body>
          </html>
        `);
        qrWindow.document.close();
      }
      
      showAlert(`–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ ${qrCodes.length} –ø—Ä–æ–¥–≤–∏–Ω—É—Ç—ã—Ö QR –∫–æ–¥–æ–≤ –¥–ª—è ${cargoType.type_number}!`, 'success');
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤:', error);
      showAlert(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤: ${error.message}`, 'error');
    }
  };

  // –ú–∞—Å—Å–æ–≤–∞—è –ø–µ—á–∞—Ç—å QR –∫–æ–¥–æ–≤ –¥–ª—è —Ç–∏–ø–∞ –≥—Ä—É–∑–∞
  // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –º–∞—Å—Å–æ–≤–∞—è –ø–µ—á–∞—Ç—å QR –∫–æ–¥–æ–≤
  const handlePrintMassQRForType = async (cargoType) => {
    try {
      console.log('üñ®Ô∏è –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –º–∞—Å—Å–æ–≤–∞—è –ø–µ—á–∞—Ç—å QR –∫–æ–¥–æ–≤:', cargoType.type_number);
      
      const qrCodes = [];
      for (const unit of cargoType.individual_units || []) {
        const qrCodeImage = await generateActualQRCode({
          individual_number: unit.individual_number,
          cargo_name: cargoType.cargo_name
        }, 300, 'individual_unit');
        qrCodes.push({
          individual_number: unit.individual_number,
          qr_image: qrCodeImage
        });
      }
      
      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏', 'error');
        return;
      }
      
      // –£–ü–†–û–©–ï–ù–ù–´–ô –î–ò–ó–ê–ô–ù –ú–ê–°–°–û–í–û–ô –ü–ï–ß–ê–¢–ò
      printWindow.document.write(`
        <html>
          <head>
            <title>QR –∫–æ–¥—ã - ${cargoType.type_number}</title>
            <meta charset="UTF-8">
            <style>
              @page {
                size: A4;
                margin: 10mm;
              }
              body { 
                font-family: Arial, sans-serif; 
                margin: 0;
                padding: 0;
              }
              .qr-grid {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
                gap: 10mm;
                page-break-inside: avoid;
              }
              .qr-item {
                border: 1px solid #000;
                padding: 5mm;
                text-align: center;
                page-break-inside: avoid;
                width: 90mm;
                height: 100mm;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
              }
              .cargo-name {
                font-size: 14px;
                font-weight: bold;
                color: #000;
                margin-bottom: 8mm;
                word-wrap: break-word;
                max-width: 80mm;
                line-height: 1.2;
              }
              .qr-image {
                margin: 3mm 0;
              }
              .cargo-number {
                font-size: 12px;
                font-weight: bold;
                color: #000;
                margin-top: 8mm;
                font-family: 'Courier New', monospace;
                letter-spacing: 1px;
              }
              @media print {
                body { margin: 0; padding: 0; }
                .qr-item { break-inside: avoid; }
              }
            </style>
          </head>
          <body>
            <div class="qr-grid">
              ${qrCodes.map(qr => `
                <div class="qr-item">
                  <div class="cargo-name">${cargoType.cargo_name}</div>
                  <img src="${qr.qr_image}" class="qr-image" style="width: 60mm; height: 60mm;" />
                  <div class="cargo-number">${qr.individual_number}</div>
                </div>
              `).join('')}
            </div>
            <script>
              window.onload = function() {
                setTimeout(function() {
                  window.print();
                  window.close();
                }, 1000);
              }
            </script>
          </body>
        </html>
      `);
      printWindow.document.close();
      
      showAlert(`${qrCodes.length} QR –∫–æ–¥–æ–≤ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –Ω–∞ –ø–µ—á–∞—Ç—å!`, 'success');
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–æ–≤:', error);
      showAlert(`–û—à–∏–±–∫–∞ –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–æ–≤: ${error.message}`, 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–∞ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏ (90–º–º x 100–º–º)
  // –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –ø–µ—á–∞—Ç—å QR –∫–æ–¥–∞ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏
  const handlePrintCargoNumberQR = () => {
    if (!cargoNumberQRCode) return;
    
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏', 'error');
      return;
    }
    
    // –ü–æ–ª—É—á–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ –∏–∑ –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∏
    const cargoName = cargoNumberQRCode.request_data?.sender_full_name ? 
                      `–ó–∞—è–≤–∫–∞ –æ—Ç ${cargoNumberQRCode.request_data.sender_full_name}` : 
                      '–ó–∞—è–≤–∫–∞ –Ω–∞ –≥—Ä—É–∑';
    
    // –£–ü–†–û–©–ï–ù–ù–´–ô –î–ò–ó–ê–ô–ù –ø–µ—á–∞—Ç–∏ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏
    printWindow.document.write(`
      <html>
        <head>
          <title>QR –∫–æ–¥ - ${cargoNumberQRCode.number}</title>
          <meta charset="UTF-8">
          <style>
            @page {
              size: 90mm 100mm;
              margin: 3mm;
            }
            body { 
              font-family: Arial, sans-serif; 
              text-align: center; 
              margin: 0;
              padding: 5mm;
              background: white;
              display: flex;
              flex-direction: column;
              justify-content: center;
              align-items: center;
              min-height: 94mm;
            }
            .cargo-name {
              font-size: 14px;
              font-weight: bold;
              color: #000;
              margin-bottom: 8mm;
              word-wrap: break-word;
              max-width: 80mm;
              line-height: 1.2;
            }
            .qr-image {
              margin: 3mm 0;
            }
            .cargo-number {
              font-size: 12px;
              font-weight: bold;
              color: #000;
              margin-top: 8mm;
              font-family: 'Courier New', monospace;
              letter-spacing: 1px;
            }
            @media print {
              body { 
                margin: 0; 
                padding: 5mm;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
              }
            }
          </style>
        </head>
        <body onload="setTimeout(function(){ window.print(); window.close(); }, 500);">
          <div class="cargo-name">${cargoName}</div>
          <img src="${cargoNumberQRCode.image}" alt="QR –∫–æ–¥" class="qr-image" style="width: 60mm; height: 60mm;" />
          <div class="cargo-number">${cargoNumberQRCode.number}</div>
        </body>
      </html>
    `);
    printWindow.document.close();
    
    showAlert('QR –∫–æ–¥ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–µ—á–∞—Ç—å (90–º–º x 100–º–º)!', 'success');
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞ –æ—Ç–¥–µ–ª—å–Ω–æ–π —è—á–µ–π–∫–∏
  const generateSingleCellQR = async () => {
    if (!singleCellBlock || !singleCellShelf || !singleCellNumber) {
      showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è (–ë–ª–æ–∫, –ü–æ–ª–∫–∞, –Ø—á–µ–π–∫–∞)', 'error');
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤–≤–µ–¥–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
    if (!/^\d+$/.test(singleCellBlock) || !/^\d+$/.test(singleCellShelf) || !/^\d+$/.test(singleCellNumber)) {
      showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–æ–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã –≤ –ø–æ–ª—è –ë–ª–æ–∫, –ü–æ–ª–∫–∞ –∏ –Ø—á–µ–π–∫–∞', 'error');
      return;
    }

    setSingleCellQRLoading(true);
    try {
      console.log('üèóÔ∏è –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞ –¥–ª—è —è—á–µ–π–∫–∏:', `–ë${singleCellBlock}-–ü${singleCellShelf}-–Ø${singleCellNumber}`);
      
      const response = await apiCall('/api/warehouse/cell/generate-qr', 'POST', {
        warehouse_id: selectedWarehouseForManagement?.id || 'default',
        block: parseInt(singleCellBlock),
        shelf: parseInt(singleCellShelf),
        cell: parseInt(singleCellNumber),
        format: 'id' // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π ID —Ñ–æ—Ä–º–∞—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      });
      
      if (response && response.success) {
        setSingleCellQRResult({
          location: response.readable_name || `–ë${singleCellBlock}-–ü${singleCellShelf}-–Ø${singleCellNumber}`,
          readable_name: response.readable_name || `–ë${singleCellBlock}-–ü${singleCellShelf}-–Ø${singleCellNumber}`,
          cell_code: response.cell_code,
          warehouse_id_number: response.warehouse_id_number,
          format_type: response.format_type,
          qr_code: response.qr_code,
          success: true
        });
        console.log('‚úÖ QR –∫–æ–¥ —Å–æ–∑–¥–∞–Ω:', response.cell_code, '–¥–ª—è –ø–µ—á–∞—Ç–∏:', response.readable_name);
        showAlert(`QR –∫–æ–¥ –¥–ª—è —è—á–µ–π–∫–∏ ${response.readable_name || `–ë${singleCellBlock}-–ü${singleCellShelf}-–Ø${singleCellNumber}`} —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!`, 'success');
      } else {
        setSingleCellQRResult({
          location: `–ë${singleCellBlock}-–ü${singleCellShelf}-–Ø${singleCellNumber}`,
          success: false,
          error: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å QR –∫–æ–¥'
        });
        showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è QR –∫–æ–¥–∞', 'error');
      }
    } catch (error) {
      console.error('Error generating single cell QR:', error);
      setSingleCellQRResult({
        location: `–ë${singleCellBlock}-–ü${singleCellShelf}-–Ø${singleCellNumber}`,
        success: false,
        error: error.message
      });
      showAlert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è QR –∫–æ–¥–∞: ${error.message}`, 'error');
    } finally {
      setSingleCellQRLoading(false);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Å–±—Ä–æ—Å–∞ —Ñ–æ—Ä–º—ã –æ—Ç–¥–µ–ª—å–Ω–æ–π —è—á–µ–π–∫–∏
  const resetSingleCellForm = () => {
    setSingleCellBlock('');
    setSingleCellShelf('');
    setSingleCellNumber('');
    setSingleCellQRResult(null);
    setSingleCellQRLoading(false);
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
  const stopMobileScanning = async () => {
    try {
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–∫–∞–Ω–µ—Ä—ã
      setSearchScannerActive(false);
      setPlacementActive(false);
      setScannerActive(false);
      setScannerMode('none');
      setScannerError(null);
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è
      setMobilePlacementStep('start');
      setReceiveStep('start');
      setScannedCargo(null);
      setScannedCell(null);
      setReceivedCargo(null);
      setNewCell(null);
      setSearchResult(null);
      setPlacementInfoMessage('');
      
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–∞–º–µ—Ä—É
      await stopCameraScanner();
      await completeQrCleanup("Mobile scanning stopped");
      
      showAlert('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'info');
    } catch (error) {
      console.error('Error stopping mobile scanning:', error);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–æ–π
  const performMobilePlacement = async (cargo, cell) => {
    try {
      // –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ
      await handlePlaceCargo(
        cargo.id,
        cell.warehouse_id,
        cell.block_number,
        cell.shelf_number,
        cell.cell_number
      );
      
      // –§–æ—Ä–º–∏—Ä—É–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–∑–º–µ—â–µ–Ω–Ω–æ–º –≥—Ä—É–∑–µ
      const placementInfo = `–ì—Ä—É–∑: ${cargo.cargo_number} - –ë${cell.block_number}-–ü${cell.shelf_number}-–Ø${cell.cell_number}`;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏–π —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
      setSessionPlacements(prev => [...prev, placementInfo]);
      setSessionPlacementCount(prev => prev + 1);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å —É—Å–ø–µ—Ö–æ–º (–±–µ–∑ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π)
      setPlacementInfoMessage(`üéâ –ì—Ä—É–∑ ${cargo.cargo_number} —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ –ë${cell.block_number}-–ü${cell.shelf_number}-–Ø${cell.cell_number}! –ü—Ä–∏—Å—Ç—É–ø–∏—Ç–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≥—Ä—É–∑—É.`);
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è  
      setMobilePlacementStep('scan-cargo');
      setScannerMode('mobile-placement-cargo');
      setScannedCargo(null);
      setScannedCell(null);
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –µ–¥–∏–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ —É—Å–ø–µ—à–Ω–æ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ (–≤–º–µ—Å—Ç–æ –¥–≤–æ–π–Ω–æ–≥–æ)
      showAlert(`üéâ –ì—Ä—É–∑ ${cargo.cargo_number} —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ –ë${cell.block_number}-–ü${cell.shelf_number}-–Ø${cell.cell_number}!`, 'success');
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≥—Ä—É–∑–∞
      setTimeout(() => {
        setPlacementInfoMessage('–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ —Å–ª–µ–¥—É—é—â–µ–≥–æ –≥—Ä—É–∑–∞ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è.');
      }, 4000); // –£–≤–µ–ª–∏—á–∏–ª–∏ –≤—Ä–µ–º—è –ø–æ–∫–∞–∑–∞ –¥–æ 4 —Å–µ–∫—É–Ω–¥
      
    } catch (error) {
      console.error('Error in mobile placement:', error);
      setPlacementInfoMessage(`‚ùå –û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞ ${cargo.cargo_number}: ${error.message}`);
      throw error;
    }
  };

  // New function: Validate cargo number
  const validateCargoNumber = async (cargoNumber) => {
    if (!cargoNumber.trim()) {
      setCargoValidation({ isValid: false, cargoInfo: null, isLoading: false });
      return;
    }

    setCargoValidation({ isValid: false, cargoInfo: null, isLoading: true });

    try {
      // Check if cargo exists by scanning QR endpoint
      const response = await apiCall('/api/qr/scan', 'POST', {
        qr_text: cargoNumber.trim()
      });
      
      if (response && response.type === 'cargo') {
        setCargoValidation({
          isValid: true,
          cargoInfo: {
            cargo_number: response.cargo_number,
            cargo_name: response.cargo_name,
            weight: response.weight,
            sender: response.sender,
            recipient: response.recipient
          },
          isLoading: false
        });
      } else {
        setCargoValidation({
          isValid: false,
          cargoInfo: null,
          isLoading: false
        });
      }
    } catch (error) {
      console.error('Error validating cargo:', error);
      setCargoValidation({
        isValid: false,
        cargoInfo: null,
        isLoading: false
      });
    }
  };

  // New function: Get available warehouse cells
  const getAvailableWarehouseCells = async () => {
    setCellValidation({ availableCells: [], selectedWarehouse: null, isLoading: true });

    try {
      // Get user's assigned warehouses
      const warehousesResponse = await apiCall('/api/warehouses');
      
      if (warehousesResponse && warehousesResponse.length > 0) {
        const warehouse = warehousesResponse[0]; // Use first available warehouse
        
        // Get warehouse structure
        const structureResponse = await apiCall(`/api/warehouses/${warehouse.id}/structure`);
        
        if (structureResponse) {
          // Generate available cells (free cells only)
          const availableCells = [];
          
          for (let block = 1; block <= structureResponse.blocks; block++) {
            for (let shelf = 1; shelf <= structureResponse.shelves_per_block; shelf++) {
              for (let cell = 1; cell <= structureResponse.cells_per_shelf; cell++) {
                // Check if cell is occupied
                const isOccupied = structureResponse.cells.some(c => 
                  c.block === block && c.shelf === shelf && c.cell === cell && c.is_occupied
                );
                
                if (!isOccupied) {
                  availableCells.push({
                    warehouse_id: warehouse.id,
                    warehouse_name: warehouse.name,
                    block: block,
                    shelf: shelf,
                    cell: cell,
                    code: `${warehouse.id}-–ë${block}-–ü${shelf}-–Ø${cell}`,
                    display: `–ë–ª–æ–∫ ${block}, –ü–æ–ª–∫–∞ ${shelf}, –Ø—á–µ–π–∫–∞ ${cell}`
                  });
                }
              }
            }
          }
          
          setCellValidation({
            availableCells: availableCells.slice(0, 20), // Show first 20 available cells
            selectedWarehouse: warehouse,
            isLoading: false
          });
        }
      }
    } catch (error) {
      console.error('Error getting available cells:', error);
      setCellValidation({ availableCells: [], selectedWarehouse: null, isLoading: false });
    }
  };

  // New function: Manual cargo placement
  const handleManualPlacement = async () => {
    if (!manualCargoNumber.trim() || !manualCellCode.trim()) {
      showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≥—Ä—É–∑–∞ –∏ –∫–æ–¥ —è—á–µ–π–∫–∏', 'error');
      return;
    }

    try {
      const success = await placeCargoInCell(manualCargoNumber.trim(), manualCellCode.trim());
      
      if (success) {
        showAlert('–ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω –≤—Ä—É—á–Ω—É—é!', 'success');
        setManualCargoNumber('');
        setManualCellCode('');
        await fetchPlacementStatistics();
      }
    } catch (error) {
      console.error('Error in manual placement:', error);
      showAlert(`–û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è: ${error.message}`, 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–ø—É—Å–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å –≤–Ω–µ—à–Ω–∏–º —Å–∫–∞–Ω–µ—Ä–æ–º
  const startExternalScannerPlacement = async () => {
    try {
      console.log('üñ•Ô∏è –§–ê–ó–ê 4: –ó–∞–ø—É—Å–∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞ —Å –≤–Ω–µ—à–Ω–∏–º —Å–∫–∞–Ω–µ—Ä–æ–º...');
      
      setExternalScannerActive(true);
      setExternalScannerStep('cargo');
      setExternalCargoInput('');
      setExternalCellInput('');
      setExternalScannedCargo(null);
      setExternalScannedCell(null);
      setScannerMode('external-scanner');
      setScannerMessage('–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –≥—Ä—É–∑–∞ —Å –ø–æ–º–æ—â—å—é –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞');
      
      // –§–ê–ó–ê 3: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∑–∞—â–∏—Ç—ã –æ—Ç –∫–ª–∏–∫–æ–≤ –∏ –∞–≤—Ç–æ—Ñ–æ–∫—É—Å–∞
      setScannerClickProtection(true);
      setScannerAutoFocusTarget('cargo');
      
      // –§–ê–ó–ê 4: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
      setScannerAutoTransition(true);
      setScannerCompletionCount(0);
      setScannerAutoReset(false);
      
      // –§–ê–ó–ê 4: –£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Ñ–æ–∫—É—Å –Ω–∞ –ø–æ–ª–µ –≥—Ä—É–∑–∞
      setTimeout(() => {
        const cargoInput = document.querySelector('input[placeholder*="–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –≥—Ä—É–∑–∞"]');
        if (cargoInput) {
          cargoInput.focus();
          cargoInput.select(); // –§–ê–ó–ê 4: –í—ã–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–º–µ–Ω—ã
          console.log('üñ•Ô∏è –§–ê–ó–ê 4: –ê–≤—Ç–æ—Ñ–æ–∫—É—Å —Å –≤—ã–¥–µ–ª–µ–Ω–∏–µ–º —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –Ω–∞ –ø–æ–ª–µ –≥—Ä—É–∑–∞');
        }
      }, 100); // –§–ê–ó–ê 4: –ë—ã—Å—Ç—Ä–µ–µ –ø–µ—Ä–µ—Ö–æ–¥
      
      // Fetch statistics and available cells
      await fetchPlacementStatistics();
      await getAvailableWarehouseCells();
      
      showAlert('üñ•Ô∏è –†–µ–∂–∏–º –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω! –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –≥—Ä—É–∑–∞.', 'info');
      
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞', 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞
  const stopExternalScannerPlacement = () => {
    console.log('üõë –§–ê–ó–ê 4: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å –≤–Ω–µ—à–Ω–∏–º —Å–∫–∞–Ω–µ—Ä–æ–º...');
    
    setExternalScannerActive(false);
    setExternalScannerStep('cargo');
    setExternalCargoInput('');
    setExternalCellInput('');
    setExternalScannedCargo(null);
    setExternalScannedCell(null);
    setScannerMode('none');
    setScannerMessage('');
    
    // –§–ê–ó–ê 3: –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏–π –∑–∞—â–∏—Ç—ã –∏ –∞–≤—Ç–æ—Ñ–æ–∫—É—Å–∞
    setScannerProcessingInput(false);
    setScannerAutoFocusTarget(null);
    setScannerClickProtection(false);
    
    // –§–ê–ó–ê 4: –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤
    setScannerAutoTransition(false);
    setScannerCompletionCount(0);
    setScannerAutoReset(false);
    
    console.log('üõë –§–ê–ó–ê 4: –í–Ω–µ—à–Ω–∏–π —Å–∫–∞–Ω–µ—Ä –ø–æ–ª–Ω–æ—Å—Ç—å—é –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω —Å –∞–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥–∞–º–∏');
  };

  // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–≤–æ–¥–∞ –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞ –¥–ª—è –≥—Ä—É–∑–∞
  const handleExternalCargoScan = async (cargoData) => {
    try {
      // –§–ê–ó–ê 3: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
      setScannerProcessingInput(true);
      setScannerClickProtection(true);
      
      const extractedData = extractCargoNumber(cargoData);
      console.log('üñ•Ô∏è –§–ê–ó–ê 3: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ –≤–Ω–µ—à–Ω–∏–º —Å–∫–∞–Ω–µ—Ä–æ–º:', extractedData);
      
      let foundCargo = null;
      let foundIndividualUnit = null;
      
      // –≠–¢–ê–ü 2: –£–õ–£–ß–®–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –ü–û–ò–°–ö–ê –ü–û –¢–†–ï–ú –¢–ò–ü–ê–ú QR –ö–û–î–û–í
      switch (extractedData.type) {
        case 'UNIT_IN_CARGO_TYPE':
          // –¢–ò–ü 3: –ü–æ–∏—Å–∫ –µ–¥–∏–Ω–∏—Ü—ã –≥—Ä—É–∑–∞ –≤–Ω—É—Ç—Ä–∏ —Ç–∏–ø–∞ (010101.01.01)
          console.log('üîç –°–¶–ï–ù–ê–†–ò–ô 3: –ü–æ–∏—Å–∫ –µ–¥–∏–Ω–∏—Ü—ã –≥—Ä—É–∑–∞ –≤–Ω—É—Ç—Ä–∏ —Ç–∏–ø–∞:', extractedData.full_number);
          console.log('   ‚Üí –ó–∞—è–≤–∫–∞:', extractedData.request_number);  
          console.log('   ‚Üí –¢–∏–ø –≥—Ä—É–∑–∞:', extractedData.cargo_type);
          console.log('   ‚Üí –ï–¥–∏–Ω–∏—Ü–∞:', extractedData.unit_number);
          
          // 1. –ù–∞–π—Ç–∏ –∑–∞—è–≤–∫—É –ø–æ –æ—Å–Ω–æ–≤–Ω–æ–º—É –Ω–æ–º–µ—Ä—É
          const requestForUnit = availableCargoForPlacement.find(item => 
            item.cargo_number === extractedData.request_number
          );
          
          if (requestForUnit) {
            console.log('‚úÖ –°–¶–ï–ù–ê–†–ò–ô 3: –ó–∞—è–≤–∫–∞ –Ω–∞–π–¥–µ–Ω–∞:', requestForUnit.cargo_number);
            
            if (requestForUnit.cargo_items && requestForUnit.cargo_items.length > 0) {
              // 2. –ù–∞–π—Ç–∏ —Ç–∏–ø –≥—Ä—É–∑–∞ –≤–Ω—É—Ç—Ä–∏ –∑–∞—è–≤–∫–∏
              const targetCargoItem = requestForUnit.cargo_items.find(item => 
                item.type_number == extractedData.cargo_type || 
                String(item.type_number).padStart(2, '0') === extractedData.cargo_type
              );
              
              if (targetCargoItem) {
                console.log('‚úÖ –°–¶–ï–ù–ê–†–ò–ô 3: –¢–∏–ø –≥—Ä—É–∑–∞ –Ω–∞–π–¥–µ–Ω:', targetCargoItem.type_number);
                
                if (targetCargoItem.individual_items && targetCargoItem.individual_items.length > 0) {
                  // 3. –ù–∞–π—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –µ–¥–∏–Ω–∏—Ü—É –≤–Ω—É—Ç—Ä–∏ —Ç–∏–ø–∞ –≥—Ä—É–∑–∞
                  const individualUnit = targetCargoItem.individual_items.find(unit => 
                    unit.unit_index == extractedData.unit_number || 
                    String(unit.unit_index).padStart(2, '0') === extractedData.unit_number ||
                    String(unit.unit_index) === extractedData.unit_number ||
                    unit.individual_number === extractedData.full_number
                  );
                  
                  if (individualUnit) {
                    foundCargo = requestForUnit;
                    foundIndividualUnit = {
                      ...individualUnit,
                      cargo_item: targetCargoItem,
                      cargo_type_number: targetCargoItem.type_number,
                      search_type: 'UNIT_IN_CARGO_TYPE'
                    };
                    console.log('‚úÖ –°–¶–ï–ù–ê–†–ò–ô 3: –ï–¥–∏–Ω–∏—Ü–∞ –Ω–∞–π–¥–µ–Ω–∞:', foundIndividualUnit);
                  } else {
                    console.log('‚ùå –°–¶–ï–ù–ê–†–ò–ô 3: –ï–¥–∏–Ω–∏—Ü–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–ø–∏—Å–∫–µ individual_items');
                    console.log('   ‚Üí –î–æ—Å—Ç—É–ø–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã:', targetCargoItem.individual_items.map(u => u.unit_index || u.individual_number));
                  }
                } else {
                  console.log('‚ùå –°–¶–ï–ù–ê–†–ò–ô 3: –£ –≥—Ä—É–∑–∞ –Ω–µ—Ç –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü');
                }
              } else {
                console.log('‚ùå –°–¶–ï–ù–ê–†–ò–ô 3: –¢–∏–ø –≥—Ä—É–∑–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∑–∞—è–≤–∫–µ');
                console.log('   ‚Üí –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã:', requestForUnit.cargo_items.map(item => item.type_number));
              }
            } else {
              console.log('‚ùå –°–¶–ï–ù–ê–†–ò–ô 3: –í –∑–∞—è–≤–∫–µ –Ω–µ—Ç cargo_items');
            }
          } else {
            console.log('‚ùå –°–¶–ï–ù–ê–†–ò–ô 3: –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            console.log('   ‚Üí –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞—è–≤–∫–∏:', availableCargoForPlacement.map(item => item.cargo_number));
          }
          break;
          
        case 'CARGO_IN_REQUEST':
          // –¢–ò–ü 2: –ü–æ–∏—Å–∫ –≥—Ä—É–∑–∞ –≤–Ω—É—Ç—Ä–∏ –∑–∞—è–≤–∫–∏ (010101.01)
          console.log('üîç –°–¶–ï–ù–ê–†–ò–ô 2: –ü–æ–∏—Å–∫ –≥—Ä—É–∑–∞ –≤–Ω—É—Ç—Ä–∏ –∑–∞—è–≤–∫–∏:', extractedData.full_number);
          console.log('   ‚Üí –ó–∞—è–≤–∫–∞:', extractedData.request_number);
          console.log('   ‚Üí –¢–∏–ø –≥—Ä—É–∑–∞:', extractedData.cargo_type);
          
          // 1. –ù–∞–π—Ç–∏ –∑–∞—è–≤–∫—É –ø–æ –æ—Å–Ω–æ–≤–Ω–æ–º—É –Ω–æ–º–µ—Ä—É
          const requestForCargo = availableCargoForPlacement.find(item => 
            item.cargo_number === extractedData.request_number
          );
          
          if (requestForCargo) {
            console.log('‚úÖ –°–¶–ï–ù–ê–†–ò–ô 2: –ó–∞—è–≤–∫–∞ –Ω–∞–π–¥–µ–Ω–∞:', requestForCargo.cargo_number);
            
            if (requestForCargo.cargo_items && requestForCargo.cargo_items.length > 0) {
              // 2. –ù–∞–π—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–π –≥—Ä—É–∑ –ø–æ —Ç–∏–ø—É –≤–Ω—É—Ç—Ä–∏ –∑–∞—è–≤–∫–∏
              const targetCargoItem = requestForCargo.cargo_items.find(item => 
                item.type_number == extractedData.cargo_type ||
                String(item.type_number).padStart(2, '0') === extractedData.cargo_type
              );
              
              if (targetCargoItem) {
                foundCargo = requestForCargo;
                console.log('‚úÖ –°–¶–ï–ù–ê–†–ò–ô 2: –ì—Ä—É–∑ –Ω–∞–π–¥–µ–Ω:', targetCargoItem.type_number);
                
                // –ï—Å–ª–∏ –µ—Å—Ç—å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã, –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é –∫–∞–∫ –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å–Ω—É—é
                if (targetCargoItem.individual_items && targetCargoItem.individual_items.length > 0) {
                  foundIndividualUnit = {
                    ...targetCargoItem.individual_items[0],
                    cargo_item: targetCargoItem,
                    cargo_type_number: targetCargoItem.type_number,
                    search_type: 'CARGO_IN_REQUEST',
                    represents_all_units: true,
                    total_units: targetCargoItem.individual_items.length
                  };
                  console.log('‚úÖ –°–¶–ï–ù–ê–†–ò–ô 2: –ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ —Å–æ–∑–¥–∞–Ω–∞:', foundIndividualUnit);
                } else {
                  // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å–Ω—É—é –µ–¥–∏–Ω–∏—Ü—É –¥–ª—è –≤—Å–µ–≥–æ –≥—Ä—É–∑–∞
                  foundIndividualUnit = {
                    cargo_item: targetCargoItem,
                    cargo_type_number: targetCargoItem.type_number,
                    search_type: 'CARGO_IN_REQUEST',
                    represents_all_cargo: true,
                    cargo_name: targetCargoItem.cargo_name || `–ì—Ä—É–∑ —Ç–∏–ø–∞ ${targetCargoItem.type_number}`,
                    quantity: targetCargoItem.quantity || 1
                  };
                  console.log('‚úÖ –°–¶–ï–ù–ê–†–ò–ô 2: –ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –¥–ª—è –≤—Å–µ–≥–æ –≥—Ä—É–∑–∞ —Å–æ–∑–¥–∞–Ω–∞:', foundIndividualUnit);
                }
              } else {
                console.log('‚ùå –°–¶–ï–ù–ê–†–ò–ô 2: –ì—Ä—É–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ –∑–∞—è–≤–∫–µ');
                console.log('   ‚Üí –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ç–∏–ø—ã –≥—Ä—É–∑–æ–≤:', requestForCargo.cargo_items.map(item => item.type_number));
              }
            } else {
              console.log('‚ùå –°–¶–ï–ù–ê–†–ò–ô 2: –í –∑–∞—è–≤–∫–µ –Ω–µ—Ç cargo_items');
            }
          } else {
            console.log('‚ùå –°–¶–ï–ù–ê–†–ò–ô 2: –ó–∞—è–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞');
            console.log('   ‚Üí –î–æ—Å—Ç—É–ø–Ω—ã–µ –∑–∞—è–≤–∫–∏:', availableCargoForPlacement.map(item => item.cargo_number));
          }
          break;
          
        case 'SIMPLE_CARGO':
          // –¢–ò–ü 1: –ü–æ–∏—Å–∫ –ø—Ä–æ—Å—Ç–æ–≥–æ –≥—Ä—É–∑–∞ (123456)
          console.log('üîç –°–¶–ï–ù–ê–†–ò–ô 1: –ü–æ–∏—Å–∫ –ø—Ä–æ—Å—Ç–æ–≥–æ –≥—Ä—É–∑–∞ –ø–æ –Ω–æ–º–µ—Ä—É:', extractedData.cargo_number);
          
          // –ü–æ–∏—Å–∫: availableCargoForPlacement.find(cargo => cargo.cargo_number === qrCode)
          foundCargo = availableCargoForPlacement.find(item => 
            item.cargo_number === extractedData.cargo_number ||
            item.id === extractedData.cargo_number ||
            String(item.cargo_number) === String(extractedData.cargo_number)
          );
          
          if (foundCargo) {
            console.log('‚úÖ –°–¶–ï–ù–ê–†–ò–ô 1: –ü—Ä–æ—Å—Ç–æ–π –≥—Ä—É–∑ –Ω–∞–π–¥–µ–Ω:', foundCargo.cargo_number);
            console.log('   ‚Üí –ù–∞–∑–≤–∞–Ω–∏–µ:', foundCargo.cargo_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ');
            console.log('   ‚Üí ID:', foundCargo.id);
            console.log('   ‚Üí –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ cargo_items:', foundCargo.cargo_items?.length || 0);
            
            // –î–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –≥—Ä—É–∑–∞ –ø—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ cargo_items
            if (foundCargo.cargo_items && foundCargo.cargo_items.length > 0) {
              console.log('üì¶ –°–¶–ï–ù–ê–†–ò–ô 1: –£ –ø—Ä–æ—Å—Ç–æ–≥–æ –≥—Ä—É–∑–∞ –µ—Å—Ç—å cargo_items, –±–µ—Ä–µ–º –ø–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç –∫–∞–∫ –æ—Å–Ω–æ–≤–Ω–æ–π');
              const mainCargoItem = foundCargo.cargo_items[0];
              
              // –°–æ–∑–¥–∞–µ–º –ø—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å–Ω—É—é –µ–¥–∏–Ω–∏—Ü—É –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ –≥—Ä—É–∑–∞
              foundIndividualUnit = {
                cargo_item: mainCargoItem,
                cargo_type_number: mainCargoItem.type_number || '01',
                search_type: 'SIMPLE_CARGO',
                represents_simple_cargo: true,
                cargo_name: mainCargoItem.cargo_name || foundCargo.cargo_name || '–ü—Ä–æ—Å—Ç–æ–π –≥—Ä—É–∑',
                quantity: mainCargoItem.quantity || 1
              };
              console.log('‚úÖ –°–¶–ï–ù–ê–†–ò–ô 1: –ü—Ä–µ–¥—Å—Ç–∞–≤–∏—Ç–µ–ª—å–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞ –ø—Ä–æ—Å—Ç–æ–≥–æ –≥—Ä—É–∑–∞ —Å–æ–∑–¥–∞–Ω–∞:', foundIndividualUnit);
            } else {
              console.log('üì¶ –°–¶–ï–ù–ê–†–ò–ô 1: –ü—Ä–æ—Å—Ç–æ–π –≥—Ä—É–∑ –±–µ–∑ cargo_items - —ç—Ç–æ –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –∑–∞—è–≤–∫–∞');
              // –ì—Ä—É–∑ –±–µ–∑ cargo_items - —ç—Ç–æ —Å—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç –∏–ª–∏ –µ–¥–∏–Ω–∏—á–Ω—ã–π –≥—Ä—É–∑
            }
          } else {
            console.log('‚ùå –°–¶–ï–ù–ê–†–ò–ô 1: –ü—Ä–æ—Å—Ç–æ–π –≥—Ä—É–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
            console.log('   ‚Üí –ò—Å–∫–∞–ª–∏ –Ω–æ–º–µ—Ä:', extractedData.cargo_number);
            console.log('   ‚Üí –î–æ—Å—Ç—É–ø–Ω—ã–µ –≥—Ä—É–∑—ã:', availableCargoForPlacement.map(item => 
              `${item.cargo_number} (ID: ${item.id})`
            ));
          }
          break;
          
        // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –¢–ò–ü–´ –î–õ–Ø –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò
        case 'JSON_CARGO':
        case 'JSON_REQUEST':
        case 'PREFIXED_CARGO':
        case 'GENERIC_NUMBER':
          // –£–ª—É—á—à–µ–Ω–Ω—ã–π –ø–æ–∏—Å–∫ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤
          console.log('üîç –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨: –ü–æ–∏—Å–∫ –¥–ª—è —Ç–∏–ø–∞', extractedData.type);
          const searchNumber = extractedData.cargo_number || extractedData.request_number;
          
          // –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –ø—Ä—è–º–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
          foundCargo = availableCargoForPlacement.find(item => 
            item.cargo_number === searchNumber || 
            item.id === searchNumber
          );
          
          // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
          if (!foundCargo) {
            foundCargo = availableCargoForPlacement.find(item => 
              extractedData.full_number.includes(item.cargo_number) ||
              item.cargo_number.includes(searchNumber)
            );
          }
          
          console.log(`${foundCargo ? '‚úÖ' : '‚ùå'} –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–¨: –ü–æ–∏—Å–∫ ${extractedData.type}:`, 
                     searchNumber, foundCargo ? '–Ω–∞–π–¥–µ–Ω' : '–Ω–µ –Ω–∞–π–¥–µ–Ω');
          break;
          
        default:
          // –£–ª—É—á—à–µ–Ω–Ω—ã–π fallback –ø–æ–∏—Å–∫ –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã—Ö —Ç–∏–ø–æ–≤
          console.log('üîç FALLBACK: –ü–æ–∏—Å–∫ –¥–ª—è –Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ–≥–æ —Ç–∏–ø–∞:', extractedData.type);
          console.log('   ‚Üí –ò—Å—Ö–æ–¥–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:', cargoData);
          
          // 1. –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏
          foundCargo = availableCargoForPlacement.find(item => 
            item.cargo_number === cargoData || 
            item.id === cargoData
          );
          
          // 2. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —á–∞—Å—Ç–∏—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ
          if (!foundCargo) {
            foundCargo = availableCargoForPlacement.find(item => 
              cargoData.includes(item.cargo_number) ||
              item.cargo_number.includes(cargoData)
            );
          }
          
          // 3. –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω, –ø–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å –∏–∑–≤–ª–µ—á—å –ª—é–±—ã–µ —Ü–∏—Ñ—Ä—ã
          if (!foundCargo) {
            const anyNumbers = cargoData.match(/\d+/g);
            if (anyNumbers && anyNumbers.length > 0) {
              for (const number of anyNumbers) {
                foundCargo = availableCargoForPlacement.find(item => 
                  item.cargo_number === number || item.id === number
                );
                if (foundCargo) break;
              }
            }
          }
          
          console.log(`${foundCargo ? '‚úÖ' : '‚ùå'} FALLBACK: –†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ–∏—Å–∫–∞:`, 
                     foundCargo ? foundCargo.cargo_number : '–Ω–µ –Ω–∞–π–¥–µ–Ω');
      }

      if (foundCargo) {
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –Ω–∞–π–¥–µ–Ω–Ω–æ–º –≥—Ä—É–∑–µ –∏ –µ–¥–∏–Ω–∏—Ü–µ
        setExternalScannedCargo({
          ...foundCargo,
          selected_individual_unit: foundIndividualUnit
        });
        
        // –≠–¢–ê–ü 4: –¢–û–ß–ù–´–ï UI –°–û–û–ë–©–ï–ù–ò–Ø –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ QR –∫–æ–¥–∞
        let successMessage = '';
        let alertMessage = '';
        
        if (foundIndividualUnit) {
          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü
          switch (foundIndividualUnit.search_type) {
            case 'UNIT_IN_CARGO_TYPE':
              // –¢–ò–ü 3: "‚úÖ –ï–¥–∏–Ω–∏—Ü–∞ 01 –≥—Ä—É–∑–∞ —Ç–∏–ø–∞ 01 –∏–∑ –∑–∞—è–≤–∫–∏ 010101 –Ω–∞–π–¥–µ–Ω–∞!"
              successMessage = `‚úÖ –ï–¥–∏–Ω–∏—Ü–∞ ${extractedData.unit_number} –≥—Ä—É–∑–∞ —Ç–∏–ø–∞ ${extractedData.cargo_type} –∏–∑ –∑–∞—è–≤–∫–∏ ${extractedData.request_number} –Ω–∞–π–¥–µ–Ω–∞!
üì¶ –ì—Ä—É–∑: ${foundIndividualUnit.cargo_item?.cargo_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥—Ä—É–∑'}
üìä –°—Ç–∞—Ç—É—Å: –ì–æ—Ç–æ–≤ –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é
üéØ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —è—á–µ–π–∫—É –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è`;
              alertMessage = `‚úÖ –ï–¥–∏–Ω–∏—Ü–∞ ${extractedData.unit_number} –≥—Ä—É–∑–∞ —Ç–∏–ø–∞ ${extractedData.cargo_type} –∏–∑ –∑–∞—è–≤–∫–∏ ${extractedData.request_number} –Ω–∞–π–¥–µ–Ω–∞!`;
              break;
              
            case 'CARGO_IN_REQUEST':
              // –¢–ò–ü 2: "‚úÖ –ì—Ä—É–∑ 01 –∏–∑ –∑–∞—è–≤–∫–∏ 010101 –Ω–∞–π–¥–µ–Ω!"
              if (foundIndividualUnit.represents_all_units) {
                successMessage = `‚úÖ –ì—Ä—É–∑ ${extractedData.cargo_type} –∏–∑ –∑–∞—è–≤–∫–∏ ${extractedData.request_number} –Ω–∞–π–¥–µ–Ω!
üì¶ –ì—Ä—É–∑: ${foundIndividualUnit.cargo_item?.cargo_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥—Ä—É–∑'}
üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –µ–¥–∏–Ω–∏—Ü: ${foundIndividualUnit.total_units || foundIndividualUnit.cargo_item?.quantity || 1}
üéØ –î–µ–π—Å—Ç–≤–∏–µ: –†–∞–∑–º–µ—â–µ–Ω–∏–µ –≤—Å–µ—Ö –µ–¥–∏–Ω–∏—Ü —Ç–∏–ø–∞ ${extractedData.cargo_type}
üéØ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —è—á–µ–π–∫—É –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è`;
                alertMessage = `‚úÖ –ì—Ä—É–∑ ${extractedData.cargo_type} –∏–∑ –∑–∞—è–≤–∫–∏ ${extractedData.request_number} –Ω–∞–π–¥–µ–Ω!`;
              } else {
                successMessage = `‚úÖ –ì—Ä—É–∑ ${extractedData.cargo_type} –∏–∑ –∑–∞—è–≤–∫–∏ ${extractedData.request_number} –Ω–∞–π–¥–µ–Ω!
üì¶ –ì—Ä—É–∑: ${foundIndividualUnit.cargo_item?.cargo_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥—Ä—É–∑'}  
üéØ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —è—á–µ–π–∫—É –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è`;
                alertMessage = `‚úÖ –ì—Ä—É–∑ ${extractedData.cargo_type} –∏–∑ –∑–∞—è–≤–∫–∏ ${extractedData.request_number} –Ω–∞–π–¥–µ–Ω!`;
              }
              break;
              
            case 'SIMPLE_CARGO':
              // –¢–ò–ü 1 —Å cargo_items: "‚úÖ –ì—Ä—É–∑ 123456 –Ω–∞–π–¥–µ–Ω!"
              successMessage = `‚úÖ –ì—Ä—É–∑ ${extractedData.cargo_number} –Ω–∞–π–¥–µ–Ω!
üì¶ –ì—Ä—É–∑: ${foundIndividualUnit.cargo_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥—Ä—É–∑'}
üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${foundIndividualUnit.quantity || 1} —à—Ç.
üí° –¢–∏–ø: –ü—Ä–æ—Å—Ç–æ–π –≥—Ä—É–∑ —Å –æ–¥–Ω–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º
üéØ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —è—á–µ–π–∫—É –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è`;
              alertMessage = `‚úÖ –ì—Ä—É–∑ ${extractedData.cargo_number} –Ω–∞–π–¥–µ–Ω!`;
              break;
              
            default:
              // –î–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä—ã–º–∏ —Ñ–æ—Ä–º–∞—Ç–∞–º–∏
              successMessage = `‚úÖ –ì—Ä—É–∑ ${extractedData.full_number} –Ω–∞–π–¥–µ–Ω!
üì¶ –ì—Ä—É–∑: ${foundIndividualUnit.cargo_item?.cargo_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥—Ä—É–∑'}
üìã –ó–∞—è–≤–∫–∞: ${foundCargo.cargo_number}
üéØ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —è—á–µ–π–∫—É –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è`;
              alertMessage = `‚úÖ –ì—Ä—É–∑ ${extractedData.full_number} –Ω–∞–π–¥–µ–Ω!`;
          }
        } else {
          // –¢–ò–ü 1: –ü—Ä–æ—Å—Ç–æ–π –≥—Ä—É–∑ –±–µ–∑ cargo_items - "‚úÖ –ì—Ä—É–∑ 123456 –Ω–∞–π–¥–µ–Ω!"
          if (extractedData.type === 'SIMPLE_CARGO') {
            successMessage = `‚úÖ –ì—Ä—É–∑ ${extractedData.cargo_number} –Ω–∞–π–¥–µ–Ω!
üì¶ –ù–∞–∑–≤–∞–Ω–∏–µ: ${foundCargo.cargo_name || '–ü—Ä–æ—Å—Ç–æ–π –≥—Ä—É–∑'}
üí° –¢–∏–ø: –ï–¥–∏–Ω—ã–π –≥—Ä—É–∑ —Å –æ–¥–Ω–∏–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º (–∫–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π —Ñ–æ—Ä–º–∞—Ç)
üìä ID –∑–∞—è–≤–∫–∏: ${foundCargo.id}
üéØ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —è—á–µ–π–∫—É –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è`;
            alertMessage = `‚úÖ –ì—Ä—É–∑ ${extractedData.cargo_number} –Ω–∞–π–¥–µ–Ω!`;
          } else {
            // –î–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö —Ç–∏–ø–æ–≤
            successMessage = `‚úÖ –ì—Ä—É–∑ ${foundCargo.cargo_number} –Ω–∞–π–¥–µ–Ω!
üì¶ –ù–∞–∑–≤–∞–Ω–∏–µ: ${foundCargo.cargo_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥—Ä—É–∑'}
üí° –§–æ—Ä–º–∞—Ç: ${extractedData.type}
üéØ –°–ª–µ–¥—É—é—â–∏–π —à–∞–≥: –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —è—á–µ–π–∫—É –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è`;
            alertMessage = `‚úÖ –ì—Ä—É–∑ ${foundCargo.cargo_number} –Ω–∞–π–¥–µ–Ω!`;
          }
        }
        
        setScannerMessage(successMessage);
        showAlert(alertMessage, 'success');
        
        // –§–ê–ó–ê 4: –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò–ï –ü–ï–†–ï–•–û–î–´ - —É–ª—É—á—à–µ–Ω–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é —è—á–µ–π–∫–∏
        setExternalScannerStep('cell');
        setScannerAutoFocusTarget('cell');
        // –≠–¢–ê–ü 3: –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å —Ç–∏–ø–æ–º QR –∫–æ–¥–∞
        let placementMessage = '';
        
        if (foundIndividualUnit) {
          switch (foundIndividualUnit.search_type) {
            case 'UNIT_IN_CARGO_TYPE':
              placementMessage = `üìç –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ —è—á–µ–π–∫–∏ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –µ–¥–∏–Ω–∏—Ü—ã ${extractedData.unit_number} –≥—Ä—É–∑–∞ —Ç–∏–ø–∞ ${extractedData.cargo_type} –∏–∑ –∑–∞—è–≤–∫–∏ ${extractedData.request_number}`;
              break;
            case 'CARGO_IN_REQUEST':
              placementMessage = `üìç –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ —è—á–µ–π–∫–∏ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞ —Ç–∏–ø–∞ ${extractedData.cargo_type} –∏–∑ –∑–∞—è–≤–∫–∏ ${extractedData.request_number}`;
              break;
            default:
              placementMessage = `üìç –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ —è—á–µ–π–∫–∏ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –µ–¥–∏–Ω–∏—Ü—ã ${extractedData.full_number}`;
          }
        } else {
          if (extractedData.type === 'SIMPLE_CARGO') {
            placementMessage = `üìç –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ —è—á–µ–π–∫–∏ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –ø—Ä–æ—Å—Ç–æ–≥–æ –≥—Ä—É–∑–∞ ${extractedData.cargo_number}`;
          } else {
            placementMessage = `üìç –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ —è—á–µ–π–∫–∏ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞ ${foundCargo.cargo_number}`;
          }
        }
        
        setScannerMessage(placementMessage);
        
        // –§–ê–ó–ê 4: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–æ–ª—è –≥—Ä—É–∑–∞ –∏ –±—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ —è—á–µ–π–∫–µ
        setTimeout(() => {
          setExternalCargoInput(''); // –§–ê–ó–ê 4: –û—á–∏—â–∞–µ–º –ø–æ–ª–µ –≥—Ä—É–∑–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏
          
          const cellInput = document.querySelector('input[placeholder*="QR –∫–æ–¥ —è—á–µ–π–∫–∏"]');
          if (cellInput) {
            cellInput.focus();
            cellInput.select(); // –§–ê–ó–ê 4: –í—ã–¥–µ–ª—è–µ–º –¥–ª—è –±—ã—Å—Ç—Ä–æ–π –∑–∞–º–µ–Ω—ã
            console.log('üñ•Ô∏è –§–ê–ó–ê 4: –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –Ω–∞ –ø–æ–ª–µ —è—á–µ–π–∫–∏ —Å –æ—á–∏—Å—Ç–∫–æ–π –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ –ø–æ–ª—è');
          }
        }, 150); // –§–ê–ó–ê 4: –ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –±–µ–∑ –∫—É—Ä—Å–æ—Ä–∞
        
      } else {
        // –≠–¢–ê–ü 3: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –¥–ª—è —Ç—Ä–µ—Ö —Ç–∏–ø–æ–≤ QR –∫–æ–¥–æ–≤
        let errorMessage = '';
        
        switch (extractedData.type) {
          case 'UNIT_IN_CARGO_TYPE':
            errorMessage = `‚ùå –ï–¥–∏–Ω–∏—Ü–∞ ${extractedData.unit_number} –≥—Ä—É–∑–∞ —Ç–∏–ø–∞ ${extractedData.cargo_type} –∏–∑ –∑–∞—è–≤–∫–∏ ${extractedData.request_number} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.
              –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
              ‚Ä¢ –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∑–∞—è–≤–∫–∞ ${extractedData.request_number}
              ‚Ä¢ –ï—Å—Ç—å –ª–∏ –≥—Ä—É–∑ —Ç–∏–ø–∞ ${extractedData.cargo_type} –≤ —ç—Ç–æ–π –∑–∞—è–≤–∫–µ
              ‚Ä¢ –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –µ–¥–∏–Ω–∏—Ü–∞ ${extractedData.unit_number} –≤ —ç—Ç–æ–º –≥—Ä—É–∑–µ
              ‚Ä¢ –ü—Ä–∏–Ω—è—Ç –ª–∏ –≥—Ä—É–∑ –Ω–∞ —Å–∫–ª–∞–¥ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è`;
            break;
            
          case 'CARGO_IN_REQUEST':
            errorMessage = `‚ùå –ì—Ä—É–∑ —Ç–∏–ø–∞ ${extractedData.cargo_type} –∏–∑ –∑–∞—è–≤–∫–∏ ${extractedData.request_number} –Ω–µ –Ω–∞–π–¥–µ–Ω.
              –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
              ‚Ä¢ –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –∑–∞—è–≤–∫–∞ ${extractedData.request_number}
              ‚Ä¢ –ï—Å—Ç—å –ª–∏ –≥—Ä—É–∑ —Ç–∏–ø–∞ ${extractedData.cargo_type} –≤ —ç—Ç–æ–π –∑–∞—è–≤–∫–µ
              ‚Ä¢ –ü—Ä–∏–Ω—è—Ç –ª–∏ –≥—Ä—É–∑ –Ω–∞ —Å–∫–ª–∞–¥ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è`;
            break;
            
          case 'SIMPLE_CARGO':
            errorMessage = `‚ùå –ü—Ä–æ—Å—Ç–æ–π –≥—Ä—É–∑ ${extractedData.cargo_number} –Ω–µ –Ω–∞–π–¥–µ–Ω.
              –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
              ‚Ä¢ –°—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –≥—Ä—É–∑ —Å –Ω–æ–º–µ—Ä–æ–º ${extractedData.cargo_number}
              ‚Ä¢ –ü—Ä–∏–Ω—è—Ç –ª–∏ –≥—Ä—É–∑ –Ω–∞ —Å–∫–ª–∞–¥ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è`;
            break;
            
          case 'ERROR':
          case 'UNKNOWN':
            errorMessage = `‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR –∫–æ–¥–∞: "${cargoData}"
              –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:
              ‚Ä¢ –ü—Ä–æ—Å—Ç–æ–π –Ω–æ–º–µ—Ä: 123456 (1-10 —Ü–∏—Ñ—Ä)
              ‚Ä¢ –ì—Ä—É–∑ –≤ –∑–∞—è–≤–∫–µ: 010101.01 –∏–ª–∏ 010101/01
              ‚Ä¢ –ï–¥–∏–Ω–∏—Ü–∞ –≤ –≥—Ä—É–∑–µ: 010101.01.01 –∏–ª–∏ 010101/01/01`;
            break;
            
          default:
            errorMessage = `‚ùå –ì—Ä—É–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –ø–æ –∫–æ–¥—É: ${cargoData}
              –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≥—Ä—É–∑ –ø—Ä–∏–Ω—è—Ç –Ω–∞ —Å–∫–ª–∞–¥ –∏ –æ–∂–∏–¥–∞–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏—è.`;
        }
        
        setScannerError(errorMessage);
        showAlert(errorMessage, 'error');
      }
    } catch (error) {
      console.error('–§–ê–ó–ê 3: –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≥—Ä—É–∑–∞:', error);
      setScannerError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä—É–∑–∞');
      showAlert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö –≥—Ä—É–∑–∞', 'error');
    } finally {
      // –§–ê–ó–ê 3: –°–±—Ä–æ—Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
      setTimeout(() => {
        setScannerProcessingInput(false);
        if (externalScannerStep !== 'cell') {
          setScannerClickProtection(false);
        }
      }, 500);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –≤–≤–æ–¥–∞ –æ—Ç –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞ –¥–ª—è —è—á–µ–π–∫–∏
  const handleExternalCellScan = async (cellData) => {
    try {
      // –§–ê–ó–ê 3: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏
      setScannerProcessingInput(true);
      setScannerClickProtection(true);
      
      console.log('üñ•Ô∏è –§–ê–ó–ê 3: –£–ª—É—á—à–µ–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —è—á–µ–π–∫–∏:', cellData);
      
      const cellInfo = parseCellQRCode(cellData);
      if (cellInfo) {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —á–∏—Ç–∞–µ–º–æ–µ –∏–º—è —è—á–µ–π–∫–∏ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        const cellDisplayFormat = cellInfo.cell_code || cellInfo.readable_name;
        
        // –í–≤–æ–¥–∏–º –¥–∞–Ω–Ω—ã–µ –≤ –ø–æ–ª–µ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —è—á–µ–π–∫–∏
        setExternalCellInput(cellDisplayFormat);
        
        console.log('üìç –û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã –¥–∞–Ω–Ω—ã–µ —è—á–µ–π–∫–∏:', cellDisplayFormat);
        console.log('üìç –§–æ—Ä–º–∞—Ç –¥–∞–Ω–Ω—ã—Ö:', cellInfo.format);
        console.log('üìç –ö–æ–¥ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:', cellInfo.cell_code);
        
        // –§–ê–ó–ê 2: –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ —è—á–µ–π–∫–∏
        try {
          console.log('üîç –§–ê–ó–ê 2: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∏ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ —è—á–µ–π–∫–∏:', cellDisplayFormat);
          
          let cellStatusPayload = {};
          
          // –§–æ—Ä–º–∏—Ä—É–µ–º payload –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞
          if (cellInfo.format === 'id') {
            cellStatusPayload = {
              warehouse_id_number: cellInfo.warehouse_id_number,
              block_id_number: cellInfo.block_id_number,
              shelf_id_number: cellInfo.shelf_id_number,
              cell_id_number: cellInfo.cell_id_number
            };
          } else {
            cellStatusPayload = {
              warehouse_id: cellInfo.warehouse_id,
              block_number: cellInfo.block_number,
              shelf_number: cellInfo.shelf_number,
              cell_number: cellInfo.cell_number
            };
          }
          
          const cellStatusResponse = await apiCall(`/api/warehouse/cell/status`, 'POST', cellStatusPayload);

          if (cellStatusResponse) {
            // –§–ê–ó–ê 2: –ù–û–í–û–ï - –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —è—á–µ–π–∫–∏
            if (cellStatusResponse.cell_exists === false) {
              setScannerError(`–Ø—á–µ–π–∫–∞ ${cellDisplayFormat} –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç`);
              setScannerMessage(`‚ùå –Ø—á–µ–π–∫–∞ ${cellDisplayFormat} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Å–∏—Å—Ç–µ–º–µ`);
              showAlert(`‚ùå –Ø—á–µ–π–∫–∞ "${cellDisplayFormat}" –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Å–∏—Å—Ç–µ–º–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ QR –∫–æ–¥ —è—á–µ–π–∫–∏.`, 'error');
              return;
            }
            
            // –§–ê–ó–ê 2: –ù–û–í–û–ï - –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≥—Ä—É–∑–æ–≤ –≤ –æ–¥–Ω–æ–π —è—á–µ–π–∫–µ
            if (cellStatusResponse.is_occupied) {
              const existingCargos = cellStatusResponse.cargo_numbers || [cellStatusResponse.cargo_number];
              const existingCargosList = existingCargos.filter(c => c).join(', ');
              
              console.log('üì¶ –Ø—á–µ–π–∫–∞ –∑–∞–Ω—è—Ç–∞ –≥—Ä—É–∑–∞–º–∏:', existingCargos);
              
              // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–Ω—è—Ç—ã—Ö –≥—Ä—É–∑–∞—Ö —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å
              const cargoCount = existingCargos.length;
              const currentCargoNumber = externalScannedCargo?.cargo_number || '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥—Ä—É–∑';
              
              setScannerMessage(`üì¶ –Ø—á–µ–π–∫–∞ ${cellDisplayFormat} —É–∂–µ —Å–æ–¥–µ—Ä–∂–∏—Ç ${cargoCount} –≥—Ä—É–∑(–æ–≤): ${existingCargosList}. 
                –î–æ–±–∞–≤–ª—è–µ–º –≥—Ä—É–∑ ${currentCargoNumber} –≤ —ç—Ç—É –∂–µ —è—á–µ–π–∫—É...`);
              
              // –§–ê–ó–ê 2: –†–ê–ó–†–ï–®–ê–ï–ú —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –≥—Ä—É–∑–æ–≤ –≤ –æ–¥–Ω–æ–π —è—á–µ–π–∫–µ
              showAlert(`üì¶ –Ø—á–µ–π–∫–∞ —Å–æ–¥–µ—Ä–∂–∏—Ç ${cargoCount} –≥—Ä—É–∑(–æ–≤). –†–∞–∑–º–µ—â–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π –≥—Ä—É–∑ ${currentCargoNumber} –≤ —è—á–µ–π–∫—É ${cellDisplayFormat}.`, 'info');
            } else {
              // –Ø—á–µ–π–∫–∞ —Å–≤–æ–±–æ–¥–Ω–∞
              setScannerMessage(`‚úÖ –Ø—á–µ–π–∫–∞ ${cellDisplayFormat} —Å–≤–æ–±–æ–¥–Ω–∞. –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ...`);
              showAlert(`‚úÖ –Ø—á–µ–π–∫–∞ ${cellDisplayFormat} —Å–≤–æ–±–æ–¥–Ω–∞. –†–∞–∑–º–µ—â–∞–µ–º –≥—Ä—É–∑.`, 'success');
            }
          } else {
            // –ï—Å–ª–∏ API –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ –æ —Å—Ç–∞—Ç—É—Å–µ
            console.warn('‚ö†Ô∏è API –Ω–µ –≤–µ—Ä–Ω—É–ª –¥–∞–Ω–Ω—ã–µ –æ —Å—Ç–∞—Ç—É—Å–µ —è—á–µ–π–∫–∏, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ');
            setScannerMessage(`‚úÖ –Ø—á–µ–π–∫–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞: ${cellDisplayFormat}. –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ...`);
            showAlert(`‚úÖ –Ø—á–µ–π–∫–∞ ${cellDisplayFormat} –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞. –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ.`, 'success');
          }

          // –§–ê–ó–ê 2: –í–°–ï–ì–î–ê –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ (—Ä–∞–∑—Ä–µ—à–∞–µ–º –Ω–µ—Å–∫–æ–ª—å–∫–æ –≥—Ä—É–∑–æ–≤)
          setExternalScannedCell(cellInfo);
          
          // –§–ê–ó–ê 4: –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–û–ï –†–ê–ó–ú–ï–©–ï–ù–ò–ï –ò –°–ë–†–û–° –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
          if (externalScannedCargo) {
            console.log('üñ•Ô∏è –§–ê–ó–ê 4: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å –∞–≤—Ç–æ—Å–±—Ä–æ—Å–æ–º...');
            await performExternalScannerPlacement(externalScannedCargo, cellInfo);
            
            // –§–ê–ó–ê 4: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
            setTimeout(() => {
              if (scannerAutoTransition) {
                console.log('üñ•Ô∏è –§–ê–ó–ê 4: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è...');
                setScannerCompletionCount(prev => prev + 1);
                setExternalScannedCargo(null);
                setExternalScannedCell(null);
                setExternalCargoInput('');
                setExternalCellInput('');
                setExternalScannerStep('cargo');
                setScannerAutoFocusTarget('cargo');
                setScannerMessage('‚úÖ –†–∞–∑–º–µ—â–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –≥—Ä—É–∑');
                
                // –§–ê–ó–ê 4: –ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –Ω–æ–≤–æ–º—É —Ü–∏–∫–ª—É –±–µ–∑ —É—á–∞—Å—Ç–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                setTimeout(() => {
                  const cargoInput = document.querySelector('input[placeholder*="–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –≥—Ä—É–∑–∞"]');
                  if (cargoInput) {
                    cargoInput.focus();
                    cargoInput.select();
                    console.log('üñ•Ô∏è –§–ê–ó–ê 4: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –Ω–æ–≤–æ–º—É —Ü–∏–∫–ª—É —Ä–∞–∑–º–µ—â–µ–Ω–∏—è');
                  }
                }, 100);
              }
            }, 1500); // –§–ê–ó–ê 4: –ü–∞—É–∑–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É—Å–ø–µ—Ö–∞, –∑–∞—Ç–µ–º –∞–≤—Ç–æ—Å–±—Ä–æ—Å
          }

        } catch (statusError) {
          console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —è—á–µ–π–∫–∏, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ:', statusError);
          // –ï—Å–ª–∏ –Ω–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —è—á–µ–π–∫–∏, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ (fallback)
          setExternalScannedCell(cellInfo);
          setScannerMessage(`‚úÖ –Ø—á–µ–π–∫–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞: ${cellDisplayFormat}. –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ...`);
          showAlert(`‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å —è—á–µ–π–∫–∏, –Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –≤ ${cellDisplayFormat}`, 'warning');
          
          if (externalScannedCargo) {
            console.log('üñ•Ô∏è –§–ê–ó–ê 4: –†–∞–∑–º–µ—â–µ–Ω–∏–µ (fallback) —Å –∞–≤—Ç–æ—Å–±—Ä–æ—Å–æ–º...');
            await performExternalScannerPlacement(externalScannedCargo, cellInfo);
            
            // –§–ê–ó–ê 4: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –¥–∞–∂–µ –ø—Ä–∏ fallback
            setTimeout(() => {
              if (scannerAutoTransition) {
                console.log('üñ•Ô∏è –§–ê–ó–ê 4: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π —Å–±—Ä–æ—Å –ø–æ—Å–ª–µ fallback —Ä–∞–∑–º–µ—â–µ–Ω–∏—è...');
                setScannerCompletionCount(prev => prev + 1);
                setExternalScannedCargo(null);
                setExternalScannedCell(null);
                setExternalCargoInput('');
                setExternalCellInput('');
                setExternalScannerStep('cargo');
                setScannerAutoFocusTarget('cargo');
                setScannerMessage('‚úÖ –†–∞–∑–º–µ—â–µ–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ! –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –≥—Ä—É–∑');
                
                // –§–ê–ó–ê 4: –ê–≤—Ç–æ—Ñ–æ–∫—É—Å –Ω–∞ –Ω–æ–≤—ã–π —Ü–∏–∫–ª
                setTimeout(() => {
                  const cargoInput = document.querySelector('input[placeholder*="–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –≥—Ä—É–∑–∞"]');
                  if (cargoInput) {
                    cargoInput.focus();
                    cargoInput.select();
                    console.log('üñ•Ô∏è –§–ê–ó–ê 4: –ê–≤—Ç–æ–ø–µ—Ä–µ—Ö–æ–¥ –∫ –Ω–æ–≤–æ–º—É —Ü–∏–∫–ª—É –ø–æ—Å–ª–µ fallback');
                  }
                }, 100);
              }
            }, 1500);
          }
        }
      } else {
        setScannerError('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞ —è—á–µ–π–∫–∏');
        setScannerMessage('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞ —è—á–µ–π–∫–∏. –û–∂–∏–¥–∞–µ—Ç—Å—è —Ñ–æ—Ä–º–∞—Ç: –ë1-–ü2-–Ø3 –∏–ª–∏ 003010101');
        showAlert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞ —è—á–µ–π–∫–∏. –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: –ë1-–ü2-–Ø3, 003010101, 001-01-01-001', 'error');
      }
    } catch (error) {
      console.error('–§–ê–ó–ê 3: –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —è—á–µ–π–∫–∏:', error);
      setScannerError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —è—á–µ–π–∫–∏');
      setScannerMessage('‚ùå –û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —è—á–µ–π–∫–∏');
      showAlert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö —è—á–µ–π–∫–∏', 'error');
    } finally {
      // –§–ê–ó–ê 3: –°–±—Ä–æ—Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π
      setTimeout(() => {
        setScannerProcessingInput(false);
        setScannerClickProtection(false);
      }, 1000);
    }
  };

  // –§–ê–ó–ê 2: –û–ë–ù–û–í–õ–ï–ù–ù–ê–Ø —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü
  const performExternalScannerPlacement = async (cargo, cell) => {
    try {
      console.log('üñ•Ô∏è –§–ê–ó–ê 2: –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞:', cargo.cargo_number, '–≤ —è—á–µ–π–∫—É:', cell.readable_name);
      console.log('üñ•Ô∏è –§–æ—Ä–º–∞—Ç —è—á–µ–π–∫–∏:', cell.format);
      console.log('üñ•Ô∏è –ö–æ–¥ —è—á–µ–π–∫–∏ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:', cell.cell_code);
      
      // –§–ê–ó–ê 2: –ù–û–í–û–ï - –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–∞—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–∞—è –µ–¥–∏–Ω–∏—Ü–∞
      let apiEndpoint = '/api/cargo/place-in-cell';
      let requestPayload = {
        cargo_number: cargo.cargo_number,
        cell_code: cell.cell_code
      };
      
      // –§–ê–ó–ê 2: –ï—Å–ª–∏ –µ—Å—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –µ–¥–∏–Ω–∏—Ü–µ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π API
      if (cargo.selected_individual_unit) {
        console.log('üîç –§–ê–ó–ê 2: –†–∞–∑–º–µ—â–∞–µ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—É—é –µ–¥–∏–Ω–∏—Ü—É:', cargo.selected_individual_unit.individual_number);
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º API –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü
        apiEndpoint = '/api/operator/cargo/place-individual';
        requestPayload = {
          cargo_id: cargo.id,
          individual_number: cargo.selected_individual_unit.individual_number,
          placement_location: {
            warehouse: cell.warehouse_name || `–°–∫–ª–∞–¥ ‚Ññ${cell.warehouse_number}`,
            block: cell.block_name || `–ë–ª–æ–∫ ${cell.block_number}`,
            shelf: cell.shelf_name || `–ü–æ–ª–∫–∞ ${cell.shelf_number}`, 
            cell: cell.cell_name || `–Ø—á–µ–π–∫–∞ ${cell.cell_number}`,
            cell_code: cell.cell_code
          }
        };
      }
      
      console.log('üì° –§–ê–ó–ê 2: API –∑–∞–ø—Ä–æ—Å:', apiEndpoint, requestPayload);
      const response = await apiCall(apiEndpoint, 'POST', requestPayload);
      
      if (response && response.success) {
        setExternalScannerStep('complete');
        
        // –§–ê–ó–ê 2: –†–∞–∑–ª–∏—á–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–∏–ø–æ–≤ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
        let successMessage = '';
        if (cargo.selected_individual_unit) {
          successMessage = `üéâ –ï–¥–∏–Ω–∏—Ü–∞ ${cargo.selected_individual_unit.individual_number} –≥—Ä—É–∑–∞ "${cargo.selected_individual_unit.cargo_item.cargo_name}" —Ä–∞–∑–º–µ—â–µ–Ω–∞ –Ω–∞ ${cell.readable_name}!`;
        } else {
          successMessage = `üéâ –ì—Ä—É–∑ ${cargo.cargo_number} —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ ${cell.readable_name}!`;
        }
        
        setScannerMessage(successMessage);
        showAlert(successMessage, 'success');
        
        // –§–ê–ó–ê 2: –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–∑–º–µ—â–µ–Ω–Ω–æ–º –≥—Ä—É–∑–µ/–µ–¥–∏–Ω–∏—Ü–µ –≤ —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–∏
        const placedCargoInfo = {
          cargo_number: cargo.cargo_number,
          individual_unit: cargo.selected_individual_unit?.individual_number || null,
          cargo_name: cargo.selected_individual_unit?.cargo_item?.cargo_name || '–ì—Ä—É–∑',
          location: cell.readable_name,
          warehouse_name: cell.warehouse_name || `–°–∫–ª–∞–¥ ‚Ññ${cell.warehouse_number}`,
          placed_at: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' }),
          placement_type: cargo.selected_individual_unit ? 'individual_unit' : 'full_cargo'
        };
        
        setSessionPlacedCargo(prev => [...prev, placedCargoInfo]);
        setSessionPlacedCount(prev => prev + 1);
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
        await fetchPlacementStatistics();
        await fetchAvailableCargoForPlacement(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥—Ä—É–∑–æ–≤
        
        // –§–ê–ó–ê 2: –ú–ì–ù–û–í–ï–ù–ù–´–ô –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é —Å–ª–µ–¥—É—é—â–µ–≥–æ –≥—Ä—É–∑–∞
        setTimeout(() => {
          setExternalScannerStep('cargo');
          setExternalCargoInput('');
          setExternalCellInput('');
          setExternalScannedCargo(null);
          setExternalScannedCell(null);
          setScannerMessage('üîÑ –ì—Ä—É–∑ —Ä–∞–∑–º–µ—â–µ–Ω! –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –≥—Ä—É–∑ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è.');
          
          // –ú–≥–Ω–æ–≤–µ–Ω–Ω–æ —Ñ–æ–∫—É—Å–∏—Ä—É–µ–º—Å—è –Ω–∞ –ø–æ–ª–µ –≥—Ä—É–∑–∞ –¥–ª—è –Ω–µ–ø—Ä–µ—Ä—ã–≤–Ω–æ–π —Ä–∞–±–æ—Ç—ã
          const cargoInput = document.querySelector('input[placeholder*="QR –∫–æ–¥ –≥—Ä—É–∑–∞"]');
          if (cargoInput) {
            cargoInput.focus();
          }
        }, 1000); // 1 —Å–µ–∫—É–Ω–¥–∞ —á—Ç–æ–±—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ–ª —É–≤–∏–¥–µ—Ç—å —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
        
      } else {
        throw new Error(response?.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è');
      }
      
    } catch (error) {
      console.error('‚ùå –§–ê–ó–ê 2: –û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å –≤–Ω–µ—à–Ω–∏–º —Å–∫–∞–Ω–µ—Ä–æ–º:', error);
      setScannerError(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ –≥—Ä—É–∑–∞: ${error.message}`);
      showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ –≥—Ä—É–∑–∞: ${error.message}`, 'error');
    }
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏
  const handleRouteChange = (newRoute) => {
    const defaultValue = getDefaultDeclaredValue(newRoute);
    setCargoOrderForm(prevForm => ({
      ...prevForm,
      route: newRoute,
      declared_value: defaultValue
    }));
  };

  // –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞–º–∏ –∫–ª–∏–µ–Ω—Ç–æ–≤
  const [pendingOrders, setPendingOrders] = useState([]);
  const [selectedOrder, setSelectedOrder] = useState(null);
  const [orderDetailsModal, setOrderDetailsModal] = useState(false);
  const [editOrderModal, setEditOrderModal] = useState(false);
  const [newOrdersCount, setNewOrdersCount] = useState(0);
  const [orderEditForm, setOrderEditForm] = useState({
    sender_full_name: '',
    sender_phone: '',
    recipient_full_name: '',
    recipient_phone: '',
    recipient_address: '',
    pickup_address: '',
    cargo_name: '',
    weight: '',
    declared_value: '',
    description: '',
    route: '',
    admin_notes: ''
  });

  // Form states
  const [loginForm, setLoginForm] = useState({ phone: '', password: '' });
  const [registerForm, setRegisterForm] = useState({ full_name: '', phone: '', password: '' }); // –£–±—Ä–∞–Ω–∞ —Ä–æ–ª—å (–§—É–Ω–∫—Ü–∏—è 3)
  const [cargoForm, setCargoForm] = useState({
    recipient_name: '',
    recipient_phone: '',
    route: 'moscow_to_tajikistan',
    weight: '',
    description: '',
    declared_value: '',
    sender_address: '',
    recipient_address: ''
  });
  const [warehouseForm, setWarehouseForm] = useState({
    name: '',
    location: '',
    blocks_count: 1,
    shelves_per_block: 1,
    cells_per_shelf: 10,
    assigned_operator_id: 'none' // –ù–æ–≤–æ–µ –ø–æ–ª–µ –¥–ª—è –≤—ã–±–æ—Ä–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
  });
  
  // –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–ª–∞–¥–∞
  const [showWarehouseCreationPage, setShowWarehouseCreationPage] = useState(false);
  const [availableOperators, setAvailableOperators] = useState([]);
  const [warehouseCreationStep, setWarehouseCreationStep] = useState('form'); // 'form', 'qr-generation'
  const [generatingAllQRs, setGeneratingAllQRs] = useState(false);
  const [allQRProgress, setAllQRProgress] = useState(0);
  const [generatedQRs, setGeneratedQRs] = useState([]);
  const [selectedCellQR, setSelectedCellQR] = useState({
    block: '',
    shelf: '',
    cell: ''
  });
  const [selectedCellQRResult, setSelectedCellQRResult] = useState(null);
  const [generatingSelectedCellQR, setGeneratingSelectedCellQR] = useState(false);
  const [createdWarehouseInfo, setCreatedWarehouseInfo] = useState(null);
  const [operatorCargoForm, setOperatorCargoForm] = useState({
    sender_full_name: '',
    sender_phone: '',
    recipient_full_name: '',
    recipient_phone: '',
    recipient_address: '',
    weight: '',  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä–æ–π —Ñ–æ—Ä–º–æ–π
    cargo_name: '',  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–æ —Å—Ç–∞—Ä–æ–π —Ñ–æ—Ä–º–æ–π
    declared_value: '',  // –¢–µ–ø–µ—Ä—å –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –∫–∞–∫ price_per_kg –¥–ª—è —Å—Ç–∞—Ä–æ–π —Ñ–æ—Ä–º—ã
    description: '',
    route: 'moscow_to_tajikistan',
    // –ù–æ–≤—ã–µ –ø–æ–ª—è –¥–ª—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤ —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏
    cargo_items: [{ cargo_name: '', quantity: 1, weight: '', price_per_kg: '', total_amount: '' }],  // –ö–∞–∂–¥—ã–π –≥—Ä—É–∑ –∏–º–µ–µ—Ç —Å–≤–æ—é —Ü–µ–Ω—É + –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –æ–±—â—É—é —Å—É–º–º—É
    price_per_kg: '',  // –û–±—â–∞—è —Ü–µ–Ω–∞ –∑–∞ –∫–≥ (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
    use_multi_cargo: true,  // –§–ª–∞–≥ –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏ (–≤–∫–ª—é—á—ë–Ω –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é)
    // –ù–û–í–´–ï –ü–û–õ–Ø –î–õ–Ø –£–õ–£–ß–®–ï–ù–ù–û–ô –°–ò–°–¢–ï–ú–´
    warehouse_id: '',  // –í—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∫–ª–∞–¥
    payment_method: 'not_paid',  // –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã
    payment_amount: '',  // –°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã
    debt_due_date: '',  // –î–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è –¥–æ–ª–≥–∞
    // –ù–û–í–´–ï –ü–û–õ–Ø –î–õ–Ø –ö–£–†–¨–ï–†–°–ö–û–ô –°–õ–£–ñ–ë–´
    pickup_required: false,  // –¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞
    pickup_address: '',  // –ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞ –≥—Ä—É–∑–∞
    pickup_date: '',  // –î–∞—Ç–∞ –∑–∞–±–æ—Ä–∞ (YYYY-MM-DD)
    pickup_time_from: '',  // –í—Ä–µ–º—è –∑–∞–±–æ—Ä–∞ —Å (HH:MM)
    pickup_time_to: '',  // –í—Ä–µ–º—è –∑–∞–±–æ—Ä–∞ –¥–æ (HH:MM)
    delivery_method: 'pickup',  // –°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä—É–∑–∞ (pickup/home_delivery)
    courier_fee: '',  // –°—Ç–æ–∏–º–æ—Å—Ç—å –∫—É—Ä—å–µ—Ä—Å–∫–∏—Ö —É—Å–ª—É–≥
    // –ù–û–í–´–ï –ü–û–õ–Ø –î–õ–Ø –†–ï–ñ–ò–ú–ê –ó–ê–ë–û–†–ê –ì–†–£–ó–ê
    pickup_time_from: '',  // –í—Ä–µ–º—è –∑–∞–±–æ—Ä–∞ —Å (HH:MM)
    pickup_time_to: ''     // –í—Ä–µ–º—è –∑–∞–±–æ—Ä–∞ –¥–æ (HH:MM)
  });
  // Operator cargo management states
  const [operatorCargo, setOperatorCargo] = useState([]);
  
  // Calculator states for multi-cargo functionality with individual prices
  const [totalWeight, setTotalWeight] = useState(0);
  const [totalCost, setTotalCost] = useState(0);
  const [cargoBreakdown, setCargoBreakdown] = useState([]);  // –î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑–±–∏–≤–∫–∞ –ø–æ –∫–∞–∂–¥–æ–º—É –≥—Ä—É–∑—É

  // –ù–û–í–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø –î–õ–Ø –£–õ–£–ß–®–ï–ù–ù–û–ô –°–ò–°–¢–ï–ú–´  
  const [debtorsList, setDebtorsList] = useState([]);  // –°–ø–∏—Å–æ–∫ –∑–∞–¥–æ–ª–∂–Ω–∏–∫–æ–≤

  // Personal dashboard states
  const [personalDashboardData, setPersonalDashboardData] = useState(null);
  const [dashboardLoading, setDashboardLoading] = useState(false);
  
  // Admin dashboard analytics states
  const [adminDashboardAnalytics, setAdminDashboardAnalytics] = useState(null);
  const [adminAnalyticsLoading, setAdminAnalyticsLoading] = useState(false);
  
  // Operator dashboard analytics states
  const [operatorDashboardAnalytics, setOperatorDashboardAnalytics] = useState(null);
  const [operatorAnalyticsLoading, setOperatorAnalyticsLoading] = useState(false);
  
  // QR codes and invoice states
  const [cargoNumbers, setCargoNumbers] = useState('');
  const [generatedQRCodes, setGeneratedQRCodes] = useState([]);
  const [generatedInvoice, setGeneratedInvoice] = useState(null);
  const [qrCodeLoading, setQrCodeLoading] = useState(false);
  const [invoiceLoading, setInvoiceLoading] = useState(false);
  const [showQRCodesModal, setShowQRCodesModal] = useState(false);
  const [showInvoiceModal, setShowInvoiceModal] = useState(false);
  
  // New QR Generation Modal states
  const [showQRGenerateModal, setShowQRGenerateModal] = useState(false);
  const [qrGenerateCargoNumber, setQrGenerateCargoNumber] = useState('');
  const [generatedSingleQR, setGeneratedSingleQR] = useState(null);
  const [qrGenerateLoading, setQrGenerateLoading] = useState(false);
  
  // Bulk QR Generation states
  const [showBulkQRModal, setBulkQRModal] = useState(false);
  const [selectedSender, setSelectedSender] = useState(null);
  const [senderCargos, setSenderCargos] = useState([]);
  const [bulkQRResults, setBulkQRResults] = useState([]);
  const [bulkQRLoading, setBulkQRLoading] = useState(false);
  
  // New Cargo Placement Modal states  
  const [showCargoPlacementModal, setShowCargoPlacementModal] = useState(false);
  const [placementActive, setPlacementActive] = useState(false);
  const [placementStep, setPlacementStep] = useState('idle'); // 'idle', 'scan-cargo', 'scan-cell'
  const [scannedCargoForPlacement, setScannedCargoForPlacement] = useState(null);
  const [placementStatistics, setPlacementStatistics] = useState(null);
  const [sessionPlacedCount, setSessionPlacedCount] = useState(0); // –°—á–µ—Ç—á–∏–∫ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤ –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
  const [targetWarehouseStats, setTargetWarehouseStats] = useState(null); // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ü–µ–ª–µ–≤–æ–≥–æ —Å–∫–ª–∞–¥–∞ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const [sessionPlacedCargo, setSessionPlacedCargo] = useState([]); // –°–ø–∏—Å–æ–∫ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤ –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏
  const [selectedCargoForDeletion, setSelectedCargoForDeletion] = useState([]); // –í—ã–±—Ä–∞–Ω–Ω—ã–µ –≥—Ä—É–∑—ã –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
  
  
  // Warehouse Management Modal states
  const [showWarehouseManagementModal, setShowWarehouseManagementModal] = useState(false);
  const [selectedWarehouseForManagement, setSelectedWarehouseForManagement] = useState(null);
  const [warehouseStructure, setWarehouseStructure] = useState(null);
  const [warehouseManagementLoading, setWarehouseManagementLoading] = useState(false);
  const [selectedCells, setSelectedCells] = useState([]);
  const [cellQRResults, setCellQRResults] = useState([]);
  const [cellQRLoading, setCellQRLoading] = useState(false);
  
  // Warehouse cities management states
  const [showWarehouseCitiesModal, setShowWarehouseCitiesModal] = useState(false);
  const [selectedWarehouseForCities, setSelectedWarehouseForCities] = useState(null);
  const [warehouseCities, setWarehouseCities] = useState([]);
  const [citiesLoading, setCitiesLoading] = useState(false);
  const [newCityName, setNewCityName] = useState('');
  const [bulkCitiesText, setBulkCitiesText] = useState('');
  
  // New cargo form fields states
  const [allWarehouseCities, setAllWarehouseCities] = useState([]);
  const [selectedDeliveryCity, setSelectedDeliveryCity] = useState('');
  const [selectedDeliveryWarehouse, setSelectedDeliveryWarehouse] = useState('');
  const [availableWarehousesForCity, setAvailableWarehousesForCity] = useState([]);
  const [allCitiesLoading, setAllCitiesLoading] = useState(false);
  const [citySearchQuery, setCitySearchQuery] = useState('');
  const [filteredCities, setFilteredCities] = useState([]);
  const [showCityDropdown, setShowCityDropdown] = useState(false);
  
  // Confirmation modal for cargo acceptance states
  const [showCargoConfirmationModal, setShowCargoConfirmationModal] = useState(false);
  const [confirmationCargoData, setConfirmationCargoData] = useState(null);
  const [qrGenerationInProgress, setQrGenerationInProgress] = useState(false);
  
  // Manual placement states
  const [manualCargoNumber, setManualCargoNumber] = useState('');
  const [manualCellCode, setManualCellCode] = useState('');
  
  // Validation states for manual input
  const [cargoValidation, setCargoValidation] = useState({ isValid: false, cargoInfo: null, isLoading: false });
  const [cellValidation, setCellValidation] = useState({ availableCells: [], selectedWarehouse: null, isLoading: false });
  
  // Camera management states
  const [availablePlacementCameras, setAvailablePlacementCameras] = useState([]);
  const [currentPlacementCameraIndex, setCurrentPlacementCameraIndex] = useState(0);
  
  // Application QR code states
  const [applicationQRCode, setApplicationQRCode] = useState(null);
  const [showApplicationQRModal, setShowApplicationQRModal] = useState(false);
  const [applicationQRLoading, setApplicationQRLoading] = useState(false);
  
  // Cargo creation QR code states
  const [createdCargoQR, setCreatedCargoQR] = useState(null);
  const [showCreatedCargoQRModal, setShowCreatedCargoQRModal] = useState(false);
  
  // Modal QR scanner state
  const [modalCameraIndex, setModalCameraIndex] = useState(0);
  const [modalCameras, setModalCameras] = useState([]);
  
  // QR Scanner states
  const [showQRScannerModal, setShowQRScannerModal] = useState(false);
  const [scannerActive, setScannerActive] = useState(false);
  const [scannedCargoInfo, setScannedCargoInfo] = useState(null);
  const [showScannedCargoModal, setShowScannedCargoModal] = useState(false);
  
  // Role management states
  const [showRoleModal, setShowRoleModal] = useState(false);
  const [selectedUserForRole, setSelectedUserForRole] = useState(null);
  const [newRole, setNewRole] = useState('');

  // Advanced search states
  const [advancedSearchOpen, setAdvancedSearchOpen] = useState(false);
  const [searchFilters, setSearchFilters] = useState({
    cargo_status: 'any',
    payment_status: 'any',
    processing_status: '',
    route: 'any',
    sender_phone: '',
    recipient_phone: '',
    date_from: '',
    date_to: '',
    user_role: '',
    user_status: null,
    sort_by: 'created_at',
    sort_order: 'desc'
  });
  const [searchSuggestions, setSearchSuggestions] = useState([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [searchLoading, setSearchLoading] = useState(false);
  const [searchTime, setSearchTime] = useState(0);

  // Profile management states
  const [showOperatorProfile, setShowOperatorProfile] = useState(false);
  const [showUserProfile, setShowUserProfile] = useState(false);
  const [selectedOperatorProfile, setSelectedOperatorProfile] = useState(null);
  const [selectedUserProfile, setSelectedUserProfile] = useState(null);
  const [profileLoading, setProfileLoading] = useState(false);
  
  // Quick cargo creation states
  const [showQuickCargoModal, setShowQuickCargoModal] = useState(false);
  const [quickCargoForm, setQuickCargoForm] = useState({
    sender_id: '',
    recipient_data: {},
    cargo_items: [{ cargo_name: '', weight: '', price_per_kg: '' }],
    route: 'moscow_to_tajikistan',
    description: ''
  });
  const [frequentRecipients, setFrequentRecipients] = useState([]);
  const [selectedRecipient, setSelectedRecipient] = useState(null);
  const [operatorCargoFilter, setOperatorCargoFilter] = useState('all'); // –§–∏–ª—å—Ç—Ä –¥–ª—è —Å–ø–∏—Å–∫–∞ –≥—Ä—É–∑–æ–≤
  const [operatorCargoPagination, setOperatorCargoPagination] = useState({}); // –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è —Å–ø–∏—Å–∫–∞ –≥—Ä—É–∑–æ–≤
  const [operatorCargoPage, setOperatorCargoPage] = useState(1);
  const [operatorCargoPerPage, setOperatorCargoPerPage] = useState(25);
  
  const [availableCargo, setAvailableCargo] = useState([]);
  const [availableCargoForPlacement, setAvailableCargoForPlacement] = useState([]); // –ì—Ä—É–∑—ã –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const [availableCargoPagination, setAvailableCargoPagination] = useState({}); // –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const [availableCargoPage, setAvailableCargoPage] = useState(1);
  const [availableCargoPerPage, setAvailableCargoPerPage] = useState(25);
  
  // –ù–û–í–û–ï: –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è individual units –∫–∞—Ä—Ç–æ—á–µ–∫
  const [individualUnitsForPlacement, setIndividualUnitsForPlacement] = useState([]); // Individual units –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const [groupedUnitsForPlacement, setGroupedUnitsForPlacement] = useState([]); // –°–≥—Ä—É–ø–ø–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –ø–æ –∑–∞—è–≤–∫–∞–º units
  const [individualUnitsPagination, setIndividualUnitsPagination] = useState({}); // –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è individual units
  const [individualUnitsPage, setIndividualUnitsPage] = useState(1);
  const [individualUnitsPerPage, setIndividualUnitsPerPage] = useState(25);
  const [cargoTypeFilter, setCargoTypeFilter] = useState(''); // –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –≥—Ä—É–∑–∞
  const [placementStatusFilter, setPlacementStatusFilter] = useState(''); // –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  // –ù–û–í–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø: –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞ —Å–æ —Å–∫–∞–Ω–µ—Ä–æ–º
  const [scannerPlacementMode, setScannerPlacementMode] = useState(false); // –†–µ–∂–∏–º —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å–æ —Å–∫–∞–Ω–µ—Ä–æ–º
  const [currentCargoQR, setCurrentCargoQR] = useState(''); // –¢–µ–∫—É—â–∏–π QR –∫–æ–¥ –≥—Ä—É–∑–∞
  const [currentCellQR, setCurrentCellQR] = useState(''); // –¢–µ–∫—É—â–∏–π QR –∫–æ–¥ —è—á–µ–π–∫–∏
  const [verifiedCargo, setVerifiedCargo] = useState(null); // –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–π –≥—Ä—É–∑
  const [verifiedCell, setVerifiedCell] = useState(null); // –ü—Ä–æ–≤–µ—Ä–µ–Ω–Ω–∞—è —è—á–µ–π–∫–∞
  const [placementSessionId, setPlacementSessionId] = useState(null); // ID —Å–µ—Å—Å–∏–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const [placementHistory, setPlacementHistory] = useState([]); // –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const [sessionStats, setSessionStats] = useState(null); // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–∏
  const [isPlacementProcessing, setIsPlacementProcessing] = useState(false); // –ü—Ä–æ—Ü–µ—Å—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const [useIndividualCards, setUseIndividualCards] = useState(true); // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–µ–∂–¥—É —Å—Ç–∞—Ä—ã–º –∏ –Ω–æ–≤—ã–º —Ä–µ–∂–∏–º–æ–º
  
  // –£–õ–£–ß–®–ï–ù–ò–ï: –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ–±—â–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è (0/20)
  const [placementProgress, setPlacementProgress] = useState({
    total_units: 0,
    placed_units: 0,
    pending_units: 0,
    progress_percentage: 0,
    progress_text: '–†–∞–∑–º–µ—â–µ–Ω–æ: 0/0',
    last_updated: null
  });
  
  
  // –ù–û–í–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø: –°—á–µ—Ç—á–∏–∫–∏ –¥–ª—è –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é
  const [menuCounters, setMenuCounters] = useState({
    cargo_placement: 0,               // –ì–æ—Ç–æ–≤ –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é  
    cargo_pickup_list: 0,             // –ù–∞ –∑–∞–±–æ—Ä
    cargo_history: 0,                 // –ò—Å—Ç–æ—Ä–∏—è –≥—Ä—É–∑–æ–≤
    couriers_list: 0,                 // –°–ø–∏—Å–æ–∫ –∫—É—Ä—å–µ—Ä–æ–≤
    couriers_inactive: 0,             // –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∫—É—Ä—å–µ—Ä—ã
    warehouses_list: 0,               // –°–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤
    warehouses_placed_cargo: 0,       // –†–∞–∑–º–µ—â–µ–Ω–Ω—ã–π –≥—Ä—É–∑
    notifications_orders: 0,          // –ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã
    notifications_requests: 0,        // –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏
    notifications_system: 0,          // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
    cashier_unpaid: 0,               // –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ
    cashier_history: 0,              // –ò—Å—Ç–æ—Ä–∏—è –æ–ø–ª–∞—Ç—ã
    logistics_transport: 0,           // –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–≤
    logistics_in_transit: 0,         // –í –ø—É—Ç–∏
    logistics_arrived: 0,            // –ù–∞ –º–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
    finances_transactions: 0,        // –¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
    placement_progress: '0/0'        // –ü—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  });

  const [selectedCargoForDetailView, setSelectedCargoForDetailView] = useState(null); // –í—ã–±—Ä–∞–Ω–Ω—ã–π –≥—Ä—É–∑ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –¥–µ—Ç–∞–ª–µ–π
  const [cargoDetailsModal, setCargoDetailsModal] = useState(false); // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π –≥—Ä—É–∑–∞
  const [quickPlacementModal, setQuickPlacementModal] = useState(false); // –ë—ã—Å—Ç—Ä–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ
  const [warehouseNumbersUpdated, setWarehouseNumbersUpdated] = useState(false); // –§–ª–∞–≥ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–æ–≤ —Å–∫–ª–∞–¥–æ–≤
  const [qrGenerationModal, setQrGenerationModal] = useState(false); // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤
  const [selectedWarehouseForQR, setSelectedWarehouseForQR] = useState(null); // –í—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∫–ª–∞–¥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR
  const [warehouseSelectionModal, setWarehouseSelectionModal] = useState(false); // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤—ã–±–æ—Ä–∞ —Å–∫–ª–∞–¥–∞ –¥–ª—è QR
  const [massQRGeneration, setMassQRGeneration] = useState({
    isGenerating: false,
    progress: 0,
    total: 0,
    current: 0,
    results: []
  }); // –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–∞—Å—Å–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤

  // –ù–û–í–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø: QR –∫–æ–¥ –¥–ª—è –∑–∞—è–≤–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤—Å–µ—Ö –≥—Ä—É–∑–∞—Ö
  const [showRequestQRModal, setShowRequestQRModal] = useState(false); // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ QR –∫–æ–¥–∞ –∑–∞—è–≤–∫–∏
  const [selectedRequestForQR, setSelectedRequestForQR] = useState(null); // –í—ã–±—Ä–∞–Ω–Ω–∞—è –∑–∞—è–≤–∫–∞ –¥–ª—è QR
  const [requestQRCode, setRequestQRCode] = useState(null); // –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π QR –∫–æ–¥ –∑–∞—è–≤–∫–∏
  const [requestQRLoading, setRequestQRLoading] = useState(false); // –ó–∞–≥—Ä—É–∑–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∑–∞—è–≤–∫–∏

  // –ù–û–í–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø: QR –∫–æ–¥ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏ –¥–ª—è —Ñ–æ—Ä–º—ã –ø—Ä–∏–µ–º–∞ –≥—Ä—É–∑–∞
  const [showCargoNumberQRModal, setShowCargoNumberQRModal] = useState(false); // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ QR –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏
  const [cargoNumberQRCode, setCargoNumberQRCode] = useState(null); // –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π QR –∫–æ–¥ –Ω–æ–º–µ—Ä–∞
  const [cargoNumberQRLoading, setCargoNumberQRLoading] = useState(false); // –ó–∞–≥—Ä—É–∑–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
  const [preGeneratedCargoNumber, setPreGeneratedCargoNumber] = useState(null); // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –•—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞

  // –ù–û–í–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–æ–≤
  const [showPlacementDetailsModal, setShowPlacementDetailsModal] = useState(false); // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const [selectedCargoForDetails, setSelectedCargoForDetails] = useState(null); // –í—ã–±—Ä–∞–Ω–Ω–∞—è –∑–∞—è–≤–∫–∞ –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è  
  const [placementDetails, setPlacementDetails] = useState(null); // –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏
  const [placementDetailsLoading, setPlacementDetailsLoading] = useState(false); // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  
  // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ì–ª–æ–±–∞–ª—å–Ω—ã–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—à–∏–±–æ–∫ removeChild
  useEffect(() => {
    const handleGlobalError = (event) => {
      if (event.error && event.error.message && 
          (event.error.message.includes('removeChild') || event.error.message.includes('Node'))) {
        console.warn('üîß –ì–ª–æ–±–∞–ª—å–Ω–∞—è –æ—à–∏–±–∫–∞ removeChild –ø–µ—Ä–µ—Ö–≤–∞—á–µ–Ω–∞ –∏ –æ–±—Ä–∞–±–æ—Ç–∞–Ω–∞:', event.error.message);
        event.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –ø–æ–∫–∞–∑ –æ—à–∏–±–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      }
    };
    
    window.addEventListener('error', handleGlobalError);
    
    return () => {
      window.removeEventListener('error', handleGlobalError);
    };
  }, []);
  const [quickPlacementForm, setQuickPlacementForm] = useState({
    block_number: 1,
    shelf_number: 1,
    cell_number: 1
  });
  const [cargoHistory, setCargoHistory] = useState([]);
  const [selectedWarehouse, setSelectedWarehouse] = useState('');
  const [availableCells, setAvailableCells] = useState([]);
  const [historyFilters, setHistoryFilters] = useState({
    status: 'all',
    search: ''
  });
  const [unpaidCargo, setUnpaidCargo] = useState([]);
  const [paymentHistory, setPaymentHistory] = useState([]);
  const [paymentModal, setPaymentModal] = useState(false);
  const [cargoForPayment, setCargoForPayment] = useState(null);
  const [paymentForm, setPaymentForm] = useState({
    cargo_number: '',
    amount_paid: '',
    transaction_type: 'cash',
    notes: ''
  });
  const [warehouseLayout, setWarehouseLayout] = useState(null);
  const [selectedWarehouseForLayout, setSelectedWarehouseForLayout] = useState(null);
  const [layoutModal, setLayoutModal] = useState(false);
  const [usersByRole, setUsersByRole] = useState({
    user: [],
    admin: [],
    warehouse_operator: []
  });
  const [cargoRequests, setCargoRequests] = useState([]);
  const [myRequests, setMyRequests] = useState([]);

  const [requestForm, setRequestForm] = useState({
    recipient_full_name: '',
    recipient_phone: '',
    recipient_address: '',
    pickup_address: '',
    cargo_name: '',
    weight: '',
    declared_value: '80', // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –æ–±—â–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ moscow_to_tajikistan
    description: '',
    route: 'moscow_to_tajikistan'
  });

  // –ü–†–û–ë–õ–ï–ú–ê 3: –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ –≤ "–°–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤"
  const [fullyPlacedCargo, setFullyPlacedCargo] = useState([]);
  const [fullyPlacedPagination, setFullyPlacedPagination] = useState({});
  const [fullyPlacedPage, setFullyPlacedPage] = useState(1);
  const [fullyPlacedPerPage, setFullyPlacedPerPage] = useState(25);
  const [fullyPlacedLoading, setFullyPlacedLoading] = useState(false);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è Individual Units —Ä–µ–∂–∏–º–∞ –≤ —Ä–∞–∑–º–µ—â–µ–Ω–Ω–æ–º –≥—Ä—É–∑–µ
  const [placedCargoViewMode, setPlacedCargoViewMode] = useState('table'); // 'table' –∏–ª–∏ 'individual'
  const [selectedPlacedCargo, setSelectedPlacedCargo] = useState(null);

  // Transport states
  const [transports, setTransports] = useState([]);
  const [transportForm, setTransportForm] = useState({
    driver_name: '',
    driver_phone: '',
    transport_number: '',
    capacity_kg: '',
    direction: ''
  });
  const [selectedTransport, setSelectedTransport] = useState(null);
  const [transportManagementModal, setTransportManagementModal] = useState(false);
  const [availableCargoForTransport, setAvailableCargoForTransport] = useState([]);
  const [selectedCargoForPlacement, setSelectedCargoForPlacement] = useState([]);
  const [transportCargoList, setTransportCargoList] = useState([]);
  const [contactModal, setContactModal] = useState(false);

  // Notification management states
  const [notificationDetailsModal, setNotificationDetailsModal] = useState(false);
  const [selectedNotificationDetails, setSelectedNotificationDetails] = useState(null);

  // Search and header states
  const [searchType, setSearchType] = useState('all');
  const [showSearchResults, setShowSearchResults] = useState(false);

  // Operator-warehouse management states
  const [operatorWarehouseBindings, setOperatorWarehouseBindings] = useState([]);
  const [operatorBindingModal, setOperatorBindingModal] = useState(false);
  const [selectedOperatorForBinding, setSelectedOperatorForBinding] = useState('');
  const [selectedWarehouseForBinding, setSelectedWarehouseForBinding] = useState('');

  // Warehouse cell management states
  const [selectedCellCargo, setSelectedCellCargo] = useState(null);
  const [cargoDetailModal, setCargoDetailModal] = useState(false);
  const [cargoEditModal, setCargoEditModal] = useState(false);
  const [cargoMoveModal, setCargoMoveModal] = useState(false);
  const [editingCargo, setEditingCargo] = useState(null);
  const [cargoEditForm, setCargoEditForm] = useState({});
  const [cargoMoveForm, setCargoMoveForm] = useState({
    warehouse_id: '',
    block_number: '',
    shelf_number: '',
    cell_number: ''
  });

  // QR Code states
  const [qrScannerModal, setQrScannerModal] = useState(false);
  const [qrPrintModal, setQrPrintModal] = useState(false);
  const [selectedCargoForQr, setSelectedCargoForQr] = useState(null);
  const [selectedWarehouseForQr, setSelectedWarehouseForQr] = useState(null);
  const [qrScanResult, setQrScanResult] = useState(null);

  // Arrived transport and cargo placement states
  const [arrivedTransports, setArrivedTransports] = useState([]);
  const [selectedArrivedTransport, setSelectedArrivedTransport] = useState(null);
  const [arrivedTransportModal, setArrivedTransportModal] = useState(false);
  const [arrivedCargoList, setArrivedCargoList] = useState([]);
  const [cargoPlacementModal, setCargoPlacementModal] = useState(false);
  const [selectedCargoForWarehouse, setSelectedCargoForWarehouse] = useState(null);
  const [placementForm, setPlacementForm] = useState({
    warehouse_id: '',
    block_number: 1,
    shelf_number: 1,
    cell_number: 1
  });

  // Transport visualization states
  const [transportVisualizationModal, setTransportVisualizationModal] = useState(false);
  const [selectedTransportForVisualization, setSelectedTransportForVisualization] = useState(null);
  const [transportVisualizationData, setTransportVisualizationData] = useState(null);

  // QR/Number cargo placement states
  const [qrPlacementModal, setQrPlacementModal] = useState(false);
  const [qrPlacementForm, setQrPlacementForm] = useState({
    cargo_number: '',
    qr_data: '',
    cell_qr_data: '',
    block_number: 1,
    shelf_number: 1,
    cell_number: 1
  });

  // Operator-specific states
  const [operatorWarehouses, setOperatorWarehouses] = useState([]);
  const [routeWarehouses, setRouteWarehouses] = useState([]);  // –°–∫–ª–∞–¥—ã –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –º–∞—Ä—à—Ä—É—Ç—É
  const [showWarehouseScheme, setShowWarehouseScheme] = useState(null); // ID —Å–∫–ª–∞–¥–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ —Å—Ö–µ–º—ã
  const [warehouseSchemeData, setWarehouseSchemeData] = useState([]); // –î–∞–Ω–Ω—ã–µ —Å—Ö–µ–º—ã —Å–∫–ª–∞–¥–∞
  const [warehouseSchemeLoading, setWarehouseSchemeLoading] = useState(false); // –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ö–µ–º—ã —Å–∫–ª–∞–¥–∞
  const [warehouseCells, setWarehouseCells] = useState([]); // –Ø—á–µ–π–∫–∏ —Å–∫–ª–∞–¥–∞
  const [showCargoManagementModal, setShowCargoManagementModal] = useState(false); // –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥—Ä—É–∑–æ–º
  const [selectedCargoForManagement, setSelectedCargoForManagement] = useState(null); // –í—ã–±—Ä–∞–Ω–Ω—ã–π –≥—Ä—É–∑ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
  const [showWarehouseReport, setShowWarehouseReport] = useState(null); // ID —Å–∫–ª–∞–¥–∞ –¥–ª—è –æ—Ç—á–µ—Ç–∞
  const [warehouseReportData, setWarehouseReportData] = useState([]); // –î–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞ –ø–æ —Å–∫–ª–∞–¥—É
  const [warehouseDetailedAnalytics, setWarehouseDetailedAnalytics] = useState({}); // –î–µ—Ç–∞–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–∫–ª–∞–¥–æ–≤
  const [interwarehouseTransportModal, setInterwarehouseTransportModal] = useState(false);
  const [interwarehouseForm, setInterwarehouseForm] = useState({
    source_warehouse_id: '',
    destination_warehouse_id: '',
    driver_name: '',
    driver_phone: '',
    capacity_kg: 1000
  });

  const [alerts, setAlerts] = useState([]);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö logout'–æ–≤
  const [isLoggingOut, setIsLoggingOut] = useState(false);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞ –ª–æ–≥–∏–Ω–∞
  const [isLoggingIn, setIsLoggingIn] = useState(false);

  // –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const [showEditProfile, setShowEditProfile] = useState(false);
  const [editProfileForm, setEditProfileForm] = useState({
    full_name: '',
    phone: '',
    email: '',
    address: ''
  });
  const [showRepeatOrderModal, setShowRepeatOrderModal] = useState(false);
  const [repeatOrderData, setRepeatOrderData] = useState(null);
  const [repeatOrderForm, setRepeatOrderForm] = useState({
    cargo_items: [{ cargo_name: '', weight: '', price_per_kg: '' }],
    recipient_full_name: '',
    recipient_phone: '',
    recipient_address: '',
    route: 'moscow_dushanbe',
    delivery_type: 'standard',
    insurance_requested: false,
    special_instructions: '',
    use_multi_cargo: true
  });
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –º—É–ª—å—Ç–∏-–≥—Ä—É–∑ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –≤ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–∫–∞–∑–µ
  const [repeatOrderTotalWeight, setRepeatOrderTotalWeight] = useState(0);
  const [repeatOrderTotalCost, setRepeatOrderTotalCost] = useState(0);
  const [repeatOrderBreakdown, setRepeatOrderBreakdown] = useState([]);

  // –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω —Ñ—É–Ω–∫—Ü–∏–π
  const [showAdminEditUser, setShowAdminEditUser] = useState(false);
  const [adminEditUserForm, setAdminEditUserForm] = useState({
    id: '',
    full_name: '',
    phone: '',
    email: '',
    address: '',
    role: 'user',
    is_active: true
  });
  const [selectedUserForEdit, setSelectedUserForEdit] = useState(null);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –∞–¥–º–∏–Ω–æ–º/–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
  const [showAdminRepeatOrderModal, setShowAdminRepeatOrderModal] = useState(false);
  const [adminRepeatOrderData, setAdminRepeatOrderData] = useState(null);
  const [adminRepeatOrderForm, setAdminRepeatOrderForm] = useState({
    sender_id: '',
    sender_full_name: '',
    sender_phone: '',
    cargo_items: [{ cargo_name: '', weight: '', price_per_kg: '' }],
    recipient_full_name: '',
    recipient_phone: '',
    recipient_address: '',
    route: 'moscow_dushanbe',
    delivery_type: 'standard',
    insurance_requested: false,
    special_instructions: '',
    use_multi_cargo: true
  });
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –º—É–ª—å—Ç–∏-–≥—Ä—É–∑ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ –∞–¥–º–∏–Ω–∞/–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
  const [adminRepeatOrderTotalWeight, setAdminRepeatOrderTotalWeight] = useState(0);
  const [adminRepeatOrderTotalCost, setAdminRepeatOrderTotalCost] = useState(0);
  const [adminRepeatOrderBreakdown, setAdminRepeatOrderBreakdown] = useState([]);

  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è
  const [isFilledFromProfile, setIsFilledFromProfile] = useState(false);
  const [profileSourceUser, setProfileSourceUser] = useState(null);

  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤ –∏ QR-–∫–æ–¥–æ–≤ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏
  const [scannerMode, setScannerMode] = useState('none'); // 'none', 'cargo-barcode', 'cell-qr', 'cargo-qr-search', 'external-scanner'
  const [scannedCargoData, setScannedCargoData] = useState(null);
  const [scannedCellData, setScannedCellData] = useState(null);
  const [placementInProgress, setPlacementInProgress] = useState(false);
  const [scannerError, setScannerError] = useState(null);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞
  const [externalScannerActive, setExternalScannerActive] = useState(false);
  const [externalScannerStep, setExternalScannerStep] = useState('cargo'); // 'cargo', 'cell', 'complete'
  const [externalCargoInput, setExternalCargoInput] = useState('');
  const [externalCellInput, setExternalCellInput] = useState('');
  const [externalScannedCargo, setExternalScannedCargo] = useState(null);
  const [externalScannedCell, setExternalScannedCell] = useState(null);
  const [scannerMessage, setScannerMessage] = useState('');
  
  // –§–ê–ó–ê 3: –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –∏ –∑–∞—â–∏—Ç—ã –æ—Ç –∫–ª–∏–∫–æ–≤
  const [scannerProcessingInput, setScannerProcessingInput] = useState(false);
  const [scannerAutoFocusTarget, setScannerAutoFocusTarget] = useState(null);
  const [scannerClickProtection, setScannerClickProtection] = useState(false);
  
  // –§–ê–ó–ê 4: –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –±–µ–∑ –∫—É—Ä—Å–æ—Ä–∞
  const [scannerAutoTransition, setScannerAutoTransition] = useState(false);
  const [scannerCompletionCount, setScannerCompletionCount] = useState(0);
  const [scannerAutoReset, setScannerAutoReset] = useState(false);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –∫–∞–º–µ—Ä—ã - —Ä–∞–∑–¥–µ–ª–µ–Ω—ã –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞
  const [html5QrCode, setHtml5QrCode] = useState(null);  // –û—Å–Ω–æ–≤–Ω–æ–π —Å–∫–∞–Ω–µ—Ä
  const [html5QrCodePlacement, setHtml5QrCodePlacement] = useState(null);  // –°–∫–∞–Ω–µ—Ä —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const [html5QrCodeModal, setHtml5QrCodeModal] = useState(null);  // –ú–æ–¥–∞–ª—å–Ω—ã–π —Å–∫–∞–Ω–µ—Ä
  const scannerRef = useRef(null);
  const modalScannerRef = useRef(null);  // Ref –¥–ª—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞
  
  // Enhanced refs for React-safe QR scanner isolation
  const placementQrReaderRef = useRef(null);
  const html5QrCodePlacementRef = useRef(null);
  const qrContainerRef = useRef(null);
  const isInitializingRef = useRef(false);

  // Complete isolation of Html5Qrcode from React DOM to prevent removeChild errors
  const [qrScannerContainer, setQrScannerContainer] = useState(null);
  
  // –ú–æ–±–∏–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è
  // –ü–æ–∏—Å–∫ –≥—Ä—É–∑–∞
  const [searchScannerActive, setSearchScannerActive] = useState(false);
  const [searchResult, setSearchResult] = useState(null);
  
  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤
  const [qrCargoNumber, setQrCargoNumber] = useState('');
  const [qrCellCode, setQrCellCode] = useState({ block: '', shelf: '', cell: '', code: '' }); // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –æ–±—ä–µ–∫—Ç–æ–≤ –∏ —Å—Ç—Ä–æ–∫
  const [generatedCargoQR, setGeneratedCargoQR] = useState(null);
  const [generatedCellQR, setGeneratedCellQR] = useState(null);
  
  // –ú–æ–±–∏–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ
  const [mobilePlacementStep, setMobilePlacementStep] = useState('start'); // 'start', 'scan-cargo', 'scan-cell', 'confirm'
  const [scannedCargo, setScannedCargo] = useState(null);
  const [scannedCell, setScannedCell] = useState(null);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
  const [lastScannedData, setLastScannedData] = useState('');
  const [lastScanTime, setLastScanTime] = useState(0);
  
  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —è—á–µ–µ–∫
  const [showSingleCellQRModal, setShowSingleCellQRModal] = useState(false);
  const [singleCellBlock, setSingleCellBlock] = useState('');
  const [singleCellShelf, setSingleCellShelf] = useState('');
  const [singleCellNumber, setSingleCellNumber] = useState('');
  const [singleCellQRResult, setSingleCellQRResult] = useState(null);
  const [singleCellQRLoading, setSingleCellQRLoading] = useState(false);
  
  // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const [sessionPlacements, setSessionPlacements] = useState([]);
  const [sessionPlacementCount, setSessionPlacementCount] = useState(0);
  const [placementInfoMessage, setPlacementInfoMessage] = useState('');
  
  // –ú–æ–±–∏–ª—å–Ω—ã–π –ø—Ä–∏—ë–º –≥—Ä—É–∑–∞
  const [receiveStep, setReceiveStep] = useState('start'); // 'start', 'scan-cargo', 'scan-new-cell', 'confirm'
  const [receivedCargo, setReceivedCargo] = useState(null);
  const [newCell, setNewCell] = useState(null);

  // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä
  const [availableCameras, setAvailableCameras] = useState([]);
  const [currentCameraIndex, setCurrentCameraIndex] = useState(0);

  // Refs –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö QR —Å–∫–∞–Ω–µ—Ä–æ–≤
  const searchQrReaderRef = useRef(null);
  const mobilePlacementQrReaderRef = useRef(null);
  const mobileCellQrReaderRef = useRef(null);
  const receiveCargoQrReaderRef = useRef(null);
  const receiveNewCellQrReaderRef = useRef(null);
  
  // Create isolated container for QR scanner to avoid React conflicts
  const createIsolatedQrContainer = () => {
    if (qrContainerRef.current && !qrContainerRef.current.innerHTML.includes('qr-reader-placement-isolated')) {
      // Create completely isolated container
      const isolatedDiv = document.createElement('div');
      isolatedDiv.id = 'qr-reader-placement-isolated';
      isolatedDiv.style.cssText = `
        width: 100%;
        min-height: 400px;
        background-color: #000000;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
      `;
      
      // Clear any existing content safely without React DOM conflicts
      while (qrContainerRef.current.firstChild) {
        qrContainerRef.current.firstChild.remove();
      }
      
      qrContainerRef.current.appendChild(isolatedDiv);
      console.log('üîß –°–æ–∑–¥–∞–Ω –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è QR —Å–∫–∞–Ω–µ—Ä–∞');
      return 'qr-reader-placement-isolated';
    }
    return 'qr-reader-placement-isolated';
  };

  // Enhanced cleanup with complete DOM isolation
  const completeQrCleanup = async (context = "Unknown") => {
    try {
      console.log(`üßπ ${context}: –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª—è—Ü–∏–æ–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ QR —Å–∫–∞–Ω–µ—Ä–∞...`);
      
      // Stop scanner instance first
      if (html5QrCodePlacementRef.current) {
        try {
          const state = html5QrCodePlacementRef.current.getState();
          if (state === Html5QrcodeScannerState.SCANNING) {
            console.log(`‚èπÔ∏è ${context}: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞...`);
            await html5QrCodePlacementRef.current.stop();
          }
          
          // Clear scanner instance
          await html5QrCodePlacementRef.current.clear();
          console.log(`‚úÖ ${context}: –°–∫–∞–Ω–µ—Ä –æ—á–∏—â–µ–Ω`);
        } catch (error) {
          console.warn(`‚ö†Ô∏è ${context}: –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å–∫–∞–Ω–µ—Ä–∞:`, error.message);
        }
        
        html5QrCodePlacementRef.current = null;
        setHtml5QrCodePlacement(null);
      }
      
      // Force cleanup isolated container
      const isolatedContainer = document.getElementById('qr-reader-placement-isolated');
      if (isolatedContainer) {
        console.log(`üîß ${context}: –û—á–∏—Å—Ç–∫–∞ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞...`);
        
        // Remove all Html5Qrcode elements safely without React DOM conflicts
        const qrElements = isolatedContainer.querySelectorAll('video, canvas, div[id*="html5"], img[id*="qr"]');
        qrElements.forEach(element => {
          try {
            // Use React-safe removal method
            element.remove();
          } catch (removeError) {
            console.debug(`Debug: –≠–ª–µ–º–µ–Ω—Ç —É–∂–µ —É–¥–∞–ª–µ–Ω`);
          }
        });
        
        // Clear container content
        isolatedContainer.innerHTML = '';
        console.log(`‚úÖ ${context}: –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –æ—á–∏—â–µ–Ω`);
      }
      
      // Reset states
      setScannerActive(false);
      isInitializingRef.current = false;
      
      console.log(`‚úÖ ${context}: –ü–æ–ª–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞`);
      
    } catch (error) {
      console.error(`üí• ${context}: –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª–Ω–æ–π –æ—á–∏—Å—Ç–∫–µ:`, error);
      // Force reset everything
      html5QrCodePlacementRef.current = null;
      setHtml5QrCodePlacement(null);
      setScannerActive(false);
      isInitializingRef.current = false;
    }
  };
  const [cameraPermission, setCameraPermission] = useState(null);
  const [camerasAvailable, setCamerasAvailable] = useState([]);
  const [selectedCamera, setSelectedCamera] = useState(null);

  // –ù–æ–≤—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞
  const [enhancedPlacementModal, setEnhancedPlacementModal] = useState(false);
  const [selectedCargoForEnhancedPlacement, setSelectedCargoForEnhancedPlacement] = useState(null);
  const [warehouseAnalytics, setWarehouseAnalytics] = useState(null);
  const [selectedWarehouseForPlacement, setSelectedWarehouseForPlacement] = useState('');
  const [selectedBlockForPlacement, setSelectedBlockForPlacement] = useState(1);
  const [selectedShelfForPlacement, setSelectedShelfForPlacement] = useState(1);
  const [selectedCellForPlacement, setSelectedCellForPlacement] = useState(1);
  const [availableCellsForPlacement, setAvailableCellsForPlacement] = useState([]);
  const [placementLoading, setPlacementLoading] = useState(false);

  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–∫–ª–∞–¥–∞
  const [warehouseDetailedStructure, setWarehouseDetailedStructure] = useState(null);
  const [structureLoading, setStructureLoading] = useState(false);
  const [selectedCellForVisualization, setSelectedCellForVisualization] = useState(null);

  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤
  const [placedCargoList, setPlacedCargoList] = useState([]);
  const [placedCargoPagination, setPlacedCargoPagination] = useState({});
  const [placedCargoPage, setPlacedCargoPage] = useState(1);
  const [placedCargoPerPage, setPlacedCargoPerPage] = useState(25);

  // –°–æ—Å—Ç–æ—è–Ω–∏—è –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è (–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏)
  const [selectedWarehouses, setSelectedWarehouses] = useState([]);
  const [selectedCargo, setSelectedCargo] = useState([]);
  const [selectedUsers, setSelectedUsers] = useState([]);
  const [selectedRequests, setSelectedRequests] = useState([]); // –í—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
  const [selectedPickupRequests, setSelectedPickupRequests] = useState([]); // –í—ã–±—Ä–∞–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä
  const [selectedOperators, setSelectedOperators] = useState([]); // –í—ã–±—Ä–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã
  const [selectedTransports, setSelectedTransports] = useState([]); // –í—ã–±—Ä–∞–Ω–Ω—ã–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ã
  const [bulkDeleteLoading, setBulkDeleteLoading] = useState(false);
  const [deleteConfirmModal, setDeleteConfirmModal] = useState(false);
  const [deleteConfirmData, setDeleteConfirmData] = useState(null);
  const [selectAllWarehouses, setSelectAllWarehouses] = useState(false);
  const [selectAllCargo, setSelectAllCargo] = useState(false);
  const [selectAllUsers, setSelectAllUsers] = useState(false);
  const [selectAllRequests, setSelectAllRequests] = useState(false); // –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –∑–∞—è–≤–∫–∏
  const [selectAllPickupRequests, setSelectAllPickupRequests] = useState(false); // –í—ã–±—Ä–∞—Ç—å –≤—Å–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä
  const [selectAllOperators, setSelectAllOperators] = useState(false); // –í—ã–±—Ä–∞—Ç—å –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
  const [selectAllTransports, setSelectAllTransports] = useState(false); // –í—ã–±—Ä–∞—Ç—å –≤—Å–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ã

  // Enhanced QR Scanner cleanup to prevent React removeChild errors
  const safeStopQrScanner = async (qrCodeInstance, elementId, context = "Unknown") => {
    if (!qrCodeInstance) {
      console.log(`‚ö†Ô∏è ${context}: QR scanner instance is null, no cleanup needed`);
      return;
    }
    
    try {
      console.log(`üõë ${context}: Safely stopping QR scanner...`);
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ DOM —ç–ª–µ–º–µ–Ω—Ç–∞ –ø–µ—Ä–µ–¥ —Ä–∞–±–æ—Ç–æ–π —Å–æ —Å–∫–∞–Ω–µ—Ä–æ–º
      const element = document.getElementById(elementId);
      if (!element || !element.parentNode) {
        console.warn(`‚ö†Ô∏è ${context}: DOM element not found or not attached, skipping cleanup`);
        return;
      }
      
      // Check if scanner is actually running
      const state = qrCodeInstance.getState();
      console.log(`üìä ${context}: Scanner state before stop: ${state}`);
      
      if (state === Html5QrcodeScannerState.SCANNING) {
        console.log(`‚èπÔ∏è ${context}: Scanner is running, stopping...`);
        await qrCodeInstance.stop();
        console.log(`‚úÖ ${context}: Scanner stopped successfully`);
      } else {
        console.log(`‚ÑπÔ∏è ${context}: Scanner not running (state: ${state}), no stop needed`);
      }
      
      // Clear the scanner instance to avoid React conflicts - —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç–æ–π
      setTimeout(() => {
        try {
          // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –≤—Å–µ –µ—â–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ø–µ—Ä–µ–¥ clear
          const currentElement = document.getElementById(elementId);
          if (qrCodeInstance && currentElement && currentElement.parentNode) {
            qrCodeInstance.clear();
            console.log(`üßπ ${context}: Scanner cleared successfully`);
          } else {
            console.log(`‚ÑπÔ∏è ${context}: Element removed from DOM, skipping clear`);
          }
        } catch (clearError) {
          console.warn(`‚ö†Ô∏è ${context}: Error during clear (non-critical):`, clearError);
        }
      }, 100);
      
    } catch (error) {
      // Enhanced error handling for React conflicts
      console.warn(`‚ö†Ô∏è ${context}: Safe cleanup error:`, error);
      
      if (error.message.includes('removeChild') || error.message.includes('Node')) {
        console.log(`üîß ${context}: React DOM conflict detected, forcing cleanup`);
        try {
          // Force cleanup the DOM element to avoid React conflicts - —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞—â–∏—Ç–æ–π
          const element = document.getElementById(elementId);
          if (element && element.parentNode) {
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º parentNode –ø–µ—Ä–µ–¥ —É–¥–∞–ª–µ–Ω–∏–µ–º –¥–æ—á–µ—Ä–Ω–∏—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
            const children = element.querySelectorAll('video, canvas, div[id*="qr-"]');
            children.forEach(child => {
              try {
                // Use React-safe removal method - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –≤—Å–µ –µ—â–µ –≤ DOM
                if (child.parentNode) {
                  child.remove();
                }
              } catch (childError) {
                console.debug(`Debug: Child removal handled:`, childError);
              }
            });
            
            // Safely clear the container
            if (element.parentNode) {
              element.innerHTML = '';
            }
            console.log(`üßπ ${context}: Forced DOM cleanup completed`);
          }
        } catch (forceError) {
          console.debug(`Debug: Force cleanup handled:`, forceError);
        }
      }
    }
  };

  const showAlert = (message, type = 'info') => {
    const id = Date.now();
    setAlerts(prev => [...prev, { id, message, type }]);
    setTimeout(() => {
      setAlerts(prev => prev.filter(alert => alert.id !== id));
    }, 5000);
  };

  // Enhanced QR Scanner lifecycle management with complete isolation
  useEffect(() => {
    // Cleanup function to prevent React removeChild errors when component unmounts
    return () => {
      console.log('üßπ Component cleanup: –ü–æ–ª–Ω–∞—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ QR —Å–∫–∞–Ω–µ—Ä–æ–≤...');
      
      // Use isolated cleanup method
      completeQrCleanup("Component Cleanup").catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞:', error);
      });
      
      console.log('‚úÖ Component cleanup –∑–∞–≤–µ—Ä—à–µ–Ω');
    };
  }, []); // Empty dependency array - only run on mount/unmount

  // Enhanced page navigation cleanup with isolation
  useEffect(() => {
    if (currentPage !== 'cargo-placement') {
      // Clean up placement scanner when leaving placement page
      console.log('üîÑ Page change: –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è...');
      completeQrCleanup("Page Navigation").catch(error => {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ –ø—Ä–∏ –Ω–∞–≤–∏–≥–∞—Ü–∏–∏:', error);
      });
    }
  }, [currentPage]);

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–∞–º–µ—Ä–æ–π –∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ–º
  const initializeCamera = async () => {
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –∫–∞–º–µ—Ä—ã
      const cameras = await Html5Qrcode.getCameras();
      setCamerasAvailable(cameras);
      
      if (cameras && cameras.length > 0) {
        setCameraPermission(true);
        
        // –£–ª—É—á—à–µ–Ω–Ω–∞—è –ª–æ–≥–∏–∫–∞ –≤—ã–±–æ—Ä–∞ –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä—ã
        console.log('Available cameras:', cameras.map(c => ({ id: c.id, label: c.label })));
        
        let backCamera = cameras.find(camera => {
          const label = camera.label.toLowerCase();
          return label.includes('back') || 
                 label.includes('rear') ||
                 label.includes('environment') ||
                 label.includes('0') || // –ß–∞—Å—Ç–æ –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ –∏–º–µ–µ—Ç –∏–Ω–¥–µ–∫—Å 0
                 label.includes('facing back');
        });

        // –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é, –±–µ—Ä–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é (—á–∞—Å—Ç–æ —ç—Ç–æ –∑–∞–¥–Ω—è—è)
        if (!backCamera && cameras.length > 1) {
          backCamera = cameras[cameras.length - 1];
        }

        // –ï—Å–ª–∏ –≤—Å–µ –µ—â–µ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –±–µ—Ä–µ–º –ø–µ—Ä–≤—É—é
        if (!backCamera) {
          backCamera = cameras[0];
        }

        console.log('Selected camera for QR scanning:', backCamera.label);
        setSelectedCamera(backCamera.id);
        return true;
      } else {
        setCameraPermission(false);
        setScannerError('–ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞');
        return false;
      }
    } catch (error) {
      console.error('Camera initialization error:', error);
      setCameraPermission(false);
      setScannerError('–û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –∫–∞–º–µ—Ä–µ. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.');
      return false;
    }
  };

  const startCameraScanner = async () => {
    try {
      const cameraInitialized = await initializeCamera();
      if (!cameraInitialized) return;

      const qrCodeInstance = new Html5Qrcode("qr-reader");
      setHtml5QrCode(qrCodeInstance);

      const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0,
        disableFlip: false,
      };

      await qrCodeInstance.start(
        selectedCamera,
        config,
        (decodedText, decodedResult) => {
          console.log('QR Code scanned:', decodedText);
          handleBarcodeScan(decodedText);
          stopCameraScanner();
        },
        (errorMessage) => {
          // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
          console.debug('QR scan error:', errorMessage);
        }
      );

      showAlert(scannerMode === 'cargo-barcode' ? 
        '–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥ –≥—Ä—É–∑–∞' : 
        '–ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞. –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR-–∫–æ–¥ —è—á–µ–π–∫–∏', 'info');
    } catch (error) {
      console.error('Camera start error:', error);
      setScannerError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É');
      showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è.', 'error');
    }
  };

  const stopCameraScanner = async () => {
    if (html5QrCode) {
      await safeStopQrScanner(html5QrCode, "qr-reader", "Main Scanner");
      setHtml5QrCode(null);
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤ –∏ QR-–∫–æ–¥–æ–≤
  const startCargoScanner = async () => {
    setScannerMode('cargo-barcode');
    setScannerActive(true);
    setScannerError(null);
    setScannedCargoData(null);
    await startCameraScanner();
  };

  const startCellScanner = async () => {
    setScannerMode('cell-qr');
    setScannerActive(true);
    setScannerError(null);
    setScannedCellData(null);
    await startCameraScanner();
  };

  const stopScanner = async () => {
    setScannerMode('none');
    setScannerActive(false);
    setScannerError(null);
    await stopCameraScanner();
  };

  // –ú–æ–±–∏–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
  const startCargoSearch = async () => {
    setSearchScannerActive(true);
    setSearchResult(null);
    setScannerMode('cargo-qr-search');
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    setPlacementActive(true);
    setScannerActive(true);
    setScannerError(null);
    await startMobileQRScanner();
  };

  const startMobilePlacement = async () => {
    setMobilePlacementStep('scan-cargo');
    setScannedCargo(null);
    setScannedCell(null);
    setScannerMode('mobile-placement-cargo');
    setPlacementInfoMessage('–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –≥—Ä—É–∑–∞ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è.');
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    setPlacementActive(true);
    setScannerActive(true);  
    setScannerError(null);
    await startMobileQRScanner();
  };

  const startCargoReceive = async () => {
    setReceiveStep('scan-cargo');
    setReceivedCargo(null);
    setNewCell(null);
    setScannerMode('mobile-receive-cargo');
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    setPlacementActive(true);
    setScannerActive(true);
    setScannerError(null);
    await startMobileQRScanner();
  };

  const startMobileReceive = async () => {
    setReceiveStep('scan-cargo');
    setReceivedCargo(null);
    setNewCell(null);
    setScannerMode('mobile-receive-cargo');
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–ø–µ—Ü–∏–∞–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
    setPlacementActive(true);
    setScannerActive(true);
    setScannerError(null);
    await startMobileQRScanner();
  };

  // –°–ø–µ—Ü–∏–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è QR —Å–∫–∞–Ω–µ—Ä–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
  const startMobileQRScanner = async () => {
    try {
      console.log('üì± –ó–∞–ø—É—Å–∫ –º–æ–±–∏–ª—å–Ω–æ–≥–æ QR —Å–∫–∞–Ω–µ—Ä–∞...');
      
      // Prevent multiple simultaneous initializations
      if (isInitializingRef.current) {
        console.log('‚ö†Ô∏è –°–∫–∞–Ω–µ—Ä —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫...');
        return;
      }
      
      isInitializingRef.current = true;
      
      // Complete cleanup first
      await completeQrCleanup("Mobile Scanner Start");
      
      // Use existing container instead of creating isolated one
      const possibleContainerIds = [
        'qr-reader-placement-main',
        'qr-reader-placement-cargo', 
        'qr-reader-placement-mobile',
        'qr-reader-placement-edit',
        'qr-reader-placement-receive',
        'qr-reader-placement-update',
        'qr-reader-placement-search'
      ];
      
      let containerId = null;
      let qrElement = null;
      
      // –ù–∞–π—Ç–∏ –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
      for (const id of possibleContainerIds) {
        const element = document.getElementById(id);
        if (element && element.offsetParent !== null) { // —ç–ª–µ–º–µ–Ω—Ç –≤–∏–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
          containerId = id;
          qrElement = element;
          console.log(`‚úÖ –ù–∞–π–¥–µ–Ω –¥–æ—Å—Ç—É–ø–Ω—ã–π QR –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä: ${containerId}`);
          break;
        }
      }
      
      if (!qrElement) {
        throw new Error('QR –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω —Å—Ä–µ–¥–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≤–∞—Ä–∏–∞–Ω—Ç–æ–≤');
      }

      // Get cameras with retry logic
      let cameras = [];
      let cameraAttempts = 0;
      const maxCameraAttempts = 3;
      
      while (cameras.length === 0 && cameraAttempts < maxCameraAttempts) {
        try {
          cameraAttempts++;
          console.log(`üé• –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞ (–ø–æ–ø—ã—Ç–∫–∞ ${cameraAttempts}/${maxCameraAttempts})...`);
          cameras = await Html5Qrcode.getCameras();
          
          if (cameras.length === 0 && cameraAttempts < maxCameraAttempts) {
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        } catch (error) {
          console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–º–µ—Ä (–ø–æ–ø—ã—Ç–∫–∞ ${cameraAttempts}):`, error);
          if (cameraAttempts < maxCameraAttempts) {
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }
      }
      
      if (!cameras || cameras.length === 0) {
        throw new Error('–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã');
      }
      
      console.log(`‚úÖ –ù–∞–π–¥–µ–Ω–æ –∫–∞–º–µ—Ä: ${cameras.length}`);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–∞–º–µ—Ä –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
      setAvailableCameras(cameras);
      
      // –í—ã–±–æ—Ä –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä—ã –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–Ω–æ
      let selectedCameraIndex = 0; // fallback –Ω–∞ –ø–µ—Ä–≤—É—é –∫–∞–º–µ—Ä—É
      
      // –ü–æ–∏—Å–∫ –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä—ã –ø–æ label
      const backCameraIndex = cameras.findIndex(camera => 
        camera.label && (
          camera.label.toLowerCase().includes('back') ||
          camera.label.toLowerCase().includes('rear') ||
          camera.label.toLowerCase().includes('environment') ||
          camera.label.toLowerCase().includes('–æ—Å–Ω–æ–≤–Ω–∞—è') ||
          camera.label.toLowerCase().includes('–∑–∞–¥–Ω—è—è')
        )
      );
      
      if (backCameraIndex !== -1) {
        selectedCameraIndex = backCameraIndex;
        console.log(`üì∑ –í—ã–±—Ä–∞–Ω–∞ –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞: ${cameras[backCameraIndex].label}`);
      } else {
        // –ï—Å–ª–∏ –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –ø–æ label, –ø–æ–ø—Ä–æ–±—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∫–∞–º–µ—Ä—É (–æ–±—ã—á–Ω–æ –∑–∞–¥–Ω—è—è)
        if (cameras.length > 1) {
          selectedCameraIndex = cameras.length - 1;
          console.log(`üì∑ –í—ã–±—Ä–∞–Ω–∞ –ø–æ—Å–ª–µ–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ (–ø—Ä–µ–¥–ø–æ–ª–æ–∂–∏—Ç–µ–ª—å–Ω–æ –∑–∞–¥–Ω—è—è): ${cameras[cameras.length - 1].label}`);
        } else {
          console.log(`üì∑ –ò—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –ø–µ—Ä–≤–∞—è –¥–æ—Å—Ç—É–ø–Ω–∞—è –∫–∞–º–µ—Ä–∞: ${cameras[0].label}`);
        }
      }
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å —Ç–µ–∫—É—â–µ–π –∫–∞–º–µ—Ä—ã
      setCurrentCameraIndex(selectedCameraIndex);
      const selectedCameraId = cameras[selectedCameraIndex].id;
      
      // Initialize Html5Qrcode
      const html5QrCode = new Html5Qrcode(containerId);
      html5QrCodePlacementRef.current = html5QrCode;
      
      // Enhanced camera configuration for mobile with FIXED dimensions
      const cameraConfig = {
        width: 300,  // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —à–∏—Ä–∏–Ω–∞
        height: 300, // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞
        facingMode: "environment" // –ú—è–≥–∫–∏–π —Ä–µ–∂–∏–º –¥–ª—è –ª—É—á—à–µ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      };
      
      const scannerConfig = {
        fps: 10,
        qrbox: {
          width: 200,  // –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ä–∞–∑–º–µ—Ä—ã –¥–ª—è qrbox
          height: 200
        },
        aspectRatio: 1.0,
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –Ω–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö
        supportedScanTypes: [Html5QrcodeScanType.SCAN_TYPE_CAMERA],
        rememberLastUsedCamera: true,
        showTorchButtonIfSupported: true
      };
      
      // Start scanning with enhanced error handling and selected camera
      try {
        await html5QrCode.start(
          selectedCameraId, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É
          cameraConfig,
          (decodedText) => {
            console.log('üì± –ú–æ–±–∏–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ:', decodedText);
            handleBarcodeScan(decodedText);
          },
          (error) => {
            // Suppress frequent scanning errors but log important ones
            if (!error.includes('NotFoundException') && !error.includes('No MultiFormat Readers')) {
              console.debug('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...', error);
            }
          },
          scannerConfig
        );
        
        console.log('‚úÖ –ú–æ–±–∏–ª—å–Ω—ã–π QR —Å–∫–∞–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω —Å –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä–æ–π');
        
        // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–º–µ—Ä—ã
        await new Promise(resolve => setTimeout(resolve, 1000));
        console.log('üì∑ –ö–∞–º–µ—Ä–∞ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞, –≥–æ—Ç–æ–≤–∞ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é');
        
      } catch (cameraError) {
        console.warn('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä–æ–π, –ø—Ä–æ–±—É–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é...', cameraError);
        
        // Fallback: –ø–æ–ø—Ä–æ–±—É–µ–º —Å –ø–µ—Ä–≤–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ–π –∫–∞–º–µ—Ä–æ–π
        const fallbackConfig = {
          width: 300,
          height: 300,
          facingMode: "environment"
        };
        
        try {
          await html5QrCode.start(
            cameras[0].id, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é –∫–∞–º–µ—Ä—É
            fallbackConfig,
            (decodedText) => {
              console.log('üì± –ú–æ–±–∏–ª—å–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ (fallback):', decodedText);
              handleBarcodeScan(decodedText);
            },
            (error) => {
              if (!error.includes('NotFoundException') && !error.includes('No MultiFormat Readers')) {
                console.debug('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...', error);
              }
            },
            scannerConfig
          );
          
          console.log('‚úÖ –ú–æ–±–∏–ª—å–Ω—ã–π QR —Å–∫–∞–Ω–µ—Ä –∑–∞–ø—É—â–µ–Ω –≤ fallback —Ä–µ–∂–∏–º–µ');
          
          // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è —Å—Ç–∞–±–∏–ª–∏–∑–∞—Ü–∏–∏
          await new Promise(resolve => setTimeout(resolve, 1000));
          console.log('üì∑ –ö–∞–º–µ—Ä–∞ —Å—Ç–∞–±–∏–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ (fallback), –≥–æ—Ç–æ–≤–∞ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é');
          
        } catch (fallbackError) {
          console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä:', fallbackError);
          throw fallbackError;
        }
      }
      isInitializingRef.current = false;
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –º–æ–±–∏–ª—å–Ω–æ–≥–æ QR —Å–∫–∞–Ω–µ—Ä–∞:', error);
      isInitializingRef.current = false;
      
      setScannerError('–û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∫–∞–º–µ—Ä—ã');
      showAlert(
        '–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥.',
        'error'
      );
      
      // Fallback to manual input
      setPlacementActive(false);
      setScannerActive(false);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä
  const switchCamera = async () => {
    if (!availableCameras || availableCameras.length <= 1) {
      showAlert('–î–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∫–∞–º–µ—Ä–∞', 'info');
      return;
    }

    try {
      // –û—Å—Ç–∞–Ω–æ–≤–∏–º —Ç–µ–∫—É—â–∏–π —Å–∫–∞–Ω–µ—Ä
      if (html5QrCodePlacementRef.current) {
        await html5QrCodePlacementRef.current.stop();
      }

      // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –∫–∞–º–µ—Ä—É
      const nextCameraIndex = (currentCameraIndex + 1) % availableCameras.length;
      setCurrentCameraIndex(nextCameraIndex);

      const nextCamera = availableCameras[nextCameraIndex];
      console.log(`üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∫–∞–º–µ—Ä—É: ${nextCamera.label}`);

      // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–µ—Ä —Å –Ω–æ–≤–æ–π –∫–∞–º–µ—Ä–æ–π
      const possibleContainerIds = [
        'qr-reader-placement-main',
        'qr-reader-placement-cargo', 
        'qr-reader-placement-mobile',
        'qr-reader-placement-edit',
        'qr-reader-placement-receive',
        'qr-reader-placement-update',
        'qr-reader-placement-search'
      ];
      
      let containerId = null;
      
      // –ù–∞–π—Ç–∏ –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä
      for (const id of possibleContainerIds) {
        const element = document.getElementById(id);
        if (element && element.offsetParent !== null) { // —ç–ª–µ–º–µ–Ω—Ç –≤–∏–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
          containerId = id;
          console.log(`‚úÖ –ù–∞–π–¥–µ–Ω –¥–æ—Å—Ç—É–ø–Ω—ã–π QR –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã: ${containerId}`);
          break;
        }
      }
      
      if (!containerId) {
        throw new Error('QR –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã');
      }
      
      const html5QrCode = new Html5Qrcode(containerId);
      html5QrCodePlacementRef.current = html5QrCode;

      // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω–æ–π –∫–∞–º–µ—Ä—ã
      const cameraConfig = {
        width: { ideal: 1280, min: 640 },
        height: { ideal: 720, min: 480 },
        aspectRatio: 1.777777778
      };

      const scannerConfig = {
        fps: 5,
        qrbox: function(viewfinderWidth, viewfinderHeight) {
          const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
          const boxSize = Math.floor(minEdge * 0.8);
          return {
            width: boxSize,
            height: boxSize
          };
        },
        aspectRatio: 1.0
      };

      await html5QrCode.start(
        nextCamera.id,
        cameraConfig,
        (decodedText) => {
          console.log('üì± –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–Ω–æ–π –∫–∞–º–µ—Ä—ã:', decodedText);
          handleBarcodeScan(decodedText);
        },
        (error) => {
          if (!error.includes('NotFoundException')) {
            console.debug('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...', error);
          }
        },
        scannerConfig
      );

      const cameraType = nextCamera.label && (
        nextCamera.label.toLowerCase().includes('back') ||
        nextCamera.label.toLowerCase().includes('rear') ||
        nextCamera.label.toLowerCase().includes('environment')
      ) ? '–∑–∞–¥–Ω—è—è' : '–ø–µ—Ä–µ–¥–Ω—è—è';

      showAlert(`–ö–∞–º–µ—Ä–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∞ –Ω–∞ ${cameraType}`, 'success');
      console.log(`‚úÖ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ ${cameraType} –∫–∞–º–µ—Ä—É –∑–∞–≤–µ—Ä—à–µ–Ω–æ`);

    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤
  const generateCargoQR = async () => {
    if (!qrCargoNumber.trim()) {
      showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≥—Ä—É–∑–∞', 'error');
      return;
    }

    try {
      const response = await apiCall('/api/cargo/generate-qr', 'POST', {
        cargo_number: qrCargoNumber.trim()
      });
      
      if (response && response.qr_code) {
        setGeneratedCargoQR(response.qr_code);
        showAlert('QR –∫–æ–¥ –≥—Ä—É–∑–∞ —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
      }
    } catch (error) {
      console.error('Error generating cargo QR:', error);
      showAlert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è QR –∫–æ–¥–∞: ${error.message}`, 'error');
    }
  };

  const generateCellQR = async () => {
    const cellCode = qrCellCode.code || ''; // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ–ª–µ code –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
    if (!cellCode.trim()) {
      showAlert('–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ —è—á–µ–π–∫–∏ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –ë1-–ü1-–Ø1', 'error');
      return;
    }

    try {
      // –ü–∞—Ä—Å–∏–º –≤–≤–µ–¥–µ–Ω–Ω—ã–π –∫–æ–¥ —è—á–µ–π–∫–∏ –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –±–ª–æ–∫–∞, –ø–æ–ª–∫–∏, —è—á–µ–π–∫–∏
      const cellParts = cellCode.trim().match(/^–ë(\d+)-–ü(\d+)-–Ø(\d+)$/);
      if (!cellParts) {
        showAlert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –≤ —Ñ–æ—Ä–º–∞—Ç–µ: –ë1-–ü1-–Ø1', 'error');
        return;
      }
      
      const block = parseInt(cellParts[1]);
      const shelf = parseInt(cellParts[2]);
      const cell = parseInt(cellParts[3]);
      
      // –ù—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–∫–ª–∞–¥ - –∏—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π –∏–ª–∏ —Ç–µ–∫—É—â–∏–π
      const warehouse_id = selectedWarehouseForManagement?.id || user?.assigned_warehouse_id;
      if (!warehouse_id) {
        showAlert('–ù–µ –≤—ã–±—Ä–∞–Ω —Å–∫–ª–∞–¥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞', 'error');
        return;
      }

      const response = await apiCall('/api/warehouse/cell/generate-qr', 'POST', {
        warehouse_id: warehouse_id,
        block: block,
        shelf: shelf,
        cell: cell,
        format: 'id' // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π ID —Ñ–æ—Ä–º–∞—Ç —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏ —Å–∫–ª–∞–¥–æ–≤
      });
      
      if (response && response.success && response.qr_code) {
        setGeneratedCellQR(response.qr_code);
        showAlert(`QR –∫–æ–¥ –¥–ª—è —è—á–µ–π–∫–∏ ${response.readable_name || cellCode} —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ! –ö–æ–¥: ${response.cell_code}`, 'success');
      } else {
        showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å QR –∫–æ–¥', 'error');
      }
    } catch (error) {
      console.error('Error generating cell QR:', error);
      showAlert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è QR –∫–æ–¥–∞: ${error.message}`, 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –º–æ–±–∏–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
  const confirmMobilePlacement = async () => {
    if (!scannedCargo || !scannedCell) {
      showAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è', 'error');
      return;
    }

    try {
      await handlePlaceCargo(
        scannedCargo.id,
        scannedCell.warehouse_id,
        scannedCell.block_number,
        scannedCell.shelf_number,
        scannedCell.cell_number
      );
      
      showAlert('–ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω!', 'success');
      setMobilePlacementStep('start');
      setScannedCargo(null);
      setScannedCell(null);
      setPlacementActive(false);
      setScannerActive(false);
      await completeQrCleanup("Mobile Placement Complete");
    } catch (error) {
      console.error('Error confirming placement:', error);
      showAlert(`–û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è: ${error.message}`, 'error');
    }
  };

  const confirmCargoReceive = async () => {
    if (!receivedCargo || !newCell) {
      showAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–∏—ë–º–∞ –≥—Ä—É–∑–∞', 'error');
      return;
    }

    try {
      await handlePlaceCargo(
        receivedCargo.id,
        newCell.warehouse_id,
        newCell.block_number,
        newCell.shelf_number,
        newCell.cell_number
      );
      
      showAlert('–ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω—è—Ç –∏ —Ä–∞–∑–º–µ—â–µ–Ω!', 'success');
      setReceiveStep('start');
      setReceivedCargo(null);
      setNewCell(null);
      setPlacementActive(false);
      setScannerActive(false);
      await completeQrCleanup("Cargo Receive Complete");
    } catch (error) {
      console.error('Error confirming receive:', error);
      showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏—ë–º–∞ –≥—Ä—É–∑–∞: ${error.message}`, 'error');
    }
  };

  const confirmMobileReceive = async () => {
    if (!receivedCargo || !newCell) {
      showAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –ø—Ä–∏—ë–º–∞ –≥—Ä—É–∑–∞', 'error');
      return;
    }

    try {
      await handlePlaceCargo(
        receivedCargo.id,
        newCell.warehouse_id,
        newCell.block_number,
        newCell.shelf_number,
        newCell.cell_number
      );
      
      showAlert('–ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω—è—Ç –∏ —Ä–∞–∑–º–µ—â–µ–Ω!', 'success');
      setReceiveStep('start');
      setReceivedCargo(null);
      setNewCell(null);
      setPlacementActive(false);
      setScannerActive(false);
      await completeQrCleanup("Mobile Receive Complete");
    } catch (error) {
      console.error('Error confirming mobile receive:', error);
      showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏—ë–º–∞ –≥—Ä—É–∑–∞: ${error.message}`, 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–∞
  const printQR = (qrCodeData, title) => {
    if (!qrCodeData) {
      showAlert('QR –∫–æ–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
      return;
    }

    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
      return;
    }
    printWindow.document.write(`
      <html>
        <head>
          <title>–ü–µ—á–∞—Ç—å QR –∫–æ–¥–∞ - ${title}</title>
          <style>
            body { 
              font-family: Arial, sans-serif; 
              text-align: center; 
              padding: 20px; 
            }
            .qr-container { 
              margin: 20px auto; 
              max-width: 300px; 
            }
            .qr-title { 
              font-size: 18px; 
              font-weight: bold; 
              margin-bottom: 10px; 
            }
            img { 
              max-width: 100%; 
              height: auto; 
            }
          </style>
        </head>
        <body>
          <div class="qr-container">
            <div class="qr-title">${title}</div>
            <img src="${qrCodeData}" alt="QR Code" />
          </div>
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.print();
  };

  // –§—É–Ω–∫—Ü–∏–∏ —Å–±—Ä–æ—Å–∞ –º–æ–±–∏–ª—å–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
  const resetMobilePlacement = async () => {
    setMobilePlacementStep('start');
    setScannedCargo(null);
    setScannedCell(null);
    setPlacementActive(false);
    setScannerActive(false);
    await completeQrCleanup("Mobile Placement Reset");
  };

  const resetCargoReceive = async () => {
    setReceiveStep('start');
    setReceivedCargo(null);
    setNewCell(null);
    setPlacementActive(false);
    setScannerActive(false);
    await completeQrCleanup("Cargo Receive Reset");
  };

  const resetMobileReceive = async () => {
    setReceiveStep('start');
    setReceivedCargo(null);
    setNewCell(null);
    setPlacementActive(false);
    setScannerActive(false);
    await completeQrCleanup("Mobile Receive Reset");
  };

  const resetCargoSearch = async () => {
    setSearchScannerActive(false);
    setSearchResult(null);
    setPlacementActive(false);
    setScannerActive(false);
    await completeQrCleanup("Cargo Search Reset");
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥—Ä—É–∑–µ –ø–æ –Ω–æ–º–µ—Ä—É
  const getCargoByNumber = async (cargoNumber) => {
    try {
      const response = await apiCall(`/api/cargo/track/${cargoNumber}`, 'GET');
      return response;
    } catch (error) {
      console.error('Error getting cargo by number:', error);
      return null;
    }
  };

  const handleBarcodeScan = async (scannedData) => {
    try {
      // –≠–¢–ê–ü 1: –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ê–Ø –§–ò–õ–¨–¢–†–ê–¶–ò–Ø –°–ò–ú–í–û–õ–û–í (–£–õ–£–ß–®–ï–ù–ù–ê–Ø)
      let filteredData = scannedData.trim();
      const originalData = filteredData;
      
      console.log('üîß –§–ò–õ–¨–¢–†–ê–¶–ò–Ø: –û–±—Ä–∞–±–æ—Ç–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö:', originalData);
      
      // –û—Å–Ω–æ–≤–Ω—ã–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è —Ñ–æ—Ä–º–∞—Ç–æ–≤ QR-–∫–æ–¥–æ–≤
      if (filteredData.includes('.')) {
        console.log('üåê –û–±–Ω–∞—Ä—É–∂–µ–Ω—ã —Ç–æ—á–∫–∏ –≤ QR –∫–æ–¥–µ, –ø—Ä–∏–º–µ–Ω—è–µ–º –∞–≤—Ç–æ—Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é...');
        
        // 001.01.01.001 ‚Üí 001-01-01-001 (–∫–æ–¥—ã —è—á–µ–µ–∫)
        if (/^\d{3}\.\d{2}\.\d{2}\.\d{3}$/.test(filteredData)) {
          filteredData = filteredData.replace(/\./g, '-');
          console.log('‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —è—á–µ–π–∫–∏:', originalData, '‚Üí', filteredData);
        }
        // 250101.01.01 ‚Üí 250101/01/01 (–∫–æ–¥—ã –≥—Ä—É–∑–æ–≤)  
        else if (/^\d{6}\.\d{2}\.\d{2}$/.test(filteredData)) {
          filteredData = filteredData.replace(/\./g, '/');
          console.log('‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≥—Ä—É–∑–∞:', originalData, '‚Üí', filteredData);
        }
        // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —á–∞—Å—Ç–µ–π
        else {
          const parts = filteredData.split('.');
          if (parts.length === 3 && parts[0].length >= 6) {
            // –§–æ—Ä–º–∞—Ç –≥—Ä—É–∑–∞ (6+ —Ü–∏—Ñ—Ä –≤ –Ω–∞—á–∞–ª–µ)
            filteredData = filteredData.replace(/\./g, '/');
            console.log('‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –≥—Ä—É–∑–∞:', originalData, '‚Üí', filteredData);
          } else if (parts.length === 4 && parts[0].length === 3) {
            // –§–æ—Ä–º–∞—Ç —è—á–µ–π–∫–∏ (3 —Ü–∏—Ñ—Ä—ã –≤ –Ω–∞—á–∞–ª–µ)
            filteredData = filteredData.replace(/\./g, '-');
            console.log('‚úÖ –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è —è—á–µ–π–∫–∏:', originalData, '‚Üí', filteredData);
          } else {
            // –ü—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞ —Ç–æ—á–µ–∫ –Ω–∞ —Å–ª–µ—à–∏ –¥–ª—è –¥—Ä—É–≥–∏—Ö —Å–ª—É—á–∞–µ–≤
            filteredData = filteredData.replace(/\./g, '/');
            console.log('‚úÖ –ü—Ä–æ—Å—Ç–∞—è –∑–∞–º–µ–Ω–∞ —Ç–æ—á–µ–∫:', originalData, '‚Üí', filteredData);
          }
        }
      }
      
      // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
      if (filteredData.includes(',')) {
        // –ó–∞–º–µ–Ω–∞ –∑–∞–ø—è—Ç—ã—Ö –Ω–∞ —Ç–æ—á–∫–∏, –∞ –ø–æ—Ç–æ–º –Ω–∞ –Ω—É–∂–Ω—ã–π —Å–∏–º–≤–æ–ª
        const commaConverted = filteredData.replace(/,/g, '.');
        if (/^\d{3}\.\d{2}\.\d{2}\.\d{3}$/.test(commaConverted)) {
          filteredData = commaConverted.replace(/\./g, '-');
          console.log('‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–ø—è—Ç—ã—Ö (—è—á–µ–π–∫–∞):', originalData, '‚Üí', filteredData);
        } else if (/^\d{6}\.\d{2}\.\d{2}$/.test(commaConverted)) {
          filteredData = commaConverted.replace(/\./g, '/');
          console.log('‚úÖ –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è –∑–∞–ø—è—Ç—ã—Ö (–≥—Ä—É–∑):', originalData, '‚Üí', filteredData);
        }
      }
      
      // –£–¥–∞–ª–µ–Ω–∏–µ –ª–∏—à–Ω–∏—Ö –ø—Ä–æ–±–µ–ª–æ–≤ –∏ —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã—Ö —Å–∏–º–≤–æ–ª–æ–≤
      filteredData = filteredData.replace(/\s+/g, '').replace(/[^\w\-\/]/g, '');
      
      if (filteredData !== originalData) {
        console.log('üéØ –†–ï–ó–£–õ–¨–¢–ê–¢ –ê–í–¢–û–§–ò–õ–¨–¢–†–ê–¶–ò–ò:', originalData, '‚Üí', filteredData);
      }
      
      // –ü—Ä–æ–≥—Ä–∞–º–º–Ω–æ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —è–∑—ã–∫ –≤ EN –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø—Ä–æ–±–ª–µ–º –≤ –±—É–¥—É—â–µ–º
      try {
        if (document.activeElement && typeof document.activeElement.setAttribute === 'function') {
          document.activeElement.setAttribute('inputmode', 'latin');
          document.activeElement.setAttribute('lang', 'en');
        }
      } catch (langError) {
        console.debug('–ù–µ —É–¥–∞–ª–æ—Å—å —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —è–∑—ã–∫ EN:', langError);
      }
      
      const processedData = filteredData;
      
      // –≠–¢–ê–ü 5: –ó–ê–©–ò–¢–ê –û–¢ –î–£–ë–õ–ò–†–û–í–ê–ù–ò–Ø –ò –ê–í–¢–û–°–ë–†–û–°
      const currentTime = Date.now();
      
      // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
      if (processedData === lastScannedData && (currentTime - lastScanTime) < 2000) {
        console.log('‚ö° –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:', processedData);
        return;
      }
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ—Å–ª–µ–¥–Ω–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏
      setLastScannedData(processedData);
      setLastScanTime(currentTime);
      
      // –≠–¢–ê–ü 5: –ê–í–¢–û–°–ë–†–û–° –ü–†–ò –ù–ï–ü–†–ê–í–ò–õ–¨–ù–û–ú –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ò
      const resetScannerOnError = () => {
        console.log('üîÑ –ê–í–¢–û–°–ë–†–û–°: –û—á–∏—â–∞–µ–º –ø–æ–ª—è –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ —Å–∫–∞–Ω–µ—Ä–∞');
        
        // –û—á–∏—â–∞–µ–º –≤—Å–µ –ø–æ–ª—è –≤–≤–æ–¥–∞
        const inputs = document.querySelectorAll('input[type="text"], input[type="number"]');
        inputs.forEach(input => {
          if (input.value) {
            input.value = '';
            input.dispatchEvent(new Event('input', { bubbles: true }));
          }
        });
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ—à–∏–±–∫–∏
        setScannerError(null);
        
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º —Ñ–æ–∫—É—Å –Ω–∞ —Å–∫–∞–Ω–µ—Ä —á–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫—É—é –∑–∞–¥–µ—Ä–∂–∫—É
        setTimeout(() => {
          const scannerInput = document.querySelector('input[placeholder*="—Å–∫–∞–Ω–µ—Ä"], input[placeholder*="QR"]');
          if (scannerInput) {
            scannerInput.focus();
          }
        }, 100);
      };
      
      if (scannerMode === 'cargo-barcode') {
        // –û–ë–ù–û–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Å–∏—Å—Ç–µ–º—É –ø–∞—Ä—Å–∏–Ω–≥–∞ QR –∫–æ–¥–æ–≤ —Å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
        const extractedData = extractCargoNumber(processedData);
        console.log('üîç –ü–æ–∏—Å–∫ –≥—Ä—É–∑–∞ —Å –¥–∞–Ω–Ω—ã–º–∏:', extractedData);
        
        let foundCargo = null;
        
        // –ü–æ–∏—Å–∫ –≥—Ä—É–∑–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –¥–∞–Ω–Ω—ã—Ö
        switch (extractedData.type) {
          case 'individual_unit':
            // –ü–æ–∏—Å–∫ –ø–æ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–º—É –Ω–æ–º–µ—Ä—É
            foundCargo = availableCargoForPlacement.find(item => 
              item.cargo_number === extractedData.request_number
            );
            break;
            
          case 'request_number':
          case 'json_request':
            foundCargo = availableCargoForPlacement.find(item => 
              item.cargo_number === extractedData.request_number
            );
            break;
            
          case 'standard_cargo':
          case 'json_cargo':
          case 'generic_number':
            const searchNumber = extractedData.cargo_number || extractedData.number;
            foundCargo = availableCargoForPlacement.find(item => {
              // –¢–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –≥—Ä—É–∑–∞
              if (item.cargo_number === searchNumber) return true;
              // –ü–æ–∏—Å–∫ –ø–æ ID
              if (item.id === searchNumber) return true;
              // –ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É –∑–∞—è–≤–∫–∏
              if (item.request_number === searchNumber) return true;
              // –ü–æ–∏—Å–∫ –≤ –∏—Å—Ö–æ–¥–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
              if (processedData.includes(item.cargo_number)) return true;
              
              return false;
            });
            break;
            
          default:
            // Fallback –ø–æ–∏—Å–∫
            foundCargo = availableCargoForPlacement.find(item => {
              if (item.cargo_number === processedData) return true;
              if (item.id === processedData) return true;
              if (processedData.includes(item.cargo_number)) return true;
              return false;
            });
        }

        if (foundCargo) {
          console.log('‚úÖ –ì—Ä—É–∑ –Ω–∞–π–¥–µ–Ω:', foundCargo);
          setScannedCargoData(foundCargo);
          setScannerActive(false);
          
          // –≠–¢–ê–ü 4: –î–ï–¢–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –ü–†–ò –†–ê–ó–ú–ï–©–ï–ù–ò–ò
          const cargoDetails = {
            cargo_name: foundCargo.cargo_name || foundCargo.items?.[0]?.name || '–ì—Ä—É–∑ –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
            application_number: foundCargo.request_number || foundCargo.cargo_number,
            remaining_items: foundCargo.total_quantity || 1,
            cargo_type: foundCargo.cargo_type || '–ù–µ —É–∫–∞–∑–∞–Ω'
          };
          
          // –°–æ–æ–±—â–µ–Ω–∏–µ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
          let detailMessage = '';
          if (extractedData.type === 'individual_unit') {
            detailMessage = `‚úÖ –ï–¥–∏–Ω–∏—Ü–∞ ${extractedData.full_number} –Ω–∞–π–¥–µ–Ω–∞!\n` +
                          `üì¶ –ì—Ä—É–∑: ${cargoDetails.cargo_name}\n` +
                          `üìÑ –ó–∞—è–≤–∫–∞: ${cargoDetails.application_number}\n` +
                          `üìä –¢–∏–ø: ${cargoDetails.cargo_type}`;
          } else {
            detailMessage = `‚úÖ –ì—Ä—É–∑ ${foundCargo.cargo_number} –Ω–∞–π–¥–µ–Ω!\n` +
                          `üì¶ –ù–∞–∑–≤–∞–Ω–∏–µ: ${cargoDetails.cargo_name}\n` +
                          `üìÑ –ó–∞—è–≤–∫–∞: ${cargoDetails.application_number}\n` +
                          `üìä –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${cargoDetails.remaining_items}`;
          }
          
          showAlert(detailMessage, 'success');
          
          // –≠–¢–ê–ü 2: –ú–ì–ù–û–í–ï–ù–ù–û–ï –°–ö–ê–ù–ò–†–û–í–ê–ù–ò–ï (—É–±–∏—Ä–∞–µ–º –≤—Å–µ –∑–∞–¥–µ—Ä–∂–∫–∏)
          console.log('‚ö° –ú–ì–ù–û–í–ï–ù–ù–´–ô –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é —è—á–µ–π–∫–∏');
          startCellScanner(); // –£–±—Ä–∞–Ω–∞ –∑–∞–¥–µ—Ä–∂–∫–∞ setTimeout
        } else {
          console.log('‚ùå –ì—Ä—É–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω. –î–æ—Å—Ç—É–ø–Ω—ã–µ –≥—Ä—É–∑—ã:', availableCargoForPlacement.map(c => c.cargo_number));
          setScannerError('–ì—Ä—É–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ –æ–∂–∏–¥–∞—é—â–∏—Ö —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ');
          
          // –≠–¢–ê–ü 5: –ê–í–¢–û–°–ë–†–û–° –ü–†–ò –û–®–ò–ë–ö–ï
          let errorMessage = '';
          if (extractedData.type === 'individual_unit') {
            errorMessage = `‚ùå –ï–¥–∏–Ω–∏—Ü–∞ "${extractedData.full_number}" –Ω–µ –Ω–∞–π–¥–µ–Ω–∞\nüìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–º–µ—Ä –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ`;
          } else {
            const searchValue = extractedData.cargo_number || extractedData.number || processedData;
            errorMessage = `‚ùå –ì—Ä—É–∑ "${searchValue}" –Ω–µ –Ω–∞–π–¥–µ–Ω\nüìã –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –Ω–æ–º–µ—Ä –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ`;
          }
          
          showAlert(errorMessage, 'error');
          
          // –ê–≤—Ç–æ—Å–±—Ä–æ—Å —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
          setTimeout(() => {
            resetScannerOnError();
          }, 2000);
        }
      } else if (scannerMode === 'cell-qr') {
        // –ü–∞—Ä—Å–∏–º QR-–∫–æ–¥ —è—á–µ–π–∫–∏
        const cellData = parseCellQRCode(processedData);
        if (cellData) {
          console.log('‚úÖ –Ø—á–µ–π–∫–∞ —É—Å–ø–µ—à–Ω–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–Ω–∞:', cellData);
          setScannedCellData(cellData);
          setScannerActive(false);
          
          // –ù–û–í–û–ï: –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ü–µ–ª–µ–≤–æ–≥–æ —Å–∫–ª–∞–¥–∞
          if (cellData.warehouse_id) {
            await fetchWarehouseStatistics(cellData.warehouse_id);
          }
          
          // –≠–¢–ê–ü 4: –î–ï–¢–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –Ø–ß–ï–ô–ö–ï
          let successMessage = '';
          if (cellData.format === 'compact' && cellData.full_address) {
            successMessage = `‚úÖ –Ø—á–µ–π–∫–∞: ${cellData.full_address}\nüìç –°–∫–ª–∞–¥: ${cellData.warehouse_name || '–°–∫–ª–∞–¥ ‚Ññ' + cellData.warehouse_number}\nüéØ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é`;
          } else if (cellData.format === 'compact') {
            successMessage = `‚úÖ –Ø—á–µ–π–∫–∞: ${cellData.readable_name}\nüìç –°–∫–ª–∞–¥ ‚Ññ${cellData.warehouse_number}\nüéØ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é`;
          } else {
            successMessage = `‚úÖ –Ø—á–µ–π–∫–∞: ${cellData.readable_name}\nüéØ –ì–æ—Ç–æ–≤ –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é`;
          }
          
          showAlert(successMessage, 'success');
          
          // –≠–¢–ê–ü 2: –ú–ì–ù–û–í–ï–ù–ù–û–ï –†–ê–ó–ú–ï–©–ï–ù–ò–ï (—É–±–∏—Ä–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫–∏)
          if (scannedCargoData) {
            console.log('‚ö° –ú–ì–ù–û–í–ï–ù–ù–û–ï —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞');
            await performAutoPlacement();
          }
        } else {
          console.log('‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞ —è—á–µ–π–∫–∏:', processedData);
          setScannerError('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞ —è—á–µ–π–∫–∏');
          
          const errorMsg = `‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞ —è—á–µ–π–∫–∏\nüì± –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ: "${processedData}"\nüìã –û–∂–∏–¥–∞–µ—Ç—Å—è: '001-01-01-001' –∏–ª–∏ '–ë1-–ü1-–Ø1'\nüîÑ –ü–æ–≤—Ç–æ—Ä–∏—Ç–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ`;
          showAlert(errorMsg, 'error');
          
          // –≠–¢–ê–ü 5: –ê–í–¢–û–°–ë–†–û–° –ü–†–ò –û–®–ò–ë–ö–ï –Ø–ß–ï–ô–ö–ò
          setTimeout(() => {
            resetScannerOnError();
          }, 3000);
        }
      } else if (scannerMode === 'cargo-qr-search') {
        // –†–µ–∂–∏–º –ø–æ–∏—Å–∫–∞ –≥—Ä—É–∑–∞
        const cargoNumber = extractCargoNumber(processedData);
        const cargoInfo = await getCargoByNumber(cargoNumber);
        
        if (cargoInfo) {
          setSearchResult(cargoInfo);
          setSearchScannerActive(false);
          setPlacementActive(false);
          setScannerActive(false);
          await completeQrCleanup("Cargo Search Complete");
          showAlert(`–ì—Ä—É–∑ ${cargoInfo.cargo_number} –Ω–∞–π–¥–µ–Ω!`, 'success');
        } else {
          setScannerError('–ì—Ä—É–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
          showAlert('–ì—Ä—É–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ', 'error');
        }
      } else if (scannerMode === 'mobile-placement-cargo') {
        // –ú–æ–±–∏–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ - —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞
        const cargoNumber = extractCargoNumber(processedData);
        const cargoInfo = await getCargoByNumber(cargoNumber);
        
        if (cargoInfo) {
          setScannedCargo(cargoInfo);
          setMobilePlacementStep('scan-cell');
          setScannerMode('mobile-placement-cell');
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
          setPlacementInfoMessage(`‚úÖ –ì—Ä—É–∑ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω: ${cargoInfo.cargo_number} - ${cargoInfo.cargo_name || '–ì—Ä—É–∑'}. –¢–µ–ø–µ—Ä—å –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ —è—á–µ–π–∫–∏ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è.`);
          
          // –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é —è—á–µ–π–∫–∏
          showAlert(`–ì—Ä—É–∑ ${cargoInfo.cargo_number} –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω. –¢–µ–ø–µ—Ä—å –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —è—á–µ–π–∫—É.`, 'success');
        } else {
          setScannerError('–ì—Ä—É–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
          showAlert('–ì—Ä—É–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ', 'error');
        }
      } else if (scannerMode === 'mobile-placement-cell') {
        // –ú–æ–±–∏–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ - —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —è—á–µ–π–∫–∏
        const cellData = parseCellQRCode(processedData);
        if (cellData) {
          setScannedCell(cellData);
          
          // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ–º
          setPlacementInfoMessage(`üì¶ –Ø—á–µ–π–∫–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞: –ë${cellData.block_number}-–ü${cellData.shelf_number}-–Ø${cellData.cell_number}. –†–∞–∑–º–µ—â–∞–µ–º –≥—Ä—É–∑...`);
          
          // –í—ã–ø–æ–ª–Ω—è–µ–º —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ –≤ performMobilePlacement)
          try {
            await performMobilePlacement(scannedCargo, cellData);
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:', error);
            showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ –≥—Ä—É–∑–∞', 'error');
          }
        } else {
          setScannerError('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞ —è—á–µ–π–∫–∏');
          showAlert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞ —è—á–µ–π–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
        }
      } else if (scannerMode === 'mobile-receive-cargo') {
        // –ú–æ–±–∏–ª—å–Ω—ã–π –ø—Ä–∏—ë–º - —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞
        const cargoNumber = extractCargoNumber(processedData);
        const cargoInfo = await getCargoByNumber(cargoNumber);
        
        if (cargoInfo) {
          setReceivedCargo(cargoInfo);
          setReceiveStep('scan-new-cell');
          setScannerMode('mobile-receive-cell');
          // –ù–µ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä, –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é –Ω–æ–≤–æ–π —è—á–µ–π–∫–∏
          showAlert(`–ì—Ä—É–∑ ${cargoInfo.cargo_number} –≥–æ—Ç–æ–≤ –∫ –ø—Ä–∏—ë–º—É. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –Ω–æ–≤—É—é —è—á–µ–π–∫—É.`, 'success');
        } else {
          setScannerError('–ì—Ä—É–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω');
          showAlert('–ì—Ä—É–∑ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ', 'error');
        }
      } else if (scannerMode === 'mobile-receive-cell') {
        // –ú–æ–±–∏–ª—å–Ω—ã–π –ø—Ä–∏—ë–º - —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π —è—á–µ–π–∫–∏
        const cellData = parseCellQRCode(processedData);
        if (cellData) {
          setNewCell(cellData);
          setReceiveStep('confirm');
          setPlacementActive(false);
          setScannerActive(false);
          await completeQrCleanup("New Cell Scanned");
          showAlert('–ù–æ–≤–∞—è —è—á–µ–π–∫–∞ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞. –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø—Ä–∏—ë–º –≥—Ä—É–∑–∞.', 'success');
        } else {
          setScannerError('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞ —è—á–µ–π–∫–∏');
          showAlert('–ù–µ–≤–µ—Ä–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR-–∫–æ–¥–∞ —è—á–µ–π–∫–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.', 'error');
        }
      }
    } catch (error) {
      console.error('Barcode scan error:', error);
      setScannerError('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö');
      showAlert('–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö', 'error');
    }
  };

  const extractCargoNumber = (scannedData) => {
    console.log('üîç –≠–¢–ê–ü 1: –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–∞ –≥—Ä—É–∑–∞ –∏–∑:', scannedData);
    
    // –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ü–æ–¥–¥–µ—Ä–∂–∫–∞ —Ç—Ä–µ—Ö —Ç–∏–ø–æ–≤ QR –∫–æ–¥–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–æ–≤
    try {
      const cleanData = scannedData.trim();
      
      // –ü–†–û–í–ï–†–ö–ê –ù–ê –ü–£–°–¢–´–ï –î–ê–ù–ù–´–ï
      if (!cleanData) {
        console.log('‚ùå –ü—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ QR –∫–æ–¥–∞');
        return { type: 'empty', error: '–ü—É—Å—Ç—ã–µ –¥–∞–Ω–Ω—ã–µ QR –∫–æ–¥–∞' };
      }
      
      // –¢–ò–ü 3: –ï–¥–∏–Ω–∏—Ü–∞ –≥—Ä—É–∑–∞ –≤–Ω—É—Ç—Ä–∏ —Ç–∏–ø–∞ (010101.01.01 –∏–ª–∏ 010101/01/01)
      const unitInCargoTypeMatch = cleanData.match(/^(\d{1,10})[\./](\d{1,2})[\./](\d{1,2})$/);
      if (unitInCargoTypeMatch) {
        console.log('‚úÖ –¢–ò–ü 3: –ï–¥–∏–Ω–∏—Ü–∞ –≥—Ä—É–∑–∞ –≤–Ω—É—Ç—Ä–∏ —Ç–∏–ø–∞ –Ω–∞–π–¥–µ–Ω–∞:', unitInCargoTypeMatch);
        return {
          type: 'UNIT_IN_CARGO_TYPE',
          request_number: unitInCargoTypeMatch[1],    // 010101
          cargo_type: unitInCargoTypeMatch[2],        // 01
          unit_number: unitInCargoTypeMatch[3],       // 01
          full_number: cleanData,                     // 010101.01.01
          description: `–ï–¥–∏–Ω–∏—Ü–∞ ${unitInCargoTypeMatch[3]} –≥—Ä—É–∑–∞ —Ç–∏–ø–∞ ${unitInCargoTypeMatch[2]} –∏–∑ –∑–∞—è–≤–∫–∏ ${unitInCargoTypeMatch[1]}`
        };
      }
      
      // –¢–ò–ü 2: –ì—Ä—É–∑ –≤–Ω—É—Ç—Ä–∏ –∑–∞—è–≤–∫–∏ (010101.01 –∏–ª–∏ 010101/01)
      const cargoInRequestMatch = cleanData.match(/^(\d{1,10})[\./](\d{1,2})$/);
      if (cargoInRequestMatch) {
        console.log('‚úÖ –¢–ò–ü 2: –ì—Ä—É–∑ –≤–Ω—É—Ç—Ä–∏ –∑–∞—è–≤–∫–∏ –Ω–∞–π–¥–µ–Ω:', cargoInRequestMatch);
        return {
          type: 'CARGO_IN_REQUEST',
          request_number: cargoInRequestMatch[1],     // 010101
          cargo_type: cargoInRequestMatch[2],         // 01
          full_number: cleanData,                     // 010101.01
          description: `–ì—Ä—É–∑ —Ç–∏–ø–∞ ${cargoInRequestMatch[2]} –∏–∑ –∑–∞—è–≤–∫–∏ ${cargoInRequestMatch[1]}`
        };
      }
      
      // –¢–ò–ü 1: –ü—Ä–æ—Å—Ç–æ–π –Ω–æ–º–µ—Ä –≥—Ä—É–∑–∞ (1-10 —Ü–∏—Ñ—Ä)
      const simpleCargoMatch = cleanData.match(/^(\d{1,10})$/);
      if (simpleCargoMatch) {
        console.log('‚úÖ –¢–ò–ü 1: –ü—Ä–æ—Å—Ç–æ–π –Ω–æ–º–µ—Ä –≥—Ä—É–∑–∞ –Ω–∞–π–¥–µ–Ω:', simpleCargoMatch[1]);
        return {
          type: 'SIMPLE_CARGO',
          cargo_number: simpleCargoMatch[1],          // 123456
          request_number: simpleCargoMatch[1],        // –¢–æ –∂–µ —Å–∞–º–æ–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
          full_number: cleanData,                     // 123456
          description: `–ü—Ä–æ—Å—Ç–æ–π –≥—Ä—É–∑ —Å –Ω–æ–º–µ—Ä–æ–º ${simpleCargoMatch[1]}`
        };
      }
      
      // –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–´–ï –§–û–†–ú–ê–¢–´ –î–õ–Ø –°–û–í–ú–ï–°–¢–ò–ú–û–°–¢–ò
      
      // JSON —Ñ–æ—Ä–º–∞—Ç (–¥–ª—è —Å—Ç–∞—Ä—ã—Ö QR –∫–æ–¥–æ–≤)
      if (cleanData.includes('{') && cleanData.includes('}')) {
        try {
          const parsed = JSON.parse(cleanData);
          if (parsed.cargo_number) {
            console.log('‚úÖ JSON: –ù–∞–π–¥–µ–Ω –Ω–æ–º–µ—Ä –≥—Ä—É–∑–∞:', parsed.cargo_number);
            return {
              type: 'JSON_CARGO',
              cargo_number: parsed.cargo_number,
              full_number: parsed.cargo_number,
              description: `–ì—Ä—É–∑ –∏–∑ JSON: ${parsed.cargo_number}`,
              original_data: parsed
            };
          }
          if (parsed.request_number) {
            console.log('‚úÖ JSON: –ù–∞–π–¥–µ–Ω –Ω–æ–º–µ—Ä –∑–∞—è–≤–∫–∏:', parsed.request_number);
            return {
              type: 'JSON_REQUEST',
              request_number: parsed.request_number,
              full_number: parsed.request_number,
              description: `–ó–∞—è–≤–∫–∞ –∏–∑ JSON: ${parsed.request_number}`,
              original_data: parsed
            };
          }
        } catch (jsonError) {
          console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON, –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç');
        }
      }
      
      // –ü—Ä–µ—Ñ–∏–∫—Å–Ω—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã (TEMP-, REQ-, –∏ —Ç.–¥.)
      const prefixMatch = cleanData.match(/^[A-Z]+-(\d+)$/);
      if (prefixMatch) {
        console.log('‚úÖ –ü–†–ï–§–ò–ö–°: –ù–∞–π–¥–µ–Ω –Ω–æ–º–µ—Ä —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º:', prefixMatch[1]);
        return {
          type: 'PREFIXED_CARGO',
          cargo_number: prefixMatch[1],
          full_number: cleanData,
          description: `–ì—Ä—É–∑ —Å –ø—Ä–µ—Ñ–∏–∫—Å–æ–º: ${cleanData}`
        };
      }
      
      // –õ—é–±—ã–µ –¥—Ä—É–≥–∏–µ —Ü–∏—Ñ—Ä–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
      const anyNumberMatch = cleanData.match(/(\d+)/);
      if (anyNumberMatch) {
        console.log('‚úÖ –û–ë–©–ò–ô: –ù–∞–π–¥–µ–Ω –ª—é–±–æ–π –Ω–æ–º–µ—Ä:', anyNumberMatch[1]);
        return {
          type: 'GENERIC_NUMBER',
          cargo_number: anyNumberMatch[1],
          full_number: cleanData,
          description: `–û–±—â–∏–π –Ω–æ–º–µ—Ä: ${anyNumberMatch[1]}`
        };
      }
      
      // –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
      console.log('‚ö†Ô∏è –ù–ï–ò–ó–í–ï–°–¢–ù–´–ô —Ñ–æ—Ä–º–∞—Ç QR –∫–æ–¥–∞:', cleanData);
      return {
        type: 'UNKNOWN',
        raw_data: cleanData,
        full_number: cleanData,
        description: `–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç: ${cleanData}`,
        error: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR –∫–æ–¥–∞'
      };
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –Ω–æ–º–µ—Ä–∞ –≥—Ä—É–∑–∞:', error);
      return {
        type: 'ERROR',
        error: error.message,
        raw_data: scannedData,
        description: `–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞: ${error.message}`
      };
    }
  };

  const parseCellQRCode = (qrData) => {
    try {
      console.log('üîç –ü–∞—Ä—Å–∏–Ω–≥ QR –∫–æ–¥–∞ —è—á–µ–π–∫–∏:', qrData);
      
      // –û–ë–ù–û–í–õ–ï–ù–ò–ï: –ù–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç 9 —Ü–∏—Ñ—Ä: 003010101 (—Å–∫–ª–∞–¥ –±–ª–æ–∫ –ø–æ–ª–∫–∞ —è—á–µ–π–∫–∞)
      const newCompactFormatMatch = qrData.match(/^(\d{3})(\d{2})(\d{2})(\d{2})$/);
      if (newCompactFormatMatch) {
        console.log('‚úÖ –ù–∞–π–¥–µ–Ω –ù–û–í–´–ô –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR –∫–æ–¥–∞ (9 —Ü–∏—Ñ—Ä):', newCompactFormatMatch);
        const warehouseNum = parseInt(newCompactFormatMatch[1]);
        const blockNum = parseInt(newCompactFormatMatch[2]);
        const shelfNum = parseInt(newCompactFormatMatch[3]);
        const cellNum = parseInt(newCompactFormatMatch[4]);
        
        // –ù–∞—Ö–æ–¥–∏–º —Å–∫–ª–∞–¥ –ø–æ warehouse_number
        const targetWarehouse = warehouses.find(w => w.warehouse_number === warehouseNum);
        if (!targetWarehouse) {
          console.error(`‚ùå –°–∫–ª–∞–¥ —Å –Ω–æ–º–µ—Ä–æ–º ${warehouseNum} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
          return null;
        }
        
        console.log(`üè¢ –ù–∞–π–¥–µ–Ω —Ü–µ–ª–µ–≤–æ–π —Å–∫–ª–∞–¥: ${targetWarehouse.name} (ID: ${targetWarehouse.id})`);
        
        return {
          format: 'compact-new',
          warehouse_number: warehouseNum,
          warehouse_id: targetWarehouse.id,
          warehouse_name: targetWarehouse.name,
          warehouse_location: targetWarehouse.location,
          block_number: blockNum,
          shelf_number: shelfNum,
          cell_number: cellNum,
          readable_name: `–ë${blockNum}-–ü${shelfNum}-–Ø${cellNum}`,
          full_address: `${targetWarehouse.name} - –ë${blockNum}-–ü${shelfNum}-–Ø${cellNum}`,
          cell_code: qrData // –ü–æ–ª–Ω—ã–π –∫–æ–¥ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
        };
      }

      // –°–¢–ê–†–´–ô: –§–æ—Ä–º–∞—Ç 8 —Ü–∏—Ñ—Ä: 03010101 (–¥–ª—è –æ–±—Ä–∞—Ç–Ω–æ–π —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
      const oldCompactFormatMatch = qrData.match(/^(\d{2})(\d{2})(\d{2})(\d{2})$/);
      if (oldCompactFormatMatch) {
        console.log('‚úÖ –ù–∞–π–¥–µ–Ω –°–¢–ê–†–´–ô –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR –∫–æ–¥–∞ (8 —Ü–∏—Ñ—Ä):', oldCompactFormatMatch);
        const warehouseNum = parseInt(oldCompactFormatMatch[1]);
        const blockNum = parseInt(oldCompactFormatMatch[2]);
        const shelfNum = parseInt(oldCompactFormatMatch[3]);
        const cellNum = parseInt(oldCompactFormatMatch[4]);
        
        // –ù–∞—Ö–æ–¥–∏–º —Å–∫–ª–∞–¥ –ø–æ warehouse_number
        const targetWarehouse = warehouses.find(w => w.warehouse_number === warehouseNum);
        if (!targetWarehouse) {
          console.error(`‚ùå –°–∫–ª–∞–¥ —Å –Ω–æ–º–µ—Ä–æ–º ${warehouseNum} –Ω–µ –Ω–∞–π–¥–µ–Ω`);
          return null;
        }
        
        console.log(`üè¢ –ù–∞–π–¥–µ–Ω —Ü–µ–ª–µ–≤–æ–π —Å–∫–ª–∞–¥: ${targetWarehouse.name} (ID: ${targetWarehouse.id})`);
        
        return {
          format: 'compact-old',
          warehouse_number: warehouseNum,
          warehouse_id: targetWarehouse.id,
          warehouse_name: targetWarehouse.name,
          warehouse_location: targetWarehouse.location,
          block_number: blockNum,
          shelf_number: shelfNum,
          cell_number: cellNum,
          readable_name: `–ë${blockNum}-–ü${shelfNum}-–Ø${cellNum}`,
          full_address: `${targetWarehouse.name} - –ë${blockNum}-–ü${shelfNum}-–Ø${cellNum}`,
          cell_code: qrData // –ü–æ–ª–Ω—ã–π –∫–æ–¥ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
        };
      }
      
      // –°—Ç–∞—Ä—ã–π —Ñ–æ—Ä–º–∞—Ç —Å ID –Ω–æ–º–µ—Ä–∞–º–∏: 001-01-01-001 (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
      const idFormatMatch = qrData.match(/^(\d{3})-(\d{2})-(\d{2})-(\d{3})$/);
      if (idFormatMatch) {
        console.log('‚úÖ –ù–∞–π–¥–µ–Ω ID —Ñ–æ—Ä–º–∞—Ç QR –∫–æ–¥–∞:', idFormatMatch);
        return {
          format: 'id',
          warehouse_id_number: idFormatMatch[1],
          block_id_number: idFormatMatch[2],
          shelf_id_number: idFormatMatch[3],
          cell_id_number: idFormatMatch[4],
          // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —á–∏—Ç–∞–µ–º–æ–µ –∏–º—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
          readable_name: `–ë${parseInt(idFormatMatch[2])}-–ü${parseInt(idFormatMatch[3])}-–Ø${parseInt(idFormatMatch[4])}`,
          cell_code: qrData // –ü–æ–ª–Ω—ã–π –∫–æ–¥ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
        };
      }

      // –§–æ—Ä–º–∞—Ç —Å —á–∏—Ç–∞–µ–º—ã–º–∏ –Ω–∞–∑–≤–∞–Ω–∏—è–º–∏: –ë1-–ü1-–Ø1 (–¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º–∏ QR)
      const simpleFormatMatch = qrData.match(/^–ë(\d+)-–ü(\d+)-–Ø(\d+)$/);
      if (simpleFormatMatch) {
        console.log('‚úÖ –ù–∞–π–¥–µ–Ω –ø—Ä–æ—Å—Ç–æ–π —Ñ–æ—Ä–º–∞—Ç QR –∫–æ–¥–∞:', simpleFormatMatch);
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ –Ω—É–∂–Ω–æ –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å warehouse_id –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —Å–∫–ª–∞–¥ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∫–∞–∫ warehouse_id –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        let defaultWarehouseId = null;
        if (operatorWarehouses && operatorWarehouses.length > 0) {
          defaultWarehouseId = operatorWarehouses[0].id;
          console.log(`üè¢ –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–∫–ª–∞–¥ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞: ${operatorWarehouses[0].name} (ID: ${defaultWarehouseId})`);
        } else if (warehouses && warehouses.length > 0) {
          defaultWarehouseId = warehouses[0].id;
          console.log(`üè¢ –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø–µ—Ä–≤—ã–π —Å–∫–ª–∞–¥ –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞: ${warehouses[0].name} (ID: ${defaultWarehouseId})`);
        }
        
        return {
          format: 'simple',
          warehouse_id: defaultWarehouseId, // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–π warehouse_id
          block_number: parseInt(simpleFormatMatch[1]),
          shelf_number: parseInt(simpleFormatMatch[2]),
          cell_number: parseInt(simpleFormatMatch[3]),
          readable_name: qrData, // –£–∂–µ –≤ —á–∏—Ç–∞–µ–º–æ–º —Ñ–æ—Ä–º–∞—Ç–µ
          cell_code: defaultWarehouseId ? `${defaultWarehouseId}-${qrData}` : qrData // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π cell_code –¥–ª—è backend
        };
      }

      // JSON —Ñ–æ—Ä–º–∞—Ç (—Å—Ç–∞—Ä—ã–π)
      if (qrData.includes('{')) {
        console.log('üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ JSON —Ñ–æ—Ä–º–∞—Ç–∞ QR –∫–æ–¥–∞');
        const parsed = JSON.parse(qrData);
        return {
          format: 'json',
          warehouse_id: parsed.warehouse_id,
          block_number: parseInt(parsed.block_number),
          shelf_number: parseInt(parsed.shelf_number),
          cell_number: parseInt(parsed.cell_number),
          readable_name: `–ë${parsed.block_number}-–ü${parsed.shelf_number}-–Ø${parsed.cell_number}`,
          cell_code: `${parsed.warehouse_id}-–ë${parsed.block_number}-–ü${parsed.shelf_number}-–Ø${parsed.cell_number}`
        };
      } 
      
      // –§–æ—Ä–º–∞—Ç —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏ warehouse_id:block_number:shelf_number:cell_number (—Å—Ç–∞—Ä—ã–π)
      const parts = qrData.split(':');
      if (parts.length === 4) {
        console.log('üîç –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞ —Å —Ä–∞–∑–¥–µ–ª–∏—Ç–µ–ª—è–º–∏');
        return {
          format: 'colon_separated',
          warehouse_id: parts[0],
          block_number: parseInt(parts[1]),
          shelf_number: parseInt(parts[2]),
          cell_number: parseInt(parts[3]),
          readable_name: `–ë${parts[1]}-–ü${parts[2]}-–Ø${parts[3]}`,
          cell_code: `${parts[0]}-–ë${parts[1]}-–ü${parts[2]}-–Ø${parts[3]}`
        };
      }
      
      console.warn('‚ùå –ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç QR –∫–æ–¥–∞ —è—á–µ–π–∫–∏:', qrData);
      return null;
    } catch (error) {
      console.error('QR parsing error:', error);
      return null;
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∑–∞ —Å–µ–≥–æ–¥–Ω—è
  const fetchTodayPlacementStats = async () => {
    try {
      const stats = await apiCall('/api/operator/placement-statistics/today');
      return stats?.today_placements || 0;
    } catch (error) {
      console.error('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∑–∞ —Å–µ–≥–æ–¥–Ω—è:', error);
      return 0;
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∫–ª–∞–¥–∞ –ø—Ä–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–∏ —è—á–µ–π–∫–∏
  const fetchWarehouseStatistics = async (warehouseId) => {
    try {
      console.log(`üìä –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∫–ª–∞–¥–∞: ${warehouseId}`);
      const stats = await apiCall(`/api/warehouses/${warehouseId}/statistics`);
      setTargetWarehouseStats(stats);
      console.log('‚úÖ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∫–ª–∞–¥–∞ –ø–æ–ª—É—á–µ–Ω–∞:', stats);
      return stats;
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∫–ª–∞–¥–∞:', error);
      return null;
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞
  const openCargoPlacementModal = async () => {
    setSessionPlacedCount(0); // –°—á–µ—Ç—á–∏–∫ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤ –≤ —Å–µ—Å—Å–∏–∏
    setTargetWarehouseStats(null); // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ü–µ–ª–µ–≤–æ–≥–æ —Å–∫–ª–∞–¥–∞
    setPlacementStatistics(null); // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
    setSessionPlacedCargo([]); // –û—á–∏—â–∞–µ–º —Å–ø–∏—Å–æ–∫ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤ –≤ —Å–µ—Å—Å–∏–∏
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
    await fetchPlacementStatistics();
    
    setShowCargoPlacementModal(true);
  };

  // –û–ë–ù–û–í–õ–ï–ù–û: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–∑–∞ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
  const handleDeleteCargoCompletely = async (cargoId, cargoNumber, cargoList = null) => {
    // –ò—â–µ–º –≥—Ä—É–∑ –≤ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–º —Å–ø–∏—Å–∫–µ –∏–ª–∏ –≤ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
    let cargoItem = null;
    if (cargoList) {
      cargoItem = cargoList.find(item => item.id === cargoId);
    } else {
      cargoItem = availableCargoForPlacement.find(item => item.id === cargoId);
    }
    
    if (cargoItem) {
      openDeleteConfirmModal('cargo-placement', cargoItem, false);
    } else {
      // –ï—Å–ª–∏ –Ω–µ –Ω–∞—à–ª–∏ –≤ —Å–ø–∏—Å–∫–∞—Ö, —Å–æ–∑–¥–∞–µ–º –æ–±—ä–µ–∫—Ç –≥—Ä—É–∑–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
      cargoItem = { id: cargoId, cargo_number: cargoNumber };
      openDeleteConfirmModal('cargo-placement', cargoItem, false);
    }
  };

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  const handleDeleteCargoFromPlacement = handleDeleteCargoCompletely;

  // –ù–û–í–û–ï: –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–∑–æ–≤
  const handleSelectCargoForDeletion = (cargoId) => {
    setSelectedCargoForDeletion(prev => {
      if (prev.includes(cargoId)) {
        return prev.filter(id => id !== cargoId);
      } else {
        return [...prev, cargoId];
      }
    });
  };

  const handleSelectAllCargoForDeletion = () => {
    if (selectedCargoForDeletion.length === availableCargoForPlacement.length) {
      // –°–Ω–∏–º–∞–µ–º –≤—ã–¥–µ–ª–µ–Ω–∏–µ —Å–æ –≤—Å–µ—Ö
      setSelectedCargoForDeletion([]);
    } else {
      // –í—ã–¥–µ–ª—è–µ–º –≤—Å–µ –≥—Ä—É–∑—ã
      setSelectedCargoForDeletion(availableCargoForPlacement.map(cargo => cargo.id));
    }
  };

  // –û–ë–ù–û–í–õ–ï–ù–û: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–∑–æ–≤ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑ —Å–∏—Å—Ç–µ–º—ã
  const handleBulkDeleteCargoCompletely = async (selectedIds = null, cargoList = null) => {
    const idsToDelete = selectedIds || selectedCargoForDeletion;
    
    if (idsToDelete.length === 0) {
      showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–∑—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'warning');
      return;
    }

    // –ù–∞–π–¥–µ–º –≥—Ä—É–∑—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –∏–∑ –ø–µ—Ä–µ–¥–∞–Ω–Ω–æ–≥–æ —Å–ø–∏—Å–∫–∞ –∏–ª–∏ –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
    let selectedCargoItems = [];
    if (cargoList) {
      selectedCargoItems = cargoList.filter(cargo => idsToDelete.includes(cargo.id));
    } else {
      selectedCargoItems = availableCargoForPlacement.filter(cargo => idsToDelete.includes(cargo.id));
    }
    
    // –ï—Å–ª–∏ –Ω–µ –≤—Å–µ –≥—Ä—É–∑—ã –Ω–∞–π–¥–µ–Ω—ã –≤ —Å–ø–∏—Å–∫–µ, –¥–æ–ø–æ–ª–Ω—è–µ–º –Ω–µ–¥–æ—Å—Ç–∞—é—â–∏–µ
    if (selectedCargoItems.length < idsToDelete.length) {
      const foundIds = selectedCargoItems.map(item => item.id);
      const missingIds = idsToDelete.filter(id => !foundIds.includes(id));
      
      missingIds.forEach(id => {
        selectedCargoItems.push({ id: id, cargo_number: `ID: ${id}` });
      });
    }
    
    // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –ü–ï–†–ï–î –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    // —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å React –æ—à–∏–±–æ–∫ —Å DOM –º–∞–Ω–∏–ø—É–ª—è—Ü–∏—è–º–∏
    if (!selectedIds) { // –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      setSelectedCargoForDeletion([]);
    }
    
    openDeleteConfirmModal('cargo-placement', selectedCargoItems, true);
  };

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å—Ç–∞—Ä–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  const handleBulkDeleteCargoFromPlacement = () => handleBulkDeleteCargoCompletely();

  const performAutoPlacement = async () => {
    if (!scannedCargoData || !scannedCellData) {
      showAlert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞', 'error');
      return;
    }

    setPlacementInProgress(true);
    try {
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–ø—Ä–µ–¥–µ–ª—è–µ–º warehouse_id –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–æ—Ä–º–∞—Ç–∞ QR –∫–æ–¥–∞
      let warehouseId;
      
      console.log('üîç –û—Ç–ª–∞–¥–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞:');
      console.log('- –î–∞–Ω–Ω—ã–µ —è—á–µ–π–∫–∏:', scannedCellData);
      console.log('- –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–∫–ª–∞–¥—ã:', warehouses.map(w => ({id: w.id, name: w.name, warehouse_number: w.warehouse_number})));
      
      if (scannedCellData.format === 'compact-new' || scannedCellData.format === 'compact-old' || scannedCellData.format === 'compact') {
        // –î–ª—è –≤—Å–µ—Ö –∫–æ–º–ø–∞–∫—Ç–Ω—ã—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—ã–π warehouse_id
        warehouseId = scannedCellData.warehouse_id;
        const formatType = scannedCellData.format === 'compact-new' ? '–ù–û–í–´–ô (9 —Ü–∏—Ñ—Ä)' : '–°–¢–ê–†–´–ô (8 —Ü–∏—Ñ—Ä)';
        console.log(`‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º ${formatType} –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç - —Å–∫–ª–∞–¥: ${scannedCellData.warehouse_name} (ID: ${warehouseId})`);
      } else if (scannedCellData.format === 'simple') {
        // –î–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞ —É–∂–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω warehouse_id –≤ parseCellQRCode
        warehouseId = scannedCellData.warehouse_id;
        console.log(`‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º warehouse_id –¥–ª—è –ø—Ä–æ—Å—Ç–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞: ${warehouseId}`);
      } else {
        // –î–ª—è –¥—Ä—É–≥–∏—Ö —Ñ–æ—Ä–º–∞—Ç–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π warehouse_id
        warehouseId = scannedCellData.warehouse_id;
        console.log(`‚úÖ –ò—Å–ø–æ–ª—å–∑—É–µ–º warehouse_id –∏–∑ –¥–∞–Ω–Ω—ã—Ö —è—á–µ–π–∫–∏ (${scannedCellData.format}): ${warehouseId}`);
      }
      
      if (!warehouseId) {
        showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–∫–ª–∞–¥ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞', 'error');
        return;
      }
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ 1: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π API –¥–ª—è Individual Units
      console.log('üéØ –†–ê–ó–ú–ï–©–ï–ù–ò–ï INDIVIDUAL UNIT');
      console.log('- Individual Number:', scannedCargoData.individual_number);
      console.log('- Warehouse ID:', warehouseId);
      console.log('- Block Number:', scannedCellData.block_number);
      console.log('- Shelf Number:', scannedCellData.shelf_number);
      console.log('- Cell Number:', scannedCellData.cell_number);

      // –≠–¢–ê–ü 4: –î–ï–¢–ê–õ–¨–ù–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –†–ê–ó–ú–ï–©–ï–ù–ò–ò
      const placementDetails = {
        cargo_name: scannedCargoData.cargo_name || scannedCargoData.items?.[0]?.name || '–ì—Ä—É–∑ –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è',
        application_number: scannedCargoData.request_number || scannedCargoData.cargo_number,
        location_name: scannedCellData.readable_name || `–ë${scannedCellData.block_number}-–ü${scannedCellData.shelf_number}-–Ø${scannedCellData.cell_number}`,
        warehouse_name: scannedCellData.warehouse_name || `–°–∫–ª–∞–¥ ‚Ññ${scannedCellData.warehouse_number}`,
        operator_name: user?.full_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –æ–ø–µ—Ä–∞—Ç–æ—Ä',
        placement_time: new Date().toLocaleString('ru-RU', { 
          day: '2-digit', 
          month: '2-digit', 
          year: 'numeric',
          hour: '2-digit', 
          minute: '2-digit' 
        })
      };
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π API –¥–ª—è individual units
      const placementResponse = await apiCall('/api/operator/cargo/place-individual', 'POST', {
        individual_number: scannedCargoData.individual_number,
        // warehouse_id –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        block_number: scannedCellData.block_number,
        shelf_number: scannedCellData.shelf_number,
        cell_number: scannedCellData.cell_number
      });
      
      console.log('‚úÖ Individual unit —Ä–∞–∑–º–µ—â–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ:', placementResponse);
      
      // –≠–¢–ê–ü 4: –£–õ–£–ß–®–ï–ù–ù–û–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–ï –° –î–ï–¢–ê–õ–¨–ù–û–ô –ò–ù–§–û–†–ú–ê–¶–ò–ï–ô
      const detailMessage = `üéâ –ì–†–£–ó –£–°–ü–ï–®–ù–û –†–ê–ó–ú–ï–©–ï–ù!\n\n` +
                           `üì¶ –ì—Ä—É–∑: ${placementDetails.cargo_name}\n` +
                           `üìÑ –ó–∞—è–≤–∫–∞: ${placementDetails.application_number}\n` +
                           `üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: ${placementDetails.location_name}\n` +
                           `üè¢ –°–∫–ª–∞–¥: ${placementDetails.warehouse_name}\n` +
                           `üë§ –û–ø–µ—Ä–∞—Ç–æ—Ä: ${placementDetails.operator_name}\n` +
                           `‚è∞ –í—Ä–µ–º—è: ${placementDetails.placement_time}`;
      
      showAlert(detailMessage, 'success');
      
      // –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á–µ—Ç—á–∏–∫ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤ –≤ —Å–µ—Å—Å–∏–∏
      setSessionPlacedCount(prev => prev + 1);
      
      // –ù–û–í–û–ï: –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ä–∞–∑–º–µ—â–µ–Ω–Ω–æ–º –≥—Ä—É–∑–µ –≤ —Å–ø–∏—Å–æ–∫ —Å–µ—Å—Å–∏–∏
      const placedCargoInfo = {
        cargo_number: scannedCargoData.cargo_number,
        location: scannedCellData.readable_name || `–ë${scannedCellData.block_number}-–ü${scannedCellData.shelf_number}-–Ø${scannedCellData.cell_number}`,
        warehouse_name: scannedCellData.warehouse_name || `–°–∫–ª–∞–¥ ‚Ññ${scannedCellData.warehouse_number}`,
        placed_at: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
      };
      
      setSessionPlacedCargo(prev => [...prev, placedCargoInfo]);
      
      // –≠–¢–ê–ü 3: –ú–ì–ù–û–í–ï–ù–ù–û–ï –û–ë–ù–û–í–õ–ï–ù–ò–ï –ü–†–û–ì–†–ï–°–°–ê –ò –°–¢–ê–¢–ò–°–¢–ò–ö–ò
      await fetchPlacementProgress(); // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
      await fetchAvailableCargoForPlacement(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
      await fetchFullyPlacedCargo(fullyPlacedPage, fullyPlacedPerPage); // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö
      
      // –≠–¢–ê–ü 2: –ú–ì–ù–û–í–ï–ù–ù–û–ï –ü–†–û–î–û–õ–ñ–ï–ù–ò–ï –†–ê–ë–û–¢–´ (—É–±–∏—Ä–∞–µ–º –∑–∞–¥–µ—Ä–∂–∫–∏)
      const remainingCargo = availableCargoForPlacement.length;
      if (remainingCargo > 0) {
        console.log(`‚ö° –ú–ì–ù–û–í–ï–ù–ù–û –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É –≥—Ä—É–∑—É (–æ—Å—Ç–∞–ª–æ—Å—å: ${remainingCargo})`);
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        setScannedCargoData(null);
        setScannedCellData(null);
        setScannerError(null);
        setTargetWarehouseStats(null);
        
        // –ú–ì–ù–û–í–ï–ù–ù–´–ô –∑–∞–ø—É—Å–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –≥—Ä—É–∑–∞
        setScannerMode('cargo-barcode');
        setScannerActive(true);
        
        showAlert(`‚ö° –°–ª–µ–¥—É—é—â–∏–π –≥—Ä—É–∑ (–æ—Å—Ç–∞–ª–æ—Å—å: ${remainingCargo})`, 'info');
      } else {
        console.log('üéâ –í—Å–µ –≥—Ä—É–∑—ã —Ä–∞–∑–º–µ—â–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!');
        showAlert('üèÜ –í–°–ï –ì–†–£–ó–´ –†–ê–ó–ú–ï–©–ï–ù–´ –£–°–ü–ï–®–ù–û!\n–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞!', 'success');
        
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä –±–µ–∑ –∑–∞–¥–µ—Ä–∂–∫–∏
        resetScannerState();
      }
      
    } catch (error) {
      console.error('Auto placement error:', error);
      showAlert('–û—à–∏–±–∫–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞', 'error');
    } finally {
      setPlacementInProgress(false);
    }
  };

  const resetScannerState = async () => {
    setScannerMode('none');
    setScannerActive(false);
    setScannedCargoData(null);
    setScannedCellData(null);
    setScannerError(null);
    await stopCameraScanner();
  };

  // New functions for warehouse management
  const openWarehouseManagement = async (warehouse) => {
    try {
      setSelectedWarehouseForManagement(warehouse);
      setWarehouseManagementLoading(true);
      setShowWarehouseManagementModal(true);
      
      // Fetch detailed warehouse structure
      const response = await apiCall(`/api/warehouses/${warehouse.id}/structure`);
      setWarehouseStructure(response);
      
    } catch (error) {
      console.error('Error loading warehouse structure:', error);
      showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–∫–ª–∞–¥–∞: ${error.message}`, 'error');
    } finally {
      setWarehouseManagementLoading(false);
    }
  };

  // Generate QR codes for selected cells
  const generateCellQRCodes = async (selectedCells = null) => {
    if (!selectedWarehouseForManagement || !warehouseStructure) return;
    
    setCellQRLoading(true);
    try {
      const cellsToProcess = selectedCells || getAllCells();
      const qrResults = [];
      
      for (const cell of cellsToProcess) {
        try {
          const response = await apiCall('/api/warehouse/cell/generate-qr', 'POST', {
            warehouse_id: selectedWarehouseForManagement.id,
            block: cell.block,
            shelf: cell.shelf,
            cell: cell.cell,
            format: 'id' // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π ID —Ñ–æ—Ä–º–∞—Ç —Å —É–Ω–∏–∫–∞–ª—å–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏ —Å–∫–ª–∞–¥–æ–≤
          });
          
          if (response && response.success) {
            qrResults.push({
              location: `–ë${cell.block}-–ü${cell.shelf}-–Ø${cell.cell}`,
              qr_code: response.qr_code,
              success: true
            });
          } else {
            qrResults.push({
              location: `–ë${cell.block}-–ü${cell.shelf}-–Ø${cell.cell}`,
              success: false,
              error: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å QR –∫–æ–¥'
            });
          }
        } catch (error) {
          qrResults.push({
            location: `–ë${cell.block}-–ü${cell.shelf}-–Ø${cell.cell}`,
            success: false,
            error: error.message
          });
        }
      }
      
      setCellQRResults(qrResults);
      showAlert(`–°–æ–∑–¥–∞–Ω–æ QR –∫–æ–¥–æ–≤ –¥–ª—è —è—á–µ–µ–∫: ${qrResults.filter(r => r.success).length}/${qrResults.length}`, 'success');
      
    } catch (error) {
      console.error('Error generating cell QR codes:', error);
      showAlert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è QR –∫–æ–¥–æ–≤: ${error.message}`, 'error');
    } finally {
      setCellQRLoading(false);
    }
  };

  // Get all cells from warehouse structure
  const getAllCells = () => {
    if (!warehouseStructure) return [];
    
    const allCells = [];
    for (let block = 1; block <= warehouseStructure.blocks; block++) {
      for (let shelf = 1; shelf <= warehouseStructure.shelves_per_block; shelf++) {
        for (let cell = 1; cell <= warehouseStructure.cells_per_shelf; cell++) {
          allCells.push({ block, shelf, cell });
        }
      }
    }
    return allCells;
  };

  // Add new block to warehouse
  const addWarehouseBlock = async () => {
    try {
      const response = await apiCall(`/api/warehouses/${selectedWarehouseForManagement.id}/add-block`, 'POST');
      
      if (response && response.success) {
        showAlert('–ë–ª–æ–∫ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω', 'success');
        // Refresh warehouse structure
        openWarehouseManagement(selectedWarehouseForManagement);
      }
    } catch (error) {
      console.error('Error adding block:', error);
      showAlert(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –±–ª–æ–∫–∞: ${error.message}`, 'error');
    }
  };

  // Delete warehouse block
  const deleteWarehouseBlock = async (blockNumber) => {
    try {
      const response = await apiCall(`/api/warehouses/${selectedWarehouseForManagement.id}/delete-block`, 'POST', {
        block_number: blockNumber
      });
      
      if (response && response.success) {
        showAlert('–ë–ª–æ–∫ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω', 'success');
        // Refresh warehouse structure
        openWarehouseManagement(selectedWarehouseForManagement);
      }
    } catch (error) {
      console.error('Error deleting block:', error);
      showAlert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –±–ª–æ–∫–∞: ${error.message}`, 'error');
    }
  };

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ì–û–†–û–î–ê–ú–ò –°–ö–õ–ê–î–û–í
  
  // –û—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞–º–∏ —Å–∫–ª–∞–¥–∞
  const openWarehouseCitiesManagement = async (warehouse) => {
    try {
      setSelectedWarehouseForCities(warehouse);
      setCitiesLoading(true);
      setShowWarehouseCitiesModal(true);
      
      // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–µ–∫—É—â–∏–π —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤
      const response = await apiCall(`/api/warehouses/${warehouse.id}/cities`);
      setWarehouseCities(response.cities || []);
      
    } catch (error) {
      console.error('Error loading warehouse cities:', error);
      showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤ —Å–∫–ª–∞–¥–∞: ${error.message}`, 'error');
    } finally {
      setCitiesLoading(false);
    }
  };

  // –î–æ–±–∞–≤–∏—Ç—å –æ–¥–∏–Ω –≥–æ—Ä–æ–¥ –∫ —Å–∫–ª–∞–¥—É
  const addWarehouseCity = async () => {
    if (!newCityName.trim()) {
      showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞', 'warning');
      return;
    }

    try {
      setCitiesLoading(true);
      
      const response = await apiCall(
        `/api/warehouses/${selectedWarehouseForCities.id}/cities`,
        'POST',
        { city_name: newCityName.trim() }
      );
      
      if (response && response.message) {
        showAlert(response.message, 'success');
        setNewCityName(''); // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤
        const updatedResponse = await apiCall(`/api/warehouses/${selectedWarehouseForCities.id}/cities`);
        setWarehouseCities(updatedResponse.cities || []);
      }
    } catch (error) {
      console.error('Error adding city to warehouse:', error);
      showAlert(`–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞: ${error.message}`, 'error');
    } finally {
      setCitiesLoading(false);
    }
  };

  // –ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤ –∫ —Å–∫–ª–∞–¥—É
  const addWarehouseCitiesBulk = async () => {
    const citiesText = bulkCitiesText.trim();
    if (!citiesText) {
      showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤', 'warning');
      return;
    }

    // –†–∞–∑–±–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç –Ω–∞ –æ—Ç–¥–µ–ª—å–Ω—ã–µ –≥–æ—Ä–æ–¥–∞ (–ø–æ –∑–∞–ø—è—Ç—ã–º, —Ç–æ—á–∫–∞–º —Å –∑–∞–ø—è—Ç–æ–π –∏–ª–∏ –Ω–æ–≤—ã–º —Å—Ç—Ä–æ–∫–∞–º)
    const cityNames = citiesText
      .split(/[,;\n]/)
      .map(city => city.trim())
      .filter(city => city.length > 0);

    if (cityNames.length === 0) {
      showAlert('–ù–µ –Ω–∞–π–¥–µ–Ω–æ –≤–∞–ª–∏–¥–Ω—ã—Ö –Ω–∞–∑–≤–∞–Ω–∏–π –≥–æ—Ä–æ–¥–æ–≤', 'warning');
      return;
    }

    try {
      setCitiesLoading(true);
      
      const response = await apiCall(
        `/api/warehouses/${selectedWarehouseForCities.id}/cities/bulk`,
        'POST',
        { city_names: cityNames }
      );
      
      if (response && response.message) {
        const summary = `${response.message}. –î–æ–±–∞–≤–ª–µ–Ω–æ: ${response.added_count}, –ø—Ä–æ–ø—É—â–µ–Ω–æ: ${response.skipped_count}`;
        showAlert(summary, 'success');
        setBulkCitiesText(''); // –û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤
        const updatedResponse = await apiCall(`/api/warehouses/${selectedWarehouseForCities.id}/cities`);
        setWarehouseCities(updatedResponse.cities || []);
      }
    } catch (error) {
      console.error('Error bulk adding cities to warehouse:', error);
      showAlert(`–û—à–∏–±–∫–∞ –º–∞—Å—Å–æ–≤–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤: ${error.message}`, 'error');
    } finally {
      setCitiesLoading(false);
    }
  };

  // –£–¥–∞–ª–∏—Ç—å –≥–æ—Ä–æ–¥ –∏–∑ —Å–∫–ª–∞–¥–∞
  const removeWarehouseCity = async (cityName) => {
    const confirmDelete = window.confirm(
      `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥–æ—Ä–æ–¥ "${cityName}" –∏–∑ —Å–ø–∏—Å–∫–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ —ç—Ç–æ–≥–æ —Å–∫–ª–∞–¥–∞?`
    );
    
    if (!confirmDelete) return;

    try {
      setCitiesLoading(true);
      
      const response = await apiCall(
        `/api/warehouses/${selectedWarehouseForCities.id}/cities`,
        'DELETE',
        { city_name: cityName }
      );
      
      if (response && response.message) {
        showAlert(response.message, 'success');
        
        // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≥–æ—Ä–æ–¥–æ–≤
        const updatedResponse = await apiCall(`/api/warehouses/${selectedWarehouseForCities.id}/cities`);
        setWarehouseCities(updatedResponse.cities || []);
      }
    } catch (error) {
      console.error('Error removing city from warehouse:', error);
      showAlert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞: ${error.message}`, 'error');
    } finally {
      setCitiesLoading(false);
    }
  };

  // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥–æ—Ä–æ–¥–∞–º–∏
  const closeWarehouseCitiesModal = () => {
    setShowWarehouseCitiesModal(false);
    setSelectedWarehouseForCities(null);
    setWarehouseCities([]);
    setNewCityName('');
    setBulkCitiesText('');
  };

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –§–û–†–ú–û–ô –ü–†–ò–Å–ú–ê –ì–†–£–ó–ê
  
  // –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤—Å–µ –≥–æ—Ä–æ–¥–∞ –∏–∑ –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤
  const fetchAllWarehouseCities = async () => {
    try {
      setAllCitiesLoading(true);
      const response = await apiCall('/api/warehouses/all-cities');
      setAllWarehouseCities(response.cities || []);
    } catch (error) {
      console.error('Error fetching all warehouse cities:', error);
      showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≥–æ—Ä–æ–¥–æ–≤: ${error.message}`, 'error');
    } finally {
      setAllCitiesLoading(false);
    }
  };

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
  const handleDeliveryCityChange = (cityName) => {
    setSelectedDeliveryCity(cityName);
    setCitySearchQuery(cityName);
    setSelectedDeliveryWarehouse(''); // –û—á–∏—â–∞–µ–º –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∫–ª–∞–¥
    setShowCityDropdown(false);
    
    // –ù–∞—Ö–æ–¥–∏–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —Å–∫–ª–∞–¥—ã –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞
    const cityData = allWarehouseCities.find(city => city.city_name === cityName);
    if (cityData && cityData.available_warehouses.length > 0) {
      setAvailableWarehousesForCity(cityData.available_warehouses);
      
      // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π —Å–∫–ª–∞–¥
      const firstWarehouse = cityData.available_warehouses[0];
      setSelectedDeliveryWarehouse(firstWarehouse.warehouse_id);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º operatorCargoForm
      setOperatorCargoForm(prev => ({
        ...prev,
        destination_warehouse_id: firstWarehouse.warehouse_id,
        destination_warehouse_name: firstWarehouse.warehouse_name,
        delivery_city: cityName
      }));
      
      console.log(`‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω —Å–∫–ª–∞–¥: ${firstWarehouse.warehouse_name} –¥–ª—è –≥–æ—Ä–æ–¥–∞ ${cityName}`);
    } else {
      setAvailableWarehousesForCity([]);
      console.log(`‚ö†Ô∏è –ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤ –¥–ª—è –≥–æ—Ä–æ–¥–∞ ${cityName}`);
    }
  };

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤ (–∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ)
  const handleCitySearchChange = (query) => {
    setCitySearchQuery(query);
    
    if (query.length === 0) {
      setFilteredCities([]);
      setShowCityDropdown(false);
      setSelectedDeliveryCity('');
      setSelectedDeliveryWarehouse('');
      setAvailableWarehousesForCity([]);
      return;
    }
    
    // –§–∏–ª—å—Ç—Ä—É–µ–º –≥–æ—Ä–æ–¥–∞ –ø–æ –≤–≤–µ–¥–µ–Ω–Ω–æ–º—É —Ç–µ–∫—Å—Ç—É
    const filtered = allWarehouseCities.filter(cityData => 
      cityData.city_name.toLowerCase().includes(query.toLowerCase())
    );
    
    setFilteredCities(filtered);
    setShowCityDropdown(filtered.length > 0);
    
    // –ï—Å–ª–∏ —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ –Ω–∞–π–¥–µ–Ω–æ, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±–∏—Ä–∞–µ–º –≥–æ—Ä–æ–¥
    const exactMatch = allWarehouseCities.find(cityData => 
      cityData.city_name.toLowerCase() === query.toLowerCase()
    );
    
    if (exactMatch) {
      setSelectedDeliveryCity(exactMatch.city_name);
      setAvailableWarehousesForCity(exactMatch.available_warehouses || []);
    } else {
      setSelectedDeliveryCity('');
      setAvailableWarehousesForCity([]);
    }
  };

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–∫–ª–∞–¥–∞ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏
  const handleDeliveryWarehouseChange = (warehouseId) => {
    setSelectedDeliveryWarehouse(warehouseId);
    
    // –û–±–Ω–æ–≤–ª—è–µ–º operatorCargoForm
    const warehouseInfo = availableWarehousesForCity.find(w => w.warehouse_id === warehouseId);
    if (warehouseInfo) {
      setOperatorCargoForm(prev => ({
        ...prev,
        destination_warehouse_id: warehouseId,
        destination_warehouse_name: warehouseInfo.warehouse_name,
        delivery_city: selectedDeliveryCity
      }));
    }
  };

  // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –∫–∞–º–µ—Ä –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞ - —É–ª—É—á—à–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
  useEffect(() => {
    return () => {
      // –û—á–∏—â–∞–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–∫–∞–Ω–µ—Ä
      if (html5QrCode) {
        safeStopQrScanner(html5QrCode, "qr-reader", "Main Scanner").catch(console.error);
      }
      
      // –û—á–∏—â–∞–µ–º —Å–∫–∞–Ω–µ—Ä —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
      if (html5QrCodePlacement) {
        safeStopQrScanner(html5QrCodePlacement, "qr-reader-placement", "Placement Scanner").catch(console.error);
      }
      
      // –û—á–∏—â–∞–µ–º –º–æ–¥–∞–ª—å–Ω—ã–π —Å–∫–∞–Ω–µ—Ä
      if (modalScannerRef.current) {
        safeStopQrScanner(modalScannerRef.current, "qr-reader-modal", "Modal Scanner").catch(console.error);
      }
    };
  }, [html5QrCode, html5QrCodePlacement]);

  const simulateBarcodeScan = (testData) => {
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –±–µ–∑ —Ä–µ–∞–ª—å–Ω–æ–π –∫–∞–º–µ—Ä—ã
    handleBarcodeScan(testData);
  };

  const apiCall = async (endpoint, method = 'GET', data = null, params = null, retryCount = 0) => {
    try {
      // Build URL with query parameters if provided
      let url = `${BACKEND_URL}${endpoint}`;
      
      // DEBUG: –õ–æ–≥–∏—Ä—É–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –∑–Ω–∞—á–µ–Ω–∏—è
      console.log('üîç API DEBUG: BACKEND_URL =', BACKEND_URL);
      console.log('üîç API DEBUG: endpoint =', endpoint);
      console.log('üîç API DEBUG: final url =', url);
      
      if (params) {
        const urlParams = new URLSearchParams(params);
        url += `?${urlParams.toString()}`;
      }

      const config = {
        method,
        headers: {
          'Content-Type': 'application/json',
        },
      };

      if (token) {
        config.headers.Authorization = `Bearer ${token}`;
      }

      if (data) {
        config.body = JSON.stringify(data);
      }

      const response = await fetch(url, config);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –∫–æ–Ω—Ç–µ–Ω—Ç –¥–ª—è –ø–∞—Ä—Å–∏–Ω–≥–∞
      const contentType = response.headers.get('content-type');
      let result = {};
      
      if (contentType && contentType.includes('application/json')) {
        const responseText = await response.text();
        if (responseText.trim()) {
          try {
            result = JSON.parse(responseText);
          } catch (jsonError) {
            console.error('JSON parsing error:', jsonError);
            console.error('Response text:', responseText);
            result = { error: 'Invalid JSON response', rawResponse: responseText };
          }
        }
      } else {
        // –ï—Å–ª–∏ –Ω–µ JSON, —á–∏—Ç–∞–µ–º –∫–∞–∫ —Ç–µ–∫—Å—Ç
        const responseText = await response.text();
        result = { message: responseText || 'Empty response' };
      }

      if (!response.ok) {
        // –°–ù–ê–ß–ê–õ–ê –ø—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (401 —Å error_type)
        if (response.status === 401 && result.detail && typeof result.detail === 'object' && result.detail.error_type) {
          console.log('üîç Detected structured auth error:', result.detail.error_type);
          // –°–æ–∑–¥–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –æ—à–∏–±–∫—É –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
          const enhancedError = new Error(result.detail.message || result.detail.status_message || 'Authentication error');
          enhancedError.status = response.status;
          enhancedError.detail = result.detail;
          enhancedError.response = result;
          throw enhancedError;
        }
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ 401 –æ—à–∏–±–∫–∏ (unauthorized) - —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω (—Ç–æ–ª—å–∫–æ –¥–ª—è –ù–ï—Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫)
        if (response.status === 401 && !isLoggingOut && !isLoggingIn) {
          console.log('Received 401 response, checking if logout is needed');
          
          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –ª–∏ —Ç–æ–∫–µ–Ω –∏—Å—Ç–µ–∫ –ø–µ—Ä–µ–¥ logout
          if (token && !isTokenValid(token)) {
            console.log('Token expired, initiating logout after delay');
            // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –ø–µ—Ä–µ–¥ logout –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è race conditions
            setTimeout(() => {
              if (!isLoggingOut && !isLoggingIn) {
                handleLogout();
              }
            }, 5000); // –£–≤–µ–ª–∏—á–∏–ª–∏ –∑–∞–¥–µ—Ä–∂–∫—É —Å 2s –¥–æ 5s –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
          } else {
            console.log('Token still valid, 401 might be temporary - retrying after delay');
            // –ï—Å–ª–∏ —Ç–æ–∫–µ–Ω –≤–∞–ª–∏–¥–µ–Ω, –≤–æ–∑–º–æ–∂–Ω–æ —ç—Ç–æ –≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ - –ø–æ–≤—Ç–æ—Ä—è–µ–º –∑–∞–ø—Ä–æ—Å —á–µ—Ä–µ–∑ 2 —Å–µ–∫—É–Ω–¥—ã
            await new Promise(resolve => setTimeout(resolve, 2000));
            // –ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–ø—Ä–æ—Å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —Ä–∞–∑
            if (retryCount === 0) {
              console.log('Retrying API call after 401 with valid token');
              return apiCall(endpoint, method, data, params, retryCount + 1);
            }
          }
          
          throw new Error('Unauthorized access');
        }
        
        // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ detail - –º–æ–∂–µ—Ç –±—ã—Ç—å —Å—Ç—Ä–æ–∫–æ–π, –æ–±—ä–µ–∫—Ç–æ–º –∏–ª–∏ –º–∞—Å—Å–∏–≤–æ–º
        let errorMessage = '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞';
        let errorDetails = null;
        
        if (result.detail) {
          if (Array.isArray(result.detail)) {
            // –ï—Å–ª–∏ detail - –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ –æ—à–∏–±–æ–∫ –≤–∞–ª–∏–¥–∞—Ü–∏–∏, –∏–∑–≤–ª–µ–∫–∞–µ–º msg –∏–∑ –∫–∞–∂–¥–æ–≥–æ
            errorMessage = result.detail.map(err => err.msg || err.message || JSON.stringify(err)).join(', ');
          } else if (typeof result.detail === 'string') {
            // –ï—Å–ª–∏ detail - —Å—Ç—Ä–æ–∫–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∫–∞–∫ –µ—Å—Ç—å
            errorMessage = result.detail;
          } else {
            // –ï—Å–ª–∏ detail - –æ–±—ä–µ–∫—Ç (–Ω–æ–≤—ã–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏), —Å–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É
            errorDetails = result.detail;
            errorMessage = result.detail.message || result.detail.status_message || JSON.stringify(result.detail);
          }
        } else if (result.message) {
          errorMessage = result.message;
        }
        
        // –°–æ–∑–¥–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—É—é –æ—à–∏–±–∫—É —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–º–∏ –¥–µ—Ç–∞–ª—è–º–∏
        const enhancedError = new Error(errorMessage);
        enhancedError.status = response.status;
        enhancedError.detail = errorDetails || result.detail;
        enhancedError.response = result;
        
        throw enhancedError;
      }

      return result;
    } catch (error) {
      // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º alert –¥–ª—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –æ–Ω–∏ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞—é—Ç—Å—è –º–æ–¥–∞–ª—å–Ω—ã–º–∏ –æ–∫–Ω–∞–º–∏
      const isAuthError = error.status === 401 || error.status === 403;
      const hasStructuredError = error.detail && typeof error.detail === 'object' && error.detail.error_type;
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º alert —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ –æ—à–∏–±–∫–∞ –∏—Å—Ç–µ—á–µ–Ω–∏—è —Å–µ—Å—Å–∏–∏ –∏ –Ω–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
      if (error.message !== 'Session expired' && !(isAuthError && hasStructuredError)) {
        showAlert(error.message, 'error');
      }
      throw error;
    }
  };

  // –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞ (–§—É–Ω–∫—Ü–∏—è 1)
  const fetchClientDashboard = async () => {
    try {
      const data = await apiCall('/api/client/dashboard');
      setClientDashboard(data);
    } catch (error) {
      console.error('Error fetching client dashboard:', error);
    }
  };

  const fetchClientCargo = async (status = null) => {
    try {
      const params = status ? `?status=${status}` : '';
      const data = await apiCall(`/api/client/cargo${params}`);
      setClientCargo(data.cargo || []);
    } catch (error) {
      console.error('Error fetching client cargo:', error);
    }
  };

  const fetchClientCargoDetails = async (cargoId) => {
    try {
      const data = await apiCall(`/api/client/cargo/${cargoId}/details`);
      setClientCargoDetails(data);
    } catch (error) {
      console.error('Error fetching client cargo details:', error);
    }
  };

  // –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ (–§—É–Ω–∫—Ü–∏—è 2)
  const fetchAllOperators = async () => {
    try {
      const data = await apiCall('/api/admin/operators');
      setAllOperators(data.operators || []);
    } catch (error) {
      console.error('Error fetching operators:', error);
    }
  };

  const handleCreateOperator = async (e) => {
    e.preventDefault();
    
    // –û–¢–õ–ê–î–ö–ê: –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã –ø–µ—Ä–µ–¥ –æ—Ç–ø—Ä–∞–≤–∫–æ–π
    console.log('üîß –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ - –¥–∞–Ω–Ω—ã–µ —Ñ–æ—Ä–º—ã:', operatorCreateForm);
    console.log('üîß –°–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤:', warehouses?.length || 0, warehouses);
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –≤—ã–±—Ä–∞–Ω —Å–∫–ª–∞–¥
    if (!operatorCreateForm.warehouse_id) {
      showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞', 'error');
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–∫–ª–∞–¥ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Å–ø–∏—Å–∫–µ
    const selectedWarehouse = warehouses.find(w => w.id === operatorCreateForm.warehouse_id);
    if (!selectedWarehouse) {
      showAlert('–í—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∫–ª–∞–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤', 'error');
      console.error('üîß –°–∫–ª–∞–¥ –Ω–µ –Ω–∞–π–¥–µ–Ω:', operatorCreateForm.warehouse_id, '–≤ —Å–ø–∏—Å–∫–µ:', warehouses);
      return;
    }
    
    try {
      console.log('üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:', operatorCreateForm);
      const response = await apiCall('/api/admin/create-operator', 'POST', operatorCreateForm);
      console.log('‚úÖ –û—Ç–≤–µ—Ç —Å–µ—Ä–≤–µ—Ä–∞:', response);
      
      // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
      setOperatorCreateForm({
        full_name: '',
        phone: '',
        address: '',
        password: '',
        warehouse_id: ''
      });
      
      // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
      fetchAllOperators();
      fetchOperatorWarehouseBindings();
      fetchUsersByRole();
      
      // –ü–æ–∫–∞–∑–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
      showAlert('–û–ø–µ—Ä–∞—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 'success');
      
    } catch (error) {
      console.error('‚ùå Error creating operator:', error);
      showAlert(error.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞', 'error');
    }
  };

  // –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≥—Ä—É–∑–∞
  const fetchDeliveryOptions = async () => {
    try {
      const data = await apiCall('/api/client/cargo/delivery-options');
      setDeliveryOptions(data);
    } catch (error) {
      console.error('Error fetching delivery options:', error);
    }
  };

  const calculateCargoCost = async () => {
    if (!cargoOrderForm.weight || !cargoOrderForm.declared_value || !cargoOrderForm.cargo_name) {
      return;
    }

    setIsCalculating(true);
    try {
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
      const calculationData = {
        ...cargoOrderForm,
        weight: parseFloat(cargoOrderForm.weight),
        declared_value: parseFloat(cargoOrderForm.declared_value),
        insurance_value: cargoOrderForm.insurance_requested ? parseFloat(cargoOrderForm.insurance_value || cargoOrderForm.declared_value) : null
      };

      const data = await apiCall('/api/client/cargo/calculate', 'POST', calculationData);
      setCostCalculation(data);
    } catch (error) {
      console.error('Error calculating cost:', error);
      alert('–û—à–∏–±–∫–∞ —Ä–∞—Å—á–µ—Ç–∞ —Å—Ç–æ–∏–º–æ—Å—Ç–∏: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'));
    } finally {
      setIsCalculating(false);
    }
  };

  const handleCreateCargoOrder = async (e) => {
    e.preventDefault();
    
    if (!costCalculation) {
      showAlert('–°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏', 'error');
      return;
    }

    try {
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–∑–∞
      const orderData = {
        ...cargoOrderForm,
        weight: parseFloat(cargoOrderForm.weight),
        declared_value: parseFloat(cargoOrderForm.declared_value),
        insurance_value: cargoOrderForm.insurance_requested ? parseFloat(cargoOrderForm.insurance_value || cargoOrderForm.declared_value) : null
      };

      const result = await apiCall('/api/client/cargo/create', 'POST', orderData);
      setCargoOrderResult(result);
      
      // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
      setCargoOrderForm({
        cargo_name: '',
        description: '',
        weight: '',
        declared_value: getDefaultDeclaredValue('moscow_dushanbe'), // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        recipient_full_name: '',
        recipient_phone: '',
        recipient_address: '',
        recipient_city: '',
        route: 'moscow_dushanbe',
        delivery_type: 'standard',
        insurance_requested: false,
        insurance_value: '',
        packaging_service: false,
        home_pickup: false,
        home_delivery: false,
        fragile: false,
        temperature_sensitive: false,
        special_instructions: ''
      });
      setCostCalculation(null);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
      fetchClientDashboard();
      fetchClientCargo();
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—à–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
      showAlert(`–ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω! –ù–æ–º–µ—Ä: ${result.cargo_number}, –¢—Ä–µ–∫–∏–Ω–≥: ${result.tracking_code}`, 'success');
      
    } catch (error) {
      console.error('Error creating cargo order:', error);
      
      // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
      let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–∏ –≥—Ä—É–∑–∞';
      
      if (error.message) {
        errorMessage = error.message;
      } else if (typeof error === 'string') {
        errorMessage = error;
      } else if (error.detail) {
        errorMessage = error.detail;
      }
      
      showAlert('–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≥—Ä—É–∑–∞: ' + errorMessage, 'error');
    }
  };

  useEffect(() => {
    console.log('üîÑ App initialization useEffect triggered');
    
    if (token && !isLoggingOut && !isLoggingIn) {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–∞–ª–∏–¥–Ω–æ—Å—Ç—å —Ç–æ–∫–µ–Ω–∞ –ø–µ—Ä–µ–¥ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º
      if (isTokenValid(token)) {
        console.log('‚úÖ Valid token found, initializing app...');
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
        setIsInitializing(true);
        setDataLoaded(false);
        
        // –û—á–∏—â–∞–µ–º —Å—Ç–∞—Ä—ã–µ –¥–∞–Ω–Ω—ã–µ —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–æ–∫–∞–∑–∞ —É—Å—Ç–∞—Ä–µ–≤—à–µ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
        clearAllAppData();
        
        // –ü–æ–ø—ã—Ç–∫–∞ –ø–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ —É –Ω–∞—Å –Ω–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        if (!user) {
          console.log('üë§ No user data, fetching user info...');
          // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å race condition
          setTimeout(() => {
            if (token && !isLoggingIn && !user && !isLoggingOut) {
              fetchUserData().then(() => {
                console.log('‚úÖ User data loaded, initialization complete');
                setIsInitializing(false);
              }).catch(error => {
                console.error('‚ùå Error loading user data:', error);
                setIsInitializing(false);
                handleLogout();
              });
            }
          }, 100);
        } else {
          console.log('üë§ User data already available, skipping fetch');
          setIsInitializing(false);
        }
      } else {
        // –¢–æ–∫–µ–Ω –∏—Å—Ç–µ–∫, –æ—á–∏—â–∞–µ–º –µ–≥–æ
        console.log('‚ùå Token expired on startup, clearing session');
        setIsInitializing(false);
        clearAllAppData();
        handleLogout();
        showAlert('–í–∞—à–∞ —Å–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É —Å–Ω–æ–≤–∞.', 'warning');
      }
    } else if (!token) {
      console.log('üö´ No token found, showing login screen');
      setIsInitializing(false);
      setDataLoaded(false);
      clearAllAppData();
    }
  }, [token]); // –£–±–∏—Ä–∞–µ–º user –∏–∑ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å —Ü–∏–∫–ª–∞

  // useEffect –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  useEffect(() => {
    if (showCargoPlacementModal && !externalScannerActive) {
      console.log('üñ•Ô∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞...');
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout –¥–ª—è –æ–±–µ—Å–ø–µ—á–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
      setTimeout(() => {
        startExternalScannerPlacement();
      }, 100);
    }
    
    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
    if (!showCargoPlacementModal && externalScannerActive) {
      console.log('üõë –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞...');
      stopExternalScannerPlacement();
    }
  }, [showCargoPlacementModal]);

  // –ü–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞ - —É–≤–µ–ª–∏—á–∏–º –∏–Ω—Ç–µ—Ä–≤–∞–ª
  useEffect(() => {
    let interval;
    if (token && user && !isLoggingOut && !isLoggingIn) {
      interval = setInterval(() => {
        if (!isTokenValid(token)) {
          console.log('Token expired during session, logging out');
          handleLogout();
        }
      }, 300000); // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç –≤–º–µ—Å—Ç–æ –∫–∞–∂–¥–æ–π –º–∏–Ω—É—Ç—ã
    }

    return () => {
      if (interval) {
        clearInterval(interval);
      }
    };
  }, [token, user, isLoggingOut, isLoggingIn]);

  // –ù–û–í–´–ô USEEFFECT: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –≤—ã–±–æ—Ä —Å–∫–ª–∞–¥–∞ –µ—Å–ª–∏ –æ–Ω –æ–¥–∏–Ω —É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
  useEffect(() => {
    if (operatorWarehouses.length === 1 && user?.role === 'warehouse_operator') {
      setOperatorCargoForm(prev => ({
        ...prev,
        warehouse_id: operatorWarehouses[0].id
      }));
    }
  }, [operatorWarehouses, user]);

  // –ù–û–í–´–ô USEEFFECT: –ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–ª–∞–¥–æ–≤ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É
  useEffect(() => {
    const loadRouteWarehouses = async () => {
      if (operatorCargoForm.route && user) {
        const warehouses = await fetchWarehousesByRoute(operatorCargoForm.route);
        setRouteWarehouses(warehouses);
        
        // –°–±—Ä–æ—Å –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ —Å–∫–ª–∞–¥–∞ –ø—Ä–∏ —Å–º–µ–Ω–µ –º–∞—Ä—à—Ä—É—Ç–∞
        if (operatorCargoForm.warehouse_id && !warehouses.find(w => w.id === operatorCargoForm.warehouse_id)) {
          setOperatorCargoForm(prev => ({
            ...prev,
            warehouse_id: ''
          }));
        }
      }
    };
    
    loadRouteWarehouses();
  }, [operatorCargoForm.route, user]);

  // –ù–û–í–´–ô USEEFFECT: –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ö–µ–º—ã —Å–∫–ª–∞–¥–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
  useEffect(() => {
    const loadWarehouseScheme = async () => {
      if (showWarehouseScheme) {
        setWarehouseSchemeLoading(true);
        try {
          // –î–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ–±—â–∏–π —Å–ø–∏—Å–æ–∫ warehouses, –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ - operatorWarehouses
          const warehousesList = user?.role === 'admin' ? warehouses : operatorWarehouses;
          const warehouse = warehousesList.find(w => w.id === showWarehouseScheme);
          
          if (warehouse && typeof warehouse === 'object') {
            console.log('Loading scheme for warehouse:', warehouse.name, warehouse);
            const scheme = await generateWarehouseScheme(warehouse);
            setWarehouseSchemeData(scheme || []);
          } else {
            console.warn('Warehouse not found for scheme:', showWarehouseScheme);
            setWarehouseSchemeData([]);
          }
        } catch (error) {
          console.error('Error loading warehouse scheme:', error);
          showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ö–µ–º—ã —Å–∫–ª–∞–¥–∞', 'error');
          setWarehouseSchemeData([]);
        } finally {
          setWarehouseSchemeLoading(false);
        }
      } else {
        setWarehouseSchemeData([]);
      }
    };

    loadWarehouseScheme();
  }, [showWarehouseScheme, operatorWarehouses, warehouses, user]);

  useEffect(() => {
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ token –∏ user –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è race condition
    if (user && token && !isLoggingOut && !isLoggingIn) {
      if (user.role === 'admin') {
        fetchNotifications();
        fetchUsers();
        fetchUsers();
        fetchAllCargo();
        fetchWarehouses();
        fetchOperatorCargo();
        fetchUsersByRole();
        fetchUnpaidCargo();
        fetchPaymentHistory();
        fetchCargoRequests();
        fetchTransports();
        fetchOperatorWarehouseBindings();
        fetchAllOperators(); // –§—É–Ω–∫—Ü–∏—è 2 - –∑–∞–≥—Ä—É–∑–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∞
        fetchCouriers(1, 25); // –ù–û–í–û–ï: –ó–∞–≥—Ä—É–∑–∫–∞ –∫—É—Ä—å–µ—Ä–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∞
        fetchNewOrdersCount(); // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤
        fetchPlacedCargo(); // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∞
        fetchDebtorsList(); // –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–æ–ª–∂–Ω–∏–∫–æ–≤
        fetchAdminDashboardAnalytics(); // –ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞
        fetchWarehouseNotifications(); // –ù–û–í–û–ï: –ó–∞–≥—Ä—É–∑–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–æ—Å—Ç—É–ø–∏–≤—à–∏—Ö –≥—Ä—É–∑–∞—Ö
        fetchAllPickupRequests(); // –ù–û–í–û–ï: –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∑–∞—è–≤–æ–∫ –Ω–∞ –∑–∞–±–æ—Ä
        fetchPickupRequestsHistory(); // –ù–û–í–û–ï: –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞—è–≤–æ–∫ –Ω–∞ –∑–∞–±–æ—Ä
        fetchPickupRequestsHistory(); // –ù–û–í–û–ï: –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞—è–≤–æ–∫ –Ω–∞ –∑–∞–±–æ—Ä
        fetchAllWarehouseCities(); // –ù–û–í–û–ï: –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è —Ñ–æ—Ä–º—ã –ø—Ä–∏—ë–º–∞ –≥—Ä—É–∑–∞
      } else if (user.role === 'warehouse_operator') {
        fetchNotifications();
        fetchWarehouseCargo();
        fetchWarehouses();
        fetchOperatorCargo('', 1, 25);
        fetchAvailableCargoForPlacement(1, 25); // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É –≥—Ä—É–∑–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
        fetchPlacedCargo(1, 25); // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥—Ä—É–∑–∫—É —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤
        fetchWarehouseNotifications(); // –ù–û–í–û–ï: –ó–∞–≥—Ä—É–∑–∫–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–æ—Å—Ç—É–ø–∏–≤—à–∏—Ö –≥—Ä—É–∑–∞—Ö
        fetchAllPickupRequests(); // –ù–û–í–û–ï: –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –∑–∞—è–≤–æ–∫ –Ω–∞ –∑–∞–±–æ—Ä
        fetchPickupRequestsHistory(); // –ù–û–í–û–ï: –ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞—è–≤–æ–∫ –Ω–∞ –∑–∞–±–æ—Ä
        fetchUnpaidCargo();
        fetchPaymentHistory();
        fetchCargoRequests();
        fetchTransportsList(); // –û–±–Ω–æ–≤–ª–µ–Ω–æ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
        fetchArrivedTransports();
        fetchOperatorWarehouses(); // –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
        fetchCouriers(1, 25); // –ù–û–í–û–ï: –û–ø–µ—Ä–∞—Ç–æ—Ä—ã —Ç–æ–∂–µ –º–æ–≥—É—Ç –≤–∏–¥–µ—Ç—å –∫—É—Ä—å–µ—Ä–æ–≤ —Å–≤–æ–∏—Ö —Å–∫–ª–∞–¥–æ–≤
        fetchNewOrdersCount(); // –ó–∞–≥—Ä—É–∑–∫–∞ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –Ω–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
        fetchOperatorDashboardAnalytics(); // –ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
        fetchAllWarehouseCities(); // –ù–û–í–û–ï: –ó–∞–≥—Ä—É–∑–∫–∞ –≤—Å–µ—Ö –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è —Ñ–æ—Ä–º—ã –ø—Ä–∏—ë–º–∞ –≥—Ä—É–∑–∞
      } else if (user.role === 'courier') {
        // –ò–°–ü–†–ê–í–õ–ï–ù–û: –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∫—É—Ä—å–µ—Ä–∞ –±–µ–∑ fetchNotifications
        console.log('üöõ –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–∞...');
        fetchCourierNewRequests(); // –ó–∞–≥—Ä—É–∑–∫–∞ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫
        fetchAcceptedRequests(); // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞—è–≤–æ–∫
        fetchPickedRequests(); // –ó–∞–≥—Ä—É–∑–∫–∞ –∑–∞–±—Ä–∞–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤
        fetchCancelledRequests(); // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫
      } else {
        fetchNotifications(); // –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –¥–ª—è –æ–±—ã—á–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
        fetchMyCargo();
        fetchMyRequests();
        fetchNotifications(); // –ù–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
        // –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–ª–∏–µ–Ω—Ç—Å–∫–æ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞ (–§—É–Ω–∫—Ü–∏—è 1)
        fetchClientDashboard();
        fetchClientCargo();
        // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ–ø—Ü–∏–∏ –¥–æ—Å—Ç–∞–≤–∫–∏ –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≥—Ä—É–∑–æ–≤
        fetchDeliveryOptions();
      }
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö
      setDataLoaded(true);
    }
  }, [user, token, isLoggingOut, isLoggingIn]); // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏

  // –ù–û–í–´–ô USEEFFECT: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å–µ–∫—Ü–∏—é –¥–ª—è –∫—É—Ä—å–µ—Ä–æ–≤
  useEffect(() => {
    if (user && user.role === 'courier' && activeSection === 'dashboard') {
      setActiveSection('courier-dashboard');
    }
  }, [user, activeSection]);

  // Effect –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É
  useEffect(() => {
    if (activeSection === 'couriers-tracking' && activeTab === 'couriers-inactive' && user?.role === 'admin') {
      fetchInactiveCouriers();
    }
  }, [activeSection, activeTab, user?.role]);

  // –ù–û–í–´–ô USEEFFECT: –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫—É—Ä—å–µ—Ä–æ–≤ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Ñ–∏–ª—å—Ç—Ä–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö
  useEffect(() => {
    if (user && (user.role === 'admin' || user.role === 'warehouse_operator')) {
      console.log(`üîÑ –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∫—É—Ä—å–µ—Ä–æ–≤ - –ø–æ–∫–∞–∑–∞—Ç—å –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö: ${showInactiveCouriers}`);
      fetchCouriers(couriersPage, couriersPerPage);
    }
  }, [showInactiveCouriers, user]);

  // –ù–û–í–´–ô USEEFFECT: –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –Ω–æ–º–µ—Ä–æ–≤ —Å–∫–ª–∞–¥–æ–≤ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∞–¥–º–∏–Ω–æ–≤
  useEffect(() => {
    if (user?.role === 'admin' && !warehouseNumbersUpdated) {
      ensureWarehouseNumbers();
      setWarehouseNumbersUpdated(true);
    }
  }, [user?.role]);

  // –ù–û–í–´–ô USEEFFECT: –°–∫—Ä—ã—Ç–∏–µ –≤—ã–ø–∞–¥–∞—é—â–µ–≥–æ —Å–ø–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤ –ø—Ä–∏ –∫–ª–∏–∫–µ –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏
  useEffect(() => {
    const handleClickOutside = (event) => {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–ª–∏–∫ –±—ã–ª –≤–Ω–µ –æ–±–ª–∞—Å—Ç–∏ –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤
      if (!event.target.closest('.city-autocomplete')) {
        setShowCityDropdown(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  // –ù–û–í–´–ô USEEFFECT: –û—á–∏—Å—Ç–∫–∞ QR —Å–∫–∞–Ω–µ—Ä–æ–≤ –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ –≤–∫–ª–∞–¥–æ–∫/—Å–µ–∫—Ü–∏–π
  useEffect(() => {
    console.log(`üîÑ –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ —Å–µ–∫—Ü–∏—é: ${activeSection}, –≤–∫–ª–∞–¥–∫–∞: ${activeTab}`);
    
    // –û—á–∏—â–∞–µ–º –≤—Å–µ QR —Å–∫–∞–Ω–µ—Ä—ã –ø—Ä–∏ –ª—é–±–æ–º –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
    cleanupAllQrScanners();
    
  }, [activeSection, activeTab]); // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å–µ–∫—Ü–∏–∏ –∏ –≤–∫–ª–∞–¥–∫–∏

  // –ù–û–í–´–ô USEEFFECT: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ individual units –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏ —Ä–µ–∂–∏–º–æ–≤
  useEffect(() => {
    // –ó–∞–≥—Ä—É–∂–∞–µ–º individual units –µ—Å–ª–∏ –≤–∫–ª—é—á–µ–Ω –Ω–æ–≤—ã–π —Ä–µ–∂–∏–º –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å - –æ–ø–µ—Ä–∞—Ç–æ—Ä —Å–∫–ª–∞–¥–∞
    if (useIndividualCards && user && user.role === 'warehouse_operator' && activeTab === 'cargo-placement') {
      console.log('üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ individual units...');
      fetchIndividualUnitsForPlacement(1, individualUnitsPerPage, cargoTypeFilter, placementStatusFilter);
    }
  }, [useIndividualCards, user, activeTab]); // –ó–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞, –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –∞–∫—Ç–∏–≤–Ω–æ–π –≤–∫–ª–∞–¥–∫–∏

  // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞
  const fetchPersonalDashboard = async () => {
    setDashboardLoading(true);
    try {
      const response = await apiCall('/api/user/dashboard', 'GET');
      setPersonalDashboardData(response);
    } catch (error) {
      console.error('Error fetching personal dashboard:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ª–∏—á–Ω–æ–≥–æ –∫–∞–±–∏–Ω–µ—Ç–∞', 'error');
    } finally {
      setDashboardLoading(false);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∞–¥–º–∏–Ω—Å–∫–æ–≥–æ –¥–∞—à–±–æ—Ä–¥–∞
  const fetchAdminDashboardAnalytics = async () => {
    if (user?.role !== 'admin') return;
    
    setAdminAnalyticsLoading(true);
    try {
      const response = await apiCall('/api/admin/dashboard/analytics', 'GET');
      setAdminDashboardAnalytics(response);
    } catch (error) {
      console.error('Error fetching admin dashboard analytics:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞', 'error');
    } finally {
      setAdminAnalyticsLoading(false);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
  const fetchOperatorDashboardAnalytics = async () => {
    if (!user || user.role !== 'warehouse_operator') return;
    
    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –Ω–æ–≤—ã—Ö
    setOperatorDashboardAnalytics(null);
    
    setOperatorAnalyticsLoading(true);
    try {
      console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –¥–∞—à–±–æ—Ä–¥–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞...');
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –î–æ–±–∞–≤–ª—è–µ–º timestamp –¥–ª—è –∏–∑–±–µ–∂–∞–Ω–∏—è –∫—ç—à–∏—Ä–æ–≤–∞–Ω–∏—è
      const timestamp = new Date().getTime();
      const response = await apiCall(`/api/operator/dashboard/analytics?_t=${timestamp}`);
      console.log('üìä –ü–æ–ª—É—á–µ–Ω–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞:', response);
      
      // –û–¢–õ–ê–î–ö–ê: –î–µ—Ç–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∫–∞–∂–¥–æ–≥–æ —Å–∫–ª–∞–¥–∞
      if (response?.warehouses_details) {
        response.warehouses_details.forEach((warehouse, index) => {
          console.log(`üè¢ –°–∫–ª–∞–¥ ${index + 1}: ${warehouse.warehouse_name}`);
          console.log('  üìà –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —è—á–µ–µ–∫:', {
            total: warehouse.warehouse_structure?.total_cells,
            occupied: warehouse.cargo_stats?.occupied_cells,
            free: warehouse.cargo_stats?.free_cells,
            occupancy_rate: warehouse.cargo_stats?.occupancy_rate
          });
          console.log('  üì¶ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—Ä—É–∑–æ–≤:', {
            total_cargo: warehouse.cargo_stats?.total_cargo,
            total_weight_kg: warehouse.cargo_stats?.total_weight_kg,
            total_value_rub: warehouse.cargo_stats?.total_value_rub
          });
        });
      }
      
      setOperatorDashboardAnalytics(response);
    } catch (error) {
      console.error('‚ùå Error fetching operator dashboard analytics:', error);
      showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏: ${error.message}`, 'error');
    } finally {
      setOperatorAnalyticsLoading(false);
    }
  };

  // QR Codes and Invoice functions - simplified version for now
  const generateBatchQRCodes = async (numbers) => {
    try {
      const response = await apiCall(`/api/cargo/batch/${encodeURIComponent(numbers)}/qr-codes`);
      return response;
    } catch (error) {
      console.error('Error generating QR codes:', error);
      throw error;
    }
  };

  const generateCargoInvoice = async (numbers) => {
    try {
      const response = await apiCall(`/api/cargo/invoice/${encodeURIComponent(numbers)}`);
      return response;
    } catch (error) {
      console.error('Error generating invoice:', error);
      throw error;
    }
  };

  // Generate QR code for application number
  const generateApplicationQR = async (cargoNumber) => {
    if (!cargoNumber.trim()) {
      showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –∑–∞—è–≤–∫–∏', 'error');
      return;
    }

    setApplicationQRLoading(true);
    try {
      const response = await apiCall(`/api/cargo/generate-application-qr/${encodeURIComponent(cargoNumber)}`);
      setApplicationQRCode(response);
      setShowApplicationQRModal(true);
      showAlert('QR –∫–æ–¥ –∑–∞—è–≤–∫–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
    } catch (error) {
      console.error('Error generating application QR:', error);
      showAlert(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞: ${error.message}`, 'error');
    } finally {
      setApplicationQRLoading(false);
    }
  };

  // New function: Generate QR by cargo number with validation
  const generateQRByCargoNumber = async () => {
    if (!qrGenerateCargoNumber.trim()) {
      showAlert('–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≥—Ä—É–∑–∞', 'error');
      return;
    }

    setQrGenerateLoading(true);
    try {
      // First, check if cargo exists by trying to scan it
      const checkResponse = await apiCall('/api/qr/scan', 'POST', {
        qr_text: qrGenerateCargoNumber.trim()
      });
      
      if (!checkResponse || checkResponse.type !== 'cargo') {
        showAlert(`–ì—Ä—É–∑ —Å –Ω–æ–º–µ—Ä–æ–º "${qrGenerateCargoNumber}" –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Å–∏—Å—Ç–µ–º–µ`, 'error');
        return;
      }
      
      // If cargo exists, generate QR code
      const response = await apiCall('/api/cargo/generate-qr-by-number', 'POST', {
        cargo_number: qrGenerateCargoNumber.trim()
      });
      
      if (response && response.success) {
        setGeneratedSingleQR(response);
        showAlert(`QR –∫–æ–¥ —Å–æ–∑–¥–∞–Ω –¥–ª—è –≥—Ä—É–∑–∞ ${response.cargo_number}`, 'success');
      }
    } catch (error) {
      console.error('Error generating QR by number:', error);
      
      // Check if error is about cargo not found
      if (error.message && (
          error.message.includes('not found') || 
          error.message.includes('–Ω–µ –Ω–∞–π–¥–µ–Ω') || 
          error.message.includes('404')
        )) {
        showAlert(`–ì—Ä—É–∑ —Å –Ω–æ–º–µ—Ä–æ–º "${qrGenerateCargoNumber}" –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –≤ —Å–∏—Å—Ç–µ–º–µ`, 'error');
      } else {
        showAlert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è QR –∫–æ–¥–∞: ${error.message}`, 'error');
      }
    } finally {
      setQrGenerateLoading(false);
    }
  };

  // New function: Generate QR codes for all cargo from same sender
  const generateBulkQRForSender = async (senderData) => {
    try {
      setBulkQRModal(true);
      setSelectedSender(senderData);
      setBulkQRLoading(true);
      
      // Find all cargo for this sender
      const senderCargoList = operatorCargo.filter(cargo => 
        cargo.sender_phone === senderData.sender_phone || 
        cargo.sender_full_name === senderData.sender_full_name
      );
      
      setSenderCargos(senderCargoList);
      
      // Generate QR codes for each cargo
      const qrResults = [];
      for (const cargo of senderCargoList) {
        try {
          const response = await apiCall('/api/cargo/generate-qr-by-number', 'POST', {
            cargo_number: cargo.cargo_number
          });
          
          if (response && response.success) {
            qrResults.push({
              cargo_number: cargo.cargo_number,
              cargo_name: cargo.cargo_name,
              qr_code: response.qr_code,
              success: true
            });
          } else {
            qrResults.push({
              cargo_number: cargo.cargo_number,
              cargo_name: cargo.cargo_name,
              success: false,
              error: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å QR –∫–æ–¥'
            });
          }
        } catch (error) {
          qrResults.push({
            cargo_number: cargo.cargo_number,
            cargo_name: cargo.cargo_name,
            success: false,
            error: error.message
          });
        }
      }
      
      setBulkQRResults(qrResults);
      showAlert(`–°–æ–∑–¥–∞–Ω–æ QR –∫–æ–¥–æ–≤: ${qrResults.filter(r => r.success).length}/${qrResults.length}`, 'success');
      
    } catch (error) {
      console.error('Error generating bulk QR codes:', error);
      showAlert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è QR –∫–æ–¥–æ–≤: ${error.message}`, 'error');
    } finally {
      setBulkQRLoading(false);
    }
  };

  // New function: Place cargo in cell
  const placeCargoInCell = async (cargoNumber, cellCode) => {
    try {
      const response = await apiCall('/api/cargo/place-in-cell', 'POST', {
        cargo_number: cargoNumber,
        cell_code: cellCode
      });
      
      if (response && response.success) {
        showAlert(`–ì—Ä—É–∑ ${cargoNumber} —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω –≤ —è—á–µ–π–∫–µ`, 'success');
        await fetchPlacementStatistics(); // Update statistics
        return true;
      }
    } catch (error) {
      console.error('Error placing cargo in cell:', error);
      showAlert(`–û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞: ${error.message}`, 'error');
      return false;
    }
  };

  // New function: Get placement statistics
  const fetchPlacementStatistics = async () => {
    try {
      const response = await apiCall('/api/operator/placement-statistics');
      setPlacementStatistics(response);
    } catch (error) {
      console.error('Error fetching placement statistics:', error);
    }
  };

  // Enhanced camera availability check for mobile devices
  const checkCameraAvailability = async () => {
    try {
      console.log('üîç –£–ª—É—á—à–µ–Ω–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–º–µ—Ä—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤...');
      
      // Check basic support
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        console.log('‚ùå MediaDevices API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è');
        return false;
      }
      
      // Mobile-specific camera constraints with multiple fallbacks
      const mobileConstraints = [
        // Primary: Back camera with high quality
        {
          video: {
            facingMode: { exact: "environment" },
            width: { ideal: 1920, max: 1920, min: 640 },
            height: { ideal: 1080, max: 1080, min: 480 },
            frameRate: { ideal: 30, min: 15 }
          }
        },
        // Fallback 1: Back camera with relaxed constraints
        {
          video: {
            facingMode: "environment",
            width: { ideal: 1280, min: 640 },
            height: { ideal: 720, min: 480 }
          }
        },
        // Fallback 2: Any camera with basic constraints
        {
          video: {
            width: { ideal: 1280, min: 640 },
            height: { ideal: 720, min: 480 }
          }
        },
        // Fallback 3: Minimal constraints
        {
          video: true
        }
      ];
      
      console.log('üîê –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã —Å —Ä–∞–∑–ª–∏—á–Ω—ã–º–∏ constraints...');
      
      let stream = null;
      let constraintsUsed = null;
      
      // Try each constraint set until one works
      for (let i = 0; i < mobileConstraints.length; i++) {
        try {
          console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ ${i + 1}/${mobileConstraints.length}...`);
          
          stream = await Promise.race([
            navigator.mediaDevices.getUserMedia(mobileConstraints[i]),
            new Promise((_, reject) => 
              setTimeout(() => reject(new Error('Timeout')), 15000) // 15 second timeout for mobile
            )
          ]);
          
          constraintsUsed = mobileConstraints[i];
          console.log(`‚úÖ –£—Å–ø–µ—Ö —Å constraints ${i + 1}`);
          break;
          
        } catch (error) {
          console.log(`‚ùå –ü–æ–ø—ã—Ç–∫–∞ ${i + 1} –Ω–µ—É–¥–∞—á–Ω–∞: ${error.name} - ${error.message}`);
          if (i === mobileConstraints.length - 1) {
            throw error; // Last attempt failed
          }
        }
      }
      
      if (!stream) {
        throw new Error('–í—Å–µ –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–ª—É—á–∏—Ç—å –∫–∞–º–µ—Ä—É –Ω–µ—É–¥–∞—á–Ω—ã');
      }
      
      // Get detailed camera info
      const videoTrack = stream.getVideoTracks()[0];
      if (videoTrack) {
        const capabilities = videoTrack.getCapabilities?.() || {};
        const settings = videoTrack.getSettings();
        console.log('üìπ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–∞–º–µ—Ä–µ:', {
          label: videoTrack.label,
          facingMode: settings.facingMode || 'unknown',
          width: settings.width,
          height: settings.height,
          frameRate: settings.frameRate,
          capabilities: Object.keys(capabilities)
        });
      }
      
      // Stop test stream
      stream.getTracks().forEach(track => {
        track.stop();
        console.log('‚èπÔ∏è –¢–µ—Å—Ç–æ–≤—ã–π –ø–æ—Ç–æ–∫ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω');
      });
      
      // Additional mobile stability wait
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      // Verify Html5Qrcode can detect cameras
      try {
        console.log('üé• –ü—Ä–æ–≤–µ—Ä–∫–∞ Html5Qrcode —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏...');
        const cameras = await Html5Qrcode.getCameras();
        console.log(`üì± Html5Qrcode –Ω–∞—à–µ–ª –∫–∞–º–µ—Ä: ${cameras.length}`);
        
        if (cameras.length === 0) {
          console.log('‚ö†Ô∏è Html5Qrcode –Ω–µ –Ω–∞—à–µ–ª –∫–∞–º–µ—Ä—ã, –Ω–æ getUserMedia —Ä–∞–±–æ—Ç–∞–µ—Ç');
          return false;
        }
        
        cameras.forEach((camera, index) => {
          console.log(`  üì∑ –ö–∞–º–µ—Ä–∞ ${index + 1}: "${camera.label || '–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}" (${camera.id})`);
        });
        
        return true;
        
      } catch (qrError) {
        console.error('‚ùå Html5Qrcode –æ—à–∏–±–∫–∞:', qrError);
        return false;
      }
      
    } catch (error) {
      console.error('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–º–µ—Ä—ã:', error.name, error.message);
      
      // Enhanced mobile error handling with user instructions
      if (error.name === 'NotAllowedError') {
        console.log('üö´ –ò–ù–°–¢–†–£–ö–¶–ò–Ø: –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ');
        showAlert('üì± –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –≤ –±—Ä–∞—É–∑–µ—Ä–µ:\n1. –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∏–∫–æ–Ω–∫—É –∑–∞–º–∫–∞/–∫–∞–º–µ—Ä—ã –≤ –∞–¥—Ä–µ—Å–Ω–æ–π —Å—Ç—Ä–æ–∫–µ\n2. –í—ã–±–µ—Ä–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å" –¥–ª—è –∫–∞–º–µ—Ä—ã\n3. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É', 'warning');
      } else if (error.name === 'NotFoundError') {
        console.log('üìµ –ö–∞–º–µ—Ä–∞ –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ');
        showAlert('üìµ –ö–∞–º–µ—Ä–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:\n1. –ö–∞–º–µ—Ä–∞ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º\n2. –§–∏–∑–∏—á–µ—Å–∫–∏–π –¥–æ—Å—Ç—É–ø –∫ –∫–∞–º–µ—Ä–µ –æ—Ç–∫—Ä—ã—Ç\n3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç–µ –±—Ä–∞—É–∑–µ—Ä', 'info');
      } else if (error.name === 'NotReadableError') {
        console.log('üîí –ö–∞–º–µ—Ä–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–∞ —Å–∏—Å—Ç–µ–º–æ–π –∏–ª–∏ –¥—Ä—É–≥–∏–º –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ–º');
        showAlert('üîí –ö–∞–º–µ—Ä–∞ –∑–∞–Ω—è—Ç–∞. –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã –∏ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'warning');
      } else if (error.message === 'Timeout') {
        console.log('‚è±Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω timeout –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∫–∞–º–µ—Ä—ã');
        showAlert('‚è±Ô∏è –ö–∞–º–µ—Ä–∞ —Å–ª–∏—à–∫–æ–º –¥–æ–ª–≥–æ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ:\n1. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É\n2. –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –¥—Ä—É–≥–æ–π –±—Ä–∞—É–∑–µ—Ä\n3. –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ', 'info');
      }
      
      return false;
    }
  };

  // Open cargo placement page
  const openCargoPlacementPage = () => {
    console.log('üöÄ –û—Ç–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞...');
    setCurrentPage('cargo-placement');
    
    // Reset placement state when opening page
    setPlacementActive(false);
    setPlacementStep('idle');
    setScannerActive(false);
    setManualCargoNumber('');
    setManualCellCode('');
    
    // Initialize placement page with longer delay for React rendering completion
    setTimeout(async () => {
      await startCargoPlacement();
    }, 1500);
  };

  // Close cargo placement page
  const closeCargoPlacementPage = () => {
    console.log('üîô –ó–∞–∫—Ä—ã—Ç–∏–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞...');
    
    // Stop any active scanners
    cleanupAllQrScanners();
    
    // Reset all placement states
    setPlacementActive(false);
    setPlacementStep('idle');
    setScannerActive(false);
    setShowCargoPlacementModal(false);
    
    // Return to main page
    setCurrentPage('main');
  };
  
  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –æ—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö QR —Å–∫–∞–Ω–µ—Ä–æ–≤
  const cleanupAllQrScanners = () => {
    console.log('üßπ –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö QR —Å–∫–∞–Ω–µ—Ä–æ–≤...');
    
    const scannerIds = [
      'qr-reader-placement-main',
      'qr-reader-placement-cargo', 
      'qr-reader-placement-mobile',
      'qr-reader-placement-edit',
      'qr-reader-placement-receive',
      'qr-reader-placement-update',
      'qr-reader-placement-search',
      'qr-reader-placement-isolated'
    ];
    
    // –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –≤—Å–µ—Ö –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–∫–∞–Ω–µ—Ä–æ–≤ —Å —Ç–∞–π–º–∞—É—Ç–æ–º
    if (html5QrCodePlacement) {
      try {
        safeStopQrScanner(html5QrCodePlacement, "qr-reader-placement-main", "Tab Switch Cleanup");
        setHtml5QrCodePlacement(null);
      } catch (e) {
        console.warn('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ QR —Å–∫–∞–Ω–µ—Ä–∞:', e);
      }
    }
    
    // –û—á–∏—Å—Ç–∫–∞ DOM —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤—Å–µ—Ö —Å–∫–∞–Ω–µ—Ä–æ–≤ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç –æ—à–∏–±–æ–∫
    scannerIds.forEach(scannerId => {
      try {
        const element = document.getElementById(scannerId);
        if (element && element.parentNode) {
          // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç –≤—Å–µ –µ—â–µ –≤ DOM
          element.innerHTML = '';
          console.log(`‚úÖ –û—á–∏—â–µ–Ω —Å–∫–∞–Ω–µ—Ä: ${scannerId}`);
        }
      } catch (e) {
        console.warn(`‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Å–∫–∞–Ω–µ—Ä–∞ ${scannerId}:`, e);
      }
    });
    
    // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏–π —Å–∫–∞–Ω–µ—Ä–æ–≤
    setScannerActive(false);
    setExternalScannerActive(false);
    setSearchScannerActive(false);
  };  
  const startCargoPlacement = async () => {
    try {
      console.log('üöÄ –ó–∞–ø—É—Å–∫ –ø—Ä–æ—Ü–µ—Å—Å–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞...');
      
      setPlacementActive(true);
      setPlacementStep('scan-cargo');
      
      // First fetch statistics and available cells
      await fetchPlacementStatistics();
      await getAvailableWarehouseCells();
      
      // Show loading indicator for mobile users
      showAlert('‚è≥ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞–º–µ—Ä—ã...', 'info');
      
      // Check camera availability with enhanced mobile support
      console.log('üì± –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–º–µ—Ä—ã –¥–ª—è –º–æ–±–∏–ª—å–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞...');
      const cameraAvailable = await checkCameraAvailability();
      
      if (cameraAvailable) {
        // Camera is available, proceed with QR scanner
        console.log('‚úÖ –ö–∞–º–µ—Ä–∞ –¥–æ—Å—Ç—É–ø–Ω–∞, –∑–∞–ø—É—Å–∫ —Å–∫–∞–Ω–µ—Ä–∞...');
        showAlert('üìπ –ö–∞–º–µ—Ä–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞! –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR –∫–æ–¥ –≥—Ä—É–∑–∞.', 'success');
        
        // Extended wait for modal to fully render on mobile
        console.log('‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–æ–ª–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞...');
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Then start QR scanner with retry mechanism
        let scannerStarted = false;
        let attempts = 0;
        const maxAttempts = 3;
        
        while (!scannerStarted && attempts < maxAttempts) {
          try {
            attempts++;
            console.log(`üîÑ –ü–æ–ø—ã—Ç–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–µ—Ä–∞ ${attempts}/${maxAttempts}...`);
            await startQRScannerForPlacement();
            scannerStarted = true;
            console.log('‚úÖ –°–∫–∞–Ω–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω');
          } catch (error) {
            console.warn(`‚ö†Ô∏è –ü–æ–ø—ã—Ç–∫–∞ ${attempts} –Ω–µ —É–¥–∞–ª–∞—Å—å:`, error.message);
            if (attempts < maxAttempts) {
              console.log('‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–ø—ã—Ç–∫–æ–π...');
              await new Promise(resolve => setTimeout(resolve, 1000));
            }
          }
        }
        
        if (!scannerStarted) {
          console.error('‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–µ—Ä –ø–æ—Å–ª–µ –≤—Å–µ—Ö –ø–æ–ø—ã—Ç–æ–∫');
          throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∫–∞–º–µ—Ä—É –ø–æ—Å–ª–µ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–ø—ã—Ç–æ–∫');
        }
        
      } else {
        // Camera not available, show manual input mode
        console.log('üìù –ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞, –ø–µ—Ä–µ—Ö–æ–¥ –∫ —Ä—É—á–Ω–æ–º—É —Ä–µ–∂–∏–º—É');
        showAlert('üìù –ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –Ω–∏–∂–µ.', 'warning');
        setScannerActive(false); // Ensure scanner is marked as inactive
      }
      
    } catch (error) {
      console.error('üí• –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞:', error);
      showAlert(`‚ùå –û—à–∏–±–∫–∞: ${error.message}. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥.`, 'error');
      // Don't reset placement active - allow manual input to work
      setScannerActive(false);
    }
  };

  // Completely isolated QR Scanner to prevent React removeChild conflicts
  const startQRScannerForPlacement = async () => {
    try {
      console.log('üîß –ó–∞–ø—É—Å–∫ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ QR —Å–∫–∞–Ω–µ—Ä–∞ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤...');
      
      // Prevent multiple simultaneous initializations
      if (isInitializingRef.current) {
        console.log('‚ö†Ô∏è –°–∫–∞–Ω–µ—Ä —É–∂–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ—Ç—Å—è, –ø—Ä–æ–ø—É—Å–∫...');
        return;
      }
      
      isInitializingRef.current = true;
      
      // Complete cleanup first using isolated method
      await completeQrCleanup("Isolated Scanner Start");
      
      // Create isolated container to avoid React conflicts
      const isolatedElementId = createIsolatedQrContainer();
      
      // Wait for isolated container to be ready
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Verify isolated element exists
      const isolatedElement = document.getElementById(isolatedElementId);
      if (!isolatedElement) {
        throw new Error('–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ —Å–æ–∑–¥–∞–Ω');
      }
      
      console.log('‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –≥–æ—Ç–æ–≤ –¥–ª—è QR —Å–∫–∞–Ω–µ—Ä–∞');

      // Get cameras with enhanced retry
      let cameras = [];
      let cameraAttempts = 0;
      const maxCameraAttempts = 3;
      
      while (cameras.length === 0 && cameraAttempts < maxCameraAttempts) {
        try {
          cameraAttempts++;
          console.log(`üé• –ü–æ–ª—É—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä (–ø–æ–ø—ã—Ç–∫–∞ ${cameraAttempts}/${maxCameraAttempts})...`);
          cameras = await Html5Qrcode.getCameras();
          
          if (cameras.length === 0 && cameraAttempts < maxCameraAttempts) {
            await new Promise(resolve => setTimeout(resolve, 1500));
          }
        } catch (error) {
          console.error(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∫–∞–º–µ—Ä (–ø–æ–ø—ã—Ç–∫–∞ ${cameraAttempts}):`, error);
          if (cameraAttempts < maxCameraAttempts) {
            await new Promise(resolve => setTimeout(resolve, 1500));
          }
        }
      }
      
      if (!cameras || cameras.length === 0) {
        throw new Error('–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –¥–ª—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞');
      }

      console.log(`üìπ –ù–∞–π–¥–µ–Ω–æ –∫–∞–º–µ—Ä –¥–ª—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞: ${cameras.length}`);
      setAvailablePlacementCameras(cameras);

      // Select best camera
      let selectedCamera = cameras[currentPlacementCameraIndex] || cameras[cameras.length - 1];
      console.log(`üé¨ –í—ã–±—Ä–∞–Ω–∞ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–∞–º–µ—Ä–∞: "${selectedCamera.label}"`);

      // Initialize Html5Qrcode with isolated element
      console.log('üöÄ –°–æ–∑–¥–∞–Ω–∏–µ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ Html5Qrcode —ç–∫–∑–µ–º–ø–ª—è—Ä–∞...');
      const qrCodeInstance = new Html5Qrcode(isolatedElementId);
      
      // Store instance in ref for safe cleanup
      html5QrCodePlacementRef.current = qrCodeInstance;
      setHtml5QrCodePlacement(qrCodeInstance);

      // Mobile-optimized configuration
      const isolatedConfig = {
        fps: 15,
        qrbox: function(viewfinderWidth, viewfinderHeight) {
          const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
          const boxSize = Math.floor(minEdge * 0.8);
          console.log(`üìê –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π QR box: ${boxSize}x${boxSize}`);
          return { width: boxSize, height: boxSize };
        },
        aspectRatio: 1.0,
        disableFlip: false,
        videoConstraints: {
          facingMode: "environment",
          width: { ideal: 1280, max: 1920, min: 640 },
          height: { ideal: 720, max: 1080, min: 480 },
          frameRate: { ideal: 20, min: 10 }
        },
        experimentalFeatures: { useBarCodeDetectorIfSupported: true },
        rememberLastUsedCamera: true
      };

      console.log('üéØ –ó–∞–ø—É—Å–∫ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞ —Å –∑–∞—â–∏—Ç–æ–π –æ—Ç React –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤...');
      
      await qrCodeInstance.start(
        selectedCamera.id,
        isolatedConfig,
        (decodedText, decodedResult) => {
          console.log('üì± QR –∫–æ–¥ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–º —Å–∫–∞–Ω–µ—Ä–æ–º:', decodedText);
          handlePlacementQRScan(decodedText);
        },
        (errorMessage) => {
          if (!errorMessage.includes('No QR code found') && 
              !errorMessage.includes('NotFoundException')) {
            console.debug('üîç –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ:', errorMessage);
          }
        }
      );
      
      setScannerActive(true);
      isInitializingRef.current = false;
      
      console.log('‚úÖ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π QR —Å–∫–∞–Ω–µ—Ä —É—Å–ø–µ—à–Ω–æ –∑–∞–ø—É—â–µ–Ω –±–µ–∑ React –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤');
      showAlert('üì± –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞! –ù–∞–≤–µ–¥–∏—Ç–µ –Ω–∞ QR –∫–æ–¥.', 'success');
      
    } catch (error) {
      console.error('üí• –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ QR —Å–∫–∞–Ω–µ—Ä–∞:', error);
      
      // Complete cleanup on error
      await completeQrCleanup("Isolated Scanner Error");
      
      let userMessage = 'üìµ –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–ø—É—Å—Ç–∏—Ç—å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—É—é –∫–∞–º–µ—Ä—É';
      
      if (error.message.includes('–ö–∞–º–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã')) {
        userMessage = 'üìµ –ö–∞–º–µ—Ä—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫–∞–º–µ—Ä—ã.';
      } else if (error.message.includes('–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä')) {
        userMessage = 'üîÑ –û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É.';
      }
      
      showAlert(`${userMessage}\n\n–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥ –Ω–∏–∂–µ.`, 'warning');
    }
  };

  // New function: Handle QR scan during placement
  const handlePlacementQRScan = async (scannedData) => {
    try {
      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ
      if (html5QrCodePlacement) {
        await safeStopQrScanner(html5QrCodePlacement, "qr-reader-placement", "Placement Scanner");
        setHtml5QrCodePlacement(null);
      }
      setScannerActive(false);

      if (placementStep === 'scan-cargo') {
        // Scanned cargo QR code
        const response = await apiCall('/api/qr/scan', 'POST', { qr_text: scannedData });
        
        if (response && response.type === 'cargo') {
          setScannedCargoForPlacement(response);
          setPlacementStep('scan-cell');
          showAlert(`–ì—Ä—É–∑ –Ω–∞–π–¥–µ–Ω: ${response.cargo_number}. –¢–µ–ø–µ—Ä—å –æ—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —è—á–µ–π–∫—É.`, 'success');
          setTimeout(() => startQRScannerForPlacement(), 1000);
        } else {
          showAlert('–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ–¥–æ–º –≥—Ä—É–∑–∞', 'error');
        }
        
      } else if (placementStep === 'scan-cell') {
        // Scanned cell QR code
        const response = await apiCall('/api/qr/scan', 'POST', { qr_text: scannedData });
        
        if (response && response.type === 'warehouse_cell') {
          if (response.is_occupied) {
            showAlert(`–Ø—á–µ–π–∫–∞ –∑–∞–Ω—è—Ç–∞ –≥—Ä—É–∑–æ–º ${response.cargo_number}`, 'error');
            setTimeout(() => startQRScannerForPlacement(), 1000);
          } else {
            // Place cargo in cell
            const success = await placeCargoInCell(
              scannedCargoForPlacement.cargo_number,
              scannedData
            );
            
            if (success) {
              // Reset to scan next cargo
              setScannedCargoForPlacement(null);
              setPlacementStep('scan-cargo');
              showAlert('–ì—Ä—É–∑ —Ä–∞–∑–º–µ—â–µ–Ω! –ú–æ–∂–µ—Ç–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â–∏–π –≥—Ä—É–∑.', 'success');
              setTimeout(() => startQRScannerForPlacement(), 1000);
            }
          }
        } else {
          showAlert('–û—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–¥ –Ω–µ —è–≤–ª—è–µ—Ç—Å—è –∫–æ–¥–æ–º —è—á–µ–π–∫–∏', 'error');
          setTimeout(() => startQRScannerForPlacement(), 1000);
        }
      }
    } catch (error) {
      console.error('Error handling placement QR scan:', error);
      showAlert(`–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ${error.message}`, 'error');
      setTimeout(() => startQRScannerForPlacement(), 1000);
    }
  };

  // New function: Stop placement process
  const stopCargoPlacement = async () => {
    if (html5QrCodePlacement) {
      await safeStopQrScanner(html5QrCodePlacement, "qr-reader-placement", "Placement Scanner");
      setHtml5QrCodePlacement(null);
    }
    
    setPlacementActive(false);
    setPlacementStep('idle');
    setScannedCargoForPlacement(null);
    setScannerActive(false);
  };

  // New function: Switch camera for placement scanner
  const switchPlacementCamera = async () => {
    if (availablePlacementCameras.length <= 1) {
      showAlert('–ù–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –Ω–∞–π–¥–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∫–∞–º–µ—Ä–∞', 'info');
      return;
    }

    try {
      // Stop current scanner
      if (html5QrCodePlacement) {
        await safeStopQrScanner(html5QrCodePlacement, "qr-reader-placement", "Placement Scanner");
        setHtml5QrCodePlacement(null);
      }

      // Switch to next camera
      const nextCameraIndex = (currentPlacementCameraIndex + 1) % availablePlacementCameras.length;
      setCurrentPlacementCameraIndex(nextCameraIndex);
      
      // Restart scanner with new camera
      setTimeout(() => {
        startQRScannerForPlacement();
      }, 500);

      showAlert(`–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –Ω–∞ –∫–∞–º–µ—Ä—É: ${availablePlacementCameras[nextCameraIndex]?.label || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è'}`, 'info');

    } catch (error) {
      console.error('Error switching camera:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã', 'error');
    }
  };

  // Scan QR code to find cargo
  const scanCargoQRCode = async (qrText) => {
    try {
      const response = await apiCall('/api/cargo/scan-qr', 'POST', { qr_text: qrText });
      
      if (response && response.success) {
        setScannedCargoInfo(response.cargo);
        setShowScannedCargoModal(true);
        showAlert(`–ì—Ä—É–∑ –Ω–∞–π–¥–µ–Ω: ${response.cargo.cargo_number}`, 'success');
        return response.cargo;
      }
    } catch (error) {
      console.error('Error scanning cargo QR:', error);
      showAlert(`–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR –∫–æ–¥–∞: ${error.message}`, 'error');
      return null;
    }
  };

  // Start QR scanner for cargo search
  const startCargoQRScanner = () => {
    setScannerMode('cargo-qr-search');
    setScannerActive(true);
    setScannerError(null);
    setShowQRScannerModal(true);
  };

  // Stop QR scanner
  const stopCargoQRScanner = () => {
    setScannerMode('none');
    setScannerActive(false);
    setScannerError(null);
    setShowQRScannerModal(false);
  };

  // Switch camera for modal QR scanner
  const switchModalCamera = async () => {
    try {
      if (modalCameras.length > 1) {
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –∫–∞–º–µ—Ä—É
        const nextIndex = (modalCameraIndex + 1) % modalCameras.length;
        setModalCameraIndex(nextIndex);
        
        // –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å–∫–∞–Ω–µ—Ä —Å –Ω–æ–≤–æ–π –∫–∞–º–µ—Ä–æ–π
        setScannerActive(false);
        setTimeout(() => {
          setScannerActive(true);
        }, 500);
        
        const cameraName = modalCameras[nextIndex]?.label || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –∫–∞–º–µ—Ä–∞';
        showAlert(`–ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–æ –Ω–∞: ${cameraName}`, 'info');
      } else {
        showAlert('–î–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –æ–¥–Ω–∞ –∫–∞–º–µ—Ä–∞', 'warning');
      }
    } catch (error) {
      console.error('Error switching camera:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã', 'error');
    }
  };

  // useEffect for QR scanner modal - improved with useRef
  useEffect(() => {
    // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–±–æ—Ä–∞ –ª—É—á—à–µ–π –∫–∞–º–µ—Ä—ã (–ø—Ä–µ–¥–ø–æ—á—Ç–µ–Ω–∏–µ –∑–∞–¥–Ω–µ–π –∫–∞–º–µ—Ä–µ)
    const getBestCamera = (cameras) => {
      if (!cameras || cameras.length === 0) return null;

      // –ò—â–µ–º –∑–∞–¥–Ω—é—é –∫–∞–º–µ—Ä—É (environment-facing)
      const backCamera = cameras.find(camera => 
        camera.label.toLowerCase().includes('back') ||
        camera.label.toLowerCase().includes('rear') ||
        camera.label.toLowerCase().includes('environment') ||
        camera.label.toLowerCase().includes('0') // –ß–∞—Å—Ç–æ –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞ –∏–º–µ–µ—Ç –∏–Ω–¥–µ–∫—Å 0 –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏
      );

      if (backCamera) {
        console.log('Selected back camera:', backCamera.label);
        return backCamera;
      }

      // –ï—Å–ª–∏ –∑–∞–¥–Ω—è—è –Ω–µ –Ω–∞–π–¥–µ–Ω–∞, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é (—á–∞—Å—Ç–æ —ç—Ç–æ –∑–∞–¥–Ω—è—è)
      console.log('Back camera not found, using camera:', cameras[cameras.length - 1].label);
      return cameras[cameras.length - 1];
    };

    const initializeModalQRScanner = async () => {
      if (showQRScannerModal && scannerMode === 'cargo-qr-search' && scannerActive) {
        try {
          // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–µ–¥—ã–¥—É—â–∏–π —ç–∫–∑–µ–º–ø–ª—è—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ
          if (modalScannerRef.current) {
            await safeStopQrScanner(modalScannerRef.current, "qr-reader-modal", "Modal Scanner");
            modalScannerRef.current = null;
          }

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞
          const modalElement = document.getElementById('qr-reader-modal');
          if (!modalElement) {
            console.log('QR reader modal element not found, waiting...');
            return;
          }

          // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É
          const cameras = await Html5Qrcode.getCameras();
          if (cameras && cameras.length > 0) {
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –∫–∞–º–µ—Ä –¥–ª—è –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è
            setModalCameras(cameras);
            
            modalScannerRef.current = new Html5Qrcode("qr-reader-modal");
            
            // –í—ã–±–∏—Ä–∞–µ–º –∫–∞–º–µ—Ä—É –ø–æ –∏–Ω–¥–µ–∫—Å—É, –ª–∏–±–æ –ª—É—á—à—É—é –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ
            let selectedCamera;
            if (modalCameraIndex < cameras.length) {
              selectedCamera = cameras[modalCameraIndex];
            } else {
              // –ü—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ –≤—ã–±–∏—Ä–∞–µ–º –ª—É—á—à—É—é –∫–∞–º–µ—Ä—É
              selectedCamera = getBestCamera(cameras);
              const selectedIndex = cameras.findIndex(c => c.id === selectedCamera.id);
              setModalCameraIndex(selectedIndex >= 0 ? selectedIndex : 0);
            }
            
            console.log(`Using camera: ${selectedCamera.label} (index: ${modalCameraIndex})`);
            
            const config = {
              fps: 10,
              qrbox: { width: 200, height: 200 },
              aspectRatio: 1.0,
              disableFlip: false,
              // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ª—É—á—à–µ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
              videoConstraints: {
                facingMode: "environment" // –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ –∑–∞–¥–Ω—è—è –∫–∞–º–µ—Ä–∞
              }
            };

            await modalScannerRef.current.start(
              selectedCamera.id, // –ò—Å–ø–æ–ª—å–∑—É–µ–º –≤—ã–±—Ä–∞–Ω–Ω—É—é –∫–∞–º–µ—Ä—É
              config,
              async (decodedText, decodedResult) => {
                console.log('Cargo QR Code scanned:', decodedText);
                
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–µ—Ä –±–µ–∑–æ–ø–∞—Å–Ω–æ
                if (modalScannerRef.current) {
                  await safeStopQrScanner(modalScannerRef.current, "qr-reader-modal", "Modal Scanner");
                  modalScannerRef.current = null;
                }
                
                // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π QR –∫–æ–¥
                await scanCargoQRCode(decodedText);
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                stopCargoQRScanner();
              },
              (errorMessage) => {
                // –ò–≥–Ω–æ—Ä–∏—Ä—É–µ–º –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–µ –æ—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è —É–º–µ–Ω—å—à–µ–Ω–∏—è –ª–æ–≥–æ–≤
                console.debug('Modal QR scan error:', errorMessage);
              }
            );
            
            console.log('Modal QR scanner initialized successfully');
          } else {
            console.error('No cameras available for modal QR scanner');
            setScannerError('–ö–∞–º–µ—Ä—ã –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω—ã');
          }
        } catch (error) {
          console.error('Modal QR scanner initialization error:', error);
          setScannerError('–ù–µ —É–¥–∞–ª–æ—Å—å –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–∫–∞–Ω–µ—Ä');
        }
      }
    };

    if (showQRScannerModal && scannerMode === 'cargo-qr-search' && scannerActive) {
      // –î–æ–±–∞–≤–ª—è–µ–º –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ DOM
      setTimeout(initializeModalQRScanner, 500);
    }

    // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
    return () => {
      if (modalScannerRef.current) {
        safeStopQrScanner(modalScannerRef.current, "qr-reader-modal", "Modal Scanner").catch(console.error);
        modalScannerRef.current = null;
      }
    };
  }, [showQRScannerModal, scannerMode, scannerActive, modalCameraIndex]);

  const printApplicationQR = () => {
    if (!applicationQRCode) return;

    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
      return;
    }
    const printContent = `
      <html>
        <head>
          <title>QR –∫–æ–¥ –∑–∞—è–≤–∫–∏ ${applicationQRCode.cargo_number}</title>
          <style>
            body { 
              font-family: Arial, sans-serif; 
              margin: 20px; 
              text-align: center; 
              line-height: 1.6; 
            }
            .qr-container { 
              border: 2px solid #333; 
              padding: 20px; 
              margin: 20px auto; 
              max-width: 400px; 
              border-radius: 10px; 
            }
            .qr-code { 
              margin: 15px 0; 
            }
            .cargo-info { 
              margin: 15px 0; 
              text-align: left; 
            }
            .cargo-info div { 
              margin: 5px 0; 
            }
            .header { 
              font-size: 18px; 
              font-weight: bold; 
              margin-bottom: 15px; 
            }
            @media print {
              .qr-container { page-break-inside: avoid; }
            }
          </style>
        </head>
        <body>
          <div class="qr-container">
            <div class="header">–ó–ê–Ø–í–ö–ê TAJLINE.TJ</div>
            <div class="qr-code">
              <img src="${applicationQRCode.qr_code}" alt="QR –∫–æ–¥ –∑–∞—è–≤–∫–∏" style="width: 200px; height: 200px;" />
            </div>
            <div class="cargo-info">
              <div><strong>–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏:</strong> ${applicationQRCode.cargo_number}</div>
              <div><strong>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</strong> ${applicationQRCode.cargo_info.cargo_name}</div>
              <div><strong>–í–µ—Å:</strong> ${applicationQRCode.cargo_info.weight} –∫–≥</div>
              <div><strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> ${applicationQRCode.cargo_info.sender_name}</div>
              <div><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> ${applicationQRCode.cargo_info.recipient_name}</div>
              <div><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong> ${applicationQRCode.cargo_info.created_at}</div>
            </div>
            <div style="margin-top: 20px; font-size: 12px; color: #666;">
              –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞—è–≤–∫–µ
            </div>
          </div>
        </body>
      </html>
    `;

    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
  };

  const getPaymentMethodText = (method) => {
    const methods = {
      'not_paid': '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ',
      'cash': '–ù–∞–ª–∏—á–Ω—ã–µ',
      'card_transfer': '–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É',
      'cash_on_delivery': '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏',
      'credit': '–í –¥–æ–ª–≥'
    };
    return methods[method] || method;
  };

  const getStatusText = (status) => {
    const statuses = {
      'accepted': '–ü—Ä–∏–Ω—è—Ç',
      'placed_in_warehouse': '–ù–∞ —Å–∫–ª–∞–¥–µ',
      'on_transport': '–ù–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ',
      'in_transit': '–í –ø—É—Ç–∏',
      'ready_for_delivery': '–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ',
      'delivered': '–î–æ—Å—Ç–∞–≤–ª–µ–Ω'
    };
    return statuses[status] || status;
  };

  const getProcessingStatusText = (status) => {
    const statuses = {
      'payment_pending': '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã',
      'paid': '–û–ø–ª–∞—á–µ–Ω',
      'placed': '–†–∞–∑–º–µ—â–µ–Ω',
      'ready_for_pickup': '–ì–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ'
    };
    return statuses[status] || status;
  };

  const getPaymentStatusText = (status) => {
    const statuses = {
      'pending': '–û–∂–∏–¥–∞–µ—Ç—Å—è',
      'paid': '–û–ø–ª–∞—á–µ–Ω',
      'unpaid': '–ù–µ –æ–ø–ª–∞—á–µ–Ω',
      'partial': '–ß–∞—Å—Ç–∏—á–Ω–æ'
    };
    return statuses[status] || status;
  };

  const getOperationText = (operation) => {
    const operations = {
      'view_details': '–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏',
      'edit_cargo': '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å',
      'print_label': '–ü–µ—á–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏',
      'generate_qr': 'QR –∫–æ–¥',
      'track_history': '–ò—Å—Ç–æ—Ä–∏—è',
      'accept_payment': '–ü—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É',
      'place_in_warehouse': '–†–∞–∑–º–µ—Å—Ç–∏—Ç—å',
      'move_cargo': '–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å',
      'prepare_delivery': '–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –≤—ã–¥–∞—á—É',
      'deliver_cargo': '–í—ã–¥–∞—Ç—å –≥—Ä—É–∑',
      'make_payment': '–û–ø–ª–∞—Ç–∏—Ç—å',
      'print_receipt': '–ö–≤–∏—Ç–∞–Ω—Ü–∏—è'
    };
    return operations[operation] || operation;
  };

  const handleCargoOperation = (operation, cargoInfo) => {
    switch (operation) {
      case 'view_details':
        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        showAlert(`–ü–æ–¥—Ä–æ–±–Ω–æ—Å—Ç–∏ –≥—Ä—É–∑–∞ ${cargoInfo.cargo_number}`, 'info');
        break;
      case 'print_label':
        // –ü–µ—á–∞—Ç—å —ç—Ç–∏–∫–µ—Ç–∫–∏
        printCargoLabel(cargoInfo);
        break;
      case 'generate_qr':
        // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞
        generateApplicationQR(cargoInfo.cargo_number);
        break;
      default:
        showAlert(`–û–ø–µ—Ä–∞—Ü–∏—è "${getOperationText(operation)}" –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞`, 'info');
    }
  };

  const printCargoLabel = (cargoInfo) => {
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
      return;
    }
    const printContent = `
      <html>
        <head>
          <title>–≠—Ç–∏–∫–µ—Ç–∫–∞ –≥—Ä—É–∑–∞ ${cargoInfo.cargo_number}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 10px; }
            .label { border: 2px solid #000; padding: 10px; max-width: 300px; }
            .header { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 10px; }
            .info { font-size: 12px; line-height: 1.3; }
          </style>
        </head>
        <body>
          <div class="label">
            <div class="header">TAJLINE.TJ</div>
            <div class="info">
              <div><strong>–ù–æ–º–µ—Ä:</strong> ${cargoInfo.cargo_number}</div>
              <div><strong>–ì—Ä—É–∑:</strong> ${cargoInfo.cargo_name}</div>
              <div><strong>–í–µ—Å:</strong> ${cargoInfo.weight} –∫–≥</div>
              <div><strong>–û—Ç:</strong> ${cargoInfo.sender_name}</div>
              <div><strong>–ö–æ–º—É:</strong> ${cargoInfo.recipient_name}</div>
              <div><strong>–¢–µ–ª:</strong> ${cargoInfo.recipient_phone}</div>
            </div>
          </div>
        </body>
      </html>
    `;
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
  };

  // –§—É–Ω–∫—Ü–∏—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ä–æ–ª—è–º–∏
  const handleRoleChange = async () => {
    if (!selectedUserForRole || !newRole) return;
    
    try {
      await apiCall(`/api/admin/users/${selectedUserForRole.id}/role`, 'PUT', {
        user_id: selectedUserForRole.id,
        new_role: newRole
      });
      
      showAlert(`–†–æ–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–µ–Ω–∞ –Ω–∞ ${getRoleLabel(newRole)}`, 'success');
      setShowRoleModal(false);
      setSelectedUserForRole(null);
      setNewRole('');
      fetchUsers(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
    } catch (error) {
      showAlert(error.message || '–û—à–∏–±–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏', 'error');
    }
  };

  // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏
  const openRoleModal = (user) => {
    setSelectedUserForRole(user);
    setNewRole(user.role);
    setShowRoleModal(true);
  };

  const fetchUserData = async () => {
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å—ã –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    if (isLoggingIn || isLoggingOut || user) {
      console.log('Skipping fetchUserData - login/logout in progress or user already loaded');
      return;
    }

    try {
      console.log('Fetching user data...');
      // Get user data from backend using the token
      const userData = await apiCall('/api/auth/me', 'GET');
      console.log('User data received:', userData.full_name, userData.role);
      setUser(userData);
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö
      setDataLoaded(true);
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ª–æ–≥–∏–Ω–∞ –µ—Å–ª–∏ –æ–Ω –±—ã–ª —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
      if (isLoggingIn) {
        setIsLoggingIn(false);
      }
    } catch (error) {
      console.error('Failed to fetch user data:', error);
      // –ù–µ –æ—á–∏—â–∞–µ–º —Ç–æ–∫–µ–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ - –ø–æ–∑–≤–æ–ª—è–µ–º apiCall –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å —ç—Ç–æ
      if (error.message !== 'Session expired') {
        showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
      }
      throw error;
    }
  };

  const fetchNotifications = async () => {
    try {
      const data = await apiCall('/api/notifications?status=all&limit=50');
      setNotifications(data || []);
    } catch (error) {
      console.error('Error fetching notifications:', error);
    }
  };

  const fetchMyCargo = async () => {
    try {
      const data = await apiCall('/api/cargo/my');
      setCargo(data);
    } catch (error) {
      console.error('Error fetching cargo:', error);
    }
  };

  const fetchAllCargo = async () => {
    try {
      const data = await apiCall('/api/cargo/all');
      setCargo(data);
    } catch (error) {
      console.error('Error fetching all cargo:', error);
    }
  };

  const fetchUsers = async (page = usersPage, perPage = usersPerPage) => {
    try {
      const params = {
        page: page,
        per_page: perPage
      };
      
      const response = await apiCall('/api/admin/users', 'GET', null, params);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
      if (response.items) {
        setUsers(response.items); // –ò—Å–ø–æ–ª—å–∑—É–µ–º items –∏–∑ –ø–∞–≥–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞
        setUsersPagination(response.pagination);
      } else {
        // –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º
        setUsers(response);
        setUsersPagination({});
      }
    } catch (error) {
      console.error('Error fetching users:', error);
      setUsers([]); // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
      setUsersPagination({});
    }
  };

  const fetchWarehouseCargo = async () => {
    try {
      const data = await apiCall('/api/warehouse/cargo');
      setWarehouseCargo(data);
    } catch (error) {
      console.error('Error fetching warehouse cargo:', error);
    }
  };

  // –ù–û–í–´–ô –ö–û–ú–ü–û–ù–ï–ù–¢: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∫–ª–∞–¥–∞ —Å lazy loading
  const WarehouseStatistics = ({ warehouse }) => {
    const [statistics, setStatistics] = useState(null);
    const [loading, setLoading] = useState(false);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    useEffect(() => {
      const loadStatistics = async () => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        if (warehousesStatistics[warehouse.id]) {
          setStatistics(warehousesStatistics[warehouse.id]);
          return;
        }
        
        setLoading(true);
        try {
          const stats = await fetchWarehouseStatisticsLazy(warehouse.id);
          setStatistics(stats);
        } catch (error) {
          console.error(`Error loading statistics for warehouse ${warehouse.id}:`, error);
        } finally {
          setLoading(false);
        }
      };
      
      loadStatistics();
    }, [warehouse.id]);
    
    // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∏–¥–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder
    if (loading || !statistics) {
      return (
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
          {[1, 2, 3, 4].map(i => (
            <div key={i} className="bg-white p-3 rounded-lg border shadow-sm animate-pulse">
              <div className="flex items-center justify-between">
                <div>
                  <div className="h-3 bg-gray-200 rounded w-16 mb-2"></div>
                  <div className="h-6 bg-gray-200 rounded w-8"></div>
                </div>
                <div className="h-6 w-6 bg-gray-200 rounded"></div>
              </div>
            </div>
          ))}
        </div>
      );
    }
    
    return (
      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
        <div className="bg-white p-3 rounded-lg border shadow-sm">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs font-medium text-gray-500">–í—Å–µ–≥–æ —è—á–µ–µ–∫</p>
              <p className="text-xl font-bold text-blue-600">
                {statistics?.total_cells || 
                 (warehouse.blocks_count || 0) * (warehouse.shelves_per_block || 0) * (warehouse.cells_per_shelf || 0)}
              </p>
            </div>
            <Grid3X3 className="h-6 w-6 text-blue-500" />
          </div>
        </div>
        
        <div className="bg-white p-3 rounded-lg border shadow-sm">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs font-medium text-gray-500">–ó–∞–Ω—è—Ç–æ</p>
              <p className="text-xl font-bold text-red-600">
                {statistics?.occupied_cells || 0}
              </p>
            </div>
            <Package className="h-6 w-6 text-red-500" />
          </div>
        </div>
        
        <div className="bg-white p-3 rounded-lg border shadow-sm">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs font-medium text-gray-500">–°–≤–æ–±–æ–¥–Ω–æ</p>
              <p className="text-xl font-bold text-green-600">
                {statistics?.free_cells || 
                 ((warehouse.blocks_count || 0) * (warehouse.shelves_per_block || 0) * (warehouse.cells_per_shelf || 0))}
              </p>
            </div>
            <CheckCircle className="h-6 w-6 text-green-500" />
          </div>
        </div>
        
        <div className="bg-white p-3 rounded-lg border shadow-sm">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs font-medium text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞</p>
              <p className="text-xl font-bold text-orange-600">
                {statistics?.utilization_percent?.toFixed(1) || '0.0'}%
              </p>
            </div>
            <DollarSign className="h-6 w-6 text-orange-500" />
          </div>
        </div>
      </div>
    );
  };

  // –ù–û–í–´–ô –ö–û–ú–ü–û–ù–ï–ù–¢: –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∫–ª–∞–¥–∞ —Å lazy loading
  const WarehouseExtendedStatistics = ({ warehouse }) => {
    const [statistics, setStatistics] = useState(null);
    const [loading, setLoading] = useState(false);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –ø—Ä–∏ –º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
    useEffect(() => {
      const loadStatistics = async () => {
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        if (warehousesStatistics[warehouse.id]) {
          setStatistics(warehousesStatistics[warehouse.id]);
          return;
        }
        
        setLoading(true);
        try {
          const stats = await fetchWarehouseStatisticsLazy(warehouse.id);
          setStatistics(stats);
        } catch (error) {
          console.error(`Error loading statistics for warehouse ${warehouse.id}:`, error);
        } finally {
          setLoading(false);
        }
      };
      
      loadStatistics();
    }, [warehouse.id]);
    
    // –ï—Å–ª–∏ –∑–∞–≥—Ä—É–∑–∫–∞ –∏–¥–µ—Ç, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º placeholder
    if (loading || !statistics) {
      return (
        <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
          {[1, 2, 3, 4].map(i => (
            <div key={i} className="bg-gradient-to-r from-gray-50 to-gray-100 p-3 rounded-lg border animate-pulse">
              <div className="flex items-center justify-between">
                <div>
                  <div className="h-3 bg-gray-200 rounded w-12 mb-2"></div>
                  <div className="h-5 bg-gray-200 rounded w-10"></div>
                </div>
                <div className="h-5 w-5 bg-gray-200 rounded"></div>
              </div>
            </div>
          ))}
        </div>
      );
    }
    
    return (
      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
        <div className="bg-gradient-to-r from-purple-50 to-pink-50 p-3 rounded-lg border border-purple-200">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs font-medium text-purple-700">–í–µ—Å (–∫–≥)</p>
              <p className="text-lg font-bold text-purple-900">
                {statistics?.total_weight || 0}
              </p>
            </div>
            <Package2 className="h-5 w-5 text-purple-600" />
          </div>
        </div>
        
        <div className="bg-gradient-to-r from-blue-50 to-cyan-50 p-3 rounded-lg border border-blue-200">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs font-medium text-blue-700">–ö–æ–ª-–≤–æ –≥—Ä—É–∑–æ–≤</p>
              <p className="text-lg font-bold text-blue-900">
                {statistics?.total_cargo_count || 0}
              </p>
            </div>
            <FileText className="h-5 w-5 text-blue-600" />
          </div>
        </div>
        
        <div className="bg-gradient-to-r from-green-50 to-emerald-50 p-3 rounded-lg border border-green-200">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs font-medium text-green-700">–í—Å–µ–≥–æ –≥—Ä—É–∑–æ–≤</p>
              <p className="text-lg font-bold text-green-900">
                {statistics?.total_cargo_count || 0}
              </p>
            </div>
            <Package className="h-5 w-5 text-green-600" />
          </div>
        </div>
        
        <div className="bg-gradient-to-r from-yellow-50 to-orange-50 p-3 rounded-lg border border-yellow-200">
          <div className="flex items-center justify-between">
            <div>
              <p className="text-xs font-medium text-yellow-700">–û–±—â–∏–π –≤–µ—Å (–∫–≥)</p>
              <p className="text-lg font-bold text-yellow-900">
                {statistics?.total_weight || 0}
              </p>
            </div>
            <Package2 className="h-5 w-5 text-yellow-600" />
          </div>
        </div>
      </div>
    );
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∫–ª–∞–¥–∞ –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é
  const fetchWarehouseStatisticsLazy = async (warehouseId) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
    if (warehousesStatistics[warehouseId]) {
      return warehousesStatistics[warehouseId];
    }
    
    try {
      console.log(`üìä –ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∫–ª–∞–¥–∞: ${warehouseId}`);
      const stats = await apiCall(`/api/warehouses/${warehouseId}/statistics`, 'GET');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –æ–±—â–∏–π –æ–±—ä–µ–∫—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
      setWarehousesStatistics(prev => ({
        ...prev,
        [warehouseId]: stats
      }));
      
      return stats;
    } catch (error) {
      console.error(`Error loading statistics for warehouse ${warehouseId}:`, error);
      return null;
    }
  };

  const fetchWarehouses = async () => {
    try {
      console.log('üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ —Å–∫–ª–∞–¥–æ–≤...');
      const startTime = performance.now();
      
      const data = await apiCall('/api/warehouses', 'GET');
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: API –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –ø—Ä—è–º–æ–π –º–∞—Å—Å–∏–≤ —Å–∫–ª–∞–¥–æ–≤, –∞ –Ω–µ –æ–±—ä–µ–∫—Ç —Å –ø–æ–ª–µ–º warehouses
      const warehousesArray = Array.isArray(data) ? data : (data.warehouses || []);
      setWarehouses(warehousesArray);
      
      const endTime = performance.now();
      console.log(`‚úÖ –ó–∞–≥—Ä—É–∂–µ–Ω–æ ${warehousesArray.length} —Å–∫–ª–∞–¥–æ–≤ –∑–∞ ${Math.round(endTime - startTime)}ms`);
      
      // –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –£–±—Ä–∞–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫—É—é –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –¥–ª—è –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤
      // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é (lazy loading)
      console.log('‚ö° –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∫–ª–∞–¥–æ–≤ –±—É–¥–µ—Ç –∑–∞–≥—Ä—É–∂–∞—Ç—å—Å—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏');
      
    } catch (error) {
      console.error('Error fetching warehouses:', error);
      setWarehouses([]);
    }
  };

  const fetchAvailableCargoForPlacement = async (page = availableCargoPage, perPage = availableCargoPerPage) => {
    try {
      const params = {
        page: page,
        per_page: perPage
      };
      
      const response = await apiCall('/api/operator/cargo/available-for-placement', 'GET', null, params);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
      if (response.items) {
        // –§–∏–ª—å—Ç—Ä—É–µ–º –Ω–µ–≤–∞–ª–∏–¥–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è React –æ—à–∏–±–æ–∫
        const validItems = response.items.filter(item => item && item.id);
        setAvailableCargoForPlacement(validItems);
        setAvailableCargoPagination(response.pagination);
      } else {
        // –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º
        const cargoData = response.cargo_list || response || [];
        const validItems = cargoData.filter(item => item && item.id);
        setAvailableCargoForPlacement(validItems);
        setAvailableCargoPagination({});
      }
    } catch (error) {
      console.error('Error fetching available cargo for placement:', error);
      setAvailableCargoForPlacement([]);
      setAvailableCargoPagination({});
    }
  };

  // –ü–†–û–ë–õ–ï–ú–ê 3: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫
  const fetchFullyPlacedCargo = async (page = 1, perPage = 25) => {
    try {
      setFullyPlacedLoading(true);
      console.log('üì¶ –ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫...');
      
      const response = await apiCall(`/api/operator/cargo/fully-placed?page=${page}&per_page=${perPage}`);
      
      console.log('‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –ø–æ–ª—É—á–µ–Ω—ã:', response);
      
      setFullyPlacedCargo(response.items || []);
      setFullyPlacedPagination(response.pagination || {});
      setFullyPlacedPage(page);
      setFullyPlacedPerPage(perPage);
      
      console.log(`üìä –ù–∞–π–¥–µ–Ω–æ ${response.items?.length || 0} –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫`);
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫', 'error');
      setFullyPlacedCargo([]);
    } finally {
      setFullyPlacedLoading(false);
    }
  };

  // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∞
  useEffect(() => {
    if (user && (user.role === 'admin' || user.role === 'warehouse_operator')) {
      fetchFullyPlacedCargo();
    }
  }, [user]);

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤ –¥–ª—è –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é
  const fetchMenuCounters = async () => {
    try {
      console.log('üìä –ó–∞–≥—Ä—É–∑–∫–∞ —Å—á–µ—Ç—á–∏–∫–æ–≤ –¥–ª—è –±–æ–∫–æ–≤–æ–≥–æ –º–µ–Ω—é...');
      
      const counters = {
        cargo_placement: 0,
        cargo_pickup_list: 0,
        cargo_history: 0,
        couriers_list: 0,
        couriers_inactive: 0,
        warehouses_list: 0,
        warehouses_placed_cargo: 0,
        notifications_orders: newOrdersCount || 0,
        notifications_requests: 0,
        notifications_system: 0,
        cashier_unpaid: 0,
        cashier_history: 0,
        logistics_transport: 0,
        logistics_in_transit: 0,
        logistics_arrived: 0,
        finances_transactions: 0,
        placement_progress: placementProgress?.progress_text || '0/0'
      };

      // –ó–∞–≥—Ä—É–∂–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—á–µ—Ç—á–∏–∫–∏
      if (user?.role === 'admin' || user?.role === 'warehouse_operator') {
        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤ (–ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏)
        if (fullyPlacedCargo?.length) {
          counters.warehouses_placed_cargo = fullyPlacedCargo.length;
        }
        
        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–∑–æ–≤ –≥–æ—Ç–æ–≤—ã—Ö –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é
        if (availableCargoForPlacement?.length) {
          counters.cargo_placement = availableCargoForPlacement.length;
        }
        
        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞—è–≤–æ–∫ –Ω–∞ –∑–∞–±–æ—Ä
        if (allPickupRequests?.length) {
          counters.cargo_pickup_list = allPickupRequests.length;
        }
        
        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å–∫–ª–∞–¥–æ–≤
        if (warehouses?.length) {
          counters.warehouses_list = warehouses.length;
        }
        
        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∫—É—Ä—å–µ—Ä–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤)
        if (user?.role === 'admin' && couriers?.length) {
          const activeCouriers = couriers.filter(c => !c.deleted && c.is_active !== false);
          const inactiveCouriers = couriers.filter(c => c.deleted || c.is_active === false);
          counters.couriers_list = activeCouriers.length;
          counters.couriers_inactive = inactiveCouriers.length;
        }
        
        // –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –∑–∞–∫–∞–∑–æ–≤
        if (unpaidCargo?.length) {
          counters.cashier_unpaid = unpaidCargo.length;
        }
        
        // –ü—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
        if (placementProgress?.progress_text) {
          counters.placement_progress = placementProgress.progress_text;
        }
      }

      setMenuCounters(counters);
      console.log('‚úÖ –°—á–µ—Ç—á–∏–∫–∏ –º–µ–Ω—é –æ–±–Ω–æ–≤–ª–µ–Ω—ã:', counters);
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—á–µ—Ç—á–∏–∫–æ–≤ –º–µ–Ω—é:', error);
    }
  };

  // –û–±–Ω–æ–≤–ª—è–µ–º —Å—á–µ—Ç—á–∏–∫–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
  useEffect(() => {
    if (user && (user.role === 'admin' || user.role === 'warehouse_operator')) {
      fetchMenuCounters();
    }
  }, [
    fullyPlacedCargo,
    availableCargoForPlacement, 
    allPickupRequests,
    warehouses,
    couriers,
    unpaidCargo,
    newOrdersCount,
    placementProgress,
    user
  ]);

  // –§–£–ù–ö–¶–ò–Ø: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –¥–ª—è –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é
  const getMenuCounter = (itemId) => {
    const counterMap = {
      'cargo-placement': menuCounters.cargo_placement,
      'cargo-pickup-list': menuCounters.cargo_pickup_list,
      'cargo-history': menuCounters.cargo_history,
      'couriers-tracking-list': menuCounters.couriers_list,
      'couriers-inactive': menuCounters.couriers_inactive,
      'warehouses-list': menuCounters.warehouses_list,
      'warehouses-placed-cargo': menuCounters.warehouses_placed_cargo || 0,
      'notifications-client-orders': menuCounters.notifications_orders,
      'notifications-requests': menuCounters.notifications_requests,
      'notifications-system': menuCounters.notifications_system,
      'cashier-unpaid': menuCounters.cashier_unpaid,
      'cashier-history': menuCounters.cashier_history,
      'logistics-transport-list': menuCounters.logistics_transport,
      'logistics-in-transit': menuCounters.logistics_in_transit,
      'logistics-arrived': menuCounters.logistics_arrived,
      'finances-transactions': menuCounters.finances_transactions,
      'operations-placement': menuCounters.placement_progress
    };
    
    return counterMap[itemId] || 0;
  };

  // –§–£–ù–ö–¶–ò–Ø: –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—á–µ—Ç—á–∏–∫–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
  const formatCounter = (counter) => {
    if (typeof counter === 'string') return counter; // –î–ª—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
    if (counter === 0) return null; // –ù–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –Ω–æ–ª—å
    if (counter > 99) return '99+'; // –ú–∞–∫—Å–∏–º—É–º 99+
    return counter.toString();
  };

  // –£–õ–£–ß–®–ï–ù–ò–ï: –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –æ–±—â–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const fetchPlacementProgress = async () => {
    try {
      console.log('üìä –£–õ–£–ß–®–ï–ù–ò–ï: –ü–æ–ª—É—á–µ–Ω–∏–µ –æ–±—â–µ–≥–æ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è...');
      
      const response = await apiCall('/api/operator/placement-progress', 'GET');
      
      console.log('‚úÖ –ü—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –ø–æ–ª—É—á–µ–Ω:', response);
      
      setPlacementProgress({
        total_units: response.total_units || 0,
        placed_units: response.placed_units || 0,
        pending_units: response.pending_units || 0,
        progress_percentage: response.progress_percentage || 0,
        progress_text: response.progress_text || '–†–∞–∑–º–µ—â–µ–Ω–æ: 0/0',
        last_updated: response.last_updated
      });
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:', error);
      // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      setPlacementProgress({
        total_units: 0,
        placed_units: 0,
        pending_units: 0,
        progress_percentage: 0,
        progress_text: '–†–∞–∑–º–µ—â–µ–Ω–æ: 0/0',
        last_updated: null
      });
    }
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–æ–ª—É—á–µ–Ω–∏–µ individual units –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const fetchIndividualUnitsForPlacement = async (
    page = individualUnitsPage, 
    perPage = individualUnitsPerPage,
    cargoType = cargoTypeFilter,
    status = placementStatusFilter
  ) => {
    try {
      console.log('üîÑ –ó–∞–≥—Ä—É–∑–∫–∞ individual units –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è...');
      
      const params = {
        page: page,
        per_page: perPage
      };
      
      // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –µ—Å–ª–∏ –æ–Ω–∏ —É–∫–∞–∑–∞–Ω—ã
      if (cargoType) {
        params.cargo_type_filter = cargoType;
      }
      if (status) {
        params.status_filter = status;
      }
      
      const response = await apiCall('/api/operator/cargo/individual-units-for-placement', 'GET', null, params);
      
      console.log('‚úÖ Individual units –ø–æ–ª—É—á–µ–Ω—ã:', response);
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ
      setIndividualUnitsForPlacement(response.individual_units || []);
      setGroupedUnitsForPlacement(response.items || []);
      setIndividualUnitsPagination({
        total: response.total || 0,
        page: response.page || 1,
        per_page: response.per_page || 25,
        total_pages: response.total_pages || 1
      });
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è individual units:', error);
      setIndividualUnitsForPlacement([]);
      setGroupedUnitsForPlacement([]);
      setIndividualUnitsPagination({});
      showAlert(`–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
    }
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –¥–ª—è —Å–ø–∏—Å–∫–∞ –≥—Ä—É–∑–æ–≤
  const handleOperatorCargoPageChange = (newPage) => {
    setOperatorCargoPage(newPage);
    fetchOperatorCargo(operatorCargoFilter, newPage, operatorCargoPerPage);
  };

  const handleOperatorCargoPerPageChange = (newPerPage) => {
    const perPage = parseInt(newPerPage);
    setOperatorCargoPerPage(perPage);
    setOperatorCargoPage(1); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    fetchOperatorCargo(operatorCargoFilter, 1, perPage);
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
  const handleUsersPageChange = (newPage) => {
    setUsersPage(newPage);
    fetchUsers(newPage, usersPerPage);
  };

  const handleUsersPerPageChange = (newPerPage) => {
    const perPage = parseInt(newPerPage);
    setUsersPerPage(perPage);
    setUsersPage(1); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
    fetchUsers(1, perPage);
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–æ–≤
  const handleAvailableCargoPageChange = (newPage) => {
    setAvailableCargoPage(newPage);
    fetchAvailableCargoForPlacement(newPage, availableCargoPerPage);
  };

  const handleAvailableCargoPerPageChange = (newPerPage) => {
    const perPage = parseInt(newPerPage);
    setAvailableCargoPerPage(perPage);
    setAvailableCargoPage(1);
    fetchAvailableCargoForPlacement(1, perPage);
  };

  // –ù–û–í–´–ï: –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –¥–ª—è individual units
  const handleIndividualUnitsPageChange = (newPage) => {
    setIndividualUnitsPage(newPage);
    fetchIndividualUnitsForPlacement(newPage, individualUnitsPerPage, cargoTypeFilter, placementStatusFilter);
  };

  const handleIndividualUnitsPerPageChange = (newPerPage) => {
    const perPage = parseInt(newPerPage);
    setIndividualUnitsPerPage(perPage);
    setIndividualUnitsPage(1);
    fetchIndividualUnitsForPlacement(1, perPage, cargoTypeFilter, placementStatusFilter);
  };

  // –ù–û–í–´–ï: –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ñ–∏–ª—å—Ç—Ä–æ–≤
  const handleCargoTypeFilterChange = (newFilter) => {
    setCargoTypeFilter(newFilter);
    setIndividualUnitsPage(1);
    fetchIndividualUnitsForPlacement(1, individualUnitsPerPage, newFilter, placementStatusFilter);
  };

  const handlePlacementStatusFilterChange = (newFilter) => {
    setPlacementStatusFilter(newFilter);
    setIndividualUnitsPage(1);
    fetchIndividualUnitsForPlacement(1, individualUnitsPerPage, cargoTypeFilter, newFilter);
  };

  const fetchWarehouseLayoutWithCargo = async (warehouseId) => {
    try {
      console.log('Fetching warehouse layout for ID:', warehouseId);
      const response = await apiCall(`/api/warehouses/${warehouseId}/layout-with-cargo`);
      console.log('Warehouse layout response:', response);
      setWarehouseLayout(response);
      setSelectedWarehouseForLayout(warehouseId);
    } catch (error) {
      console.error('Error fetching warehouse layout with cargo:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ö–µ–º—ã —Å–∫–ª–∞–¥–∞: ' + error.message, 'error');
    }
  };

  const handleCargoMove = async () => {
    if (!selectedCargoForWarehouse) return;
    
    try {
      const moveData = {
        cargo_id: selectedCargoForWarehouse.id,
        from_block: selectedCargoForWarehouse.block_number,
        from_shelf: selectedCargoForWarehouse.shelf_number,
        from_cell: selectedCargoForWarehouse.cell_number,
        to_block: cargoMoveForm.to_block,
        to_shelf: cargoMoveForm.to_shelf,
        to_cell: cargoMoveForm.to_cell
      };

      const response = await apiCall(`/api/warehouses/${selectedWarehouseForLayout}/move-cargo`, 'POST', moveData);
      
      showAlert(`–ì—Ä—É–∑ ${response.cargo_number} —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω —Å ${response.old_location} –Ω–∞ ${response.new_location}`, 'success');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ö–µ–º—É —Å–∫–ª–∞–¥–∞
      fetchWarehouseLayoutWithCargo(selectedWarehouseForLayout);
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      setCargoMoveModal(false);
      setSelectedCargoForWarehouse(null);
      setCargoMoveForm({
        to_block: 1,
        to_shelf: 1,
        to_cell: 1
      });
      
    } catch (error) {
      console.error('Error moving cargo:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –≥—Ä—É–∑–∞: ' + error.message, 'error');
    }
  };

  const handleCleanupTestData = async () => {
    if (!confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –í–°–ï —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ —Å–∏—Å—Ç–µ–º—ã:\n- –¢–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π\n- –¢–µ—Å—Ç–æ–≤—ã–µ –≥—Ä—É–∑—ã –∏ –∑–∞—è–≤–∫–∏\n- –°–≤—è–∑–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è\n- –î–∞–Ω–Ω—ã–µ –æ —è—á–µ–π–∫–∞—Ö\n\n–î–µ–π—Å—Ç–≤–∏–µ –ù–ï–û–ë–†–ê–¢–ò–ú–û!\n\n–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?')) {
      return;
    }
    
    try {
      const response = await apiCall('/api/admin/cleanup-test-data', 'POST');
      
      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—ã–π –æ—Ç—á–µ—Ç –æ–± –æ—á–∏—Å—Ç–∫–µ
      const report = response.cleanup_report;
      const summaryMessage = `
üßπ –û—á–∏—Å—Ç–∫–∞ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞–≤–µ—Ä—à–µ–Ω–∞!

üìä –û—Ç—á–µ—Ç –æ–± —É–¥–∞–ª–µ–Ω–∏–∏:
‚Ä¢ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏: ${report.users_deleted}
‚Ä¢ –ó–∞—è–≤–∫–∏ –Ω–∞ –≥—Ä—É–∑—ã: ${report.cargo_requests_deleted}  
‚Ä¢ –ì—Ä—É–∑—ã –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤: ${report.operator_cargo_deleted}
‚Ä¢ –ì—Ä—É–∑—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π: ${report.user_cargo_deleted}
‚Ä¢ –ù–µ–æ–ø–ª–∞—á–µ–Ω–Ω—ã–µ –∑–∞–∫–∞–∑—ã: ${report.unpaid_orders_deleted}
‚Ä¢ –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: ${report.notifications_deleted}
‚Ä¢ –Ø—á–µ–π–∫–∏ —Å–∫–ª–∞–¥–∞: ${report.warehouse_cells_deleted}

–í—Ä–µ–º—è –æ—á–∏—Å—Ç–∫–∏: ${new Date(response.cleanup_time).toLocaleString('ru-RU')}
      `.trim();
      
      showAlert(summaryMessage, 'success');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
      fetchOperatorCargo(operatorCargoFilter, operatorCargoPage, operatorCargoPerPage);
      fetchAvailableCargoForPlacement(availableCargoPage, availableCargoPerPage);
      fetchUsersByRole();
      fetchNotifications();
      fetchUnpaidCargo();
      
    } catch (error) {
      console.error('Error cleaning test data:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—á–∏—Å—Ç–∫–µ —Ç–µ—Å—Ç–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö: ' + error.message, 'error');
    }
  };

  const handleQuickPlacement = async (cargoId) => {
    try {
      const response = await apiCall(`/api/cargo/${cargoId}/quick-placement`, 'POST', quickPlacementForm);
      showAlert(`–ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω: ${response.location}`, 'success');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
      fetchOperatorCargo(operatorCargoFilter);
      fetchAvailableCargoForPlacement();
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω—ã–µ –æ–∫–Ω–∞
      setQuickPlacementModal(false);
      setSelectedCargoForDetailView(null);
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
      setQuickPlacementForm({
        block_number: 1,
        shelf_number: 1,
        cell_number: 1
      });
    } catch (error) {
      console.error('Error placing cargo:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ –≥—Ä—É–∑–∞: ' + error.message, 'error');
    }
  };

  const handlePaymentAcceptance = async (cargoId, cargoNumber) => {
    try {
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –Ω–∞ –æ–ø–ª–∞—á–µ–Ω–æ
      await apiCall(`/api/cargo/${cargoId}/processing-status`, 'PUT', { new_status: 'paid' });
      
      showAlert(`‚úÖ –û–ø–ª–∞—Ç–∞ –ø—Ä–∏–Ω—è—Ç–∞ –¥–ª—è –≥—Ä—É–∑–∞ ${cargoNumber}`, 'success');
      showAlert('üì¶ –ì—Ä—É–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ —Ä–∞–∑–¥–µ–ª "–û–∂–∏–¥–∞–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ"', 'info');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å–ø–∏—Å–∫–∏ –∏ —Å—Ç–∞—Ç—É—Å—ã –≤–æ –í–°–ï–• —Ç–∞–±–ª–∏—Ü–∞—Ö –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö
      fetchOperatorCargo(operatorCargoFilter);
      fetchAvailableCargoForPlacement();
      fetchAllCargo(); // –ê–¥–º–∏–Ω—Å–∫–∏–π —Å–ø–∏—Å–æ–∫
      fetchUnpaidCargo(); // –ö–∞—Å—Å–∞
      fetchPaymentHistory(); // –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
      fetchPlacedCargo(); // –†–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã
      
    } catch (error) {
      console.error('Error accepting payment:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–∏–Ω—è—Ç–∏–∏ –æ–ø–ª–∞—Ç—ã: ' + error.message, 'error');
    }
  };

  // –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –ø–æ —Å–∫–ª–∞–¥–∞–º
  const fetchWarehouseAnalytics = async () => {
    try {
      const data = await apiCall('/api/warehouses/analytics');
      setWarehouseAnalytics(data);
      return data;
    } catch (error) {
      console.error('Error fetching warehouse analytics:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å–∫–ª–∞–¥–æ–≤', 'error');
      return null;
    }
  };

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —è—á–µ–µ–∫ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è (—Å—Ç–∞—Ä—ã–π –º–µ—Ç–æ–¥ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏)
  const fetchAvailableCellsForEnhancedPlacement = async (warehouseId, blockNumber, shelfNumber) => {
    try {
      const data = await apiCall(`/api/warehouses/${warehouseId}/available-cells/${blockNumber}/${shelfNumber}`);
      setAvailableCellsForPlacement(data.available_cells || []);
      return data.available_cells || [];
    } catch (error) {
      console.error('Error fetching available cells:', error);
      setAvailableCellsForPlacement([]);
      return [];
    }
  };

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–∫–ª–∞–¥–∞
  const fetchWarehouseDetailedStructure = async (warehouseId) => {
    setStructureLoading(true);
    try {
      const data = await apiCall(`/api/warehouses/${warehouseId}/detailed-structure`);
      setWarehouseDetailedStructure(data);
      return data;
    } catch (error) {
      console.error('Error fetching warehouse detailed structure:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–∫–ª–∞–¥–∞', 'error');
      return null;
    } finally {
      setStructureLoading(false);
    }
  };

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —Å–∫–ª–∞–¥–∞ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è —Å –∑–∞–≥—Ä—É–∑–∫–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
  const handleWarehouseSelectionForPlacement = async (warehouseId) => {
    setSelectedWarehouseForPlacement(warehouseId);
    setSelectedBlockForPlacement(1);
    setSelectedShelfForPlacement(1);
    setSelectedCellForPlacement(1);
    setSelectedCellForVisualization(null);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–∫–ª–∞–¥–∞
    await fetchWarehouseDetailedStructure(warehouseId);
    
    // –¢–∞–∫–∂–µ –∑–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
    await fetchAvailableCellsForEnhancedPlacement(warehouseId, 1, 1);
  };

  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —è—á–µ–π–∫–∏
  const isCellAvailable = (blockNumber, shelfNumber, cellNumber) => {
    if (!warehouseDetailedStructure) return true;
    
    const block = warehouseDetailedStructure.blocks?.find(b => b.block_number === blockNumber);
    if (!block) return true;
    
    const shelf = block.shelves?.find(s => s.shelf_number === shelfNumber);
    if (!shelf) return true;
    
    const cell = shelf.cells?.find(c => c.cell_number === cellNumber);
    return cell?.status === 'available';
  };

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ —è—á–µ–π–∫–∏
  const getCellInfo = (blockNumber, shelfNumber, cellNumber) => {
    if (!warehouseDetailedStructure) return null;
    
    const block = warehouseDetailedStructure.blocks?.find(b => b.block_number === blockNumber);
    if (!block) return null;
    
    const shelf = block.shelves?.find(s => s.shelf_number === shelfNumber);
    if (!shelf) return null;
    
    const cell = shelf.cells?.find(c => c.cell_number === cellNumber);
    return cell;
  };

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ –±–ª–æ–∫–∞ –∏ –ø–æ–ª–∫–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —è—á–µ–µ–∫
  const handleBlockShelfSelection = async (blockNumber, shelfNumber) => {
    setSelectedBlockForPlacement(blockNumber);
    setSelectedShelfForPlacement(shelfNumber);
    
    if (selectedWarehouseForPlacement) {
      // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ —è—á–µ–π–∫–∏ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
      await fetchAvailableCellsForEnhancedPlacement(selectedWarehouseForPlacement, blockNumber, shelfNumber);
      
      // –ù–∞—Ö–æ–¥–∏–º –ø–µ—Ä–≤—É—é –¥–æ—Å—Ç—É–ø–Ω—É—é —è—á–µ–π–∫—É –≤ –≤—ã–±—Ä–∞–Ω–Ω–æ–º –±–ª–æ–∫–µ/–ø–æ–ª–∫–µ
      if (warehouseDetailedStructure) {
        const block = warehouseDetailedStructure.blocks?.find(b => b.block_number === blockNumber);
        const shelf = block?.shelves?.find(s => s.shelf_number === shelfNumber);
        const firstAvailableCell = shelf?.cells?.find(c => c.status === 'available');
        
        if (firstAvailableCell) {
          setSelectedCellForPlacement(firstAvailableCell.cell_number);
        } else {
          // –ï—Å–ª–∏ –Ω–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —è—á–µ–µ–∫, –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—É—é
          setSelectedCellForPlacement(1);
        }
      } else {
        setSelectedCellForPlacement(1);
      }
    }
  };

  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—ã–±–æ—Ä–∞ —è—á–µ–π–∫–∏ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
  const handleCellSelection = (cellNumber) => {
    const cellInfo = getCellInfo(selectedBlockForPlacement, selectedShelfForPlacement, cellNumber);
    
    if (cellInfo && cellInfo.status === 'occupied') {
      showAlert('–≠—Ç–∞ —è—á–µ–π–∫–∞ –∑–∞–Ω—è—Ç–∞! –í—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–±–æ–¥–Ω—É—é —è—á–µ–π–∫—É.', 'error');
      return;
    }
    
    setSelectedCellForPlacement(cellNumber);
    setSelectedCellForVisualization({
      block: selectedBlockForPlacement,
      shelf: selectedShelfForPlacement,
      cell: cellNumber,
      info: cellInfo
    });
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏
  const handleEnhancedCargoPlacement = async () => {
    if (!selectedCargoForEnhancedPlacement || !selectedWarehouseForPlacement) {
      showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–∑ –∏ —Å–∫–ª–∞–¥ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è', 'error');
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤—ã–±—Ä–∞–Ω–Ω–æ–π —è—á–µ–π–∫–∏
    const isCellFree = isCellAvailable(selectedBlockForPlacement, selectedShelfForPlacement, selectedCellForPlacement);
    if (!isCellFree) {
      showAlert('–í—ã–±—Ä–∞–Ω–Ω–∞—è —è—á–µ–π–∫–∞ –∑–∞–Ω—è—Ç–∞! –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–≤–æ–±–æ–¥–Ω—É—é —è—á–µ–π–∫—É.', 'error');
      return;
    }

    setPlacementLoading(true);
    try {
      const response = await apiCall('/api/operator/cargo/place', 'POST', {
        cargo_id: selectedCargoForEnhancedPlacement.id,
        warehouse_id: selectedWarehouseForPlacement,
        block_number: selectedBlockForPlacement,
        shelf_number: selectedShelfForPlacement,
        cell_number: selectedCellForPlacement
      });

      showAlert(
        `‚úÖ –ì—Ä—É–∑ ${selectedCargoForEnhancedPlacement.cargo_number} —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω –≤ ${response.warehouse_name} (–ë–ª–æ–∫ ${selectedBlockForPlacement}, –ü–æ–ª–∫–∞ ${selectedShelfForPlacement}, –Ø—á–µ–π–∫–∞ ${selectedCellForPlacement})`,
        'success'
      );

      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
      setEnhancedPlacementModal(false);
      setSelectedCargoForEnhancedPlacement(null);

      // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ —Å–ø–∏—Å–∫–∏
      fetchAvailableCargoForPlacement(); // –£–±–∏—Ä–∞–µ–º –∏–∑ "–û–∂–∏–¥–∞–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ"
      fetchPlacedCargo(); // –î–æ–±–∞–≤–ª—è–µ–º –≤ "–†–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã"
      fetchOperatorCargo(operatorCargoFilter);
      
    } catch (error) {
      console.error('Enhanced placement error:', error);
      showAlert('–û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞: ' + error.message, 'error');
    } finally {
      setPlacementLoading(false);
    }
  };

  // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
  const openEnhancedPlacementModal = async (cargo) => {
    setSelectedCargoForEnhancedPlacement(cargo);
    setEnhancedPlacementModal(true);
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∞–Ω–∞–ª–∏—Ç–∏–∫—É —Å–∫–ª–∞–¥–æ–≤
    await fetchWarehouseAnalytics();
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—ã–±–æ—Ä
    setSelectedWarehouseForPlacement('');
    setSelectedBlockForPlacement(1);
    setSelectedShelfForPlacement(1);
    setSelectedCellForPlacement(1);
    setAvailableCellsForPlacement([]);
  };

  // –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ø–∏—Å–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤
  const fetchPlacedCargo = async (page = placedCargoPage, perPage = placedCargoPerPage) => {
    try {
      const params = {
        page: page,
        per_page: perPage
        // –£–±–∏—Ä–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä status - backend —Ç–µ–ø–µ—Ä—å —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç —Å–∞–º
      };
      
      const response = await apiCall('/api/warehouses/placed-cargo', 'GET', null, params);
      
      if (response.items) {
        setPlacedCargoList(response.items);
        setPlacedCargoPagination(response.pagination);
      } else {
        setPlacedCargoList(response.cargo_list || response);
        setPlacedCargoPagination({});
      }
    } catch (error) {
      console.error('Error fetching placed cargo:', error);
      setPlacedCargoList([]);
      setPlacedCargoPagination({});
    }
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤
  const handlePlacedCargoPageChange = (newPage) => {
    setPlacedCargoPage(newPage);
    fetchPlacedCargo(newPage, placedCargoPerPage);
  };

  const handlePlacedCargoPerPageChange = (newPerPage) => {
    const perPage = parseInt(newPerPage);
    setPlacedCargoPerPage(perPage);
    setPlacedCargoPage(1);
    fetchPlacedCargo(1, perPage);
  };

  // ===== –§–£–ù–ö–¶–ò–ò –ú–ê–°–°–û–í–û–ì–û –£–î–ê–õ–ï–ù–ò–Ø =====

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Å–∫–ª–∞–¥–∞–º–∏
  const handleWarehouseSelect = (warehouseId, isSelected) => {
    if (isSelected) {
      setSelectedWarehouses(prev => [...prev, warehouseId]);
    } else {
      setSelectedWarehouses(prev => prev.filter(id => id !== warehouseId));
    }
  };

  const handleSelectAllWarehouses = (isSelected) => {
    setSelectAllWarehouses(isSelected);
    if (isSelected) {
      const allIds = warehouses.map(warehouse => warehouse.id);
      setSelectedWarehouses(allIds);
    } else {
      setSelectedWarehouses([]);
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –≥—Ä—É–∑–∞–º–∏
  const handleCargoSelect = (cargoId, isSelected) => {
    if (isSelected) {
      setSelectedCargo(prev => [...prev, cargoId]);
    } else {
      setSelectedCargo(prev => prev.filter(id => id !== cargoId));
    }
  };

  const handleSelectAllCargo = (isSelected, cargoList) => {
    setSelectAllCargo(isSelected);
    if (isSelected) {
      const allIds = cargoList.map(cargo => cargo.id);
      setSelectedCargo(allIds);
    } else {
      setSelectedCargo([]);
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –∑–∞—è–≤–∫–∞–º–∏ –Ω–∞ –∑–∞–±–æ—Ä
  const handlePickupRequestSelect = (requestId, isSelected) => {
    if (isSelected) {
      setSelectedPickupRequests(prev => [...prev, requestId]);
    } else {
      setSelectedPickupRequests(prev => prev.filter(id => id !== requestId));
    }
  };

  const handleSelectAllPickupRequests = (isSelected, requestList) => {
    setSelectAllPickupRequests(isSelected);
    if (isSelected) {
      const allIds = requestList.map(request => request.id);
      setSelectedPickupRequests(allIds);
    } else {
      setSelectedPickupRequests([]);
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏
  const handleUserSelect = (userId, isSelected) => {
    if (isSelected) {
      setSelectedUsers(prev => [...prev, userId]);
    } else {
      setSelectedUsers(prev => prev.filter(id => id !== userId));
    }
  };

  const handleSelectAllUsers = (isSelected, userList) => {
    setSelectAllUsers(isSelected);
    if (isSelected) {
      const allIds = userList.map(user => user.id).filter(id => id !== user.id); // –ò—Å–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      setSelectedUsers(allIds);
    } else {
      setSelectedUsers([]);
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –∑–∞—è–≤–∫–∞–º–∏
  const handleRequestSelect = (requestId, isSelected) => {
    if (isSelected) {
      setSelectedRequests(prev => [...prev, requestId]);
    } else {
      setSelectedRequests(prev => prev.filter(id => id !== requestId));
    }
  };

  const handleSelectAllRequests = (isSelected, requestList) => {
    setSelectAllRequests(isSelected);
    if (isSelected) {
      const allIds = requestList.map(request => request.id);
      setSelectedRequests(allIds);
    } else {
      setSelectedRequests([]);
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏
  const handleOperatorSelect = (operatorId, isSelected) => {
    if (isSelected) {
      setSelectedOperators(prev => [...prev, operatorId]);
    } else {
      setSelectedOperators(prev => prev.filter(id => id !== operatorId));
    }
  };

  const handleSelectAllOperators = (isSelected, operatorList) => {
    setSelectAllOperators(isSelected);
    if (isSelected) {
      const allIds = operatorList.map(operator => operator.id).filter(id => id !== user.id); // –ò—Å–∫–ª—é—á–∞–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      setSelectedOperators(allIds);
    } else {
      setSelectedOperators([]);
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≤—ã–±—Ä–∞–Ω–Ω—ã–º–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞–º–∏
  const handleTransportSelect = (transportId, isSelected) => {
    if (isSelected) {
      setSelectedTransports(prev => [...prev, transportId]);
    } else {
      setSelectedTransports(prev => prev.filter(id => id !== transportId));
    }
  };

  const handleSelectAllTransports = (isSelected, transportList) => {
    setSelectAllTransports(isSelected);
    if (isSelected) {
      const allIds = transportList.map(transport => transport.id);
      setSelectedTransports(allIds);
    } else {
      setSelectedTransports([]);
    }
  };

  // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è
  const openDeleteConfirmModal = (type, items, isBulk = false) => {
    setDeleteConfirmData({
      type,
      items: isBulk ? items : [items],
      isBulk,
      count: isBulk ? items.length : 1
    });
    setDeleteConfirmModal(true);
  };

  // –§—É–Ω–∫—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è –æ—Ç–¥–µ–ª—å–Ω—ã—Ö —ç–ª–µ–º–µ–Ω—Ç–æ–≤
  const handleDeleteWarehouse = async (warehouseId) => {
    const warehouse = warehouses.find(w => w.id === warehouseId);
    openDeleteConfirmModal('warehouse', warehouse, false);
  };

  const handleDeleteCargo = async (cargoId, cargoList) => {
    const cargo = cargoList.find(c => c.id === cargoId);
    openDeleteConfirmModal('cargo', cargo, false);
  };

  const handleDeleteUser = async (userId, userList) => {
    const userToDelete = userList.find(u => u.id === userId);
    openDeleteConfirmModal('user', userToDelete, false);
  };

  // –§—É–Ω–∫—Ü–∏–∏ –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
  const handleBulkDeleteWarehouses = () => {
    if (selectedWarehouses.length === 0) {
      showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
      return;
    }
    openDeleteConfirmModal('warehouse', selectedWarehouses, true);
  };

  const handleBulkDeleteCargo = (cargoList) => {
    if (selectedCargo.length === 0) {
      showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –≥—Ä—É–∑—ã –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
      return;
    }
    const selectedCargoItems = cargoList.filter(c => selectedCargo.includes(c.id));
    openDeleteConfirmModal('cargo', selectedCargoItems, true);
  };

  const handleBulkDeleteUsers = (userList) => {
    if (selectedUsers.length === 0) {
      showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
      return;
    }
    const selectedUserItems = userList.filter(u => selectedUsers.includes(u.id));
    openDeleteConfirmModal('user', selectedUserItems, true);
  };

  // –§—É–Ω–∫—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞—è–≤–æ–∫
  const handleDeleteRequest = async (requestId) => {
    const request = cargoRequests.find(r => r.id === requestId);
    openDeleteConfirmModal('request', request, false);
  };

  const handleBulkDeleteRequests = () => {
    if (selectedRequests.length === 0) {
      showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫–∏ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
      return;
    }
    const selectedRequestItems = cargoRequests.filter(r => selectedRequests.includes(r.id));
    openDeleteConfirmModal('request', selectedRequestItems, true);
  };

  // –§—É–Ω–∫—Ü–∏–∏ —É–¥–∞–ª–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
  const handleDeleteOperator = async (operatorId) => {
    const operator = usersByRole.warehouse_operator.find(o => o.id === operatorId);
    openDeleteConfirmModal('operator', operator, false);
  };

  const handleBulkDeleteOperators = () => {
    if (selectedOperators.length === 0) {
      showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
      return;
    }
    const selectedOperatorItems = usersByRole.warehouse_operator.filter(o => selectedOperators.includes(o.id));
    openDeleteConfirmModal('operator', selectedOperatorItems, true);
  };

  // –§—É–Ω–∫—Ü–∏—è –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
  const handleBulkDeleteTransports = () => {
    if (selectedTransports.length === 0) {
      showAlert('–í—ã–±–µ—Ä–∏—Ç–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è', 'error');
      return;
    }
    const selectedTransportItems = transports.filter(t => selectedTransports.includes(t.id));
    openDeleteConfirmModal('transport', selectedTransportItems, true);
  };

  // –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–∏—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  const executeDelete = async () => {
    if (!deleteConfirmData) return;
    
    setBulkDeleteLoading(true);
    try {
      const { type, items, isBulk } = deleteConfirmData;
      
      if (type === 'warehouse') {
        if (isBulk) {
          const ids = items.map(warehouse => warehouse.id);
          const response = await apiCall('/api/admin/warehouses/bulk', 'DELETE', { ids });
          showAlert(response.message, response.errors?.length > 0 ? 'warning' : 'success');
          if (response.errors?.length > 0) {
            response.errors.forEach(error => showAlert(error, 'error'));
          }
        } else {
          const response = await apiCall(`/api/admin/warehouses/${items[0].id}`, 'DELETE');
          showAlert(response.message, 'success');
        }
        setSelectedWarehouses([]);
        setSelectAllWarehouses(false);
        fetchWarehouses();
      }
      
      else if (type === 'cargo') {
        if (isBulk) {
          const ids = items.map(cargo => cargo.id);
          const response = await apiCall('/api/admin/cargo/bulk', 'DELETE', { ids });
          showAlert(response.message, 'success');
        } else {
          const response = await apiCall(`/api/admin/cargo/${items[0].id}`, 'DELETE');
          showAlert(response.message, 'success');
        }
        setSelectedCargo([]);
        setSelectAllCargo(false);
        fetchAllCargo();
        fetchOperatorCargo();
      }
      
      else if (type === 'pickup-request') {
        if (isBulk) {
          const ids = items.map(request => request.id);
          const response = await apiCall('/api/admin/pickup-requests/bulk', 'DELETE', { ids });
          showAlert(response.message, response.errors?.length > 0 ? 'warning' : 'success');
          if (response.errors?.length > 0) {
            response.errors.forEach(error => showAlert(error, 'error'));
          }
        } else {
          const response = await apiCall(`/api/admin/pickup-requests/${items[0].id}`, 'DELETE');
          showAlert(response.message, 'success');
        }
        setSelectedPickupRequests([]);
        setSelectAllPickupRequests(false);
        fetchAllPickupRequests();
      }
      
      else if (type === 'user') {
        if (isBulk) {
          const ids = items.map(user => user.id);
          const response = await apiCall('/api/admin/users/bulk', 'DELETE', { ids });
          showAlert(response.message, 'success');
          if (response.warnings?.length > 0) {
            response.warnings.forEach(warning => showAlert(warning, 'warning'));
          }
        } else {
          const response = await apiCall(`/api/admin/users/${items[0].id}`, 'DELETE');
          showAlert(response.message, response.warning ? 'warning' : 'success');
        }
        setSelectedUsers([]);
        setSelectAllUsers(false);
        fetchUsers();
      }

      else if (type === 'request') {
        if (isBulk) {
          const ids = items.map(request => request.id);
          const response = await apiCall('/api/admin/cargo-applications/bulk', 'DELETE', { ids });
          showAlert(response.message, 'success');
        } else {
          const response = await apiCall(`/api/admin/cargo-applications/${items[0].id}`, 'DELETE');
          showAlert(response.message, 'success');
        }
        setSelectedRequests([]);
        setSelectAllRequests(false);
        fetchCargoRequests();
      }

      else if (type === 'operator') {
        if (isBulk) {
          const ids = items.map(operator => operator.id);
          const response = await apiCall('/api/admin/operators/bulk', 'DELETE', { ids });
          showAlert(response.message, 'success');
          if (response.warnings?.length > 0) {
            response.warnings.forEach(warning => showAlert(warning, 'warning'));
          }
        } else {
          const response = await apiCall(`/api/admin/operators/${items[0].id}`, 'DELETE');
          showAlert(response.message, response.warning ? 'warning' : 'success');
        }
        setSelectedOperators([]);
        setSelectAllOperators(false);
        fetchUsersByRole(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
      }

      else if (type === 'transport') {
        if (isBulk) {
          const ids = items.map(transport => transport.id);
          const response = await apiCall('/api/admin/transports/bulk', 'DELETE', { ids });
          showAlert(response.message, response.errors?.length > 0 ? 'warning' : 'success');
          if (response.errors?.length > 0) {
            response.errors.forEach(error => showAlert(error, 'error'));
          }
        } else {
          try {
            // –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º —Å—Ç—Ä–æ–≥–∏–π endpoint (—Ç–æ–ª—å–∫–æ –ø—É—Å—Ç—ã–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ã)
            const response = await apiCall(`/api/admin/transports/${items[0].id}`, 'DELETE');
            showAlert(response.message, 'success');
          } catch (error) {
            // –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –≥—Ä—É–∑, –ø—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ
            if (error.message.includes('—Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è') || error.message.includes('–≥—Ä—É–∑')) {
              const transport = items[0];
              const forceDelete = window.confirm(
                `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç "${transport.transport_number}" —Å–æ–¥–µ—Ä–∂–∏—Ç –≥—Ä—É–∑!\n\n` +
                `${error.message}\n\n` +
                `–•–æ—Ç–∏—Ç–µ –ü–†–ò–ù–£–î–ò–¢–ï–õ–¨–ù–û —É–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç?\n` +
                `‚ö†Ô∏è –ì–†–£–ó –ë–£–î–ï–¢ –ü–ï–†–ï–ú–ï–©–ï–ù –í –°–¢–ê–¢–£–° "–ë–µ–∑ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞"\n\n` +
                `–ù–∞–∂–º–∏—Ç–µ –û–ö –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∏–ª–∏ –û—Ç–º–µ–Ω–∞ –¥–ª—è –æ—Ç–∫–∞–∑–∞.`
              );
              
              if (forceDelete) {
                try {
                  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–µ–Ω–µ–µ —Å—Ç—Ä–æ–≥–∏–π endpoint –¥–ª—è –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è
                  const forceResponse = await apiCall(`/api/transport/${items[0].id}`, 'DELETE');
                  showAlert(`–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç "${transport.transport_number}" –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ —É–¥–∞–ª–µ–Ω. ${forceResponse.message}`, 'warning');
                } catch (forceError) {
                  showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è: ${forceError.message}`, 'error');
                  return; // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –æ—à–∏–±–∫–µ
                }
              } else {
                showAlert('–£–¥–∞–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'info');
                return; // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
              }
            } else {
              showAlert(`–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞: ${error.message}`, 'error');
              return; // –ù–µ –∑–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            }
          }
        }
        setSelectedTransports([]);
        setSelectAllTransports(false);
        fetchTransports(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
        setTransportManagementModal(false); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –µ—Å–ª–∏ –±—ã–ª–æ –æ—Ç–∫—Ä—ã—Ç–æ
      }
      
      else if (type === 'cargo-placement') {
        try {
          if (isBulk) {
            const ids = items.map(cargo => cargo.id);
            const response = await apiCall('/api/operator/cargo/bulk-remove-from-placement', 'DELETE', {
              cargo_ids: ids
            });
            if (response.success) {
              showAlert(`${response.deleted_count} –≥—Ä—É–∑–æ–≤ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–æ –∏–∑ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è`, 'success');
              
              // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –ü–ï–†–ï–î –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º —Å–ø–∏—Å–∫–æ–≤
              setSelectedCargoForDeletion([]);
              
              // –û–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Å–ø–∏—Å–∫–∏ –≥—Ä—É–∑–æ–≤ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è (—Å —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
              setTimeout(async () => {
                try {
                  await Promise.all([
                    fetchAvailableCargoForPlacement(),
                    fetchAllCargo(),
                    fetchOperatorCargo(),
                    fetchUnpaidCargo(),
                    fetchPaymentHistory(),
                    fetchPlacedCargo()
                  ]);
                  
                  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä –æ—Ç–¥–µ–ª—å–Ω–æ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
                  setTimeout(() => {
                    fetchAllPickupRequests();
                  }, 1000);
                } catch (error) {
                  console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤:', error);
                }
              }, 800);
            } else {
              showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –º–∞—Å—Å–æ–≤–æ–º —É–¥–∞–ª–µ–Ω–∏–∏: ${response.message}`, 'error');
            }
          } else {
            const response = await apiCall(`/api/operator/cargo/${items[0].id}/remove-from-placement`, 'DELETE');
            if (response.success) {
              showAlert(`–ì—Ä—É–∑ ${items[0].cargo_number} —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω –∏–∑ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è`, 'success');
              
              // –û–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Å–ø–∏—Å–∫–∏ –≥—Ä—É–∑–æ–≤ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è (—Å —É–≤–µ–ª–∏—á–µ–Ω–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏)
              setTimeout(async () => {
                try {
                  await Promise.all([
                    fetchAvailableCargoForPlacement(),
                    fetchAllCargo(),
                    fetchOperatorCargo(),
                    fetchUnpaidCargo(),
                    fetchPaymentHistory(),
                    fetchPlacedCargo()
                  ]);
                  
                  // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä –æ—Ç–¥–µ–ª—å–Ω–æ —Å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–¥–µ—Ä–∂–∫–æ–π
                  setTimeout(() => {
                    fetchAllPickupRequests();
                  }, 1000);
                } catch (error) {
                  console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–æ–≤:', error);
                }
              }, 800);
            } else {
              showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –≥—Ä—É–∑–∞: ${response.message}`, 'error');
            }
          }
        } catch (error) {
          console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–∑–∞:', error);
          showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ${error.message}`, 'error');
        }
      }
      
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ç–æ–ª—å–∫–æ –ü–û–°–õ–ï –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
      setTimeout(() => {
        setDeleteConfirmModal(false);
        setDeleteConfirmData(null);
      }, 100);
      
    } catch (error) {
      console.error('Delete error:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ' + error.message, 'error');
    } finally {
      setBulkDeleteLoading(false);
    }
  };

  const updateCargoProcessingStatus = async (cargoId, newStatus) => {
    try {
      await apiCall(`/api/cargo/${cargoId}/processing-status`, 'PUT', { new_status: newStatus });
      showAlert(`–°—Ç–∞—Ç—É—Å –≥—Ä—É–∑–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω: ${getProcessingStatusLabel(newStatus)}`, 'success');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –í–°–ï —Å–ø–∏—Å–∫–∏ –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å—Ç–∞—Ç—É—Å–æ–≤ –≤–æ –≤—Å–µ—Ö —Ç–∞–±–ª–∏—Ü–∞—Ö –∏ –∫–∞—Ç–µ–≥–æ—Ä–∏—è—Ö
      fetchOperatorCargo(operatorCargoFilter, operatorCargoPage, operatorCargoPerPage);
      fetchAvailableCargoForPlacement(availableCargoPage, availableCargoPerPage);
      fetchAllCargo(); // –ê–¥–º–∏–Ω—Å–∫–∏–π —Å–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤
      fetchUnpaidCargo(); // –ö–∞—Å—Å–∞ - –Ω–µ–æ–ø–ª–∞—á–µ–Ω–æ
      fetchPaymentHistory(); // –ò—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
      fetchPlacedCargo(); // –†–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã
      
      // –ï—Å–ª–∏ –≥—Ä—É–∑ —Å—Ç–∞–ª –æ–ø–ª–∞—á–µ–Ω–Ω—ã–º, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏
      if (newStatus === 'paid') {
        showAlert('–ì—Ä—É–∑ –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ —Ä–∞–∑–¥–µ–ª "–û–∂–∏–¥–∞–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ"', 'info');
      }
      // –ï—Å–ª–∏ –≥—Ä—É–∑ —Ä–∞–∑–º–µ—â–µ–Ω, –ø–µ—Ä–µ–º–µ—â–∞–µ–º –≤ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ
      else if (newStatus === 'placed') {
        showAlert('–ì—Ä—É–∑ –ø–µ—Ä–µ–º–µ—â–µ–Ω –≤ —Ä–∞–∑–¥–µ–ª "–†–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã"', 'info');
      }
    } catch (error) {
      console.error('Error updating cargo processing status:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –≥—Ä—É–∑–∞: ' + error.message, 'error');
    }
  };

  const getProcessingStatusLabel = (status) => {
    const labels = {
      'payment_pending': '–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã',
      'paid': '–û–ø–ª–∞—á–µ–Ω',
      'invoice_printed': '–ù–∞–∫–ª–∞–¥–Ω–∞—è –Ω–∞–ø–µ—á–∞—Ç–∞–Ω–∞',
      'placed': '–†–∞–∑–º–µ—â–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥–µ'
    };
    return labels[status] || status;
  };

  const getProcessingStatusBadgeVariant = (status) => {
    const variants = {
      'payment_pending': 'destructive',
      'paid': 'default',
      'invoice_printed': 'secondary',
      'placed': 'outline'
    };
    return variants[status] || 'outline';
  };

  const fetchOperatorCargo = async (filterStatus = 'all', page = operatorCargoPage, perPage = operatorCargoPerPage) => {
    try {
      const params = { 
        page: page,
        per_page: perPage
      };
      
      // –¢–æ–ª—å–∫–æ –¥–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –µ—Å–ª–∏ —ç—Ç–æ –Ω–µ "all" (–≤—Å–µ –≥—Ä—É–∑—ã)
      if (filterStatus && filterStatus !== 'all') {
        params.filter_status = filterStatus;
      }
      
      const response = await apiCall('/api/operator/cargo/list', 'GET', null, params);
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–æ–≤—ã–π —Ñ–æ—Ä–º–∞—Ç –æ—Ç–≤–µ—Ç–∞ —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
      if (response.items) {
        setOperatorCargo(response.items);
        setOperatorCargoPagination(response.pagination);
      } else {
        // –û–±—Ä–∞—Ç–Ω–∞—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å —Å–æ —Å—Ç–∞—Ä—ã–º —Ñ–æ—Ä–º–∞—Ç–æ–º
        setOperatorCargo(response.cargo_list || response);
        setOperatorCargoPagination({});
      }
    } catch (error) {
      console.error('Error fetching operator cargo:', error);
      setOperatorCargo([]);
      setOperatorCargoPagination({});
    }
  };

  const fetchAvailableCargo = async () => {
    try {
      const data = await apiCall('/api/operator/cargo/available');
      setAvailableCargo(data);
    } catch (error) {
      console.error('Error fetching available cargo:', error);
    }
  };

  const fetchCargoHistory = async () => {
    try {
      const params = new URLSearchParams();
      if (historyFilters.status && historyFilters.status !== 'all') {
        params.append('status', historyFilters.status);
      }
      if (historyFilters.search) {
        params.append('search', historyFilters.search);
      }
      const data = await apiCall(`/api/operator/cargo/history?${params}`);
      setCargoHistory(data);
    } catch (error) {
      console.error('Error fetching cargo history:', error);
    }
  };

  const fetchAvailableCells = async (warehouseId) => {
    try {
      const data = await apiCall(`/api/warehouses/${warehouseId}/available-cells`);
      setAvailableCells(data.available_cells || []);
    } catch (error) {
      console.error('Error fetching available cells:', error);
    }
  };

  const fetchUnpaidCargo = async () => {
    try {
      const data = await apiCall('/api/cashier/unpaid-cargo');
      setUnpaidCargo(data);
    } catch (error) {
      console.error('Error fetching unpaid cargo:', error);
    }
  };

  const fetchPaymentHistory = async () => {
    try {
      const data = await apiCall('/api/cashier/payment-history');
      setPaymentHistory(data);
    } catch (error) {
      console.error('Error fetching payment history:', error);
    }
  };

  const fetchUsersByRole = async () => {
    try {
      const roles = ['user', 'admin', 'warehouse_operator'];
      const usersByRoleData = {};
      
      for (const role of roles) {
        const data = await apiCall(`/api/admin/users/by-role/${role}`);
        usersByRoleData[role] = data;
      }
      
      setUsersByRole(usersByRoleData);
    } catch (error) {
      console.error('Error fetching users by role:', error);
    }
  };

  const fetchWarehouseLayout = async (warehouseId) => {
    try {
      const data = await apiCall(`/api/warehouses/${warehouseId}/full-layout`);
      setWarehouseLayout(data);
    } catch (error) {
      console.error('Error fetching warehouse layout:', error);
    }
  };

  const fetchCargoRequests = async () => {
    try {
      const data = await apiCall('/api/admin/cargo-requests');
      setCargoRequests(data);
      setPendingOrders(data); // –¢–∞–∫–∂–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞
    } catch (error) {
      console.error('Error fetching cargo requests:', error);
    }
  };

  const fetchMyRequests = async () => {
    try {
      const data = await apiCall('/api/user/my-requests');
      setMyRequests(data);
    } catch (error) {
      console.error('Error fetching my requests:', error);
    }
  };

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ó–ê–ö–ê–ó–ê–ú–ò –ö–õ–ò–ï–ù–¢–û–í

  const fetchNewOrdersCount = async () => {
    try {
      const data = await apiCall('/api/admin/new-orders-count');
      setNewOrdersCount(data.pending_orders);
    } catch (error) {
      console.error('Error fetching new orders count:', error);
    }
  };

  const fetchOrderDetails = async (orderId) => {
    try {
      const data = await apiCall(`/api/admin/cargo-requests/${orderId}`);
      setSelectedOrder(data);
      return data;
    } catch (error) {
      console.error('Error fetching order details:', error);
      return null;
    }
  };

  const handleOrderDetailsView = async (order) => {
    const details = await fetchOrderDetails(order.id);
    if (details) {
      setOrderDetailsModal(true);
    }
  };

  const handleOrderEdit = async (order) => {
    const details = await fetchOrderDetails(order.id);
    if (details) {
      // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Ñ–æ—Ä–º—É —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –¥–∞–Ω–Ω—ã–º–∏ –∑–∞–∫–∞–∑–∞
      setOrderEditForm({
        sender_full_name: details.sender_full_name || '',
        sender_phone: details.sender_phone || '',
        recipient_full_name: details.recipient_full_name || '',
        recipient_phone: details.recipient_phone || '',
        recipient_address: details.recipient_address || '',
        pickup_address: details.pickup_address || '',
        cargo_name: details.cargo_name || '',
        weight: details.weight || '',
        declared_value: details.declared_value || '',
        description: details.description || '',
        route: details.route || '',
        admin_notes: details.admin_notes || ''
      });
      setEditOrderModal(true);
    }
  };

  const handleSaveOrderChanges = async () => {
    try {
      const updateData = { ...orderEditForm };
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å —á–∏—Å–ª–æ–≤—ã–µ –ø–æ–ª—è
      if (updateData.weight) updateData.weight = parseFloat(updateData.weight);
      if (updateData.declared_value) updateData.declared_value = parseFloat(updateData.declared_value);

      await apiCall(`/api/admin/cargo-requests/${selectedOrder.id}/update`, 'PUT', updateData);
      
      showAlert('–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
      setEditOrderModal(false);
      
      // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
      fetchCargoRequests();
      fetchNewOrdersCount();
      
    } catch (error) {
      console.error('Error updating order:', error);
      showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
    }
  };

  const handleAcceptOrder = async (orderId) => {
    try {
      await apiCall(`/api/admin/cargo-requests/${orderId}/accept`, 'POST');
      showAlert('–ó–∞–∫–∞–∑ –ø—Ä–∏–Ω—è—Ç –∏ –≥—Ä—É–∑ —Å–æ–∑–¥–∞–Ω!', 'success');
      
      // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
      fetchCargoRequests();
      fetchNewOrdersCount();
      fetchAllCargo();
      setOrderDetailsModal(false);
      
    } catch (error) {
      console.error('Error accepting order:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞–∫–∞–∑–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
    }
  };

  const handleRejectOrder = async (orderId, reason = '') => {
    try {
      await apiCall(`/api/admin/cargo-requests/${orderId}/reject`, 'POST', { reason });
      showAlert('–ó–∞–∫–∞–∑ –æ—Ç–∫–ª–æ–Ω–µ–Ω!', 'success');
      
      // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
      fetchCargoRequests();
      fetchNewOrdersCount();
      setOrderDetailsModal(false);
      
    } catch (error) {
      console.error('Error rejecting order:', error);
      showAlert('–û—à–∏–±–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞: ' + (error.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'), 'error');
    }
  };

  // Transport functions
  const fetchTransports = async (status = null) => {
    try {
      const params = status ? `?status=${status}` : '';
      const data = await apiCall(`/api/transport/list${params}`);
      setTransports(data);
    } catch (error) {
      console.error('Error fetching transports:', error);
    }
  };

  const fetchTransportCargoList = async (transportId) => {
    try {
      const data = await apiCall(`/api/transport/${transportId}/cargo-list`);
      setTransportCargoList(data);
    } catch (error) {
      console.error('Error fetching transport cargo list:', error);
    }
  };

  const fetchAvailableCargoForTransport = async () => {
    try {
      // –ü–æ–ª—É—á–∏—Ç—å –≥—Ä—É–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ –Ω–∞—Ö–æ–¥—è—Ç—Å—è –Ω–∞ —Å–∫–ª–∞–¥–µ –∏ –≥–æ—Ç–æ–≤—ã –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏
      const data = await apiCall('/api/operator/cargo/available');
      setAvailableCargoForTransport(data.filter(cargo => 
        cargo.status === 'accepted' && cargo.warehouse_location
      ));
    } catch (error) {
      console.error('Error fetching available cargo for transport:', error);
    }
  };

  const handleCreateTransport = async (e) => {
    e.preventDefault();
    try {
      await apiCall('/api/transport/create', 'POST', {
        ...transportForm,
        capacity_kg: parseFloat(transportForm.capacity_kg)
      });
      showAlert('–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω!', 'success');
      setTransportForm({
        driver_name: '',
        driver_phone: '',
        transport_number: '',
        capacity_kg: '',
        direction: ''
      });
      fetchTransports();
    } catch (error) {
      console.error('Create transport error:', error);
    }
  };

  const handlePlaceCargoOnTransport = async (transportId, cargoNumbers) => {
    try {
      if (!cargoNumbers || cargoNumbers.length === 0) {
        showAlert('–ù–µ —É–∫–∞–∑–∞–Ω—ã –Ω–æ–º–µ—Ä–∞ –≥—Ä—É–∑–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è', 'error');
        return;
      }

      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–æ–º–µ—Ä–∞ –≥—Ä—É–∑–æ–≤ –Ω–∞–ø—Ä—è–º—É—é, –±–µ–∑ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏—è –≤ ID
      await apiCall(`/api/transport/${transportId}/place-cargo`, 'POST', {
        transport_id: transportId,
        cargo_numbers: cargoNumbers
      });
      
      showAlert(`–ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ! (${cargoNumbers.length} –º–µ—Å—Ç)`, 'success');
      fetchTransports();
      fetchTransportCargoList(transportId);
      fetchAvailableCargoForTransport(); // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –≥—Ä—É–∑–æ–≤
      setSelectedCargoForPlacement([]);
    } catch (error) {
      console.error('Place cargo on transport error:', error);
      // –ü–æ–∫–∞–∑–∞—Ç—å –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω—É—é –æ—à–∏–±–∫—É –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
      const errorMessage = error.response?.data?.detail || error.message || '–û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞';
      showAlert(errorMessage, 'error');
    }
  };

  const handleDispatchTransport = async (transportId) => {
    if (window.confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —ç—Ç–æ—Ç —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç?')) {
      try {
        await apiCall(`/api/transport/${transportId}/dispatch`, 'POST');
        showAlert('–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!', 'success');
        fetchTransports();
        setTransportManagementModal(false);
      } catch (error) {
        console.error('Dispatch transport error:', error);
      }
    }
  };

  const handleDeleteTransport = async (transportId) => {
    const transport = transports.find(t => t.id === transportId);
    if (transport) {
      openDeleteConfirmModal('transport', transport, false);
    } else {
      showAlert('–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
    }
  };

  // Contact functions
  const handleWhatsAppContact = () => {
    // –û—Ç–∫—Ä—ã—Ç—å WhatsApp —Å –ø—Ä–µ–¥—É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º —Å–æ–æ–±—â–µ–Ω–∏–µ–º
    const phoneNumber = "79123456789"; // –ù–æ–º–µ—Ä —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏
    const message = "–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –£ –º–µ–Ω—è –µ—Å—Ç—å –≤–æ–ø—Ä–æ—Å –ø–æ –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∞–º TAJLINE.TJ";
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
  };

  const handleTelegramContact = () => {
    // –û—Ç–∫—Ä—ã—Ç—å Telegram
    const telegramUsername = "tajline_support"; // Username —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏
    const telegramUrl = `https://t.me/${telegramUsername}`;
    window.open(telegramUrl, '_blank');
  };

  const handleOnlineChat = () => {
    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –∏–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –æ–Ω–ª–∞–π–Ω —á–∞—Ç (–Ω–∞–ø—Ä–∏–º–µ—Ä, Tawk.to, Intercom, –∏–ª–∏ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–µ —Ä–µ—à–µ–Ω–∏–µ)
    showAlert('–û–Ω–ª–∞–π–Ω —á–∞—Ç –≤—Ä–µ–º–µ–Ω–Ω–æ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ WhatsApp –∏–ª–∏ Telegram.', 'info');
    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ –º–æ–∂–Ω–æ –æ—Ç–∫—Ä—ã—Ç—å —Ñ–æ—Ä–º—É –æ–±—Ä–∞—Ç–Ω–æ–π —Å–≤—è–∑–∏
  };

  // Search functions
  const handleSearch = async (query) => {
    if (!query || query.length < 2) {
      setSearchResults([]);
      setShowSearchResults(false);
      setShowSuggestions(false);
      return;
    }

    try {
      const results = await apiCall(`/api/cargo/search?query=${encodeURIComponent(query)}&search_type=${searchType}`);
      // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—Å–µ–≥–¥–∞ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º
      setSearchResults(Array.isArray(results) ? results : []);
      setShowSearchResults(true);
      setShowSuggestions(false);
    } catch (error) {
      console.error('Search error:', error);
      setSearchResults([]);
      setShowSearchResults(false);
    }
  };

  // Advanced search function
  const handleAdvancedSearch = async (query = searchQuery, filters = searchFilters) => {
    setSearchLoading(true);
    try {
      // Convert "any" values back to empty strings for API
      const processedFilters = { ...filters };
      if (processedFilters.cargo_status === 'any') processedFilters.cargo_status = '';
      if (processedFilters.payment_status === 'any') processedFilters.payment_status = '';
      if (processedFilters.route === 'any') processedFilters.route = '';
      
      const searchRequest = {
        query: query.trim(),
        search_type: searchType,
        ...processedFilters
      };

      const response = await apiCall('/api/search/advanced', 'POST', searchRequest);
      
      setSearchResults(Array.isArray(response.results) ? response.results : []);
      setShowSearchResults(true);
      setShowSuggestions(false);
      setSearchTime(response.search_time_ms);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è –¥–ª—è –∞–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏—è
      if (response.suggestions && response.suggestions.length > 0) {
        setSearchSuggestions(response.suggestions);
      }
      
    } catch (error) {
      console.error('Advanced search error:', error);
      setSearchResults([]);
      setShowSearchResults(false);
      setSearchTime(0);
    } finally {
      setSearchLoading(false);
    }
  };

  // Autocomplete suggestions
  const handleSearchInput = async (value) => {
    setSearchQuery(value);
    
    if (value.length >= 2) {
      try {
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π –ø–æ–∏—Å–∫ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π
        const response = await apiCall('/api/search/advanced', 'POST', {
          query: value.trim(),
          search_type: searchType,
          per_page: 5
        });
        
        if (response.suggestions && response.suggestions.length > 0) {
          setSearchSuggestions(response.suggestions);
          setShowSuggestions(true);
        } else {
          setShowSuggestions(false);
        }
      } catch (error) {
        setShowSuggestions(false);
      }
    } else {
      setShowSuggestions(false);
      setSearchSuggestions([]);
    }
  };

  const selectSearchSuggestion = (suggestion) => {
    setSearchQuery(suggestion);
    setShowSuggestions(false);
    handleAdvancedSearch(suggestion);
  };

  // Profile management functions
  const fetchOperatorProfile = async (operatorId) => {
    setProfileLoading(true);
    try {
      const profile = await apiCall(`/api/admin/operators/profile/${operatorId}`, 'GET');
      setSelectedOperatorProfile(profile);
      setShowOperatorProfile(true);
    } catch (error) {
      console.error('Error fetching operator profile:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞', 'error');
    } finally {
      setProfileLoading(false);
    }
  };

  const fetchUserProfile = async (userId) => {
    setProfileLoading(true);
    try {
      const profile = await apiCall(`/api/admin/users/profile/${userId}`, 'GET');
      setSelectedUserProfile(profile);
      setFrequentRecipients(profile.frequent_recipients || []);
      setShowUserProfile(true);
    } catch (error) {
      console.error('Error fetching user profile:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è', 'error');
    } finally {
      setProfileLoading(false);
    }
  };

  // Quick cargo creation functions
  const openQuickCargoModal = (user) => {
    setQuickCargoForm({
      sender_id: user.id,
      recipient_data: {},
      cargo_items: [{ cargo_name: '', weight: '', price_per_kg: '' }],
      route: 'moscow_to_tajikistan',
      description: ''
    });
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —á–∞—Å—Ç—ã—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
    fetchUserProfile(user.id);
    setShowQuickCargoModal(true);
  };

  const selectRecipientFromHistory = (recipient) => {
    setSelectedRecipient(recipient);
    setQuickCargoForm({
      ...quickCargoForm,
      recipient_data: {
        recipient_full_name: recipient.recipient_full_name,
        recipient_phone: recipient.recipient_phone,
        recipient_address: recipient.recipient_address
      }
    });
  };

  const addQuickCargoItem = () => {
    setQuickCargoForm({
      ...quickCargoForm,
      cargo_items: [...quickCargoForm.cargo_items, { cargo_name: '', weight: '', price_per_kg: '' }]
    });
  };

  const removeQuickCargoItem = (index) => {
    if (quickCargoForm.cargo_items.length > 1) {
      const newItems = quickCargoForm.cargo_items.filter((_, i) => i !== index);
      setQuickCargoForm({
        ...quickCargoForm,
        cargo_items: newItems
      });
    }
  };

  const updateQuickCargoItem = (index, field, value) => {
    const newItems = [...quickCargoForm.cargo_items];
    newItems[index] = { ...newItems[index], [field]: value };
    setQuickCargoForm({
      ...quickCargoForm,
      cargo_items: newItems
    });
  };

  const calculateQuickCargoTotals = () => {
    const totalWeight = quickCargoForm.cargo_items.reduce((sum, item) => {
      return sum + (parseFloat(item.weight) || 0);
    }, 0);

    const totalCost = quickCargoForm.cargo_items.reduce((sum, item) => {
      const weight = parseFloat(item.weight) || 0;
      const price = parseFloat(item.price_per_kg) || 0;
      return sum + (weight * price);
    }, 0);

    return { totalWeight, totalCost };
  };

  const submitQuickCargo = async () => {
    try {
      const response = await apiCall(`/api/admin/users/${quickCargoForm.sender_id}/quick-cargo`, 'POST', quickCargoForm);
      showAlert('–ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è!', 'success');
      setShowQuickCargoModal(false);
      setShowUserProfile(false);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤
      fetchOperatorCargo();
      
    } catch (error) {
      console.error('Error creating quick cargo:', error);
      showAlert(error.message || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–∑–∞', 'error');
    }
  };

  const clearSearch = () => {
    setSearchQuery('');
    setSearchResults([]);
    setShowSearchResults(false);
  };

  // Operator-warehouse binding functions
  const fetchOperatorWarehouseBindings = async () => {
    try {
      const data = await apiCall('/api/admin/operator-warehouse-bindings');
      setOperatorWarehouseBindings(data);
    } catch (error) {
      console.error('Error fetching operator-warehouse bindings:', error);
    }
  };

  const handleCreateOperatorBinding = async () => {
    if (!selectedOperatorForBinding || !selectedWarehouseForBinding) {
      showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏ —Å–∫–ª–∞–¥ –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏', 'error');
      return;
    }

    try {
      await apiCall('/api/admin/operator-warehouse-binding', 'POST', {
        operator_id: selectedOperatorForBinding,
        warehouse_id: selectedWarehouseForBinding
      });
      showAlert('–ü—Ä–∏–≤—è–∑–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∫ —Å–∫–ª–∞–¥—É —Å–æ–∑–¥–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
      setOperatorBindingModal(false);
      setSelectedOperatorForBinding('');
      setSelectedWarehouseForBinding('');
      fetchOperatorWarehouseBindings();
    } catch (error) {
      console.error('Create operator binding error:', error);
      const errorMessage = error.response?.data?.detail || '–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–≤—è–∑–∫–∏';
      showAlert(errorMessage, 'error');
    }
  };

  // Warehouse cell and cargo detail functions
  const handleCellClick = async (warehouseId, locationCode) => {
    try {
      const cargoData = await apiCall(`/api/warehouse/${warehouseId}/cell/${locationCode}/cargo`);
      setSelectedCellCargo(cargoData);
      setCargoDetailModal(true);
    } catch (error) {
      if (error.response?.status === 404) {
        showAlert('–í —ç—Ç–æ–π —è—á–µ–π–∫–µ –Ω–µ—Ç –≥—Ä—É–∑–∞', 'info');
      } else {
        console.error('Error fetching cell cargo:', error);
        showAlert('–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥—Ä—É–∑–µ', 'error');
      }
    }
  };

  const fetchCargoDetails = async (cargoId) => {
    try {
      const cargoData = await apiCall(`/api/cargo/${cargoId}/details`);
      return cargoData;
    } catch (error) {
      console.error('Error fetching cargo details:', error);
      throw error;
    }
  };

  const handleEditCargo = (cargo) => {
    setEditingCargo(cargo);
    setCargoEditForm({
      cargo_name: cargo.cargo_name || '',
      description: cargo.description || '',
      weight: cargo.weight || '',
      declared_value: cargo.declared_value || '',
      sender_full_name: cargo.sender_full_name || '',
      sender_phone: cargo.sender_phone || '',
      recipient_full_name: cargo.recipient_full_name || cargo.recipient_name || '',
      recipient_phone: cargo.recipient_phone || '',
      recipient_address: cargo.recipient_address || ''
    });
    setCargoEditModal(true);
  };

  const handleUpdateCargo = async () => {
    if (!editingCargo) return;

    try {
      await apiCall(`/api/cargo/${editingCargo.id}/update`, 'PUT', cargoEditForm);
      showAlert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!', 'success');
      setCargoEditModal(false);
      setEditingCargo(null);
      
      // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
      if (selectedCellCargo && selectedCellCargo.id === editingCargo.id) {
        const updatedCargo = await fetchCargoDetails(editingCargo.id);
        setSelectedCellCargo(updatedCargo);
      }
      
      // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–∫–∏ –≥—Ä—É–∑–æ–≤
      fetchOperatorCargo();
      fetchAllCargo();
    } catch (error) {
      console.error('Update cargo error:', error);
    }
  };

  const handleMoveCargo = (cargo) => {
    setEditingCargo(cargo);
    setCargoMoveForm({
      warehouse_id: cargo.warehouse_id || '',
      block_number: cargo.block_number || '',
      shelf_number: cargo.shelf_number || '',
      cell_number: cargo.cell_number || ''
    });
    setCargoMoveModal(true);
  };

  const handleMoveCargoSubmit = async () => {
    if (!editingCargo) return;

    try {
      await apiCall(`/api/warehouse/cargo/${editingCargo.id}/move`, 'POST', cargoMoveForm);
      showAlert('–ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω!', 'success');
      setCargoMoveModal(false);
      setEditingCargo(null);
      
      // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
      fetchOperatorCargo();
      setCargoDetailModal(false);
    } catch (error) {
      console.error('Move cargo error:', error);
      const errorMessage = error.response?.data?.detail || '–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞';
      showAlert(errorMessage, 'error');
    }
  };

  const handleRemoveCargoFromCell = async (cargo) => {
    if (window.confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–∑ ${cargo.cargo_number} –∏–∑ —è—á–µ–π–∫–∏?`)) {
      try {
        await apiCall(`/api/warehouse/cargo/${cargo.id}/remove`, 'DELETE');
        showAlert('–ì—Ä—É–∑ —É–¥–∞–ª–µ–Ω –∏–∑ —è—á–µ–π–∫–∏!', 'success');
        setCargoDetailModal(false);
        fetchOperatorCargo();
      } catch (error) {
        console.error('Remove cargo error:', error);
      }
    }
  };

  // Print transport cargo list
  const printTransportCargoList = (transport, cargoList) => {
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
      return;
    }
    const totalWeight = cargoList.reduce((sum, cargo) => sum + cargo.weight, 0);
    
    printWindow.document.write(`
      <html>
        <head>
          <title>–°–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤ - ${transport.transport_number}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
            .header { text-align: center; margin-bottom: 20px; }
            .logo { font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 10px; }
            .company { font-size: 18px; margin-bottom: 5px; }
            .title { font-size: 16px; font-weight: bold; margin: 20px 0; }
            .info-section { margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; }
            .info-title { font-weight: bold; margin-bottom: 5px; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; font-weight: bold; }
            .summary { margin-top: 20px; padding: 10px; background-color: #f9f9f9; border: 1px solid #ddd; }
            .footer { margin-top: 30px; text-align: center; font-size: 10px; color: #666; }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="logo" style="text-align: center; margin-bottom: 10px;">
              <img src="/logo.png" alt="TAJLINE.TJ" style="height: 60px; width: auto; margin: 0 auto;" onerror="this.style.display='none'; this.nextSibling.style.display='block';" />
              <div style="display: none; font-size: 24px; font-weight: bold; color: #2563eb;">üì¶ TAJLINE.TJ</div>
            </div>
            <div class="company">–û–û–û "–¢–∞–¥–∂–ª–∞–π–Ω"</div>
            <div class="title">–°–ü–ò–°–û–ö –ì–†–£–ó–û–í –ù–ê –¢–†–ê–ù–°–ü–û–†–¢–ï</div>
          </div>

          <div class="info-section">
            <div class="info-title">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ</div>
            <p><strong>–ù–æ–º–µ—Ä —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞:</strong> ${transport.transport_number}</p>
            <p><strong>–í–æ–¥–∏—Ç–µ–ª—å:</strong> ${transport.driver_name}</p>
            <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è:</strong> ${transport.driver_phone}</p>
            <p><strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> ${transport.direction}</p>
            <p><strong>–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:</strong> ${transport.capacity_kg} –∫–≥</p>
            <p><strong>–î–∞—Ç–∞ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏—è:</strong> ${new Date().toLocaleDateString('ru-RU')} ${new Date().toLocaleTimeString('ru-RU')}</p>
          </div>

          <table>
            <thead>
              <tr>
                <th>‚Ññ</th>
                <th>–ù–æ–º–µ—Ä –≥—Ä—É–∑–∞</th>
                <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                <th>–í–µ—Å (–∫–≥)</th>
                <th>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</th>
                <th>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>
                <th>–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è</th>
                <th>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</th>
              </tr>
            </thead>
            <tbody>
              ${cargoList.map((cargo, index) => `
                <tr>
                  <td>${index + 1}</td>
                  <td><strong>${cargo.cargo_number}</strong></td>
                  <td>${cargo.cargo_name || '–ì—Ä—É–∑'}</td>
                  <td>${cargo.weight}</td>
                  <td>${cargo.sender_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}<br><small>${cargo.sender_phone || ''}</small></td>
                  <td>${cargo.recipient_full_name || cargo.recipient_name}</td>
                  <td>${cargo.recipient_phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                  <td>${cargo.recipient_address || '–ù–µ —É–∫–∞–∑–∞–Ω'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>

          <div class="summary">
            <p><strong>–í—Å–µ–≥–æ –≥—Ä—É–∑–æ–≤:</strong> ${cargoList.length} –º–µ—Å—Ç</p>
            <p><strong>–û–±—â–∏–π –≤–µ—Å:</strong> ${totalWeight} –∫–≥</p>
            <p><strong>–ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞:</strong> ${Math.round((totalWeight / transport.capacity_kg) * 100)}%</p>
            <p><strong>–û—Å—Ç–∞—Ç–æ–∫ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:</strong> ${transport.capacity_kg - totalWeight} –∫–≥</p>
          </div>

          <div class="footer">
            <p>–≠—Ç–æ—Ç –¥–æ–∫—É–º–µ–Ω—Ç —Å—Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∏—Å—Ç–µ–º–æ–π 
              <img src="/logo.png" alt="TAJLINE.TJ" style="height: 16px; width: auto; vertical-align: middle; margin: 0 5px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';" />
              <span style="display: none; font-weight: bold;">TAJLINE.TJ</span>
            </p>
            <p>–î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è: ${new Date().toLocaleDateString('ru-RU')} ${new Date().toLocaleTimeString('ru-RU')}</p>
          </div>
        </body>
      </html>
    `);
    
    printWindow.document.close();
    printWindow.print();
  };

  // Print invoice for individual cargo - TAJLINE format
  const printInvoice = (cargo) => {
    // –ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–∫—Ä—ã—Ç—å –Ω–æ–≤–æ–µ –æ–∫–Ω–æ
    const printWindow = window.open('', '_blank');
    if (!printWindow) {
      showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
      return;
    }
    
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —É–¥–∞–ª–æ—Å—å –ª–∏ –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ (–º–æ–∂–µ—Ç –±—ã—Ç—å –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ –±—Ä–∞—É–∑–µ—Ä–æ–º)
    if (!printWindow) {
      // –ï—Å–ª–∏ –æ–∫–Ω–æ –Ω–µ –æ—Ç–∫—Ä—ã–ª–æ—Å—å, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥
      showAlert('–í—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã. –ù–∞–∫–ª–∞–¥–Ω–∞—è –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç–∞ –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ.', 'warning');
      
      // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç –¥–ª—è –ø–µ—á–∞—Ç–∏
      const printContent = createInvoiceHTML(cargo);
      
      // –û—Ç–∫—Ä—ã–≤–∞–µ–º –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ —Å data URL
      const dataUrl = `data:text/html;charset=utf-8,${encodeURIComponent(printContent)}`;
      window.open(dataUrl, '_blank');
      return;
    }
    
    try {
      const invoiceHTML = createInvoiceHTML(cargo);
      printWindow.document.write(invoiceHTML);
      printWindow.document.close();
    } catch (error) {
      console.error('Error creating print window:', error);
      showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–∞–∫–ª–∞–¥–Ω–æ–π. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
      if (printWindow) {
        printWindow.close();
      }
    }
  };

  // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è HTML –¥–ª—è –Ω–∞–∫–ª–∞–¥–Ω–æ–π
  const createInvoiceHTML = (cargo) => {
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –≤ —Ñ–æ—Ä–º–∞—Ç–µ dd.mm.yy
    const currentDate = new Date().toLocaleDateString('ru-RU', {
      day: '2-digit',
      month: '2-digit',
      year: '2-digit'
    });
    
    // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –ø–æ –º–∞—Ä—à—Ä—É—Ç—É
    const getDestination = (route) => {
      switch(route) {
        case 'moscow_dushanbe': return '–î—É—à–∞–Ω–±–µ';
        case 'moscow_khujand': return '–•—É–¥–∂–∞–Ω–¥';
        case 'moscow_kulob': return '–ö—É–ª–æ–±';
        case 'moscow_kurgantyube': return '–ö—É—Ä–≥–∞–Ω-–¢—é–±–µ';
        default: return '–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω';
      }
    };
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä—É–∑–∞ –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã
    let cargoItems = [];
    if (cargo.cargo_items && Array.isArray(cargo.cargo_items)) {
      // –ú—É–ª—å—Ç–∏-–≥—Ä—É–∑
      cargoItems = cargo.cargo_items.map(item => ({
        name: item.cargo_name || '–¢–æ–≤–∞—Ä',
        quantity: item.weight || 0,
        unit: '–∫–≥',
        price: item.price_per_kg || 0,
        total: (item.weight || 0) * (item.price_per_kg || 0)
      }));
    } else {
      // –û–¥–∏–Ω–æ—á–Ω—ã–π –≥—Ä—É–∑
      cargoItems = [{
        name: cargo.cargo_name || cargo.description || '–¢–æ–≤–∞—Ä',
        quantity: cargo.weight || 0,
        unit: '–∫–≥', 
        price: cargo.price_per_kg || (cargo.total_cost || 0) / (cargo.weight || 1),
        total: cargo.total_cost || cargo.declared_value || 0
      }];
    }
    
    const totalWeight = cargoItems.reduce((sum, item) => sum + item.quantity, 0);
    const totalAmount = cargoItems.reduce((sum, item) => sum + item.total, 0);
    
    return `
      <html>
        <head>
          <title>–ù–∞–∫–ª–∞–¥–Ω–∞—è TAJLINE ‚Ññ ${cargo.cargo_number}</title>
          <meta charset="utf-8">
          <style>
            @page {
              size: A4;
              margin: 15mm;
            }
            
            body {
              font-family: Arial, sans-serif;
              margin: 0;
              padding: 0;
              font-size: 11px;
              line-height: 1.2;
              color: #000;
            }
            
            .invoice-container {
              max-width: 100%;
              margin: 0 auto;
            }
            
            .header {
              text-align: center;
              margin-bottom: 20px;
              border-bottom: 2px solid #000;
              padding-bottom: 15px;
            }
            
            .logo {
              font-size: 24px;
              font-weight: bold;
              letter-spacing: 2px;
              margin-bottom: 10px;
              color: #000;
            }
            
            .contacts {
              font-size: 9px;
              line-height: 1.3;
              color: #666;
              margin-bottom: 15px;
            }
            
            .invoice-number {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 15px;
            }
            
            .invoice-number .label {
              font-weight: bold;
              font-size: 12px;
            }
            
            .invoice-number .number-box,
            .invoice-number .date-box {
              border: 2px solid #000;
              padding: 8px 15px;
              font-weight: bold;
              font-size: 14px;
              min-width: 120px;
              text-align: center;
            }
            
            .info-row {
              display: flex;
              margin-bottom: 5px;
              border: 1px solid #000;
            }
            
            .info-cell {
              padding: 6px 8px;
              border-right: 1px solid #000;
              font-size: 10px;
            }
            
            .info-cell:last-child {
              border-right: none;
            }
            
            .info-cell.label {
              background-color: #f5f5f5;
              font-weight: bold;
              width: 15%;
              text-align: center;
            }
            
            .info-cell.wide {
              width: 35%;
            }
            
            .cargo-table {
              width: 100%;
              border-collapse: collapse;
              margin: 15px 0;
              border: 2px solid #000;
            }
            
            .cargo-table th,
            .cargo-table td {
              border: 1px solid #000;
              padding: 6px;
              text-align: center;
              font-size: 10px;
            }
            
            .cargo-table th {
              background-color: #f5f5f5;
              font-weight: bold;
            }
            
            .cargo-table .item-name {
              text-align: left;
            }
            
            .total-row {
              font-weight: bold;
              background-color: #f9f9f9;
            }
            
            .cargo-value {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin: 15px 0;
              font-weight: bold;
              font-size: 12px;
            }
            
            .signatures {
              margin-top: 30px;
              display: flex;
              justify-content: space-between;
            }
            
            .signature-block {
              width: 30%;
              text-align: center;
              border-bottom: 1px solid #000;
              padding-bottom: 2px;
              margin-bottom: 5px;
            }
            
            .signature-label {
              font-size: 9px;
              margin-top: 5px;
            }
            
            .terms {
              font-size: 8px;
              line-height: 1.3;
              margin-top: 20px;
              border-top: 1px solid #ccc;
              padding-top: 10px;
            }
            
            .terms p {
              margin: 5px 0;
              text-align: justify;
            }
            
            @media print {
              body { -webkit-print-color-adjust: exact; }
              .no-print { display: none !important; }
            }
          </style>
        </head>
        <body>
          <div class="invoice-container">
            <!-- Header -->
            <div class="header">
              <div class="logo">TAJLINE</div>
              <div class="contacts">
                <strong>–ù–∞—à–∏ –∫–æ–Ω—Ç–∞–∫—Ç—ã</strong><br>
                –ú–°–ö: (968) 658-8858<br>
                –ú–°–ö: (977) 904-8888<br>
                –°–∫–ª–∞–¥ –≤ –•—É–¥–∂–∞–Ω–¥–µ: +992 92 650 5001<br>
                –°–∫–ª–∞–¥ –≤ –•—É–¥–∂–∞–Ω–¥–µ: +992 92 913 2442<br>
                –°–∫–ª–∞–¥ –≤ –î—É—à–∞–Ω–±–µ: +992 91 868 3313
              </div>
            </div>
            
            <!-- Invoice Number and Date -->
            <div class="invoice-number">
              <span class="label">–ù–∞–∫–ª–∞–¥–Ω–∞—è ‚Ññ</span>
              <div class="number-box">${cargo.cargo_number || 'N/A'}</div>
              <span class="label">–æ—Ç</span>
              <div class="date-box">${currentDate}</div>
            </div>
            
            <!-- Destination -->
            <div class="info-row">
              <div class="info-cell label">–ü—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</div>
              <div class="info-cell" style="flex: 1; text-align: center; font-weight: bold;">
                ${getDestination(cargo.route)}
              </div>
            </div>
            
            <!-- Sender and Recipient -->
            <div class="info-row">
              <div class="info-cell label">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</div>
              <div class="info-cell wide">${cargo.sender_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
              <div class="info-cell label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</div>
              <div class="info-cell wide">${cargo.recipient_full_name || cargo.recipient_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
            </div>
            
            <div class="info-row">
              <div class="info-cell label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
              <div class="info-cell wide">${cargo.sender_phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
              <div class="info-cell label">–¢–µ–ª–µ—Ñ–æ–Ω</div>
              <div class="info-cell wide">${cargo.recipient_phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
            </div>
            
            <!-- Cargo Table -->
            <table class="cargo-table">
              <thead>
                <tr>
                  <th style="width: 5%;">‚Ññ</th>
                  <th style="width: 35%;">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</th>
                  <th style="width: 15%;">–ö–æ–ª-–≤–æ</th>
                  <th style="width: 10%;">–ï–¥.</th>
                  <th style="width: 15%;">–¶–µ–Ω–∞ –∑–∞ –∫–≥</th>
                  <th style="width: 20%;">–°—É–º–º–∞</th>
                </tr>
              </thead>
              <tbody>
                ${cargoItems.map((item, index) => `
                  <tr>
                    <td>${index + 1}</td>
                    <td class="item-name">${item.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</td>
                    <td>${item.quantity || 1}</td>
                    <td>${item.unit || '—à—Ç'}</td>
                    <td>${(parseFloat(item.price) || 0).toFixed(2)}</td>
                    <td>${(parseFloat(item.total) || 0).toFixed(2)}</td>
                  </tr>
                `).join('')}
                <tr class="total-row">
                  <td colspan="2"><strong>–ò—Ç–æ–≥–æ:</strong></td>
                  <td><strong>${totalWeight}</strong></td>
                  <td><strong>–∫–≥</strong></td>
                  <td></td>
                  <td><strong>${totalAmount.toFixed(2)} ‚ÇΩ</strong></td>
                </tr>
              </tbody>
            </table>
            
            <!-- Volume -->
            <div style="text-align: right; margin: 10px 0;">
              <span style="border: 1px solid #000; padding: 5px 10px;">
                –∫—É–±.–º
              </span>
            </div>
            
            <!-- Signatures -->
            <div class="signatures">
              <div>
                <div class="signature-block"></div>
                <div class="signature-label">–º.–ø.</div>
              </div>
              <div>
                <div class="signature-block"></div>
                <div class="signature-label"></div>
              </div>
              <div>
                <div class="signature-block">–ø–æ–¥–ø–∏—Å—å</div>
                <div class="signature-label"></div>
              </div>
            </div>
            
            <!-- Cargo Value -->
            <div class="cargo-value">
              <span>–¶–µ–Ω–Ω–æ—Å—Ç—å –≥—Ä—É–∑–∞:</span>
              <span>${cargo.declared_value || totalAmount.toFixed(0)} —Ä—É–±.</span>
            </div>
            
            <!-- Terms -->
            <div class="terms">
              <p><strong>–£—Å–ª–æ–≤–∏—è –ø–µ—Ä–µ–≤–æ–∑–∫–∏</strong></p>
              <p>1. –°—Ä–æ–∫ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–µ–º –≤ –ü—É–Ω–∫—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–æ—Å—Ç–∞–≤–ª—è–µ—Ç 5 —Ä–∞–±–æ—á–∏—Ö –¥–Ω–µ–π —Å –º–æ–º–µ–Ω—Ç–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± —É—Å–ø–µ—à–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–µ –≤ –ü—É–Ω–∫—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è. –ü—Ä–∏ –Ω–µ—Å–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω–æ–º –ø–æ–ª—É—á–µ–Ω–∏–∏ —Ç–æ–≤–∞—Ä–∞ –ó–∞–∫–∞–∑—á–∏–∫–æ–º –≤–æ–∑–Ω–∏–∫–∞–µ—Ç –æ–±—è–∑–∞–Ω–Ω–æ—Å—Ç—å –ó–∞–∫–∞–∑—á–∏–∫–∞ —É–ø–ª–∞—Ç–∏—Ç—å –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –ø–µ–Ω–∏ –≤ —Ä–∞–∑–º–µ—Ä–µ 0,1% –∑–∞ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å –ø—Ä–µ–≤—ã—à–µ–Ω–∏—è –°—Ä–æ–∫–∞ —Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞ –≤ –ü—É–Ω–∫—Ç–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</p>
              <p>2. –ü—Ä–∏ –≤–æ–∑–Ω–∏–∫–Ω–æ–≤–µ–Ω–∏–∏ –æ–±—Å—Ç–æ—è—Ç–µ–ª—å—Å—Ç–≤ –Ω–µ–ø—Ä–µ–æ–¥–æ–ª–∏–º–æ–π —Å–∏–ª—ã (—Ç–∞–∫–∏—Ö –∫–∞–∫: –ø–æ–∂–∞—Ä—ã, –Ω–∞–≤–æ–¥–Ω–µ–Ω–∏—è, –∑–µ–º–ª–µ—Ç—Ä—è—Å–µ–Ω–∏—è, –≤–æ–µ–Ω–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –∏ –ø—Ä.) –∏ –Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–æ–≤ –ó–∞–∫–∞–∑—á–∏–∫–∞, –ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –æ–±—è–∑—É–µ—Ç—Å—è –≤–µ—Ä–Ω—É—Ç—å –ó–∞–∫–∞–∑—á–∏–∫—É –¥–µ–Ω–µ–∂–Ω—ã–µ —Å—Ä–µ–¥—Å—Ç–≤–∞ –≤ —Ä–∞–∑–º–µ—Ä–µ, —Ç—Ä—ë—Ö–∫—Ä–∞—Ç–Ω–æ –ø—Ä–µ–≤—ã—à–∞—é—â–µ–º —Å—É–º–º—É, –æ–ø–ª–∞—á–µ–Ω–Ω—É—é –ó–∞–∫–∞–∑—á–∏–∫–æ–º –∑–∞ –¥–æ—Å—Ç–∞–≤–∫—É —Ç–æ–≤–∞—Ä–∞ –ø–æ –ù–∞–∫–ª–∞–¥–Ω–æ–π ‚Ññ ${cargo.cargo_number || 'N/A'}.</p>
            </div>
          </div>
          
          <script>
            window.onload = function() {
              setTimeout(function() {
                window.print();
                window.onafterprint = function() {
                  window.close();
                };
              }, 500);
            };
          </script>
        </body>
      </html>
    `;
  };

  const handleDeleteOperatorBinding = async (bindingId) => {
    if (window.confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –ø—Ä–∏–≤—è–∑–∫—É?')) {
      try {
        await apiCall(`/api/admin/operator-warehouse-binding/${bindingId}`, 'DELETE');
        showAlert('–ü—Ä–∏–≤—è–∑–∫–∞ —É–¥–∞–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
        fetchOperatorWarehouseBindings();
      } catch (error) {
        console.error('Delete operator binding error:', error);
      }
    }
  };

  // QR Code functions
  const getCargoQrCode = async (cargoId) => {
    try {
      const data = await apiCall(`/api/cargo/${cargoId}/qr-code`);
      return data.qr_code;
    } catch (error) {
      console.error('Error getting cargo QR code:', error);
      return null;
    }
  };

  const getCellQrCode = async (warehouseId, block, shelf, cell) => {
    try {
      const data = await apiCall(`/api/warehouse/${warehouseId}/cell-qr/${block}/${shelf}/${cell}`);
      return data.qr_code;
    } catch (error) {
      console.error('Error getting cell QR code:', error);
      return null;
    }
  };

  const handleQrScan = async (qrText) => {
    try {
      const data = await apiCall('/api/qr/scan', 'POST', { qr_text: qrText });
      setQrScanResult(data);
      setQrScannerModal(false);
      showAlert('QR –∫–æ–¥ —É—Å–ø–µ—à–Ω–æ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω!', 'success');
    } catch (error) {
      console.error('QR scan error:', error);
      setQrScanResult(null);
    }
  };

  const printCargoQrLabel = async (cargo) => {
    try {
      const qrCode = await getCargoQrCode(cargo.id);
      if (!qrCode) {
        showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å QR –∫–æ–¥', 'error');
        return;
      }

      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
        return;
      }
      printWindow.document.write(`
        <html>
          <head>
            <title>QR –≠—Ç–∏–∫–µ—Ç–∫–∞ - ${cargo.cargo_number}</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
              .qr-label { border: 2px solid #000; padding: 20px; margin: 20px auto; width: 300px; }
              .qr-code { margin: 20px 0; }
              .cargo-info { font-size: 14px; font-weight: bold; margin: 10px 0; }
              .cargo-details { font-size: 12px; margin: 5px 0; }
            </style>
          </head>
          <body>
            <div class="qr-label">
              <div style="text-align: center; margin-bottom: 15px;">
                <img src="/logo.png" alt="TAJLINE.TJ" style="height: 40px; width: auto;" onerror="this.style.display='none'; this.nextSibling.style.display='block';" />
                <div style="display: none; font-weight: bold; color: #2563eb; font-size: 18px;">TAJLINE.TJ</div>
              </div>
              <div class="cargo-info">–ì–†–£–ó ‚Ññ${cargo.cargo_number}</div>
              <div class="qr-code">
                <img src="${qrCode}" alt="QR Code" style="width: 150px; height: 150px;" />
              </div>
              <div class="cargo-details">
                <div><strong>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</strong> ${cargo.cargo_name || '–ì—Ä—É–∑'}</div>
                <div><strong>–í–µ—Å:</strong> ${cargo.weight} –∫–≥</div>
                <div><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> ${cargo.recipient_full_name || cargo.recipient_name}</div>
              </div>
            </div>
          </body>
        </html>
      `);
      
      printWindow.document.close();
      printWindow.print();
    } catch (error) {
      console.error('Error printing QR label:', error);
    }
  };

  const printWarehouseCellsQr = async (warehouse) => {
    try {
      const data = await apiCall(`/api/warehouse/${warehouse.id}/all-cells-qr`);
      
      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
        return;
      }
      printWindow.document.write(`
        <html>
          <head>
            <title>QR –ö–æ–¥—ã —è—á–µ–µ–∫ - ${data.warehouse_name}</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 10px; }
              .header { text-align: center; margin-bottom: 20px; }
              .qr-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
              .qr-cell { border: 1px solid #ccc; padding: 10px; text-align: center; page-break-inside: avoid; }
              .qr-code { margin: 10px 0; }
              .cell-info { font-size: 12px; font-weight: bold; }
              @media print { .qr-grid { grid-template-columns: repeat(3, 1fr); } }
            </style>
          </head>
          <body>
            <div class="header">
              <h2>QR –ö–æ–¥—ã —è—á–µ–µ–∫ —Å–∫–ª–∞–¥–∞ "${data.warehouse_name}"</h2>
              <p>–í—Å–µ–≥–æ —è—á–µ–µ–∫: ${data.total_cells}</p>
            </div>
            <div class="qr-grid">
              ${data.qr_codes.map(cell => `
                <div class="qr-cell">
                  <div class="cell-info">${cell.location}</div>
                  <div class="qr-code">
                    <img src="${cell.qr_code}" alt="QR Code" style="width: 80px; height: 80px;" />
                  </div>
                  <div class="cell-info">${data.warehouse_name}</div>
                </div>
              `).join('')}
            </div>
          </body>
        </html>
      `);
      
      printWindow.document.close();
      printWindow.print();
    } catch (error) {
      console.error('Error printing warehouse QR codes:', error);
    }
  };

  // Arrived Transport Functions
  const fetchArrivedTransports = async () => {
    try {
      const data = await apiCall('/api/transport/arrived');
      setArrivedTransports(data);
    } catch (error) {
      console.error('Error fetching arrived transports:', error);
    }
  };

  const fetchArrivedTransportCargo = async (transportId) => {
    try {
      const data = await apiCall(`/api/transport/${transportId}/arrived-cargo`);
      setArrivedCargoList(data);
    } catch (error) {
      console.error('Error fetching arrived cargo:', error);
    }
  };

  const handleMarkTransportArrived = async (transportId) => {
    if (window.confirm('–û—Ç–º–µ—Ç–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∫–∞–∫ –ø—Ä–∏–±—ã–≤—à–∏–π?')) {
      try {
        await apiCall(`/api/transport/${transportId}/arrive`, 'POST');
        showAlert('–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –ø—Ä–∏–±—ã–≤—à–∏–π!', 'success');
        fetchTransports();
        fetchArrivedTransports();
      } catch (error) {
        console.error('Error marking transport as arrived:', error);
        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–º–µ—Ç–∫–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –∫–∞–∫ –ø—Ä–∏–±—ã–≤—à–µ–≥–æ', 'error');
      }
    }
  };

  const handlePlaceCargoFromTransport = async (e) => {
    e.preventDefault();
    try {
      const placementData = {
        cargo_id: selectedCargoForWarehouse.id,
        warehouse_id: placementForm.warehouse_id,
        block_number: parseInt(placementForm.block_number),
        shelf_number: parseInt(placementForm.shelf_number),
        cell_number: parseInt(placementForm.cell_number)
      };

      const response = await apiCall(`/api/transport/${selectedArrivedTransport.id}/place-cargo-to-warehouse`, 'POST', placementData);
      
      showAlert(`–ì—Ä—É–∑ ${response.cargo_number} —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥–µ ${response.warehouse_name} –≤ —è—á–µ–π–∫–µ ${response.location}!`, 'success');
      
      // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
      fetchArrivedTransportCargo(selectedArrivedTransport.id);
      fetchArrivedTransports();
      
      // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª –∏ —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ä–º—É
      setCargoPlacementModal(false);
      setSelectedCargoForWarehouse(null);
      setPlacementForm({
        warehouse_id: '',
        block_number: 1,
        shelf_number: 1,
        cell_number: 1
      });
      
      if (response.transport_status === 'completed') {
        showAlert('–í—Å–µ –≥—Ä—É–∑—ã —Ä–∞–∑–º–µ—â–µ–Ω—ã! –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω.', 'info');
        setArrivedTransportModal(false);
      }
    } catch (error) {
      console.error('Error placing cargo:', error);
      showAlert('–û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ', 'error');
    }
  };

  // Transport Visualization Functions
  const fetchTransportVisualization = async (transportId) => {
    try {
      const data = await apiCall(`/api/transport/${transportId}/visualization`);
      setTransportVisualizationData(data);
    } catch (error) {
      console.error('Error fetching transport visualization:', error);
    }
  };

  const openTransportVisualization = (transport) => {
    setSelectedTransportForVisualization(transport);
    fetchTransportVisualization(transport.id);
    setTransportVisualizationModal(true);
  };

  // QR/Number Cargo Placement Functions
  const handleQrCargoPlacement = async (e) => {
    e.preventDefault();
    try {
      const placementData = {
        cargo_number: qrPlacementForm.cargo_number,
        qr_data: qrPlacementForm.qr_data,
        cell_qr_data: qrPlacementForm.cell_qr_data,
        block_number: parseInt(qrPlacementForm.block_number),
        shelf_number: parseInt(qrPlacementForm.shelf_number),
        cell_number: parseInt(qrPlacementForm.cell_number)
      };

      const response = await apiCall(`/api/transport/${selectedArrivedTransport.id}/place-cargo-by-number`, 'POST', placementData);
      
      showAlert(
        `–ì—Ä—É–∑ ${response.cargo_number} —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥–µ ${response.warehouse_name} –≤ —è—á–µ–π–∫–µ ${response.location}! ${response.warehouse_auto_selected ? '–°–∫–ª–∞–¥ –≤—ã–±—Ä–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.' : ''}`, 
        'success'
      );
      
      // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
      fetchArrivedTransportCargo(selectedArrivedTransport.id);
      fetchArrivedTransports();
      
      // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª –∏ —Å–±—Ä–æ—Å–∏—Ç—å —Ñ–æ—Ä–º—É
      setQrPlacementModal(false);
      setQrPlacementForm({
        cargo_number: '',
        qr_data: '',
        cell_qr_data: '',
        block_number: 1,
        shelf_number: 1,
        cell_number: 1
      });
      
      if (response.transport_status === 'completed') {
        showAlert('–í—Å–µ –≥—Ä—É–∑—ã —Ä–∞–∑–º–µ—â–µ–Ω—ã! –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∑–∞–≤–µ—Ä—à–µ–Ω.', 'info');
        setArrivedTransportModal(false);
      }
    } catch (error) {
      console.error('Error placing cargo by QR/number:', error);
      showAlert('–û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞ –ø–æ –Ω–æ–º–µ—Ä—É/QR', 'error');
    }
  };

  // Operator Functions
  const fetchOperatorWarehouses = async () => {
    try {
      const data = await apiCall('/api/operator/warehouses');  // –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–π —ç–Ω–¥–ø–æ–∏–Ω—Ç
      setOperatorWarehouses(data || []);
    } catch (error) {
      console.error('Error fetching operator warehouses:', error);
    }
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–≤ –ø–æ –º–∞—Ä—à—Ä—É—Ç—É
  const fetchWarehousesByRoute = async (route) => {
    try {
      const data = await apiCall(`/api/warehouses/by-route/${route}`);
      return data || [];
    } catch (error) {
      console.error('Error fetching warehouses by route:', error);
      return [];
    }
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –∑–∞–¥–æ–ª–∂–Ω–∏–∫–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∞
  const fetchDebtorsList = async () => {
    if (user?.role !== 'admin') return;
    
    try {
      const data = await apiCall('/api/admin/debts');
      setDebtorsList(data || []);
    } catch (error) {
      console.error('Error fetching debtors list:', error);
    }
  };

  // –§–ê–ó–ê 3: –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ò –ò –°–•–ï–ú–´ –°–ö–õ–ê–î–û–í
  
  // –ü–æ–ª—É—á–µ–Ω–∏–µ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —Å–∫–ª–∞–¥–∞
  const fetchWarehouseSpecificAnalytics = async (warehouseId) => {
    try {
      const data = await apiCall(`/api/warehouse/${warehouseId}/analytics`);
      return data || {};
    } catch (error) {
      console.error('Error fetching warehouse analytics:', error);
      return {};
    }
  };

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –≥—Ä—É–∑–æ–≤ —Å–∫–ª–∞–¥–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫–ª–∏–µ–Ω—Ç–∞—Ö –¥–ª—è —Ü–≤–µ—Ç–æ–≤–æ–≥–æ –∫–æ–¥–∏—Ä–æ–≤–∞–Ω–∏—è
  const fetchWarehouseCargoWithClients = async (warehouseId) => {
    try {
      const data = await apiCall(`/api/warehouse/${warehouseId}/cargo-with-clients`);
      return data || {};
    } catch (error) {
      console.error('Error fetching warehouse cargo with clients:', error);
      return {};
    }
  };

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å—Ö–µ–º—ã —è—á–µ–µ–∫ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ —Å —Ü–≤–µ—Ç–æ–≤–æ–π –º–∞—Ä–∫–∏—Ä–æ–≤–∫–æ–π –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
  const generateWarehouseScheme = async (warehouse) => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ–±—ä–µ–∫—Ç —Å–∫–ª–∞–¥–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
    if (!warehouse || typeof warehouse !== 'object') {
      console.error('generateWarehouseScheme: Invalid warehouse object:', warehouse);
      return [];
    }
    
    const blocks = warehouse.blocks_count || 3;
    const shelves_per_block = warehouse.shelves_per_block || 4;
    const cells_per_shelf = warehouse.cells_per_shelf || 5;
    const cellsPerBlock = shelves_per_block * cells_per_shelf;
    
    try {
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–ª—É—á–∞–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ –∏–∑ Statistics API
      const statisticsResponse = await apiCall(`/api/warehouses/${warehouse.id}/statistics`, 'GET');
      const warehouseStats = statisticsResponse || {};
      
      // –°–æ–∑–¥–∞–µ–º –∫–∞—Ä—Ç—É —Ä–µ–∞–ª—å–Ω–æ–π –∑–∞–Ω—è—Ç–æ—Å—Ç–∏ —è—á–µ–µ–∫ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
      const occupancyMap = {};
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å –∑–∞–Ω—è—Ç—ã–µ —è—á–µ–π–∫–∏, —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –∏—Ö —Å–ª—É—á–∞–π–Ω–æ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏
      // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∞—Ç—å —Ç–æ—á–Ω—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –∑–∞–Ω—è—Ç—ã—Ö —è—á–µ–µ–∫ –∏–∑ –±–∞–∑—ã
      const occupiedCells = warehouseStats.occupied_cells || 0;
      let distributedOccupied = 0;
      
      // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ –≥—Ä—É–∑–∞—Ö —Å–∫–ª–∞–¥–∞ —Å –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ –∫–ª–∏–µ–Ω—Ç–∞–º
      const warehouseCargoData = await fetchWarehouseCargoWithClients(warehouse.id);
      const { sender_groups = {}, recipient_groups = {}, color_assignments = {} } = warehouseCargoData;
      
      const scheme = [];
      
      // –°–æ–∑–¥–∞–µ–º —Å—Ö–µ–º—É –±–ª–æ–∫–æ–≤ —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–æ–π –ø–æ –ø–æ–ª–∫–∞–º
      for (let block = 1; block <= blocks; block++) {
        const blockCells = [];
        
        // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —è—á–µ–π–∫–∏ –ø–æ –ø–æ–ª–∫–∞–º –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
        for (let shelf = 1; shelf <= shelves_per_block; shelf++) {
          for (let cell = 1; cell <= cells_per_shelf; cell++) {
            const cellNumber = (shelf - 1) * cells_per_shelf + cell;
            const cellId = `${warehouse.id}-${block}-${shelf}-${cell}`;
            
            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –∑–∞–Ω—è—Ç–æ—Å—Ç–∏
            const occupancyKey = `${block}-${shelf}-${cell}`;
            let isOccupied = false;
            
            // –†–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ–º –∑–∞–Ω—è—Ç—ã–µ —è—á–µ–π–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ä–µ–∞–ª—å–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
            if (distributedOccupied < occupiedCells) {
              // –î–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏: –ø–µ—Ä–≤—ã–µ N —è—á–µ–µ–∫ –ø–æ–º–µ—á–∞–µ–º –∫–∞–∫ –∑–∞–Ω—è—Ç—ã–µ
              // –í —Ä–µ–∞–ª—å–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ –∑–¥–µ—Å—å –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—Ä–æ—Å –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
              if (block === 1 && shelf === 1 && cell <= occupiedCells) {
                isOccupied = true;
                distributedOccupied++;
              }
            }
            
            let cellData = {
              id: cellId,
              block_number: block,
              shelf_number: shelf,
              cell_number: cell,
              cell_position: cellNumber,
              is_occupied: isOccupied,
              position: {
                row: shelf,
                col: cell
              },
              location_name: `–ë${block}-–ü${shelf}-–Ø${cell}`
            };

            if (isOccupied) {
              // –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –≥—Ä—É–∑ –∏–∑ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö —Å–∫–ª–∞–¥–∞
              const allCargo = warehouseCargoData.cargo || [];
              
              if (allCargo.length > 0) {
              const randomCargo = allCargo[Math.floor(Math.random() * allCargo.length)];
              
              // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –≥—Ä—É–ø–ø—É –∫–ª–∏–µ–Ω—Ç–∞ (–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—å)
              const senderKey = `${randomCargo.sender_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}-${randomCargo.sender_phone || ''}`;
              const recipientKey = `${randomCargo.recipient_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}-${randomCargo.recipient_phone || ''}`;
              
              let clientGroup = null;
              let groupType = 'single';
              
              // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –ª–∏ –≥—Ä—É–∑ –∫ –≥—Ä—É–ø–ø–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π
              if (sender_groups[senderKey] && sender_groups[senderKey].is_group) {
                clientGroup = sender_groups[senderKey];
                groupType = 'sender';
              }
              // –ï—Å–ª–∏ –Ω–µ –≤ –≥—Ä—É–ø–ø–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π, –ø—Ä–æ–≤–µ—Ä—è–µ–º –≥—Ä—É–ø–ø—É –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
              else if (recipient_groups[recipientKey] && recipient_groups[recipientKey].is_group) {
                clientGroup = recipient_groups[recipientKey];
                groupType = 'recipient';
              }
              
              cellData = {
                ...cellData,
                cargo_number: randomCargo.cargo_number || `TEMP-${Date.now()}`,
                cargo_sender: randomCargo.sender_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω',
                cargo_sender_phone: randomCargo.sender_phone || '',
                cargo_recipient: randomCargo.recipient_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω',
                cargo_recipient_phone: randomCargo.recipient_phone || '',
                cargo_weight: randomCargo.weight || 0,
                cargo_value: randomCargo.declared_value || randomCargo.total_cost || 0,
                clientGroup: clientGroup,
                groupType: groupType,
                hasRelatedCargo: clientGroup !== null,
                relatedCargo: clientGroup ? {
                  groupType: groupType,
                  client_name: groupType === 'sender' ? clientGroup.sender_full_name : clientGroup.recipient_full_name,
                  client_phone: groupType === 'sender' ? clientGroup.sender_phone : clientGroup.recipient_phone,
                  totalCargo: clientGroup.cargo_list.length,
                  cargoNumbers: clientGroup.cargo_list.map(c => c.cargo_number),
                  cargoDetails: clientGroup.cargo_list
                } : null
              };
            } else {
              // Fallback –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –Ω–µ—Ç —Ä–µ–∞–ª—å–Ω—ã—Ö –≥—Ä—É–∑–æ–≤
              cellData = {
                ...cellData,
                cargo_number: `TEMP-${Date.now()}-${cellNumber}`,
                cargo_sender: `–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å ${cellNumber}`,
                cargo_recipient: `–ü–æ–ª—É—á–∞—Ç–µ–ª—å ${cellNumber}`,
                hasRelatedCargo: false
              };
            }
          }
          
          blockCells.push(cellData);
        }
      }
      
      scheme.push({
        block_number: block,
        cells: blockCells,
        total_cells: cellsPerBlock,
        occupied_cells: blockCells.filter(c => c.is_occupied).length
      });
    }
    
    return scheme;
    
  } catch (error) {
    console.error('Error generating warehouse scheme:', error);
    // Fallback: –≥–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ö–µ–º—É –±–µ–∑ —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –æ—à–∏–±–∫–µ
    const scheme = [];
    for (let block = 1; block <= blocks; block++) {
      const blockCells = [];
      for (let shelf = 1; shelf <= shelves_per_block; shelf++) {
        for (let cell = 1; cell <= cells_per_shelf; cell++) {
          const cellNumber = (shelf - 1) * cells_per_shelf + cell;
          blockCells.push({
            id: `${warehouse.id}-${block}-${shelf}-${cell}`,
            block_number: block,
            shelf_number: shelf,
            cell_number: cell,
            cell_position: cellNumber,
            is_occupied: false, // –ü—Ä–∏ –æ—à–∏–±–∫–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–∞–∫ —Å–≤–æ–±–æ–¥–Ω—ã–µ
            hasRelatedCargo: false
          });
        }
      }
      scheme.push({
        block_number: block,
        cells: blockCells,
        total_cells: shelves_per_block * cells_per_shelf,
        occupied_cells: 0
      });
    }
    return scheme;
  }
  };

  // –§–ê–ó–ê 4: –§–£–ù–ö–¶–ò–ò –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ì–†–£–ó–û–ú

  // –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞ –≤ –¥—Ä—É–≥—É—é —è—á–µ–π–∫—É
  const handleMoveCargoToCell = async (cargoId, newCellId) => {
    try {
      const data = await apiCall(`/api/cargo/${cargoId}/move`, 'POST', { new_cell_id: newCellId });
      console.log('–ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω!');
      return true;
    } catch (error) {
      console.error('Error moving cargo:', error);
      return false;
    }
  };

  // –í–æ–∑–≤—Ä–∞—Ç —Ç–æ–≤–∞—Ä–∞
  const handleReturnCargo = async (cargoId, returnReason) => {
    try {
      const data = await apiCall(`/api/cargo/${cargoId}/return`, 'POST', { reason: returnReason });
      console.log('–ì—Ä—É–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –≤–æ–∑–≤—Ä–∞—Ç!');
      return true;
    } catch (error) {
      console.error('Error returning cargo:', error);
      return false;
    }
  };

  // –†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞ –Ω–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç (—É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∏–∑ —è—á–µ–π–∫–∏)
  const handleMoveCargoToTransport = async (cargoId, transportId) => {
    try {
      const data = await apiCall(`/api/cargo/${cargoId}/place-transport`, 'POST', { transport_id: transportId });
      console.log('–ì—Ä—É–∑ —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç!');
      return true;
    } catch (error) {
      console.error('Error placing cargo on transport:', error);
      return false;
    }
  };

  // –û—Ç–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥—Ä—É–∑–æ–º
  const openCargoManagementModal = async (cargoInfo) => {
    // –°–æ–∑–¥–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä—É–∑–µ —Å –¥–∞–Ω–Ω—ã–º–∏ –æ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –≥—Ä—É–∑–∞—Ö
    const detailedCargo = {
      ...cargoInfo,
      cargo_number: cargoInfo.cargo_number || `CRG${Date.now()}`,
      status: 'placed',
      payment_status: cargoInfo.cargo_value > 0 ? 'paid' : 'pending',
      payment_method: 'cash',
      payment_amount: cargoInfo.cargo_value || 1500.0,
      weight: cargoInfo.cargo_weight || 15.5,
      sender: {
        full_name: cargoInfo.cargo_sender || '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á',
        phone: cargoInfo.cargo_sender_phone || '+79991234567',
        address: '–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –ö—Ä–∞—Å–Ω–∞—è –ø–ª–æ—â–∞–¥—å, –¥. 1',
        email: 'sender@example.com'
      },
      recipient: {
        full_name: cargoInfo.cargo_recipient || '–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á',
        phone: cargoInfo.cargo_recipient_phone || '+992987654321',
        address: '–≥. –î—É—à–∞–Ω–±–µ, –ø—Ä. –†—É–¥–∞–∫–∏, –¥. 10',
        email: 'recipient@example.com'
      },
      // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –≥—Ä—É–∑–∞—Ö –æ—Ç —Ç–æ–≥–æ –∂–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è/–ø–æ–ª—É—á–∞—Ç–µ–ª—è
      relatedCargo: cargoInfo.hasRelatedCargo && cargoInfo.relatedCargo ? {
        ...cargoInfo.relatedCargo,
        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –¥–µ—Ç–∞–ª–∏ –æ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –≥—Ä—É–∑–∞—Ö —Å –∏—Ö –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ–º
        detailedCargoList: cargoInfo.relatedCargo.cargoDetails ? cargoInfo.relatedCargo.cargoDetails.map(relatedItem => ({
          cargo_number: relatedItem.cargo_number,
          weight: relatedItem.weight || 0,
          value: relatedItem.declared_value || relatedItem.total_cost || 0,
          // –°–∏–º—É–ª–∏—Ä—É–µ–º –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ (–≤ —Ä–µ–∞–ª—å–Ω–æ–π —Å–∏—Å—Ç–µ–º–µ —ç—Ç–æ –±—É–¥–µ—Ç –∏–∑ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö)
          location: relatedItem.warehouse_location ? {
            warehouse: relatedItem.warehouse_location,
            block: Math.floor(Math.random() * 7) + 1,
            shelf: Math.floor(Math.random() * 3) + 1,
            cell: Math.floor(Math.random() * 10) + 1,
            status: 'placed'
          } : {
            warehouse: '–í –æ–±—Ä–∞–±–æ—Ç–∫–µ',
            status: 'pending',
            payment_status: relatedItem.payment_status || 'paid'
          }
        })) : []
      } : null,
      location: {
        warehouse_name: '–°–∫–ª–∞–¥ ‚Ññ2 –•—É–¥–∂–∞–Ω–¥',
        block: cargoInfo.block_number || 1,
        shelf: cargoInfo.shelf_number || 1, 
        cell: cargoInfo.cell_number || 1
      },
      // –ò—Å—Ç–æ—Ä–∏—è –¥–≤–∏–∂–µ–Ω–∏—è –≥—Ä—É–∑–∞
      history: [
        { date: new Date().toISOString().split('T')[0], action: '–ü—Ä–∏–Ω—è—Ç –∫ –ø–µ—Ä–µ–≤–æ–∑–∫–µ', user: '–û–ø–µ—Ä–∞—Ç–æ—Ä —Å–∫–ª–∞–¥–∞' },
        { date: new Date(Date.now() - 86400000).toISOString().split('T')[0], action: '–†–∞–∑–º–µ—â–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥–µ', user: '–û–ø–µ—Ä–∞—Ç–æ—Ä —Å–∫–ª–∞–¥–∞' },
        { date: new Date(Date.now() - 172800000).toISOString().split('T')[0], action: '–ì—Ä—É–∑ —Å–æ–∑–¥–∞–Ω', user: '–°–∏—Å—Ç–µ–º–∞' }
      ]
    };
    
    setSelectedCargoForManagement(detailedCargo);
    setShowCargoManagementModal(true);
  };

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –î–õ–Ø –ê–ù–ê–õ–ò–¢–ò–ö–ò –ò –û–¢–ß–ï–¢–û–í

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –æ—Ç—á–µ—Ç–∞ –ø–æ —Å–∫–ª–∞–¥—É
  const fetchWarehouseReport = async (warehouseId) => {
    try {
      const data = await apiCall(`/api/warehouse/${warehouseId}/report`);
      return data || [];
    } catch (error) {
      console.error('Error fetching warehouse report:', error);
      return [];
    }
  };

  // –ü–æ–ª—É—á–µ–Ω–∏–µ –¥–µ—Ç–∞–ª—å–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å–∫–ª–∞–¥–∞
  const fetchWarehouseDetailedAnalytics = async (warehouseId) => {
    try {
      const data = await apiCall(`/api/warehouse/${warehouseId}/detailed-analytics`);
      return data || {};
    } catch (error) {
      console.error('Error fetching warehouse detailed analytics:', error);
      return {};
    }
  };

  // –û—Ç–∫—Ä—ã—Ç–∏–µ –æ—Ç—á–µ—Ç–∞ –ø–æ —Å–∫–ª–∞–¥—É
  const openWarehouseReport = async (warehouse) => {
    setShowWarehouseReport(warehouse.id);
    
    try {
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç—á–µ—Ç–∞ –∏–∑ API
      const reportData = await generateRealWarehouseReportData(warehouse);
      setWarehouseReportData(reportData);
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É –∏–∑ API
      const analytics = await generateRealWarehouseAnalytics(warehouse);
      setWarehouseDetailedAnalytics(prev => ({
        ...prev,
        [warehouse.id]: analytics
      }));
    } catch (error) {
      console.error('Error generating warehouse report:', error);
      showAlert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –æ—Ç—á–µ—Ç–∞: ' + error.message, 'error');
    }
  };

  // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞ –ø–æ —Å–∫–ª–∞–¥—É
  const generateRealWarehouseReportData = async (warehouse) => {
    try {
      // –ü–æ–ª—É—á–∞–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –≥—Ä—É–∑—ã —Å–∫–ª–∞–¥–∞
      const cargoResponse = await apiCall(`/api/warehouses/${warehouse.id}/cargo`, 'GET');
      const cargos = cargoResponse.cargo || [];
      
      // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∫–ª–∞–¥–∞
      const statsResponse = await apiCall(`/api/warehouses/${warehouse.id}/statistics`, 'GET');
      const stats = statsResponse || {};
      
      // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≤ —Ñ–æ—Ä–º–∞—Ç –æ—Ç—á–µ—Ç–∞
      const reportData = cargos.map((cargo, index) => ({
        id: cargo.id || `cargo-${index}`,
        cargo_number: cargo.cargo_number || `TEMP-${Date.now()}-${index}`,
        sender_name: cargo.sender_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
        sender_phone: cargo.sender_phone || '–ù–µ —É–∫–∞–∑–∞–Ω',
        recipient_name: cargo.recipient_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
        recipient_phone: cargo.recipient_phone || '–ù–µ —É–∫–∞–∑–∞–Ω',
        cargo_type: cargo.description || cargo.cargo_type || '–ù–µ —É–∫–∞–∑–∞–Ω–æ',
        weight: cargo.weight || 0,
        declared_value: cargo.declared_value || cargo.total_cost || 0,
        payment_status: cargo.payment_status || '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ',
        route: cargo.route || '–ù–µ —É–∫–∞–∑–∞–Ω',
        created_date: cargo.created_at ? new Date(cargo.created_at).toLocaleDateString('ru-RU') : new Date().toLocaleDateString('ru-RU'),
        processing_status: cargo.processing_status || 'unknown',
        cell_location: cargo.block_number && cargo.shelf_number && cargo.cell_number ? 
          `–ë${cargo.block_number}-–ü${cargo.shelf_number}-–Ø${cargo.cell_number}` : '–ù–µ —Ä–∞–∑–º–µ—â–µ–Ω'
      }));
      
      return reportData;
    } catch (error) {
      console.error('Error fetching real warehouse report data:', error);
      return []; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –ø—Ä–∏ –æ—à–∏–±–∫–µ
    }
  };

  // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Ä–µ–∞–ª—å–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å–∫–ª–∞–¥–∞
  const generateRealWarehouseAnalytics = async (warehouse) => {
    try {
      // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∫–ª–∞–¥–∞
      const statsResponse = await apiCall(`/api/warehouses/${warehouse.id}/statistics`, 'GET');
      const stats = statsResponse || {};
      
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ –≥—Ä—É–∑–∞—Ö –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏
      const cargoResponse = await apiCall(`/api/warehouses/${warehouse.id}/cargo`, 'GET');
      const cargos = cargoResponse.cargo || [];
      
      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Ä–µ–∞–ª—å–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É
      const totalCargo = cargos.length;
      const totalWeight = cargos.reduce((sum, cargo) => sum + (cargo.weight || 0), 0);
      const totalValue = cargos.reduce((sum, cargo) => sum + (cargo.declared_value || cargo.total_cost || 0), 0);
      
      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ —Å—Ç–∞—Ç—É—Å–∞–º
      const statusGroups = cargos.reduce((groups, cargo) => {
        const status = cargo.processing_status || 'unknown';
        groups[status] = (groups[status] || 0) + 1;
        return groups;
      }, {});
      
      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –º–∞—Ä—à—Ä—É—Ç–∞–º
      const routeGroups = cargos.reduce((groups, cargo) => {
        const route = cargo.route || '–ù–µ —É–∫–∞–∑–∞–Ω';
        groups[route] = (groups[route] || 0) + 1;
        return groups;
      }, {});
      
      return {
        totalCargo: totalCargo,
        totalWeight: totalWeight,
        totalValue: totalValue,
        occupiedCells: stats.occupied_cells || 0,
        totalCells: stats.total_cells || ((warehouse.blocks_count || 0) * (warehouse.shelves_per_block || 0) * (warehouse.cells_per_shelf || 0)),
        utilizationRate: stats.utilization || 0,
        statusDistribution: statusGroups,
        routeDistribution: routeGroups,
        lastUpdated: new Date().toISOString()
      };
    } catch (error) {
      console.error('Error fetching real warehouse analytics:', error);
      // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –±–∞–∑–æ–≤—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø—Ä–∏ –æ—à–∏–±–∫–µ
      return {
        totalCargo: 0,
        totalWeight: 0,  
        totalValue: 0,
        occupiedCells: 0,
        totalCells: (warehouse.blocks_count || 0) * (warehouse.shelves_per_block || 0) * (warehouse.cells_per_shelf || 0),
        utilizationRate: 0,
        statusDistribution: {},
        routeDistribution: {},
        lastUpdated: new Date().toISOString()
      };
    }
  };

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö –æ—Ç—á–µ—Ç–∞ –ø–æ —Å–∫–ª–∞–¥—É (—Å–∏–º—É–ª—è—Ü–∏—è)
  const generateWarehouseReportData = (warehouse) => {
    const reportData = [];
    const senders = [
      { name: '–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á', phone: '+79991234567' },
      { name: '–ü–µ—Ç—Ä–æ–≤–∞ –ú–∞—Ä–∏—è –°–µ—Ä–≥–µ–µ–≤–Ω–∞', phone: '+79887654321' },
      { name: '–°–∏–¥–æ—Ä–æ–≤ –ü–µ—Ç—Ä –ù–∏–∫–æ–ª–∞–µ–≤–∏—á', phone: '+79776543210' },
      { name: '–ö–æ–∑–ª–æ–≤–∞ –ê–Ω–Ω–∞ –í–ª–∞–¥–∏–º–∏—Ä–æ–≤–Ω–∞', phone: '+79665432109' }
    ];
    
    const recipients = [
      { name: '–†–∞—Ö–∏–º–æ–≤ –§–∞—Ä—Ö–æ–¥ –ê–ª–∏–µ–≤–∏—á', phone: '+992987654321' },
      { name: '–ù–∞–∑–∞—Ä–æ–≤–∞ –ì—É–ª—è –ú–∞—Ö–º—É–¥–æ–≤–Ω–∞', phone: '+992988765432' },
      { name: '–ò—Å–º–∞—Ç–æ–≤ –°–∞–Ω–∂–∞—Ä –†—É—Å—Ç–∞–º–æ–≤–∏—á', phone: '+992987123456' },
      { name: '–Æ—Å—É–ø–æ–≤–∞ –î–∏–ª–æ—Ä–æ–º –ö–∞—Ä–∏–º–æ–≤–Ω–∞', phone: '+992986543210' }
    ];
    
    const cargoTypes = ['–î–æ–∫—É–º–µ–Ω—Ç—ã', '–≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞', '–û–¥–µ–∂–¥–∞', '–ü—Ä–æ–¥—É–∫—Ç—ã –ø–∏—Ç–∞–Ω–∏—è', '–ö–æ—Å–º–µ—Ç–∏–∫–∞', '–ò–≥—Ä—É—à–∫–∏'];
    const paymentStatuses = ['–û–ø–ª–∞—á–µ–Ω–æ', '–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É', '–û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏', '–û–ø–ª–∞—Ç–∞ –≤ –¥–æ–ª–≥'];
    const routes = ['–ú–æ—Å–∫–≤–∞ ‚Üí –î—É—à–∞–Ω–±–µ', '–ú–æ—Å–∫–≤–∞ ‚Üí –•—É–¥–∂–∞–Ω–¥', '–ú–æ—Å–∫–≤–∞ ‚Üí –ö—É–ª–æ–±'];
    
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º 15-25 –∑–∞–ø–∏—Å–µ–π –≥—Ä—É–∑–∞ –¥–ª—è —Å–∫–ª–∞–¥–∞
    const itemCount = Math.floor(Math.random() * 10) + 15;
    
    for (let i = 1; i <= itemCount; i++) {
      const sender = senders[Math.floor(Math.random() * senders.length)];
      const recipient = recipients[Math.floor(Math.random() * recipients.length)];
      const weight = (Math.random() * 50 + 0.5).toFixed(1);
      const amount = Math.floor(Math.random() * 5000) + 500;
      const cargoType = cargoTypes[Math.floor(Math.random() * cargoTypes.length)];
      const paymentStatus = paymentStatuses[Math.floor(Math.random() * paymentStatuses.length)];
      const route = routes[Math.floor(Math.random() * routes.length)];
      
      const date = new Date();
      date.setDate(date.getDate() - Math.floor(Math.random() * 30));
      
      reportData.push({
        id: `${warehouse.id}-cargo-${i}`,
        cargo_number: `CRG${Date.now()}-${i}`,
        cargo_name: cargoType,
        weight: parseFloat(weight),
        total_amount: amount,
        sender: sender.name,
        recipient: recipient.name,
        recipient_phone: recipient.phone,
        route: route,
        destination_warehouse: warehouse.name,
        payment_status: paymentStatus,
        acceptance_date: date.toISOString().split('T')[0],
        created_date: date.toISOString()
      });
    }
    
    return reportData.sort((a, b) => new Date(b.created_date) - new Date(a.created_date));
  };

  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–µ—Ç–∞–ª—å–Ω–æ–π –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ —Å–∫–ª–∞–¥–∞ (—Å–∏–º—É–ª—è—Ü–∏—è)
  const generateWarehouseAnalytics = (warehouse) => {
    const blocksCount = warehouse.blocks_count || 3;
    const totalCells = blocksCount * 20;
    const occupiedCells = Math.floor(totalCells * 0.6);
    const freeCells = totalCells - occupiedCells;
    
    const totalWeight = Math.floor(Math.random() * 1000) + 500; // –∫–≥
    const totalCargoCount = occupiedCells + Math.floor(Math.random() * 10);
    const uniqueClientsCount = Math.floor(totalCargoCount * 0.7); // 70% —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç–æ–≤
    const totalAmount = Math.floor(Math.random() * 100000) + 50000; // —Ä—É–±–ª–∏
    
    return {
      total_blocks: blocksCount,
      total_cells: totalCells,
      occupied_cells: occupiedCells,
      free_cells: freeCells,
      loading_percentage: Math.round((occupiedCells / totalCells) * 100),
      total_weight_kg: totalWeight,
      total_cargo_count: totalCargoCount,
      unique_clients_count: uniqueClientsCount,
      total_amount_rub: totalAmount
    };
  };

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ–ª–≥–∞–º–∏
  const handlePayOffDebt = async (debtId, remainingAmount) => {
    if (window.confirm(`–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –ø–æ–≥–∞—à–µ–Ω–∏–µ –¥–æ–ª–≥–∞ –Ω–∞ —Å—É–º–º—É ${remainingAmount?.toFixed(2)} —Å–æ–º`)) {
      try {
        await apiCall(`/api/admin/debts/${debtId}/status`, 'PUT', { status: 'paid' });
        showAlert('–î–æ–ª–≥ —É—Å–ø–µ—à–Ω–æ –ø–æ–≥–∞—à–µ–Ω!', 'success');
        fetchDebtorsList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
      } catch (error) {
        console.error('Error paying off debt:', error);
        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–≥–∞—à–µ–Ω–∏–∏ –¥–æ–ª–≥–∞', 'error');
      }
    }
  };

  const handleMarkOverdue = async (debtId) => {
    if (window.confirm('–û—Ç–º–µ—Ç–∏—Ç—å –¥–æ–ª–≥ –∫–∞–∫ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π?')) {
      try {
        await apiCall(`/api/admin/debts/${debtId}/status`, 'PUT', { status: 'overdue' });
        showAlert('–î–æ–ª–≥ –æ—Ç–º–µ—á–µ–Ω –∫–∞–∫ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–π', 'success');
        fetchDebtorsList(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫
      } catch (error) {
        console.error('Error marking debt overdue:', error);
        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –¥–æ–ª–≥–∞', 'error');
      }
    }
  };

  // –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò: –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏
  const handleMarkNotificationAsRead = async (notificationId) => {
    try {
      await apiCall(`/api/notifications/${notificationId}/status`, 'PUT', { status: 'read' });
      // –û–±–Ω–æ–≤–ª—è–µ–º –ª–æ–∫–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
      setNotifications(prev => 
        prev.map(n => n.id === notificationId ? {...n, status: 'read'} : n)
      );
      showAlert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ', 'success');
    } catch (error) {
      console.error('Error marking notification as read:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
    }
  };

  const handleDeleteNotification = async (notificationId) => {
    if (window.confirm('–£–¥–∞–ª–∏—Ç—å —ç—Ç–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ?')) {
      try {
        await apiCall(`/api/notifications/${notificationId}`, 'DELETE');
        // –£–¥–∞–ª—è–µ–º –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Å–æ—Å—Ç–æ—è–Ω–∏—è
        setNotifications(prev => prev.filter(n => n.id !== notificationId));
        showAlert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ —É–¥–∞–ª–µ–Ω–æ', 'success');
      } catch (error) {
        console.error('Error deleting notification:', error);
        showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
      }
    }
  };

  const handleViewNotificationDetails = async (notificationId) => {
    try {
      const data = await apiCall(`/api/notifications/${notificationId}/details`);
      setSelectedNotificationDetails(data);
      setNotificationDetailsModal(true);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≤ –ª–æ–∫–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
      setNotifications(prev => 
        prev.map(n => n.id === notificationId ? {...n, status: 'read'} : n)
      );
    } catch (error) {
      console.error('Error fetching notification details:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–µ—Ç–∞–ª–µ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è', 'error');
    }
  };

  const fetchTransportsList = async () => {
    try {
      const data = await apiCall('/api/transport/list');
      setTransports(data);
    } catch (error) {
      console.error('Error fetching transports list:', error);
    }
  };

  const handleCreateInterwarehouseTransport = async (e) => {
    e.preventDefault();
    try {
      const response = await apiCall('/api/transport/create-interwarehouse', 'POST', interwarehouseForm);
      
      showAlert(
        `–ú–µ–∂—Å–∫–ª–∞–¥—Å–∫–æ–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç ${response.transport_number} —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ! –ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ: ${response.direction}`, 
        'success'
      );
      
      // –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏ –∑–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª
      fetchTransportsList();
      setInterwarehouseTransportModal(false);
      setInterwarehouseForm({
        source_warehouse_id: '',
        destination_warehouse_id: '',
        driver_name: '',
        driver_phone: '',
        capacity_kg: 1000
      });
    } catch (error) {
      console.error('Error creating interwarehouse transport:', error);
      showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –º–µ–∂—Å–∫–ª–∞–¥—Å–∫–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞', 'error');
    }
  };

  const handleLogin = async (e) => {
    e.preventDefault();
    setIsLoggingIn(true);
    try {
      const data = await apiCall('/api/auth/login', 'POST', loginForm);
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
      setToken(data.access_token);
      setUser(data.user);
      localStorage.setItem('token', data.access_token);
      
      showAlert('–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É!', 'success');
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ª–æ–≥–∏–Ω–∞ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
      setTimeout(() => {
        setIsLoggingIn(false);
      }, 1000);
      
    } catch (error) {
      console.error('Login error:', error);
      console.log('Error status:', error.status || 'undefined');
      console.log('Error detail:', error.detail || 'undefined');
      setIsLoggingIn(false);
      
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ/—É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      if (error.status === 403 && error.detail?.error_type === 'account_disabled') {
        console.log('üîí Handling account_disabled error');
        const statusInfo = error.detail;
        setUserStatusData({
          statusMessage: statusInfo.status_message,
          statusDetails: statusInfo.status_details,
          userRole: statusInfo.user_role,
          userName: statusInfo.user_name,
          userPhone: statusInfo.user_phone,
          isDeleted: statusInfo.is_deleted
        });
        setUserStatusModal(true);
        console.log('‚úÖ UserStatus modal should be shown');
      } 
      // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (–Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä –∏–ª–∏ –ø–∞—Ä–æ–ª—å)
      else if (error.status === 401 && error.detail?.error_type) {
        console.log('üö´ Handling login error:', error.detail.error_type);
        const errorInfo = error.detail;
        
        // –î–æ–±–∞–≤–ª—è–µ–º –æ—Ç–ª–∞–¥–æ—á–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
        const errorData = {
          errorType: errorInfo.error_type,
          message: errorInfo.message,
          details: errorInfo.details,
          userRole: errorInfo.user_role,
          userName: errorInfo.user_name,
          userPhone: errorInfo.user_phone,
          phoneFormat: errorInfo.phone_format,
          passwordRequirements: errorInfo.password_requirements,
          availableActions: errorInfo.available_actions || []
        };
        
        console.log('üìä Setting loginErrorData:', errorData);
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º ref –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
        loginErrorRef.current = { modal: true, data: errorData };
        
        // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        setLoginErrorData(errorData);
        
        console.log('üîç Setting loginErrorModal to TRUE');
        
        // –ò—Å–ø–æ–ª—å–∑—É–µ–º setTimeout –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è React state batching
        setTimeout(() => {
          setLoginErrorModal(true);
          console.log('‚è∞ TIMEOUT: loginErrorModal set to TRUE');
          console.log('üéØ REF CHECK: loginErrorRef.current:', loginErrorRef.current);
          
          // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —á–µ—Ä–µ–∑ –Ω–µ–±–æ–ª—å—à—É—é –∑–∞–¥–µ—Ä–∂–∫—É
          setTimeout(() => {
            console.log('üéØ DELAYED CHECK: Current loginErrorModal state:', loginErrorModal);
            console.log('üéØ DELAYED CHECK: Current loginErrorData state:', loginErrorData);
          }, 50);
        }, 10);
        
        console.log('‚úÖ LoginError modal should be shown');
      } else {
        // –û–±—ã—á–Ω–∞—è –æ—à–∏–±–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ (fallback)
        console.log('‚ùå Fallback error handling:', error.message);
        showAlert(error.message || '–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
      }
    }
  };

  const handleRegister = async (e) => {
    e.preventDefault();
    setIsLoggingIn(true);
    try {
      const data = await apiCall('/api/auth/register', 'POST', registerForm);
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–æ–∫–µ–Ω –∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω–æ
      setToken(data.access_token);
      setUser(data.user);
      localStorage.setItem('token', data.access_token);
      
      showAlert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –ø—Ä–æ—à–ª–∞ —É—Å–ø–µ—à–Ω–æ!', 'success');
      
      // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –ª–æ–≥–∏–Ω–∞ –ø–æ—Å–ª–µ –Ω–µ–±–æ–ª—å—à–æ–π –∑–∞–¥–µ—Ä–∂–∫–∏
      setTimeout(() => {
        setIsLoggingIn(false);
      }, 1000);
      
    } catch (error) {
      console.error('Registration error:', error);
      setIsLoggingIn(false);
    }
  };

  const handleCreateCargo = async (e) => {
    e.preventDefault();
    try {
      await apiCall('/api/cargo/create', 'POST', {
        ...cargoForm,
        weight: parseFloat(cargoForm.weight),
        declared_value: parseFloat(cargoForm.declared_value)
      });
      showAlert('–ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 'success');
      setCargoForm({
        recipient_name: '',
        recipient_phone: '',
        route: 'moscow_to_tajikistan',
        weight: '',
        description: '',
        declared_value: '',
        sender_address: '',
        recipient_address: ''
      });
      fetchMyCargo();
    } catch (error) {
      console.error('Create cargo error:', error);
    }
  };

  const handleTrackCargo = async (e) => {
    e.preventDefault();
    try {
      const data = await apiCall(`/api/cargo/track/${trackingNumber}`);
      setTrackingResult(data);
      showAlert('–ì—Ä—É–∑ –Ω–∞–π–¥–µ–Ω!', 'success');
    } catch (error) {
      setTrackingResult(null);
      console.error('Track cargo error:', error);
    }
  };

  const handleWarehouseSearch = async () => {
    if (!searchQuery.trim()) return;
    try {
      const data = await apiCall(`/api/warehouse/search?query=${encodeURIComponent(searchQuery)}`);
      // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –≤—Å–µ–≥–¥–∞ —è–≤–ª—è–µ—Ç—Å—è –º–∞—Å—Å–∏–≤–æ–º
      setSearchResults(Array.isArray(data) ? data : []);
      setShowSearchResults(true);
    } catch (error) {
      console.error('Search error:', error);
      setSearchResults([]);
      setShowSearchResults(false);
    }
  };

  const handleCreateWarehouse = async (e) => {
    e.preventDefault();
    try {
      const response = await apiCall('/api/warehouses/create', 'POST', {
        ...warehouseForm,
        blocks_count: parseInt(warehouseForm.blocks_count),
        shelves_per_block: parseInt(warehouseForm.shelves_per_block),
        cells_per_shelf: parseInt(warehouseForm.cells_per_shelf)
      });
      
      showAlert('–°–∫–ª–∞–¥ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!', 'success');
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–∑–¥–∞–Ω–Ω–æ–º —Å–∫–ª–∞–¥–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤
      setCreatedWarehouseInfo(response);
      
      // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä, —Å–æ–∑–¥–∞–µ–º –ø—Ä–∏–≤—è–∑–∫—É
      if (warehouseForm.assigned_operator_id && warehouseForm.assigned_operator_id !== 'none') {
        try {
          await apiCall('/api/admin/operator-warehouse-binding/create', 'POST', {
            operator_id: warehouseForm.assigned_operator_id,
            warehouse_id: response.id
          });
          showAlert('–û–ø–µ—Ä–∞—Ç–æ—Ä —É—Å–ø–µ—à–Ω–æ –Ω–∞–∑–Ω–∞—á–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥!', 'success');
        } catch (bindingError) {
          console.error('Operator binding error:', bindingError);
          showAlert('–°–∫–ª–∞–¥ —Å–æ–∑–¥–∞–Ω, –Ω–æ –Ω–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–∑–Ω–∞—á–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞', 'warning');
        }
      }
      
      // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —à–∞–≥—É –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤
      setWarehouseCreationStep('qr-generation');
      
      setWarehouseForm({
        name: '',
        location: '',
        blocks_count: 1,
        shelves_per_block: 1,
        cells_per_shelf: 10,
        assigned_operator_id: 'none'
      });
      fetchWarehouses();
    } catch (error) {
      console.error('Create warehouse error:', error);
      showAlert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–ª–∞–¥–∞: ${error.message}`, 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤
  const fetchAvailableOperators = async () => {
    try {
      const response = await apiCall('/api/admin/users/operators', 'GET');
      setAvailableOperators(response || []);
    } catch (error) {
      console.error('Error fetching operators:', error);
      setAvailableOperators([]);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–ª–∞–¥–∞
  const openWarehouseCreationPage = async () => {
    setShowWarehouseCreationPage(true);
    setWarehouseCreationStep('form');
    setCreatedWarehouseInfo(null);
    setGeneratedQRs([]);
    await fetchAvailableOperators();
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–∫—Ä—ã—Ç–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã —Å–æ–∑–¥–∞–Ω–∏—è —Å–∫–ª–∞–¥–∞
  const closeWarehouseCreationPage = () => {
    setShowWarehouseCreationPage(false);
    setWarehouseCreationStep('form');
    setCreatedWarehouseInfo(null);
    setGeneratedQRs([]);
    setWarehouseForm({
      name: '',
      location: '',
      blocks_count: 1,
      shelves_per_block: 1,
      cells_per_shelf: 10,
      assigned_operator_id: 'none'
    });
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤ –¥–ª—è –≤—Å–µ—Ö —è—á–µ–µ–∫
  const generateAllCellQRs = async () => {
    if (!createdWarehouseInfo) {
      showAlert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∫–ª–∞–¥–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
      return;
    }

    setGeneratingAllQRs(true);
    setAllQRProgress(0);
    setGeneratedQRs([]);

    const { blocks_count, shelves_per_block, cells_per_shelf } = createdWarehouseInfo;
    const totalCells = blocks_count * shelves_per_block * cells_per_shelf;
    let processedCells = 0;
    const qrResults = [];

    try {
      for (let block = 1; block <= blocks_count; block++) {
        for (let shelf = 1; shelf <= shelves_per_block; shelf++) {
          for (let cell = 1; cell <= cells_per_shelf; cell++) {
            try {
              const qrResponse = await apiCall('/api/warehouse/cell/generate-qr', 'POST', {
                warehouse_id: createdWarehouseInfo.id,
                block: block,
                shelf: shelf,
                cell: cell,
                format: 'id' // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID —Ñ–æ—Ä–º–∞—Ç
              });

              if (qrResponse && qrResponse.success) {
                qrResults.push({
                  block,
                  shelf,
                  cell,
                  readable_name: qrResponse.readable_name || `–ë${block}-–ü${shelf}-–Ø${cell}`,
                  cell_code: qrResponse.cell_code,
                  qr_code: qrResponse.qr_code,
                  success: true
                });
              } else {
                qrResults.push({
                  block,
                  shelf,
                  cell,
                  readable_name: `–ë${block}-–ü${shelf}-–Ø${cell}`,
                  success: false,
                  error: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å QR –∫–æ–¥'
                });
              }
            } catch (error) {
              console.error(`Error generating QR for cell ${block}-${shelf}-${cell}:`, error);
              qrResults.push({
                block,
                shelf,
                cell,
                readable_name: `–ë${block}-–ü${shelf}-–Ø${cell}`,
                success: false,
                error: error.message
              });
            }

            processedCells++;
            setAllQRProgress((processedCells / totalCells) * 100);
          }
        }
      }

      setGeneratedQRs(qrResults);
      const successCount = qrResults.filter(qr => qr.success).length;
      showAlert(`–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –£—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–æ ${successCount} –∏–∑ ${totalCells} QR –∫–æ–¥–æ–≤`, successCount === totalCells ? 'success' : 'warning');

    } catch (error) {
      console.error('Error generating all QRs:', error);
      showAlert(`–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤: ${error.message}`, 'error');
    } finally {
      setGeneratingAllQRs(false);
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —è—á–µ–π–∫–∏
  const generateSelectedCellQR = async () => {
    if (!createdWarehouseInfo) {
      showAlert('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∫–ª–∞–¥–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞', 'error');
      return;
    }

    if (!selectedCellQR.block || !selectedCellQR.shelf || !selectedCellQR.cell) {
      showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è (–ë–ª–æ–∫, –ü–æ–ª–∫–∞, –Ø—á–µ–π–∫–∞)', 'error');
      return;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤–≤–µ–¥–µ–Ω—ã —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã
    if (!/^\d+$/.test(selectedCellQR.block) || !/^\d+$/.test(selectedCellQR.shelf) || !/^\d+$/.test(selectedCellQR.cell)) {
      showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–æ–¥–∏—Ç–µ —Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã', 'error');
      return;
    }

    const block = parseInt(selectedCellQR.block);
    const shelf = parseInt(selectedCellQR.shelf);
    const cell = parseInt(selectedCellQR.cell);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω—ã
    if (block < 1 || block > createdWarehouseInfo.blocks_count) {
      showAlert(`–ù–æ–º–µ—Ä –±–ª–æ–∫–∞ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ ${createdWarehouseInfo.blocks_count}`, 'error');
      return;
    }
    if (shelf < 1 || shelf > createdWarehouseInfo.shelves_per_block) {
      showAlert(`–ù–æ–º–µ—Ä –ø–æ–ª–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ ${createdWarehouseInfo.shelves_per_block}`, 'error');
      return;
    }
    if (cell < 1 || cell > createdWarehouseInfo.cells_per_shelf) {
      showAlert(`–ù–æ–º–µ—Ä —è—á–µ–π–∫–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –æ—Ç 1 –¥–æ ${createdWarehouseInfo.cells_per_shelf}`, 'error');
      return;
    }

    setGeneratingSelectedCellQR(true);
    try {
      const qrResponse = await apiCall('/api/warehouse/cell/generate-qr', 'POST', {
        warehouse_id: createdWarehouseInfo.id,
        block: block,
        shelf: shelf,
        cell: cell,
        format: 'id' // –ò—Å–ø–æ–ª—å–∑—É–µ–º ID —Ñ–æ—Ä–º–∞—Ç
      });

      if (qrResponse && qrResponse.success) {
        setSelectedCellQRResult({
          readable_name: qrResponse.readable_name || `–ë${block}-–ü${shelf}-–Ø${cell}`,
          cell_code: qrResponse.cell_code,
          qr_code: qrResponse.qr_code,
          success: true
        });
        showAlert(`QR –∫–æ–¥ –¥–ª—è —è—á–µ–π–∫–∏ ${qrResponse.readable_name || `–ë${block}-–ü${shelf}-–Ø${cell}`} —Å–æ–∑–¥–∞–Ω —É—Å–ø–µ—à–Ω–æ!`, 'success');
      } else {
        setSelectedCellQRResult({
          readable_name: `–ë${block}-–ü${shelf}-–Ø${cell}`,
          success: false,
          error: '–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å QR –∫–æ–¥'
        });
        showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è QR –∫–æ–¥–∞', 'error');
      }
    } catch (error) {
      console.error('Error generating selected cell QR:', error);
      setSelectedCellQRResult({
        readable_name: `–ë${block}-–ü${shelf}-–Ø${cell}`,
        success: false,
        error: error.message
      });
      showAlert(`–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è QR –∫–æ–¥–∞: ${error.message}`, 'error');
    } finally {
      setGeneratingSelectedCellQR(false);
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –≥—Ä—É–∑–∞–º–∏ —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ —Ü–µ–Ω–∞–º–∏
  const addCargoItem = () => {
    setOperatorCargoForm({
      ...operatorCargoForm,
      cargo_items: [...operatorCargoForm.cargo_items, { cargo_name: '', quantity: 1, weight: '', price_per_kg: '', total_amount: '' }]
    });
  };

  const removeCargoItem = (index) => {
    if (operatorCargoForm.cargo_items.length > 1) {
      const newItems = operatorCargoForm.cargo_items.filter((_, i) => i !== index);
      setOperatorCargoForm({
        ...operatorCargoForm,
        cargo_items: newItems
      });
      calculateTotalsWithIndividualPrices(newItems);
    }
  };

  const updateCargoItem = (index, field, value) => {
    const newItems = [...operatorCargoForm.cargo_items];
    newItems[index] = { ...newItems[index], [field]: value };
    
    // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º total_amount –µ—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏—Å—å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ, –≤–µ—Å –∏–ª–∏ —Ü–µ–Ω–∞
    if (field === 'quantity' || field === 'weight' || field === 'price_per_kg') {
      const item = newItems[index];
      const quantity = parseFloat(item.quantity) || 0;
      const weight = parseFloat(item.weight) || 0;
      const pricePerKg = parseFloat(item.price_per_kg) || 0;
      newItems[index].total_amount = (quantity * weight * pricePerKg).toFixed(2);
    }
    
    setOperatorCargoForm(prev => ({
      ...prev,
      cargo_items: newItems
    }));
    
    // Debounce –ø–µ—Ä–µ—Å—á–µ—Ç –∏—Ç–æ–≥–æ–≤ —Ç–æ–ª—å–∫–æ –¥–ª—è —á–∏—Å–ª–æ–≤—ã—Ö –ø–æ–ª–µ–π
    if (field === 'quantity' || field === 'weight' || field === 'price_per_kg') {
      setTimeout(() => calculateTotalsWithIndividualPrices(newItems), 100);
    }
  };

  const calculateTotalsWithIndividualPrices = (cargoItems = operatorCargoForm.cargo_items) => {
    let totalWeightSum = 0;
    let totalCostSum = 0;
    const breakdown = [];
    
    cargoItems.forEach((item, index) => {
      const quantity = parseFloat(item.quantity) || 1;
      const weight = parseFloat(item.weight) || 0;
      const pricePerKg = parseFloat(item.price_per_kg) || 0;
      const itemCost = quantity * weight * pricePerKg;
      const totalWeight = quantity * weight;
      
      totalWeightSum += totalWeight;
      totalCostSum += itemCost;
      
      if (weight > 0 && pricePerKg > 0) {
        breakdown.push({
          index: index + 1,
          name: item.cargo_name || `–ì—Ä—É–∑ ${index + 1}`,
          quantity,
          weight: totalWeight,
          pricePerKg,
          cost: itemCost
        });
      }
    });
    
    setTotalWeight(totalWeightSum);
    setTotalCost(totalCostSum);
    setCargoBreakdown(breakdown);
  };

  // –°—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è calculateTotals –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Ä–µ–∂–∏–º–æ–º –æ–±—â–µ–π —Ü–µ–Ω—ã
  const calculateTotals = (cargoItems = operatorCargoForm.cargo_items, pricePerKg = operatorCargoForm.price_per_kg) => {
    const weight = cargoItems.reduce((sum, item) => {
      const itemWeight = parseFloat(item.weight) || 0;
      return sum + itemWeight;
    }, 0);
    
    const cost = weight * (parseFloat(pricePerKg) || 0);
    
    setTotalWeight(weight);
    setTotalCost(cost);
  };

  const handleAcceptCargo = async (e) => {
    e.preventDefault();
    
    // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º warehouse_id
      let selectedWarehouseId = operatorCargoForm.warehouse_id;
      
      // –ï—Å–ª–∏ –Ω–µ –≤—ã–±—Ä–∞–Ω —Å–∫–ª–∞–¥, –≤—ã–±–∏—Ä–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
      if (!selectedWarehouseId && operatorWarehouses.length > 0) {
        selectedWarehouseId = operatorWarehouses[0].id;
        console.log('Auto-selected warehouse:', selectedWarehouseId);
      }
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∫–ª–∞–¥ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—É
      if (selectedWarehouseId && !operatorWarehouses.find(w => w.id === selectedWarehouseId)) {
        // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∫–ª–∞–¥ –Ω–µ –ø—Ä–∏–Ω–∞–¥–ª–µ–∂–∏—Ç –æ–ø–µ—Ä–∞—Ç–æ—Ä—É, –≤—ã–±–∏—Ä–∞–µ–º –ø–µ—Ä–≤—ã–π –¥–æ—Å—Ç—É–ø–Ω—ã–π
        selectedWarehouseId = operatorWarehouses.length > 0 ? operatorWarehouses[0].id : null;
        console.log('Corrected warehouse selection:', selectedWarehouseId);
      }
      
      if (!selectedWarehouseId) {
        showAlert('–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –æ–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Å–∫–ª–∞–¥ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞. –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.', 'error');
        return;
      }
      
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
      const confirmationData = {
        sender_info: {
          full_name: operatorCargoForm.sender_full_name,
          phone: operatorCargoForm.sender_phone
        },
        recipient_info: {
          full_name: operatorCargoForm.recipient_full_name,
          phone: operatorCargoForm.recipient_phone,
          address: operatorCargoForm.recipient_address
        },
        delivery_info: {
          city: selectedDeliveryCity,
          warehouse: availableWarehousesForCity.find(w => w.warehouse_id === selectedDeliveryWarehouse)?.warehouse_name || '–ù–µ –≤—ã–±—Ä–∞–Ω',
          method: operatorCargoForm.delivery_method
        },
        cargo_items: operatorCargoForm.cargo_items.map(item => ({
          name: item.cargo_name,
          quantity: parseInt(item.quantity) || 1,
          weight: parseFloat(item.weight) || 0,
          price_per_kg: parseFloat(item.price_per_kg) || 0,
          total_amount: parseFloat(item.total_amount) || 0
        })),
        payment_info: {
          method: operatorCargoForm.payment_method,
          amount: operatorCargoForm.payment_amount,
          due_date: operatorCargoForm.debt_due_date
        },
        totals: {
          total_weight: totalWeight,
          total_cost: totalCost
        }
      };
      
      setConfirmationCargoData(confirmationData);
      setShowCargoConfirmationModal(true);
      
    } catch (error) {
      console.error('Error preparing cargo confirmation:', error);
      showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–µ –¥–∞–Ω–Ω—ã—Ö: ${error.message}`, 'error');
    }
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≥—Ä—É–∑–∞ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç –Ω–∞—Å—Ç–æ—è—â–∏–º QR –∫–æ–¥–∞–º —Å –±–∏–±–ª–∏–æ—Ç–µ–∫–æ–π QRCode.js
  // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü—Ä–æ—Å—Ç—ã–µ —á–∏—Å–ª–æ–≤–æ-—Å–∏–º–≤–æ–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è QR –∫–æ–¥–∞
  const createSimpleQRData = (type, data) => {
    const timestamp = new Date().toISOString().slice(0, 16).replace(/[-:T]/g, ''); // YYYYMMDDHHMM
    
    switch (type) {
      case 'individual_unit':
        // –î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü: TAJLINE|UNIT|250101/01/01|YYYYMMDDHHMM
        const individualNumber = data.individual_number || data;
        return `TAJLINE|UNIT|${individualNumber}|${timestamp}`;
        
      case 'cargo_request':
        // –î–ª—è –∑–∞—è–≤–∫–∏: TAJLINE|REQ|250101|YYYYMMDDHHMM
        const cargoNumber = data.cargo_number || data;
        return `TAJLINE|REQ|${cargoNumber}|${timestamp}`;
        
      case 'warehouse_cell':
        // –î–ª—è —è—á–µ–µ–∫: TAJLINE|CELL|001-01-01-001|YYYYMMDDHHMM
        const cellId = data.cell_id || data;
        return `TAJLINE|CELL|${cellId}|${timestamp}`;
        
      default:
        // –ü—Ä–æ—Å—Ç–æ–π —Ñ–æ—Ä–º–∞—Ç: TAJLINE|DATA|–∑–Ω–∞—á–µ–Ω–∏–µ|timestamp
        return `TAJLINE|DATA|${data.toString()}|${timestamp}`;
    }
  };

  const generateActualQRCode = async (data, size = 200, type = 'data') => {
    console.log(`üéØ –ù–û–í–´–ô –ú–ï–¢–û–î: –ò—Å–ø–æ–ª—å–∑—É–µ–º backend API –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞`, data, type);
    
    try {
      let qrText = '';
      
      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–µ–∫—Å—Ç –¥–ª—è QR –∫–æ–¥–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞
      if (type === 'individual_unit') {
        // –î–ª—è –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã—Ö –µ–¥–∏–Ω–∏—Ü: –Ω–æ–º–µ—Ä –µ–¥–∏–Ω–∏—Ü—ã
        qrText = data.individual_number || data;
      } else if (type === 'cargo_request') {
        // –î–ª—è –∑–∞—è–≤–æ–∫: –Ω–æ–º–µ—Ä –∑–∞—è–≤–∫–∏
        qrText = data.cargo_number || data;
      } else {
        // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é: –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç
        qrText = data.toString();
      }
      
      console.log('üìä QR —Ç–µ–∫—Å—Ç –¥–ª—è backend –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:', qrText);
      
      // –í—Ä–µ–º–µ–Ω–Ω–æ —Å–æ–∑–¥–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω—É—é –∑–∞—è–≤–∫—É –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–æ—Å—Ç–æ–π —Ç–µ–∫—Å—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
      const response = await fetch('/api/backend/generate-simple-qr', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'Authorization': `Bearer ${localStorage.getItem('token')}`
        },
        body: JSON.stringify({
          qr_text: qrText,
          format: 'png'
        })
      });
      
      if (response.ok) {
        const result = await response.json();
        console.log('‚úÖ Backend QR –≥–µ–Ω–µ—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞!');
        return result.qr_code; // base64 –¥–∞–Ω–Ω—ã–µ
      } else {
        throw new Error(`Backend API –æ—à–∏–±–∫–∞: ${response.status}`);
      }
      
    } catch (error) {
      console.warn('‚ö†Ô∏è Backend API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, –∏—Å–ø–æ–ª—å–∑—É–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–µ—Ç–æ–¥:', error);
      
      // –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ê: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç—É –∂–µ –ª–æ–≥–∏–∫—É —á—Ç–æ –∏ –≤ working QR —Å–∏—Å—Ç–µ–º–µ, –Ω–æ –Ω–∞ frontend
      return generateQRWithWorkingMethod(data, type);
    }
  };

  // –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô –ú–ï–¢–û–î: –ö–æ–ø–∏—Ä—É–µ–º –ª–æ–≥–∏–∫—É –∏–∑ —Ä–∞–±–æ—Ç–∞—é—â–µ–π —Å–∏—Å—Ç–µ–º—ã
  const generateQRWithWorkingMethod = async (data, type) => {
    console.log('üîÑ –ê–õ–¨–¢–ï–†–ù–ê–¢–ò–í–ù–´–ô –ú–ï–¢–û–î: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–∞–∫ –≤ —Ä–∞–±–æ—Ç–∞—é—â–µ–π —Å–∏—Å—Ç–µ–º–µ');
    
    let qrText = '';
    
    if (type === 'individual_unit') {
      qrText = data.individual_number || data;
    } else if (type === 'cargo_request') {
      qrText = data.cargo_number || data;
    } else {
      qrText = data.toString();
    }
    
    // –ò–º–∏—Ç–∏—Ä—É–µ–º —Å–æ–∑–¥–∞–Ω–∏–µ QR —Ç–∞–∫ –∂–µ, –∫–∞–∫ —ç—Ç–æ –¥–µ–ª–∞–µ—Ç backend —Å –ø–æ–º–æ—â—å—é qrcode –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
    return new Promise((resolve) => {
      try {
        // –°–æ–∑–¥–∞–µ–º —Ñ–∏–∫—Ç–∏–≤–Ω—ã–π –∑–∞–ø—Ä–æ—Å –∫ –Ω–∞—à–µ–º—É —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ–º—É API –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
        const canvas = document.createElement('canvas');
        const size = 200;
        canvas.width = size;
        canvas.height = size;
        const ctx = canvas.getContext('2d');
        
        // –ò–º–∏—Ç–∏—Ä—É–µ–º backend –≥–µ–Ω–µ—Ä–∞—Ü–∏—é
        // –ü—Ä–æ—Å—Ç–æ–π –ø–æ–¥—Ö–æ–¥: —Å–æ–∑–¥–∞–µ–º Data URL –≤ —Ç–æ–º –∂–µ —Ñ–æ—Ä–º–∞—Ç–µ —á—Ç–æ backend
        
        // –î–ª—è –Ω–∞—á–∞–ª–∞ —Å–æ–∑–¥–∞–¥–∏–º –ø—Ä–æ—Å—Ç—É—é –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—é –ø–æ –æ–±—Ä–∞–∑—Ü—É backend
        const createBackendStyleQR = (text) => {
          // –ë–µ–ª—ã–π —Ñ–æ–Ω
          ctx.fillStyle = 'white';
          ctx.fillRect(0, 0, size, size);
          
          // –ß–µ—Ä–Ω–∞—è —Ä–∞–º–∫–∞ (–∏–º–∏—Ç–∏—Ä—É—è qrcode border=4)
          const borderSize = 4;
          ctx.fillStyle = 'black';
          ctx.fillRect(0, 0, size, borderSize);
          ctx.fillRect(0, 0, borderSize, size);
          ctx.fillRect(size - borderSize, 0, borderSize, size);
          ctx.fillRect(0, size - borderSize, size, borderSize);
          
          // –°–æ–∑–¥–∞–µ–º QR-–ø–æ–¥–æ–±–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω, –∏–º–∏—Ç–∏—Ä—É—é—â–∏–π qrcode.constants.ERROR_CORRECT_L
          const modules = 21; // version=1 –¥–∞–µ—Ç 21x21 –º–æ–¥—É–ª–µ–π
          const moduleSize = (size - borderSize * 2) / modules;
          const offset = borderSize;
          
          // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ–∫—Å—Ç–∞ (–∫–∞–∫ backend)
          let hash = 0;
          for (let i = 0; i < text.length; i++) {
            const char = text.charCodeAt(i);
            hash = ((hash << 5) - hash) + char;
            hash = hash & hash;
          }
          
          // –†–∏—Å—É–µ–º finder patterns (–ø–æ–∑–∏—Ü–∏–æ–Ω–Ω—ã–µ –º–∞—Ä–∫–µ—Ä—ã)
          const drawFinder = (x, y) => {
            const finderSize = 7;
            // –í–Ω–µ—à–Ω–∏–π –∫–≤–∞–¥—Ä–∞—Ç 7x7
            ctx.fillStyle = 'black';
            ctx.fillRect(offset + x * moduleSize, offset + y * moduleSize, 
                       finderSize * moduleSize, finderSize * moduleSize);
            // –í–Ω—É—Ç—Ä–µ–Ω–Ω–∏–π –±–µ–ª—ã–π –∫–≤–∞–¥—Ä–∞—Ç 5x5
            ctx.fillStyle = 'white';
            ctx.fillRect(offset + (x + 1) * moduleSize, offset + (y + 1) * moduleSize, 
                       (finderSize - 2) * moduleSize, (finderSize - 2) * moduleSize);
            // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —á–µ—Ä–Ω—ã–π –∫–≤–∞–¥—Ä–∞—Ç 3x3
            ctx.fillStyle = 'black';
            ctx.fillRect(offset + (x + 2) * moduleSize, offset + (y + 2) * moduleSize, 
                       (finderSize - 4) * moduleSize, (finderSize - 4) * moduleSize);
          };
          
          // Finder patterns –≤ —É–≥–ª–∞—Ö
          drawFinder(0, 0);    // –í–µ—Ä—Ö–Ω–∏–π –ª–µ–≤—ã–π
          drawFinder(14, 0);   // –í–µ—Ä—Ö–Ω–∏–π –ø—Ä–∞–≤—ã–π (21-7=14)
          drawFinder(0, 14);   // –ù–∏–∂–Ω–∏–π –ª–µ–≤—ã–π
          
          // Timing patterns
          ctx.fillStyle = 'black';
          for (let i = 8; i < 13; i++) {
            if (i % 2 === 0) {
              ctx.fillRect(offset + i * moduleSize, offset + 6 * moduleSize, 
                         moduleSize, moduleSize);
              ctx.fillRect(offset + 6 * moduleSize, offset + i * moduleSize, 
                         moduleSize, moduleSize);
            }
          }
          
          // Data modules (–∏–º–∏—Ç–∏—Ä—É–µ–º box_size=10 –∏–∑ backend)
          for (let x = 0; x < modules; x++) {
            for (let y = 0; y < modules; y++) {
              // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –æ–±–ª–∞—Å—Ç–∏
              if ((x < 9 && y < 9) || (x > 13 && y < 9) || (x < 9 && y > 13)) continue;
              if ((x === 6 && y >= 8 && y < 13) || (y === 6 && x >= 8 && x < 13)) continue;
              
              // –î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω (–∫–∞–∫ ERROR_CORRECT_L)
              const seed = hash + x * 31 + y * 47;
              const random = Math.abs(Math.sin(seed)) * 1000;
              
              if (random % 10 > 4) { // 60% –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –¥–ª—è L —É—Ä–æ–≤–Ω—è
                ctx.fillRect(offset + x * moduleSize, offset + y * moduleSize, 
                           moduleSize, moduleSize);
              }
            }
          }
          
          return canvas.toDataURL('image/png');
        };
        
        const qrDataURL = createBackendStyleQR(qrText);
        
        console.log('‚úÖ QR –∫–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–º –º–µ—Ç–æ–¥–æ–º (–∏–º–∏—Ç–∏—Ä—É—è backend)');
        resolve(qrDataURL);
        
      } catch (error) {
        console.error('‚ùå –û—à–∏–±–∫–∞ –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:', error);
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—Ä–æ—Å—Ç—É—é –∫–∞—Ä—Ç–∏–Ω–∫—É —Å —Ç–µ–∫—Å—Ç–æ–º
        const canvas = document.createElement('canvas');
        canvas.width = 200;
        canvas.height = 200;
        const ctx = canvas.getContext('2d');
        ctx.fillStyle = 'white';
        ctx.fillRect(0, 0, 200, 200);
        ctx.fillStyle = 'black';
        ctx.font = '12px Arial';
        ctx.textAlign = 'center';
        ctx.fillText('QR –ö–û–î', 100, 90);
        ctx.fillText(qrText, 100, 110);
        resolve(canvas.toDataURL('image/png'));
      }
    });
  };

  // –ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ô FALLBACK: –°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã—Ö QR –∫–æ–¥–æ–≤ –±–µ–∑ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
  const generateStandardQRCode = (data, size = 200) => {
    console.log('‚ö†Ô∏è FALLBACK: –ò—Å–ø–æ–ª—å–∑—É–µ–º Google Charts API –¥–ª—è QR –∫–æ–¥–∞:', data);
    
    try {
      // –ò—Å–ø–æ–ª—å–∑—É–µ–º Google Charts QR API –∫–∞–∫ fallback
      const encodedData = encodeURIComponent(data);
      const qrUrl = `https://chart.googleapis.com/chart?chs=${size}x${size}&cht=qr&chl=${encodedData}&choe=UTF-8`;
      
      // –°–æ–∑–¥–∞–µ–º canvas –∏ —Ä–∏—Å—É–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      return new Promise((resolve) => {
        const canvas = document.createElement('canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = size;
        canvas.height = size;
        
        const img = new Image();
        img.crossOrigin = 'anonymous';
        
        img.onload = () => {
          ctx.fillStyle = '#FFFFFF';
          ctx.fillRect(0, 0, size, size);
          ctx.drawImage(img, 0, 0, size, size);
          resolve(canvas.toDataURL('image/png'));
        };
        
        img.onerror = () => {
          console.warn('‚ö†Ô∏è Google Charts API –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω, —Å–æ–∑–¥–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π QR-–ø–æ–¥–æ–±–Ω—ã–π –∫–æ–¥');
          resolve(generateBasicQRPattern(data, size));
        };
        
        img.src = qrUrl;
      });
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ fallback –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:', error);
      return generateBasicQRPattern(data, size);
    }
  };

  // –ë–ê–ó–û–í–´–ô QR-–ü–ê–¢–¢–ï–†–ù –∫–∞–∫ –ø–æ—Å–ª–µ–¥–Ω–∏–π fallback
  const generateBasicQRPattern = (data, size = 200) => {
    console.log('‚ö†Ô∏è –ë–ê–ó–û–í–´–ô FALLBACK: –°–æ–∑–¥–∞–µ–º QR-–ø–æ–¥–æ–±–Ω—ã–π –∫–æ–¥ –¥–ª—è:', data);
    
    const canvas = document.createElement('canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = size;
    canvas.height = size;
    
    // –ë–µ–ª—ã–π —Ñ–æ–Ω
    ctx.fillStyle = '#FFFFFF';
    ctx.fillRect(0, 0, size, size);
    
    // –†–∞–º–∫–∞
    ctx.fillStyle = '#000000';
    ctx.fillRect(0, 0, size, 4);
    ctx.fillRect(0, 0, 4, size);
    ctx.fillRect(size-4, 0, 4, size);
    ctx.fillRect(0, size-4, size, 4);
    
    // –¢–µ–∫—Å—Ç –≤–º–µ—Å—Ç–æ QR –∫–æ–¥–∞
    ctx.fillStyle = '#000000';
    ctx.font = '12px monospace';
    ctx.textAlign = 'center';
    ctx.fillText('TAJLINE QR', size/2, size/2 - 20);
    
    // –£–ø—Ä–æ—â–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
    const shortData = data.length > 20 ? data.substring(0, 17) + '...' : data;
    ctx.font = '10px monospace';
    ctx.fillText(shortData, size/2, size/2);
    
    ctx.font = '8px monospace';
    ctx.fillText('–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ', size/2, size/2 + 20);
    ctx.fillText(new Date().toLocaleDateString('ru-RU'), size/2, size/2 + 35);
    
    return canvas.toDataURL('image/png');
  };

  // –£–õ–£–ß–®–ï–ù–ù–´–ô FALLBACK: –°–æ–∑–¥–∞–Ω–∏–µ –∫–∞—á–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö QR-–ø–æ–¥–æ–±–Ω—ã—Ö –∫–æ–¥–æ–≤ –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏
  // –£–¥–∞–ª–µ–Ω–∞ —Å—Ç–∞—Ä–∞—è —Ñ—É–Ω–∫—Ü–∏—è generateSimpleQRCode - –∑–∞–º–µ–Ω–µ–Ω–∞ –Ω–∞ generateStandardQRCode –∏ generateBasicQRPattern

  // –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–µ—á–∞—Ç—å QR –∫–æ–¥–æ–≤ (—Ç–æ–ª—å–∫–æ QR –∫–æ–¥—ã, –Ω–µ –≤—Å—é —Å—Ç—Ä–∞–Ω–∏—Ü—É)
  const printQRCodes = (qrCodes) => {
    try {
      if (!qrCodes || qrCodes.length === 0) {
        showAlert('–ù–µ—Ç QR –∫–æ–¥–æ–≤ –¥–ª—è –ø–µ—á–∞—Ç–∏', 'warning');
        return;
      }

      const printWindow = window.open('', '_blank');
      if (!printWindow) {
        showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞.', 'error');
        return;
      }

      // –°–æ–∑–¥–∞–µ–º HTML –¥–ª—è –ø–µ—á–∞—Ç–∏ —Ç–æ–ª—å–∫–æ QR –∫–æ–¥–æ–≤
      let printContent = `
        <html>
          <head>
            <title>QR –∫–æ–¥—ã –≥—Ä—É–∑–∞</title>
            <style>
              body {
                font-family: Arial, sans-serif;
                margin: 0;
                padding: 20px;
                background: white;
              }
              .qr-container {
                display: grid;
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
                gap: 20px;
                page-break-inside: avoid;
              }
              .qr-item {
                border: 2px solid #333;
                border-radius: 8px;
                padding: 15px;
                text-align: center;
                background: white;
                page-break-inside: avoid;
              }
              .cargo-name {
                font-size: 16px;
                font-weight: bold;
                margin-bottom: 10px;
                color: #333;
              }
              .qr-code-img {
                width: 200px;
                height: 200px;
                margin: 10px auto;
                border: 1px solid #ddd;
              }
              .cargo-number {
                font-size: 14px;
                font-weight: bold;
                margin-top: 10px;
                color: #666;
                font-family: monospace;
              }
              .item-info {
                font-size: 12px;
                color: #888;
                margin-top: 5px;
              }
              @media print {
                body { margin: 0; padding: 10px; }
                .qr-container { gap: 15px; }
                .qr-item { margin-bottom: 15px; }
              }
            </style>
          </head>
          <body>
            <div class="qr-container">
      `;

      // –î–æ–±–∞–≤–ª—è–µ–º –∫–∞–∂–¥—ã–π QR –∫–æ–¥ –¥–ª—è –µ–¥–∏–Ω–∏—Ü—ã –≥—Ä—É–∑–∞
      qrCodes.forEach((qr, index) => {
        printContent += `
          <div class="qr-item">
            <div class="cargo-name">${qr.cargo_name}</div>
            ${qr.qr_code_image ? `<img src="${qr.qr_code_image}" class="qr-code-img" alt="QR –∫–æ–¥ ${qr.id}">` : `<div class="qr-code-img" style="display: flex; align-items: center; justify-content: center; background: #f0f0f0;">QR –∫–æ–¥</div>`}
            <div class="cargo-number">${qr.id}</div>
            <div class="item-info">
              <div>–ï–¥–∏–Ω–∏—Ü–∞: <strong>${qr.item_number} –∏–∑ ${qr.total_items}</strong></div>
              <div>–í–µ—Å –µ–¥–∏–Ω–∏—Ü—ã: <strong>${(qr.weight / qr.total_items).toFixed(2)} –∫–≥</strong></div>
              <div>–°—Ç–æ–∏–º–æ—Å—Ç—å: <strong>${qr.total_amount?.toFixed(2)} ‚ÇΩ</strong></div>
            </div>
          </div>
        `;
      });

      printContent += `
            </div>
            <script>
              window.onload = function() {
                window.print();
                setTimeout(() => window.close(), 1000);
              }
            </script>
          </body>
        </html>
      `;

      printWindow.document.write(printContent);
      printWindow.document.close();
      
      showAlert(`–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –Ω–∞ –ø–µ—á–∞—Ç—å ${qrCodes.length} QR –∫–æ–¥–æ–≤`, 'success');
    } catch (error) {
      console.error('Error printing QR codes:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–æ–≤: ' + error.message, 'error');
    }
  };

  // –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–£–ù–ö–¶–ò–Ø: –°–∫–∞—á–∏–≤–∞–Ω–∏–µ QR –∫–æ–¥–æ–≤
  const downloadQRCodes = (qrCodes) => {
    try {
      if (!qrCodes || qrCodes.length === 0) {
        showAlert('–ù–µ—Ç QR –∫–æ–¥–æ–≤ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è', 'warning');
        return;
      }

      // –°–æ–∑–¥–∞–µ–º ZIP —Ñ–∞–π–ª —Å QR –∫–æ–¥–∞–º–∏ (–≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ JSZip)
      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      canvas.width = 800;
      canvas.height = Math.ceil(qrCodes.length / 2) * 400;
      
      // –ë–µ–ª—ã–π —Ñ–æ–Ω
      ctx.fillStyle = '#FFFFFF';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      
      let currentX = 0;
      let currentY = 0;
      
      for (let i = 0; i < qrCodes.length; i++) {
        const qr = qrCodes[i];
        
        // –ü–æ–∑–∏—Ü–∏—è –¥–ª—è —Ç–µ–∫—É—â–µ–≥–æ QR –∫–æ–¥–∞
        const x = currentX * 400;
        const y = currentY * 400;
        
        // –†–∏—Å—É–µ–º —Ä–∞–º–∫—É
        ctx.strokeStyle = '#333';
        ctx.lineWidth = 2;
        ctx.strokeRect(x + 20, y + 20, 360, 360);
        
        // –ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ —Å–≤–µ—Ä—Ö—É
        ctx.fillStyle = '#333';
        ctx.font = 'bold 16px Arial';
        ctx.textAlign = 'center';
        ctx.fillText(qr.cargo_name, x + 200, y + 50);
        
        // QR –∫–æ–¥ (–ø—Ä–æ—Å—Ç–æ–π –ø—Ä—è–º–æ—É–≥–æ–ª—å–Ω–∏–∫ —Å –¥–∞–Ω–Ω—ã–º–∏)
        const qrImage = generateActualQRCode(qr.id, 200);
        if (qrImage) {
          const img = new Image();
          img.onload = function() {
            ctx.drawImage(img, x + 100, y + 80, 200, 200);
          };
          img.src = qrImage;
        }
        
        // –ù–æ–º–µ—Ä –≥—Ä—É–∑–∞ —Å–Ω–∏–∑—É
        ctx.font = 'bold 14px monospace';
        ctx.fillText(qr.id, x + 200, y + 320);
        
        // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ
        ctx.font = '12px Arial';
        ctx.fillStyle = '#666';
        ctx.fillText(`–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${qr.quantity} —à—Ç`, x + 200, y + 340);
        ctx.fillText(`–í–µ—Å: ${qr.weight} –∫–≥`, x + 200, y + 355);
        ctx.fillText(`–°—É–º–º–∞: ${qr.total_amount?.toFixed(2)} ‚ÇΩ`, x + 200, y + 370);
        
        // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ–∑–∏—Ü–∏–∏
        currentX++;
        if (currentX >= 2) {
          currentX = 0;
          currentY++;
        }
      }
      
      // –°–∫–∞—á–∏–≤–∞–µ–º –∫–∞–∫ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
      canvas.toBlob((blob) => {
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `QR_–∫–æ–¥—ã_–≥—Ä—É–∑–∞_${new Date().toISOString().slice(0, 10)}.png`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        
        showAlert(`–°–∫–∞—á–∞–Ω–æ ${qrCodes.length} QR –∫–æ–¥–æ–≤`, 'success');
      }, 'image/png');
      
    } catch (error) {
      console.error('Error downloading QR codes:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏–∏ QR –∫–æ–¥–æ–≤: ' + error.message, 'error');
    }
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –§–∞–∫—Ç–∏—á–µ—Å–∫–∞—è –æ—Ç–ø—Ä–∞–≤–∫–∞ –≥—Ä—É–∑–∞ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  const handleConfirmCargoAcceptance = async () => {
    try {
      setQrGenerationInProgress(true);
      
      // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω–æ–π —Ñ–æ—Ä–º—ã
      const data = confirmationCargoData;
      
      // –ü–æ–¥–≥–æ—Ç–∞–≤–ª–∏–≤–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫–∞–∫ —Ä–∞–Ω—å—à–µ
      let selectedWarehouseId = operatorWarehouses.length > 0 ? operatorWarehouses[0].id : null;
      
      const requestData = {
        sender_full_name: data.sender_info.full_name,
        sender_phone: data.sender_info.phone,
        recipient_full_name: data.recipient_info.full_name,
        recipient_phone: data.recipient_info.phone,
        recipient_address: data.recipient_info.address,
        description: operatorCargoForm.description,
        route: operatorCargoForm.route,
        cargo_items: data.cargo_items.map(item => ({
          cargo_name: item.name,
          quantity: item.quantity,
          weight: item.weight,
          price_per_kg: item.price_per_kg,
          total_amount: item.total_amount
        })),
        warehouse_id: selectedWarehouseId,
        delivery_city: data.delivery_info.city,
        delivery_warehouse_id: selectedDeliveryWarehouse,
        payment_method: data.payment_info.method,
        payment_amount: data.payment_info.amount ? parseFloat(data.payment_info.amount) : null,
        debt_due_date: data.payment_info.due_date || null,
        delivery_method: data.delivery_info.method === 'city_delivery' ? 'home_delivery' : data.delivery_info.method,
        // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ–¥–∞–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞—è–≤–∫–∏
        preferred_cargo_number: preGeneratedCargoNumber
      };
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤
      setQrGenerationInProgress(true);
      
      // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–∞–Ω–Ω—ã–µ –≥—Ä—É–∑–∞ –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ
      setConfirmationCargoData(data);
      
      console.log('üîÑ –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...');
      
      // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –≤ backend
      const response = await apiCall('/api/operator/cargo/accept', 'POST', requestData);
      
      console.log('üîç –û—Ç–≤–µ—Ç –æ—Ç backend:', response);
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º cargo_items –∏–∑ –æ—Ç–≤–µ—Ç–∞ API
      const qrCodes = [];
      const application_number = response.cargo_number || '000000000';
      const cargo_items_from_api = response.cargo_items || [];
      
      console.log(`üîÑ –ù–∞—á–∏–Ω–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ü–∏—é QR –∫–æ–¥–æ–≤ –¥–ª—è –∑–∞—è–≤–∫–∏: ${application_number}`);
      console.log(`üì¶ cargo_items –∏–∑ API:`, cargo_items_from_api);
      console.log(`üì¶ –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–∏–ø–æ–≤ –≥—Ä—É–∑–∞ –≤ API: ${cargo_items_from_api.length}`);
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –∫–æ–¥—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –∏–∑ API (–Ω–µ –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π —Ñ–æ—Ä–º—ã)
      for (let cargoIndex = 0; cargoIndex < cargo_items_from_api.length; cargoIndex++) {
        const item = cargo_items_from_api[cargoIndex];
        const cargo_id_base = `${application_number}/${String(cargoIndex + 1).padStart(2, '0')}`;
        
        console.log(`üìã –ì—Ä—É–∑ ${cargoIndex + 1}: "${item.cargo_name}" (–∫–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${item.quantity})`);
        
        // –°–æ–∑–¥–∞–µ–º QR –∫–æ–¥ –¥–ª—è –∫–∞–∂–¥–æ–π –µ–¥–∏–Ω–∏—Ü—ã –≥—Ä—É–∑–∞
        for (let i = 1; i <= item.quantity; i++) {
          const item_id = `${cargo_id_base}/${String(i).padStart(2, '0')}`;  // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –í–µ–¥—É—â–∏–µ –Ω—É–ª–∏ –¥–ª—è unit_index
          
          console.log(`üîÑ –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º QR –∫–æ–¥ –¥–ª—è –µ–¥–∏–Ω–∏—Ü—ã ${i}/${item.quantity}: ${item_id}`);
          
          // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞ –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω–æ–π –µ–¥–∏–Ω–∏—Ü—ã
          const qrCodeImage = await generateActualQRCode({
            individual_number: item_id,
            cargo_name: item.cargo_name
          }, 200, 'individual_unit');
          
          qrCodes.push({
            id: item_id,
            cargo_name: item.cargo_name,
            cargo_index: cargoIndex + 1,
            item_number: i,
            total_items: item.quantity,
            weight: item.weight,
            price_per_kg: item.price_per_kg,
            total_amount: item.total_amount / item.quantity, // –¶–µ–Ω–∞ –∑–∞ —ç—Ç—É –µ–¥–∏–Ω–∏—Ü—É
            qr_code_image: qrCodeImage
          });
          
          console.log(`‚úÖ QR –∫–æ–¥ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è: ${item_id}`);
        }
      }
      
      console.log(`üéâ –í—Å–µ–≥–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–æ QR –∫–æ–¥–æ–≤: ${qrCodes.length}`);
      
      setGeneratedQRCodes(qrCodes);
      setShowCargoConfirmationModal(true);
      setQrGenerationInProgress(false);
      
      console.log('üéâ –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å QR –∫–æ–¥–∞–º–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–æ');
      showAlert('–ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω—è—Ç! –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã QR –∫–æ–¥—ã –¥–ª—è –∫–∞–∂–¥–æ–π –µ–¥–∏–Ω–∏—Ü—ã.', 'success');
      
      // –°–±—Ä–æ—Å —Ñ–æ—Ä–º—ã
      const warehouseId = operatorWarehouses.length === 1 ? operatorWarehouses[0].id : '';
      setOperatorCargoForm({
        sender_full_name: '',
        sender_phone: '',
        recipient_full_name: '',
        recipient_phone: '',
        recipient_address: '',
        weight: '',
        cargo_name: '',
        declared_value: '',
        description: '',
        route: 'moscow_to_tajikistan',
        cargo_items: [{ cargo_name: '', quantity: 1, weight: '', price_per_kg: '', total_amount: '' }],
        price_per_kg: '',
        use_multi_cargo: true,
        warehouse_id: warehouseId,
        payment_method: 'not_paid',
        payment_amount: '',
        debt_due_date: '',
        delivery_method: 'pickup'
      });
      
      // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏–π
      setSelectedDeliveryCity('');
      setSelectedDeliveryWarehouse('');
      setCitySearchQuery('');
      setTotalWeight(0);
      setTotalCost(0);
      setCargoBreakdown([]);
      
      fetchOperatorCargo();
      fetchAvailableCargo();
      
      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—á–∏—â–∞–µ–º –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏
      setPreGeneratedCargoNumber(null);
      console.log('‚úÖ –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –Ω–æ–º–µ—Ä –∑–∞—è–≤–∫–∏ –æ—á–∏—â–µ–Ω –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è');
      
    } catch (error) {
      console.error('Error confirming cargo acceptance:', error);
      showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ –≥—Ä—É–∑–∞: ${error.message}`, 'error');
      setQrGenerationInProgress(false);
    }
  };

  // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
  const closeCargoConfirmationModal = () => {
    setShowCargoConfirmationModal(false);
    setConfirmationCargoData(null);
    setGeneratedQRCodes([]);
    setQrGenerationInProgress(false);
  };

  // –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –û—Ç–ø—Ä–∞–≤–∫–∞ –≥—Ä—É–∑–∞ –∫—É—Ä—å–µ—Ä–æ–º
  const handleSendToCourier = async () => {
    if (!operatorCargoForm.pickup_required) {
      showAlert('–ù–µ–æ–±—Ö–æ–¥–∏–º–æ –≤–∫–ª—é—á–∏—Ç—å –æ–ø—Ü–∏—é "–¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞"', 'error');
      return;
    }

    // –í–∞–ª–∏–¥–∞—Ü–∏—è –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã—Ö –ø–æ–ª–µ–π –¥–ª—è –∫—É—Ä—å–µ—Ä—Å–∫–æ–≥–æ –∑–∞–±–æ—Ä–∞
    if (!operatorCargoForm.sender_full_name.trim()) {
      showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –§–ò–û –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è', 'error');
      return;
    }
    
    if (!operatorCargoForm.sender_phone.trim()) {
      showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∫–æ–Ω—Ç–∞–∫—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è', 'error');
      return;
    }
    
    if (!operatorCargoForm.cargo_name.trim()) {
      showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –Ω–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞', 'error');
      return;
    }
    
    if (!operatorCargoForm.pickup_address.trim()) {
      showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∞–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞ –≥—Ä—É–∑–∞', 'error');
      return;
    }
    
    if (!operatorCargoForm.pickup_date) {
      showAlert('–í—ã–±–µ—Ä–∏—Ç–µ –¥–∞—Ç—É –∑–∞–±–æ—Ä–∞', 'error');
      return;
    }
    
    if (!operatorCargoForm.pickup_time_from || !operatorCargoForm.pickup_time_to) {
      showAlert('–£–∫–∞–∂–∏—Ç–µ –≤—Ä–µ–º—è –∑–∞–±–æ—Ä–∞ (—Å –∏ –¥–æ)', 'error');
      return;
    }

    try {
      setQrCodeLoading(true);
      
      // –ì–æ—Ç–æ–≤–∏–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∫—É—Ä—å–µ—Ä–æ–º (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è —Ñ–æ—Ä–º–∞)
      const courierCargoData = {
        sender_full_name: operatorCargoForm.sender_full_name,
        sender_phone: operatorCargoForm.sender_phone,
        recipient_full_name: operatorCargoForm.recipient_full_name || "–ù–µ —É–∫–∞–∑–∞–Ω",
        recipient_phone: operatorCargoForm.recipient_phone || "–ù–µ —É–∫–∞–∑–∞–Ω", 
        recipient_address: operatorCargoForm.recipient_address || "–ù–µ —É–∫–∞–∑–∞–Ω",
        weight: parseFloat(operatorCargoForm.weight) || 0,
        cargo_name: operatorCargoForm.cargo_name,
        declared_value: parseFloat(operatorCargoForm.declared_value) || 0,
        description: operatorCargoForm.description || "–ö—É—Ä—å–µ—Ä—Å–∫–∏–π –∑–∞–±–æ—Ä",
        route: operatorCargoForm.route,
        pickup_required: true,
        pickup_address: operatorCargoForm.pickup_address,
        pickup_date: operatorCargoForm.pickup_date,
        pickup_time_from: operatorCargoForm.pickup_time_from,
        pickup_time_to: operatorCargoForm.pickup_time_to,
        delivery_method: operatorCargoForm.delivery_method,
        courier_fee: parseFloat(operatorCargoForm.courier_fee) || 0
      };

      const response = await apiCall('/api/operator/cargo/create-for-courier', 'POST', courierCargoData);
      
      if (response) {
        showAlert(`‚úÖ –ó–∞—è–≤–∫–∞ –¥–ª—è –∫—É—Ä—å–µ—Ä—Å–∫–æ–≥–æ –∑–∞–±–æ—Ä–∞ —Å–æ–∑–¥–∞–Ω–∞! –ì—Ä—É–∑ ${response.cargo_number}`, 'success');
        
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É
        setOperatorCargoForm({
          sender_full_name: '',
          sender_phone: '',
          recipient_full_name: '',
          recipient_phone: '',
          recipient_address: '',
          weight: '',
          cargo_name: '',
          declared_value: '',
          description: '',
          route: 'moscow_to_tajikistan',
          cargo_items: [{ cargo_name: '', weight: '', price_per_kg: '' }],
          price_per_kg: '',
          use_multi_cargo: false,
          warehouse_id: '',
          payment_method: 'not_paid',
          payment_amount: '',
          debt_due_date: '',
          pickup_required: false,
          pickup_address: '',
          pickup_date: '',
          pickup_time_from: '',
          pickup_time_to: '',
          delivery_method: 'pickup',
          courier_fee: ''
        });
        
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏
        fetchOperatorCargo();
      }
    } catch (error) {
      console.error('Send to courier error:', error);
      showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –¥–ª—è –∫—É—Ä—å–µ—Ä–∞: ' + error.message, 'error');
    } finally {
      setQrCodeLoading(false);
    }
  };

  const handlePlaceCargo = async (cargoId, warehouseId, blockNumber, shelfNumber, cellNumber) => {
    try {
      console.log('üì§ API –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞:');
      const requestData = {
        cargo_id: cargoId,
        warehouse_id: warehouseId,
        block_number: parseInt(blockNumber),
        shelf_number: parseInt(shelfNumber),
        cell_number: parseInt(cellNumber)
      };
      console.log('–î–∞–Ω–Ω—ã–µ –∑–∞–ø—Ä–æ—Å–∞:', requestData);
      
      const response = await apiCall('/api/operator/cargo/place', 'POST', requestData);
      
      console.log('‚úÖ –û—Ç–≤–µ—Ç –æ—Ç API —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:', response);

      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü—Ä–∞–≤–∏–ª—å–Ω–æ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º –æ–±—ä–µ–∫—Ç –æ—Ç–≤–µ—Ç–∞ –æ—Ç API
      let successMessage = '‚úÖ –ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω';
      if (response && typeof response === 'object') {
        if (response.warehouse_name && response.location_code) {
          successMessage = `‚úÖ –ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω –≤ ${response.warehouse_name} (${response.location_code})`;
        } else if (response.warehouse_name) {
          successMessage = `‚úÖ –ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω –≤ ${response.warehouse_name}`;
        } else if (response.location_code) {
          successMessage = `‚úÖ –ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω –≤ —è—á–µ–π–∫–µ ${response.location_code}`;
        }
      }
      
      showAlert(successMessage, 'success');
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –≥—Ä—É–∑–∞ –Ω–∞ "—Ä–∞–∑–º–µ—â–µ–Ω" –≤–æ –í–°–ï–• —Ç–∞–±–ª–∏—Ü–∞—Ö
      await updateCargoProcessingStatus(cargoId, 'placed');
      
      // –ù–û–í–û–ï: –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ
      await handlePlacementStatusUpdate(cargoId);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã
      fetchPlacedCargo(); // –î–æ–±–∞–≤–ª—è–µ–º –≤ "–†–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã"
      fetchOperatorCargo(operatorCargoFilter, operatorCargoPage, operatorCargoPerPage);
      fetchAllCargo(); // –ê–¥–º–∏–Ω—Å–∫–∏–π —Å–ø–∏—Å–æ–∫
      
      return response;
    } catch (error) {
      console.error('Error placing cargo:', error);
      showAlert('–û—à–∏–±–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞: ' + error.message, 'error');
      throw error;
    }
  };

  const handleSearchCargoForPayment = async () => {
    if (!paymentForm.cargo_number.trim()) return;
    
    try {
      const data = await apiCall(`/api/cashier/search-cargo/${paymentForm.cargo_number}`);
      setCargoForPayment(data);
      setPaymentForm({...paymentForm, amount_paid: data.declared_value.toString()});
    } catch (error) {
      setCargoForPayment(null);
      console.error('Search cargo for payment error:', error);
    }
  };

  const handleProcessPayment = async () => {
    try {
      await apiCall('/api/cashier/process-payment', 'POST', {
        cargo_number: paymentForm.cargo_number,
        amount_paid: parseFloat(paymentForm.amount_paid),
        transaction_type: paymentForm.transaction_type,
        notes: paymentForm.notes
      });
      showAlert('–û–ø–ª–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–∏–Ω—è—Ç–∞!', 'success');
      setPaymentModal(false);
      setCargoForPayment(null);
      setPaymentForm({
        cargo_number: '',
        amount_paid: '',
        transaction_type: 'cash',
        notes: ''
      });
      fetchUnpaidCargo();
      fetchPaymentHistory();
      fetchOperatorCargo();
    } catch (error) {
      console.error('Process payment error:', error);
    }
  };

  const handleOpenWarehouseLayout = async (warehouse) => {
    console.log('Opening warehouse layout for:', warehouse);
    setSelectedWarehouseForLayout(warehouse);
    
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ö–µ–º—ã —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≥—Ä—É–∑–∞—Ö
    try {
      await fetchWarehouseLayoutWithCargo(warehouse.id);
      console.log('Layout fetched, opening modal...');
      setLayoutModal(true);
    } catch (error) {
      console.error('Error opening warehouse layout:', error);
      showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Å—Ö–µ–º—ã —Å–∫–ª–∞–¥–∞: ' + error.message, 'error');
    }
  };

  const printCargoInvoice = (cargo) => {
    // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ—Ç –∂–µ —Ñ–æ—Ä–º–∞—Ç, —á—Ç–æ –∏ printInvoice
    printInvoice(cargo);
  };

  const handleCreateRequest = async (e) => {
    e.preventDefault();
    try {
      await apiCall('/api/user/cargo-request', 'POST', {
        ...requestForm,
        weight: parseFloat(requestForm.weight),
        declared_value: parseFloat(requestForm.declared_value)
      });
      showAlert('–ó–∞—è–≤–∫–∞ –Ω–∞ –≥—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∞–Ω–∞!', 'success');
      setRequestForm({
        recipient_full_name: '',
        recipient_phone: '',
        recipient_address: '',
        pickup_address: '',
        cargo_name: '',
        weight: '',
        declared_value: getDefaultDeclaredValue('moscow_to_tajikistan'), // –ò—Å–ø–æ–ª—å–∑—É–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        description: '',
        route: 'moscow_to_tajikistan'
      });
      fetchMyRequests();
    } catch (error) {
      console.error('Create request error:', error);
      
      // –ü—Ä–∞–≤–∏–ª—å–Ω–∞—è –æ–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫
      let errorMessage = '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∞—á–µ –∑–∞—è–≤–∫–∏';
      
      if (error.message) {
        errorMessage = error.message;
      } else if (typeof error === 'string') {
        errorMessage = error;
      } else if (error.detail) {
        errorMessage = error.detail;
      }
      
      showAlert('–û—à–∏–±–∫–∞ –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–∫–∏: ' + errorMessage, 'error');
    }
  };

  const handleAcceptRequest = async (requestId) => {
    try {
      await apiCall(`/api/admin/cargo-requests/${requestId}/accept`, 'POST');
      showAlert('–ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞ –∏ –≥—Ä—É–∑ —Å–æ–∑–¥–∞–Ω!', 'success');
      fetchCargoRequests();
      fetchOperatorCargo();
      fetchNotifications();
    } catch (error) {
      console.error('Accept request error:', error);
    }
  };

  const handleRejectRequest = async (requestId, reason = '') => {
    try {
      await apiCall(`/api/admin/cargo-requests/${requestId}/reject`, 'POST', { reason });
      showAlert('–ó–∞—è–≤–∫–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∞', 'info');
      fetchCargoRequests();
      fetchNotifications();
    } catch (error) {
      console.error('Reject request error:', error);
    }
  };

  const updateCargoStatus = async (cargoId, status, warehouseLocation = null) => {
    try {
      const params = new URLSearchParams({ status });
      if (warehouseLocation) {
        params.append('warehouse_location', warehouseLocation);
      }
      
      await apiCall(`/api/cargo/${cargoId}/status?${params}`, 'PUT');
      showAlert('–°—Ç–∞—Ç—É—Å –≥—Ä—É–∑–∞ –æ–±–Ω–æ–≤–ª–µ–Ω!', 'success');
      
      if (user.role === 'admin') {
        fetchAllCargo();
      } else if (user.role === 'warehouse_operator') {
        fetchWarehouseCargo();
      }
    } catch (error) {
      console.error('Update status error:', error);
    }
  };

  const toggleUserStatus = async (userId, isActive) => {
    try {
      await apiCall(`/api/admin/users/${userId}/status`, 'PUT', { is_active: !isActive });
      showAlert('–°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑–º–µ–Ω–µ–Ω!', 'success');
      fetchUsers();
    } catch (error) {
      console.error('Toggle user status error:', error);
    }
  };

  const deleteUser = async (userId) => {
    if (window.confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è?')) {
      try {
        await apiCall(`/api/admin/users/${userId}`, 'DELETE');
        showAlert('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É–¥–∞–ª–µ–Ω!', 'success');
        fetchUsers();
      } catch (error) {
        console.error('Delete user error:', error);
      }
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∞–ª–∏–¥–Ω–æ—Å—Ç–∏ —Ç–æ–∫–µ–Ω–∞
  const isTokenValid = (tokenString) => {
    if (!tokenString) return false;
    
    try {
      // –î–µ–∫–æ–¥–∏—Ä—É–µ–º JWT —Ç–æ–∫–µ–Ω –±–µ–∑ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è exp)
      const base64Url = tokenString.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      
      const decoded = JSON.parse(jsonPayload);
      const currentTime = Date.now() / 1000;
      
      // –î–æ–±–∞–≤–ª—è–µ–º –±—É—Ñ–µ—Ä–Ω–æ–µ –≤—Ä–µ–º—è –≤ 5 –º–∏–Ω—É—Ç (300 —Å–µ–∫—É–Ω–¥) –ø–µ—Ä–µ–¥ –∏—Å—Ç–µ—á–µ–Ω–∏–µ–º —Ç–æ–∫–µ–Ω–∞
      const bufferTime = 300;
      
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ –∏—Å—Ç–µ–∫ –ª–∏ —Ç–æ–∫–µ–Ω (—Å —É—á–µ—Ç–æ–º –±—É—Ñ–µ—Ä–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏)
      return decoded.exp && decoded.exp > (currentTime + bufferTime);
    } catch (error) {
      console.error('Token validation error:', error);
      return false;
    }
  };

  const handleLogout = () => {
    // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–µ logout'—ã
    if (isLoggingOut) {
      console.log('Logout already in progress, skipping...');
      return;
    }
    
    console.log('Starting logout process...');
    setIsLoggingOut(true);
    
    localStorage.removeItem('token');
    setToken(null);
    setUser(null);
    
    // –û—á–∏—â–∞–µ–º –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
    clearAllAppData();
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏
    setIsInitializing(false);
    setDataLoaded(false);
    
    // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Å–æ—Å—Ç–æ—è–Ω–∏—è
    setActiveTab('dashboard');
    setActiveSection('dashboard');
    setSidebarOpen(true);
    setCurrentPage('main');
    setShowCargoAcceptanceModal(false);
    setEditingCargo(null);
    setScannerActive(false);
    setScannedCargoInfo(null);
    setShowWarehouseManagementModal(false);
    setSelectedWarehouseForManagement(null);
    
    console.log('Logout completed');
    setIsLoggingOut(false);
  };

  const getStatusBadge = (status) => {
    const statusConfig = {
      created: { label: '–°–æ–∑–¥–∞–Ω', variant: 'secondary' },
      accepted: { label: '–ü—Ä–∏–Ω—è—Ç', variant: 'default' },
      in_transit: { label: '–í –ø—É—Ç–∏', variant: 'default' },
      arrived_destination: { label: '–ü—Ä–∏–±—ã–ª', variant: 'default' },
      completed: { label: '–î–æ—Å—Ç–∞–≤–ª–µ–Ω', variant: 'default' }
    };
    
    const config = statusConfig[status] || { label: status, variant: 'secondary' };
    return <Badge variant={config.variant}>{config.label}</Badge>;
  };

  const getRoleIcon = (role) => {
    switch (role) {
      case 'admin':
        return <Shield className="h-4 w-4" />;
      case 'warehouse_operator':
        return <Warehouse className="h-4 w-4" />;
      default:
        return <User className="h-4 w-4" />;
    }
  };

  const getRoleLabel = (role) => {
    const labels = {
      user: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å',
      admin: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä',
      warehouse_operator: '–û–ø–µ—Ä–∞—Ç–æ—Ä —Å–∫–ª–∞–¥–∞'
    };
    return labels[role] || role;
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Ü–≤–µ—Ç–æ–≤ —Å–∫–ª–∞–¥–∞–º
  const getWarehouseColor = (warehouseName) => {
    if (!warehouseName) return { bg: 'bg-gray-100', border: 'border-gray-300', text: 'text-gray-700' };
    
    // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤
    const name = warehouseName.toLowerCase();
    
    // –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –∫–ª—é—á–µ–≤—ã—Ö —Å–ª–æ–≤ –≤ –Ω–∞–∑–≤–∞–Ω–∏–∏ —Å–∫–ª–∞–¥–∞
    if (name.includes('—Ö—É–¥–∂–∞–Ω–¥') || name.includes('khujand')) {
      return { bg: 'bg-blue-50', border: 'border-l-blue-500', text: 'text-blue-800', badge: 'bg-blue-100' };
    } else if (name.includes('–¥—É—à–∞–Ω–±–µ') || name.includes('dushanbe')) {
      return { bg: 'bg-green-50', border: 'border-l-green-500', text: 'text-green-800', badge: 'bg-green-100' };
    } else if (name.includes('–∫—É–ª–æ–±') || name.includes('kulob')) {
      return { bg: 'bg-purple-50', border: 'border-l-purple-500', text: 'text-purple-800', badge: 'bg-purple-100' };
    } else if (name.includes('–∫—É—Ä–≥–∞–Ω') || name.includes('kurgan')) {
      return { bg: 'bg-orange-50', border: 'border-l-orange-500', text: 'text-orange-800', badge: 'bg-orange-100' };
    } else if (name.includes('–º–æ—Å–∫–≤–∞') || name.includes('moscow')) {
      return { bg: 'bg-red-50', border: 'border-l-red-500', text: 'text-red-800', badge: 'bg-red-100' };
    } else {
      // –î–ª—è –¥—Ä—É–≥–∏—Ö —Å–∫–ª–∞–¥–æ–≤ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π —Ü–≤–µ—Ç –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ö–µ—à–∞ –Ω–∞–∑–≤–∞–Ω–∏—è
      const colors = [
        { bg: 'bg-yellow-50', border: 'border-l-yellow-500', text: 'text-yellow-800', badge: 'bg-yellow-100' },
        { bg: 'bg-pink-50', border: 'border-l-pink-500', text: 'text-pink-800', badge: 'bg-pink-100' },
        { bg: 'bg-indigo-50', border: 'border-l-indigo-500', text: 'text-indigo-800', badge: 'bg-indigo-100' },
        { bg: 'bg-teal-50', border: 'border-l-teal-500', text: 'text-teal-800', badge: 'bg-teal-100' }
      ];
      
      // –ü—Ä–æ—Å—Ç–æ–π —Ö–µ—à –¥–ª—è –∫–æ–Ω—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–≥–æ –≤—ã–±–æ—Ä–∞ —Ü–≤–µ—Ç–∞
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = ((hash << 5) - hash + name.charCodeAt(i)) & 0xffffffff;
      }
      const colorIndex = Math.abs(hash) % colors.length;
      return colors[colorIndex];
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ª–µ–≥–µ–Ω–¥—ã —Ü–≤–µ—Ç–æ–≤ —Å–∫–ª–∞–¥–æ–≤
  const getWarehouseLegend = () => {
    const legend = [
      { name: '–°–∫–ª–∞–¥—ã –•—É–¥–∂–∞–Ω–¥–∞', color: 'bg-blue-500', textColor: 'text-blue-800' },
      { name: '–°–∫–ª–∞–¥—ã –î—É—à–∞–Ω–±–µ', color: 'bg-green-500', textColor: 'text-green-800' },
      { name: '–°–∫–ª–∞–¥—ã –ö—É–ª–æ–±–∞', color: 'bg-purple-500', textColor: 'text-purple-800' },
      { name: '–°–∫–ª–∞–¥—ã –ö—É—Ä–≥–∞–Ω-–¢—é–±–µ', color: 'bg-orange-500', textColor: 'text-orange-800' },
      { name: '–°–∫–ª–∞–¥—ã –ú–æ—Å–∫–≤—ã', color: 'bg-red-500', textColor: 'text-red-800' }
    ];
    return legend;
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const openEditProfile = () => {
    setEditProfileForm({
      full_name: user.full_name || '',
      phone: user.phone || '',
      email: user.email || '',
      address: user.address || ''
    });
    setShowEditProfile(true);
  };

  const saveProfile = async () => {
    try {
      const updatedUser = await apiCall('/api/user/profile', 'PUT', editProfileForm);
      setUser(updatedUser);
      setShowEditProfile(false);
      showAlert('–ü—Ä–æ—Ñ–∏–ª—å –æ–±–Ω–æ–≤–ª–µ–Ω —É—Å–ø–µ—à–Ω–æ!', 'success');
    } catch (error) {
      showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è: ' + error.message, 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
  const openRepeatOrder = (cargo) => {
    setRepeatOrderData(cargo);
    setRepeatOrderForm({
      cargo_items: [{ 
        cargo_name: cargo.cargo_name || cargo.description || '–ì—Ä—É–∑', 
        weight: cargo.weight || '', 
        price_per_kg: cargo.price_per_kg || '50' 
      }],
      recipient_full_name: cargo.recipient_full_name || '',
      recipient_phone: cargo.recipient_phone || '',
      recipient_address: cargo.recipient_address || '',
      route: cargo.route || 'moscow_dushanbe',
      delivery_type: 'standard',
      insurance_requested: false,
      special_instructions: '',
      use_multi_cargo: true
    });
    setShowRepeatOrderModal(true);
    calculateRepeatOrderTotals([{ 
      cargo_name: cargo.cargo_name || cargo.description || '–ì—Ä—É–∑', 
      weight: cargo.weight || '', 
      price_per_kg: cargo.price_per_kg || '50' 
    }]);
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∏—Ç–æ–≥–æ–≤ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
  const calculateRepeatOrderTotals = (cargoItems) => {
    let totalWeight = 0;
    let totalCost = 0;
    const breakdown = [];

    cargoItems.forEach((item, index) => {
      const weight = parseFloat(item.weight) || 0;
      const pricePerKg = parseFloat(item.price_per_kg) || 0;
      const itemCost = weight * pricePerKg;

      totalWeight += weight;
      totalCost += itemCost;

      breakdown.push({
        index: index,
        cargo_name: item.cargo_name || `–ì—Ä—É–∑ ${index + 1}`,
        weight: weight,
        price_per_kg: pricePerKg,
        cost: itemCost
      });
    });

    setRepeatOrderTotalWeight(totalWeight);
    setRepeatOrderTotalCost(totalCost);
    setRepeatOrderBreakdown(breakdown);
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≥—Ä—É–∑–∞ –≤ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–∫–∞–∑–µ
  const handleRepeatOrderItemChange = (index, field, value) => {
    const updatedItems = [...repeatOrderForm.cargo_items];
    updatedItems[index] = { ...updatedItems[index], [field]: value };
    setRepeatOrderForm({ ...repeatOrderForm, cargo_items: updatedItems });
    calculateRepeatOrderTotals(updatedItems);
  };

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≥—Ä—É–∑–∞ –≤ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–∫–∞–∑
  const addRepeatOrderItem = () => {
    const newItems = [...repeatOrderForm.cargo_items, { cargo_name: '', weight: '', price_per_kg: '50' }];
    setRepeatOrderForm({ ...repeatOrderForm, cargo_items: newItems });
    calculateRepeatOrderTotals(newItems);
  };

  // –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –≥—Ä—É–∑–∞ –∏–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
  const removeRepeatOrderItem = (index) => {
    if (repeatOrderForm.cargo_items.length > 1) {
      const newItems = repeatOrderForm.cargo_items.filter((_, i) => i !== index);
      setRepeatOrderForm({ ...repeatOrderForm, cargo_items: newItems });
      calculateRepeatOrderTotals(newItems);
    }
  };

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞
  const submitRepeatOrder = async () => {
    try {
      if (repeatOrderForm.cargo_items.some(item => !item.cargo_name || !item.weight || !item.price_per_kg)) {
        showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–ª—è –≤—Å–µ—Ö –≥—Ä—É–∑–æ–≤', 'error');
        return;
      }

      if (!repeatOrderForm.recipient_full_name || !repeatOrderForm.recipient_phone) {
        showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è', 'error');
        return;
      }

      const orderData = {
        ...repeatOrderForm,
        sender_full_name: user.full_name,
        sender_phone: user.phone,
        total_weight: repeatOrderTotalWeight,
        total_cost: repeatOrderTotalCost
      };

      const result = await apiCall('/api/operator/cargo/accept', 'POST', orderData);
      
      setShowRepeatOrderModal(false);
      setRepeatOrderData(null);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ –∫–ª–∏–µ–Ω—Ç–∞
      fetchClientDashboard();
      fetchClientCargo();
      
      showAlert(`–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! –ù–æ–º–µ—Ä: ${result.cargo_number}`, 'success');
      
    } catch (error) {
      console.error('Error creating repeat order:', error);
      showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: ' + error.message, 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∞–¥–º–∏–Ω–æ–º
  const openAdminEditUser = (user) => {
    setSelectedUserForEdit(user);
    setAdminEditUserForm({
      id: user.id,
      full_name: user.full_name || '',
      phone: user.phone || '',
      email: user.email || '',
      address: user.address || '',
      role: user.role || 'user',
      is_active: user.is_active !== undefined ? user.is_active : true
    });
    setShowAdminEditUser(true);
  };

  const saveAdminUserEdit = async () => {
    try {
      const updatedUser = await apiCall(`/api/admin/users/${adminEditUserForm.id}/update`, 'PUT', adminEditUserForm);
      setShowAdminEditUser(false);
      setSelectedUserForEdit(null);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      fetchUsers();
      fetchUsersByRole();
      
      showAlert('–î–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!', 'success');
    } catch (error) {
      showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ' + error.message, 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –∞–¥–º–∏–Ω–æ–º/–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
  const openAdminRepeatOrder = (cargo) => {
    setAdminRepeatOrderData(cargo);
    setAdminRepeatOrderForm({
      sender_id: cargo.sender_id || '',
      sender_full_name: cargo.sender_full_name || '',
      sender_phone: cargo.sender_phone || '',
      cargo_items: [{ 
        cargo_name: '', // –ê–¥–º–∏–Ω –¥–æ–ª–∂–µ–Ω –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∑–∞–Ω–æ–≤–æ
        weight: '', // –ê–¥–º–∏–Ω –¥–æ–ª–∂–µ–Ω –∑–∞–ø–æ–ª–Ω–∏—Ç—å –∑–∞–Ω–æ–≤–æ
        price_per_kg: '50' // –ó–Ω–∞—á–µ–Ω–∏–µ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      }],
      recipient_full_name: cargo.recipient_full_name || '',
      recipient_phone: cargo.recipient_phone || '',
      recipient_address: cargo.recipient_address || '',
      route: cargo.route || 'moscow_dushanbe',
      delivery_type: 'standard',
      insurance_requested: false,
      special_instructions: `–ü–æ–≤—Ç–æ—Ä –≥—Ä—É–∑–∞ ‚Ññ${cargo.cargo_number}`,
      use_multi_cargo: true
    });
    setShowAdminRepeatOrderModal(true);
    calculateAdminRepeatOrderTotals([{ 
      cargo_name: '', 
      weight: '', 
      price_per_kg: '50'
    }]);
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞ –∏—Ç–æ–≥–æ–≤ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –∞–¥–º–∏–Ω–∞/–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
  const calculateAdminRepeatOrderTotals = (cargoItems) => {
    let totalWeight = 0;
    let totalCost = 0;
    const breakdown = [];

    cargoItems.forEach((item, index) => {
      const weight = parseFloat(item.weight) || 0;
      const pricePerKg = parseFloat(item.price_per_kg) || 0;
      const itemCost = weight * pricePerKg;

      totalWeight += weight;
      totalCost += itemCost;

      breakdown.push({
        index: index,
        cargo_name: item.cargo_name || `–ì—Ä—É–∑ ${index + 1}`,
        weight: weight,
        price_per_kg: pricePerKg,
        cost: itemCost
      });
    });

    setAdminRepeatOrderTotalWeight(totalWeight);
    setAdminRepeatOrderTotalCost(totalCost);
    setAdminRepeatOrderBreakdown(breakdown);
  };

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∏–∑–º–µ–Ω–µ–Ω–∏—è —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≥—Ä—É–∑–∞ –≤ –ø–æ–≤—Ç–æ—Ä–Ω–æ–º –∑–∞–∫–∞–∑–µ –∞–¥–º–∏–Ω–∞
  const handleAdminRepeatOrderItemChange = (index, field, value) => {
    const updatedItems = [...adminRepeatOrderForm.cargo_items];
    updatedItems[index] = { ...updatedItems[index], [field]: value };
    setAdminRepeatOrderForm({ ...adminRepeatOrderForm, cargo_items: updatedItems });
    calculateAdminRepeatOrderTotals(updatedItems);
  };

  // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ –≥—Ä—É–∑–∞ –≤ –ø–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–∫–∞–∑ –∞–¥–º–∏–Ω–∞
  const addAdminRepeatOrderItem = () => {
    const newItems = [...adminRepeatOrderForm.cargo_items, { cargo_name: '', weight: '', price_per_kg: '50' }];
    setAdminRepeatOrderForm({ ...adminRepeatOrderForm, cargo_items: newItems });
    calculateAdminRepeatOrderTotals(newItems);
  };

  // –£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞ –≥—Ä—É–∑–∞ –∏–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –∞–¥–º–∏–Ω–∞
  const removeAdminRepeatOrderItem = (index) => {
    if (adminRepeatOrderForm.cargo_items.length > 1) {
      const newItems = adminRepeatOrderForm.cargo_items.filter((_, i) => i !== index);
      setAdminRepeatOrderForm({ ...adminRepeatOrderForm, cargo_items: newItems });
      calculateAdminRepeatOrderTotals(newItems);
    }
  };

  // –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –∞–¥–º–∏–Ω–æ–º/–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
  const submitAdminRepeatOrder = async () => {
    try {
      if (adminRepeatOrderForm.cargo_items.some(item => !item.cargo_name || !item.weight || !item.price_per_kg)) {
        showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è –¥–ª—è –≤—Å–µ—Ö –≥—Ä—É–∑–æ–≤', 'error');
        return;
      }

      if (!adminRepeatOrderForm.recipient_full_name || !adminRepeatOrderForm.recipient_phone) {
        showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è', 'error');
        return;
      }

      if (!adminRepeatOrderForm.sender_full_name || !adminRepeatOrderForm.sender_phone) {
        showAlert('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è', 'error');
        return;
      }

      const orderData = {
        ...adminRepeatOrderForm,
        total_weight: adminRepeatOrderTotalWeight,
        total_cost: adminRepeatOrderTotalCost
      };

      const result = await apiCall('/api/operator/cargo/accept', 'POST', orderData);
      
      setShowAdminRepeatOrderModal(false);
      setAdminRepeatOrderData(null);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
      if (user.role === 'admin') {
        fetchAllCargo();
      } else if (user.role === 'warehouse_operator') {
        fetchOperatorCargo();
      }
      
      showAlert(`–ü–æ–≤—Ç–æ—Ä–Ω—ã–π –∑–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω! –ù–æ–º–µ—Ä: ${result.cargo_number}`, 'success');
      
    } catch (error) {
      console.error('Error creating admin repeat order:', error);
      showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞: ' + error.message, 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ä–º—ã –ø—Ä–∏–µ–º–∞ –≥—Ä—É–∑–∞ –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const openQuickCargoFromProfile = async (userInfo) => {
    try {
      // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è
      setShowUserProfile(false);
      
      // –ü–æ–ª—É—á–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
      const historyData = selectedUserProfile?.sent_cargo || [];
      
      let senderData = {
        full_name: userInfo.full_name || '',
        phone: userInfo.phone || '',
        address: userInfo.address || ''
      };
      
      let recipientData = {
        full_name: '',
        phone: '',
        address: ''
      };
      
      // –ï—Å–ª–∏ –µ—Å—Ç—å –∏—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π, –±–µ—Ä–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è
      if (historyData.length > 0) {
        const lastCargo = historyData[0]; // –ü–µ—Ä–≤—ã–π —ç–ª–µ–º–µ–Ω—Ç - —Å–∞–º—ã–π –ø–æ—Å–ª–µ–¥–Ω–∏–π
        recipientData = {
          full_name: lastCargo.recipient_full_name || lastCargo.recipient_name || '',
          phone: lastCargo.recipient_phone || '',
          address: lastCargo.recipient_address || ''
        };
      }
      
      // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
      const formData = {
        sender_full_name: senderData.full_name,
        sender_phone: senderData.phone,
        sender_address: senderData.address,
        recipient_full_name: recipientData.full_name,
        recipient_phone: recipientData.phone,
        recipient_address: recipientData.address,
        cargo_items: [{ cargo_name: '', weight: '', price_per_kg: '50' }],
        route: historyData.length > 0 ? historyData[0].route || 'moscow_dushanbe' : 'moscow_dushanbe',
        delivery_type: 'standard',
        insurance_requested: false,
        special_instructions: `–ì—Ä—É–∑ –¥–ª—è ${userInfo.full_name} (${userInfo.user_number})`,
        use_multi_cargo: true
      };
      
      setOperatorCargoForm(formData);
      
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ñ–ª–∞–≥ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è
      setIsFilledFromProfile(true);
      setProfileSourceUser(userInfo);
      
      // –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä
      calculateTotalsWithIndividualPrices([{ cargo_name: '', weight: '', price_per_kg: '50' }]);
      
      // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø—Ä–∏–µ–º–∞ –≥—Ä—É–∑–∞
      setActiveSection('cargo-management');
      setActiveTab('cargo-accept');
      
      if (historyData.length > 0) {
        showAlert(`–§–æ—Ä–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userInfo.full_name}. –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –≤–∑—è—Ç—ã –∏–∑ –ø–æ—Å–ª–µ–¥–Ω–µ–π –æ—Ç–ø—Ä–∞–≤–∫–∏.`, 'info');
      } else {
        showAlert(`–§–æ—Ä–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: ${userInfo.full_name}. –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –Ω—É–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –≤—Ä—É—á–Ω—É—é.`, 'warning');
      }
      
    } catch (error) {
      console.error('Error opening cargo form from profile:', error);
      showAlert('–û—à–∏–±–∫–∞ –æ—Ç–∫—Ä—ã—Ç–∏—è —Ñ–æ—Ä–º—ã: ' + error.message, 'error');
    }
  };

  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è –ø–µ—á–∞—Ç–∏ –Ω–∞–∫–ª–∞–¥–Ω–æ–π –∏ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ —Ç–µ–∫—É—â–µ–π –∑–∞—è–≤–∫–∏
  const canPrintInvoice = () => {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –ø–æ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã
    return (
      operatorCargoForm.sender_full_name && 
      operatorCargoForm.sender_phone && 
      operatorCargoForm.recipient_full_name && 
      operatorCargoForm.recipient_phone &&
      totalWeight > 0 &&
      totalCost > 0
    );
  };

  const handlePrintCurrentInvoice = () => {
    if (!canPrintInvoice()) {
      showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –ø–µ—á–∞—Ç–∏ –Ω–∞–∫–ª–∞–¥–Ω–æ–π', 'warning');
      return;
    }

    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –≥—Ä—É–∑–∞ –∏–∑ —Ç–µ–∫—É—â–µ–π —Ñ–æ—Ä–º—ã
    const tempCargo = {
      cargo_number: `TEMP-${Date.now()}`, // –í—Ä–µ–º–µ–Ω–Ω—ã–π –Ω–æ–º–µ—Ä
      route: operatorCargoForm.route,
      sender_full_name: operatorCargoForm.sender_full_name,
      sender_phone: operatorCargoForm.sender_phone,
      sender_address: operatorCargoForm.sender_address,
      recipient_full_name: operatorCargoForm.recipient_full_name,
      recipient_phone: operatorCargoForm.recipient_phone,
      recipient_address: operatorCargoForm.recipient_address,
      weight: totalWeight,
      total_cost: totalCost,
      declared_value: totalCost,
      cargo_items: operatorCargoForm.use_multi_cargo ? operatorCargoForm.cargo_items : [{
        cargo_name: operatorCargoForm.description || '–ì—Ä—É–∑',
        weight: operatorCargoForm.weight,
        price_per_kg: operatorCargoForm.declared_value / operatorCargoForm.weight
      }],
      created_at: new Date().toISOString()
    };

    // –ü–µ—á–∞—Ç–∞–µ–º –Ω–∞–∫–ª–∞–¥–Ω—É—é
    printInvoice(tempCargo);
  };

  const generateBarcodeData = (cargoData) => {
    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞
    return {
      cargo_number: cargoData.cargo_number,
      sender: cargoData.sender_full_name,
      recipient: cargoData.recipient_full_name,
      weight: cargoData.weight,
      route: cargoData.route,
      date: new Date().toLocaleDateString('ru-RU')
    };
  };

  const handlePrintCurrentBarcode = () => {
    if (!canPrintInvoice()) {
      showAlert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ –ø–æ–ª—è –¥–ª—è –ø–µ—á–∞—Ç–∏ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞', 'warning');
      return;
    }

    // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –æ–±—ä–µ–∫—Ç –≥—Ä—É–∑–∞
    const tempCargo = {
      cargo_number: `TEMP-${Date.now()}`,
      sender_full_name: operatorCargoForm.sender_full_name,
      recipient_full_name: operatorCargoForm.recipient_full_name,
      weight: totalWeight,
      route: operatorCargoForm.route
    };

    // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –∏ –ø–µ—á–∞—Ç–∞–µ–º —à—Ç—Ä–∏—Ö-–∫–æ–¥
    printBarcode(tempCargo);
  };

  const printBarcode = (cargo) => {
    const printWindow = window.open('', '_blank');
    
    if (!printWindow) {
      showAlert('–í—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã. –®—Ç—Ä–∏—Ö-–∫–æ–¥ –±—É–¥–µ—Ç –æ—Ç–∫—Ä—ã—Ç –≤ –Ω–æ–≤–æ–π –≤–∫–ª–∞–¥–∫–µ.', 'warning');
      const barcodeContent = createBarcodeHTML(cargo);
      const dataUrl = `data:text/html;charset=utf-8,${encodeURIComponent(barcodeContent)}`;
      window.open(dataUrl, '_blank');
      return;
    }

    try {
      const barcodeHTML = createBarcodeHTML(cargo);
      printWindow.document.write(barcodeHTML);
      printWindow.document.close();
    } catch (error) {
      console.error('Error creating barcode print:', error);
      showAlert('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.', 'error');
      if (printWindow) {
        printWindow.close();
      }
    }
  };

  const createBarcodeHTML = (cargo) => {
    return `
      <html>
        <head>
          <title>–®—Ç—Ä–∏—Ö-–∫–æ–¥ TAJLINE ‚Ññ ${cargo.cargo_number}</title>
          <meta charset="utf-8">
          <style>
            @page {
              size: A5 landscape;
              margin: 10mm;
            }
            
            body {
              font-family: Arial, sans-serif;
              margin: 0;
              padding: 20px;
              text-align: center;
            }
            
            .barcode-container {
              border: 3px solid #000;
              padding: 30px;
              margin: 20px auto;
              max-width: 500px;
              background: white;
            }
            
            .logo {
              font-size: 32px;
              font-weight: bold;
              letter-spacing: 3px;
              margin-bottom: 20px;
              color: #000;
            }
            
            .cargo-number {
              font-size: 24px;
              font-weight: bold;
              margin: 20px 0;
              padding: 15px;
              border: 2px solid #000;
              background: #f0f0f0;
            }
            
            .barcode-visual {
              margin: 30px 0;
              padding: 20px;
              border: 1px solid #ccc;
              background: white;
              font-family: 'Courier New', monospace;
              letter-spacing: 2px;
            }
            
            .barcode-lines {
              height: 60px;
              background: repeating-linear-gradient(
                90deg,
                #000 0px,
                #000 2px,
                #fff 2px,
                #fff 4px
              );
              margin: 10px 0;
            }
            
            .cargo-info {
              margin: 20px 0;
              text-align: left;
              font-size: 14px;
            }
            
            .cargo-info div {
              margin: 8px 0;
              display: flex;
              justify-content: space-between;
              border-bottom: 1px dotted #ccc;
              padding-bottom: 5px;
            }
            
            .cargo-info .label {
              font-weight: bold;
              width: 40%;
            }
            
            .cargo-info .value {
              width: 60%;
              text-align: right;
            }
            
            .print-date {
              font-size: 10px;
              color: #666;
              margin-top: 20px;
              border-top: 1px solid #ccc;
              padding-top: 10px;
            }

            @media print {
              body { -webkit-print-color-adjust: exact; }
            }
          </style>
        </head>
        <body>
          <div class="barcode-container">
            <div class="logo">TAJLINE</div>
            
            <div class="cargo-number">
              ${cargo.cargo_number}
            </div>
            
            <div class="barcode-visual">
              <div class="barcode-lines"></div>
              <div style="font-size: 16px; font-weight: bold;">${cargo.cargo_number}</div>
            </div>
            
            <div class="cargo-info">
              <div>
                <span class="label">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</span>
                <span class="value">${cargo.sender_full_name}</span>
              </div>
              <div>
                <span class="label">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</span>
                <span class="value">${cargo.recipient_full_name}</span>
              </div>
              <div>
                <span class="label">–í–µ—Å:</span>
                <span class="value">${cargo.weight} –∫–≥</span>
              </div>
              <div>
                <span class="label">–ú–∞—Ä—à—Ä—É—Ç:</span>
                <span class="value">${cargo.route === 'moscow_dushanbe' ? '–ú–æ—Å–∫–≤–∞ ‚Üí –î—É—à–∞–Ω–±–µ' : 
                                     cargo.route === 'moscow_khujand' ? '–ú–æ—Å–∫–≤–∞ ‚Üí –•—É–¥–∂–∞–Ω–¥' : 
                                     cargo.route === 'moscow_kulob' ? '–ú–æ—Å–∫–≤–∞ ‚Üí –ö—É–ª–æ–±' : 
                                     cargo.route === 'moscow_kurgantyube' ? '–ú–æ—Å–∫–≤–∞ ‚Üí –ö—É—Ä–≥–∞–Ω-–¢—é–±–µ' : '–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω'}</span>
              </div>
            </div>
            
            <div class="print-date">
              –î–∞—Ç–∞ –ø–µ—á–∞—Ç–∏: ${new Date().toLocaleDateString('ru-RU')} ${new Date().toLocaleTimeString('ru-RU')}
            </div>
          </div>
          
          <script>
            window.onload = function() {
              setTimeout(function() {
                window.print();
                window.onafterprint = function() {
                  window.close();
                };
              }, 500);
            };
          </script>
        </body>
      </html>
    `;
  };

  // –ù–û–í–û–ï: –ê–¥–∞–ø—Ç–∏–≤–Ω–æ–µ –±–æ–∫–æ–≤–æ–µ –º–µ–Ω—é –¥–ª—è –∫—É—Ä—å–µ—Ä–∞ (–£–õ–£–ß–®–ï–ù–ù–ê–Ø –í–ï–†–°–ò–Ø)
  const CourierSidebarMenu = () => {
    if (user?.role !== 'courier') return null;

    const courierMenuItems = [
      {
        id: 'courier-dashboard',
        label: '–ì–ª–∞–≤–Ω–∞—è',
        icon: <Home className="w-5 h-5" />,
        section: 'courier-dashboard'
      },
      {
        id: 'courier-requests',
        label: '–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏',
        icon: <Package className="w-5 h-5" />,
        section: 'courier-requests'
      },
      {
        id: 'courier-accepted',
        label: '–ü—Ä–∏–Ω—è—Ç—ã–µ –∑–∞—è–≤–∫–∏',
        icon: <CheckCircle className="w-5 h-5" />,
        section: 'courier-accepted'
      },
      {
        id: 'courier-picked',
        label: '–ó–∞–±—Ä–∞–Ω–Ω—ã–µ –≥—Ä—É–∑—ã', 
        icon: <Truck className="w-5 h-5" />,
        section: 'courier-picked'
      },
      {
        id: 'courier-cancelled',
        label: '–û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏',
        icon: <XCircle className="w-5 h-5" />,
        section: 'courier-cancelled'
      },
      {
        id: 'courier-chat',
        label: '–ß–∞—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π',
        icon: <MessageCircle className="w-5 h-5" />,
        section: 'courier-chat'
      },
      {
        id: 'courier-history',
        label: '–ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫',
        icon: <Clock className="w-5 h-5" />,
        section: 'courier-history'
      }
    ];

    return (
      <>
        {/* –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –º–µ–Ω—é */}
        <div className="md:hidden">
          {/* –ú–æ–±–∏–ª—å–Ω–∞—è —à–∞–ø–∫–∞ */}
          <div className="bg-white border-b border-gray-200 px-4 py-3 flex items-center justify-between">
            <div className="flex items-center">
              <img 
                src="https://customer-assets.emergentagent.com/job_tajline-courier/artifacts/st3odbr7_Logo_line.png" 
                alt="Logo" 
                className="h-8 w-auto mr-2"
              />
              <div>
                <Badge className="bg-blue-100 text-blue-800 text-xs">–ö–£–†–¨–ï–†</Badge>
              </div>
            </div>
            <div className="flex items-center space-x-2">
              {/* –ö–Ω–æ–ø–∫–∞ –º–µ–Ω—é */}
              <Button
                variant="ghost"
                size="sm"
                onClick={() => setCourierMobileMenuOpen(!courierMobileMenuOpen)}
                className="p-2"
              >
                {courierMobileMenuOpen ? <X className="h-5 w-5" /> : <Menu className="h-5 w-5" />}
              </Button>
            </div>
          </div>

          {/* –í—ã–¥–≤–∏–≥–∞—é—â–µ–µ—Å—è –º–æ–±–∏–ª—å–Ω–æ–µ –º–µ–Ω—é */}
          {courierMobileMenuOpen && (
            <>
              {/* –ó–∞—Ç–µ–º–Ω—è—é—â–∏–π —Ñ–æ–Ω */}
              <div 
                className="fixed inset-0 bg-black bg-opacity-50 z-40"
                onClick={() => setCourierMobileMenuOpen(false)}
              />
              
              {/* –°–∞–º–æ –º–µ–Ω—é */}
              <div className="fixed top-0 left-0 h-full w-80 bg-white border-r border-gray-200 z-50 transform transition-transform duration-300">
                <div className="flex items-center h-16 px-6 border-b border-gray-200">
                  <img 
                    src="https://customer-assets.emergentagent.com/job_tajline-courier/artifacts/st3odbr7_Logo_line.png" 
                    alt="Logo" 
                    className="h-10 w-auto mr-3"
                  />
                  <div>
                    <Badge className="bg-blue-100 text-blue-800 text-xs">–ö–£–†–¨–ï–†</Badge>
                  </div>
                </div>

                <nav className="flex-1 px-4 py-4 space-y-2 overflow-y-auto">
                  {courierMenuItems.map((item) => (
                    <button
                      key={item.id}
                      onClick={() => {
                        if (item.id === 'courier-chat') {
                          handleOpenCourierChat();
                        } else {
                          setActiveSection(item.section);
                          setActiveTab(item.id);
                        }
                        setCourierMobileMenuOpen(false); // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–µ–Ω—é –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞
                      }}
                      className={`w-full flex items-center justify-between px-4 py-3 text-sm font-medium rounded-lg transition-colors ${
                        activeSection === item.section
                          ? 'bg-blue-100 text-blue-700 border border-blue-200'
                          : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'
                      }`}
                    >
                      <div className="flex items-center">
                        {item.icon}
                        <span className="ml-3">{item.label}</span>
                      </div>
                      {item.id === 'courier-requests' && courierRequests.length > 0 && (
                        <Badge className="bg-red-500 text-white text-xs min-w-[20px] h-5 flex items-center justify-center rounded-full">
                          {courierRequests.length}
                        </Badge>
                      )}
                      {item.id === 'courier-accepted' && acceptedRequests.length > 0 && (
                        <Badge className="bg-blue-500 text-white text-xs min-w-[20px] h-5 flex items-center justify-center rounded-full">
                          {acceptedRequests.length}
                        </Badge>
                      )}
                      {item.id === 'courier-picked' && pickedRequests.length > 0 && (
                        <Badge className="bg-orange-500 text-white text-xs min-w-[20px] h-5 flex items-center justify-center rounded-full">
                          {pickedRequests.length}
                        </Badge>
                      )}
                    </button>
                  ))}
                </nav>

                {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—É—Ä—å–µ—Ä–µ –≤ –º–æ–±–∏–ª—å–Ω–æ–º –º–µ–Ω—é */}
                <div className="px-4 py-4 border-t border-gray-200">
                  <div className="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-lg" onClick={() => {
                    handleOpenCourierProfile();
                    setCourierMobileMenuOpen(false);
                  }}>
                    <User className="h-8 w-8 text-gray-400" />
                    <div className="ml-3">
                      <p className="text-sm font-medium text-gray-900">{user?.full_name}</p>
                      <p className="text-xs text-gray-500">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è</p>
                    </div>
                  </div>
                  <Button
                    onClick={() => {
                      handleLogout();
                      setCourierMobileMenuOpen(false);
                    }}
                    variant="outline" 
                    size="sm"
                    className="w-full mt-3"
                  >
                    –í—ã—Ö–æ–¥
                  </Button>
                </div>
              </div>
            </>
          )}
        </div>

        {/* –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –≤–µ—Ä—Å–∏—è –º–µ–Ω—é */}
        <div className="hidden md:block h-full bg-white border-r border-gray-200 w-64 flex flex-col fixed left-0 top-0 z-30">
          <div className="flex items-center h-16 px-6 border-b border-gray-200">
            <div className="flex items-center">
              <img 
                src="https://customer-assets.emergentagent.com/job_tajline-courier/artifacts/st3odbr7_Logo_line.png" 
                alt="Logo" 
                className="h-10 w-auto mr-3"
              />
              <div>
                <Badge className="bg-blue-100 text-blue-800 text-xs">–ö–£–†–¨–ï–†</Badge>
              </div>
            </div>
          </div>

          <nav className="flex-1 px-4 py-4 space-y-2 overflow-y-auto">
            {courierMenuItems.map((item) => (
              <button
                key={item.id}
                onClick={() => {
                  if (item.id === 'courier-chat') {
                    handleOpenCourierChat();
                  } else {
                    setActiveSection(item.section);
                    setActiveTab(item.id);
                  }
                }}
                className={`w-full flex items-center justify-between px-4 py-3 text-sm font-medium rounded-lg transition-colors ${
                  activeSection === item.section
                    ? 'bg-blue-100 text-blue-700 border border-blue-200'
                    : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'
                }`}
              >
                <div className="flex items-center">
                  {item.icon}
                  <span className="ml-3">{item.label}</span>
                </div>
                {item.id === 'courier-requests' && courierRequests.length > 0 && (
                  <Badge className="bg-red-500 text-white text-xs min-w-[20px] h-5 flex items-center justify-center rounded-full">
                    {courierRequests.length}
                  </Badge>
                )}
                {item.id === 'courier-accepted' && acceptedRequests.length > 0 && (
                  <Badge className="bg-blue-500 text-white text-xs min-w-[20px] h-5 flex items-center justify-center rounded-full">
                    {acceptedRequests.length}
                  </Badge>
                )}
                {item.id === 'courier-picked' && pickedRequests.length > 0 && (
                  <Badge className="bg-orange-500 text-white text-xs min-w-[20px] h-5 flex items-center justify-center rounded-full">
                    {pickedRequests.length}
                  </Badge>
                )}
              </button>
            ))}
          </nav>

          {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫—É—Ä—å–µ—Ä–µ */}
          <div className="px-4 py-4 border-t border-gray-200">
            <div className="flex items-center cursor-pointer hover:bg-gray-50 p-2 rounded-lg" onClick={handleOpenCourierProfile}>
              <User className="h-8 w-8 text-gray-400" />
              <div className="ml-3">
                <p className="text-sm font-medium text-gray-900">{user?.full_name}</p>
                <p className="text-xs text-gray-500">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è</p>
              </div>
            </div>
            <Button
              onClick={handleLogout}
              variant="outline" 
              size="sm"
              className="w-full mt-3"
            >
              –í—ã—Ö–æ–¥
            </Button>
          </div>
        </div>
      </>
    );
  };

  // –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é –¥–ª—è –∞–¥–º–∏–Ω–∞ –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å–∫–ª–∞–¥–∞ - –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ê–î–ê–ü–¢–ò–í–ù–ê–Ø –í–ï–†–°–ò–Ø
  const SidebarMenu = () => {
    if (user?.role === 'user') return null;

    const [mobileMenuOpen, setMobileMenuOpen] = useState(false);

    const menuItems = [
      {
        id: 'dashboard',
        label: '–ì–ª–∞–≤–Ω–∞—è',
        icon: <Home className="w-5 h-5" />,
        section: 'dashboard'
      },
      {
        id: 'personal-dashboard',
        label: '–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç',
        icon: <User className="w-5 h-5" />,
        section: 'personal-dashboard'
      },
      {
        id: 'users',
        label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏',
        icon: <Users className="w-5 h-5" />,
        section: 'users',
        adminOnly: true,
        subsections: [
          { id: 'users-regular', label: '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏' },
          { id: 'users-operators', label: '–û–ø–µ—Ä–∞—Ç–æ—Ä—ã —Å–∫–ª–∞–¥–∞' },
          { id: 'users-admins', label: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã' },
          { id: 'users-couriers', label: '–ö—É—Ä—å–µ—Ä—ã' },
          { id: 'users-create-operator', label: '–°–æ–∑–¥–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞' },
          { id: 'users-operator-bindings', label: '–ü—Ä–∏–≤—è–∑–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤' },
          { id: 'users-debtors', label: '–°–ø–∏—Å–æ–∫ –∑–∞–¥–æ–ª–∂–Ω–∏–∫–æ–≤' }
        ]
      },
      {
        id: 'operations',
        label: '–û–ø–µ—Ä–∞—Ü–∏–∏',
        icon: <Target className="w-5 h-5" />,
        section: 'operations',
        subsections: [
          { id: 'operations-search', label: '–ü–æ–∏—Å–∫ –≥—Ä—É–∑–∞' },
          { id: 'operations-qr-generate', label: '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤' },
          { id: 'operations-placement', label: '–†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑' },
          { id: 'operations-receive', label: '–ü—Ä–∏—ë–º –≥—Ä—É–∑–∞' }
        ]
      },
      {
        id: 'cargo-management',
        label: '–ì—Ä—É–∑—ã',
        icon: <Package className="w-5 h-5" />,
        section: 'cargo-management',
        subsections: [
          { id: 'cargo-accept', label: '–ü—Ä–∏–Ω–∏–º–∞—Ç—å –Ω–æ–≤—ã–π –≥—Ä—É–∑' },
          {
            id: 'cargo-pickup-requests',
            label: '–ó–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä',
            subsections: [
              { id: 'cargo-pickup-create', label: '–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞' },
              { id: 'cargo-pickup-list', label: '–ù–∞ –∑–∞–±–æ—Ä' }
            ]
          },
          { id: 'cargo-placement', label: '–ì–æ—Ç–æ–≤ –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é' },
          { id: 'cargo-pickup-history', label: '–ò—Å—Ç–æ—Ä–∏—è –∑–∞–±–æ—Ä–∞ –≥—Ä—É–∑–∞' },
          { id: 'cargo-history', label: '–ò—Å—Ç–æ—Ä–∏—è –≥—Ä—É–∑–æ–≤' }
        ]
      },
      {
        id: 'warehouses',
        label: '–°–∫–ª–∞–¥—ã',
        icon: <Building className="w-5 h-5" />,
        section: 'warehouses',
        subsections: [
          { id: 'warehouses-list', label: '–°–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤' },
          { id: 'warehouses-placed-cargo', label: '–†–∞–∑–º–µ—â–µ–Ω–Ω—ã–π –≥—Ä—É–∑' },
          { id: 'warehouses-create', label: '–°–æ–∑–¥–∞—Ç—å —Å–∫–ª–∞–¥' },
          { id: 'warehouses-manage', label: '–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏' }
        ]
      },
      {
        id: 'couriers-tracking',
        label: '–ö—É—Ä—å–µ—Ä—ã',
        icon: <Truck className="w-5 h-5" />,
        section: 'couriers-tracking',
        subsections: [
          { id: 'couriers-tracking-map', label: '–ö–∞—Ä—Ç–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è' },
          { id: 'couriers-tracking-list', label: '–°–ø–∏—Å–æ–∫ –∫—É—Ä—å–µ—Ä–æ–≤', adminOnly: true },
          { id: 'couriers-inactive', label: '–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∫—É—Ä—å–µ—Ä—ã', adminOnly: true },
          { id: 'couriers-history-analytics', label: '–ò—Å—Ç–æ—Ä–∏—è –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞' }
        ]
      },
      {
        id: 'notifications-management',
        label: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è',
        icon: <Bell className="w-5 h-5" />,
        section: 'notifications-management',
        subsections: [
          { id: 'notifications-client-orders', label: `–ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã (${newOrdersCount})` },
          { id: 'notifications-requests', label: '–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏' },
          { id: 'notifications-system', label: '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è' }
        ]
      },
      {
        id: 'cashier',
        label: '–ö–∞—Å—Å–∞',
        icon: <DollarSign className="w-5 h-5" />,
        section: 'cashier',
        subsections: [
          { id: 'cashier-payment', label: '–ü—Ä–∏—ë–º –æ–ø–ª–∞—Ç—ã' },
          { id: 'cashier-unpaid', label: '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ' },
          { id: 'cashier-history', label: '–ò—Å—Ç–æ—Ä–∏—è –æ–ø–ª–∞—Ç—ã' }
        ]
      },
      {
        id: 'logistics',
        label: '–õ–æ–≥–∏—Å—Ç–∏–∫–∞',
        icon: <Zap className="w-5 h-5" />,
        section: 'logistics',
        subsections: [
          { id: 'logistics-add-transport', label: '–ü—Ä–∏—ë–º –º–∞—à–∏–Ω—É' },
          { id: 'logistics-transport-list', label: '–°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–≤' },
          { id: 'logistics-in-transit', label: '–í –ø—É—Ç–∏' },
          { id: 'logistics-arrived', label: '–ù–∞ –º–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ' },
          { id: 'logistics-history', label: '–ò—Å—Ç–æ—Ä–∏—è –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏' }
        ]
      },
      {
        id: 'finances',
        label: '–§–∏–Ω–∞–Ω—Å—ã',
        icon: <DollarSign className="w-5 h-5" />,
        section: 'finances',
        adminOnly: true,
        subsections: [
          { id: 'finances-overview', label: '–û–±–∑–æ—Ä' },
          { id: 'finances-transactions', label: '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏' }
        ]
      },
      {
        id: 'reports',
        label: '–û—Ç—á–µ—Ç—ã',
        icon: <FileText className="w-5 h-5" />,
        section: 'reports',
        subsections: [
          { id: 'reports-cargo', label: '–û—Ç—á–µ—Ç—ã –ø–æ –≥—Ä—É–∑–∞–º' },
          { id: 'reports-performance', label: '–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å' }
        ]
      }
    ];

    const filteredItems = menuItems.filter(item => 
      !item.adminOnly || user?.role === 'admin'
    );

    return (
      <>
        {/* –ú–æ–±–∏–ª—å–Ω–∞—è –≤–µ—Ä—Å–∏—è –º–µ–Ω—é */}
        <div className="md:hidden">
          {/* –ú–æ–±–∏–ª—å–Ω–∞—è —à–∞–ø–∫–∞ */}
          <div className="fixed top-0 left-0 right-0 bg-white border-b border-gray-200 p-4 flex items-center justify-between z-50">
            <div className="flex items-center">
              <img 
                src="https://customer-assets.emergentagent.com/job_tajline-courier/artifacts/st3odbr7_Logo_line.png" 
                alt="Logo" 
                className="h-8 w-auto mr-2"
              />
              <div>
                <Badge className="bg-blue-100 text-blue-800 text-xs">
                  {user?.role === 'admin' ? '–ê–î–ú–ò–ù' : '–û–ü–ï–†–ê–¢–û–†'}
                </Badge>
              </div>
            </div>
            
            <Button
              variant="ghost"
              size="sm"
              onClick={() => setMobileMenuOpen(!mobileMenuOpen)}
              className="p-2"
            >
              {mobileMenuOpen ? <X className="h-5 w-5" /> : <Menu className="h-5 w-5" />}
            </Button>
          </div>

          {/* –ú–æ–±–∏–ª—å–Ω–æ–µ –≤—ã–¥–≤–∏–∂–Ω–æ–µ –º–µ–Ω—é */}
          {mobileMenuOpen && (
            <div 
              className="fixed inset-0 bg-black bg-opacity-50 z-40"
              onClick={() => setMobileMenuOpen(false)}
            >
              <div 
                className="fixed left-0 top-0 h-full bg-white w-80 shadow-2xl z-50 overflow-y-auto"
                onClick={(e) => e.stopPropagation()}
              >
                <div className="p-6">
                  <div className="flex items-center justify-between mb-8">
                    <div className="flex items-center">
                      <img 
                        src="https://customer-assets.emergentagent.com/job_tajline-courier/artifacts/st3odbr7_Logo_line.png" 
                        alt="Logo" 
                        className="h-10 w-auto mr-3"
                      />
                      <div>
                        <Badge className="bg-blue-100 text-blue-800 text-xs">
                          {user?.role === 'admin' ? '–ê–î–ú–ò–ù' : '–û–ü–ï–†–ê–¢–û–†'}
                        </Badge>
                      </div>
                    </div>
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={() => setMobileMenuOpen(false)}
                      className="p-1"
                    >
                      <X className="h-5 w-5" />
                    </Button>
                  </div>

                  <nav className="space-y-2">
                    {filteredItems.map((item) => (
                      <div key={item.id}>
                        <button
                          onClick={() => {
                            setActiveSection(item.section);
                            if (item.section === 'warehouses' && user?.role === 'admin') {
                              setActiveTab('warehouses-list');
                            } else if (item.section === 'users' && user?.role === 'admin') {
                              setActiveTab('users-regular');
                            }
                            setMobileMenuOpen(false);
                          }}
                          className={`w-full flex items-center px-4 py-3 rounded-xl transition-colors ${
                            activeSection === item.section
                              ? 'bg-blue-100 text-blue-700 border border-blue-200'
                              : 'text-gray-600 hover:bg-gray-100 hover:text-gray-900'
                          }`}
                        >
                          {item.icon}
                          <span className="ml-3 font-medium flex-1">{item.label}</span>
                          {/* –°—á–µ—Ç—á–∏–∫ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é */}
                          {getMenuCounter(item.id) > 0 && (
                            <span className="ml-2 bg-red-500 text-white text-xs px-2 py-1 rounded-full min-w-[20px] text-center">
                              {formatCounter(getMenuCounter(item.id))}
                            </span>
                          )}
                        </button>
                        
                        {item.subsections && activeSection === item.section && (
                          <div className="ml-6 mt-2 space-y-1">
                            {item.subsections.map((sub) => (
                              <div key={sub.id}>
                                <button
                                  onClick={() => {
                                    if (sub.subsections) {
                                      // –ï—Å–ª–∏ –µ—Å—Ç—å –≤–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã, –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏—Ö
                                      // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –¥–ª—è –ø–æ–∫–∞–∑–∞/—Å–∫—Ä—ã—Ç–∏—è –≤–ª–æ–∂–µ–Ω–Ω—ã—Ö
                                    } else {
                                      setActiveTab(sub.id);
                                    }
                                    setMobileMenuOpen(false);
                                  }}
                                  className={`block w-full text-left px-3 py-2 text-sm rounded-lg transition-colors ${
                                    activeTab === sub.id 
                                      ? 'bg-blue-50 text-blue-600 font-medium' 
                                      : 'text-gray-500 hover:text-gray-700 hover:bg-gray-50'
                                  }`}
                                >
                                  {sub.subsections && <span className="mr-1">üöö</span>}
                                  <span className="flex-1">{sub.label}</span>
                                  {/* –°—á–µ—Ç—á–∏–∫ –¥–ª—è –ø–æ–¥–ø—É–Ω–∫—Ç–∞ –º–µ–Ω—é */}
                                  {getMenuCounter(sub.id) > 0 && (
                                    <span className="ml-2 bg-blue-500 text-white text-xs px-2 py-1 rounded-full min-w-[18px] text-center">
                                      {formatCounter(getMenuCounter(sub.id))}
                                    </span>
                                  )}
                                </button>
                                
                                {/* –í–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã */}
                                {sub.subsections && (
                                  <div className="ml-4 mt-1 space-y-1">
                                    {sub.subsections.map((nested) => (
                                      <button
                                        key={nested.id}
                                        onClick={() => {
                                          setActiveTab(nested.id);
                                          setMobileMenuOpen(false);
                                        }}
                                        className={`block w-full text-left px-3 py-2 text-xs rounded-lg transition-colors ${
                                          activeTab === nested.id 
                                            ? 'bg-green-50 text-green-600 font-medium' 
                                            : 'text-gray-400 hover:text-gray-600 hover:bg-gray-50'
                                        }`}
                                      >
                                        <span className="flex-1">{nested.label}</span>
                                        {/* –°—á–µ—Ç—á–∏–∫ –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –ø–æ–¥–ø—É–Ω–∫—Ç–∞ */}
                                        {getMenuCounter(nested.id) > 0 && (
                                          <span className="ml-2 bg-green-500 text-white text-xs px-1.5 py-0.5 rounded-full min-w-[16px] text-center">
                                            {formatCounter(getMenuCounter(nested.id))}
                                          </span>
                                        )}
                                      </button>
                                    ))}
                                  </div>
                                )}
                              </div>
                            ))}
                          </div>
                        )}
                      </div>
                    ))}
                  </nav>

                  {/* –ü—Ä–æ—Ñ–∏–ª—å –∏ –≤—ã—Ö–æ–¥ */}
                  <div className="mt-8 pt-6 border-t border-gray-200">
                    <div className="bg-gray-50 p-4 rounded-xl mb-4">
                      <p className="text-sm font-medium text-gray-900">{user?.full_name}</p>
                      <p className="text-xs text-gray-500">{user?.phone}</p>
                    </div>
                    
                    <Button 
                      onClick={() => setContactModal(true)}
                      variant="outline"
                      className="w-full mb-3"
                    >
                      <MessageCircle className="w-4 h-4 mr-2" />
                      –°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏
                    </Button>
                    
                    <Button 
                      onClick={handleLogout} 
                      variant="outline"
                      className="w-full text-red-600 border-red-200 hover:bg-red-50"
                    >
                      –í—ã—Ö–æ–¥
                    </Button>
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>

        {/* –î–µ—Å–∫—Ç–æ–ø–Ω–∞—è –≤–µ—Ä—Å–∏—è –º–µ–Ω—é - —É–ª—É—á—à–µ–Ω–Ω–∞—è */}
        <div className={`hidden md:block fixed left-0 top-0 h-full bg-gradient-to-b from-gray-900 to-gray-800 text-white transition-all duration-300 z-40 shadow-2xl ${
          sidebarOpen ? 'w-72' : 'w-16'
        }`}>
          {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ –º–µ–Ω—é */}
          <div className="flex items-center justify-between h-16 px-6 bg-gradient-to-r from-blue-600 to-purple-600">
            {sidebarOpen && (
              <div className="flex items-center">
                <img 
                  src="https://customer-assets.emergentagent.com/job_tajline-courier/artifacts/st3odbr7_Logo_line.png" 
                  alt="Logo" 
                  className="h-8 w-auto mr-3"
                />
                <div>
                  <Badge className="bg-white/20 text-white text-xs">
                    {user?.role === 'admin' ? '–ê–î–ú–ò–ù' : '–û–ü–ï–†–ê–¢–û–†'}
                  </Badge>
                </div>
              </div>
            )}
            <Button
              variant="ghost"
              size="sm"
              onClick={() => setSidebarOpen(!sidebarOpen)}
              className="text-white hover:bg-white/10 p-2"
            >
              {sidebarOpen ? <X className="w-5 h-5" /> : <Menu className="w-5 h-5" />}
            </Button>
          </div>

          <div className="flex-1 overflow-y-auto">
            <nav className="p-4 space-y-2">
              {filteredItems.map((item) => (
                <div key={item.id}>
                  <button
                    onClick={() => {
                      setActiveSection(item.section);
                      if (item.section === 'warehouses' && user?.role === 'admin') {
                        setActiveTab('warehouses-list');
                      } else if (item.section === 'users' && user?.role === 'admin') {
                        setActiveTab('users-regular');
                      }
                    }}
                    className={`w-full flex items-center px-3 py-3 rounded-xl transition-all duration-200 ${
                      activeSection === item.section
                        ? 'bg-gradient-to-r from-blue-500 to-purple-500 text-white shadow-lg'
                        : 'text-gray-300 hover:bg-white/10 hover:text-white'
                    }`}
                  >
                    {item.icon}
                    {sidebarOpen && (
                      <div className="ml-3 flex items-center justify-between flex-1">
                        <span className="font-medium">{item.label}</span>
                        {/* –°—á–µ—Ç—á–∏–∫ –¥–ª—è –æ—Å–Ω–æ–≤–Ω–æ–≥–æ –ø—É–Ω–∫—Ç–∞ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–≥–æ –º–µ–Ω—é */}
                        {getMenuCounter(item.id) > 0 && (
                          <span className="bg-white/20 text-white text-xs px-2 py-1 rounded-full min-w-[20px] text-center ml-2">
                            {formatCounter(getMenuCounter(item.id))}
                          </span>
                        )}
                      </div>
                    )}
                  </button>
                  
                  {sidebarOpen && item.subsections && activeSection === item.section && (
                    <div className="ml-4 mt-2 space-y-1 border-l-2 border-white/20 pl-4">
                      {item.subsections.map((sub) => (
                        <div key={sub.id}>
                          <button
                            onClick={() => {
                              if (!sub.subsections) {
                                setActiveTab(sub.id);
                              }
                            }}
                            className={`block w-full text-left px-3 py-2 text-sm rounded-lg transition-colors ${
                              activeTab === sub.id 
                                ? 'bg-white/20 text-white font-medium' 
                                : 'text-gray-400 hover:text-white hover:bg-white/10'
                            }`}
                          >
                            {sub.subsections && <span className="mr-1">üöö</span>}
                            <div className="flex items-center justify-between flex-1">
                              <span>{sub.label}</span>
                              {/* –°—á–µ—Ç—á–∏–∫ –¥–ª—è –ø–æ–¥–ø—É–Ω–∫—Ç–∞ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–≥–æ –º–µ–Ω—é */}
                              {getMenuCounter(sub.id) > 0 && (
                                <span className="bg-white/15 text-white text-xs px-1.5 py-0.5 rounded-full min-w-[18px] text-center ml-2">
                                  {formatCounter(getMenuCounter(sub.id))}
                                </span>
                              )}
                            </div>
                          </button>
                          
                          {/* –í–ª–æ–∂–µ–Ω–Ω—ã–µ –ø–æ–¥—Ä–∞–∑–¥–µ–ª—ã –¥–ª—è –¥–µ—Å–∫—Ç–æ–ø–∞ */}
                          {sub.subsections && (
                            <div className="ml-4 mt-1 space-y-1 border-l border-white/10 pl-3">
                              {sub.subsections.map((nested) => (
                                <button
                                  key={nested.id}
                                  onClick={() => setActiveTab(nested.id)}
                                  className={`block w-full text-left px-2 py-1 text-xs rounded-lg transition-colors ${
                                    activeTab === nested.id 
                                      ? 'bg-green-500/30 text-green-200 font-medium' 
                                      : 'text-gray-500 hover:text-gray-300 hover:bg-white/10'
                                  }`}
                                >
                                  <div className="flex items-center justify-between flex-1">
                                    <span>{nested.label}</span>
                                    {/* –°—á–µ—Ç—á–∏–∫ –¥–ª—è –≤–ª–æ–∂–µ–Ω–Ω–æ–≥–æ –ø–æ–¥–ø—É–Ω–∫—Ç–∞ –¥–µ—Å–∫—Ç–æ–ø–Ω–æ–≥–æ –º–µ–Ω—é */}
                                    {getMenuCounter(nested.id) > 0 && (
                                      <span className="bg-green-500/30 text-green-200 text-xs px-1 py-0.5 rounded-full min-w-[16px] text-center ml-1">
                                        {formatCounter(getMenuCounter(nested.id))}
                                      </span>
                                    )}
                                  </div>
                                </button>
                              ))}
                            </div>
                          )}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              ))}
            </nav>

            {/* –ö–Ω–æ–ø–∫–∏ –≤–Ω–∏–∑—É –º–µ–Ω—é */}
            <div className="p-4 border-t border-white/20">
              {sidebarOpen && (
                <div className="bg-white/10 backdrop-blur-sm rounded-xl p-4 mb-4">
                  <p className="text-sm font-medium text-white">{user?.full_name}</p>
                  <p className="text-xs text-gray-300">{user?.phone}</p>
                </div>
              )}
              
              <button
                onClick={() => setContactModal(true)}
                className="w-full flex items-center px-3 py-2 rounded-xl transition-colors text-gray-300 hover:bg-white/10 hover:text-white"
              >
                <MessageCircle className="w-5 h-5" />
                {sidebarOpen && <span className="ml-3">–°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏</span>}
              </button>
              
              <button
                onClick={handleLogout}
                className="w-full flex items-center px-3 py-2 mt-2 rounded-xl transition-colors text-gray-300 hover:bg-red-600/20 hover:text-red-400"
              >
                <Shield className="w-5 h-5" />
                {sidebarOpen && <span className="ml-3">–í—ã—Ö–æ–¥</span>}
              </button>
            </div>
          </div>
        </div>
      </>
    );
  };

  // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–∫–∞–∑ —ç–∫—Ä–∞–Ω–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –ø–æ–∫–∞–∑–∞ —Å—Ç–∞—Ä—ã—Ö –¥–∞–Ω–Ω—ã—Ö
  if (isInitializing && token) {
    return (
      <div className="min-h-screen bg-gray-50 flex items-center justify-center relative">
        <DevBadge id={getDevNumber('pages', 'loading').id} type="page" label={getDevNumber('pages', 'loading').label} />
        <div className="text-center">
          <div className="flex items-center justify-center mb-6">
            <div className="bg-blue-600 rounded-2xl p-4 shadow-2xl">
              <img 
                src="https://customer-assets.emergentagent.com/job_tajline-courier/artifacts/st3odbr7_Logo_line.png" 
                alt="TAJLINE.TJ" 
                className="h-12 w-auto"
                onError={(e) => {
                  e.target.style.display = 'none';
                  e.target.nextSibling.style.display = 'block';
                }}
              />
              <div className="hidden">
                <Truck className="h-12 w-12 text-white" />
              </div>
            </div>
          </div>
          <div className="animate-spin rounded-full h-12 w-12 border-4 border-blue-600 border-t-transparent mx-auto mb-4"></div>
          <h2 className="text-xl font-semibold text-gray-800 mb-2">–ó–∞–≥—Ä—É–∑–∫–∞...</h2>
          <p className="text-gray-600">–ü–æ–ª—É—á–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</p>
        </div>
      </div>
    );
  }

  if (!user) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-600 via-purple-600 to-indigo-800 flex items-center justify-center p-4 relative">
        <DevBadge id={getDevNumber('pages', 'login').id} type="page" label={getDevNumber('pages', 'login').label} />
        <div className="w-full max-w-md">
          {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –ª–æ–≥–æ—Ç–∏–ø–æ–º */}
          <div className="text-center mb-8">
            <div className="flex items-center justify-center mb-6">
              <div className="bg-white/10 backdrop-blur-lg rounded-2xl p-4 shadow-2xl">
                <img 
                  src="https://customer-assets.emergentagent.com/job_tajline-courier/artifacts/st3odbr7_Logo_line.png" 
                  alt="TAJLINE.TJ" 
                  className="h-12 w-auto"
                  onError={(e) => {
                    e.target.style.display = 'none';
                    e.target.nextSibling.style.display = 'block';
                  }}
                />
                <div className="hidden">
                  <Truck className="h-12 w-12 text-white" />
                </div>
              </div>
            </div>
            <h1 className="text-3xl md:text-4xl font-bold text-white mb-2">TAJLINE</h1>
            <p className="text-blue-100 text-sm md:text-base">–ì—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∏ –ú–æ—Å–∫–≤–∞-–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω</p>
          </div>

          {/* –§–æ—Ä–º–∞ –≤—Ö–æ–¥–∞ */}
          <div className="bg-white/95 backdrop-blur-xl rounded-2xl shadow-2xl overflow-hidden">
            <Tabs defaultValue="login" className="w-full">
              <TabsList className="grid w-full grid-cols-2 bg-gray-50/80 p-1 m-4 rounded-xl">
                <TabsTrigger 
                  value="login" 
                  className="rounded-lg data-[state=active]:bg-white data-[state=active]:shadow-sm font-medium"
                >
                  –í—Ö–æ–¥
                </TabsTrigger>
                <TabsTrigger 
                  value="register"
                  className="rounded-lg data-[state=active]:bg-white data-[state=active]:shadow-sm font-medium"
                >
                  –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                </TabsTrigger>
              </TabsList>
              
              <TabsContent value="login" className="p-6 pt-2 relative">
                <DevBadge id={getDevNumber('forms', 'login').id} type="form" label={getDevNumber('forms', 'login').label} />
                <form onSubmit={handleLogin} className="space-y-5">
                  <div className="text-center mb-6">
                    <h2 className="text-2xl font-bold text-gray-900 mb-2">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å!</h2>
                    <p className="text-gray-600 text-sm">–í–æ–π–¥–∏—Ç–µ –≤ —Å–≤–æ—é —É—á–µ—Ç–Ω—É—é –∑–∞–ø–∏—Å—å</p>
                  </div>
                  
                  <div className="space-y-4">
                    <div>
                      <Label htmlFor="login-phone" className="text-gray-700 font-medium">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</Label>
                      <div className="relative mt-2">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                          <Phone className="h-5 w-5 text-gray-400" />
                        </div>
                        <Input
                          id="login-phone"
                          type="tel"
                          placeholder="+7XXXXXXXXXX"
                          value={loginForm.phone}
                          onChange={(e) => setLoginForm({...loginForm, phone: e.target.value})}
                          className="pl-10 h-12 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-blue-500"
                          required
                        />
                      </div>
                    </div>
                    
                    <div>
                      <Label htmlFor="login-password" className="text-gray-700 font-medium">–ü–∞—Ä–æ–ª—å</Label>
                      <div className="relative mt-2">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                          <Shield className="h-5 w-5 text-gray-400" />
                        </div>
                        <Input
                          id="login-password"
                          type="password"
                          placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å"
                          value={loginForm.password}
                          onChange={(e) => setLoginForm({...loginForm, password: e.target.value})}
                          className="pl-10 h-12 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-blue-500"
                          required
                        />
                      </div>
                    </div>
                  </div>
                  
                  <Button 
                    type="submit" 
                    disabled={isLoggingIn}
                    className="w-full h-12 bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200"
                  >
                    {isLoggingIn ? (
                      <div className="flex items-center justify-center">
                        <div className="animate-spin rounded-full h-5 w-5 border-2 border-white border-t-transparent mr-2"></div>
                        –í—Ö–æ–¥...
                      </div>
                    ) : (
                      '–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É'
                    )}
                  </Button>
                  
                  {/* –¢–µ—Å—Ç–æ–≤–∞—è –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */}
                  <Button 
                    type="button"
                    variant="outline"
                    className="w-full h-10 rounded-xl"
                    onClick={() => {
                      console.log('üß™ TEST: Opening test modal');
                      setTestModal(true);
                    }}
                  >
                    üß™ –¢–µ—Å—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                  </Button>
                </form>
              </TabsContent>
              
              <TabsContent value="register" className="p-6 pt-2 relative">
                <DevBadge id={getDevNumber('forms', 'register').id} type="form" label={getDevNumber('forms', 'register').label} />
                <form onSubmit={handleRegister} className="space-y-5">
                  <div className="text-center mb-6">
                    <h2 className="text-2xl font-bold text-gray-900 mb-2">–°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h2>
                    <p className="text-gray-600 text-sm">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–π—Ç–µ—Å—å –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã</p>
                  </div>
                  
                  <div className="space-y-4">
                    <div>
                      <Label htmlFor="register-name" className="text-gray-700 font-medium">–ü–æ–ª–Ω–æ–µ –∏–º—è</Label>
                      <div className="relative mt-2">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                          <User className="h-5 w-5 text-gray-400" />
                        </div>
                        <Input
                          id="register-name"
                          placeholder="–í–≤–µ–¥–∏—Ç–µ –§–ò–û"
                          value={registerForm.full_name}
                          onChange={(e) => setRegisterForm({...registerForm, full_name: e.target.value})}
                          className="pl-10 h-12 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-blue-500"
                          required
                        />
                      </div>
                    </div>
                    
                    <div>
                      <Label htmlFor="register-phone" className="text-gray-700 font-medium">–ù–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞</Label>
                      <div className="relative mt-2">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                          <Phone className="h-5 w-5 text-gray-400" />
                        </div>
                        <Input
                          id="register-phone"
                          type="tel"
                          placeholder="+7XXXXXXXXXX"
                          value={registerForm.phone}
                          onChange={(e) => setRegisterForm({...registerForm, phone: e.target.value})}
                          className="pl-10 h-12 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-blue-500"
                          required
                        />
                      </div>
                    </div>
                    
                    <div>
                      <Label htmlFor="register-password" className="text-gray-700 font-medium">–ü–∞—Ä–æ–ª—å</Label>
                      <div className="relative mt-2">
                        <div className="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                          <Shield className="h-5 w-5 text-gray-400" />
                        </div>
                        <Input
                          id="register-password"
                          type="password"
                          placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"
                          value={registerForm.password}
                          onChange={(e) => setRegisterForm({...registerForm, password: e.target.value})}
                          className="pl-10 h-12 border-gray-300 rounded-xl focus:border-blue-500 focus:ring-blue-500"
                          required
                        />
                      </div>
                    </div>
                  </div>
                  
                  <Button 
                    type="submit" 
                    className="w-full h-12 bg-gradient-to-r from-green-600 to-blue-600 hover:from-green-700 hover:to-blue-700 text-white font-semibold rounded-xl shadow-lg hover:shadow-xl transform hover:scale-[1.02] transition-all duration-200"
                  >
                    –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç
                  </Button>
                </form>
              </TabsContent>
            </Tabs>
          </div>
          
          {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
          <div className="text-center mt-8">
            <p className="text-blue-100 text-sm">
              ¬© 2024 TAJLINE.TJ - –ù–∞–¥–µ–∂–Ω—ã–µ –≥—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∏
            </p>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* –ë–æ–∫–æ–≤–æ–µ –º–µ–Ω—é */}
      {user && (user.role === 'admin' || user.role === 'warehouse_operator') && <SidebarMenu />}
      {user && user.role === 'courier' && <CourierSidebarMenu />}
      
      {/* –û—Å–Ω–æ–≤–Ω–æ–π –∫–æ–Ω—Ç–µ–Ω—Ç */}
      <div className={`${
        user && (user.role === 'admin' || user.role === 'warehouse_operator') 
          ? 'md:ml-72 transition-all duration-300'  // –ù–∞ –º–æ–±–∏–ª–µ –±–µ–∑ –æ—Ç—Å—Ç—É–ø–æ–≤, –Ω–∞ –¥–µ—Å–∫—Ç–æ–ø–µ —Å –æ—Ç—Å—Ç—É–ø–æ–º
          : user && user.role === 'courier'
            ? 'md:ml-64 pt-16 md:pt-0'  // –ö—É—Ä—å–µ—Ä: –º–æ–±–∏–ª–µ –æ—Ç—Å—Ç—É–ø —Å–≤–µ—Ä—Ö—É –¥–ª—è header, –¥–µ—Å–∫—Ç–æ–ø —Å –±–æ–∫–æ–≤—ã–º –º–µ–Ω—é
            : ''
      }`}>
        
        {/* Header - –∞–¥–∞–ø—Ç–∏–≤–Ω—ã–π –¥–ª—è –∞–¥–º–∏–Ω–æ–≤/–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ */}
        {user && user.role !== 'courier' && (
          <header className="bg-white shadow-sm border-b sticky top-0 z-30">
            <div className="px-4 md:px-6 py-4">
              <div className="flex items-center justify-between">
                {/* –õ–æ–≥–æ—Ç–∏–ø –∏ –Ω–∞–∑–≤–∞–Ω–∏–µ - —Å–∫—Ä—ã—Ç–æ –Ω–∞ –º–æ–±–∏–ª–µ –µ—Å–ª–∏ –µ—Å—Ç—å –±–æ–∫–æ–≤–æ–µ –º–µ–Ω—é */}
                <div className="flex items-center">
                  <div className="md:flex items-center mr-6 hidden">
                    <img 
                      src="https://customer-assets.emergentagent.com/job_tajline-courier/artifacts/st3odbr7_Logo_line.png" 
                      alt="TAJLINE.TJ" 
                      className="h-10 w-auto mr-3"
                      onError={(e) => {
                        e.target.style.display = 'none';
                        e.target.nextSibling.style.display = 'flex';
                      }}
                    />
                    <div className="hidden">
                      <div className="bg-blue-600 text-white p-2 rounded-lg mr-3">
                        <Truck className="h-8 w-8" />
                      </div>
                      <div>
                        <h1 className="text-2xl font-bold text-blue-600">TAJLINE.TJ</h1>
                        <p className="text-sm text-gray-600">–ì—Ä—É–∑–æ–ø–µ—Ä–µ–≤–æ–∑–∫–∏ –ú–æ—Å–∫–≤–∞-–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω</p>
                      </div>
                    </div>
                  </div>
                  
                  {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å—Ç—Ä–∞–Ω–∏—Ü—ã –Ω–∞ –º–æ–±–∏–ª–µ */}
                  <div className="md:hidden">
                    <h1 className="text-lg font-semibold text-gray-900">
                      {activeSection === 'dashboard' ? '–ì–ª–∞–≤–Ω–∞—è' :
                       activeSection === 'users' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏' :
                       activeSection === 'cargo-management' ? '–ì—Ä—É–∑—ã' :
                       activeSection === 'warehouses' ? '–°–∫–ª–∞–¥—ã' :
                       activeSection === 'operations' ? '–û–ø–µ—Ä–∞—Ü–∏–∏' :
                       activeSection === 'notifications-management' ? '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è' :
                       activeSection === 'cashier' ? '–ö–∞—Å—Å–∞' :
                       activeSection === 'logistics' ? '–õ–æ–≥–∏—Å—Ç–∏–∫–∞' :
                       activeSection === 'finances' ? '–§–∏–Ω–∞–Ω—Å—ã' :
                       activeSection === 'reports' ? '–û—Ç—á–µ—Ç—ã' :
                       '–ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è'}
                    </h1>
                  </div>
                </div>
                
                <div className="flex items-center space-x-2 md:space-x-4">
                  <div className="flex items-center space-x-2">
                    {getRoleIcon(user.role)}
                    <div className="hidden md:flex flex-col">
                      <span className="text-sm font-medium">{user.full_name}</span>
                      {user.user_number && (
                      <span className="text-xs text-gray-500">‚Ññ {user.user_number}</span>
                    )}
                  </div>
                  <Badge variant="outline">{getRoleLabel(user.role)}</Badge>
                </div>
                
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <div className="relative cursor-pointer">
                      <Bell className="h-5 w-5 text-gray-600 hover:text-gray-800 transition-colors" />
                      {notifications.filter(n => n.status === 'unread').length > 0 && (
                        <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                          {notifications.filter(n => n.status === 'unread').length}
                        </span>
                      )}
                    </div>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end" className="w-80 max-h-96 overflow-y-auto">
                    <div className="px-3 py-2 border-b">
                      <h3 className="font-semibold text-sm">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</h3>
                    </div>
                    
                    {/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è —Å –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
                    {notifications.length > 0 && (
                      <>
                        <div className="px-3 py-1 bg-gray-50">
                          <p className="text-xs font-medium text-gray-600">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</p>
                        </div>
                        {notifications.slice(0, 8).map((notification) => (
                          <div key={`notification-${notification.id}`} className={`p-3 border-b hover:bg-gray-50 ${notification.status === 'unread' ? 'bg-blue-50 border-l-4 border-l-blue-400' : ''}`}>
                            <div className="w-full">
                              <p className={`text-sm leading-tight ${notification.status === 'unread' ? 'font-medium' : ''}`}>
                                {notification.message}
                              </p>
                              <p className="text-xs text-gray-500 mt-1">
                                {new Date(notification.created_at).toLocaleString('ru-RU')}
                              </p>
                              
                              {/* –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */}
                              <div className="flex space-x-1 mt-2">
                                {notification.status === 'unread' && (
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleMarkNotificationAsRead(notification.id);
                                    }}
                                    className="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors"
                                  >
                                    –ü—Ä–æ—á–∏—Ç–∞–Ω–æ
                                  </button>
                                )}
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    handleViewNotificationDetails(notification.id);
                                  }}
                                  className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors"
                                >
                                  –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å
                                </button>
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    handleDeleteNotification(notification.id);
                                  }}
                                  className="text-xs px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors"
                                >
                                  –£–¥–∞–ª–∏—Ç—å
                                </button>
                              </div>
                            </div>
                          </div>
                        ))}
                        {notifications.length > 8 && (
                          <div className="px-3 py-2 text-xs text-gray-500 text-center border-t">
                            –ò –µ—â–µ {notifications.length - 8} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π...
                          </div>
                        )}
                      </>
                    )}
                    
                    {/* –ü—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ */}
                    {notifications.length === 0 && (
                      <div className="p-4 text-center text-gray-500">
                        <Bell className="mx-auto h-8 w-8 text-gray-400 mb-2" />
                        <p className="text-sm">–ù–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</p>
                      </div>
                    )}
                  </DropdownMenuContent>
                </DropdownMenu>
                
                <Button variant="outline" onClick={handleLogout}>
                  –í—ã–π—Ç–∏
                </Button>
              </div>
            </div>
          </div>
        </header>
        )}

        {/* Main Content */}
        <main className="container mx-auto px-4 py-8">
          {/* Cargo Placement Page */}
          {currentPage === 'cargo-placement' ? (
            <div className="min-h-screen bg-gray-50 relative">
              <DevBadge id={getDevNumber('pages', 'cargo-placement').id} type="page" label={getDevNumber('pages', 'cargo-placement').label} />
              {/* Page Header */}
              <div className="bg-white shadow-sm rounded-lg mb-6 p-6">
                <div className="flex items-center justify-between">
                  <div className="flex items-center">
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={closeCargoPlacementPage}
                      className="mr-4 text-gray-600 hover:text-gray-800"
                    >
                      <ArrowLeft className="h-4 w-4 mr-2" />
                      –ù–∞–∑–∞–¥
                    </Button>
                    <div>
                      <h1 className="text-2xl font-bold text-gray-900">–†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞</h1>
                      <p className="text-gray-600 mt-1">–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥—ã –≥—Ä—É–∑–æ–≤ –∏ —è—á–µ–µ–∫ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Cargo Placement Content */}
              <div className="max-w-4xl mx-auto">
                {/* Progress Steps */}
                <div className="mb-8">
                  <div className="flex items-center justify-center space-x-8">
                    <div className={`flex items-center ${placementStep === 'scan-cargo' || placementStep === 'scan-cell' ? 'text-blue-600' : 'text-gray-400'}`}>
                      <div className={`w-8 h-8 rounded-full flex items-center justify-center ${placementStep === 'scan-cargo' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}>
                        1
                      </div>
                      <span className="ml-2 font-medium">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–∑</span>
                    </div>
                    <div className="h-px bg-gray-300 flex-1 max-w-32"></div>
                    <div className={`flex items-center ${placementStep === 'scan-cell' ? 'text-blue-600' : 'text-gray-400'}`}>
                      <div className={`w-8 h-8 rounded-full flex items-center justify-center ${placementStep === 'scan-cell' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}>
                        2
                      </div>
                      <span className="ml-2 font-medium">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —è—á–µ–π–∫—É</span>
                    </div>
                  </div>
                </div>

                {/* Current Step Content */}
                <>
                <Card 
                  className={`mb-6 ${placementStep === 'scan-cargo' ? 'react-visible' : 'react-hidden'}`}
                >
                  <CardHeader>
                    <CardTitle className="flex items-center">
                      <QrCode className="mr-2 h-5 w-5" />
                      –®–∞–≥ 1: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞
                    </CardTitle>
                    <CardDescription>
                      –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR –∫–æ–¥ –≥—Ä—É–∑–∞ –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    {/* –≠–¢–ê–ü 3: –ü–†–û–ì–†–ï–°–° –ò –ê–ù–ê–õ–ò–¢–ò–ö–ê –í –°–ö–ê–ù–ï–†–ï */}
                    {placementProgress && (placementProgress.total_units > 0 || placementProgress.placed_units > 0) && (
                      <div className="mb-6 p-4 bg-gradient-to-r from-emerald-50 to-green-50 rounded-lg border border-emerald-200">
                        <div className="flex items-center justify-between mb-3">
                          <div>
                            <h3 className="font-semibold text-emerald-800 flex items-center">
                              <BarChart3 className="mr-2 h-4 w-4" />
                              –ü—Ä–æ–≥—Ä–µ—Å—Å —Å–µ—Å—Å–∏–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
                            </h3>
                            <p className="text-sm text-emerald-600 mt-1">{placementProgress.progress_text}</p>
                          </div>
                          <div className="text-right">
                            <div className="text-xl font-bold text-emerald-600">
                              {placementProgress.progress_percentage.toFixed(1)}%
                            </div>
                            <div className="text-xs text-emerald-700">–≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                          </div>
                        </div>
                        
                        {/* –í–∏–∑—É–∞–ª—å–Ω—ã–π –ø—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */}
                        <div className="mb-2">
                          <div className="w-full bg-emerald-200 rounded-full h-3">
                            <div 
                              className="bg-emerald-600 h-3 rounded-full transition-all duration-500 ease-in-out"
                              style={{ width: `${placementProgress.progress_percentage}%` }}
                            ></div>
                          </div>
                        </div>
                        
                        {/* –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
                        <div className="flex justify-between text-xs text-emerald-700">
                          <span className="flex items-center">
                            <Circle className="mr-1 h-3 w-3 fill-orange-400 text-orange-400" />
                            –û–∂–∏–¥–∞—é—Ç: {placementProgress.pending_units}
                          </span>
                          <span className="flex items-center">
                            <Circle className="mr-1 h-3 w-3 fill-emerald-500 text-emerald-500" />
                            –†–∞–∑–º–µ—â–µ–Ω–æ: {placementProgress.placed_units}
                          </span>
                          <span className="flex items-center">
                            <Target className="mr-1 h-3 w-3" />
                            –í—Å–µ–≥–æ: {placementProgress.total_units}
                          </span>
                        </div>
                      </div>
                    )}
                      {/* Isolated Camera Scanner Container to prevent React conflicts */}
                      <div className="relative">
                        <div className="bg-black rounded-lg p-4 mb-4">
                          <div 
                            ref={qrContainerRef}
                            className="w-full min-h-[400px] flex items-center justify-center"
                            style={{ 
                              display: 'block', 
                              minHeight: '400px', 
                              backgroundColor: '#000000',
                              borderRadius: '8px' 
                            }}
                          >
                            {!scannerActive && (
                              <div className="text-white text-center p-8">
                                <Camera className="mx-auto h-16 w-16 mb-4 text-gray-400" />
                                <p className="text-lg font-medium mb-2">–ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–∞–º–µ—Ä–∞ –≥–æ—Ç–æ–≤–∞</p>
                                <p className="text-sm text-gray-300">
                                  –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞
                                </p>
                              </div>
                            )}
                          </div>
                        </div>
                        
                        {/* Camera Controls - isolated from React lifecycle */}
                        <div className="flex justify-center space-x-4 mb-4">
                          {availablePlacementCameras.length > 1 && scannerActive && (
                            <Button 
                              onClick={switchPlacementCamera}
                              variant="outline"
                              size="sm"
                            >
                              <Camera className="mr-2 h-4 w-4" />
                              –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
                            </Button>
                          )}
                          
                          {scannerActive && (
                            <Button 
                              onClick={async () => {
                                await completeQrCleanup("User Stop");
                              }}
                              variant="outline"
                              size="sm"
                            >
                              <X className="mr-2 h-4 w-4" />
                              –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∫–∞–º–µ—Ä—É
                            </Button>
                          )}
                        </div>
                      </div>

                      <div 
                        className={`space-y-4 ${!scannerActive ? 'react-visible' : 'react-hidden'}`}
                      >
                          {/* Camera unavailable message with enhanced mobile retry */}
                          <div 
                            className={`space-y-3 ${placementActive ? 'react-visible' : 'react-hidden'}`}
                          >
                              <div className="text-center p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <div className="text-yellow-800 font-medium mb-2">
                                  üì± –ö–∞–º–µ—Ä–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞
                                </div>
                                <p className="text-sm text-yellow-700 mb-4">
                                  –î–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR –∫–æ–¥–æ–≤ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ –ø–æ–ø—Ä–æ–±—É–π—Ç–µ:
                                </p>
                                
                                {/* Mobile-specific camera retry buttons */}
                                <div className="space-y-2">
                                  <Button 
                                    onClick={async () => {
                                      console.log('üîÑ –û–±—ã—á–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Å –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ—á–∏—Å—Ç–∫–æ–π...');
                                      await completeQrCleanup("Normal Retry");
                                      
                                      await new Promise(resolve => setTimeout(resolve, 1000));
                                      
                                      const cameraAvailable = await checkCameraAvailability();
                                      if (cameraAvailable) {
                                        showAlert('‚úÖ –ö–∞–º–µ—Ä–∞ –Ω–∞–π–¥–µ–Ω–∞! –ó–∞–ø—É—Å–∫ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞...', 'success');
                                        await new Promise(resolve => setTimeout(resolve, 2000));
                                        try {
                                          await startQRScannerForPlacement();
                                        } catch (error) {
                                          console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–ø—É—Å–∫–∞ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞:', error);
                                        }
                                      }
                                    }}
                                    size="sm"
                                    variant="outline"
                                    className="w-full text-xs bg-white text-blue-600 border-blue-300 hover:bg-blue-50"
                                  >
                                    <RefreshCw className="mr-1 h-3 w-3" />
                                    –ü–æ–ø—Ä–æ–±–æ–≤–∞—Ç—å —Å–Ω–æ–≤–∞
                                  </Button>
                                  
                                  <Button 
                                    onClick={async () => {
                                      console.log('üîß –ò–ó–û–õ–ò–†–û–í–ê–ù–ù–´–ô –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –º–æ–±–∏–ª—å–Ω–æ–π –∫–∞–º–µ—Ä—ã...');
                                      showAlert('üîß –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫...', 'info');
                                      
                                      // Complete isolation cleanup first
                                      await completeQrCleanup("Force Isolated Retry");
                                      
                                      // Wait longer for complete cleanup
                                      await new Promise(resolve => setTimeout(resolve, 3000));
                                      
                                      // Direct isolated scanner start without availability check
                                      try {
                                        console.log('üöÄ –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞...');
                                        await startQRScannerForPlacement();
                                        showAlert('üéâ –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ —É—Å–ø–µ—à–µ–Ω!', 'success');
                                      } catch (error) {
                                        console.error('‚ùå –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –Ω–µ —É–¥–∞–ª—Å—è:', error);
                                        showAlert('‚ùå –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –Ω–µ —É–¥–∞–ª—Å—è. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ä—É—á–Ω–æ–π –≤–≤–æ–¥.', 'error');
                                      }
                                    }}
                                    size="sm"
                                    variant="default"
                                    className="w-full text-xs bg-green-600 text-white hover:bg-green-700"
                                  >
                                    <Camera className="mr-1 h-3 w-3" />
                                    –ü—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫
                                  </Button>
                                </div>
                                
                                <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded text-xs text-blue-800">
                                  üí° <strong>–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–∞:</strong>
                                  <br />‚Ä¢ –ù–∞–∂–º–∏—Ç–µ "–†–∞–∑—Ä–µ—à–∏—Ç—å" –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫–∞–º–µ—Ä—ã
                                  <br />‚Ä¢ –ó–∞–∫—Ä–æ–π—Ç–µ –¥—Ä—É–≥–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã
                                  <br />‚Ä¢ –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä–∞–Ω–∏—Ü—É (F5)
                                  <br />‚Ä¢ –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –∏–ª–∏ Safari
                                </div>
                              </div>
                            </div>

                          {/* Manual Input Section */}
                          {placementActive && (
                          <div className="bg-white border rounded-lg p-4">
                            <h3 className="font-medium mb-4 flex items-center">
                              <Edit3 className="mr-2 h-4 w-4" />
                              –†—É—á–Ω–æ–π –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö
                            </h3>
                            
                            <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                              {/* Cargo Number Input */}
                              <div>
                                <Label htmlFor="manual-cargo-full">–ù–æ–º–µ—Ä –≥—Ä—É–∑–∞</Label>
                                <Input
                                  id="manual-cargo-full"
                                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: TEMP-123456"
                                  value={manualCargoNumber}
                                  onChange={(e) => {
                                    setManualCargoNumber(e.target.value);
                                    // Add validation logic here if needed
                                  }}
                                  className="mt-1"
                                />
                              </div>
                              
                              {/* Cell Code Input */}
                              <div>
                                <Label htmlFor="manual-cell-full">–ö–æ–¥ —è—á–µ–π–∫–∏</Label>
                                <Input
                                  id="manual-cell-full"
                                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: W001-–ë1-–ü1-–Ø1"
                                  value={manualCellCode}
                                  onChange={(e) => setManualCellCode(e.target.value)}
                                  className="mt-1"
                                />
                              </div>
                            </div>
                            
                            {/* Available Cells Display */}
                            {availableCellsForPlacement.length > 0 && (
                              <div className="mt-4">
                                <h4 className="font-medium mb-2">–î–æ—Å—Ç—É–ø–Ω—ã–µ —è—á–µ–π–∫–∏:</h4>
                                <div className="max-h-32 overflow-y-auto">
                                  {availableCellsForPlacement.slice(0, 10).map((cell, index) => (
                                    <div 
                                      key={index} 
                                      className="text-sm p-2 bg-gray-50 rounded border mb-1 cursor-pointer hover:bg-gray-100"
                                      onClick={() => setManualCellCode(cell.cell_code)}
                                    >
                                      <div className="font-mono">{cell.cell_code}</div>
                                      <div className="text-gray-600">{cell.location_description}</div>
                                    </div>
                                  ))}
                                  {availableCellsForPlacement.length > 10 && (
                                    <div className="text-sm text-gray-500 text-center">
                                      ... –∏ –µ—â–µ {availableCellsForPlacement.length - 10} —è—á–µ–µ–∫
                                    </div>
                                  )}
                                </div>
                              </div>
                            )}
                            
                            {/* Manual Placement Button */}
                            <div className="mt-4">
                              <Button 
                                onClick={handleManualPlacement}
                                className="w-full bg-green-600 hover:bg-green-700"
                                disabled={!manualCargoNumber.trim() || !manualCellCode.trim()}
                              >
                                <Package className="mr-2 h-4 w-4" />
                                –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –≤—Ä—É—á–Ω—É—é
                              </Button>
                            </div>
                          </div>
                          )}
                      </div>
                    </CardContent>
                  </Card>

                  {/* Placement Statistics */}
                  <Card 
                    className={`mb-6 ${placementStatistics ? 'react-visible' : 'react-hidden'}`}
                  >
                    <CardHeader>
                      <CardTitle className="flex items-center">
                        <BarChart3 className="mr-2 h-5 w-5" />
                        –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
                      </CardTitle>
                    </CardHeader>
                    <CardContent>
                      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <div className="text-center p-3 bg-blue-50 rounded-lg">
                          <div className="text-2xl font-bold text-blue-600">{placementStatistics?.today_placements || 0}</div>
                          <div className="text-sm text-gray-600">–°–µ–≥–æ–¥–Ω—è</div>
                        </div>
                        <div className="text-center p-3 bg-green-50 rounded-lg">
                          <div className="text-2xl font-bold text-green-600">{placementStatistics?.session_placements || 0}</div>
                          <div className="text-sm text-gray-600">–ó–∞ —Å–µ—Å—Å–∏—é</div>
                        </div>
                        <div className="text-center p-3 bg-orange-50 rounded-lg">
                          <div className="text-2xl font-bold text-orange-600">{placementStatistics?.recent_placements || 0}</div>
                          <div className="text-sm text-gray-600">–ù–µ–¥–∞–≤–Ω–∏—Ö</div>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                {/* Action Buttons */}
                <div className="flex justify-center space-x-4">
                  <Button 
                    onClick={closeCargoPlacementPage}
                    variant="outline"
                    size="lg"
                  >
                    <X className="mr-2 h-4 w-4" />
                    –ó–∞–≤–µ—Ä—à–∏—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ
                  </Button>
                </div>
                </>
              </div>
            </div>
          ) : 
          
          /* Main content for different user roles */
          user?.role === 'user' ? (
            <div className="space-y-6">
              {/* Client Dashboard Header */}
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-4">
                  <img 
                    src="/logo.png" 
                    alt="TAJLINE.TJ" 
                    className="h-12 w-auto"
                    onError={(e) => {
                      e.target.style.display = 'none';
                      e.target.nextSibling.style.display = 'block';
                    }}
                  />
                  <div className="hidden">
                    <h1 className="text-3xl font-bold text-gray-900">TAJLINE.TJ</h1>
                  </div>
                  <div>
                    <h1 className="text-3xl font-bold text-gray-900">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, {user.full_name}!</h1>
                    <p className="text-gray-600 mt-1">–í–∞—à –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≥—Ä—É–∑–∞–º–∏</p>
                  </div>
                </div>
                <div className="flex items-center space-x-4">
                  <Button 
                    variant="outline" 
                    onClick={openEditProfile}
                    className="text-blue-600 hover:text-blue-700"
                  >
                    <Settings className="mr-2 h-4 w-4" />
                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å
                  </Button>
                  <Button 
                    variant="outline" 
                    onClick={() => {
                      fetchClientDashboard();
                      fetchClientCargo();
                    }}
                  >
                    <Package className="mr-2 h-4 w-4" />
                    –û–±–Ω–æ–≤–∏—Ç—å
                  </Button>
                </div>
              </div>

              {/* Client Dashboard Stats */}
              {clientDashboard && (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                  <Card className="relative">
                    <DevBadge id={getDevNumber('cards', 'dashboard-stats').id} type="card" label="–í—Å–µ–≥–æ –≥—Ä—É–∑–æ–≤" />
                    <CardContent className="p-6">
                      <div className="flex items-center">
                        <Package className="h-8 w-8 text-blue-600" />
                        <div className="ml-4">
                          <p className="text-sm font-medium text-gray-600">–í—Å–µ–≥–æ –≥—Ä—É–∑–æ–≤</p>
                          <p className="text-2xl font-bold text-gray-900">
                            {clientDashboard.cargo_summary?.total_cargo || 0}
                          </p>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  <Card className="relative">
                    <DevBadge id={getDevNumber('cards', 'dashboard-stats').id} type="card" label="–í –ø—É—Ç–∏" />
                    <CardContent className="p-6">
                      <div className="flex items-center">
                        <Clock className="h-8 w-8 text-yellow-600" />
                        <div className="ml-4">
                          <p className="text-sm font-medium text-gray-600">–í –ø—É—Ç–∏</p>
                          <p className="text-2xl font-bold text-gray-900">
                            {clientDashboard.cargo_summary?.status_breakdown?.in_transit || 0}
                          </p>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  <Card className="relative">
                    <DevBadge id={getDevNumber('cards', 'dashboard-stats').id} type="card" label="–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ" />
                    <CardContent className="p-6">
                      <div className="flex items-center">
                        <CheckCircle className="h-8 w-8 text-green-600" />
                        <div className="ml-4">  
                          <p className="text-sm font-medium text-gray-600">–î–æ—Å—Ç–∞–≤–ª–µ–Ω–æ</p>
                          <p className="text-2xl font-bold text-gray-900">
                            {clientDashboard.cargo_summary?.status_breakdown?.delivered || 0}
                          </p>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  <Card className="relative">
                    <DevBadge id={getDevNumber('cards', 'dashboard-stats').id} type="card" label="–ö –æ–ø–ª–∞—Ç–µ" />
                    <CardContent className="p-6">
                      <div className="flex items-center">
                        <CreditCard className="h-8 w-8 text-red-600" />
                        <div className="ml-4">
                          <p className="text-sm font-medium text-gray-600">–ö –æ–ø–ª–∞—Ç–µ</p>
                          <p className="text-2xl font-bold text-gray-900">
                            {clientDashboard.cargo_summary?.unpaid_cargo_count || 0}
                          </p>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                </div>
              )}

              {/* Client Navigation Tabs */}
              <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
                <TabsList className="grid w-full grid-cols-5">
                  <TabsTrigger value="dashboard" className="flex items-center">
                    <Home className="mr-2 h-4 w-4" />
                    –ì–ª–∞–≤–Ω–∞—è
                  </TabsTrigger>
                  <TabsTrigger value="create-order" className="flex items-center">
                    <Plus className="mr-2 h-4 w-4" />
                    –û—Ñ–æ—Ä–º–∏—Ç—å –≥—Ä—É–∑
                  </TabsTrigger>
                  <TabsTrigger value="cargo" className="flex items-center">
                    <Package className="mr-2 h-4 w-4" />
                    –ú–æ–∏ –≥—Ä—É–∑—ã
                  </TabsTrigger>
                  <TabsTrigger value="requests" className="flex items-center">
                    <FileText className="mr-2 h-4 w-4" />
                    –ó–∞—è–≤–∫–∏
                  </TabsTrigger>
                  <TabsTrigger value="contact" className="flex items-center">
                    <MessageCircle className="mr-2 h-4 w-4" />
                    –°–≤—è–∑—å
                  </TabsTrigger>
                </TabsList>

                {/* Dashboard Tab */}
                <TabsContent value="dashboard" className="space-y-6">
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* Recent Cargo */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Package className="mr-2 h-5 w-5" />
                          –ü–æ—Å–ª–µ–¥–Ω–∏–µ –≥—Ä—É–∑—ã
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {clientDashboard?.recent_cargo && clientDashboard.recent_cargo.length > 0 ? (
                            clientDashboard.recent_cargo.slice(0, 3).map((cargo) => (
                              <div key={cargo.id} className="flex items-center justify-between p-3 border rounded-lg">
                                <div>
                                  <div className="font-medium">#{cargo.cargo_number}</div>
                                  <div className="text-sm text-gray-600">{cargo.cargo_name || '–ì—Ä—É–∑'}</div>
                                  <div className="text-xs text-gray-500">
                                    {cargo.recipient_full_name}
                                  </div>
                                </div>
                                <Badge variant={cargo.status === 'delivered' ? 'default' : 'outline'}>
                                  {cargo.status}
                                </Badge>
                              </div>
                            ))
                          ) : (
                            <p className="text-gray-500 text-center py-4">–ù–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –≥—Ä—É–∑–æ–≤</p>
                          )}
                        </div>
                        <div className="mt-4">
                          <Button 
                            variant="outline" 
                            className="w-full" 
                            onClick={() => {
                              setActiveTab('cargo');
                              fetchClientCargo();
                            }}
                          >
                            –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –≥—Ä—É–∑—ã
                          </Button>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Unpaid Cargo */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <CreditCard className="mr-2 h-5 w-5 text-red-600" />
                          –ö –æ–ø–ª–∞—Ç–µ
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {clientDashboard?.unpaid_cargo && clientDashboard.unpaid_cargo.length > 0 ? (
                            clientDashboard.unpaid_cargo.slice(0, 3).map((cargo) => (
                              <div key={cargo.id} className="flex items-center justify-between p-3 border rounded-lg bg-red-50">
                                <div>
                                  <div className="font-medium">#{cargo.cargo_number}</div>
                                  <div className="text-sm text-gray-600">{cargo.cargo_name || '–ì—Ä—É–∑'}</div>
                                  <div className="text-sm font-medium text-red-600">
                                    {cargo.declared_value} ‚ÇΩ
                                  </div>
                                </div>
                                <Button size="sm" variant="outline">
                                  –û–ø–ª–∞—Ç–∏—Ç—å
                                </Button>
                              </div>
                            ))
                          ) : (
                            <p className="text-gray-500 text-center py-4">–í—Å–µ –≥—Ä—É–∑—ã –æ–ø–ª–∞—á–µ–Ω—ã!</p>
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  </div>

                  {/* Quick Actions */}
                  <Card>
                    <CardHeader>
                      <CardTitle>–ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</CardTitle>
                    </CardHeader>
                    <CardContent>
                      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <Button 
                          className="h-20 flex-col" 
                          variant="outline"
                          onClick={() => setActiveTab('create-order')}
                        >
                          <Plus className="h-6 w-6 mb-2" />
                          –û—Ñ–æ—Ä–º–∏—Ç—å –≥—Ä—É–∑
                        </Button>
                        <Button 
                          className="h-20 flex-col" 
                          variant="outline"
                          onClick={() => setActiveTab('cargo')}
                        >
                          <Package className="h-6 w-6 mb-2" />
                          –û—Ç—Å–ª–µ–¥–∏—Ç—å –≥—Ä—É–∑
                        </Button>
                        <Button 
                          className="h-20 flex-col" 
                          variant="outline"
                          onClick={() => setActiveTab('contact')}
                        >
                          <MessageCircle className="h-6 w-6 mb-2" />
                          –°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏
                        </Button>
                      </div>
                    </CardContent>
                  </Card>
                </TabsContent>

                {/* Create Cargo Order Tab */}
                <TabsContent value="create-order" className="space-y-6">
                  <div className="max-w-4xl mx-auto">
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Plus className="mr-2 h-5 w-5 text-blue-600" />
                          –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≥—Ä—É–∑–∞
                        </CardTitle>
                        <CardDescription>
                          –†–∞—Å—Å—á–∏—Ç–∞–π—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç—å –∏ –æ—Ñ–æ—Ä–º–∏—Ç–µ –≥—Ä—É–∑ –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏
                        </CardDescription>
                      </CardHeader>
                      <CardContent className="xl:p-8">
                        <form onSubmit={handleCreateCargoOrder} className="space-y-6">
                          {/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ */}
                          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="space-y-4">
                              <h3 className="text-lg font-semibold text-gray-900 border-b pb-2">
                                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ
                              </h3>
                              
                              <div>
                                <Label htmlFor="cargo_name">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ *</Label>
                                <Input
                                  id="cargo_name"
                                  value={cargoOrderForm.cargo_name}
                                  onChange={(e) => setCargoOrderForm({...cargoOrderForm, cargo_name: e.target.value})}
                                  placeholder="–î–æ–∫—É–º–µ–Ω—Ç—ã, –æ–¥–µ–∂–¥–∞, –ø–æ–¥–∞—Ä–∫–∏..."
                                  required
                                />
                              </div>

                              <div>
                                <Label htmlFor="description">–û–ø–∏—Å–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ *</Label>
                                <Textarea
                                  id="description"
                                  value={cargoOrderForm.description}
                                  onChange={(e) => setCargoOrderForm({...cargoOrderForm, description: e.target.value})}
                                  placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ –≥—Ä—É–∑–∞"
                                  required
                                />
                              </div>

                              <div className="grid grid-cols-2 gap-4">
                                <div>
                                  <Label htmlFor="weight">–í–µ—Å (–∫–≥) *</Label>
                                  <Input
                                    id="weight"
                                    type="number"
                                    step="0.1"
                                    min="0.1"
                                    max="10000"
                                    value={cargoOrderForm.weight}
                                    onChange={(e) => {
                                      setCargoOrderForm({...cargoOrderForm, weight: e.target.value});
                                      setCostCalculation(null);
                                    }}
                                    placeholder="5.0"
                                    required
                                  />
                                </div>
                                <div>
                                  <Label htmlFor="declared_value">–û–±—ä—è–≤–ª–µ–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ) *</Label>
                                  <Input
                                    id="declared_value"
                                    type="number"
                                    min="100"
                                    max="10000000"
                                    value={cargoOrderForm.declared_value}
                                    onChange={(e) => {
                                      setCargoOrderForm({...cargoOrderForm, declared_value: e.target.value});
                                      setCostCalculation(null);
                                    }}
                                    placeholder="25000"
                                    required
                                  />
                                </div>
                              </div>

                              <div className="grid grid-cols-2 gap-4">
                                <div>
                                  <Label htmlFor="route">–ú–∞—Ä—à—Ä—É—Ç *</Label>
                                  <Select 
                                    value={cargoOrderForm.route} 
                                    onValueChange={(value) => {
                                      handleRouteChange(value); // –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏—é
                                      setCostCalculation(null);
                                    }}
                                  >
                                    <SelectTrigger>
                                      <SelectValue />
                                    </SelectTrigger>
                                    <SelectContent>
                                      {deliveryOptions?.routes?.map((route) => (
                                        <SelectItem key={route.value} value={route.value}>
                                          {route.label} ({route.base_days} –¥–Ω–µ–π)
                                        </SelectItem>
                                      ))}
                                    </SelectContent>
                                  </Select>
                                </div>
                                <div>
                                  <Label htmlFor="delivery_type">–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏ *</Label>
                                  <Select 
                                    value={cargoOrderForm.delivery_type} 
                                    onValueChange={(value) => {
                                      setCargoOrderForm({...cargoOrderForm, delivery_type: value});
                                      setCostCalculation(null);
                                    }}
                                  >
                                    <SelectTrigger>
                                      <SelectValue />
                                    </SelectTrigger>
                                    <SelectContent>
                                      {deliveryOptions?.delivery_types?.map((type) => (
                                        <SelectItem key={type.value} value={type.value}>
                                          {type.label}
                                        </SelectItem>
                                      ))}
                                    </SelectContent>
                                  </Select>
                                </div>
                              </div>
                            </div>

                            <div className="space-y-4">
                              <h3 className="text-lg font-semibold text-gray-900 border-b pb-2">
                                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ
                              </h3>
                              
                              <div>
                                <Label htmlFor="recipient_full_name">–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</Label>
                                <Input
                                  id="recipient_full_name"
                                  value={cargoOrderForm.recipient_full_name}
                                  onChange={(e) => setCargoOrderForm({...cargoOrderForm, recipient_full_name: e.target.value})}
                                  placeholder="–ê–ª–∏–µ–≤ –§–∞—Ä—Ö–æ–¥ –†–∞—Ö–∏–º–æ–≤–∏—á"
                                  required
                                />
                              </div>

                              <div>
                                <Label htmlFor="recipient_phone">–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</Label>
                                <Input
                                  id="recipient_phone"
                                  type="tel"
                                  value={cargoOrderForm.recipient_phone}
                                  onChange={(e) => setCargoOrderForm({...cargoOrderForm, recipient_phone: e.target.value})}
                                  placeholder="+992901234567"
                                  required
                                />
                              </div>

                              <div>
                                <Label htmlFor="recipient_address">–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</Label>
                                <Input
                                  id="recipient_address"
                                  value={cargoOrderForm.recipient_address}
                                  onChange={(e) => setCargoOrderForm({...cargoOrderForm, recipient_address: e.target.value})}
                                  placeholder="—É–ª. –†—É–¥–∞–∫–∏, 15, –∫–≤. 25"
                                  required
                                />
                              </div>

                              <div>
                                <Label htmlFor="recipient_city">–ì–æ—Ä–æ–¥ –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</Label>
                                <Input
                                  id="recipient_city"
                                  value={cargoOrderForm.recipient_city}
                                  onChange={(e) => setCargoOrderForm({...cargoOrderForm, recipient_city: e.target.value})}
                                  placeholder="–î—É—à–∞–Ω–±–µ"
                                  required
                                />
                              </div>
                            </div>
                          </div>

                          {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏ */}
                          <div className="border-t pt-6">
                            <h3 className="text-lg font-semibold text-gray-900 mb-4">
                              –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å–ª—É–≥–∏
                            </h3>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                              {/* –°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ */}
                              <div className="flex items-center space-x-2 p-4 border rounded-lg">
                                <input
                                  type="checkbox"
                                  id="insurance_requested"
                                  checked={cargoOrderForm.insurance_requested}
                                  onChange={(e) => {
                                    setCargoOrderForm({
                                      ...cargoOrderForm, 
                                      insurance_requested: e.target.checked,
                                      insurance_value: e.target.checked ? cargoOrderForm.declared_value : ''
                                    });
                                    setCostCalculation(null);
                                  }}
                                  className="rounded"
                                />
                                <div className="flex-1">
                                  <Label htmlFor="insurance_requested" className="font-medium">
                                    –°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ
                                  </Label>
                                  <p className="text-sm text-gray-600">
                                    0.5% –æ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏, –º–∏–Ω. 500 ‚ÇΩ
                                  </p>
                                  {cargoOrderForm.insurance_requested && (
                                    <Input
                                      type="number"
                                      value={cargoOrderForm.insurance_value}
                                      onChange={(e) => {
                                        setCargoOrderForm({...cargoOrderForm, insurance_value: e.target.value});
                                        setCostCalculation(null);
                                      }}
                                      placeholder="–°—É–º–º–∞ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è"
                                      className="mt-2"
                                    />
                                  )}
                                </div>
                              </div>

                              {/* –£–ø–∞–∫–æ–≤–∫–∞ */}
                              <div className="flex items-center space-x-2 p-4 border rounded-lg">
                                <input
                                  type="checkbox"
                                  id="packaging_service"
                                  checked={cargoOrderForm.packaging_service}
                                  onChange={(e) => {
                                    setCargoOrderForm({...cargoOrderForm, packaging_service: e.target.checked});
                                    setCostCalculation(null);
                                  }}
                                  className="rounded"
                                />
                                <div>
                                  <Label htmlFor="packaging_service" className="font-medium">
                                    –£–ø–∞–∫–æ–≤–∫–∞
                                  </Label>
                                  <p className="text-sm text-gray-600">
                                    –ü—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω–∞—è —É–ø–∞–∫–æ–≤–∫–∞ - 800 ‚ÇΩ
                                  </p>
                                </div>
                              </div>

                              {/* –ó–∞–±–æ—Ä –Ω–∞ –¥–æ–º—É */}
                              <div className="flex items-center space-x-2 p-4 border rounded-lg">
                                <input
                                  type="checkbox"
                                  id="home_pickup"
                                  checked={cargoOrderForm.home_pickup}
                                  onChange={(e) => {
                                    setCargoOrderForm({...cargoOrderForm, home_pickup: e.target.checked});
                                    setCostCalculation(null);
                                  }}
                                  className="rounded"
                                />
                                <div>
                                  <Label htmlFor="home_pickup" className="font-medium">
                                    –ó–∞–±–æ—Ä –Ω–∞ –¥–æ–º—É
                                  </Label>
                                  <p className="text-sm text-gray-600">
                                    –ó–∞–±–µ—Ä–µ–º –≥—Ä—É–∑ –ø–æ –∞–¥—Ä–µ—Å—É - 1500 ‚ÇΩ
                                  </p>
                                </div>
                              </div>

                              {/* –î–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ –¥–æ–º */}
                              <div className="flex items-center space-x-2 p-4 border rounded-lg">
                                <input
                                  type="checkbox"
                                  id="home_delivery"
                                  checked={cargoOrderForm.home_delivery}
                                  onChange={(e) => {
                                    setCargoOrderForm({...cargoOrderForm, home_delivery: e.target.checked});
                                    setCostCalculation(null);
                                  }}
                                  className="rounded"
                                />
                                <div>
                                  <Label htmlFor="home_delivery" className="font-medium">
                                    –î–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ –¥–æ–º
                                  </Label>
                                  <p className="text-sm text-gray-600">
                                    –î–æ—Å—Ç–∞–≤–∏–º –≥—Ä—É–∑ –ø–æ–ª—É—á–∞—Ç–µ–ª—é - 1200 ‚ÇΩ
                                  </p>
                                </div>
                              </div>

                              {/* –•—Ä—É–ø–∫–∏–π –≥—Ä—É–∑ */}
                              <div className="flex items-center space-x-2 p-4 border rounded-lg">
                                <input
                                  type="checkbox"
                                  id="fragile"
                                  checked={cargoOrderForm.fragile}
                                  onChange={(e) => {
                                    setCargoOrderForm({...cargoOrderForm, fragile: e.target.checked});
                                    setCostCalculation(null);
                                  }}
                                  className="rounded"
                                />
                                <div>
                                  <Label htmlFor="fragile" className="font-medium">
                                    –•—Ä—É–ø–∫–∏–π –≥—Ä—É–∑
                                  </Label>
                                  <p className="text-sm text-gray-600">
                                    –û—Å–æ–±–∞—è –æ—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å - 500 ‚ÇΩ
                                  </p>
                                </div>
                              </div>

                              {/* –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ä–µ–∂–∏–º */}
                              <div className="flex items-center space-x-2 p-4 border rounded-lg">
                                <input
                                  type="checkbox"
                                  id="temperature_sensitive"
                                  checked={cargoOrderForm.temperature_sensitive}
                                  onChange={(e) => {
                                    setCargoOrderForm({...cargoOrderForm, temperature_sensitive: e.target.checked});
                                    setCostCalculation(null);
                                  }}
                                  className="rounded"
                                />
                                <div>
                                  <Label htmlFor="temperature_sensitive" className="font-medium">
                                    –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–Ω—ã–π —Ä–µ–∂–∏–º
                                  </Label>
                                  <p className="text-sm text-gray-600">
                                    –ö–æ–Ω—Ç—Ä–æ–ª—å —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã - 800 ‚ÇΩ
                                  </p>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* –°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ */}
                          <div>
                            <Label htmlFor="special_instructions">–°–ø–µ—Ü–∏–∞–ª—å–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</Label>
                            <Textarea
                              id="special_instructions"
                              value={cargoOrderForm.special_instructions}
                              onChange={(e) => setCargoOrderForm({...cargoOrderForm, special_instructions: e.target.value})}
                              placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è –∏–ª–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏..."
                            />
                          </div>

                          {/* –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ */}
                          <div className="border-t pt-6">
                            <div className="flex items-center justify-between mb-4">
                              <h3 className="text-lg font-semibold text-gray-900">
                                –°—Ç–æ–∏–º–æ—Å—Ç—å –¥–æ—Å—Ç–∞–≤–∫–∏
                              </h3>
                              <Button 
                                type="button"
                                variant="outline"
                                onClick={calculateCargoCost}
                                disabled={isCalculating || !cargoOrderForm.weight || !cargoOrderForm.declared_value || !cargoOrderForm.cargo_name}
                              >
                                <Calculator className="mr-2 h-4 w-4" />
                                {isCalculating ? '–†–∞—Å—á–µ—Ç...' : '–†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å'}
                              </Button>
                            </div>

                            {costCalculation && (
                              <div className="bg-blue-50 p-6 rounded-lg">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                  <div>
                                    <h4 className="font-semibold mb-3">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç–æ–∏–º–æ—Å—Ç–∏:</h4>
                                    <div className="space-y-2">
                                      {Object.entries(costCalculation.breakdown).map(([key, value]) => (
                                        <div key={key} className="flex justify-between text-sm">
                                          <span>{key}:</span>
                                          <span className="font-medium">{value}{typeof value === 'number' ? ' ‚ÇΩ' : ''}</span>
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                  <div className="text-center">
                                    <div className="text-3xl font-bold text-blue-600 mb-2">
                                      {costCalculation.calculation.total_cost} ‚ÇΩ
                                    </div>
                                    <div className="text-lg text-gray-600 mb-2">
                                      –°—Ä–æ–∫ –¥–æ—Å—Ç–∞–≤–∫–∏: {costCalculation.calculation.delivery_time_days} –¥–Ω–µ–π
                                    </div>
                                    <div className="text-sm text-gray-500">
                                      –ú–∞—Ä—à—Ä—É—Ç: {costCalculation.route_info.route.replace('_', ' ‚Üí ')}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            )}
                          </div>

                          {/* –ö–Ω–æ–ø–∫–∏ */}
                          <div className="flex items-center justify-between pt-6 border-t">
                            <Button 
                              type="button" 
                              variant="outline"
                              onClick={() => {
                                setCargoOrderForm({
                                  cargo_name: '',
                                  description: '',
                                  weight: '',
                                  declared_value: '',
                                  recipient_full_name: '',
                                  recipient_phone: '',
                                  recipient_address: '',
                                  recipient_city: '',
                                  route: 'moscow_dushanbe',
                                  delivery_type: 'standard',
                                  insurance_requested: false,
                                  insurance_value: '',
                                  packaging_service: false,
                                  home_pickup: false,
                                  home_delivery: false,
                                  fragile: false,
                                  temperature_sensitive: false,
                                  special_instructions: ''
                                });
                                setCostCalculation(null);
                              }}
                            >
                              –û—á–∏—Å—Ç–∏—Ç—å —Ñ–æ—Ä–º—É
                            </Button>
                            <Button 
                              type="submit" 
                              className="bg-blue-600 hover:bg-blue-700"
                              disabled={!costCalculation}
                            >
                              <Package className="mr-2 h-4 w-4" />
                              –û—Ñ–æ—Ä–º–∏—Ç—å –≥—Ä—É–∑
                            </Button>
                          </div>
                        </form>
                      </CardContent>
                    </Card>
                  </div>
                </TabsContent>

                {/* Cargo Tab */}
                <TabsContent value="cargo" className="space-y-6">
                  <div className="flex items-center justify-between">
                    <h2 className="text-xl font-semibold">–ú–æ–∏ –≥—Ä—É–∑—ã</h2>
                    <div className="flex items-center space-x-2">
                      <Select defaultValue="all" onValueChange={(value) => fetchClientCargo(value === 'all' ? null : value)}>
                        <SelectTrigger className="w-40">
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem key="all" value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</SelectItem>
                          <SelectItem key="accepted" value="accepted">–ü—Ä–∏–Ω—è—Ç</SelectItem>
                          <SelectItem key="placed_in_warehouse" value="placed_in_warehouse">–ù–∞ —Å–∫–ª–∞–¥–µ</SelectItem>
                          <SelectItem key="on_transport" value="on_transport">–ù–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ</SelectItem>
                          <SelectItem key="in_transit" value="in_transit">–í –ø—É—Ç–∏</SelectItem>
                          <SelectItem key="delivered" value="delivered">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</SelectItem>
                        </SelectContent>
                      </Select>
                      <Button 
                        variant="outline" 
                        onClick={() => fetchClientCargo()}
                      >
                        –û–±–Ω–æ–≤–∏—Ç—å
                      </Button>
                    </div>
                  </div>

                  <div className="space-y-4">
                    {clientCargo.length === 0 ? (
                      <Card>
                        <CardContent className="p-8 text-center">
                          <Package className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                          <p className="text-gray-500">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –≥—Ä—É–∑–æ–≤</p>
                          <Button 
                            className="mt-4" 
                            onClick={() => setActiveTab('requests')}
                          >
                            –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≥—Ä—É–∑
                          </Button>
                        </CardContent>
                      </Card>
                    ) : (
                      clientCargo.map((cargo) => (
                        <Card key={cargo.id}>
                          <CardContent className="p-6">
                            <div className="flex items-center justify-between mb-4">
                              <div>
                                <h3 className="font-semibold text-lg">#{cargo.cargo_number}</h3>
                                <p className="text-gray-600">{cargo.cargo_name || '–ì—Ä—É–∑'}</p>
                              </div>
                              <Badge variant={cargo.status === 'delivered' ? 'default' : 'outline'}>
                                {cargo.status}
                              </Badge>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                              <div>
                                <p className="text-sm text-gray-600">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</p>
                                <p className="font-medium">{cargo.recipient_full_name}</p>
                                <p className="text-sm text-gray-600">{cargo.recipient_phone}</p>
                              </div>
                              <div>
                                <p className="text-sm text-gray-600">–í–µ—Å:</p>
                                <p className="font-medium">{cargo.weight} –∫–≥</p>
                                <p className="text-sm text-gray-600">–°—Ç–æ–∏–º–æ—Å—Ç—å: {cargo.declared_value} ‚ÇΩ</p>
                              </div>
                            </div>

                            {cargo.location_description && (
                              <div className="mb-4">
                                <p className="text-sm text-gray-600">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</p>
                                <p className="font-medium">{cargo.location_description}</p>
                              </div>
                            )}

                            <div className="flex items-center justify-between">
                              <div className="flex items-center space-x-4 text-sm text-gray-600">
                                {cargo.tracking_code && (
                                  <span className="flex items-center">
                                    <QrCode className="mr-1 h-4 w-4" />
                                    –¢—Ä–µ–∫–∏–Ω–≥: {cargo.tracking_code}
                                  </span>
                                )}
                                {cargo.photo_count > 0 && (
                                  <span className="flex items-center">
                                    <Camera className="mr-1 h-4 w-4" />
                                    {cargo.photo_count} —Ñ–æ—Ç–æ
                                  </span>
                                )}
                                {cargo.comment_count > 0 && (
                                  <span className="flex items-center">
                                    <MessageCircle className="mr-1 h-4 w-4" />
                                    {cargo.comment_count} –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤
                                  </span>
                                )}
                              </div>
                              <div className="flex space-x-2">
                                <Button 
                                  variant="outline" 
                                  size="sm"
                                  onClick={() => openRepeatOrder(cargo)}
                                  className="text-green-600 hover:text-green-700"
                                  title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑ —Å —Ç–µ–º–∏ –∂–µ –¥–∞–Ω–Ω—ã–º–∏"
                                >
                                  <Copy className="mr-1 h-4 w-4" />
                                  –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                                </Button>
                                <Button 
                                  variant="outline" 
                                  size="sm"
                                  onClick={() => fetchClientCargoDetails(cargo.id)}
                                >
                                  <Eye className="mr-1 h-4 w-4" />
                                  –ü–æ–¥—Ä–æ–±–Ω–µ–µ
                                </Button>
                              </div>
                            </div>
                          </CardContent>
                        </Card>
                      ))
                    )}
                  </div>
                </TabsContent>

                {/* Keep existing Requests and Contact tabs */}
                <TabsContent value="requests" className="space-y-6">
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Plus className="mr-2 h-5 w-5" />
                          –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –≥—Ä—É–∑
                        </CardTitle>
                        <CardDescription>
                          –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É –≥—Ä—É–∑–∞
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <form onSubmit={handleCreateRequest} className="space-y-4">
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <Label htmlFor="recipient_full_name">–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è</Label>
                              <Input
                                id="recipient_full_name"
                                value={requestForm.recipient_full_name}
                                onChange={(e) => setRequestForm({...requestForm, recipient_full_name: e.target.value})}
                                required
                              />
                            </div>
                            <div>
                              <Label htmlFor="recipient_phone">–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è</Label>
                              <Input
                                id="recipient_phone"
                                type="tel"
                                value={requestForm.recipient_phone}
                                onChange={(e) => setRequestForm({...requestForm, recipient_phone: e.target.value})}
                                required
                              />
                            </div>
                          </div>
                          <div>
                            <Label htmlFor="recipient_address">–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è</Label>
                            <Input
                              id="recipient_address"
                              value={requestForm.recipient_address}
                              onChange={(e) => setRequestForm({...requestForm, recipient_address: e.target.value})}
                              required
                            />
                          </div>
                          <div>
                            <Label htmlFor="pickup_address">–ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞ –≥—Ä—É–∑–∞</Label>
                            <Input
                              id="pickup_address"
                              value={requestForm.pickup_address}
                              onChange={(e) => setRequestForm({...requestForm, pickup_address: e.target.value})}
                              required
                            />
                          </div>
                          <div>
                            <Label htmlFor="cargo_name">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞</Label>
                            <Input
                              id="cargo_name"
                              value={requestForm.cargo_name}
                              onChange={(e) => setRequestForm({...requestForm, cargo_name: e.target.value})}
                              required
                            />
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <Label htmlFor="weight">–í–µ—Å (–∫–≥)</Label>
                              <Input
                                id="weight"
                                type="number"
                                step="0.1"
                                value={requestForm.weight}
                                onChange={(e) => setRequestForm({...requestForm, weight: e.target.value})}
                                required
                              />
                            </div>
                            <div>
                              <Label htmlFor="declared_value">–û–±—ä—è–≤–ª–µ–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</Label>
                              <Input
                                id="declared_value"
                                type="number"
                                value={requestForm.declared_value}
                                onChange={(e) => setRequestForm({...requestForm, declared_value: e.target.value})}
                                required
                              />
                            </div>
                          </div>
                          <div>
                            <Label htmlFor="description">–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–∑–∞</Label>
                            <Textarea
                              id="description"
                              value={requestForm.description}
                              onChange={(e) => setRequestForm({...requestForm, description: e.target.value})}
                              required
                            />
                          </div>
                          <Button type="submit" className="w-full">
                            –ü–æ–¥–∞—Ç—å –∑–∞—è–≤–∫—É
                          </Button>
                        </form>
                      </CardContent>
                    </Card>

                    {/* –ú–æ–∏ –∑–∞—è–≤–∫–∏ */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <FileText className="mr-2 h-5 w-5" />
                          –ú–æ–∏ –∑–∞—è–≤–∫–∏
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {myRequests.length === 0 ? (
                            <p className="text-gray-500 text-center py-4">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫</p>
                          ) : (
                            myRequests.map((request) => (
                              <div key={request.id} className="border rounded-lg p-4">
                                <div className="flex justify-between items-start mb-2">
                                  <div>
                                    <div className="font-medium">{request.recipient_full_name}</div>
                                    <div className="text-sm text-gray-600">{request.recipient_phone}</div>
                                  </div>
                                  <Badge variant={request.status === 'approved' ? 'default' : 'outline'}>
                                    {request.status}
                                  </Badge>
                                </div>
                                <div className="text-sm text-gray-600 mb-2">
                                  {request.description}
                                </div>
                                <div className="flex justify-between text-sm">
                                  <span>–í–µ—Å: {request.weight} –∫–≥</span>
                                  <span>–°—Ç–æ–∏–º–æ—Å—Ç—å: {request.declared_value} ‚ÇΩ</span>
                                </div>
                              </div>
                            ))
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  </div>
                </TabsContent>

                <TabsContent value="contact" className="space-y-6">
                  <Card>
                    <CardHeader>
                      <CardTitle className="flex items-center">
                        <MessageCircle className="mr-2 h-5 w-5" />
                        –°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏
                      </CardTitle>
                      <CardDescription>
                        –í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏
                      </CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                        <Button className="h-20 flex-col" variant="outline">
                          <MessageCircle className="h-6 w-6 mb-2" />
                          WhatsApp
                        </Button>
                        <Button className="h-20 flex-col" variant="outline">
                          <MessageCircle className="h-6 w-6 mb-2" />
                          Telegram
                        </Button>
                        <Button className="h-20 flex-col" variant="outline">
                          <MessageCircle className="h-6 w-6 mb-2" />
                          –û–Ω–ª–∞–π–Ω —á–∞—Ç
                        </Button>
                      </div>
                    </CardContent>
                  </Card>
                </TabsContent>
              </Tabs>
            </div>
          ) : (
            /* –î–ª—è –∞–¥–º–∏–Ω–∞ –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å–∫–ª–∞–¥–∞ - –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å –±–æ–∫–æ–≤—ã–º –º–µ–Ω—é */
            <div className="space-y-6">
              
              {/* –®–∞–ø–∫–∞ —Å –ø–æ–∏—Å–∫–æ–º –∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è–º–∏ - –°–ö–†–´–¢–ê –î–õ–Ø –ö–£–†–¨–ï–†–û–í */}
              {user.role !== 'courier' && (
                <Card>
                  <CardContent className="p-4">
                    <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                    
                    {/* –ü–æ–∏—Å–∫ —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ —Ñ—É–Ω–∫—Ü–∏—è–º–∏ */}
                    <div className="flex-1 max-w-md relative">
                      <div className="relative">
                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input
                          placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É, –§–ò–û, —Ç–µ–ª–µ—Ñ–æ–Ω—É..."
                          value={searchQuery}
                          onChange={(e) => handleSearchInput(e.target.value)}
                          onKeyPress={(e) => {
                            if (e.key === 'Enter') {
                              handleAdvancedSearch(searchQuery);
                            }
                          }}
                          className="pl-10 pr-20"
                        />
                        
                        {/* –ö–Ω–æ–ø–∫–∞ —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –ø–æ–∏—Å–∫–∞ */}
                        <Button
                          size="sm"
                          variant="outline"
                          className="absolute right-1 top-1/2 transform -translate-y-1/2"
                          onClick={() => setAdvancedSearchOpen(!advancedSearchOpen)}
                        >
                          <Filter className="h-4 w-4" />
                        </Button>
                        
                        {searchQuery && (
                          <Button
                            size="sm"
                            variant="ghost"
                            className="absolute right-12 top-1/2 transform -translate-y-1/2"
                            onClick={clearSearch}
                          >
                            <X className="h-4 w-4" />
                          </Button>
                        )}
                      </div>

                      {/* –ê–≤—Ç–æ–¥–æ–ø–æ–ª–Ω–µ–Ω–∏–µ */}
                      {showSuggestions && searchSuggestions.length > 0 && (
                        <div className="absolute z-50 mt-1 w-full bg-white border rounded-lg shadow-lg">
                          {searchSuggestions.map((suggestion, index) => (
                            <div
                              key={`search-${index}-${suggestion.id || suggestion.name || index}`}
                              className="p-2 hover:bg-gray-100 cursor-pointer text-sm"
                              onClick={() => selectSearchSuggestion(suggestion)}
                            >
                              <Search className="inline mr-2 h-3 w-3 text-gray-400" />
                              {suggestion}
                            </div>
                          ))}
                        </div>
                      )}

                      {/* –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã */}
                      {advancedSearchOpen && (
                        <div className="absolute z-50 mt-2 w-96 bg-white border rounded-lg shadow-lg p-4">
                          <div className="space-y-4">
                            <h3 className="font-semibold text-sm">–†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã</h3>
                            
                            {/* –§–∏–ª—å—Ç—Ä—ã –¥–ª—è –≥—Ä—É–∑–æ–≤ */}
                            <div className="grid grid-cols-2 gap-2">
                              <div>
                                <Label className="text-xs">–°—Ç–∞—Ç—É—Å –≥—Ä—É–∑–∞</Label>
                                <Select 
                                  value={searchFilters.cargo_status} 
                                  onValueChange={(value) => setSearchFilters({...searchFilters, cargo_status: value})}
                                >
                                  <SelectTrigger className="h-8">
                                    <SelectValue placeholder="–õ—é–±–æ–π" />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="any">–õ—é–±–æ–π</SelectItem>
                                    <SelectItem value="accepted">–ü—Ä–∏–Ω—è—Ç</SelectItem>
                                    <SelectItem value="in_transit">–í –ø—É—Ç–∏</SelectItem>
                                    <SelectItem value="delivered">–î–æ—Å—Ç–∞–≤–ª–µ–Ω</SelectItem>
                                    <SelectItem value="returned">–í–æ–∑–≤—Ä–∞—â–µ–Ω</SelectItem>
                                  </SelectContent>
                                </Select>
                              </div>
                              
                              <div>
                                <Label className="text-xs">–û–ø–ª–∞—Ç–∞</Label>
                                <Select 
                                  value={searchFilters.payment_status} 
                                  onValueChange={(value) => setSearchFilters({...searchFilters, payment_status: value})}
                                >
                                  <SelectTrigger className="h-8">
                                    <SelectValue placeholder="–õ—é–±–∞—è" />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="any">–õ—é–±–∞—è</SelectItem>
                                    <SelectItem value="pending">–û–∂–∏–¥–∞–µ—Ç—Å—è</SelectItem>
                                    <SelectItem value="paid">–û–ø–ª–∞—á–µ–Ω</SelectItem>
                                  </SelectContent>
                                </Select>
                              </div>
                            </div>

                            <div className="grid grid-cols-2 gap-2">
                              <div>
                                <Label className="text-xs">–ú–∞—Ä—à—Ä—É—Ç</Label>
                                <Select 
                                  value={searchFilters.route} 
                                  onValueChange={(value) => setSearchFilters({...searchFilters, route: value})}
                                >
                                  <SelectTrigger className="h-8">
                                    <SelectValue placeholder="–õ—é–±–æ–π" />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="any">–õ—é–±–æ–π</SelectItem>
                                    <SelectItem value="moscow_to_tajikistan">–ú–æ—Å–∫–≤–∞ ‚Üí –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω</SelectItem>
                                    <SelectItem value="tajikistan_to_moscow">–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω ‚Üí –ú–æ—Å–∫–≤–∞</SelectItem>
                                  </SelectContent>
                                </Select>
                              </div>
                              
                              <div>
                                <Label className="text-xs">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</Label>
                                <Select 
                                  value={searchFilters.sort_by} 
                                  onValueChange={(value) => setSearchFilters({...searchFilters, sort_by: value})}
                                >
                                  <SelectTrigger className="h-8">
                                    <SelectValue />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="created_at">–ü–æ –¥–∞—Ç–µ</SelectItem>
                                    <SelectItem value="relevance_score">–ü–æ —Ä–µ–ª–µ–≤–∞–Ω—Ç–Ω–æ—Å—Ç–∏</SelectItem>
                                    <SelectItem value="weight">–ü–æ –≤–µ—Å—É</SelectItem>
                                    <SelectItem value="declared_value">–ü–æ —Å—Ç–æ–∏–º–æ—Å—Ç–∏</SelectItem>
                                  </SelectContent>
                                </Select>
                              </div>
                            </div>

                            {/* –ü–æ–ª—è –¥–ª—è —Ç–µ–ª–µ—Ñ–æ–Ω–æ–≤ */}
                            <div className="grid grid-cols-2 gap-2">
                              <div>
                                <Label className="text-xs">–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è</Label>
                                <Input
                                  className="h-8"
                                  placeholder="+7..."
                                  value={searchFilters.sender_phone}
                                  onChange={(e) => setSearchFilters({...searchFilters, sender_phone: e.target.value})}
                                />
                              </div>
                              <div>
                                <Label className="text-xs">–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è</Label>
                                <Input
                                  className="h-8"
                                  placeholder="+992..."
                                  value={searchFilters.recipient_phone}
                                  onChange={(e) => setSearchFilters({...searchFilters, recipient_phone: e.target.value})}
                                />
                              </div>
                            </div>

                            {/* –î–∏–∞–ø–∞–∑–æ–Ω –¥–∞—Ç */}
                            <div className="grid grid-cols-2 gap-2">
                              <div>
                                <Label className="text-xs">–û—Ç –¥–∞—Ç—ã</Label>
                                <Input
                                  type="date"
                                  className="h-8"
                                  value={searchFilters.date_from}
                                  onChange={(e) => setSearchFilters({...searchFilters, date_from: e.target.value})}
                                />
                              </div>
                              <div>
                                <Label className="text-xs">–î–æ –¥–∞—Ç—ã</Label>
                                <Input
                                  type="date"
                                  className="h-8"
                                  value={searchFilters.date_to}
                                  onChange={(e) => setSearchFilters({...searchFilters, date_to: e.target.value})}
                                />
                              </div>
                            </div>

                            <div className="flex justify-between">
                              <Button
                                size="sm"
                                variant="outline"
                                onClick={() => {
                                  setSearchFilters({
                                    cargo_status: '',
                                    payment_status: '',
                                    processing_status: '',
                                    route: '',
                                    sender_phone: '',
                                    recipient_phone: '',
                                    date_from: '',
                                    date_to: '',
                                    user_role: '',
                                    user_status: null,
                                    sort_by: 'created_at',
                                    sort_order: 'desc'
                                  });
                                }}
                              >
                                –°–±—Ä–æ—Å–∏—Ç—å
                              </Button>
                              <Button
                                size="sm"
                                onClick={() => {
                                  handleAdvancedSearch(searchQuery, searchFilters);
                                  setAdvancedSearchOpen(false);
                                }}
                                disabled={searchLoading}
                              >
                                {searchLoading ? '–ü–æ–∏—Å–∫...' : '–ü—Ä–∏–º–µ–Ω–∏—Ç—å'}
                              </Button>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {/* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ */}
                      {showSearchResults && (
                        <div className="absolute z-40 mt-2 w-full bg-white border rounded-lg shadow-lg max-h-80 overflow-y-auto">
                          {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–∏—Å–∫–µ */}
                          {searchTime > 0 && (
                            <div className="px-3 py-2 bg-gray-50 border-b text-xs text-gray-600">
                              –ù–∞–π–¥–µ–Ω–æ {searchResults.length} —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –∑–∞ {searchTime}–º—Å
                            </div>
                          )}
                          
                          {!Array.isArray(searchResults) || searchResults.length === 0 ? (
                            <div className="p-4 text-gray-500 text-center">–ù–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>
                          ) : (
                            searchResults.map((result) => (
                              <div
                                key={result.id}
                                className="p-3 border-b hover:bg-gray-50 cursor-pointer"
                                onClick={() => {
                                  if (result.type === 'cargo') {
                                    fetchCargoDetails(result.id).then(cargoDetails => {
                                      setSelectedCellCargo(cargoDetails);
                                      setCargoDetailModal(true);
                                      clearSearch();
                                    });
                                  } else if (result.type === 'user') {
                                    // –û—Ç–∫—Ä—ã—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                    console.log('Open user profile:', result.id);
                                  } else if (result.type === 'warehouse') {
                                    // –û—Ç–∫—Ä—ã—Ç—å —Å–∫–ª–∞–¥
                                    console.log('Open warehouse:', result.id);
                                  }
                                }}
                              >
                                <div className="flex items-start justify-between">
                                  <div className="flex-1">
                                    <div className="font-medium text-sm">{result.title}</div>
                                    <div className="text-xs text-gray-600">{result.subtitle}</div>
                                    
                                    {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ */}
                                    {result.type === 'cargo' && (
                                      <div className="mt-1 text-xs text-gray-500">
                                        {result.details.weight && `${result.details.weight} –∫–≥`}
                                        {result.details.declared_value && ` ‚Ä¢ ${result.details.declared_value} —Ä—É–±`}
                                        {result.details.status && ` ‚Ä¢ ${result.details.status}`}
                                      </div>
                                    )}
                                    
                                    {result.type === 'warehouse' && (
                                      <div className="mt-1 text-xs text-gray-500">
                                        {result.details.cargo_count} –≥—Ä—É–∑–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ
                                      </div>
                                    )}
                                  </div>
                                  
                                  <div className="ml-2 text-right">
                                    <Badge variant="outline" className="text-xs">
                                      {result.type === 'cargo' ? '–ì—Ä—É–∑' : 
                                       result.type === 'user' ? '–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å' : '–°–∫–ª–∞–¥'}
                                    </Badge>
                                    {result.relevance_score && (
                                      <div className="text-xs text-gray-400 mt-1">
                                        {result.relevance_score.toFixed(0)}%
                                      </div>
                                    )}
                                  </div>
                                </div>
                              </div>
                            ))
                          )}
                        </div>
                      )}
                    </div>
                    
                    {/* –§–∏–ª—å—Ç—Ä –ø–æ–∏—Å–∫–∞ */}
                    <Select value={searchType} onValueChange={setSearchType}>
                      <SelectTrigger className="w-40">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">–í–µ–∑–¥–µ</SelectItem>
                        <SelectItem value="number">–ü–æ –Ω–æ–º–µ—Ä—É</SelectItem>
                        <SelectItem value="sender_name">–ü–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é</SelectItem>
                        <SelectItem value="recipient_name">–ü–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—é</SelectItem>
                        <SelectItem value="phone">–ü–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É</SelectItem>
                        <SelectItem value="cargo_name">–ü–æ –Ω–∞–∑–≤–∞–Ω–∏—é</SelectItem>
                      </SelectContent>
                    </Select>
                    
                    {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∏ –±—ã—Å—Ç—Ä—ã–π –¥–æ—Å—Ç—É–ø */}
                    <div className="flex items-center space-x-4">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={startCargoQRScanner}
                        title="–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥ –≥—Ä—É–∑–∞"
                      >
                        <Camera className="h-4 w-4 mr-2" />
                        –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR
                      </Button>
                      
                      <div className="text-sm text-gray-600">
                        –í—Å–µ–≥–æ –≥—Ä—É–∑–æ–≤: <span className="font-medium">{cargo.length}</span>
                      </div>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => {
                          fetchNotifications();
                          fetchNotifications();
                        }}
                      >
                        <Bell className="h-4 w-4 mr-2" />
                        –û–±–Ω–æ–≤–∏—Ç—å
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>
              )}

              {/* Dashboard - –¢–û–õ–¨–ö–û –î–õ–Ø –ê–î–ú–ò–ù–û–í –ò –û–ü–ï–†–ê–¢–û–†–û–í */}
              {activeSection === 'dashboard' && user.role !== 'courier' && (
                <div className="space-y-6 relative">
                  <DevBadge id={getDevNumber('pages', 'dashboard').id} type="page" label={getDevNumber('pages', 'dashboard').label} />
                  {/* –ö–Ω–æ–ø–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ */}
                  <div className="flex justify-between items-center">
                    <h2 className="text-2xl font-bold">–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–∞—à–±–æ—Ä–¥</h2>
                    <Button 
                      onClick={fetchAdminDashboardAnalytics}
                      disabled={adminAnalyticsLoading}
                      variant="outline"
                    >
                      <RefreshCw className={`h-4 w-4 mr-2 ${adminAnalyticsLoading ? 'animate-spin' : ''}`} />
                      {adminAnalyticsLoading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–û–±–Ω–æ–≤–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É'}
                    </Button>
                  </div>

                  {adminDashboardAnalytics ? (
                    <>
                      {/* –û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
                      <div>
                        <h3 className="text-lg font-semibold mb-4 text-gray-700">–û—Å–Ω–æ–≤–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                          <Card className="bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">–°–∫–ª–∞–¥—ã</CardTitle>
                              <Building className="h-4 w-4 text-blue-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-blue-700">{adminDashboardAnalytics.basic_stats.total_warehouses}</div>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-green-50 to-green-100 border-green-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</CardTitle>
                              <Users className="h-4 w-4 text-green-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-green-700">{adminDashboardAnalytics.basic_stats.total_users}</div>
                              <p className="text-xs text-green-600 mt-1">
                                –ê–¥–º–∏–Ω—ã: {adminDashboardAnalytics.basic_stats.total_admins}, 
                                –û–ø–µ—Ä–∞—Ç–æ—Ä—ã: {adminDashboardAnalytics.basic_stats.total_operators}
                              </p>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–∏</CardTitle>
                              <User className="h-4 w-4 text-purple-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-purple-700">{adminDashboardAnalytics.people_stats.unique_senders}</div>
                              <p className="text-xs text-purple-600 mt-1">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö</p>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-orange-50 to-orange-100 border-orange-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">–ü–æ–ª—É—á–∞—Ç–µ–ª–∏</CardTitle>
                              <User className="h-4 w-4 text-orange-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-orange-700">{adminDashboardAnalytics.people_stats.unique_recipients}</div>
                              <p className="text-xs text-orange-600 mt-1">–£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö</p>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-teal-50 to-teal-100 border-teal-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">–í—Å–µ–≥–æ –≥—Ä—É–∑–æ–≤</CardTitle>
                              <Package className="h-4 w-4 text-teal-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-teal-700">{adminDashboardAnalytics.cargo_stats.total_cargo}</div>
                            </CardContent>
                          </Card>
                        </div>
                      </div>

                      {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—Ä—É–∑–æ–≤ */}
                      <div>
                        <h3 className="text-lg font-semibold mb-4 text-gray-700">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—Ä—É–∑–æ–≤</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                          <Card className="bg-gradient-to-br from-indigo-50 to-indigo-100 border-indigo-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">–û–±—â–∏–π –≤–µ—Å</CardTitle>
                              <Package2 className="h-4 w-4 text-indigo-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-indigo-700">{adminDashboardAnalytics.cargo_stats.total_weight_kg.toLocaleString()}</div>
                              <p className="text-xs text-indigo-600 mt-1">–∫–≥</p>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-emerald-50 to-emerald-100 border-emerald-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">–û–±—â–∞—è —Å—É–º–º–∞</CardTitle>
                              <DollarSign className="h-4 w-4 text-emerald-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-emerald-700">{adminDashboardAnalytics.cargo_stats.total_sum_rub.toLocaleString()}</div>
                              <p className="text-xs text-emerald-600 mt-1">‚ÇΩ</p>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-amber-50 to-amber-100 border-amber-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">–û–∂–∏–¥–∞—é—Ç –ø–æ–ª—É—á–∞—Ç–µ–ª—è</CardTitle>
                              <Clock className="h-4 w-4 text-amber-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-amber-700">{adminDashboardAnalytics.cargo_stats.awaiting_recipient}</div>
                              <p className="text-xs text-amber-600 mt-1">–≥—Ä—É–∑–æ–≤</p>
                            </CardContent>
                          </Card>
                        </div>
                      </div>

                      {/* –§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
                      <div>
                        <h3 className="text-lg font-semibold mb-4 text-gray-700">–§–∏–Ω–∞–Ω—Å–æ–≤–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <Card className="bg-gradient-to-br from-red-50 to-red-100 border-red-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">–î–æ–ª–∂–Ω–∏–∫–∏</CardTitle>
                              <CreditCard className="h-4 w-4 text-red-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-red-700">{adminDashboardAnalytics.financial_stats.debtors_count}</div>
                              <p className="text-xs text-red-600 mt-1">
                                –°—É–º–º–∞ –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏: {adminDashboardAnalytics.financial_stats.total_debt_amount.toLocaleString()} ‚ÇΩ
                              </p>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-cyan-50 to-cyan-100 border-cyan-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏</CardTitle>
                              <FileText className="h-4 w-4 text-cyan-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-cyan-700">{adminDashboardAnalytics.requests_stats.new_requests}</div>
                              <p className="text-xs text-cyan-600 mt-1">–æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</p>
                            </CardContent>
                          </Card>
                        </div>
                      </div>

                      {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–≤ */}
                      <div>
                        <h3 className="text-lg font-semibold mb-4 text-gray-700">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ã –ø–æ –º–∞—Ä—à—Ä—É—Ç–∞–º</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                          <Card className="bg-gradient-to-br from-violet-50 to-violet-100 border-violet-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">–í—Å–µ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–≤</CardTitle>
                              <Truck className="h-4 w-4 text-violet-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-violet-700">{adminDashboardAnalytics.transport_stats.total_transports}</div>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-rose-50 to-rose-100 border-rose-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">–ú–æ—Å–∫–≤–∞ ‚Üí –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω</CardTitle>
                              <MapPin className="h-4 w-4 text-rose-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-rose-700">{adminDashboardAnalytics.transport_stats.moscow_to_tajikistan}</div>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-lime-50 to-lime-100 border-lime-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω ‚Üí –ú–æ—Å–∫–≤–∞</CardTitle>
                              <MapPin className="h-4 w-4 text-lime-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-lime-700">{adminDashboardAnalytics.transport_stats.tajikistan_to_moscow}</div>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-sky-50 to-sky-100 border-sky-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">–ê–∫—Ç–∏–≤–Ω—ã–µ</CardTitle>
                              <Zap className="h-4 w-4 text-sky-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-sky-700">{adminDashboardAnalytics.transport_stats.active_transports}</div>
                              <p className="text-xs text-sky-600 mt-1">–≤ –ø—É—Ç–∏</p>
                            </CardContent>
                          </Card>
                        </div>
                      </div>
                    </>
                  ) : (
                    // –°—Ç–∞—Ä—ã–π –±–∞–∑–æ–≤—ã–π –¥–∞—à–±–æ—Ä–¥, –µ—Å–ª–∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                      <Card>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">–í—Å–µ–≥–æ –≥—Ä—É–∑–æ–≤</CardTitle>
                          <Package className="h-4 w-4 text-muted-foreground" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">{cargo.length}</div>
                        </CardContent>
                      </Card>
                      
                      <Card>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">–ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</CardTitle>
                          <Users className="h-4 w-4 text-muted-foreground" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">{users && Array.isArray(users) ? users.filter(u => u.is_active !== false).length : 0}</div>
                        </CardContent>
                      </Card>
                      
                      <Card>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">–°–∫–ª–∞–¥—ã</CardTitle>
                          <Building className="h-4 w-4 text-muted-foreground" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">{warehouses.length}</div>
                        </CardContent>
                      </Card>
                      
                      <Card>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">–ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</CardTitle>
                          <Bell className="h-4 w-4 text-muted-foreground" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">{notifications.filter(n => !n.is_read).length}</div>
                        </CardContent>
                      </Card>
                    </div>
                  )}
                </div>
              )}

              {/* –õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç */}
              {activeSection === 'personal-dashboard' && (
                <div className="space-y-6">
                  {/* –£–ª—É—á—à–µ–Ω–Ω—ã–π –∞–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π –¥–∞—à–±–æ—Ä–¥ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ —Å–∫–ª–∞–¥–∞ */}
                  {user?.role === 'warehouse_operator' && (
                    <div className="space-y-6">
                      {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ–± –æ–ø–µ—Ä–∞—Ç–æ—Ä–µ */}
                      <div className="flex justify-between items-center">
                        <div>
                          <h2 className="text-2xl font-bold">–ú–æ–π –¥–∞—à–±–æ—Ä–¥ —Å–∫–ª–∞–¥–∞</h2>
                          {operatorDashboardAnalytics && (
                            <p className="text-gray-600">
                              {operatorDashboardAnalytics.operator_info?.operator_name} ‚Ä¢ 
                              –ù–∞–∑–Ω–∞—á–µ–Ω–æ —Å–∫–ª–∞–¥–æ–≤: {operatorDashboardAnalytics.operator_info?.assigned_warehouses_count || 0}
                            </p>
                          )}
                        </div>
                        <Button 
                          onClick={fetchOperatorDashboardAnalytics}
                          disabled={operatorAnalyticsLoading}
                          variant="outline"
                        >
                          <RefreshCw className={`h-4 w-4 mr-2 ${operatorAnalyticsLoading ? 'animate-spin' : ''}`} />
                          {operatorAnalyticsLoading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–û–±–Ω–æ–≤–∏—Ç—å'}
                        </Button>
                      </div>

                      {operatorDashboardAnalytics ? (
                        <div className="space-y-6">
                          {/* –û–±—â–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ */}
                          <div>
                            <h3 className="text-lg font-semibold mb-4 text-gray-700">–û–±—â–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ –º–æ–∏–º —Å–∫–ª–∞–¥–∞–º</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                              <Card key="total-cargo-summary" className="bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200">
                                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                                  <CardTitle className="text-sm font-medium">–í—Å–µ–≥–æ –≥—Ä—É–∑–æ–≤</CardTitle>
                                  <Package className="h-4 w-4 text-blue-600" />
                                </CardHeader>
                                <CardContent>
                                  <div className="text-2xl font-bold text-blue-700">
                                    {operatorDashboardAnalytics.summary_stats?.total_cargo_in_my_warehouses || 0}
                                  </div>
                                  <p className="text-xs text-blue-600 mt-1">–Ω–∞ –º–æ–∏—Ö —Å–∫–ª–∞–¥–∞—Ö</p>
                                </CardContent>
                              </Card>
                              
                              <Card key="total-weight-summary" className="bg-gradient-to-br from-indigo-50 to-indigo-100 border-indigo-200">
                                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                                  <CardTitle className="text-sm font-medium">–û–±—â–∏–π –≤–µ—Å</CardTitle>
                                  <Package2 className="h-4 w-4 text-indigo-600" />
                                </CardHeader>
                                <CardContent>
                                  <div className="text-2xl font-bold text-indigo-700">
                                    {operatorDashboardAnalytics.summary_stats?.total_weight_kg?.toLocaleString() || '0'}
                                  </div>
                                  <p className="text-xs text-indigo-600 mt-1">–∫–≥</p>
                                </CardContent>
                              </Card>
                              
                              <Card key="total-value-summary" className="bg-gradient-to-br from-emerald-50 to-emerald-100 border-emerald-200">
                                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                                  <CardTitle className="text-sm font-medium">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</CardTitle>
                                  <DollarSign className="h-4 w-4 text-emerald-600" />
                                </CardHeader>
                                <CardContent>
                                  <div className="text-2xl font-bold text-emerald-700">
                                    {operatorDashboardAnalytics.summary_stats?.total_value_rub?.toLocaleString() || '0'}
                                  </div>
                                  <p className="text-xs text-emerald-600 mt-1">‚ÇΩ</p>
                                </CardContent>
                              </Card>
                              
                              <Card key="occupancy-summary" className="bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200">
                                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                                  <CardTitle className="text-sm font-medium">–ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å</CardTitle>
                                  <BarChart className="h-4 w-4 text-purple-600" />
                                </CardHeader>
                                <CardContent>
                                  <div className="text-2xl font-bold text-purple-700">
                                    {operatorDashboardAnalytics.summary_stats?.average_occupancy_rate || 0}%
                                  </div>
                                  <p className="text-xs text-purple-600 mt-1">
                                    {operatorDashboardAnalytics.summary_stats?.occupied_cells || 0} –∏–∑ {operatorDashboardAnalytics.summary_stats?.total_cells || 0} —è—á–µ–µ–∫
                                  </p>
                                </CardContent>
                              </Card>
                            </div>
                          </div>

                          {/* –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ –∫–∞–∂–¥–æ–º—É —Å–∫–ª–∞–¥—É */}
                          <div>
                            <h3 className="text-lg font-semibold mb-4 text-gray-700">–ú–æ–∏ —Å–∫–ª–∞–¥—ã - –¥–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                            <div className="grid gap-6">
                              {operatorDashboardAnalytics.warehouses_details?.map((warehouse, index) => (
                                <Card key={`warehouse-detail-${warehouse.warehouse_id}`} className="border-l-4 border-l-blue-500">
                                  <CardHeader>
                                    <CardTitle className="flex items-center justify-between">
                                      <div className="flex items-center">
                                        <Building className="mr-3 h-5 w-5 text-blue-600" />
                                        <div>
                                          <h4 className="text-lg font-semibold">{warehouse.warehouse_name}</h4>
                                          <p className="text-sm text-gray-600">{warehouse.warehouse_location}</p>
                                        </div>
                                      </div>
                                      <Badge variant="secondary">
                                        {warehouse.cargo_stats?.occupancy_rate || 0}% –∑–∞–ø–æ–ª–Ω–µ–Ω
                                      </Badge>
                                    </CardTitle>
                                  </CardHeader>
                                  <CardContent>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                      {/* –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∫–ª–∞–¥–∞ */}
                                      <div className="bg-slate-50 p-3 rounded-lg">
                                        <h5 className="font-semibold text-slate-700 mb-2">–°—Ç—Ä—É–∫—Ç—É—Ä–∞</h5>
                                        <div className="text-sm text-slate-600 space-y-1">
                                          <p>üì¶ –ë–ª–æ–∫–æ–≤: {warehouse.warehouse_structure?.blocks_count || 0}</p>
                                          <p>üìö –ü–æ–ª–æ–∫/–±–ª–æ–∫: {warehouse.warehouse_structure?.shelves_per_block || 0}</p>
                                          <p>üî≤ –Ø—á–µ–µ–∫/–ø–æ–ª–∫–∞: {warehouse.warehouse_structure?.cells_per_shelf || 0}</p>
                                          <p className="font-semibold">
                                            üéØ –í—Å–µ–≥–æ —è—á–µ–µ–∫: {(() => {
                                              const total = warehouse.warehouse_structure?.total_cells || 0;
                                              console.log(`üîß –í—Å–µ–≥–æ —è—á–µ–µ–∫ –¥–ª—è —Å–∫–ª–∞–¥–∞ ${warehouse.warehouse_name}:`, total);
                                              return total;
                                            })()}
                                          </p>
                                        </div>
                                      </div>

                                      {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—Ä—É–∑–æ–≤ */}
                                      <div className="bg-blue-50 p-3 rounded-lg">
                                        <h5 className="font-semibold text-blue-700 mb-2">–ì—Ä—É–∑—ã</h5>
                                        <div className="text-sm space-y-1">
                                          <p className="text-blue-900 font-bold text-lg">
                                            {(() => {
                                              const total = warehouse.cargo_stats?.total_cargo || 0;
                                              console.log(`üîß –í—Å–µ–≥–æ –≥—Ä—É–∑–æ–≤ –¥–ª—è —Å–∫–ª–∞–¥–∞ ${warehouse.warehouse_name}:`, total);
                                              return total;
                                            })()}
                                          </p>
                                          <p className="text-blue-600">üì¶ –í—Å–µ–≥–æ –≥—Ä—É–∑–æ–≤</p>
                                          <p className="text-blue-600">
                                            ‚öñÔ∏è {(() => {
                                              const weight = warehouse.cargo_stats?.total_weight_kg?.toLocaleString() || 0;
                                              console.log(`üîß –û–±—â–∏–π –≤–µ—Å –¥–ª—è —Å–∫–ª–∞–¥–∞ ${warehouse.warehouse_name}:`, warehouse.cargo_stats?.total_weight_kg);
                                              return weight;
                                            })()} –∫–≥
                                          </p>
                                          <p className="text-blue-600">
                                            üí∞ {(() => {
                                              const value = warehouse.cargo_stats?.total_value_rub?.toLocaleString() || 0;
                                              console.log(`üîß –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å –¥–ª—è —Å–∫–ª–∞–¥–∞ ${warehouse.warehouse_name}:`, warehouse.cargo_stats?.total_value_rub);
                                              return value;
                                            })()} ‚ÇΩ
                                          </p>
                                        </div>
                                      </div>

                                      {/* –ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å */}
                                      <div className="bg-green-50 p-3 rounded-lg">
                                        <h5 className="font-semibold text-green-700 mb-2">–ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å</h5>
                                        <div className="text-sm space-y-1">
                                          <p className="text-green-900 font-bold text-lg">
                                            {(() => {
                                              const rate = warehouse.cargo_stats?.occupancy_rate || 0;
                                              console.log(`üîß –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç–∏ –¥–ª—è —Å–∫–ª–∞–¥–∞ ${warehouse.warehouse_name}:`, rate);
                                              return rate;
                                            })()}%
                                          </p>
                                          <p className="text-green-600">
                                            üü¢ –ó–∞–Ω—è—Ç–æ: {(() => {
                                              const occupied = warehouse.cargo_stats?.occupied_cells || 0;
                                              console.log(`üîß –ó–∞–Ω—è—Ç–æ —è—á–µ–µ–∫ –¥–ª—è —Å–∫–ª–∞–¥–∞ ${warehouse.warehouse_name}:`, occupied);
                                              return occupied;
                                            })()}
                                          </p>
                                          <p className="text-green-600">
                                            ‚ö™ –°–≤–æ–±–æ–¥–Ω–æ: {(() => {
                                              const free = warehouse.cargo_stats?.free_cells || 0;
                                              console.log(`üîß –°–≤–æ–±–æ–¥–Ω–æ —è—á–µ–µ–∫ –¥–ª—è —Å–∫–ª–∞–¥–∞ ${warehouse.warehouse_name}:`, free);
                                              return free;
                                            })()}
                                          </p>
                                        </div>
                                      </div>

                                      {/* –ö–ª–∏–µ–Ω—Ç—ã */}
                                      <div className="bg-orange-50 p-3 rounded-lg">
                                        <h5 className="font-semibold text-orange-700 mb-2">–ö–ª–∏–µ–Ω—Ç—ã</h5>
                                        <div className="text-sm space-y-1">
                                          <p className="text-orange-600">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π: {warehouse.clients?.unique_senders || 0}</p>
                                          <p className="text-orange-600">üì• –ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π: {warehouse.clients?.unique_recipients || 0}</p>
                                          <div className="mt-2 pt-2 border-t border-orange-200">
                                            <p className="text-orange-600">üí≥ –û–ø–ª–∞—á–µ–Ω–æ: {warehouse.financial?.paid_cargo || 0}</p>
                                            <p className="text-orange-600">‚è≥ –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ: {warehouse.financial?.unpaid_cargo || 0}</p>
                                          </div>
                                        </div>
                                      </div>
                                    </div>

                                    {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è —Å–∫–ª–∞–¥–∞ */}
                                    <div className="mt-4 flex flex-wrap gap-2">
                                      <Button 
                                        size="sm" 
                                        variant="outline"
                                        onClick={() => setShowWarehouseScheme(warehouse.warehouse_id)}
                                      >
                                        <MapPin className="mr-2 h-4 w-4" />
                                        –°—Ö–µ–º–∞ —Å–∫–ª–∞–¥–∞
                                      </Button>
                                      <Button size="sm" variant="outline">
                                        <FileText className="mr-2 h-4 w-4" />
                                        –û—Ç—á–µ—Ç
                                      </Button>
                                      <Button size="sm" variant="outline">
                                        <Settings className="mr-2 h-4 w-4" />
                                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                                      </Button>
                                    </div>
                                  </CardContent>
                                </Card>
                              )) || (
                                <Card>
                                  <CardContent className="p-8 text-center">
                                    <Building className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                                    <p className="text-gray-500">–£ –≤–∞—Å –Ω–µ—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤</p>
                                  </CardContent>
                                </Card>
                              )}
                            </div>
                          </div>

                          {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫–ª–∏–µ–Ω—Ç–æ–≤ –∏ —Ñ–∏–Ω–∞–Ω—Å—ã –ø–æ –≤—Å–µ–º —Å–∫–ª–∞–¥–∞–º */}
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* –ö–ª–∏–µ–Ω—Ç—ã */}
                            <Card key="clients-summary">
                              <CardHeader>
                                <CardTitle className="flex items-center">
                                  <Users className="mr-2 h-5 w-5" />
                                  –ú–æ–∏ –∫–ª–∏–µ–Ω—Ç—ã
                                </CardTitle>
                              </CardHeader>
                              <CardContent>
                                <div className="space-y-3">
                                  <div className="flex justify-between items-center">
                                    <span className="text-sm text-gray-600">üì§ –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–π</span>
                                    <span className="font-semibold">{operatorDashboardAnalytics.clients_stats?.unique_senders || 0}</span>
                                  </div>
                                  <div className="flex justify-between items-center">
                                    <span className="text-sm text-gray-600">üì• –£–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π</span>
                                    <span className="font-semibold">{operatorDashboardAnalytics.clients_stats?.unique_recipients || 0}</span>
                                  </div>
                                </div>
                              </CardContent>
                            </Card>

                            {/* –§–∏–Ω–∞–Ω—Å—ã */}
                            <Card key="financial-summary">
                              <CardHeader>
                                <CardTitle className="flex items-center">
                                  <CreditCard className="mr-2 h-5 w-5" />
                                  –§–∏–Ω–∞–Ω—Å—ã
                                </CardTitle>
                              </CardHeader>
                              <CardContent>
                                <div className="space-y-3">
                                  <div className="flex justify-between items-center">
                                    <span className="text-sm text-gray-600">üí≥ –û–ø–ª–∞—á–µ–Ω–æ –≥—Ä—É–∑–æ–≤</span>
                                    <span className="font-semibold text-green-600">{operatorDashboardAnalytics.financial_stats?.paid_cargo || 0}</span>
                                  </div>
                                  <div className="flex justify-between items-center">
                                    <span className="text-sm text-gray-600">‚è≥ –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</span>
                                    <span className="font-semibold text-red-600">{operatorDashboardAnalytics.financial_stats?.unpaid_cargo || 0}</span>
                                  </div>
                                  <div className="flex justify-between items-center">
                                    <span className="text-sm text-gray-600">üí∏ –°—É–º–º–∞ –¥–æ–ª–≥–æ–≤</span>
                                    <span className="font-semibold text-red-600">{operatorDashboardAnalytics.financial_stats?.debt_amount?.toLocaleString() || 0} ‚ÇΩ</span>
                                  </div>
                                </div>
                              </CardContent>
                            </Card>
                          </div>

                          {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞—Ö –Ω–∞ —Å–∫–ª–∞–¥–∞—Ö */}
                          <Card key="operators-summary">
                            <CardHeader>
                              <CardTitle className="flex items-center">
                                <UserCheck className="mr-2 h-5 w-5" />
                                –û–ø–µ—Ä–∞—Ç–æ—Ä—ã –Ω–∞ –º–æ–∏—Ö —Å–∫–ª–∞–¥–∞—Ö
                              </CardTitle>
                            </CardHeader>
                            <CardContent>
                              <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                  <span className="text-sm text-gray-600">üë• –í—Å–µ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤</span>
                                  <span className="font-semibold">{operatorDashboardAnalytics.operator_info?.total_operators_on_my_warehouses || 0}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                  <span className="text-sm text-gray-600">üìã –û–±—â–µ–µ –∫–æ–ª-–≤–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–π</span>
                                  <span className="font-semibold">{operatorDashboardAnalytics.operator_info?.total_operators_assignments || 0}</span>
                                </div>
                              </div>
                            </CardContent>
                          </Card>

                          {/* –ì—Ä—É–∑—ã –ø–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è–º */}
                          {operatorDashboardAnalytics.cargo_by_destinations && Object.keys(operatorDashboardAnalytics.cargo_by_destinations).length > 0 && (
                            <Card key="cargo-destinations">
                              <CardHeader>
                                <CardTitle className="flex items-center">
                                  <MapPin className="mr-2 h-5 w-5" />
                                  –ì—Ä—É–∑—ã, –æ–∂–∏–¥–∞—é—â–∏–µ –æ—Ç–ø—Ä–∞–≤–∫–∏ –ø–æ –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º
                                </CardTitle>
                                <CardDescription>
                                  –î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑–±–∏–≤–∫–∞ –≥—Ä—É–∑–æ–≤ –ø–æ –ø—É–Ω–∫—Ç–∞–º –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
                                </CardDescription>
                              </CardHeader>
                              <CardContent>
                                <div className="space-y-4">
                                  {Object.entries(operatorDashboardAnalytics.cargo_by_destinations).map(([destination, data]) => (
                                    <div key={destination} className="border rounded-lg p-4">
                                      <div className="flex justify-between items-center mb-3">
                                        <h4 className="font-semibold text-lg">
                                          {destination === '–ú–æ—Å–∫–≤–∞' && 'üá∑üá∫ –ú–æ—Å–∫–≤–∞'}
                                          {destination === '–î—É—à–∞–Ω–±–µ' && 'üáπüáØ –î—É—à–∞–Ω–±–µ'}
                                          {destination === '–•—É–¥–∂–∞–Ω–¥' && 'üáπüáØ –•—É–¥–∂–∞–Ω–¥'}
                                          {destination === '–ö—É–ª–æ–±' && 'üáπüáØ –ö—É–ª–æ–±'}
                                          {destination === '–ö—É—Ä–≥–∞–Ω-–¢—é–±–µ' && 'üáπüáØ –ö—É—Ä–≥–∞–Ω-–¢—é–±–µ'}
                                          {!['–ú–æ—Å–∫–≤–∞', '–î—É—à–∞–Ω–±–µ', '–•—É–¥–∂–∞–Ω–¥', '–ö—É–ª–æ–±', '–ö—É—Ä–≥–∞–Ω-–¢—é–±–µ'].includes(destination) && `üìç ${destination}`}
                                        </h4>
                                      </div>
                                      <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                                        <div className="text-center">
                                          <div className="text-2xl font-bold text-blue-600">
                                            {data.cargo_count || 0}
                                          </div>
                                          <div className="text-sm text-gray-600">–≥—Ä—É–∑–æ–≤</div>
                                        </div>
                                        <div className="text-center">
                                          <div className="text-2xl font-bold text-indigo-600">
                                            {(data.total_weight || 0).toLocaleString()}
                                          </div>
                                          <div className="text-sm text-gray-600">–∫–≥</div>
                                        </div>
                                        <div className="text-center">
                                          <div className="text-2xl font-bold text-emerald-600">
                                            {(data.total_value || 0).toLocaleString()}
                                          </div>
                                          <div className="text-sm text-gray-600">‚ÇΩ</div>
                                        </div>
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </CardContent>
                            </Card>
                          )}
                        </div>
                      ) : (
                        <Card key="loading-analytics">
                          <CardContent className="p-6">
                            <div className="text-center py-8">
                              <RefreshCw className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500 mb-4">–ó–∞–≥—Ä—É–∂–∞–µ–º –¥–µ—Ç–∞–ª—å–Ω—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É –ø–æ –≤–∞—à–∏–º —Å–∫–ª–∞–¥–∞–º...</p>
                              <Button onClick={fetchOperatorDashboardAnalytics} variant="outline">
                                <RefreshCw className="mr-2 h-4 w-4" />
                                –ó–∞–≥—Ä—É–∑–∏—Ç—å –∞–Ω–∞–ª–∏—Ç–∏–∫—É
                              </Button>
                            </div>
                          </CardContent>
                        </Card>
                      )}
                    </div>
                  )}

                  {/* –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
                  <Card>
                    <CardHeader>
                      <CardTitle className="flex items-center">
                        <User className="mr-2 h-5 w-5" />
                        {user?.role === 'warehouse_operator' ? '–ü—Ä–æ—Ñ–∏–ª—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å–∫–ª–∞–¥–∞' : '–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç'}
                      </CardTitle>
                      <CardDescription>
                        {user?.role === 'warehouse_operator' ? 
                          '–í–∞—à–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã' : 
                          '–í–∞—à–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π'
                        }
                      </CardDescription>
                    </CardHeader>
                    <CardContent>
                      <div className="flex items-center justify-between mb-6">
                        <Button 
                          onClick={fetchPersonalDashboard}
                          disabled={dashboardLoading}
                        >
                          {dashboardLoading ? '–ó–∞–≥—Ä—É–∑–∫–∞...' : '–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ'}
                        </Button>
                        
                        {/* –ù–æ–≤—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∏ –∞–¥–º–∏–Ω–æ–≤ */}
                        {(user?.role === 'admin' || user?.role === 'warehouse_operator') && (
                          <div className="flex gap-2">
                            <Dialog>
                              <DialogTrigger asChild>
                                <Button variant="outline">
                                  <QrCode className="mr-2 h-4 w-4" />
                                  –®—Ç—Ä–∏—Ö–∫–æ–¥—ã
                                </Button>
                              </DialogTrigger>
                              <DialogContent className="max-w-2xl">
                                <DialogHeader>
                                  <DialogTitle>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤ –¥–ª—è –≥—Ä—É–∑–æ–≤</DialogTitle>
                                  <DialogDescription>
                                    –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ –≥—Ä—É–∑–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR-–∫–æ–¥–æ–≤
                                  </DialogDescription>
                                </DialogHeader>
                                <div className="space-y-4">
                                  <div>
                                    <Label htmlFor="cargo-numbers">–ù–æ–º–µ—Ä–∞ –≥—Ä—É–∑–æ–≤</Label>
                                    <Textarea
                                      id="cargo-numbers"
                                      placeholder="CRG-001, CRG-002, CRG-003..."
                                      className="min-h-20"
                                    />
                                  </div>
                                  <div className="flex gap-2">
                                    <Button className="flex-1">
                                      <QrCode className="mr-2 h-4 w-4" />
                                      –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥—ã
                                    </Button>
                                    <Button variant="outline" className="flex-1">
                                      <Printer className="mr-2 h-4 w-4" />
                                      –ü–µ—á–∞—Ç—å —à—Ç—Ä–∏—Ö–∫–æ–¥–æ–≤
                                    </Button>
                                  </div>
                                </div>
                              </DialogContent>
                            </Dialog>

                            <Dialog>
                              <DialogTrigger asChild>
                                <Button variant="outline">
                                  <FileText className="mr-2 h-4 w-4" />
                                  –ù–∞–∫–ª–∞–¥–Ω–∞—è
                                </Button>
                              </DialogTrigger>
                              <DialogContent className="max-w-4xl">
                                <DialogHeader>
                                  <DialogTitle>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è –Ω–∞–∫–ª–∞–¥–Ω–æ–π</DialogTitle>
                                  <DialogDescription>
                                    –°–æ–∑–¥–∞–Ω–∏–µ –Ω–∞–∫–ª–∞–¥–Ω–æ–π –¥–ª—è –≥—Ä—É–ø–ø—ã –≥—Ä—É–∑–æ–≤
                                  </DialogDescription>
                                </DialogHeader>
                                <div className="space-y-4">
                                  <div>
                                    <Label htmlFor="invoice-cargo-numbers">–ù–æ–º–µ—Ä–∞ –≥—Ä—É–∑–æ–≤ –¥–ª—è –Ω–∞–∫–ª–∞–¥–Ω–æ–π</Label>
                                    <Textarea
                                      id="invoice-cargo-numbers"
                                      placeholder="CRG-001, CRG-002, CRG-003..."
                                      className="min-h-20"
                                    />
                                  </div>
                                  <div className="flex gap-2">
                                    <Button className="flex-1">
                                      <FileText className="mr-2 h-4 w-4" />
                                      –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω—É—é
                                    </Button>
                                    <Button variant="outline" className="flex-1">
                                      <Printer className="mr-2 h-4 w-4" />
                                      –ü–µ—á–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω–æ–π
                                    </Button>
                                  </div>
                                </div>
                              </DialogContent>
                            </Dialog>
                          </div>
                        )}
                      </div>
                      
                      {personalDashboardData && (
                        <div className="space-y-6">
                          {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ */}
                          <div className="bg-gray-50 p-6 rounded-lg">
                            <h3 className="text-lg font-semibold mb-4">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h3>
                            <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                              <div>
                                <label className="text-sm font-medium text-gray-500">–ù–æ–º–µ—Ä –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                                <p className="text-lg">{personalDashboardData.user_info.user_number}</p>
                              </div>
                              <div>
                                <label className="text-sm font-medium text-gray-500">–§–ò–û</label>
                                <p className="text-lg">{personalDashboardData.user_info.full_name}</p>
                              </div>
                              <div>
                                <label className="text-sm font-medium text-gray-500">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                <p className="text-lg">{personalDashboardData.user_info.phone}</p>
                              </div>
                              <div>
                                <label className="text-sm font-medium text-gray-500">–†–æ–ª—å</label>
                                <Badge variant="outline">{getRoleLabel(personalDashboardData.user_info.role)}</Badge>
                              </div>
                              <div>
                                <label className="text-sm font-medium text-gray-500">–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</label>
                                <p className="text-lg">{new Date(personalDashboardData.user_info.created_at).toLocaleDateString('ru-RU')}</p>
                              </div>
                            </div>
                          </div>

                          {/* –ó–∞—è–≤–∫–∏ –Ω–∞ –≥—Ä—É–∑—ã */}
                          <div>
                            <h3 className="text-lg font-semibold mb-4 flex items-center">
                              <FileText className="mr-2 h-5 w-5" />
                              –ú–æ–∏ –∑–∞—è–≤–∫–∏ –Ω–∞ –≥—Ä—É–∑—ã ({personalDashboardData.cargo_requests.length})
                            </h3>
                            {personalDashboardData.cargo_requests.length > 0 ? (
                              <div className="space-y-3">
                                {personalDashboardData.cargo_requests.slice(0, 10).map((request, index) => (
                                  <div key={`request-${request.id || index}-${request.cargo_name || index}`} className="bg-white border rounded-lg p-4">
                                    <div className="flex justify-between items-start">
                                      <div>
                                        <h4 className="font-medium">{request.cargo_name}</h4>
                                        <p className="text-sm text-gray-600">
                                          –í–µ—Å: {request.weight} –∫–≥ | –°—Ç–æ–∏–º–æ—Å—Ç—å: {request.declared_value} —Ä—É–±
                                        </p>
                                        <p className="text-sm text-gray-600">
                                          –ü–æ–ª—É—á–∞—Ç–µ–ª—å: {request.recipient_name} ({request.recipient_phone})
                                        </p>
                                      </div>
                                      <div className="text-right">
                                        <Badge variant="secondary">{request.status}</Badge>
                                        <p className="text-xs text-gray-500 mt-1">
                                          {new Date(request.created_at).toLocaleDateString('ru-RU')}
                                        </p>
                                      </div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <p className="text-gray-500">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –∑–∞—è–≤–æ–∫ –Ω–∞ –≥—Ä—É–∑—ã</p>
                            )}
                          </div>

                          {/* –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã */}
                          <div>
                            <h3 className="text-lg font-semibold mb-4 flex items-center">
                              <Package className="mr-2 h-5 w-5" />
                              –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã ({personalDashboardData.sent_cargo.length})
                            </h3>
                            {personalDashboardData.sent_cargo.length > 0 ? (
                              <div className="space-y-3">
                                {personalDashboardData.sent_cargo.slice(0, 10).map((cargo, index) => (
                                  <div key={`sent-cargo-${cargo.id || index}-${cargo.cargo_number || index}`} className="bg-white border rounded-lg p-4">
                                    <div className="flex justify-between items-start">
                                      <div>
                                        <h4 className="font-medium">
                                          {cargo.cargo_number} - {cargo.cargo_name}
                                        </h4>
                                        <p className="text-sm text-gray-600">
                                          –í–µ—Å: {cargo.weight} –∫–≥ | –°—Ç–æ–∏–º–æ—Å—Ç—å: {cargo.declared_value} —Ä—É–±
                                        </p>
                                        <p className="text-sm text-gray-600">
                                          –ü–æ–ª—É—á–∞—Ç–µ–ª—å: {cargo.recipient_name} ({cargo.recipient_phone})
                                        </p>
                                        {cargo.created_by_operator && (
                                          <p className="text-sm text-gray-500">
                                            –ü—Ä–∏–Ω—è—Ç–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º: {cargo.created_by_operator}
                                          </p>
                                        )}
                                      </div>
                                      <div className="text-right">
                                        <div className="space-y-1">
                                          <Badge variant="default">{cargo.status}</Badge>
                                          {cargo.payment_status && (
                                            <Badge variant="secondary" className="block">
                                              {cargo.payment_status}
                                            </Badge>
                                          )}
                                          {cargo.processing_status && (
                                            <Badge variant="outline" className="block">
                                              {cargo.processing_status}
                                            </Badge>
                                          )}
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <p className="text-gray-500">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤</p>
                            )}
                          </div>

                          {/* –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã */}
                          <div>
                            <h3 className="text-lg font-semibold mb-4 flex items-center">
                              <Truck className="mr-2 h-5 w-5" />
                              –ü–æ–ª—É—á–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã ({personalDashboardData.received_cargo.length})
                            </h3>
                            {personalDashboardData.received_cargo.length > 0 ? (
                              <div className="space-y-3">
                                {personalDashboardData.received_cargo.slice(0, 10).map((cargo, index) => (
                                  <div key={`received-cargo-${cargo.id || index}-${cargo.cargo_number || index}`} className="bg-white border rounded-lg p-4">
                                    <div className="flex justify-between items-start">
                                      <div>
                                        <h4 className="font-medium">
                                          {cargo.cargo_number} - {cargo.cargo_name}
                                        </h4>
                                        <p className="text-sm text-gray-600">
                                          –í–µ—Å: {cargo.weight} –∫–≥ | –°—Ç–æ–∏–º–æ—Å—Ç—å: {cargo.declared_value} —Ä—É–±
                                        </p>
                                        <p className="text-sm text-gray-600">
                                          –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: {cargo.sender_name} ({cargo.sender_phone})
                                        </p>
                                        {cargo.created_by_operator && (
                                          <p className="text-sm text-gray-500">
                                            –ü—Ä–∏–Ω—è—Ç–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º: {cargo.created_by_operator}
                                          </p>
                                        )}
                                      </div>
                                      <div className="text-right">
                                        <div className="space-y-1">
                                          <Badge variant="default">{cargo.status}</Badge>
                                          {cargo.payment_status && (
                                            <Badge variant="secondary" className="block">
                                              {cargo.payment_status}
                                            </Badge>
                                          )}
                                          {cargo.processing_status && (
                                            <Badge variant="outline" className="block">
                                              {cargo.processing_status}
                                            </Badge>
                                          )}
                                        </div>
                                      </div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <p className="text-gray-500">–£ –≤–∞—Å –ø–æ–∫–∞ –Ω–µ—Ç –ø–æ–ª—É—á–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤</p>
                            )}
                          </div>
                        </div>
                      )}
                      
                      {!personalDashboardData && !dashboardLoading && (
                        <div className="text-center py-8">
                          <User className="mx-auto h-12 w-12 text-gray-400" />
                          <h3 className="mt-4 text-sm font-medium text-gray-900">–î–∞–Ω–Ω—ã–µ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã</h3>
                          <p className="mt-1 text-sm text-gray-500">
                            –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É "–û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                          </p>
                        </div>
                      )}
                    </CardContent>
                  </Card>
                </div>
              )}

              {/* –ú–æ–±–∏–ª—å–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ */}
              {activeSection === 'operations' && (
                <div className="space-y-6">
                  {/* –ü–æ–∏—Å–∫ –≥—Ä—É–∑–∞ */}
                  {activeTab === 'operations-search' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Search className="mr-2 h-5 w-5" />
                          –ü–æ–∏—Å–∫ –≥—Ä—É–∑–∞ –ø–æ QR –∫–æ–¥—É
                        </CardTitle>
                        <CardDescription>–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –≥—Ä—É–∑–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {/* QR —Å–∫–∞–Ω–µ—Ä –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä–æ–º */}
                          <div className="relative">
                            <div 
                              id="qr-reader-placement-search" 
                              className="w-full bg-black rounded-lg"
                              style={{
                                width: '300px',
                                height: '300px',
                                maxWidth: '300px',
                                maxHeight: '300px',
                                minWidth: '300px',
                                minHeight: '300px',
                                margin: '0 auto'
                              }}
                            />
                            
                            {/* –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è –∫–æ–≥–¥–∞ –∫–∞–º–µ—Ä–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞ */}
                            {!searchScannerActive && (
                              <div 
                                className="absolute inset-0 bg-black rounded-lg camera-placeholder"
                                style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  color: '#a0aec0',
                                  fontSize: '14px',
                                  fontWeight: '500'
                                }}
                              >
                                üì∑ –ö–∞–º–µ—Ä–∞ –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–Ω–∞ –∑–¥–µ—Å—å
                              </div>
                            )}
                          </div>

                          {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –≤–Ω–∏–∑—É */}
                          <div className="text-center">
                            <Button 
                              onClick={() => startCargoSearch()}
                              className="w-full bg-blue-600 hover:bg-blue-700 text-white"
                              size="lg"
                              disabled={searchScannerActive}
                            >
                              <Camera className="mr-2 h-5 w-5" />
                              {searchScannerActive ? '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ...' : '–ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞'}
                            </Button>
                          </div>

                          {/* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã */}
                          {searchScannerActive && availableCameras.length > 1 && (
                            <div className="text-center">
                              <Button 
                                onClick={() => switchCamera()}
                                variant="outline"
                                size="sm"
                              >
                                <RefreshCw className="mr-2 h-4 w-4" />
                                –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É ({availableCameras.length > currentCameraIndex ? 
                                  (availableCameras[currentCameraIndex].label?.includes('back') || 
                                   availableCameras[currentCameraIndex].label?.includes('rear') ||
                                   availableCameras[currentCameraIndex].label?.includes('environment') ? '–∑–∞–¥–Ω—è—è' : '–ø–µ—Ä–µ–¥–Ω—è—è') 
                                  : '–Ω–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'})
                              </Button>
                            </div>
                          )}

                          {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */}
                          {searchScannerActive && (
                            <div className="text-center mt-3">
                              <Button 
                                onClick={stopMobileScanning}
                                variant="destructive"
                                size="sm"
                              >
                                <X className="mr-2 h-4 w-4" />
                                –ó–∞–∫—Ä—ã—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                              </Button>
                            </div>
                          )}

                          {/* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –ø–æ–∏—Å–∫–∞ */}
                          {searchResult && (
                            <Card className="mt-4">
                              <CardHeader>
                                <CardTitle className="text-lg text-green-600">
                                  –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ
                                </CardTitle>
                              </CardHeader>
                              <CardContent className="space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                  <div>
                                    <Label className="font-semibold">–ù–æ–º–µ—Ä –≥—Ä—É–∑–∞</Label>
                                    <p>{searchResult.cargo_number}</p>
                                  </div>
                                  <div>
                                    <Label className="font-semibold">–°—Ç–∞—Ç—É—Å</Label>
                                    <Badge className={
                                      searchResult.status === 'delivered' ? 'bg-green-100 text-green-800' :
                                      searchResult.status === 'in_transit' ? 'bg-blue-100 text-blue-800' :
                                      'bg-yellow-100 text-yellow-800'
                                    }>
                                      {searchResult.status === 'delivered' ? '–î–æ—Å—Ç–∞–≤–ª–µ–Ω' :
                                       searchResult.status === 'in_transit' ? '–í –ø—É—Ç–∏' :
                                       '–ü—Ä–∏–Ω—è—Ç'}
                                    </Badge>
                                  </div>
                                  <div>
                                    <Label className="font-semibold">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</Label>
                                    <p>{searchResult.sender_full_name}</p>
                                    <p className="text-sm text-gray-600">{searchResult.sender_phone}</p>
                                  </div>
                                  <div>
                                    <Label className="font-semibold">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</Label>
                                    <p>{searchResult.recipient_full_name}</p>
                                    <p className="text-sm text-gray-600">{searchResult.recipient_phone}</p>
                                  </div>
                                  <div>
                                    <Label className="font-semibold">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã</Label>
                                    <Badge className={
                                      searchResult.payment_status === 'paid' ? 'bg-green-100 text-green-800' :
                                      'bg-red-100 text-red-800'
                                    }>
                                      {searchResult.payment_status === 'paid' ? '–û–ø–ª–∞—á–µ–Ω–æ' : '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ'}
                                    </Badge>
                                  </div>
                                  <div>
                                    <Label className="font-semibold">–ú–µ—Å—Ç–æ–Ω–∞—Ö–æ–∂–¥–µ–Ω–∏–µ</Label>
                                    <p>{searchResult.current_location || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                                  </div>
                                </div>

                                {/* –ò—Å—Ç–æ—Ä–∏—è –≥—Ä—É–∑–∞ */}
                                {searchResult.history && searchResult.history.length > 0 && (
                                  <div className="mt-4">
                                    <Label className="font-semibold">–ò—Å—Ç–æ—Ä–∏—è –≥—Ä—É–∑–∞</Label>
                                    <div className="mt-2 space-y-2">
                                      {searchResult.history.map((item, index) => (
                                        <div key={index} className="flex items-center text-sm bg-gray-50 p-2 rounded">
                                          <Clock className="mr-2 h-4 w-4 text-gray-500" />
                                          <span className="text-gray-600">{item.date}</span>
                                          <span className="ml-2">{item.action}</span>
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                )}
                              </CardContent>
                            </Card>
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤ */}
                  {activeTab === 'operations-qr-generate' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <QrCode className="mr-2 h-5 w-5" />
                          –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤
                        </CardTitle>
                        <CardDescription>–°–æ–∑–¥–∞–Ω–∏–µ QR –∫–æ–¥–æ–≤ –¥–ª—è –≥—Ä—É–∑–æ–≤ –∏ —è—á–µ–µ–∫</CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          {/* –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞ –¥–ª—è –≥—Ä—É–∑–∞ */}
                          <div className="space-y-4">
                            <h3 className="font-semibold">QR –∫–æ–¥ –¥–ª—è –≥—Ä—É–∑–∞</h3>
                            <div>
                              <Label htmlFor="cargo-number-qr">–ù–æ–º–µ—Ä –≥—Ä—É–∑–∞</Label>
                              <Input
                                id="cargo-number-qr"
                                placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≥—Ä—É–∑–∞"
                                value={qrCargoNumber}
                                onChange={(e) => setQrCargoNumber(e.target.value)}
                              />
                            </div>
                            <Button 
                              onClick={() => generateCargoQR()}
                              className="w-full bg-green-600 hover:bg-green-700"
                              disabled={!qrCargoNumber.trim()}
                            >
                              <QrCode className="mr-2 h-4 w-4" />
                              –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥ –≥—Ä—É–∑–∞
                            </Button>
                          </div>

                          {/* –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞ –¥–ª—è —è—á–µ–π–∫–∏ */}
                          <div className="space-y-4">
                            <h3 className="font-semibold">QR –∫–æ–¥ –¥–ª—è —è—á–µ–π–∫–∏</h3>
                            <div>
                              <Label htmlFor="cell-code-qr">–ö–æ–¥ —è—á–µ–π–∫–∏</Label>
                              <Input
                                id="cell-code-qr"
                                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ë1-–ü1-–Ø1"
                                value={qrCellCode.code || ''}
                                onChange={(e) => setQrCellCode({...qrCellCode, code: e.target.value})}
                              />
                            </div>
                            <Button 
                              onClick={() => generateCellQR()}
                              className="w-full bg-purple-600 hover:bg-purple-700"
                              disabled={!qrCellCode.code?.trim()}
                            >
                              <QrCode className="mr-2 h-4 w-4" />
                              –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥ —è—á–µ–π–∫–∏
                            </Button>
                          </div>
                        </div>

                        {/* –ü–æ–∫–∞–∑ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö QR –∫–æ–¥–æ–≤ */}
                        {(generatedCargoQR || generatedCellQR) && (
                          <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            {generatedCargoQR && (
                              <div className="text-center space-y-2">
                                <h4 className="font-semibold">QR –∫–æ–¥ –≥—Ä—É–∑–∞</h4>
                                <div className="bg-white p-4 rounded border inline-block">
                                  <img src={generatedCargoQR} alt="QR –∫–æ–¥ –≥—Ä—É–∑–∞" className="w-48 h-48" />
                                </div>
                                <Button 
                                  onClick={() => printQR(generatedCargoQR, `–ì—Ä—É–∑: ${qrCargoNumber}`)}
                                  variant="outline"
                                  size="sm"
                                >
                                  <Printer className="mr-2 h-4 w-4" />
                                  –ü–µ—á–∞—Ç—å
                                </Button>
                              </div>
                            )}

                            {generatedCellQR && (
                              <div className="text-center space-y-2">
                                <h4 className="font-semibold">QR –∫–æ–¥ —è—á–µ–π–∫–∏</h4>
                                <div className="bg-white p-4 rounded border inline-block">
                                  <img src={generatedCellQR} alt="QR –∫–æ–¥ —è—á–µ–π–∫–∏" className="w-48 h-48" />
                                </div>
                                <Button 
                                  onClick={() => printQR(generatedCellQR, `–Ø—á–µ–π–∫–∞: ${qrCellCode}`)}
                                  variant="outline" 
                                  size="sm"
                                >
                                  <Printer className="mr-2 h-4 w-4" />
                                  –ü–µ—á–∞—Ç—å
                                </Button>
                              </div>
                            )}
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  )}

                  {/* –†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞ */}
                  {/* –ù–û–í–û–ï: –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞ —Å–æ —Å–∫–∞–Ω–µ—Ä–æ–º */}
                  {activeTab === 'operations-placement' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Target className="mr-2 h-5 w-5" />
                          –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞
                        </CardTitle>
                        <CardDescription>
                          –†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞ —Å QR —Å–∫–∞–Ω–µ—Ä–æ–º, –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –∫–∞—á–µ—Å—Ç–≤–∞
                        </CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-6">
                        
                        {/* –ü–∞–Ω–µ–ª—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–µ—Å—Å–∏–µ–π */}
                        <div className="bg-gradient-to-r from-blue-50 to-indigo-50 p-4 rounded-lg border border-blue-200">
                          <div className="flex items-center justify-between mb-4">
                            <div>
                              <h3 className="font-semibold text-blue-800">–°–µ—Å—Å–∏—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</h3>
                              {placementSessionId && (
                                <p className="text-sm text-blue-600">ID: {placementSessionId}</p>
                              )}
                            </div>
                            
                            {!scannerPlacementMode ? (
                              <Button
                                onClick={initializePlacementSession}
                                className="bg-green-600 hover:bg-green-700 text-white"
                                size="lg"
                              >
                                <RefreshCw className="mr-2 h-4 w-4" />
                                –ù–∞—á–∞—Ç—å —Å–µ—Å—Å–∏—é
                              </Button>
                            ) : (
                              <Button
                                onClick={finalizePlacementSession}
                                variant="outline"
                                className="border-red-300 text-red-600 hover:bg-red-50"
                              >
                                <X className="mr-2 h-4 w-4" />
                                –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–µ—Å—Å–∏—é
                              </Button>
                            )}
                          </div>
                          
                          {/* –£–õ–£–ß–®–ï–ù–ò–ï: –û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è */}
                          <div className="bg-gradient-to-r from-green-50 to-emerald-50 p-4 rounded-lg border border-green-200 mb-4">
                            <div className="flex items-center justify-between">
                              <div>
                                <h3 className="font-semibold text-green-800">–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</h3>
                                <p className="text-sm text-green-600">{placementProgress.progress_text}</p>
                              </div>
                              <div className="text-right">
                                <div className="text-2xl font-bold text-green-600">
                                  {placementProgress.progress_percentage.toFixed(1)}%
                                </div>
                                <div className="text-xs text-green-700">–≤—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
                              </div>
                            </div>
                            
                            {/* –ü—Ä–æ–≥—Ä–µ—Å—Å-–±–∞—Ä */}
                            <div className="mt-3">
                              <div className="w-full bg-green-200 rounded-full h-3">
                                <div 
                                  className="bg-green-600 h-3 rounded-full transition-all duration-300"
                                  style={{ width: `${placementProgress.progress_percentage}%` }}
                                ></div>
                              </div>
                              <div className="flex justify-between text-xs text-green-700 mt-1">
                                <span>–û–∂–∏–¥–∞—é—Ç: {placementProgress.pending_units}</span>
                                <span>–†–∞–∑–º–µ—â–µ–Ω–æ: {placementProgress.placed_units}</span>
                              </div>
                            </div>
                          </div>
                          
                          {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ—Å—Å–∏–∏ */}
                          {sessionStats && (
                            <div className="grid grid-cols-3 gap-4 text-center">
                              <div className="bg-white p-3 rounded-lg">
                                <div className="text-2xl font-bold text-green-600">{sessionStats.total_placements || 0}</div>
                                <div className="text-xs text-gray-600">–†–∞–∑–º–µ—â–µ–Ω–æ</div>
                              </div>
                              <div className="bg-white p-3 rounded-lg">
                                <div className="text-2xl font-bold text-blue-600">{sessionStats.sessions_count || 0}</div>
                                <div className="text-xs text-gray-600">–°–µ—Å—Å–∏–π</div>
                              </div>
                              <div className="bg-white p-3 rounded-lg">
                                <div className="text-lg font-bold text-purple-600">{sessionStats.operator_name || 'N/A'}</div>
                                <div className="text-xs text-gray-600">–û–ø–µ—Ä–∞—Ç–æ—Ä</div>
                              </div>
                            </div>
                          )}
                        </div>

                        {/* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–∫–∞–Ω–µ—Ä–∞ */}
                        {scannerPlacementMode && (
                          <div className="space-y-6">
                            
                            {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —à–∞–≥–æ–≤ */}
                            <div className="flex items-center justify-center space-x-4 mb-6">
                              <div className={`flex items-center ${placementStep === 'scan-cargo' ? 'text-blue-600' : placementStep === 'scan-cell' ? 'text-gray-400' : 'text-green-600'}`}>
                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${
                                  placementStep === 'scan-cargo' ? 'bg-blue-600 text-white' : 
                                  placementStep === 'scan-cell' || placementStep === 'idle' ? 'bg-green-100 text-green-600' : 'bg-gray-200'
                                }`}>
                                  1
                                </div>
                                <span className="ml-2 font-medium">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –≥—Ä—É–∑</span>
                              </div>
                              
                              <div className="w-8 h-0.5 bg-gray-300"></div>
                              
                              <div className={`flex items-center ${placementStep === 'scan-cell' ? 'text-blue-600' : placementStep === 'idle' ? 'text-green-600' : 'text-gray-400'}`}>
                                <div className={`w-10 h-10 rounded-full flex items-center justify-center font-bold ${
                                  placementStep === 'scan-cell' ? 'bg-blue-600 text-white' : 
                                  placementStep === 'idle' ? 'bg-green-100 text-green-600' : 'bg-gray-200'
                                }`}>
                                  2
                                </div>
                                <span className="ml-2 font-medium">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å —è—á–µ–π–∫—É</span>
                              </div>
                            </div>

                            {/* –ü–æ–ª—è –¥–ª—è QR —Å–∫–∞–Ω–µ—Ä–∞ */}
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                              
                              {/* –ü–æ–ª–µ –¥–ª—è QR –≥—Ä—É–∑–∞ */}
                              <div className={`p-4 rounded-lg border-2 ${
                                placementStep === 'scan-cargo' ? 'border-blue-400 bg-blue-50' : 'border-gray-200 bg-gray-50'
                              }`}>
                                <label className="block text-sm font-medium mb-2">
                                  üì¶ QR –∫–æ–¥ –≥—Ä—É–∑–∞
                                </label>
                                <Input
                                  id="cargo-qr-input"
                                  type="text"
                                  placeholder="–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –≥—Ä—É–∑–∞..."
                                  value={currentCargoQR}
                                  onChange={(e) => setCurrentCargoQR(e.target.value)}
                                  onKeyPress={async (e) => {
                                    if (e.key === 'Enter' || e.key === 'Tab') {
                                      e.preventDefault();
                                      if (e.target.value.trim()) {
                                        await handleNewCargoQRScan(e.target.value.trim());
                                      }
                                    }
                                  }}
                                  className={`text-center font-mono ${
                                    placementStep === 'scan-cargo' ? 'border-blue-400 focus:border-blue-600' : ''
                                  }`}
                                  disabled={placementStep !== 'scan-cargo' || isPlacementProcessing}
                                  autoFocus={placementStep === 'scan-cargo'}
                                />
                                
                                {verifiedCargo && (
                                  <div className="mt-2 p-2 bg-green-100 rounded text-sm">
                                    <div className="font-medium text-green-800">‚úÖ {verifiedCargo.cargo_number}</div>
                                    <div className="text-green-600">{verifiedCargo.sender_name}</div>
                                  </div>
                                )}
                              </div>

                              {/* –ü–æ–ª–µ –¥–ª—è QR —è—á–µ–π–∫–∏ */}
                              <div className={`p-4 rounded-lg border-2 ${
                                placementStep === 'scan-cell' ? 'border-blue-400 bg-blue-50' : 'border-gray-200 bg-gray-50'
                              }`}>
                                <label className="block text-sm font-medium mb-2">
                                  üè† QR –∫–æ–¥ —è—á–µ–π–∫–∏
                                </label>
                                <Input
                                  id="cell-qr-input"
                                  type="text"
                                  placeholder="–°–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ —è—á–µ–π–∫–∏..."
                                  value={currentCellQR}
                                  onChange={(e) => setCurrentCellQR(e.target.value)}
                                  onKeyPress={async (e) => {
                                    if (e.key === 'Enter' || e.key === 'Tab') {
                                      e.preventDefault();
                                      if (e.target.value.trim()) {
                                        await handleNewCellQRScan(e.target.value.trim());
                                      }
                                    }
                                  }}
                                  className={`text-center font-mono ${
                                    placementStep === 'scan-cell' ? 'border-blue-400 focus:border-blue-600' : ''
                                  }`}
                                  disabled={placementStep !== 'scan-cell' || isPlacementProcessing}
                                />
                                
                                {verifiedCell && (
                                  <div className="mt-2 p-2 bg-green-100 rounded text-sm">
                                    <div className="font-medium text-green-800">‚úÖ {verifiedCell.cell_address}</div>
                                    <div className="text-green-600">
                                      {verifiedCell.current_cargo_count} –≥—Ä—É–∑–æ–≤ –≤ —è—á–µ–π–∫–µ
                                    </div>
                                  </div>
                                )}
                              </div>
                            </div>

                            {/* –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ü–µ—Å—Å–∞ */}
                            {isPlacementProcessing && (
                              <div className="text-center py-4">
                                <div className="inline-flex items-center">
                                  <RefreshCw className="mr-2 h-4 w-4 animate-spin" />
                                  –û–±—Ä–∞–±–æ—Ç–∫–∞...
                                </div>
                              </div>
                            )}

                          </div>
                        )}

                        {/* –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è */}
                        {scannerPlacementMode && placementHistory.length > 0 && (
                          <div className="bg-gray-50 p-4 rounded-lg">
                            <div className="flex items-center justify-between mb-4">
                              <h3 className="font-semibold text-gray-800">üìä –ò—Å—Ç–æ—Ä–∏—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</h3>
                              
                              <div className="flex items-center space-x-2">
                                <Button
                                  onClick={() => fetchPlacementHistory(placementSessionId)}
                                  size="sm"
                                  variant="outline"
                                >
                                  <RefreshCw className="mr-1 h-3 w-3" />
                                  –û–±–Ω–æ–≤–∏—Ç—å
                                </Button>
                                
                                {placementHistory.length > 0 && (
                                  <Button
                                    onClick={() => undoLastPlacement(placementSessionId)}
                                    size="sm"
                                    variant="outline"
                                    className="border-red-300 text-red-600 hover:bg-red-50"
                                  >
                                    <RotateCw className="mr-1 h-3 w-3" />
                                    –û—Ç–º–µ–Ω–∏—Ç—å –ø–æ—Å–ª–µ–¥–Ω–µ–µ
                                  </Button>
                                )}
                              </div>
                            </div>
                            
                            <div className="space-y-2 max-h-60 overflow-y-auto">
                              {placementHistory.slice(0, 10).map((record, index) => (
                                <div key={record.id || index} className="flex items-center justify-between p-2 bg-white rounded border">
                                  <div className="flex-1">
                                    <div className="font-medium text-sm">
                                      {record.cargo_number} ‚Üí {record.cell_address}
                                    </div>
                                    <div className="text-xs text-gray-500">
                                      {new Date(record.placement_timestamp).toLocaleTimeString('ru-RU')}
                                    </div>
                                  </div>
                                  <div className="text-xs text-gray-400">
                                    #{index + 1}
                                  </div>
                                </div>
                              ))}
                            </div>
                          </div>
                        )}

                      </CardContent>
                    </Card>
                  )}

                  {/* –ü—Ä–∏—ë–º –≥—Ä—É–∑–∞ */}
                  {activeTab === 'operations-receive' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Package className="mr-2 h-5 w-5" />
                          –ü—Ä–∏—ë–º –≥—Ä—É–∑–∞ –Ω–∞ –Ω–æ–≤—ã–π —Å–∫–ª–∞–¥
                        </CardTitle>
                        <CardDescription>–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ –∏ —è—á–µ–π–∫–∏ –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è</CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-4">
                        {receiveStep === 'start' && (
                          <div className="space-y-4">
                            {/* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∫–∞–º–µ—Ä—ã —Å–Ω–∞—á–∞–ª–∞ */}
                            <div 
                              id="qr-reader-placement-edit" 
                              className="w-full bg-black rounded-lg camera-placeholder"
                              style={{
                                aspectRatio: '1',
                                maxWidth: '400px',
                                margin: '0 auto',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                color: '#a0aec0',
                                fontSize: '14px',
                                fontWeight: '500'
                              }}
                            >
                              üì∑ –ö–∞–º–µ—Ä–∞ –±—É–¥–µ—Ç –∞–∫—Ç–∏–≤–Ω–∞ –∑–¥–µ—Å—å
                            </div>

                            {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–ø—É—Å–∫–∞ –ø—Ä–∏—ë–º–∞ –≤–Ω–∏–∑—É */}
                            <div className="text-center">
                              <Button 
                                onClick={() => startMobileReceive()}
                                className="w-full bg-orange-600 hover:bg-orange-700 text-white"
                                size="lg"
                              >
                                <Camera className="mr-2 h-5 w-5" />
                                –ù–∞—á–∞—Ç—å –ø—Ä–∏—ë–º –≥—Ä—É–∑–∞
                              </Button>
                            </div>
                          </div>
                        )}

                        {receiveStep === 'scan-cargo' && (
                          <div className="space-y-4">
                            <div className="text-center">
                              <h3 className="font-semibold text-orange-600">–®–∞–≥ 1: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞</h3>
                              <p className="text-sm text-gray-600">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR –∫–æ–¥ –≥—Ä—É–∑–∞ –¥–ª—è –ø—Ä–∏—ë–º–∞</p>
                            </div>
                            
                            <div 
                              id="qr-reader-placement-receive" 
                              className="w-full bg-black rounded-lg"
                              style={{
                                aspectRatio: '1',
                                maxWidth: '400px',
                                margin: '0 auto'
                              }}
                            />

                            {/* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã –¥–ª—è –ø—Ä–∏—ë–º–∞ –≥—Ä—É–∑–∞ */}
                            {availableCameras.length > 1 && (
                              <div className="text-center mt-2">
                                <Button 
                                  onClick={() => switchCamera()}
                                  variant="outline"
                                  size="sm"
                                >
                                  <RefreshCw className="mr-2 h-4 w-4" />
                                  –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
                                </Button>
                              </div>
                            )}

                            {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –ø—Ä–∏—ë–º–∞ –≥—Ä—É–∑–∞ */}
                            {scannerActive && (
                              <div className="text-center mt-3">
                                <Button 
                                  onClick={stopMobileScanning}
                                  variant="destructive"
                                  size="sm"
                                >
                                  <X className="mr-2 h-4 w-4" />
                                  –ó–∞–∫—Ä—ã—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                                </Button>
                              </div>
                            )}

                            {receivedCargo && (
                              <div className="p-3 bg-orange-50 border border-orange-200 rounded">
                                <p className="text-sm text-orange-800">
                                  ‚úì –ì—Ä—É–∑ –¥–ª—è –ø—Ä–∏—ë–º–∞: {receivedCargo.cargo_number}
                                </p>
                              </div>
                            )}
                          </div>
                        )}

                        {receiveStep === 'scan-new-cell' && (
                          <div className="space-y-4">
                            <div className="text-center">
                              <h3 className="font-semibold text-green-600">–®–∞–≥ 2: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –Ω–æ–≤–æ–π —è—á–µ–π–∫–∏</h3>
                              <p className="text-sm text-gray-600">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR –∫–æ–¥ —è—á–µ–π–∫–∏ –Ω–æ–≤–æ–≥–æ —Å–∫–ª–∞–¥–∞</p>
                            </div>
                            
                            <div 
                              id="qr-reader-placement-update" 
                              className="w-full bg-black rounded-lg"
                              style={{
                                aspectRatio: '1',
                                maxWidth: '400px',
                                margin: '0 auto'
                              }}
                            />

                            {/* –ö–Ω–æ–ø–∫–∞ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –∫–∞–º–µ—Ä—ã –¥–ª—è –Ω–æ–≤–æ–π —è—á–µ–π–∫–∏ */}
                            {availableCameras.length > 1 && (
                              <div className="text-center mt-2">
                                <Button 
                                  onClick={() => switchCamera()}
                                  variant="outline"
                                  size="sm"
                                >
                                  <RefreshCw className="mr-2 h-4 w-4" />
                                  –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
                                </Button>
                              </div>
                            )}

                            {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –¥–ª—è –Ω–æ–≤–æ–π —è—á–µ–π–∫–∏ */}
                            {scannerActive && (
                              <div className="text-center mt-3">
                                <Button 
                                  onClick={stopMobileScanning}
                                  variant="destructive"
                                  size="sm"
                                >
                                  <X className="mr-2 h-4 w-4" />
                                  –ó–∞–∫—Ä—ã—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
                                </Button>
                              </div>
                            )}

                            {receivedCargo && (
                              <div className="p-3 bg-blue-50 border border-blue-200 rounded">
                                <p className="text-sm text-blue-800">
                                  –ì—Ä—É–∑ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è: {receivedCargo.cargo_number}
                                </p>
                              </div>
                            )}
                          </div>
                        )}

                        {receiveStep === 'confirm' && (
                          <div className="space-y-4">
                            <div className="text-center">
                              <h3 className="font-semibold text-green-600">–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏—ë–º–∞</h3>
                            </div>
                            
                            <div className="bg-gray-50 p-4 rounded space-y-2">
                              <div className="flex justify-between">
                                <span>–ì—Ä—É–∑:</span>
                                <span className="font-medium">{receivedCargo?.cargo_number}</span>
                              </div>
                              <div className="flex justify-between">
                                <span>–ù–æ–≤–∞—è —è—á–µ–π–∫–∞:</span>
                                <span className="font-medium">{newCell?.cell_code}</span>
                              </div>
                              <div className="flex justify-between">
                                <span>–ù–æ–≤—ã–π —Å–∫–ª–∞–¥:</span>
                                <span className="font-medium">{newCell?.warehouse_name}</span>
                              </div>
                            </div>

                            <div className="flex space-x-2">
                              <Button 
                                onClick={() => confirmMobileReceive()}
                                className="flex-1 bg-green-600 hover:bg-green-700"
                              >
                                <CheckCircle className="mr-2 h-4 w-4" />
                                –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø—Ä–∏—ë–º
                              </Button>
                              <Button 
                                onClick={() => resetMobileReceive()}
                                variant="outline"
                                className="flex-1"
                              >
                                <X className="mr-2 h-4 w-4" />
                                –û—Ç–º–µ–Ω–∏—Ç—å
                              </Button>
                            </div>
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}

              {/* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–∑–∞–º–∏ */}
              {activeSection === 'cargo-management' && (
                <div className="space-y-6">
                  {/* –ü—Ä–∏–Ω–∏–º–∞—Ç—å –Ω–æ–≤—ã–π –≥—Ä—É–∑ */}
                  {activeTab === 'cargo-accept' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Plus className="mr-2 h-5 w-5" />
                          –ü—Ä–∏–Ω–∏–º–∞—Ç—å –Ω–æ–≤—ã–π –≥—Ä—É–∑
                        </CardTitle>
                        <CardDescription>
                          –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è –ø—Ä–∏–µ–º–∞ –Ω–æ–≤–æ–≥–æ –≥—Ä—É–∑–∞ –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
                        </CardDescription>
                        {isFilledFromProfile && profileSourceUser && (
                          <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div className="flex items-center text-blue-800">
                              <User className="mr-2 h-4 w-4" />
                              <span className="text-sm font-medium">
                                –î–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∏–∑ –ø—Ä–æ—Ñ–∏–ª—è: {profileSourceUser.full_name} ({profileSourceUser.user_number})
                              </span>
                            </div>
                            <p className="text-xs text-blue-600 mt-1">
                              –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∑–∞–ø–æ–ª–Ω–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ –≥—Ä—É–∑—ã.
                            </p>
                          </div>
                        )}
                      </CardHeader>
                      <CardContent>
                        {/* –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –ø–æ—Å—Ç—É–ø–∏–≤—à–∏—Ö –≥—Ä—É–∑–∞—Ö –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ */}
                        {(user?.role === 'warehouse_operator' || user?.role === 'admin') && warehouseNotifications.length > 0 && (
                          <Card className="mb-6 border-blue-200 bg-blue-50">
                            <CardHeader>
                              <CardTitle className="flex items-center justify-between">
                                <div className="flex items-center">
                                  <Bell className="mr-2 h-5 w-5 text-blue-700" />
                                  –ü–æ—Å—Ç—É–ø–∏–≤—à–∏–µ –≥—Ä—É–∑—ã –Ω–∞ —Å–∫–ª–∞–¥ ({warehouseNotifications.length})
                                </div>
                                {warehouseNotifications.length > 2 && (
                                  <Button
                                    variant="outline"
                                    size="sm"
                                    onClick={() => setShowAllNotifications(!showAllNotifications)}
                                    className="text-blue-700 border-blue-300 hover:bg-blue-100"
                                  >
                                    {showAllNotifications ? '–°–∫—Ä—ã—Ç—å' : `–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ—Ö (${warehouseNotifications.length})`}
                                  </Button>
                                )}
                              </CardTitle>
                              <CardDescription className="text-blue-600">
                                –ö—É—Ä—å–µ—Ä—ã —Å–¥–∞–ª–∏ —Å–ª–µ–¥—É—é—â–∏–µ –≥—Ä—É–∑—ã –Ω–∞ —Å–∫–ª–∞–¥. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–∏–Ω—è—Ç—å –∏ –æ—Ñ–æ—Ä–º–∏—Ç—å –∏—Ö –≤ —Å–∏—Å—Ç–µ–º–µ.
                                {!showAllNotifications && warehouseNotifications.length > 2 && 
                                  ` –ü–æ–∫–∞–∑–∞–Ω–æ ${Math.min(2, warehouseNotifications.length)} –∏–∑ ${warehouseNotifications.length} —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π.`
                                }
                              </CardDescription>
                            </CardHeader>
                            <CardContent>
                              <div className="space-y-3">
                                {(showAllNotifications ? warehouseNotifications : warehouseNotifications.slice(0, 2))
                                  .filter(notification => notification?.id) // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–∏–ª—å—Ç—Ä –¥–ª—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏
                                  .map((notification, index) => (
                                  <div
                                    key={`${notification.id}-${notification.status}-${index}`} // –ë–æ–ª–µ–µ —É–Ω–∏–∫–∞–ª—å–Ω—ã–π –∫–ª—é—á
                                    className="bg-white p-4 rounded-lg border border-blue-200 shadow-sm"
                                  >
                                    <div className="flex items-start justify-between">
                                      <div className="flex-1">
                                        <div className="flex items-center space-x-4 mb-2">
                                          <Badge className="bg-orange-100 text-orange-700 border-orange-200">
                                            ‚Ññ {notification.request_number || 'N/A'}
                                          </Badge>
                                          <Badge className="bg-green-100 text-green-700 border-green-200">
                                            {notification.courier_name}
                                          </Badge>
                                          {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å—Ç–∞—Ç—É—Å–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */}
                                          <Badge variant={
                                            notification.status === 'pending_acceptance' ? 'default' :
                                            notification.status === 'in_processing' ? 'secondary' : 'outline'
                                          } className={
                                            notification.status === 'pending_acceptance' ? 'bg-blue-100 text-blue-800' :
                                            notification.status === 'in_processing' ? 'bg-yellow-100 text-yellow-800' : 
                                            'bg-gray-100 text-gray-800'
                                          }>
                                            {notification.status === 'pending_acceptance' ? 'üîî –ù–æ–≤–æ–µ' :
                                             notification.status === 'in_processing' ? '‚è≥ –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è' : 
                                             '‚úÖ –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ'}
                                          </Badge>
                                        </div>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm">
                                          <div>
                                            <span className="font-medium text-gray-700">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</span>
                                            <span className="ml-1">{notification.sender_full_name}</span>
                                          </div>
                                          <div>
                                            <span className="font-medium text-gray-700">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                                            <span className="ml-1">{notification.sender_phone}</span>
                                          </div>
                                          <div>
                                            <span className="font-medium text-gray-700">–ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞:</span>
                                            <span className="ml-1">{notification.pickup_address}</span>
                                          </div>
                                          <div>
                                            <span className="font-medium text-gray-700">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞:</span>
                                            <span className="ml-1">{notification.destination || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                                          </div>
                                          <div>
                                            <span className="font-medium text-gray-700">–ü–ª–∞—Ç–∞ –∫—É—Ä—å–µ—Ä—É:</span>
                                            <span className="ml-1 font-semibold text-green-600">{notification.courier_fee || 0} ‚ÇΩ</span>
                                          </div>
                                          <div>
                                            <span className="font-medium text-gray-700">–°–¥–∞–Ω –Ω–∞ —Å–∫–ª–∞–¥:</span>
                                            <span className="ml-1">{new Date(notification.delivered_at).toLocaleString('ru-RU')}</span>
                                          </div>
                                        </div>
                                      </div>
                                      
                                      <div className="ml-4">
                                        {/* –£—Å–ª–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞ */}
                                        {notification.status === 'pending_acceptance' && (
                                          <Button
                                            onClick={() => handleAcceptWarehouseDelivery(notification.id)}
                                            className="bg-blue-600 hover:bg-blue-700"
                                            size="sm"
                                          >
                                            <CheckCircle className="mr-2 h-4 w-4" />
                                            –ü—Ä–∏–Ω—è—Ç—å –≥—Ä—É–∑
                                          </Button>
                                        )}
                                        
                                        {notification.status === 'in_processing' && (
                                          <div className="flex flex-col space-y-2">
                                            <div className="text-center mb-2">
                                              <div className="text-sm text-yellow-600 font-medium">–û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è</div>
                                              <div className="text-xs text-gray-500 mt-1">
                                                {notification.processing_by}
                                              </div>
                                            </div>
                                            
                                            {/* –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∑–∞—è–≤–∫–∏ */}
                                            <div className="flex flex-col space-y-1">
                                              <Button
                                                variant="outline"
                                                size="sm"
                                                onClick={() => handlePrintPickupQR(notification)}
                                                className="text-blue-600 border-blue-300 hover:bg-blue-50"
                                              >
                                                <QrCode className="mr-1 h-3 w-3" />
                                                QR –∫–æ–¥
                                              </Button>
                                              
                                              <Button
                                                variant="outline"
                                                size="sm"
                                                onClick={() => handlePrintPickupInvoice(notification)}
                                                className="text-purple-600 border-purple-300 hover:bg-purple-50"
                                              >
                                                <FileText className="mr-1 h-3 w-3" />
                                                –ù–∞–∫–ª–∞–¥–Ω–∞—è
                                              </Button>
                                              
                                              <Button
                                                variant="outline"
                                                size="sm"
                                                onClick={() => handleViewNotification(notification)}
                                                className="text-orange-600 border-orange-300 hover:bg-orange-50"
                                              >
                                                <Eye className="mr-1 h-3 w-3" />
                                                –ü—Ä–æ—Å–º–æ—Ç—Ä
                                              </Button>
                                              
                                              <Button
                                                variant="outline"
                                                size="sm"
                                                onClick={() => handleSendToPlacement(notification)}
                                                className="text-green-600 border-green-300 hover:bg-green-50"
                                              >
                                                <Package className="mr-1 h-3 w-3" />
                                                –û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ
                                              </Button>
                                            </div>
                                          </div>
                                        )}
                                      </div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            </CardContent>
                          </Card>
                        )}
                        
                        <form onSubmit={handleAcceptCargo} className="space-y-6 max-w-4xl xl:max-w-6xl">
                          {/* –£–õ–£–ß–®–ï–ù–ù–ê–Ø –§–û–†–ú–ê –ü–†–ò–Å–ú–ê –ì–†–£–ó–ê */}
                          
                          {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ */}
                          <Card>
                            <CardHeader>
                              <CardTitle className="text-lg flex items-center">
                                <User className="mr-2 h-5 w-5 text-blue-600" />
                                –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å
                              </CardTitle>
                            </CardHeader>
                            <CardContent>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                  <Label htmlFor="sender_full_name">–§–ò–û –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è *</Label>
                                  <Input
                                    id="sender_full_name"
                                    value={operatorCargoForm.sender_full_name}
                                    onChange={(e) => setOperatorCargoForm({...operatorCargoForm, sender_full_name: e.target.value})}
                                    placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
                                    className="h-12 text-base"
                                    required
                                  />
                                </div>
                                <div>
                                  <Label htmlFor="sender_phone">–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è *</Label>
                                  <Input
                                    id="sender_phone"
                                    type="tel"
                                    value={operatorCargoForm.sender_phone}
                                    onChange={(e) => setOperatorCargoForm({...operatorCargoForm, sender_phone: e.target.value})}
                                    placeholder="+7XXXXXXXXXX"
                                    className="h-12 text-base"
                                    required
                                  />
                                </div>
                              </div>
                            </CardContent>
                          </Card>

                          {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ */}
                          <Card>
                            <CardHeader>
                              <CardTitle className="text-lg flex items-center">
                                <User className="mr-2 h-5 w-5 text-green-600" />
                                –ü–æ–ª—É—á–∞—Ç–µ–ª—å
                              </CardTitle>
                            </CardHeader>
                            <CardContent>
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                  <Label htmlFor="recipient_full_name">–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</Label>
                                  <Input
                                    id="recipient_full_name"
                                    value={operatorCargoForm.recipient_full_name}
                                    onChange={(e) => setOperatorCargoForm({...operatorCargoForm, recipient_full_name: e.target.value})}
                                    placeholder="–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á"
                                    className="h-12 text-base"
                                    required
                                  />
                                </div>
                                <div>
                                  <Label htmlFor="recipient_phone">–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</Label>
                                  <Input
                                    id="recipient_phone"
                                    type="tel"
                                    value={operatorCargoForm.recipient_phone}
                                    onChange={(e) => setOperatorCargoForm({...operatorCargoForm, recipient_phone: e.target.value})}
                                    placeholder="+992XXXXXXXXX"
                                    className="h-12 text-base"
                                    required
                                  />
                                </div>
                              </div>
                            </CardContent>
                          </Card>

                          {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ */}
                          <Card>
                            <CardHeader>
                              <CardTitle className="text-lg flex items-center">
                                <MapPin className="mr-2 h-5 w-5 text-orange-600" />
                                –î–æ—Å—Ç–∞–≤–∫–∞
                              </CardTitle>
                            </CardHeader>
                            <CardContent>
                              <div className="space-y-4">
                                {/* –ì–æ—Ä–æ–¥ –∏ —Å–∫–ª–∞–¥ –≤—ã–¥–∞—á–∏ –≥—Ä—É–∑–∞ */}
                                <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                  <div>
                                    <Label htmlFor="delivery_city">–ì–æ—Ä–æ–¥ –≤—ã–¥–∞—á–∏ –≥—Ä—É–∑–∞ *</Label>
                                    {allCitiesLoading ? (
                                      <div className="flex items-center px-3 py-2 border border-gray-300 rounded-md">
                                        <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                                        <span className="text-sm text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –≥–æ—Ä–æ–¥–æ–≤...</span>
                                      </div>
                                    ) : (
                                      <div className="relative city-autocomplete">
                                        <Input
                                          id="delivery_city"
                                          type="text"
                                          value={citySearchQuery}
                                          onChange={(e) => handleCitySearchChange(e.target.value)}
                                          onFocus={() => {
                                            if (filteredCities.length > 0) setShowCityDropdown(true);
                                          }}
                                          placeholder="–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞..."
                                          className="w-full h-12 text-base"
                                          required
                                        />
                                        
                                        {/* –í—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ —Å –Ω–∞–π–¥–µ–Ω–Ω—ã–º–∏ –≥–æ—Ä–æ–¥–∞–º–∏ */}
                                        {showCityDropdown && filteredCities.length > 0 && (
                                          <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto">
                                            {filteredCities.map((cityData, index) => (
                                              <div
                                                key={index}
                                                onClick={() => handleDeliveryCityChange(cityData.city_name)}
                                                className="px-4 py-2 hover:bg-blue-50 cursor-pointer border-b border-gray-100 last:border-b-0"
                                              >
                                                <div className="font-medium text-gray-900">{cityData.city_name}</div>
                                                <div className="text-sm text-gray-500">
                                                  {cityData.warehouses_count} {cityData.warehouses_count === 1 ? '—Å–∫–ª–∞–¥' : '—Å–∫–ª–∞–¥–æ–≤'}
                                                </div>
                                              </div>
                                            ))}
                                          </div>
                                        )}
                                        
                                        {/* –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ –µ—Å–ª–∏ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ */}
                                        {citySearchQuery.length > 0 && filteredCities.length === 0 && (
                                          <div className="absolute z-10 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg p-4 text-center text-gray-500">
                                            –ì–æ—Ä–æ–¥–æ–≤ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ
                                          </div>
                                        )}
                                      </div>
                                    )}
                                  </div>
                                  
                                  <div>
                                    <Label htmlFor="delivery_warehouse">–°–∫–ª–∞–¥ –¥–ª—è –≤—ã–¥–∞—á–∏ –≥—Ä—É–∑–∞ *</Label>
                                    {selectedDeliveryCity && availableWarehousesForCity.length > 0 ? (
                                      <div className="space-y-2">
                                        <select
                                          id="delivery_warehouse"
                                          value={selectedDeliveryWarehouse}
                                          onChange={(e) => handleDeliveryWarehouseChange(e.target.value)}
                                          className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 h-12 text-base"
                                          required
                                        >
                                          {availableWarehousesForCity.map((warehouse, index) => (
                                            <option key={index} value={warehouse.warehouse_id}>
                                              {warehouse.warehouse_name} ({warehouse.warehouse_location})
                                            </option>
                                          ))}
                                        </select>
                                        {selectedDeliveryWarehouse && (
                                          <div className="bg-green-50 p-2 rounded-md border border-green-200">
                                            <div className="text-sm text-green-700 flex items-center">
                                              <CheckCircle className="h-4 w-4 mr-1" />
                                              –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω: {availableWarehousesForCity.find(w => w.warehouse_id === selectedDeliveryWarehouse)?.warehouse_name}
                                            </div>
                                          </div>
                                        )}
                                      </div>
                                    ) : (
                                      <div className="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-500 h-12 flex items-center">
                                        {!selectedDeliveryCity 
                                          ? '–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –≥–æ—Ä–æ–¥' 
                                          : availableWarehousesForCity.length === 0
                                            ? '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–æ—Ä–æ–¥–∞' 
                                            : '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–ª–∞–¥–æ–≤...'}
                                      </div>
                                    )}
                                  </div>
                                </div>

                                {/* –ê–¥—Ä–µ—Å –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä—É–∑–∞ - –ø–µ—Ä–µ–º–µ—â–µ–Ω –ø–æ—Å–ª–µ –≤—ã–±–æ—Ä–∞ –≥–æ—Ä–æ–¥–∞ */}
                                <div>
                                  <Label htmlFor="recipient_address">–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä—É–∑–∞ *</Label>
                                  <Input
                                    id="recipient_address"
                                    value={operatorCargoForm.recipient_address}
                                    onChange={(e) => setOperatorCargoForm({...operatorCargoForm, recipient_address: e.target.value})}
                                    placeholder="–î—É—à–∞–Ω–±–µ, —É–ª. –†—É–¥–∞–∫–∏, 10, –∫–≤. 5"
                                    className="h-12 text-base"
                                    required
                                  />
                                </div>
                              </div>
                            </CardContent>
                          </Card>

                          {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ –∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä */}
                          <Card>
                            <CardHeader>
                              <CardTitle className="text-lg flex items-center">
                                <Package className="mr-2 h-5 w-5 text-purple-600" />
                                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ
                              </CardTitle>
                            </CardHeader>
                            <CardContent>
                              {/* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –º–µ–∂–¥—É —Ä–µ–∂–∏–º–∞–º–∏ */}
                              <div className="mb-4 p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-blue-200">
                                <Label className="flex items-center space-x-2 cursor-pointer">
                                  <input
                                    type="checkbox"
                                    checked={operatorCargoForm.use_multi_cargo}
                                    onChange={(e) => {
                                      setOperatorCargoForm({
                                        ...operatorCargoForm,
                                        use_multi_cargo: e.target.checked
                                      });
                                      if (!e.target.checked) {
                                        setTotalWeight(0);
                                        setTotalCost(0);
                                      }
                                    }}
                                    className="rounded h-4 w-4"
                                  />
                                  <span className="text-base font-medium flex items-center">
                                    <Calculator className="mr-2 h-4 w-4" />
                                    –ù–µ—Å–∫–æ–ª—å–∫–æ –≤–∏–¥–æ–≤ –≥—Ä—É–∑–∞ (—Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º)
                                  </span>
                                </Label>
                                <div className="text-sm text-gray-600 mt-1 ml-6">
                                  –í–∫–ª—é—á–∏—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –ø–æ–∑–∏—Ü–∏–π —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–º —Ä–∞—Å—á–µ—Ç–æ–º —Å—Ç–æ–∏–º–æ—Å—Ç–∏
                                </div>
                              </div>

                          {!operatorCargoForm.use_multi_cargo ? (
                            // –°—Ç–∞—Ä–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –æ–¥–Ω–æ–≥–æ –≥—Ä—É–∑–∞
                            <>
                              <div>
                                <Label htmlFor="cargo_name">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞</Label>
                                <Input
                                  id="cargo_name"
                                  value={operatorCargoForm.cargo_name}
                                  onChange={(e) => setOperatorCargoForm({...operatorCargoForm, cargo_name: e.target.value})}
                                  placeholder="–î–æ–∫—É–º–µ–Ω—Ç—ã, –ª–∏—á–Ω—ã–µ –≤–µ—â–∏, —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞"
                                  required
                                />
                              </div>

                              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                  <Label htmlFor="weight">–í–µ—Å –≥—Ä—É–∑–∞ (–∫–≥)</Label>
                                  <Input
                                    id="weight"
                                    type="number"
                                    step="0.1"
                                    value={operatorCargoForm.weight}
                                    onChange={(e) => setOperatorCargoForm({...operatorCargoForm, weight: e.target.value})}
                                    placeholder="10.5"
                                    required
                                  />
                                </div>
                                <div>
                                  <Label htmlFor="declared_value">–°—Ç–æ–∏–º–æ—Å—Ç—å –≥—Ä—É–∑–∞ (—Ä—É–±.)</Label>
                                  <Input
                                    id="declared_value"
                                    type="number"
                                    step="0.01"
                                    value={operatorCargoForm.declared_value}
                                    onChange={(e) => setOperatorCargoForm({...operatorCargoForm, declared_value: e.target.value})}
                                    placeholder="5000"
                                    required
                                  />
                                </div>
                              </div>
                            </>
                          ) : (
                            // –ù–æ–≤–∞—è —Ñ–æ—Ä–º–∞ —Å –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã–º–∏ –≥—Ä—É–∑–∞–º–∏ –∏ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º
                            <>
                              <div className="bg-blue-50 p-4 rounded-lg">
                                <h3 className="font-semibold text-lg mb-3 flex items-center">
                                  <Package className="mr-2 h-5 w-5" />
                                  –°–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤
                                </h3>
                                
                                {operatorCargoForm.cargo_items.map((item, index) => (
                                  <div key={`cargo-item-${index}`} className="mb-4 p-4 bg-white rounded border">
                                    <div className="flex items-center justify-between mb-2">
                                      <span className="font-medium text-sm text-gray-600">
                                        –ì—Ä—É–∑ #{index + 1}
                                      </span>
                                      {operatorCargoForm.cargo_items.length > 1 && (
                                        <Button
                                          type="button"
                                          variant="outline"
                                          size="sm"
                                          onClick={() => removeCargoItem(index)}
                                        >
                                          <X className="h-4 w-4" />
                                        </Button>
                                      )}
                                    </div>
                                    
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 xl:grid-cols-5 2xl:grid-cols-5 gap-3">
                                      <div>
                                        <Label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞</Label>
                                        <Input
                                          key={`cargo-name-${index}`}
                                          value={item.cargo_name || ''}
                                          onChange={(e) => {
                                            const newItems = [...operatorCargoForm.cargo_items];
                                            newItems[index] = { ...newItems[index], cargo_name: e.target.value };
                                            setOperatorCargoForm(prev => ({
                                              ...prev,
                                              cargo_items: newItems
                                            }));
                                          }}
                                          placeholder="–î–æ–∫—É–º–µ–Ω—Ç—ã, –æ–¥–µ–∂–¥–∞, —ç–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞"
                                          className="xl:h-11 xl:text-base"
                                          required
                                        />
                                      </div>
                                      <div>
                                        <Label>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</Label>
                                        <Input
                                          type="number"
                                          min="1"
                                          step="1"
                                          value={item.quantity || 1}
                                          onChange={(e) => updateCargoItem(index, 'quantity', e.target.value)}
                                          placeholder="1"
                                          className="xl:h-11 xl:text-base"
                                          required
                                        />
                                      </div>
                                      <div>
                                        <Label>–í–µ—Å (–∫–≥)</Label>
                                        <Input
                                          type="number"
                                          step="0.1"
                                          min="0"
                                          value={item.weight}
                                          onChange={(e) => updateCargoItem(index, 'weight', e.target.value)}
                                          placeholder="1.0"
                                          required
                                        />
                                      </div>
                                      <div>
                                        <Label>–¶–µ–Ω–∞ –∑–∞ –∫–≥ (‚ÇΩ)</Label>
                                        <Input
                                          type="number"
                                          step="0.01"
                                          min="0"
                                          value={item.price_per_kg}
                                          onChange={(e) => updateCargoItem(index, 'price_per_kg', e.target.value)}
                                          placeholder="50.00"
                                          required
                                        />
                                      </div>
                                      <div>
                                        <Label>–û–±—â–∞—è —Å—É–º–º–∞ (‚ÇΩ)</Label>
                                        <Input
                                          type="number"
                                          step="0.01"
                                          min="0"
                                          value={item.total_amount || '0.00'}
                                          readOnly
                                          className="bg-gray-100"
                                          placeholder="0.00"
                                        />
                                      </div>
                                    </div>
                                    
                                    {/* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–π —Ä–∞—Å—á–µ—Ç –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥—Ä—É–∑–∞ */}
                                    {item.weight && item.price_per_kg && (
                                      <div className="mt-2 p-2 bg-gray-50 rounded text-sm">
                                        <span className="text-gray-600">
                                          –°—Ç–æ–∏–º–æ—Å—Ç—å: {parseFloat(item.weight)} –∫–≥ √ó {parseFloat(item.price_per_kg)} —Ä—É–±/–∫–≥ = 
                                          <span className="font-semibold text-green-600 ml-1">
                                            {(parseFloat(item.weight) * parseFloat(item.price_per_kg)).toFixed(2)} —Ä—É–±
                                          </span>
                                        </span>
                                      </div>
                                    )}
                                  </div>
                                ))}
                                
                                <Button
                                  type="button"
                                  variant="outline"
                                  onClick={addCargoItem}
                                  className="w-full border-dashed border-gray-300 text-gray-600 hover:border-gray-400 xl:h-12 xl:text-base"
                                >
                                  <Plus className="mr-2 h-4 w-4 xl:h-5 xl:w-5" />
                                  –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ –≥—Ä—É–∑
                                </Button>
                              </div>

                              {/* –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π —Ä–∞–∑–±–∏–≤–∫–æ–π */}
                              <div className="bg-green-50 p-4 rounded-lg">
                                <h3 className="font-semibold text-lg mb-3 flex items-center">
                                  <Calculator className="mr-2 h-5 w-5" />
                                  –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä —Å—Ç–æ–∏–º–æ—Å—Ç–∏
                                </h3>
                                
                                {/* –î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑–±–∏–≤–∫–∞ –ø–æ –∫–∞–∂–¥–æ–º—É –≥—Ä—É–∑—É */}
                                {cargoBreakdown.length > 0 && (
                                  <div className="mb-4">
                                    <h4 className="font-medium text-sm text-gray-700 mb-2">–î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑–±–∏–≤–∫–∞:</h4>
                                    <div className="space-y-2">
                                      {cargoBreakdown.map((item, index) => (
                                        <div key={`breakdown-${index}-${item.name}`} className="bg-white p-3 rounded border-l-4 border-blue-400">
                                          <div className="flex justify-between items-center">
                                            <span className="text-sm font-medium text-gray-700">
                                              –ì—Ä—É–∑ #{item.index}: {item.name}
                                            </span>
                                            <span className="text-sm font-bold text-green-600">
                                              {item.cost.toFixed(2)} —Ä—É–±
                                            </span>
                                          </div>
                                          <div className="text-xs text-gray-500 mt-1">
                                            {item.quantity}—à—Ç √ó {(item.weight/item.quantity).toFixed(1)} –∫–≥ √ó {item.pricePerKg.toFixed(2)} —Ä—É–±/–∫–≥
                                          </div>
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                )}

                                {/* –û–±—â–∏–µ –∏—Ç–æ–≥–∏ */}
                                <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                                  <div className="bg-white p-3 rounded border">
                                    <div className="text-sm text-gray-600">–û–±—â–∏–π –≤–µ—Å</div>
                                    <div className="text-2xl font-bold text-blue-600">
                                      {totalWeight.toFixed(1)} –∫–≥
                                    </div>
                                  </div>
                                  <div className="bg-white p-3 rounded border">
                                    <div className="text-sm text-gray-600">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
                                    <div className="text-2xl font-bold text-green-600">
                                      {totalCost.toFixed(2)} ‚ÇΩ
                                    </div>
                                  </div>
                                </div>

                                {/* –°–≤–æ–¥–∫–∞ —Ä–∞—Å—á–µ—Ç–æ–≤ */}
                                {cargoBreakdown.length > 1 && (
                                  <div className="mt-3 p-2 bg-white rounded text-sm border-t-2 border-green-400">
                                    <div className="font-medium text-gray-700 mb-1">–ò–¢–û–ì–û:</div>
                                    {cargoBreakdown.map((item, index) => (
                                      <div key={`cost-${index}-${item.name}`} className="flex justify-between text-xs text-gray-600">
                                        <span>{item.name}: {item.weight.toFixed(1)}–∫–≥ √ó {item.pricePerKg.toFixed(2)}—Ä—É–±</span>
                                        <span>{item.cost.toFixed(2)}—Ä—É–±</span>
                                      </div>
                                    ))}
                                    <div className="flex justify-between font-bold text-sm text-green-700 mt-1 pt-1 border-t">
                                      <span>–í—Å–µ–≥–æ: {totalWeight.toFixed(1)} –∫–≥</span>
                                      <span>{totalCost.toFixed(2)} —Ä—É–±</span>
                                    </div>
                                  </div>
                                )}
                              </div>
                            </>
                          )}

                          <div>
                            <Label htmlFor="route">–ú–∞—Ä—à—Ä—É—Ç</Label>
                            <Select 
                              key="old-route-select"
                              value={operatorCargoForm.route} 
                              onValueChange={(value) => {
                                setOperatorCargoForm(prev => ({
                                  ...prev, 
                                  route: value
                                }));
                              }}
                            >
                              <SelectTrigger key="old-route-trigger">
                                <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç" />
                              </SelectTrigger>
                              <SelectContent key="old-route-content">
                                <SelectItem key="old-moscow-to-tajikistan" value="moscow_to_tajikistan">–ú–æ—Å–∫–≤–∞ ‚Üí –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω</SelectItem>
                                <SelectItem key="old-tajikistan-to-moscow" value="tajikistan_to_moscow">–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω ‚Üí –ú–æ—Å–∫–≤–∞</SelectItem>
                              </SelectContent>
                            </Select>
                          </div>

                          <div>
                            <Label htmlFor="description">–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–∑–∞</Label>
                            <Textarea
                              id="description"
                              value={operatorCargoForm.description}
                              onChange={(e) => setOperatorCargoForm({...operatorCargoForm, description: e.target.value})}
                              placeholder="–õ–∏—á–Ω—ã–µ –≤–µ—â–∏, –¥–æ–∫—É–º–µ–Ω—Ç—ã, –ø–æ–¥–∞—Ä–∫–∏..."
                              required
                            />
                          </div>

                          {/* –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã */}
                          <div>
                            <Label htmlFor="payment_method">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</Label>
                            <Select 
                              key="payment-method-select"
                              value={operatorCargoForm.payment_method} 
                              onValueChange={(value) => {
                                const newForm = { ...operatorCargoForm };
                                newForm.payment_method = value;
                                
                                // –°–±—Ä–æ—Å –∑–∞–≤–∏—Å–∏–º—ã—Ö –ø–æ–ª–µ–π
                                if (value !== 'cash' && value !== 'card_transfer') {
                                  newForm.payment_amount = '';
                                }
                                if (value !== 'credit') {
                                  newForm.debt_due_date = '';
                                }
                                
                                setOperatorCargoForm(newForm);
                              }}
                            >
                              <SelectTrigger key="payment-method-trigger">
                                <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã" />
                              </SelectTrigger>
                              <SelectContent key="payment-method-content">
                                <SelectItem key="payment-not_paid" value="not_paid">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</SelectItem>
                                <SelectItem key="payment-cash" value="cash">–û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏</SelectItem>
                                <SelectItem key="payment-card_transfer" value="card_transfer">–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É</SelectItem>
                                <SelectItem key="payment-cash_on_delivery" value="cash_on_delivery">–û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏</SelectItem>
                                <SelectItem key="payment-credit" value="credit">–û–ø–ª–∞—Ç–∞ –≤ –¥–æ–ª–≥</SelectItem>
                              </SelectContent>
                            </Select>
                          </div>

                          {/* –ü–æ–ª–µ —Å—É–º–º—ã –æ–ø–ª–∞—Ç—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–∞–ª–∏—á–Ω—ã—Ö –∏ –∫–∞—Ä—Ç—ã) */}
                          {(operatorCargoForm.payment_method === 'cash' || operatorCargoForm.payment_method === 'card_transfer') && (
                            <div>
                              <Label htmlFor="payment_amount">–°—É–º–º–∞ –æ–ø–ª–∞—Ç—ã (—Å–æ–º)</Label>
                              <Input
                                id="payment_amount"
                                type="number"
                                step="0.01"
                                value={operatorCargoForm.payment_amount}
                                onChange={(e) => setOperatorCargoForm({...operatorCargoForm, payment_amount: e.target.value})}
                                placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É –æ–ø–ª–∞—Ç—ã"
                                required={operatorCargoForm.payment_method === 'cash' || operatorCargoForm.payment_method === 'card_transfer'}
                              />
                            </div>
                          )}

                          {/* –î–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è –¥–æ–ª–≥–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –æ–ø–ª–∞—Ç—ã –≤ –¥–æ–ª–≥) */}
                          {operatorCargoForm.payment_method === 'credit' && (
                            <div>
                              <Label htmlFor="debt_due_date">–î–∞—Ç–∞ –ø–æ–≥–∞—à–µ–Ω–∏—è –¥–æ–ª–≥–∞</Label>
                              <Input
                                id="debt_due_date"
                                type="date"
                                value={operatorCargoForm.debt_due_date}
                                onChange={(e) => setOperatorCargoForm({...operatorCargoForm, debt_due_date: e.target.value})}
                                required
                                min={new Date().toISOString().split('T')[0]}
                              />
                            </div>
                          )}

                          {/* –°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä—É–∑–∞ */}
                          <div>
                            <Label htmlFor="delivery_method">–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä—É–∑–∞ *</Label>
                            <select
                              id="delivery_method"
                              value={operatorCargoForm.delivery_method}
                              onChange={(e) => setOperatorCargoForm({...operatorCargoForm, delivery_method: e.target.value})}
                              className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 xl:h-12 xl:text-base"
                              required
                            >
                              <option value="pickup">–°–∞–º–æ–≤—ã–≤–æ–∑</option>
                              <option value="city_delivery">–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –≥–æ—Ä–æ–¥–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</option>
                              <option value="home_delivery">–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –¥–æ–º–∞</option>
                            </select>
                          </div>

                          {/* –°–∫–ª–∞–¥ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞) */}
                          {user?.role === 'admin' && (
                            <div>
                              <Label htmlFor="placement_warehouse">–°–∫–ª–∞–¥ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞ *</Label>
                              <select
                                id="placement_warehouse"
                                value={operatorCargoForm.warehouse_id}
                                onChange={(e) => setOperatorCargoForm({...operatorCargoForm, warehouse_id: e.target.value})}
                                className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                                required
                              >
                                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</option>
                                {warehouses.map((warehouse) => (
                                  <option key={warehouse.id} value={warehouse.id}>
                                    {warehouse.name} - {warehouse.location}
                                  </option>
                                ))}
                              </select>
                            </div>
                          )}

                          {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º —Å–∫–ª–∞–¥–µ –¥–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ */}
                          {user?.role === 'warehouse_operator' && operatorWarehouses.length > 0 && (
                            <div className="bg-blue-50 p-3 rounded-lg border border-blue-200">
                              <Label className="text-sm font-medium text-blue-800">–°–∫–ª–∞–¥ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞</Label>
                              <div className="mt-1">
                                <span className="font-semibold text-blue-900">
                                  {operatorWarehouses[0]?.name} - {operatorWarehouses[0]?.location}
                                </span>
                              </div>
                              <p className="text-xs text-blue-600 mt-1">
                                –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—ã–±—Ä–∞–Ω —Å–∫–ª–∞–¥, –∫ –∫–æ—Ç–æ—Ä–æ–º—É –≤—ã –ø—Ä–∏–≤—è–∑–∞–Ω—ã
                              </p>
                            </div>
                          )}

                          {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π - –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –≤ –æ–±—ã—á–Ω–æ–º —Ä–µ–∂–∏–º–µ */}
                          <div className="flex flex-col gap-4">
                            {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
                            <div className="flex flex-col space-y-3">
                              {/* –ì–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ –ø—Ä–∏–µ–º–∞ –≥—Ä—É–∑–∞ */}
                              <Button type="submit" className="w-full h-12 md:h-14 text-base md:text-lg" size="lg" variant="default">
                                <Plus className="mr-2 h-4 w-4 md:h-5 md:w-5" />
                                –ü—Ä–∏–Ω—è—Ç—å –≥—Ä—É–∑
                              </Button>
                              
                              {/* –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏ */}
                              <Button 
                                type="button"
                                onClick={handleGenerateCargoNumberQR}
                                className="w-full bg-orange-600 hover:bg-orange-700 h-12 md:h-14 text-base md:text-lg" 
                                size="lg"
                                title="–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥ —Ç–æ–ª—å–∫–æ –¥–ª—è –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏ (—Ä–∞–∑–º–µ—Ä –ø–µ—á–∞—Ç–∏: 90–º–º x 100–º–º)"
                              >
                                <QrCode className="mr-2 h-4 w-4 md:h-5 md:w-5" />
                                –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ü–µ—á–∞—Ç—å QR –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏
                              </Button>
                              
                              {/* –ö–Ω–æ–ø–∫–∞ –¥–ª—è –∫—É—Ä—å–µ—Ä—Å–∫–æ–≥–æ –∑–∞–±–æ—Ä–∞ */}
                              {operatorCargoForm.pickup_required && (
                                <Button 
                                  type="button"
                                  onClick={() => handleSendToCourier()}
                                  className="w-full bg-blue-600 hover:bg-blue-700 h-12 md:h-14 text-base md:text-lg" 
                                  size="lg"
                                >
                                  <Truck className="mr-2 h-4 w-4 md:h-5 md:w-5" />
                                  –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∫—É—Ä—å–µ—Ä–æ–º
                                </Button>
                              )}
                            </div>
                            
                            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å—Ç–∞—Ç—É—Å–µ */}
                            <div className="text-sm text-gray-600 text-center bg-blue-50 p-3 rounded-lg border border-blue-200">
                              <div className="flex items-center justify-center mb-2">
                                <Clock className="mr-2 h-4 w-4" />
                                <span className="font-medium">–ü–æ—Å–ª–µ –ø—Ä–∏–µ–º–∞ –≥—Ä—É–∑ –ø–æ—Å—Ç—É–ø–∏—Ç –≤:</span>
                              </div>
                              <div className="text-blue-800 font-semibold">
                                –ö–∞—Å—Å–∞ ‚Üí –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ
                              </div>
                              <div className="text-xs text-gray-500 mt-1">
                                –ü–æ—Å–ª–µ –æ–ø–ª–∞—Ç—ã –≥—Ä—É–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—Å—è –≤ "–†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞"
                              </div>
                            </div>
                          </div>
                            </CardContent>
                          </Card>
                        </form>
                      </CardContent>
                    </Card>
                  )}

                  {/* –ù–û–í–ê–Ø –í–ö–õ–ê–î–ö–ê: –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞ */}
                  {activeTab === 'cargo-pickup-create' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Truck className="mr-2 h-5 w-5 text-orange-600" />
                          –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞
                        </CardTitle>
                        <CardDescription>
                          –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ñ–æ—Ä–º—É –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞ –∫—É—Ä—å–µ—Ä–æ–º
                        </CardDescription>
                      </CardHeader>
                      <CardContent className="xl:p-8">
                        <form onSubmit={handlePickupCargoSubmit} className="space-y-4 max-w-2xl xl:max-w-4xl">
                          <div className="bg-orange-50 p-4 rounded-lg border border-orange-200 mb-6">
                            <h3 className="font-semibold text-orange-800 mb-2 flex items-center">
                              <Truck className="mr-2 h-5 w-5" />
                              –ó–∞—è–≤–∫–∞ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞
                            </h3>
                            <p className="text-sm text-orange-700">
                              –ó–∞–ø–æ–ª–Ω–∏—Ç–µ —Ç–æ–ª—å–∫–æ –æ—Å–Ω–æ–≤–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ –∫—É—Ä—å–µ—Ä—É –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞
                            </p>
                          </div>

                          <div className="grid grid-cols-1 sm:grid-cols-2 xl:grid-cols-4 gap-4">
                            {/* –§–ò–û –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è */}
                            <div>
                              <Label htmlFor="pickup_sender_name" className="text-orange-700 font-medium">
                                –§–ò–û –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è *
                              </Label>
                              <Input
                                id="pickup_sender_name"
                                value={operatorCargoForm.sender_full_name}
                                onChange={(e) => setOperatorCargoForm({...operatorCargoForm, sender_full_name: e.target.value})}
                                placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
                                className="border-orange-200 focus:border-orange-400 xl:h-12 xl:text-base"
                                required
                              />
                            </div>

                            {/* –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ */}
                            <div>
                              <Label htmlFor="pickup_cargo_name" className="text-orange-700 font-medium">
                                –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ *
                              </Label>
                              <Input
                                id="pickup_cargo_name"
                                value={operatorCargoForm.cargo_name}
                                onChange={(e) => setOperatorCargoForm({...operatorCargoForm, cargo_name: e.target.value})}
                                placeholder="–î–æ–∫—É–º–µ–Ω—Ç—ã, –∫–æ—Ä–æ–±–∫–∞, —Å—É–º–∫–∞"
                                className="border-orange-200 focus:border-orange-400 xl:h-12 xl:text-base"
                                required
                              />
                            </div>

                            {/* –í–µ—Å –≥—Ä—É–∑–∞ */}
                            <div>
                              <Label htmlFor="pickup_weight" className="text-orange-700 font-medium">
                                –ü—Ä–∏–º–µ—Ä–Ω—ã–π –≤–µ—Å (–∫–≥) *
                              </Label>
                              <Input
                                id="pickup_weight"
                                type="number"
                                step="0.1"
                                min="0.1"
                                value={operatorCargoForm.weight}
                                onChange={(e) => setOperatorCargoForm({...operatorCargoForm, weight: e.target.value})}
                                placeholder="1.5"
                                className="border-orange-200 focus:border-orange-400 xl:h-12 xl:text-base"
                                required
                              />
                            </div>

                            {/* –ê–¥—Ä–µ—Å –º–µ—Å—Ç–∞ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –≥—Ä—É–∑–∞ */}
                            <div>
                              <Label htmlFor="pickup_address" className="text-orange-700 font-medium">
                                –ê–¥—Ä–µ—Å –º–µ—Å—Ç–∞ –Ω–∞—Ö–æ–∂–¥–µ–Ω–∏—è –≥—Ä—É–∑–∞ *
                              </Label>
                              <Input
                                id="pickup_address"
                                value={operatorCargoForm.pickup_address}
                                onChange={(e) => setOperatorCargoForm({...operatorCargoForm, pickup_address: e.target.value})}
                                placeholder="–ú–æ—Å–∫–≤–∞, —É–ª. –õ–µ–Ω–∏–Ω–∞, 15, –æ—Ñ–∏—Å 203"
                                className="border-orange-200 focus:border-orange-400 xl:h-12 xl:text-base"
                                required
                              />
                            </div>
                          </div>

                          {/* –ö–Ω–æ–ø–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞—è–≤–∫–∏ */}
                          <div className="pt-4">
                            <Button 
                              type="submit" 
                              className="w-full bg-orange-600 hover:bg-orange-700 text-white xl:h-14 xl:text-lg" 
                              size="lg"
                            >
                              <Truck className="mr-2 h-4 w-4 xl:h-5 xl:w-5" />
                              –û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞
                            </Button>
                          </div>
                        </form>
                      </CardContent>
                    </Card>
                  )}

                  {/* –ü–ï–†–ï–ò–ú–ï–ù–û–í–ê–ù–ù–ê–Ø –í–ö–õ–ê–î–ö–ê: –ù–∞ –∑–∞–±–æ—Ä (–ø–µ—Ä–µ–Ω–µ—Å–µ–Ω–æ –∏–∑ –†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞) */}
                  {activeTab === 'cargo-pickup-list' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Truck className="mr-2 h-5 w-5" />
                            –ó–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞
                          </div>
                          <Badge variant="secondary" className="bg-orange-100 text-orange-800">
                            {allPickupRequests.length} –∑–∞—è–≤–æ–∫
                          </Badge>
                        </CardTitle>
                        <CardDescription>
                          –ê–∫—Ç–∏–≤–Ω—ã–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞ —Å–æ —Å—Ç–∞—Ç—É—Å–∞–º–∏ –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –∫—É—Ä—å–µ—Ä–∞—Ö. 
                          –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω—ã –≤ "–ò—Å—Ç–æ—Ä–∏—é –∑–∞–±–æ—Ä–∞ –≥—Ä—É–∑–∞".
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        {/* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞—è–≤–æ–∫ –Ω–∞ –∑–∞–±–æ—Ä */}
                        {allPickupRequests.length > 0 && (
                          <div className="mb-4 flex items-center justify-between">
                            <div className="flex items-center space-x-4">
                              <div className="flex items-center space-x-2">
                                <Checkbox
                                  id="selectAllPickupRequests"
                                  checked={selectAllPickupRequests}
                                  onCheckedChange={(checked) => 
                                    handleSelectAllPickupRequests(checked, allPickupRequests)
                                  }
                                />
                                <Label htmlFor="selectAllPickupRequests" className="text-sm font-medium">
                                  –í—ã–±—Ä–∞—Ç—å –≤—Å–µ
                                </Label>
                              </div>
                              {selectedPickupRequests.length > 0 && (
                                <Badge variant="secondary" className="bg-blue-100 text-blue-800">
                                  {selectedPickupRequests.length} –≤—ã–±—Ä–∞–Ω–æ
                                </Badge>
                              )}
                            </div>
                            
                            {/* –ö–Ω–æ–ø–∫–∏ –º–∞—Å—Å–æ–≤—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π */}
                            {selectedPickupRequests.length > 0 && (
                              <div className="flex items-center space-x-2">
                                <Button
                                  variant="outline"
                                  size="sm"
                                  onClick={() => handleBulkDeleteRequests()}
                                  disabled={bulkDeleteLoading}
                                  className="text-red-600 border-red-300 hover:bg-red-50 hover:border-red-400"
                                >
                                  {bulkDeleteLoading ? (
                                    <>
                                      <div className="animate-spin rounded-full h-3 w-3 border-b-2 border-red-600 mr-1"></div>
                                      –£–¥–∞–ª–µ–Ω–∏–µ...
                                    </>
                                  ) : (
                                    <>
                                      <Trash2 className="mr-1 h-3 w-3" />
                                      –£–¥–∞–ª–∏—Ç—å ({selectedPickupRequests.length})
                                    </>
                                  )}
                                </Button>
                              </div>
                            )}
                          </div>
                        )}

                        {allPickupRequests.length === 0 ? (
                          <div className="text-center py-12">
                            <Truck className="mx-auto h-16 w-16 text-gray-300 mb-4" />
                            <h3 className="text-lg font-medium text-gray-900 mb-2">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –∑–∞—è–≤–æ–∫</h3>
                            <p className="text-gray-600 mb-4">
                              –ó–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å –ø–æ—Å–ª–µ –∏—Ö —Å–æ–∑–¥–∞–Ω–∏—è
                            </p>
                            <Button onClick={() => setActiveTab('cargo-pickup-create')}>
                              <Plus className="mr-2 h-4 w-4" />
                              –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –∑–∞–±–æ—Ä
                            </Button>
                          </div>
                        ) : (
                          <div className="grid gap-4">
                            {allPickupRequests.map((request) => (
                              <Card key={request.request_id} className="relative">
                                <CardContent className="p-4">
                                  <div className="flex items-start justify-between">
                                    <div className="flex items-center space-x-3">
                                      <Checkbox
                                        checked={selectedPickupRequests.includes(request.request_id)}
                                        onCheckedChange={(checked) => {
                                          setSelectedPickupRequests(prev => 
                                            checked 
                                              ? [...prev, request.request_id]
                                              : prev.filter(id => id !== request.request_id)
                                          )
                                        }}
                                        className="mt-1"
                                      />
                                      <div className="flex-1">
                                        <div className="flex items-center space-x-2 mb-2">
                                          <Badge variant="outline" className="text-blue-600 border-blue-200">
                                            ID: {request.request_id}
                                          </Badge>
                                          <Badge 
                                            className={
                                              request.status === 'pending' ? 'bg-yellow-100 text-yellow-800' :
                                              request.status === 'assigned' ? 'bg-blue-100 text-blue-800' :
                                              request.status === 'picked_up' ? 'bg-green-100 text-green-800' :
                                              'bg-red-100 text-red-800'
                                            }
                                          >
                                            {request.status === 'pending' ? '–û–∂–∏–¥–∞–µ—Ç' :
                                             request.status === 'assigned' ? '–ù–∞–∑–Ω–∞—á–µ–Ω–æ' :
                                             request.status === 'picked_up' ? '–ó–∞–±—Ä–∞–Ω–æ' :
                                             request.status}
                                          </Badge>
                                        </div>
                                        
                                        <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                                          <div>
                                            <p className="text-gray-500">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</p>
                                            <p className="font-medium">{request.sender_name}</p>
                                          </div>
                                          <div>
                                            <p className="text-gray-500">–ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞</p>
                                            <p className="font-medium">{request.pickup_address}</p>
                                          </div>
                                          <div>
                                            <p className="text-gray-500">–ì—Ä—É–∑</p>
                                            <p className="font-medium">{request.cargo_description || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                                          </div>
                                          <div>
                                            <p className="text-gray-500">–î–∞—Ç–∞ –∑–∞–±–æ—Ä–∞</p>
                                            <p className="font-medium">
                                              {request.pickup_date} {request.pickup_time_from}-{request.pickup_time_to}
                                            </p>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                    
                                    <div className="flex items-center space-x-2">
                                      <Button
                                        variant="outline"
                                        size="sm"
                                        onClick={async () => {
                                          const confirmDelete = window.confirm(
                                            `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –∑–∞–±–æ—Ä ${request.request_id}?`
                                          );
                                          
                                          if (confirmDelete) {
                                            try {
                                              const response = await apiCall(`/api/operator/pickup-requests/${request.request_id}`, 'DELETE');
                                              
                                              if (response && response.success) {
                                                showAlert('–ó–∞—è–≤–∫–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞', 'success');
                                                // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –∑–∞—è–≤–æ–∫ –Ω–∞ –∑–∞–±–æ—Ä
                                                await fetchAllPickupRequests();
                                              } else {
                                                showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∑–∞—è–≤–∫–∏: ${response.message || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`, 'error');
                                              }
                                            } catch (error) {
                                              console.error('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä:', error);
                                              showAlert(`–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏: ${error.message}`, 'error');
                                            }
                                          }
                                        }}
                                        className="flex items-center text-red-600 border-red-300 hover:bg-red-50 hover:border-red-400"
                                      >
                                        <Trash2 className="mr-1 h-3 w-3" />
                                        –£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É
                                      </Button>
                                    </div>
                                  </div>
                                </CardContent>
                              </Card>
                            ))}
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  )}

                  {/* –ü–†–û–ë–õ–ï–ú–ê 3: –°–ø–∏—Å–æ–∫ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤ */}
                  {(!activeTab || activeTab === 'cargo-management') && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Package className="mr-2 h-5 w-5" />
                            –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏
                            {fullyPlacedCargo.length > 0 && (
                              <Badge className="ml-2 bg-green-100 text-green-800">
                                {fullyPlacedCargo.length}
                              </Badge>
                            )}
                          </div>
                          <div className="flex space-x-2">
                            <Button 
                              variant="outline" 
                              size="sm"
                              onClick={() => fetchFullyPlacedCargo(fullyPlacedPage, fullyPlacedPerPage)}
                              loading={fullyPlacedLoading}
                            >
                              <RefreshCw className="mr-2 h-4 w-4" />
                              –û–±–Ω–æ–≤–∏—Ç—å
                            </Button>
                          </div>
                        </CardTitle>
                        <CardDescription>
                          –ó–∞—è–≤–∫–∏ —Å–æ –≤—Å–µ–º–∏ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–º–∏ –≥—Ä—É–∑–∞–º–∏ (5/5, 10/10, –∏ —Ç.–¥.)
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {fullyPlacedLoading ? (
                            <div className="text-center py-8">
                              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                              <p className="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫...</p>
                            </div>
                          ) : fullyPlacedCargo.length === 0 ? (
                            <div className="text-center py-8">
                              <Package className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">–ù–µ—Ç –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫</p>
                              <p className="text-sm text-gray-400 mt-2">
                                –ó–∞—è–≤–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å –∫–æ–≥–¥–∞ –≤—Å–µ –∏—Ö –≥—Ä—É–∑—ã –±—É–¥—É—Ç —Ä–∞–∑–º–µ—â–µ–Ω—ã
                              </p>
                            </div>
                          ) : (
                            fullyPlacedCargo.map((request) => (
                              <Card key={request.id} className="border-l-4 border-l-green-500 bg-green-50">
                                <CardContent className="p-4">
                                  <div className="flex items-start justify-between">
                                    <div className="flex-1">
                                      <div className="flex items-center space-x-2 mb-2">
                                        <span className="font-semibold text-lg">{request.cargo_name}</span>
                                        <Badge className="bg-green-100 text-green-800">
                                          ‚úÖ {request.progress_text}
                                        </Badge>
                                      </div>
                                      
                                      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm text-gray-600 mb-3">
                                        <div>
                                          <span className="font-medium">üìã –ó–∞—è–≤–∫–∞:</span>
                                          <div>{request.request_number}</div>
                                        </div>
                                        <div>
                                          <span className="font-medium">üë§ –û–ø–µ—Ä–∞—Ç–æ—Ä:</span>
                                          <div>{request.operator_name}</div>
                                        </div>
                                        <div>
                                          <span className="font-medium">üì¶ –ï–¥–∏–Ω–∏—Ü:</span>
                                          <div>{request.total_units}</div>
                                        </div>
                                        <div>
                                          <span className="font-medium">üìÖ –°–æ–∑–¥–∞–Ω–æ:</span>
                                          <div>{new Date(request.created_at).toLocaleDateString('ru-RU')}</div>
                                        </div>
                                      </div>
                                      
                                      {/* Individual units —Å —Ç–µ–º–∏ –∂–µ –∫–∞—Ä—Ç–æ—á–∫–∞–º–∏ –∏ –¥–∏–∑–∞–π–Ω–æ–º */}
                                      {request.individual_units && request.individual_units.length > 0 && (
                                        <div className="mt-4">
                                          <h4 className="font-medium text-sm text-gray-700 mb-2 flex items-center">
                                            <Grid3X3 className="mr-1 h-4 w-4" />
                                            –†–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã ({request.individual_units.length})
                                          </h4>
                                          <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                                            {request.individual_units.map((unit) => (
                                              <div key={unit.individual_number} className="bg-white border border-green-200 rounded-lg p-3">
                                                <div className="flex items-center justify-between mb-2">
                                                  <span className="font-mono text-sm font-medium text-green-700">
                                                    {unit.individual_number}
                                                  </span>
                                                  <Badge className="bg-green-100 text-green-700 text-xs">
                                                    ‚úÖ –†–∞–∑–º–µ—â–µ–Ω
                                                  </Badge>
                                                </div>
                                                
                                                <div className="text-xs text-gray-600 space-y-1">
                                                  <div>üìç <strong>–ú–µ—Å—Ç–æ:</strong> {unit.placement_info}</div>
                                                  <div>üè¢ <strong>–°–∫–ª–∞–¥:</strong> {unit.warehouse_name}</div>
                                                  <div>üë§ <strong>–û–ø–µ—Ä–∞—Ç–æ—Ä:</strong> {unit.placed_by}</div>
                                                  {unit.placed_at && (
                                                    <div>üïí <strong>–í—Ä–µ–º—è:</strong> {new Date(unit.placed_at).toLocaleString('ru-RU')}</div>
                                                  )}
                                                </div>
                                                
                                                {/* –ö–Ω–æ–ø–∫–∞ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è individual unit */}
                                                <Button
                                                  onClick={() => handleOpenIndividualUnitActions(unit)}
                                                  variant="outline"
                                                  size="sm"
                                                  className="w-full mt-2 text-xs"
                                                >
                                                  <Settings className="mr-1 h-3 w-3" />
                                                  –î–µ–π—Å—Ç–≤–∏—è
                                                </Button>
                                              </div>
                                            ))}
                                          </div>
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                </CardContent>
                              </Card>
                            ))
                          )}
                          
                          {/* –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫ */}
                          {fullyPlacedPagination.total_pages > 1 && (
                            <div className="mt-6">
                              <DataPagination 
                                currentPage={fullyPlacedPage}
                                totalPages={fullyPlacedPagination.total_pages}
                                totalItems={fullyPlacedPagination.total_items}
                                itemsPerPage={fullyPlacedPerPage}
                                onPageChange={(page) => {
                                  setFullyPlacedPage(page);
                                  fetchFullyPlacedCargo(page, fullyPlacedPerPage);
                                }}
                                onItemsPerPageChange={(perPage) => {
                                  setFullyPlacedPerPage(perPage);
                                  setFullyPlacedPage(1);
                                  fetchFullyPlacedCargo(1, perPage);
                                }}
                              />
                            </div>
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* –°–ø–∏—Å–æ–∫ –ø—Ä–∏–Ω—è—Ç—ã—Ö –≥—Ä—É–∑–æ–≤ */}
                  <Card>
                    <CardHeader>
                      <CardTitle className="flex items-center justify-between">
                        <div className="flex items-center space-x-2">
                          <Package className="h-5 w-5" />
                          <span>–ü—Ä–∏–Ω—è—Ç—ã–µ –≥—Ä—É–∑—ã</span>
                          <Badge variant="outline">{operatorCargo.length}</Badge>
                        </div>
                        <div className="flex items-center space-x-2">
                          {/* –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É */}
                          <Select value={operatorCargoFilter} onValueChange={setOperatorCargoFilter}>
                            <SelectTrigger className="w-48">
                              <SelectValue placeholder="–í—Å–µ –≥—Ä—É–∑—ã" />
                            </SelectTrigger>
                            <SelectContent>
                              <SelectItem value="all">–í—Å–µ –≥—Ä—É–∑—ã</SelectItem>
                              <SelectItem value="new_request">–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏</SelectItem>
                              <SelectItem value="awaiting_payment">–û–∂–∏–¥–∞–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞</SelectItem>
                              <SelectItem value="awaiting_placement">–û–∂–∏–¥–∞–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ</SelectItem>
                            </SelectContent>
                          </Select>
                          <Button onClick={() => fetchOperatorCargo()} size="sm" variant="outline">
                            <RefreshCw className="mr-2 h-4 w-4" />
                            –û–±–Ω–æ–≤–∏—Ç—å
                          </Button>
                        </div>
                      </CardTitle>
                    </CardHeader>
                    <CardContent>
                      <div className="space-y-4">
                        {operatorCargo.length === 0 ? (
                          <div className="text-center py-8">
                            <Package className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                            <p className="text-gray-500 mb-4">
                              {(operatorCargoFilter && operatorCargoFilter !== 'all')
                                ? `–ù–µ—Ç –≥—Ä—É–∑–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º "${operatorCargoFilter === 'new_request' ? '–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏' : operatorCargoFilter === 'awaiting_payment' ? '–û–∂–∏–¥–∞–µ—Ç—Å—è –æ–ø–ª–∞—Ç–∞' : '–û–∂–∏–¥–∞–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ'}"` 
                                : '–ù–µ—Ç –ø—Ä–∏–Ω—è—Ç—ã—Ö –≥—Ä—É–∑–æ–≤'
                              }
                            </p>
                            <Button onClick={() => setActiveTab('cargo-accept')}>
                              <Plus className="mr-2 h-4 w-4" />
                              –ü—Ä–∏–Ω—è—Ç—å –ø–µ—Ä–≤—ã–π –≥—Ä—É–∑
                            </Button>
                          </div>
                        ) : (
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  {user?.role === 'admin' && (
                                    <TableHead className="w-12">
                                      <input
                                        type="checkbox"
                                        checked={selectAllCargo}
                                        onChange={(e) => handleSelectAllCargo(e.target.checked, operatorCargo)}
                                        className="rounded border-gray-300"
                                      />
                                    </TableHead>
                                  )}
                                  <TableHead>–ù–æ–º–µ—Ä –≥—Ä—É–∑–∞</TableHead>
                                  <TableHead>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</TableHead>
                                  <TableHead>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</TableHead>
                                  <TableHead>–í–µ—Å</TableHead>
                                  <TableHead>–°—Ç–æ–∏–º–æ—Å—Ç—å</TableHead>
                                  <TableHead>–°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏</TableHead>
                                  <TableHead>–†–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ</TableHead>
                                  <TableHead>–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞</TableHead>
                                  <TableHead>–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {operatorCargo.map((item) => (
                                  <TableRow key={item.id}>
                                    {user?.role === 'admin' && (
                                      <TableCell>
                                        <input
                                          type="checkbox"
                                          checked={selectedCargo.includes(item.id)}
                                          onChange={(e) => handleCargoSelect(item.id, e.target.checked)}
                                          className="rounded border-gray-300"
                                        />
                                      </TableCell>
                                    )}
                                    <TableCell className="font-medium">{item.cargo_number}</TableCell>
                                    <TableCell>
                                      <div>
                                        <div className="font-medium flex items-center justify-between">
                                          <span>{item.sender_full_name}</span>
                                          {/* –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –¥–ª—è –≤—Å–µ—Ö –≥—Ä—É–∑–æ–≤ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è */}
                                          {(user?.role === 'admin' || user?.role === 'warehouse_operator') && (
                                            <Button
                                              size="sm"
                                              variant="ghost"
                                              onClick={() => generateBulkQRForSender({
                                                sender_full_name: item.sender_full_name,
                                                sender_phone: item.sender_phone
                                              })}
                                              className="ml-2 text-blue-600 hover:bg-blue-50 p-1 h-auto"
                                              title="–°–æ–∑–¥–∞—Ç—å QR –∫–æ–¥—ã –¥–ª—è –≤—Å–µ—Ö –≥—Ä—É–∑–æ–≤ —ç—Ç–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è"
                                            >
                                              <QrCode className="h-3 w-3" />
                                            </Button>
                                          )}
                                        </div>
                                        <div className="text-sm text-gray-500">{item.sender_phone}</div>
                                      </div>
                                    </TableCell>
                                    <TableCell>
                                      <div>
                                        <div className="font-medium">{item.recipient_full_name}</div>
                                        <div className="text-sm text-gray-500">{item.recipient_phone}</div>
                                        <div className="text-sm text-gray-500">{item.recipient_address}</div>
                                      </div>
                                    </TableCell>
                                    <TableCell>{item.weight} –∫–≥</TableCell>
                                    <TableCell>{item.declared_value} ‚ÇΩ</TableCell>
                                    <TableCell>
                                      <div className="flex flex-col space-y-1">
                                        <Badge variant={getProcessingStatusBadgeVariant(item.processing_status || 'payment_pending')}>
                                          {getProcessingStatusLabel(item.processing_status || 'payment_pending')}
                                        </Badge>
                                        {/* –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ */}
                                        <div className="flex space-x-1">
                                          {item.processing_status === 'payment_pending' && (
                                            <Button
                                              size="sm"
                                              onClick={() => handlePaymentAcceptance(item.id, item.cargo_number)}
                                              className="text-xs px-3 py-1 bg-green-600 hover:bg-green-700 text-white font-medium"
                                            >
                                              üí∞ –û–ø–ª–∞—á–µ–Ω
                                            </Button>
                                          )}
                                          {item.processing_status === 'paid' && (
                                            <Button
                                              size="sm"
                                              variant="outline"
                                              onClick={() => updateCargoProcessingStatus(item.id, 'invoice_printed')}
                                              className="text-xs px-2 py-1"
                                            >
                                              üìÑ –ù–∞–∫–ª–∞–¥–Ω–∞—è
                                            </Button>
                                          )}
                                          {item.processing_status === 'invoice_printed' && (
                                            <Button
                                              size="sm"
                                              variant="outline"
                                              onClick={() => updateCargoProcessingStatus(item.id, 'placed')}
                                              className="text-xs px-2 py-1"
                                            >
                                              üì¶ –†–∞–∑–º–µ—Å—Ç–∏—Ç—å
                                            </Button>
                                          )}
                                        </div>
                                      </div>
                                    </TableCell>
                                    <TableCell>
                                      {item.warehouse_location ? (
                                        <div className="text-sm">
                                          <div className="font-medium">{warehouses.find(w => w.id === item.warehouse_id)?.name || '–°–∫–ª–∞–¥'}</div>
                                          <div className="text-blue-600">{item.warehouse_location}</div>
                                        </div>
                                      ) : (
                                        <Badge variant="outline">–ù–µ —Ä–∞–∑–º–µ—â–µ–Ω</Badge>
                                      )}
                                    </TableCell>
                                    <TableCell>
                                      {new Date(item.created_at).toLocaleDateString('ru-RU')} {new Date(item.created_at).toLocaleTimeString('ru-RU')}
                                    </TableCell>
                                    <TableCell>
                                      <div className="flex flex-col space-y-1">
                                        <Button
                                          size="sm"
                                          variant="outline"
                                          onClick={() => printCargoInvoice(item)}
                                          className="flex items-center"
                                          disabled={!item.processing_status || item.processing_status === 'payment_pending'}
                                        >
                                          <Printer className="mr-1 h-4 w-4" />
                                          –ù–∞–∫–ª–∞–¥–Ω–∞—è
                                        </Button>
                                        {/* QR –∫–æ–¥ –¥–æ—Å—Ç—É–ø–µ–Ω –≤—Å–µ–≥–¥–∞ */}
                                        <Button
                                          size="sm"
                                          variant="outline"
                                          onClick={() => {
                                            setQrGenerateCargoNumber(item.cargo_number);
                                            setShowQRGenerateModal(true);
                                          }}
                                          className="flex items-center text-xs px-2 py-1 text-blue-600 border-blue-300 hover:bg-blue-50"
                                        >
                                          <QrCode className="mr-1 h-3 w-3" />
                                          QR –∫–æ–¥
                                        </Button>
                                        
                                        {/* –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –∏ –ü–µ—á–∞—Ç—å QR –∫–æ–¥–æ–≤ –¥–ª—è –∑–∞—è–≤–∫–∏ */}
                                        <Button
                                          size="sm"
                                          variant="outline"
                                          onClick={() => handleGenerateRequestQR(item)}
                                          className="flex items-center text-xs px-2 py-1 text-orange-600 border-orange-300 hover:bg-orange-50"
                                          title="–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥ –¥–ª—è –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤—Å–µ—Ö –≥—Ä—É–∑–∞—Ö"
                                        >
                                          <QrCode className="mr-1 h-3 w-3" />
                                          QR –∑–∞—è–≤–∫–∏
                                        </Button>
                                        
                                        {/* –ö–Ω–æ–ø–∫–∞ –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –¥–ª—è –æ–ø–ª–∞—á–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤ */}
                                        {(item.processing_status === 'paid' || item.processing_status === 'invoice_printed') && !item.warehouse_location && (
                                          <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => {
                                              setSelectedCargoForDetailView(item);
                                              setQuickPlacementModal(true);
                                            }}
                                            className="flex items-center text-xs px-2 py-1 bg-green-50 hover:bg-green-100"
                                          >
                                            <Grid3X3 className="mr-1 h-3 w-3" />
                                            –†–∞–∑–º–µ—Å—Ç–∏—Ç—å
                                          </Button>
                                        )}
                                        
                                        {/* –ö–Ω–æ–ø–∫–∞ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ */}
                                        {(user.role === 'admin' || user.role === 'warehouse_operator') && (
                                          <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => openAdminRepeatOrder(item)}
                                            className="flex items-center text-xs px-2 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 hover:text-blue-700"
                                            title="–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑ —Å —Ç–µ–º–∏ –∂–µ –¥–∞–Ω–Ω—ã–º–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è"
                                          >
                                            <Copy className="mr-1 h-3 w-3" />
                                            –ü–æ–≤—Ç–æ—Ä–∏—Ç—å
                                          </Button>
                                        )}

                                        {/* –ö–Ω–æ–ø–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è –≥—Ä—É–∑–∞ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞) */}
                                        {user?.role === 'admin' && (
                                          <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => handleDeleteCargo(item.id, operatorCargo)}
                                            className="flex items-center text-xs px-2 py-1 text-red-600 border-red-300 hover:bg-red-50"
                                            title="–£–¥–∞–ª–∏—Ç—å –≥—Ä—É–∑"
                                          >
                                            <Trash2 className="mr-1 h-3 w-3" />
                                            –£–¥–∞–ª–∏—Ç—å
                                          </Button>
                                        )}
                                      </div>
                                    </TableCell>
                                  </TableRow>
                                ))}
                              </TableBody>
                            </Table>
                          )}
                        </div>
                      </CardContent>
                    </Card>

                  {/* –†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞ - –£–ª—É—á—à–µ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–æ —Å–∫–∞–Ω–µ—Ä–æ–º */}
                  {activeTab === 'cargo-placement' && (
                    <div className="space-y-6">
                      {/* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */}
                      {(scannerActive || scannedCargoData || placementInProgress) && (
                        <Card className="border-2 border-blue-500 bg-blue-50">
                          <CardHeader>
                            <CardTitle className="flex items-center justify-between">
                              <div className="flex items-center">
                                <Camera className="mr-2 h-5 w-5 text-blue-600" />
                                {scannerMode === 'cargo-barcode' ? '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ –≥—Ä—É–∑–∞' :
                                 scannerMode === 'cell-qr' ? '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR-–∫–æ–¥–∞ —è—á–µ–π–∫–∏' :
                                 placementInProgress ? '–†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞...' : '–ì–æ—Ç–æ–≤–æ –∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—é'}
                              </div>
                              {(scannerActive || scannedCargoData) && (
                                <Button 
                                  variant="outline" 
                                  size="sm"
                                  onClick={resetScannerState}
                                  className="text-red-600 hover:text-red-700"
                                >
                                  <X className="h-4 w-4" />
                                  –û—Ç–º–µ–Ω–∏—Ç—å
                                </Button>
                              )}
                            </CardTitle>
                            <CardDescription>
                              {scannerMode === 'cargo-barcode' && '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥ –≥—Ä—É–∑–∞ –¥–ª—è –µ–≥–æ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏'}
                              {scannerMode === 'cell-qr' && '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ —Å–≤–æ–±–æ–¥–Ω–æ–π —è—á–µ–π–∫–∏ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è'}
                              {placementInProgress && '–í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞ –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é —è—á–µ–π–∫—É...'}
                              {scannerMode === 'none' && scannedCargoData && !placementInProgress && '–ì—Ä—É–∑ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω, –æ–∂–∏–¥–∞–µ—Ç—Å—è –≤—ã–±–æ—Ä —è—á–µ–π–∫–∏'}
                            </CardDescription>
                          </CardHeader>
                          <CardContent>
                            {/* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫–∞–º–µ—Ä—ã */}
                            {scannerActive && (
                              <div className="mb-6">
                                <div className="bg-black rounded-lg overflow-hidden" style={{maxWidth: '500px', margin: '0 auto'}}>
                                  <div 
                                    id="qr-reader" 
                                    className="w-full"
                                    style={{
                                      width: '100%',
                                      maxWidth: '500px',
                                      minHeight: '300px'
                                    }}
                                  />
                                </div>
                                <div className="text-center mt-4 space-y-2">
                                  <p className="text-sm text-gray-600">
                                    {scannerMode === 'cargo-barcode' ? 
                                      '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ —à—Ç—Ä–∏—Ö-–∫–æ–¥ –≥—Ä—É–∑–∞' : 
                                      '–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR-–∫–æ–¥ —è—á–µ–π–∫–∏'}
                                  </p>
                                  {cameraPermission === false && (
                                    <p className="text-sm text-red-600">
                                      –î–ª—è —Ä–∞–±–æ—Ç—ã —Å–∫–∞–Ω–µ—Ä–∞ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –∫–∞–º–µ—Ä—ã
                                    </p>
                                  )}
                                </div>
                              </div>
                            )}

                            {/* –°—Ç–∞—Ç—É—Å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */}
                            <div className="space-y-4">
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–º –≥—Ä—É–∑–µ */}
                                {scannedCargoData && (
                                  <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
                                    <h4 className="font-medium text-green-800 mb-2 flex items-center">
                                      <CheckCircle className="mr-2 h-4 w-4" />
                                      –ì—Ä—É–∑ –∏–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω
                                    </h4>
                                    <p><strong>–ù–æ–º–µ—Ä:</strong> {scannedCargoData.cargo_number}</p>
                                    <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {scannedCargoData.description || scannedCargoData.cargo_name}</p>
                                    <p><strong>–í–µ—Å:</strong> {scannedCargoData.weight} –∫–≥</p>
                                    <p><strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> {scannedCargoData.sender_full_name}</p>
                                  </div>
                                )}
                                
                                {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —è—á–µ–π–∫–µ */}
                                {scannedCellData && (
                                  <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                    <h4 className="font-medium text-blue-800 mb-2 flex items-center">
                                      <Grid3X3 className="mr-2 h-4 w-4" />
                                      –Ø—á–µ–π–∫–∞ –≤—ã–±—Ä–∞–Ω–∞
                                    </h4>
                                    <p><strong>–°–∫–ª–∞–¥:</strong> {scannedCellData.warehouse_id}</p>
                                    <p><strong>–ë–ª–æ–∫:</strong> {scannedCellData.block_number}</p>
                                    <p><strong>–ü–æ–ª–∫–∞:</strong> {scannedCellData.shelf_number}</p>
                                    <p><strong>–Ø—á–µ–π–∫–∞:</strong> {scannedCellData.cell_number}</p>
                                  </div>
                                )}
                              </div>
                              
                              {/* –û—à–∏–±–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è */}
                              {scannerError && (
                                <div className="p-4 bg-red-50 border border-red-200 rounded-lg">
                                  <p className="text-red-800 flex items-center">
                                    <XCircle className="mr-2 h-4 w-4" />
                                    {scannerError}
                                  </p>
                                </div>
                              )}
                              
                              {/* –ü—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è */}
                              {placementInProgress && (
                                <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                  <p className="text-yellow-800 flex items-center">
                                    <RefreshCw className="mr-2 h-4 w-4 animate-spin" />
                                    –†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...
                                  </p>
                                </div>
                              )}
                              
                              {/* –¢–µ—Å—Ç–æ–≤—ã–µ –∫–Ω–æ–ø–∫–∏ (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏) */}
                              {process.env.NODE_ENV === 'development' && (
                                <div className="flex flex-wrap gap-2 p-3 bg-gray-100 rounded-lg border-2 border-dashed">
                                  <Button 
                                    size="sm" 
                                    variant="outline"
                                    onClick={() => simulateBarcodeScan('2501999271')}
                                  >
                                    –¢–µ—Å—Ç —à—Ç—Ä–∏—Ö-–∫–æ–¥–∞ –≥—Ä—É–∑–∞
                                  </Button>
                                  <Button 
                                    size="sm" 
                                    variant="outline"
                                    onClick={() => simulateBarcodeScan('WH001:1:2:5')}
                                  >
                                    –¢–µ—Å—Ç QR-–∫–æ–¥–∞ —è—á–µ–π–∫–∏
                                  </Button>
                                </div>
                              )}
                            </div>
                          </CardContent>
                        </Card>
                      )}

                      {/* –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å */}
                      <Card>
                        <CardHeader>
                          <CardTitle className="flex items-center justify-between">
                            <div className="flex items-center">
                              <Grid3X3 className="mr-2 h-5 w-5" />
                              –†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞
                            </div>
                            <div className="flex space-x-2">
                              {/* –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞ */}
                              <Button 
                                onClick={() => setShowQRGenerateModal(true)}
                                variant="outline"
                                size="sm"
                                className="text-blue-600 border-blue-300 hover:bg-blue-50"
                              >
                                <QrCode className="mr-2 h-4 w-4" />
                                –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR
                              </Button>
                              
                              {/* –ö–Ω–æ–ø–∫–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞ - –∫–∞–º–µ—Ä–∞ –∏ –≤–Ω–µ—à–Ω–∏–π —Å–∫–∞–Ω–µ—Ä */}
                              {!placementActive && !externalScannerActive && (
                                <>
                                  <Button 
                                    onClick={openCargoPlacementPage}
                                    className="bg-green-600 hover:bg-green-700"
                                    size="sm"
                                  >
                                    <Camera className="mr-2 h-4 w-4" />
                                    –†–∞–∑–º–µ—â–µ–Ω–∏–µ (–ö–∞–º–µ—Ä–∞)
                                  </Button>
                                  <Button 
                                    onClick={openCargoPlacementModal}
                                    className="bg-blue-600 hover:bg-blue-700"
                                    size="sm"
                                  >
                                    <Scan className="mr-2 h-4 w-4" />
                                    –†–∞–∑–º–µ—â–µ–Ω–∏–µ (–°–∫–∞–Ω–µ—Ä)
                                  </Button>
                                </>
                              )}
                              
                              {placementActive && (
                                <Button 
                                  onClick={stopCargoPlacement}
                                  variant="outline"
                                  size="sm"
                                  className="text-red-600 border-red-300 hover:bg-red-50"
                                >
                                  <X className="mr-2 h-4 w-4" />
                                  –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ
                                </Button>
                              )}

                              {externalScannerActive && (
                                <Button 
                                  onClick={stopExternalScannerPlacement}
                                  variant="outline"
                                  size="sm"
                                  className="text-red-600 border-red-300 hover:bg-red-50"
                                >
                                  <X className="mr-2 h-4 w-4" />
                                  –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–µ—Ä
                                </Button>
                              )}
                            </div>
                          </CardTitle>
                          <CardDescription>
                            –û–ø–ª–∞—á–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã –∏ –≥—Ä—É–∑—ã –∏–∑ –∑–∞—è–≤–æ–∫ –Ω–∞ –∑–∞–±–æ—Ä, –≥–æ—Ç–æ–≤—ã–µ –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é –Ω–∞ —Å–∫–ª–∞–¥–µ. 
                            –ì—Ä—É–∑—ã —Å –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–æ–º üöö –ø–æ—Å—Ç—É–ø–∏–ª–∏ —á–µ—Ä–µ–∑ –∫—É—Ä—å–µ—Ä—Å–∫–∏–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä. 
                            –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Å–∫–∞–Ω–µ—Ä –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è.
                          </CardDescription>
                        </CardHeader>
                        <CardContent>
                          {/* –ù–û–í–û–ï: –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ –∏ —Ñ–∏–ª—å—Ç—Ä—ã */}
                          <div className="mb-6 space-y-4">
                            {/* –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ */}
                            <div className="flex items-center justify-between bg-gray-50 p-4 rounded-lg">
                              <div className="space-y-2">
                                <h4 className="font-medium text-gray-800">–†–µ–∂–∏–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è</h4>
                                <div className="flex items-center space-x-4">
                                  <label className="flex items-center space-x-2 cursor-pointer">
                                    <input
                                      type="radio"
                                      checked={!useIndividualCards}
                                      onChange={() => setUseIndividualCards(false)}
                                      className="w-4 h-4 text-blue-600"
                                    />
                                    <span className="text-sm">–ö–∞—Ä—Ç–æ—á–∫–∏ –∑–∞—è–≤–æ–∫</span>
                                  </label>
                                  <label className="flex items-center space-x-2 cursor-pointer">
                                    <input
                                      type="radio"
                                      checked={useIndividualCards}
                                      onChange={() => setUseIndividualCards(true)}
                                      className="w-4 h-4 text-blue-600"
                                    />
                                    <span className="text-sm font-medium text-blue-600">Individual Units –∫–∞—Ä—Ç–æ—á–∫–∏</span>
                                  </label>
                                </div>
                              </div>
                              <Button
                                onClick={() => {
                                  if (useIndividualCards) {
                                    fetchIndividualUnitsForPlacement(individualUnitsPage, individualUnitsPerPage, cargoTypeFilter, placementStatusFilter);
                                  } else {
                                    fetchAvailableCargoForPlacement(availableCargoPage, availableCargoPerPage);
                                  }
                                }}
                                size="sm"
                                variant="outline"
                              >
                                <RefreshCw className="mr-2 h-4 w-4" />
                                –û–±–Ω–æ–≤–∏—Ç—å
                              </Button>
                            </div>

                            {/* –§–∏–ª—å—Ç—Ä—ã –¥–ª—è individual units */}
                            {useIndividualCards && (
                              <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                                <div className="flex items-center justify-between mb-3">
                                  <h4 className="font-medium text-blue-800 flex items-center">
                                    <Filter className="mr-2 h-4 w-4" />
                                    –§–∏–ª—å—Ç—Ä—ã –∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞
                                  </h4>
                                  
                                  {/* –ù–û–í–û–ï: –ö–Ω–æ–ø–∫–∞ –º–∞—Å—Å–æ–≤–æ–π –ø–µ—á–∞—Ç–∏ QR */}
                                  <Button
                                    onClick={handleMassPrintQR}
                                    className="bg-purple-600 hover:bg-purple-700 text-white"
                                    size="sm"
                                    disabled={individualUnitsForPlacement.length === 0 || qrGenerationProgress}
                                  >
                                    {qrGenerationProgress ? (
                                      <>
                                        <RefreshCw className="mr-2 h-4 w-4 animate-spin" />
                                        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR...
                                      </>
                                    ) : (
                                      <>
                                        <Printer className="mr-2 h-4 w-4" />
                                        –ü–µ—á–∞—Ç—å QR –¥–ª—è –≤—Å–µ—Ö ({individualUnitsForPlacement.length} –µ–¥–∏–Ω–∏—Ü)
                                      </>
                                    )}
                                  </Button>
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-3 gap-4">
                                  {/* –§–∏–ª—å—Ç—Ä –ø–æ —Ç–∏–ø—É –≥—Ä—É–∑–∞ */}
                                  <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                      –¢–∏–ø –≥—Ä—É–∑–∞
                                    </label>
                                    <select
                                      value={cargoTypeFilter}
                                      onChange={(e) => handleCargoTypeFilterChange(e.target.value)}
                                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                    >
                                      <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                                      <option value="01">–¢–∏–ø 01</option>
                                      <option value="02">–¢–∏–ø 02</option>
                                      <option value="03">–¢–∏–ø 03</option>
                                      <option value="04">–¢–∏–ø 04</option>
                                      <option value="05">–¢–∏–ø 05</option>
                                    </select>
                                  </div>

                                  {/* –§–∏–ª—å—Ç—Ä –ø–æ —Å—Ç–∞—Ç—É—Å—É —Ä–∞–∑–º–µ—â–µ–Ω–∏—è */}
                                  <div>
                                    <label className="block text-sm font-medium text-gray-700 mb-1">
                                      –°—Ç–∞—Ç—É—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
                                    </label>
                                    <select
                                      value={placementStatusFilter}
                                      onChange={(e) => handlePlacementStatusFilterChange(e.target.value)}
                                      className="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                                    >
                                      <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                      <option value="awaiting">–û–∂–∏–¥–∞–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</option>
                                      <option value="placed">–†–∞–∑–º–µ—â–µ–Ω</option>
                                    </select>
                                  </div>

                                  {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ */}
                                  <div className="flex items-end">
                                    <div className="text-sm text-gray-600">
                                      <div className="font-medium">–ù–∞–π–¥–µ–Ω–æ –µ–¥–∏–Ω–∏—Ü: {individualUnitsPagination.total || 0}</div>
                                      <div className="text-xs">–°—Ç—Ä–∞–Ω–∏—Ü–∞ {individualUnitsPagination.page || 1} –∏–∑ {individualUnitsPagination.total_pages || 1}</div>
                                    </div>
                                  </div>
                                </div>
                                
                                {/* –ë—ã—Å—Ç—Ä—ã–µ —Ñ–∏–ª—å—Ç—Ä—ã */}
                                <div className="mt-3 flex flex-wrap gap-2">
                                  <button
                                    onClick={() => {
                                      setCargoTypeFilter('');
                                      setPlacementStatusFilter('awaiting');
                                      handlePlacementStatusFilterChange('awaiting');
                                    }}
                                    className="px-3 py-1 text-xs bg-red-100 text-red-700 rounded-full hover:bg-red-200 transition-colors"
                                  >
                                    –¢–æ–ª—å–∫–æ –æ–∂–∏–¥–∞—é—â–∏–µ
                                  </button>
                                  <button
                                    onClick={() => {
                                      setCargoTypeFilter('');
                                      setPlacementStatusFilter('placed');
                                      handlePlacementStatusFilterChange('placed');
                                    }}
                                    className="px-3 py-1 text-xs bg-green-100 text-green-700 rounded-full hover:bg-green-200 transition-colors"
                                  >
                                    –¢–æ–ª—å–∫–æ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ
                                  </button>
                                  <button
                                    onClick={() => {
                                      setCargoTypeFilter('');
                                      setPlacementStatusFilter('');
                                      handleCargoTypeFilterChange('');
                                      handlePlacementStatusFilterChange('');
                                    }}
                                    className="px-3 py-1 text-xs bg-gray-100 text-gray-700 rounded-full hover:bg-gray-200 transition-colors"
                                  >
                                    –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                                  </button>
                                </div>
                              </div>
                            )}
                          </div>

                          <Button onClick={() => fetchAvailableCargoForPlacement(availableCargoPage, availableCargoPerPage)} className="mb-4">
                            <RefreshCw className="mr-2 h-4 w-4" />
                            –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤
                          </Button>
                          
                          {/* –õ–µ–≥–µ–Ω–¥–∞ —Ü–≤–µ—Ç–æ–≤ —Å–∫–ª–∞–¥–æ–≤ */}
                          {availableCargoForPlacement.length > 0 && (
                            <div className="mb-6 p-4 bg-gray-50 rounded-lg border">
                              <h4 className="font-semibold text-sm text-gray-700 mb-3 flex items-center">
                                <Palette className="mr-2 h-4 w-4" />
                                –¶–≤–µ—Ç–æ–≤–∞—è —Å—Ö–µ–º–∞ –ø–æ —Å–∫–ª–∞–¥–∞–º
                              </h4>
                              <div className="flex flex-wrap gap-3">
                                {getWarehouseLegend().map((item, index) => (
                                  <div key={index} className="flex items-center space-x-2">
                                    <div className={`w-4 h-4 ${item.color} rounded`}></div>
                                    <span className={`text-sm font-medium ${item.textColor}`}>
                                      {item.name}
                                    </span>
                                  </div>
                                ))}
                              </div>
                              <p className="text-xs text-gray-500 mt-2">
                                –ö–∞–∂–¥—ã–π –≥—Ä—É–∑ –æ–∫—Ä–∞—à–µ–Ω –≤ —Ü–≤–µ—Ç —Å–≤–æ–µ–≥–æ —Å–∫–ª–∞–¥–∞ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞ –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
                              </p>
                            </div>
                          )}
                          
                          {/* –ù–û–í–û–ï: –ü–∞–Ω–µ–ª—å –º–∞—Å—Å–æ–≤–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è */}
                          {availableCargoForPlacement.length > 0 && (
                            <div className="mb-6 p-4 bg-red-50 border border-red-200 rounded-lg">
                              <h4 className="font-semibold text-sm text-red-700 mb-3 flex items-center">
                                <Trash2 className="mr-2 h-4 w-4" />
                                –ú–∞—Å—Å–æ–≤–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –≥—Ä—É–∑–æ–≤ –∏–∑ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
                              </h4>
                              
                              <div className="flex items-center justify-between">
                                <div className="flex items-center space-x-4">
                                  <label className="flex items-center space-x-2 cursor-pointer">
                                    <input
                                      type="checkbox"
                                      checked={selectedCargoForDeletion.length === availableCargoForPlacement.length && availableCargoForPlacement.length > 0}
                                      onChange={handleSelectAllCargoForDeletion}
                                      className="h-4 w-4 text-red-600 focus:ring-red-500 border-gray-300 rounded"
                                    />
                                    <span className="text-sm text-gray-700">
                                      –í—ã–±—Ä–∞—Ç—å –≤—Å–µ ({availableCargoForPlacement.length})
                                    </span>
                                  </label>
                                  
                                  {selectedCargoForDeletion.length > 0 && (
                                    <span className="text-sm text-red-600 font-medium">
                                      –í—ã–±rano: {selectedCargoForDeletion.length}
                                    </span>
                                  )}
                                </div>
                                
                                <div className="flex space-x-2">
                                  {selectedCargoForDeletion.length > 0 && (
                                    <>
                                      <Button
                                        onClick={() => setSelectedCargoForDeletion([])}
                                        variant="outline"
                                        size="sm"
                                        className="text-gray-600 border-gray-300"
                                      >
                                        –°–Ω—è—Ç—å –≤—ã–¥–µ–ª–µ–Ω–∏–µ
                                      </Button>
                                      
                                      <Button
                                        onClick={handleBulkDeleteCargoFromPlacement}
                                        size="sm"
                                        className="bg-red-600 hover:bg-red-700 text-white"
                                      >
                                        <Trash2 className="mr-2 h-4 w-4" />
                                        –£–¥–∞–ª–∏—Ç—å ({selectedCargoForDeletion.length})
                                      </Button>
                                    </>
                                  )}
                                </div>
                              </div>
                              
                              <p className="text-xs text-red-600 mt-2">
                                ‚ö†Ô∏è –£–¥–∞–ª–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã –±—É–¥—É—Ç –∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ —Å–ø–∏—Å–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∏ –ø–æ–ª—É—á–∞—Ç —Å—Ç–∞—Ç—É—Å "removed_from_placement"
                              </p>
                            </div>
                          )}
                          
                          <div className="space-y-4">
                            {/* –£–°–õ–û–í–ù–û–ï –û–¢–û–ë–†–ê–ñ–ï–ù–ò–ï: –°—Ç–∞—Ä—ã–π —Ä–µ–∂–∏–º (–∫–∞—Ä—Ç–æ—á–∫–∏ –∑–∞—è–≤–æ–∫) –∏–ª–∏ –Ω–æ–≤—ã–π —Ä–µ–∂–∏–º (individual units) */}
                            {!useIndividualCards ? (
                              /* –°–¢–ê–†–´–ô –†–ï–ñ–ò–ú: Request-based –∫–∞—Ä—Ç–æ—á–∫–∏ */
                              availableCargoForPlacement.length === 0 ? (
                                <div className="text-center py-8">
                                  <Package className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                                  <p className="text-gray-500">–ù–µ—Ç –≥—Ä—É–∑–æ–≤, –æ–∂–∏–¥–∞—é—â–∏—Ö —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</p>
                                  <p className="text-sm text-gray-400 mt-2">–û–ø–ª–∞—á–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã –∏–∑ "–°–ø–∏—Å–∫–∞ –≥—Ä—É–∑–æ–≤" –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                                  <Button 
                                    variant="outline" 
                                    className="mt-4"
                                    onClick={() => setActiveTab('cargo-list')}
                                  >
                                    –ü–µ—Ä–µ–π—Ç–∏ –∫ —Å–ø–∏—Å–∫—É –≥—Ä—É–∑–æ–≤
                                  </Button>
                                </div>
                              ) : (
                                <div className="grid gap-4 grid-cols-1 lg:grid-cols-2 xl:grid-cols-3">
                                  {availableCargoForPlacement.filter(item => item && item.id).map((item) => {
                                    const warehouseColors = getWarehouseColor(item.warehouse_name);
                                    return (
                                      <Card key={`cargo-${item.id}`} className={`${warehouseColors.border} ${warehouseColors.bg} border-l-4`}>
                                        <CardContent className="p-4">
                                          <h3 className="font-bold text-lg text-blue-600 mb-2">‚Ññ{item.cargo_number}</h3>
                                          <div className="space-y-2 text-sm">
                                            <div>
                                              <span className="font-medium">üèôÔ∏è –ì–æ—Ä–æ–¥ –≤—ã–¥–∞—á–∏:</span> {item.delivery_city || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                                            </div>
                                            <div>
                                              <span className="font-medium">üè¢ –ú–∞—Ä—à—Ä—É—Ç:</span> {item.source_warehouse_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'} ‚Üí {item.target_warehouse_name || '–ù–µ–∏–∑–≤–µ—Å—Ç–µ–Ω'}
                                            </div>
                                            <div>
                                              <span className="font-medium">üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å:</span> {item.recipient_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                                            </div>
                                            <div>
                                              <span className="font-medium">üìÖ –ü—Ä–∏–Ω—è—Ç:</span> {item.created_date ? new Date(item.created_date).toLocaleDateString('ru-RU') : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                                            </div>
                                            <div>
                                              <span className="font-medium">üöö –°–ø–æ—Å–æ–±:</span> {item.delivery_method || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                                            </div>
                                            <div>
                                              <span className="font-medium">üí∞ –û–ø–ª–∞—Ç–∞:</span> {item.payment_method || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                                            </div>
                                          </div>
                                          
                                          <div className="bg-gray-50 p-3 rounded-lg mt-3">
                                            <h4 className="font-medium text-sm mb-2">üì¶ –°–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤ ({(item.cargo_items || []).length} —Ç–∏–ø–æ–≤)</h4>
                                            {(item.cargo_items || []).length > 0 ? (
                                              item.cargo_items.map((cargoItem, index) => (
                                                <div key={index} className="bg-white p-2 rounded border text-xs mb-1">
                                                  <div className="flex justify-between items-center">
                                                    <div>
                                                      <p className="font-medium text-gray-800">
                                                        –ì—Ä—É–∑{item.cargo_number}/{String(index + 1).padStart(2, '0')} "{cargoItem.cargo_name || `–ì—Ä—É–∑ ‚Ññ${index + 1}`}"
                                                      </p>
                                                      <p className="text-gray-500 text-xs">
                                                        {cargoItem.quantity || 1} —à—Ç ‚Ä¢ {cargoItem.weight || 0} –∫–≥
                                                      </p>
                                                      {/* –ù–û–í–û–ï: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞ */}
                                                      {cargoItem.individual_items && cargoItem.individual_items.length > 0 && (
                                                        <div className="mt-1 flex flex-wrap gap-1">
                                                          {cargoItem.individual_items.slice(0, 3).map((unit, unitIndex) => (
                                                            <span 
                                                              key={unitIndex} 
                                                              className={`px-1 py-0.5 text-xs rounded ${
                                                                unit.is_placed 
                                                                  ? 'bg-green-100 text-green-700' 
                                                                  : 'bg-gray-100 text-gray-600'
                                                              }`}
                                                              title={unit.individual_number}
                                                            >
                                                              {unit.individual_number.split('/').slice(-1)[0]}
                                                            </span>
                                                          ))}
                                                          {cargoItem.individual_items.length > 3 && (
                                                            <span className="px-1 py-0.5 text-xs bg-gray-100 text-gray-500 rounded">
                                                              +{cargoItem.individual_items.length - 3}
                                                            </span>
                                                          )}
                                                        </div>
                                                      )}
                                                    </div>
                                                    <div className="text-right">
                                                      {/* –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ individual_items –¥–ª—è –ø–æ–¥—Å—á–µ—Ç–∞ */}
                                                      {(() => {
                                                        let totalCount, placedCount;
                                                        
                                                        if (cargoItem.individual_items && cargoItem.individual_items.length > 0) {
                                                          // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ individual_items
                                                          totalCount = cargoItem.individual_items.length;
                                                          placedCount = cargoItem.individual_items.filter(unit => unit.is_placed === true).length;
                                                        } else {
                                                          // Fallback –∫ —Å—Ç–∞—Ä—ã–º –ø–æ–ª—è–º
                                                          totalCount = cargoItem.quantity || 1;
                                                          placedCount = cargoItem.placed_count || 0;
                                                        }
                                                        
                                                        return (
                                                          <>
                                                            <p className="font-medium text-blue-600">
                                                              –†–∞–∑–º–µ—â–µ–Ω–æ {placedCount}/{totalCount}
                                                            </p>
                                                            <p className={`text-xs ${
                                                              placedCount === totalCount && totalCount > 0
                                                                ? 'text-green-600' 
                                                                : placedCount > 0 
                                                                  ? 'text-yellow-600' 
                                                                  : 'text-red-600'
                                                            }`}>
                                                              {placedCount === totalCount && totalCount > 0
                                                                ? '–†–∞–∑–º–µ—â–µ–Ω–æ' 
                                                                : placedCount > 0 
                                                                  ? '–ß–∞—Å—Ç–∏—á–Ω–æ' 
                                                                  : '–ñ–¥—ë—Ç'}
                                                            </p>
                                                          </>
                                                        );
                                                      })()}
                                                    </div>
                                                  </div>
                                                </div>
                                              ))
                                            ) : (
                                              <div className="bg-white p-2 rounded border text-xs">
                                                <div className="flex justify-between">
                                                  <div>
                                                    <p className="font-medium">–ì—Ä—É–∑{item.cargo_number}/01 ‚Ññ1</p>
                                                    <p className="text-gray-500">1 —à—Ç ‚Ä¢ {item.weight || 0} –∫–≥</p>
                                                  </div>
                                                  <span className="text-red-600 text-xs">–ñ–¥—ë—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ</span>
                                                </div>
                                              </div>
                                            )}
                                            
                                            <div className="mt-2 pt-2 border-t text-sm">
                                              <div className="flex justify-between items-center">
                                                <span className="font-medium">–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å:</span>
                                                <div className="flex items-center space-x-2">
                                                  {(() => {
                                                    // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–æ–¥—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö individual_items
                                                    let totalItems = 0;
                                                    let placedItems = 0;
                                                    
                                                    (item.cargo_items || []).forEach(cargoItem => {
                                                      if (cargoItem.individual_items && cargoItem.individual_items.length > 0) {
                                                        // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ individual_items
                                                        totalItems += cargoItem.individual_items.length;
                                                        placedItems += cargoItem.individual_items.filter(unit => unit.is_placed === true).length;
                                                      } else {
                                                        // Fallback –∫ quantity –µ—Å–ª–∏ individual_items –Ω–µ—Ç
                                                        totalItems += (cargoItem.quantity || 1);
                                                        placedItems += (cargoItem.placed_count || 0);
                                                      }
                                                    });
                                                    
                                                    const progressText = `${placedItems}/${totalItems}`;
                                                    const statusText = placedItems === totalItems && totalItems > 0 ? '–†–∞–∑–º–µ—â–µ–Ω–æ' : 
                                                                      placedItems > 0 ? '–ß–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω–æ' : '–û–∂–∏–¥–∞–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏—è';
                                                    const statusColor = placedItems === totalItems && totalItems > 0 ? 'text-green-600' : 
                                                                       placedItems > 0 ? 'text-yellow-600' : 'text-red-600';
                                                    
                                                    return (
                                                      <>
                                                        <span className={`font-bold ${statusColor}`}>{progressText}</span>
                                                        <span className={`text-xs px-2 py-1 rounded-full ${
                                                          placedItems === totalItems && totalItems > 0 ? 'bg-green-100 text-green-700' : 
                                                          placedItems > 0 ? 'bg-yellow-100 text-yellow-700' : 'bg-red-100 text-red-700'
                                                        }`}>
                                                          {statusText}
                                                        </span>
                                                      </>
                                                    );
                                                  })()}
                                                </div>
                                              </div>
                                            </div>
                                          </div>
                                          
                                          <div className="flex flex-wrap gap-2 mt-4">
                                            <Button onClick={() => openEnhancedPlacementModal(item)} size="sm" className="bg-green-600 hover:bg-green-700">
                                              <Grid3X3 className="mr-1 h-3 w-3" />–†–∞–∑–º–µ—Å—Ç–∏—Ç—å
                                            </Button>
                                            <Button onClick={() => handleOpenCargoPlacementDetails(item)} size="sm" className="bg-purple-600 hover:bg-purple-700">
                                              <Settings className="mr-1 h-3 w-3" />–î–µ–π—Å—Ç–≤–∏—è
                                            </Button>
                                          </div>
                                        </CardContent>
                                      </Card>
                                    );
                                  })}
                                </div>
                              )
                            ) : (
                              /* –ù–û–í–´–ô –†–ï–ñ–ò–ú: Individual Units –∫–∞—Ä—Ç–æ—á–∫–∏ */
                              individualUnitsForPlacement.length === 0 ? (
                                <div className="text-center py-8">
                                  <Package className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                                  <p className="text-gray-500">–ù–µ—Ç individual units, –æ–∂–∏–¥–∞—é—â–∏—Ö —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</p>
                                  <p className="text-sm text-gray-400 mt-2">Individual units –∏–∑ –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞—è–≤–æ–∫ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å</p>
                                  <Button 
                                    variant="outline" 
                                    className="mt-4"
                                    onClick={() => fetchIndividualUnitsForPlacement()}
                                  >
                                    –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                                  </Button>
                                </div>
                              ) : (
                                /* –ì—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∞ –ø–æ –∑–∞—è–≤–∫–∞–º —á–µ—Ä–µ–∑ Accordion */
                                <div className="space-y-4">
                                  {groupedUnitsForPlacement.map((group) => (
                                    <Card key={group.request_number} className="border-2 border-blue-200">
                                      <Accordion type="single" collapsible className="w-full">
                                        <AccordionItem value={group.request_number} className="border-none">
                                          <AccordionTrigger className="px-6 py-4 hover:no-underline">
                                            <div className="flex items-center justify-between w-full mr-4">
                                              <div className="flex items-center space-x-4">
                                                <h3 className="text-lg font-bold text-blue-600">
                                                  –ó–∞—è–≤–∫–∞ {group.request_number}
                                                </h3>
                                                <Badge variant="secondary" className="bg-blue-100 text-blue-800">
                                                  {group.total_units} –µ–¥–∏–Ω–∏—Ü
                                                </Badge>
                                                <Badge variant={group.placed_units === group.total_units ? "default" : group.placed_units > 0 ? "secondary" : "destructive"}>
                                                  {group.placed_units}/{group.total_units} —Ä–∞–∑–º–µ—â–µ–Ω–æ
                                                </Badge>
                                              </div>
                                              <div className="text-right text-sm text-gray-600">
                                                <div>üë§ {group.sender_name}</div>
                                                <div>üè† {group.warehouse_name}</div>
                                              </div>
                                            </div>
                                          </AccordionTrigger>
                                          <AccordionContent className="px-6 pb-4">
                                            <div className="grid gap-3 grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4">
                                              {group.units.map((unit) => {
                                                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ –ø–æ —Ç–∏–ø—É –≥—Ä—É–∑–∞
                                                const getCargoTypeColor = (typeNumber) => {
                                                  const colors = {
                                                    '01': 'border-blue-300 bg-blue-50',
                                                    '02': 'border-green-300 bg-green-50', 
                                                    '03': 'border-yellow-300 bg-yellow-50',
                                                    '04': 'border-purple-300 bg-purple-50',
                                                    '05': 'border-red-300 bg-red-50'
                                                  };
                                                  return colors[typeNumber] || 'border-gray-300 bg-gray-50';
                                                };

                                                return (
                                                  <Card key={unit.individual_number} className={`${getCargoTypeColor(unit.type_number)} border-l-4`}>
                                                    <CardHeader className="pb-2">
                                                      <CardTitle className="text-sm font-bold text-gray-800">
                                                        {unit.individual_number}
                                                      </CardTitle>
                                                      <Badge 
                                                        variant={unit.is_placed ? "default" : "destructive"}
                                                        className="text-xs"
                                                      >
                                                        {unit.is_placed ? '‚úÖ –†–∞–∑–º–µ—â–µ–Ω' : 'üü° –û–∂–∏–¥–∞–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏—è'}
                                                      </Badge>
                                                    </CardHeader>
                                                    <CardContent className="pt-0 space-y-2 text-xs">
                                                      <div>
                                                        <span className="font-medium">üìã –ó–∞—è–≤–∫–∞:</span> {unit.cargo_request_number}
                                                      </div>
                                                      <div>
                                                        <span className="font-medium">üì¶ –ì—Ä—É–∑:</span> {unit.cargo_name}
                                                      </div>
                                                      <div>
                                                        <span className="font-medium">üî¢ –¢–∏–ø:</span> {unit.type_number} | <span className="font-medium">–ï–¥–∏–Ω–∏—Ü–∞:</span> {unit.unit_index}
                                                      </div>
                                                      <div>
                                                        <span className="font-medium">üë§ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</span> {unit.sender_full_name}
                                                      </div>
                                                      <div>
                                                        <span className="font-medium">üìç –ü–æ–ª—É—á–∞—Ç–µ–ª—å:</span> {unit.recipient_full_name}
                                                      </div>
                                                      {unit.placement_info && (
                                                        <div className="text-green-600 font-medium">
                                                          üìç {unit.placement_info}
                                                        </div>
                                                      )}
                                                      
                                                      <div className="flex gap-1 mt-3">
                                                        <Button 
                                                          size="sm" 
                                                          className="flex-1 bg-green-600 hover:bg-green-700 text-xs"
                                                          onClick={() => handlePlaceIndividualUnit(unit)}
                                                          disabled={unit.is_placed}
                                                        >
                                                          <Grid3X3 className="mr-1 h-3 w-3" />
                                                          {unit.is_placed ? '–†–∞–∑–º–µ—â–µ–Ω' : '–†–∞–∑–º–µ—Å—Ç–∏—Ç—å'}
                                                        </Button>
                                                        <Button 
                                                          size="sm" 
                                                          variant="outline"
                                                          className="bg-purple-50 text-purple-600 border-purple-300 hover:bg-purple-100 text-xs"
                                                          onClick={() => handleOpenIndividualUnitActions(unit)}
                                                        >
                                                          <Settings className="h-3 w-3" />
                                                        </Button>
                                                      </div>
                                                    </CardContent>
                                                  </Card>
                                                );
                                              })}
                                            </div>
                                          </AccordionContent>
                                        </AccordionItem>
                                      </Accordion>
                                    </Card>
                                  ))}
                                </div>
                              )
                            )}
                          </div>
                        </CardContent>
                        
                        {/* –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–æ–≤ */}
                        {!useIndividualCards ? (
                          /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è —Å—Ç–∞—Ä–æ–≥–æ —Ä–µ–∂–∏–º–∞ */
                          availableCargoForPlacement.length > 0 && availableCargoPagination && (
                            <DataPagination
                              pagination={availableCargoPagination}
                              onPageChange={handleAvailableCargoPageChange}
                              onPerPageChange={handleAvailableCargoPerPageChange}
                            />
                          )
                        ) : (
                          /* –ü–∞–≥–∏–Ω–∞—Ü–∏—è –¥–ª—è –Ω–æ–≤–æ–≥–æ —Ä–µ–∂–∏–º–∞ individual units */
                          individualUnitsForPlacement.length > 0 && individualUnitsPagination && (
                            <DataPagination
                              pagination={individualUnitsPagination}
                              onPageChange={handleIndividualUnitsPageChange}
                              onPerPageChange={handleIndividualUnitsPerPageChange}
                            />
                          )
                        )}
                      </Card>
                    </div>
                  )}

                  {/* –ò—Å—Ç–æ—Ä–∏—è –≥—Ä—É–∑–æ–≤ —É–¥–∞–ª–µ–Ω –±–ª–æ–∫ "–†–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã" –¥–ª—è –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ */}

                  {/* –ò—Å—Ç–æ—Ä–∏—è –∑–∞–±–æ—Ä–∞ –≥—Ä—É–∑–∞ */}
                  {activeTab === 'cargo-pickup-history' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Package className="mr-2 h-5 w-5" />
                            –ò—Å—Ç–æ—Ä–∏—è –∑–∞–±–æ—Ä–∞ –≥—Ä—É–∑–∞
                          </div>
                          <Badge variant="secondary" className="bg-purple-100 text-purple-800">
                            {pickupRequestsHistory.length} –∑–∞–≤–µ—Ä—à–µ–Ω–æ
                          </Badge>
                        </CardTitle>
                        <CardDescription>
                          –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞ —Å –ø–æ–ª–Ω–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π –¥–µ–π—Å—Ç–≤–∏–π
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        {pickupRequestsHistory.length === 0 ? (
                          <div className="text-center py-8">
                            <Package className="mx-auto h-12 w-12 text-gray-400" />
                            <h3 className="mt-2 text-sm font-medium text-gray-900">–ù–µ—Ç –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫</h3>
                            <p className="mt-1 text-sm text-gray-500">
                              –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–¥–µ—Å—å.
                            </p>
                          </div>
                        ) : (
                          <div className="space-y-4">
                            {pickupRequestsHistory.map((request) => (
                              <Card key={request.id} className="border border-purple-200">
                                <CardContent className="p-4">
                                  <div className="flex items-start justify-between">
                                    <div className="flex-1">
                                      <div className="flex items-center space-x-3 mb-3">
                                        <Badge className="bg-purple-100 text-purple-700 border-purple-200">
                                          ‚Ññ {request.request_number || request.id.slice(0, 6)}
                                        </Badge>
                                        <Badge className="bg-green-100 text-green-800 border-green-200">
                                          ‚úÖ –í—ã–ø–æ–ª–Ω–µ–Ω–æ
                                        </Badge>
                                        {request.assigned_courier_name && (
                                          <Badge className="bg-blue-100 text-blue-700">
                                            üë§ {request.assigned_courier_name}
                                          </Badge>
                                        )}
                                      </div>
                                      
                                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-4">
                                        <div>
                                          <span className="font-medium text-gray-700">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</span>
                                          <span className="ml-1">{request.sender_full_name}</span>
                                        </div>
                                        <div>
                                          <span className="font-medium text-gray-700">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                                          <span className="ml-1">{request.sender_phone}</span>
                                        </div>
                                        <div>
                                          <span className="font-medium text-gray-700">–ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞:</span>
                                          <span className="ml-1">{request.pickup_address}</span>
                                        </div>
                                        <div>
                                          <span className="font-medium text-gray-700">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞:</span>
                                          <span className="ml-1">{request.destination || request.route || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                                        </div>
                                        <div>
                                          <span className="font-medium text-gray-700">–°–¥–∞–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥:</span>
                                          <span className="ml-1">
                                            {request.delivery_time 
                                              ? new Date(request.delivery_time).toLocaleString('ru-RU')
                                              : '–ù–µ —É–∫–∞–∑–∞–Ω–æ'
                                            }
                                          </span>
                                        </div>
                                        <div>
                                          <span className="font-medium text-gray-700">–û–±—Ä–∞–±–æ—Ç–∞–ª:</span>
                                          <span className="ml-1">{request.processed_by || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                                        </div>
                                      </div>

                                      {/* –°–æ–∑–¥–∞–Ω–Ω—ã–µ –≥—Ä—É–∑—ã */}
                                      {request.created_cargos && request.created_cargos.length > 0 && (
                                        <div className="mt-3 p-3 bg-green-50 rounded border border-green-200">
                                          <div className="text-sm font-medium text-green-800 mb-2">
                                            üì¶ –°–æ–∑–¥–∞–Ω–Ω—ã–µ –≥—Ä—É–∑—ã ({request.created_cargos.length}):
                                          </div>
                                          <div className="flex flex-wrap gap-2">
                                            {request.created_cargos.map((cargo, index) => (
                                              <Badge key={index} className="bg-green-100 text-green-700 border-green-300">
                                                {cargo.cargo_number}
                                              </Badge>
                                            ))}
                                          </div>
                                        </div>
                                      )}
                                      
                                      {/* –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π */}
                                      {request.action_history && request.action_history.length > 0 && (
                                        <div className="mt-3 p-3 bg-gray-50 rounded">
                                          <div className="text-sm font-medium text-gray-700 mb-2">üìã –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π:</div>
                                          <div className="space-y-1">
                                            {request.action_history.map((action, index) => (
                                              <div key={index} className="text-xs text-gray-600 flex items-start space-x-2">
                                                <span className="w-2 h-2 bg-blue-400 rounded-full mt-1.5 flex-shrink-0"></span>
                                                <div>
                                                  <span className="font-medium">
                                                    {new Date(action.timestamp).toLocaleString('ru-RU')}:
                                                  </span>
                                                  <span className="ml-1">{action.details}</span>
                                                  <span className="text-gray-500"> ({action.performed_by})</span>
                                                </div>
                                              </div>
                                            ))}
                                          </div>
                                        </div>
                                      )}
                                    </div>
                                  </div>
                                </CardContent>
                              </Card>
                            ))}
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  )}

                  {/* –ò—Å—Ç–æ—Ä–∏—è –≥—Ä—É–∑–æ–≤ */}
                  {activeTab === 'cargo-history' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <FileText className="mr-2 h-5 w-5" />
                          –ò—Å—Ç–æ—Ä–∏—è –≥—Ä—É–∑–æ–≤
                        </CardTitle>
                        <CardDescription>
                          –ü—Ä–æ—Å–º–æ—Ç—Ä –¥–æ—Å—Ç–∞–≤–ª–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤ —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏ –∏ –ø–æ–∏—Å–∫–æ–º
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="flex space-x-4 mb-6">
                          <div className="flex-1">
                            <Input
                              placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É –≥—Ä—É–∑–∞, –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é –∏–ª–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—é"
                              value={historyFilters.search}
                              onChange={(e) => setHistoryFilters({...historyFilters, search: e.target.value})}
                            />
                          </div>
                          <div>
                            <Select 
                              value={historyFilters.status} 
                              onValueChange={(value) => setHistoryFilters({...historyFilters, status: value})}
                            >
                              <SelectTrigger className="w-48">
                                <SelectValue />
                              </SelectTrigger>
                              <SelectContent>
                                <SelectItem value="all">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã –æ–ø–ª–∞—Ç—ã</SelectItem>
                                <SelectItem value="paid">–û–ø–ª–∞—á–µ–Ω–æ</SelectItem>
                                <SelectItem value="pending">–û–∂–∏–¥–∞–µ—Ç –æ–ø–ª–∞—Ç—ã</SelectItem>
                                <SelectItem value="failed">–û–ø–ª–∞—Ç–∞ –Ω–µ –ø—Ä–æ—à–ª–∞</SelectItem>
                              </SelectContent>
                            </Select>
                          </div>
                          <Button onClick={fetchCargoHistory}>
                            <Search className="mr-2 h-4 w-4" />
                            –ù–∞–π—Ç–∏
                          </Button>
                        </div>
                        
                        <div className="space-y-4">
                          {cargoHistory.length === 0 ? (
                            <div className="text-center py-8">
                              <FileText className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">–ò—Å—Ç–æ—Ä–∏—è –≥—Ä—É–∑–æ–≤ –ø—É—Å—Ç–∞</p>
                            </div>
                          ) : (
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  <TableHead>–ù–æ–º–µ—Ä</TableHead>
                                  <TableHead>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</TableHead>
                                  <TableHead>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</TableHead>
                                  <TableHead>–í–µ—Å</TableHead>
                                  <TableHead>–°—Ç–æ–∏–º–æ—Å—Ç—å</TableHead>
                                  <TableHead>–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã</TableHead>
                                  <TableHead>–î–∞—Ç–∞ –¥–æ—Å—Ç–∞–≤–∫–∏</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {cargoHistory.map((item) => (
                                  <TableRow key={item.id}>
                                    <TableCell className="font-medium">{item.cargo_number}</TableCell>
                                    <TableCell>
                                      <div>
                                        <div className="font-medium">{item.sender_full_name}</div>
                                        <div className="text-sm text-gray-500">{item.sender_phone}</div>
                                      </div>
                                    </TableCell>
                                    <TableCell>
                                      <div>
                                        <div className="font-medium">{item.recipient_full_name}</div>
                                        <div className="text-sm text-gray-500">{item.recipient_phone}</div>
                                      </div>
                                    </TableCell>
                                    <TableCell>{item.weight} –∫–≥</TableCell>
                                    <TableCell>{item.declared_value} ‚ÇΩ</TableCell>
                                    <TableCell>
                                      <Badge variant={item.payment_status === 'paid' ? 'default' : 'secondary'}>
                                        {item.payment_status === 'paid' ? '–û–ø–ª–∞—á–µ–Ω' : '–ù–µ –æ–ø–ª–∞—á–µ–Ω'}
                                      </Badge>
                                    </TableCell>
                                    <TableCell>
                                      {new Date(item.updated_at).toLocaleDateString('ru-RU')}
                                    </TableCell>
                                  </TableRow>
                                ))}
                              </TableBody>
                            </Table>
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}
              {/* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞) */}
              {activeSection === 'users' && user?.role === 'admin' && (
                <div className="space-y-6">
                  {/* –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ */}
                  {(activeTab === 'users-regular' || !activeTab || activeTab === 'users') && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <User className="mr-2 h-5 w-5" />
                          –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ ({usersByRole.user.length})
                        </CardTitle>
                        <CardDescription>–û–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å–∏—Å—Ç–µ–º—ã</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <Table>
                          <TableHeader>
                            <TableRow>
                              <TableHead>–ù–æ–º–µ—Ä</TableHead>
                              <TableHead>–§–ò–û</TableHead>
                              <TableHead>–¢–µ–ª–µ—Ñ–æ–Ω</TableHead>
                              <TableHead>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</TableHead>
                              <TableHead>–°—Ç–∞—Ç—É—Å</TableHead>
                              <TableHead>–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                            </TableRow>
                          </TableHeader>
                          <TableBody>
                            {usersByRole.user.map((u) => (
                              <TableRow key={u.id}>
                                <TableCell>
                                  <Badge variant="secondary" className="text-xs">
                                    {u.user_number || 'N/A'}
                                  </Badge>
                                </TableCell>
                                <TableCell className="font-medium">{u.full_name}</TableCell>
                                <TableCell>{u.phone}</TableCell>
                                <TableCell>{new Date(u.created_at).toLocaleDateString('ru-RU')}</TableCell>
                                <TableCell>
                                  <Badge variant={u.is_active ? 'default' : 'secondary'}>
                                    {u.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}
                                  </Badge>
                                </TableCell>
                                <TableCell>
                                  <div className="flex space-x-2">
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => openAdminEditUser(u)}
                                      className="text-orange-600 hover:text-orange-700"
                                      title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
                                    >
                                      <Edit className="h-4 w-4" />
                                    </Button>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => fetchUserProfile(u.id)}
                                      className="text-blue-600 hover:text-blue-700"
                                      title="–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è –∏ –∏—Å—Ç–æ—Ä–∏–∏"
                                    >
                                      <Eye className="h-4 w-4" />
                                    </Button>
                                    {user.role === 'warehouse_operator' && (
                                      <Button
                                        size="sm"
                                        variant="outline"
                                        onClick={() => openQuickCargoModal(u)}
                                        className="text-green-600 hover:text-green-700"
                                        title="–ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–∑–∞"
                                      >
                                        <Plus className="h-4 w-4" />
                                      </Button>
                                    )}
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => openRoleModal(u)}
                                      className="text-blue-600 hover:text-blue-700"
                                      title="–ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å"
                                    >
                                      <Shield className="h-4 w-4" />
                                    </Button>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => toggleUserStatus(u.id, u.is_active)}
                                    >
                                      {u.is_active ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                                    </Button>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => deleteUser(u.id)}
                                      className="text-red-600 hover:text-red-700"
                                    >
                                      <Trash2 className="h-4 w-4" />
                                    </Button>
                                  </div>
                                </TableCell>
                              </TableRow>
                            ))}
                          </TableBody>
                        </Table>
                      </CardContent>
                    </Card>
                  )}

                  {/* –û–ø–µ—Ä–∞—Ç–æ—Ä—ã —Å–∫–ª–∞–¥–∞ */}
                  {activeTab === 'users-operators' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Warehouse className="mr-2 h-5 w-5" />
                            –û–ø–µ—Ä–∞—Ç–æ—Ä—ã —Å–∫–ª–∞–¥–æ–≤ ({usersByRole.warehouse_operator.length})
                          </div>
                          {selectedOperators.length > 0 && (
                            <Button
                              onClick={handleBulkDeleteOperators}
                              variant="outline"
                              className="text-red-600 border-red-300 hover:bg-red-50"
                            >
                              <Trash2 className="mr-2 h-4 w-4" />
                              –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã—Ö ({selectedOperators.length})
                            </Button>
                          )}
                        </CardTitle>
                        <CardDescription>–û–ø–µ—Ä–∞—Ç–æ—Ä—ã —Å–∫–ª–∞–¥–æ–≤ —Å –¥–µ—Ç–∞–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ–º —Ä–æ–ª—è–º–∏</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <Table>
                          <TableHeader>
                            <TableRow>
                              <TableHead>
                                {usersByRole.warehouse_operator.length > 0 && (
                                  <input
                                    type="checkbox"
                                    checked={selectAllOperators}
                                    onChange={(e) => handleSelectAllOperators(e.target.checked, usersByRole.warehouse_operator)}
                                    className="rounded border-gray-300"
                                  />
                                )}
                              </TableHead>
                              <TableHead>–ù–æ–º–µ—Ä</TableHead>
                              <TableHead>–§–ò–û</TableHead>
                              <TableHead>–¢–µ–ª–µ—Ñ–æ–Ω</TableHead>
                              <TableHead>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</TableHead>
                              <TableHead>–°—Ç–∞—Ç—É—Å</TableHead>
                              <TableHead>–†–æ–ª—å</TableHead>
                              <TableHead>–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                            </TableRow>
                          </TableHeader>
                          <TableBody>
                            {usersByRole.warehouse_operator.map((u) => (
                              <TableRow key={u.id}>
                                <TableCell>
                                  <input
                                    type="checkbox"
                                    checked={selectedOperators.includes(u.id)}
                                    onChange={(e) => handleOperatorSelect(u.id, e.target.checked)}
                                    className="rounded border-gray-300"
                                  />
                                </TableCell>
                                <TableCell>
                                  <Badge variant="secondary" className="text-xs">
                                    {u.user_number || 'N/A'}
                                  </Badge>
                                </TableCell>
                                <TableCell className="font-medium">{u.full_name}</TableCell>
                                <TableCell>{u.phone}</TableCell>
                                <TableCell>{new Date(u.created_at).toLocaleDateString('ru-RU')}</TableCell>
                                <TableCell>
                                  <Badge variant={u.is_active ? 'default' : 'secondary'}>
                                    {u.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}
                                  </Badge>
                                </TableCell>
                                <TableCell>
                                  <Badge variant="outline" className="bg-orange-50 text-orange-700">
                                    –û–ø–µ—Ä–∞—Ç–æ—Ä —Å–∫–ª–∞–¥–∞
                                  </Badge>
                                </TableCell>
                                <TableCell>
                                  <div className="flex space-x-2">
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => fetchOperatorProfile(u.id)}
                                      className="text-blue-600 hover:text-blue-700"
                                      title="–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–æ—Ñ–∏–ª—è –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"
                                    >
                                      <Eye className="h-4 w-4" />
                                    </Button>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => {
                                        setSelectedUserForRole(u);
                                        setNewRole('admin');
                                        setShowRoleModal(true);
                                      }}
                                      className="text-purple-600 hover:text-purple-700"
                                      title="–ü–æ–≤—ã—Å–∏—Ç—å –¥–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞"
                                    >
                                      <ArrowUp className="h-4 w-4" />
                                    </Button>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => toggleUserStatus(u.id, u.is_active)}
                                      className={u.is_active ? "text-red-600 hover:text-red-700" : "text-green-600 hover:text-green-700"}
                                      title={u.is_active ? "–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å" : "–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å"}
                                    >
                                      {u.is_active ? <Ban className="h-4 w-4" /> : <CheckCircle className="h-4 w-4" />}
                                    </Button>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => handleDeleteOperator(u.id)}
                                      className="text-red-600 hover:text-red-700"
                                      title="–£–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞"
                                    >
                                      <Trash2 className="h-4 w-4" />
                                    </Button>
                                  </div>
                                </TableCell>
                              </TableRow>
                            ))}
                          </TableBody>
                        </Table>

                        {usersByRole.warehouse_operator.length === 0 && (
                          <div className="text-center py-8">
                            <Warehouse className="mx-auto h-12 w-12 text-gray-400" />
                            <h3 className="mt-4 text-sm font-medium text-gray-900">–û–ø–µ—Ä–∞—Ç–æ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                            <p className="mt-1 text-sm text-gray-500">
                              –ù–∞–∑–Ω–∞—á—å—Ç–µ —Ä–æ–ª—å "–û–ø–µ—Ä–∞—Ç–æ—Ä —Å–∫–ª–∞–¥–∞" –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º
                            </p>
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  )}

                  {/* –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã */}
                  {activeTab === 'users-admins' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Shield className="mr-2 h-5 w-5" />
                          –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã ({usersByRole.admin.length})
                        </CardTitle>
                        <CardDescription>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã —Å–∏—Å—Ç–µ–º—ã</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <Table>
                          <TableHeader>
                            <TableRow>
                              <TableHead>–§–ò–û</TableHead>
                              <TableHead>–¢–µ–ª–µ—Ñ–æ–Ω</TableHead>
                              <TableHead>–î–∞—Ç–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏</TableHead>
                              <TableHead>–°—Ç–∞—Ç—É—Å</TableHead>
                              <TableHead>–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                            </TableRow>
                          </TableHeader>
                          <TableBody>
                            {usersByRole.admin.map((u) => (
                              <TableRow key={u.id}>
                                <TableCell className="font-medium">{u.full_name}</TableCell>
                                <TableCell>{u.phone}</TableCell>
                                <TableCell>{new Date(u.created_at).toLocaleDateString('ru-RU')}</TableCell>
                                <TableCell>
                                  <Badge variant={u.is_active ? 'default' : 'secondary'}>
                                    {u.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}
                                  </Badge>
                                </TableCell>
                                <TableCell>
                                  <div className="flex space-x-2">
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => toggleUserStatus(u.id, u.is_active)}
                                    >
                                      {u.is_active ? '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å' : '–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å'}
                                    </Button>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => deleteUser(u.id)}
                                      className="text-red-600 hover:text-red-700"
                                    >
                                      <Trash2 className="h-4 w-4" />
                                    </Button>
                                  </div>
                                </TableCell>
                              </TableRow>
                            ))}
                          </TableBody>
                        </Table>
                      </CardContent>
                    </Card>
                  )}

                  {/* –ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø: –ö—É—Ä—å–µ—Ä—ã */}
                  {activeTab === 'users-couriers' && (
                    <div className="space-y-6">
                      {/* –ö–∞—Ä—Ç–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–æ–≤ */}
                      <CourierTrackingMap 
                        userRole={user?.role}
                        apiCall={apiCall}
                      />
                      
                      <Card>
                        <CardHeader>
                          <CardTitle className="flex items-center justify-between">
                            <div className="flex items-center">
                              <Truck className="mr-2 h-5 w-5" />
                              –ö—É—Ä—å–µ—Ä—ã ({couriers.length})
                            </div>
                            <Button onClick={() => setCourierCreateModal(true)}>
                              <Plus className="mr-2 h-4 w-4" />
                              –°–æ–∑–¥–∞—Ç—å –∫—É—Ä—å–µ—Ä–∞
                            </Button>
                          </CardTitle>
                          <CardDescription>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞–º–∏ –∏ —Å–ª—É–∂–±–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏</CardDescription>
                        </CardHeader>
                        <CardContent>
                          {couriers.length > 0 ? (
                            <div className="space-y-4">
                              <Table>
                                <TableHeader>
                                  <TableRow>
                                    <TableHead>–§–ò–û</TableHead>
                                    <TableHead>–¢–µ–ª–µ—Ñ–æ–Ω</TableHead>
                                    <TableHead>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</TableHead>
                                    <TableHead>–ì—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å</TableHead>
                                    <TableHead>–°–∫–ª–∞–¥</TableHead>
                                    <TableHead>–°—Ç–∞—Ç—É—Å</TableHead>
                                    <TableHead>–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                                  </TableRow>
                                </TableHeader>
                                <TableBody>
                                  {couriers.map((courier) => (
                                    <TableRow key={courier.id}>
                                      <TableCell className="font-medium">{courier.full_name}</TableCell>
                                      <TableCell>{courier.phone}</TableCell>
                                      <TableCell>
                                        <div className="flex items-center">
                                          <Truck className="mr-2 h-4 w-4" />
                                          {courier.transport_type} {courier.transport_number}
                                        </div>
                                      </TableCell>
                                      <TableCell>{courier.transport_capacity} –∫–≥</TableCell>
                                      <TableCell>{courier.assigned_warehouse_name}</TableCell>
                                      <TableCell>
                                        <Badge variant={courier.is_active ? "default" : "secondary"}>
                                          {courier.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                                        </Badge>
                                      </TableCell>
                                      <TableCell>
                                        <div className="flex space-x-2">
                                          <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => handleViewCourierProfile(courier.id)}
                                          >
                                            <Eye className="h-4 w-4" />
                                          </Button>
                                          <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => handleEditCourier(courier)}
                                          >
                                            <Edit className="h-4 w-4" />
                                          </Button>
                                        </div>
                                      </TableCell>
                                    </TableRow>
                                  ))}
                                </TableBody>
                              </Table>
                              
                              {/* –ü–∞–≥–∏–Ω–∞—Ü–∏—è –∫—É—Ä—å–µ—Ä–æ–≤ */}
                              {couriersPagination && couriersPagination.total_pages > 1 && (
                                <DataPagination 
                                  currentPage={couriersPage}
                                  totalPages={couriersPagination.total_pages}
                                  totalItems={couriersPagination.total_count}
                                  itemsPerPage={couriersPerPage}
                                  onPageChange={(page) => {
                                    setCouriersPage(page);
                                    fetchCouriers(page, couriersPerPage);
                                  }}
                                  onItemsPerPageChange={(perPage) => {
                                    setCouriersPerPage(perPage);
                                    setCouriersPage(1);
                                    fetchCouriers(1, perPage);
                                  }}
                                />
                              )}
                            </div>
                          ) : (
                            <div className="text-center py-8">
                              <Truck className="mx-auto h-12 w-12 text-gray-400" />
                              <h3 className="mt-4 text-sm font-medium text-gray-900">–ö—É—Ä—å–µ—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</h3>
                              <p className="mt-1 text-sm text-gray-500">
                                –°–æ–∑–¥–∞–π—Ç–µ –ø–µ—Ä–≤–æ–≥–æ –∫—É—Ä—å–µ—Ä–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Ä–∞–±–æ—Ç—ã —Å–ª—É–∂–±—ã –¥–æ—Å—Ç–∞–≤–∫–∏
                              </p>
                            </div>
                          )}
                        </CardContent>
                      </Card>
                    </div>
                  )}

                  {/* –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å–∫–ª–∞–¥–∞ (–§—É–Ω–∫—Ü–∏—è 2) */}
                  {activeTab === 'users-create-operator' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Plus className="mr-2 h-5 w-5" />
                          –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤–æ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å–∫–ª–∞–¥–∞
                        </CardTitle>
                        <CardDescription>
                          –°–æ–∑–¥–∞–Ω–∏–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–∏–≤—è–∑–∫–æ–π –∫ —Å–∫–ª–∞–¥—É
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <form onSubmit={handleCreateOperator} className="space-y-4 max-w-md">
                          <div>
                            <Label htmlFor="operator-full-name">–§–ò–û –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</Label>
                            <Input
                              id="operator-full-name"
                              value={operatorCreateForm.full_name}
                              onChange={(e) => setOperatorCreateForm({...operatorCreateForm, full_name: e.target.value})}
                              placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
                              required
                            />
                          </div>
                          <div>
                            <Label htmlFor="operator-phone">–¢–µ–ª–µ—Ñ–æ–Ω</Label>
                            <Input
                              id="operator-phone"
                              type="tel"
                              value={operatorCreateForm.phone}
                              onChange={(e) => setOperatorCreateForm({...operatorCreateForm, phone: e.target.value})}
                              placeholder="+79XXXXXXXXX"
                              required
                            />
                          </div>
                          <div>
                            <Label htmlFor="operator-address">–ê–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è</Label>
                            <Input
                              id="operator-address"
                              value={operatorCreateForm.address}
                              onChange={(e) => setOperatorCreateForm({...operatorCreateForm, address: e.target.value})}
                              placeholder="–ú–æ—Å–∫–≤–∞, —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 10, –∫–≤. 5"
                              required
                            />
                          </div>
                          <div>
                            <Label htmlFor="operator-password">–ü–∞—Ä–æ–ª—å</Label>
                            <Input
                              id="operator-password"
                              type="password"
                              value={operatorCreateForm.password}
                              onChange={(e) => setOperatorCreateForm({...operatorCreateForm, password: e.target.value})}
                              placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"
                              minLength={6}
                              required
                            />
                          </div>
                          <div>
                            <Label htmlFor="operator-warehouse">–ù–∞–∑–Ω–∞—á–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥</Label>
                            <Select 
                              value={operatorCreateForm.warehouse_id} 
                              onValueChange={(value) => {
                                console.log('–í—ã–±—Ä–∞–Ω —Å–∫–ª–∞–¥:', value);
                                setOperatorCreateForm({...operatorCreateForm, warehouse_id: value});
                              }}
                            >
                              <SelectTrigger>
                                <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥" />
                              </SelectTrigger>
                              <SelectContent>
                                {warehouses && warehouses.length > 0 ? (
                                  warehouses.map((warehouse) => (
                                    <SelectItem key={warehouse.id} value={warehouse.id}>
                                      {warehouse.name} - {warehouse.location}
                                    </SelectItem>
                                  ))
                                ) : (
                                  <SelectItem value="" disabled>
                                    {warehouses ? '–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤' : '–ó–∞–≥—Ä—É–∑–∫–∞ —Å–∫–ª–∞–¥–æ–≤...'}
                                  </SelectItem>
                                )}
                              </SelectContent>
                            </Select>
                            {warehouses && warehouses.length === 0 && (
                              <p className="text-sm text-red-600 mt-1">
                                ‚ö†Ô∏è –°–∫–ª–∞–¥—ã –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ —Å–µ—Ä–≤–µ—Ä—É.
                              </p>
                            )}
                          </div>
                          <Button type="submit" className="w-full">
                            <Plus className="mr-2 h-4 w-4" />
                            –°–æ–∑–¥–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
                          </Button>
                        </form>

                        {/* –°–ø–∏—Å–æ–∫ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ */}
                        <div className="mt-8">
                          <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold">–°–æ–∑–¥–∞–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã</h3>
                            <div className="flex space-x-2">
                              <Button 
                                variant="destructive"
                                size="sm"
                                onClick={handleCleanupTestData}
                                className="bg-red-600 hover:bg-red-700"
                              >
                                üßπ –û—á–∏—Å—Ç–∏—Ç—å —Ç–µ—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
                              </Button>
                              <Button 
                                variant="outline" 
                                onClick={fetchAllOperators}
                              >
                                –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫
                              </Button>
                            </div>
                          </div>
                          {allOperators.length === 0 ? (
                            <div className="text-center py-8">
                              <Users className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">–û–ø–µ—Ä–∞—Ç–æ—Ä—ã –Ω–µ —Å–æ–∑–¥–∞–Ω—ã</p>
                            </div>
                          ) : (
                            <div className="space-y-4">
                              {allOperators.map((operator) => (
                                <div key={operator.id} className="border rounded-lg p-4">
                                  <div className="flex items-center justify-between">
                                    <div>
                                      <h4 className="font-semibold">{operator.full_name}</h4>
                                      <p className="text-sm text-gray-600">{operator.phone}</p>
                                      <p className="text-sm text-gray-600">{operator.address}</p>
                                      <div className="flex items-center mt-2">
                                        <Badge variant="outline" className="mr-2">
                                          {operator.role}
                                        </Badge>
                                        <span className="text-xs text-gray-500">
                                          –°–æ–∑–¥–∞–Ω: {new Date(operator.created_at).toLocaleDateString('ru-RU')}
                                        </span>
                                      </div>
                                    </div>
                                    <div className="text-right">
                                      <p className="text-sm font-medium">–°–∫–ª–∞–¥—ã ({operator.warehouses_count})</p>
                                      {operator.warehouses && operator.warehouses.length > 0 ? (
                                        <div className="text-xs text-gray-600">
                                          {operator.warehouses.map((warehouse) => (
                                            <div key={warehouse.id}>
                                              {warehouse.name}
                                            </div>
                                          ))}
                                        </div>
                                      ) : (
                                        <span className="text-xs text-red-600">–ù–µ—Ç —Å–∫–ª–∞–¥–æ–≤</span>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* –ü—Ä–∏–≤—è–∑–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∫ —Å–∫–ª–∞–¥–∞–º */}
                  {activeTab === 'users-operator-bindings' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Users className="mr-2 h-5 w-5" />
                            –ü—Ä–∏–≤—è–∑–∫–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∫ —Å–∫–ª–∞–¥–∞–º ({operatorWarehouseBindings.length})
                          </div>
                          <Button onClick={() => setOperatorBindingModal(true)}>
                            <Plus className="mr-2 h-4 w-4" />
                            –°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É
                          </Button>
                        </CardTitle>
                        <CardDescription>
                          –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–æ—Å—Ç—É–ø–æ–º –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∫ —Å–∫–ª–∞–¥–∞–º
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        {operatorWarehouseBindings.length === 0 ? (
                          <div className="text-center py-8">
                            <Users className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                            <p className="text-gray-500">–ù–µ—Ç –ø—Ä–∏–≤—è–∑–æ–∫ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–≤ –∫ —Å–∫–ª–∞–¥–∞–º</p>
                            <Button 
                              onClick={() => setOperatorBindingModal(true)}
                              className="mt-4"
                            >
                              –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—É—é –ø—Ä–∏–≤—è–∑–∫—É
                            </Button>
                          </div>
                        ) : (
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>–û–ø–µ—Ä–∞—Ç–æ—Ä</TableHead>
                                <TableHead>–¢–µ–ª–µ—Ñ–æ–Ω</TableHead>
                                <TableHead>–°–∫–ª–∞–¥</TableHead>
                                <TableHead>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</TableHead>
                                <TableHead>–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {operatorWarehouseBindings.map((binding) => (
                                <TableRow key={binding.id}>
                                  <TableCell className="font-medium">{binding.operator_name}</TableCell>
                                  <TableCell>{binding.operator_phone}</TableCell>
                                  <TableCell>{binding.warehouse_name}</TableCell>
                                  <TableCell>
                                    {new Date(binding.created_at).toLocaleDateString('ru-RU')}
                                  </TableCell>
                                  <TableCell>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => handleDeleteOperatorBinding(binding.id)}
                                      className="text-red-600 hover:text-red-700"
                                    >
                                      <Trash2 className="h-4 w-4" />
                                      –£–¥–∞–ª–∏—Ç—å
                                    </Button>
                                  </TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        )}
                      </CardContent>
                    </Card>
                  )}

                  {/* –ù–û–í–ê–Ø –í–ö–õ–ê–î–ö–ê: –°–ø–∏—Å–æ–∫ –∑–∞–¥–æ–ª–∂–Ω–∏–∫–æ–≤ */}
                  {activeTab === 'users-debtors' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <CreditCard className="mr-2 h-5 w-5" />
                            –°–ø–∏—Å–æ–∫ –∑–∞–¥–æ–ª–∂–Ω–∏–∫–æ–≤ ({debtorsList.length})
                          </div>
                          <Button onClick={fetchDebtorsList}>
                            –û–±–Ω–æ–≤–∏—Ç—å
                          </Button>
                        </CardTitle>
                        <CardDescription>
                          –ì—Ä—É–∑—ã –æ—Ñ–æ—Ä–º–ª–µ–Ω–Ω—ã–µ –≤ –¥–æ–ª–≥ —Å –¥–∞—Ç–∞–º–∏ –ø–æ–≥–∞—à–µ–Ω–∏—è
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        {debtorsList.length === 0 ? (
                          <div className="text-center py-8">
                            <CreditCard className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                            <p className="text-gray-500">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –¥–æ–ª–≥–æ–≤</p>
                          </div>
                        ) : (
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>–ù–æ–º–µ—Ä –≥—Ä—É–∑–∞</TableHead>
                                <TableHead>–î–æ–ª–∂–Ω–∏–∫</TableHead>
                                <TableHead>–¢–µ–ª–µ—Ñ–æ–Ω</TableHead>
                                <TableHead>–°—É–º–º–∞ –¥–æ–ª–≥–∞</TableHead>
                                <TableHead>–û–ø–ª–∞—á–µ–Ω–æ</TableHead>
                                <TableHead>–û—Å—Ç–∞—Ç–æ–∫</TableHead>
                                <TableHead>–°—Ä–æ–∫ –ø–æ–≥–∞—à–µ–Ω–∏—è</TableHead>
                                <TableHead>–°–∫–ª–∞–¥</TableHead>
                                <TableHead>–°—Ç–∞—Ç—É—Å</TableHead>
                                <TableHead>–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {debtorsList.map((debt) => {
                                const isOverdue = new Date(debt.debt_due_date) < new Date();
                                return (
                                  <TableRow key={debt.id}>
                                    <TableCell className="font-medium">
                                      {debt.cargo_number}
                                    </TableCell>
                                    <TableCell>{debt.debtor_name}</TableCell>
                                    <TableCell>{debt.debtor_phone}</TableCell>
                                    <TableCell className="font-semibold">
                                      {debt.debt_amount?.toFixed(2)} —Å–æ–º
                                    </TableCell>
                                    <TableCell className="text-green-600">
                                      {debt.payment_amount?.toFixed(2) || 0} —Å–æ–º
                                    </TableCell>
                                    <TableCell className="font-semibold text-red-600">
                                      {debt.remaining_amount?.toFixed(2)} —Å–æ–º
                                    </TableCell>
                                    <TableCell className={isOverdue ? "text-red-600 font-semibold" : ""}>
                                      {new Date(debt.debt_due_date).toLocaleDateString('ru-RU')}
                                      {isOverdue && " (–ü–†–û–°–†–û–ß–ï–ù)"}
                                    </TableCell>
                                    <TableCell>{debt.warehouse_name}</TableCell>
                                    <TableCell>
                                      <Badge variant={
                                        debt.status === 'paid' ? 'default' : 
                                        isOverdue ? 'destructive' : 'secondary'
                                      }>
                                        {debt.status === 'paid' ? '–û–ø–ª–∞—á–µ–Ω' : 
                                         isOverdue ? '–ü—Ä–æ—Å—Ä–æ—á–µ–Ω' : '–ê–∫—Ç–∏–≤–Ω—ã–π'}
                                      </Badge>
                                    </TableCell>
                                    <TableCell>
                                      {debt.status === 'active' && (
                                        <div className="flex space-x-2">
                                          <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => handlePayOffDebt(debt.id, debt.remaining_amount)}
                                            className="text-green-600 hover:text-green-700"
                                          >
                                            –ü–æ–≥–∞—Å–∏—Ç—å
                                          </Button>
                                          <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => handleMarkOverdue(debt.id)}
                                            className="text-orange-600 hover:text-orange-700"
                                          >
                                            –ü—Ä–æ—Å—Ä–æ—á–µ–Ω
                                          </Button>
                                        </div>
                                      )}
                                    </TableCell>
                                  </TableRow>
                                );
                              })}
                            </TableBody>
                          </Table>
                        )}
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}

              {/* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–∞–º–∏ */}
              {activeSection === 'warehouses' && (
                <div className="space-y-6">
                  {/* –†–ê–°–®–ò–†–ï–ù–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–° –î–õ–Ø –û–ü–ï–†–ê–¢–û–†–û–í –°–ö–õ–ê–î–û–í (–§–ê–ó–ê 3) */}
                  {user?.role === 'warehouse_operator' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Building className="mr-2 h-5 w-5" />
                            –ú–æ–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–µ —Å–∫–ª–∞–¥—ã ({operatorWarehouses.length})
                          </div>
                          <Button onClick={fetchOperatorWarehouses} variant="outline" size="sm">
                            <RefreshCw className="mr-2 h-4 w-4" />
                            –û–±–Ω–æ–≤–∏—Ç—å
                          </Button>
                        </CardTitle>
                        <CardDescription>
                          –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–∫–ª–∞–¥–æ–≤ —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π –∏ —Å—Ö–µ–º–æ–π —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        {operatorWarehouses.length === 0 ? (
                          <div className="text-center py-8">
                            <Building className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                            <p className="text-gray-500 mb-4">–í–∞–º –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω—ã —Å–∫–ª–∞–¥—ã</p>
                            <p className="text-sm text-gray-400">–û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –ø—Ä–∏–≤—è–∑–∫–∏ –∫ —Å–∫–ª–∞–¥–∞–º</p>
                          </div>
                        ) : (
                          <div className="space-y-6">
                            {operatorWarehouses.map((warehouse) => {
                              // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ö–æ–º–ø–æ–Ω–µ–Ω—Ç –∫–∞—Ä—Ç–æ—á–∫–∏ —Å–∫–ª–∞–¥–∞ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
                              const WarehouseCard = ({ warehouse }) => {
                                const [statistics, setStatistics] = useState(null);
                                const [loading, setLoading] = useState(false);
                                
                                useEffect(() => {
                                  const loadStatistics = async () => {
                                    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ —É–∂–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
                                    if (warehousesStatistics[warehouse.id]) {
                                      setStatistics(warehousesStatistics[warehouse.id]);
                                      return;
                                    }
                                    
                                    setLoading(true);
                                    try {
                                      const stats = await fetchWarehouseStatisticsLazy(warehouse.id);
                                      setStatistics(stats);
                                    } catch (error) {
                                      console.error(`Error loading statistics for warehouse ${warehouse.id}:`, error);
                                    } finally {
                                      setLoading(false);
                                    }
                                  };
                                  
                                  loadStatistics();
                                }, [warehouse.id]);
                                
                                if (loading) {
                                  return (
                                    <Card key={warehouse.id} className="border-l-4 border-l-blue-500 bg-gradient-to-r from-blue-50 to-white">
                                      <CardContent className="p-6">
                                        <div className="text-center py-8">
                                          <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-4"></div>
                                          <p className="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–∫–ª–∞–¥–∞...</p>
                                        </div>
                                      </CardContent>
                                    </Card>
                                  );
                                }
                                
                                return (
                                  <Card key={warehouse.id} className="border-l-4 border-l-blue-500 bg-gradient-to-r from-blue-50 to-white">
                                    <CardContent className="p-6">
                                      {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å–∫–ª–∞–¥–∞ */}
                                      <div className="flex items-start justify-between mb-6">
                                        <div>
                                          <h3 className="font-bold text-xl text-gray-900 mb-2">
                                            üè≠ {warehouse.name}
                                          </h3>
                                          <p className="text-gray-600 flex items-center mb-1">
                                            <MapPin className="inline h-4 w-4 mr-2" />
                                            {warehouse.location}
                                          </p>
                                          <div className="flex flex-wrap gap-3 text-sm text-gray-500">
                                            <span>–ë–ª–æ–∫–æ–≤: {warehouse.blocks_count || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                                            <span>–ü–æ–ª–æ–∫/–±–ª–æ–∫: {warehouse.shelves_per_block || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                                            <span>–Ø—á–µ–µ–∫/–ø–æ–ª–∫–∞: {warehouse.cells_per_shelf || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                                          </div>
                                          <p className="text-sm text-blue-600 font-medium mt-1">
                                            –û–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —è—á–µ–µ–∫: {statistics?.total_cells || 
                                             (warehouse.blocks_count || 0) * (warehouse.shelves_per_block || 0) * (warehouse.cells_per_shelf || 0)}
                                          </p>
                                        </div>
                                        <Badge className="bg-green-100 text-green-800 border-green-200">
                                          <CheckCircle className="w-3 h-3 mr-1" />
                                          –ê–∫—Ç–∏–≤–Ω—ã–π
                                        </Badge>
                                      </div>

                                      {/* –ò–°–ü–†–ê–í–õ–ï–ù–û: –†–µ–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —è—á–µ–µ–∫ */}
                                      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                                        <div className="bg-white p-3 rounded-lg border shadow-sm">
                                          <div className="flex items-center justify-between">
                                            <div>
                                              <p className="text-xs font-medium text-gray-500">–í—Å–µ–≥–æ —è—á–µ–µ–∫</p>
                                              <p className="text-xl font-bold text-blue-600">
                                                {statistics?.total_cells || 
                                                 (warehouse.blocks_count || 0) * (warehouse.shelves_per_block || 0) * (warehouse.cells_per_shelf || 0)}
                                              </p>
                                            </div>
                                            <Grid3X3 className="h-6 w-6 text-blue-500" />
                                          </div>
                                        </div>
                                        
                                        <div className="bg-white p-3 rounded-lg border shadow-sm">
                                          <div className="flex items-center justify-between">
                                            <div>
                                              <p className="text-xs font-medium text-gray-500">–ó–∞–Ω—è—Ç–æ</p>
                                              <p className="text-xl font-bold text-red-600">
                                                {statistics?.occupied_cells || 0}
                                              </p>
                                            </div>
                                            <Package className="h-6 w-6 text-red-500" />
                                          </div>
                                        </div>
                                        
                                        <div className="bg-white p-3 rounded-lg border shadow-sm">
                                          <div className="flex items-center justify-between">
                                            <div>
                                              <p className="text-xs font-medium text-gray-500">–°–≤–æ–±–æ–¥–Ω–æ</p>
                                              <p className="text-xl font-bold text-green-600">
                                                {statistics?.free_cells || ((statistics?.total_cells || 0) - (statistics?.occupied_cells || 0))}
                                              </p>
                                            </div>
                                            <CheckCircle className="h-6 w-6 text-green-500" />
                                          </div>
                                        </div>
                                        
                                        <div className="bg-white p-3 rounded-lg border shadow-sm">
                                          <div className="flex items-center justify-between">
                                            <div>
                                              <p className="text-xs font-medium text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞</p>
                                              <p className="text-xl font-bold text-purple-600">
                                                {statistics?.occupancy_rate || Math.round(((statistics?.occupied_cells || 0) / (statistics?.total_cells || 1)) * 100)}%
                                              </p>
                                            </div>
                                            <Calculator className="h-6 w-6 text-purple-500" />
                                          </div>
                                        </div>
                                      </div>

                                      {/* –ò–°–ü–†–ê–í–õ–ï–ù–û: –†–µ–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –≥—Ä—É–∑–æ–≤ */}
                                      <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                                        <div className="bg-gradient-to-r from-purple-50 to-pink-50 p-3 rounded-lg border border-purple-200">
                                          <div className="flex items-center justify-between">
                                            <div>
                                              <p className="text-xs font-medium text-purple-700">–í–µ—Å (–∫–≥)</p>
                                              <p className="text-lg font-bold text-purple-900">
                                                {statistics?.total_weight_kg?.toLocaleString() || 0}
                                              </p>
                                            </div>
                                            <Package2 className="h-5 w-5 text-purple-600" />
                                          </div>
                                        </div>
                                        
                                        <div className="bg-gradient-to-r from-blue-50 to-cyan-50 p-3 rounded-lg border border-blue-200">
                                          <div className="flex items-center justify-between">
                                            <div>
                                              <p className="text-xs font-medium text-blue-700">–ö–æ–ª-–≤–æ –≥—Ä—É–∑–æ–≤</p>
                                              <p className="text-lg font-bold text-blue-900">
                                                {statistics?.total_cargo || 0}
                                              </p>
                                            </div>
                                            <FileText className="h-5 w-5 text-blue-600" />
                                          </div>
                                        </div>
                                        
                                        <div className="bg-gradient-to-r from-green-50 to-emerald-50 p-3 rounded-lg border border-green-200">
                                          <div className="flex items-center justify-between">
                                            <div>
                                              <p className="text-xs font-medium text-green-700">–ö–ª–∏–µ–Ω—Ç–æ–≤</p>
                                              <p className="text-lg font-bold text-green-900">
                                                {statistics?.unique_clients || 0}
                                              </p>
                                            </div>
                                            <Users className="h-5 w-5 text-green-600" />
                                          </div>
                                        </div>
                                        
                                        <div className="bg-gradient-to-r from-yellow-50 to-orange-50 p-3 rounded-lg border border-yellow-200">
                                          <div className="flex items-center justify-between">
                                            <div>
                                              <p className="text-xs font-medium text-yellow-700">–°—É–º–º–∞ (‚ÇΩ)</p>
                                              <p className="text-lg font-bold text-yellow-900">
                                                {statistics?.total_value_rub?.toLocaleString() || 0}
                                              </p>
                                            </div>
                                            <CreditCard className="h-5 w-5 text-yellow-600" />
                                          </div>
                                        </div>
                                      </div>

                                      {/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
                                      <div className="flex flex-wrap gap-3">
                                        <Button 
                                          onClick={() => setShowWarehouseScheme(warehouse.id)}
                                          className="bg-blue-600 hover:bg-blue-700"
                                        >
                                          <Grid3X3 className="mr-2 h-4 w-4" />
                                          –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ö–µ–º—ã —Å–∫–ª–∞–¥–∞
                                        </Button>
                                        <Button 
                                          variant="outline"
                                          onClick={() => openWarehouseReport(warehouse)}
                                        >
                                          <FileText className="mr-2 h-4 w-4" />
                                          –û—Ç—á–µ—Ç –ø–æ —Å–∫–ª–∞–¥—É
                                        </Button>
                                        <Button 
                                          variant="outline"
                                          onClick={async () => {
                                            setLoading(true);
                                            try {
                                              const stats = await fetchWarehouseStatisticsLazy(warehouse.id);
                                              setStatistics(stats);
                                              showAlert('–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∫–ª–∞–¥–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞!', 'success');
                                            } catch (error) {
                                              console.error('Error refreshing statistics:', error);
                                              showAlert('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏', 'error');
                                            } finally {
                                              setLoading(false);
                                            }
                                          }}
                                          disabled={loading}
                                        >
                                          <RefreshCw className={`mr-2 h-4 w-4 ${loading ? 'animate-spin' : ''}`} />
                                          –û–±–Ω–æ–≤–∏—Ç—å
                                        </Button>
                                      </div>
                                    </CardContent>
                                  </Card>
                                );
                              };
                              
                              return <WarehouseCard key={warehouse.id} warehouse={warehouse} />;
                            })}
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  )}

                  {/* –†–∞–∑–º–µ—â–µ–Ω–Ω—ã–π –≥—Ä—É–∑ */}
                  {activeTab === 'warehouses-placed-cargo' && (user?.role === 'admin' || user?.role === 'warehouse_operator') && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Package className="mr-2 h-5 w-5" />
                            –†–∞–∑–º–µ—â–µ–Ω–Ω—ã–π –≥—Ä—É–∑ ({fullyPlacedCargo.length})
                          </div>
                          <div className="flex items-center space-x-2">
                            <Button 
                              variant={placedCargoViewMode === 'table' ? 'default' : 'outline'}
                              onClick={() => setPlacedCargoViewMode('table')}
                              size="sm"
                            >
                              <List className="mr-2 h-4 w-4" />
                              –¢–∞–±–ª–∏—Ü–∞
                            </Button>
                            <Button 
                              variant={placedCargoViewMode === 'individual' ? 'default' : 'outline'}
                              onClick={() => setPlacedCargoViewMode('individual')}
                              size="sm"
                            >
                              <Grid className="mr-2 h-4 w-4" />
                              Individual Units
                            </Button>
                            <Button 
                              variant="outline"
                              onClick={() => fetchFullyPlacedCargo(fullyPlacedPage, fullyPlacedPerPage)}
                              className="text-blue-600 border-blue-300 hover:bg-blue-50"
                            >
                              <RefreshCw className="mr-2 h-4 w-4" />
                              –û–±–Ω–æ–≤–∏—Ç—å
                            </Button>
                          </div>
                        </CardTitle>
                        <CardDescription>
                          –í—Å–µ –∑–∞—è–≤–∫–∏ —Å —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–º –≥—Ä—É–∑–æ–º (—á–∞—Å—Ç–∏—á–Ω–æ –∏ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ)
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        {fullyPlacedLoading ? (
                          <div className="flex items-center justify-center py-12">
                            <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                            <span className="ml-2 text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–Ω–æ–≥–æ –≥—Ä—É–∑–∞...</span>
                          </div>
                        ) : fullyPlacedCargo.length === 0 ? (
                          <div className="text-center py-8">
                            <Package className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                            <p className="text-gray-500 mb-4">–ù–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–Ω–æ–≥–æ –≥—Ä—É–∑–∞</p>
                            <p className="text-sm text-gray-400">–í—Å–µ –∑–∞—è–≤–∫–∏ —Å –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–º–∏ –≥—Ä—É–∑–∞–º–∏ –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–µ–Ω—ã –∑–¥–µ—Å—å</p>
                          </div>
                        ) : (
                          <div className="space-y-4">
                            {placedCargoViewMode === 'table' ? (
                              // –¢–∞–±–ª–∏—á–Ω—ã–π —Ä–µ–∂–∏–º
                              <>
                                {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∞–±–ª–∏—Ü—ã */}
                                <div className="grid grid-cols-8 gap-4 p-4 bg-gray-100 rounded-lg font-semibold text-sm text-gray-700">
                                  <div>–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏</div>
                                  <div>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</div>
                                  <div>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</div>
                                  <div>–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è</div>
                                  <div>–Ø—á–µ–π–∫–∞</div>
                                  <div>–†–∞–∑–º–µ—â–µ–Ω–∏–µ</div>
                                  <div>–û–ø–µ—Ä–∞—Ç–æ—Ä</div>
                                  <div>–î–µ–π—Å—Ç–≤–∏—è</div>
                                </div>
                                
                                {/* –°–ø–∏—Å–æ–∫ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤ */}
                                {fullyPlacedCargo.map((cargoItem) => (
                                  <Card key={cargoItem.id} className={`border-l-4 ${cargoItem.is_fully_placed ? 'border-l-green-500 bg-gradient-to-r from-green-50 to-white' : 'border-l-yellow-500 bg-gradient-to-r from-yellow-50 to-white'}`}>
                                    <CardContent className="p-4">
                                      <div className="grid grid-cols-8 gap-4 items-center">
                                        {/* –ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏ */}
                                        <div className="font-semibold text-blue-600">
                                          {cargoItem.request_number || cargoItem.cargo_number}
                                        </div>
                                        
                                        {/* –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å */}
                                        <div className="text-sm">
                                          <div className="font-medium">{cargoItem.sender_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                                          <div className="text-gray-500">{cargoItem.sender_phone || ''}</div>
                                        </div>
                                        
                                        {/* –ü–æ–ª—É—á–∞—Ç–µ–ª—å */}
                                        <div className="text-sm">
                                          <div className="font-medium">{cargoItem.recipient_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                                          <div className="text-gray-500">{cargoItem.recipient_address || ''}</div>
                                        </div>
                                        
                                        {/* –¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è */}
                                        <div className="text-sm font-medium">
                                          {cargoItem.recipient_phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                                        </div>
                                        
                                        {/* –Ø—á–µ–π–∫–∞ */}
                                        <div className="text-sm">
                                          {cargoItem.individual_units && cargoItem.individual_units.length > 0 ? (
                                            <div className="flex flex-wrap gap-1">
                                              {cargoItem.individual_units
                                                .filter(unit => unit.is_placed)
                                                .map((unit, index) => (
                                                  <Badge key={index} variant="outline" className="text-xs">
                                                    {unit.placement_info || unit.warehouse_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                                                  </Badge>
                                                ))
                                              }
                                            </div>
                                          ) : (
                                            <span className="text-gray-500">–ù–µ —É–∫–∞–∑–∞–Ω–æ</span>
                                          )}
                                        </div>
                                        
                                        {/* –†–∞–∑–º–µ—â–µ–Ω–∏–µ */}
                                        <div className="text-sm">
                                          <Badge variant={cargoItem.is_fully_placed ? "success" : "secondary"} className={cargoItem.is_fully_placed ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800"}>
                                            {cargoItem.progress_text || `${cargoItem.placed_units}/${cargoItem.total_units}`}
                                          </Badge>
                                          <div className="text-xs text-gray-500 mt-1">
                                            {cargoItem.created_at ? new Date(cargoItem.created_at).toLocaleDateString() : ''}
                                          </div>
                                        </div>
                                        
                                        {/* –û–ø–µ—Ä–∞—Ç–æ—Ä */}
                                        <div className="text-sm">
                                          <div className="font-medium">
                                            {cargoItem.placing_operator && cargoItem.placing_operator !== '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' 
                                              ? cargoItem.placing_operator 
                                              : cargoItem.operator_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                                          </div>
                                          <div className="text-xs text-gray-500">
                                            –†–∞–∑–º–µ—Å—Ç–∏–ª: {cargoItem.placing_operator && cargoItem.placing_operator !== '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ' 
                                              ? cargoItem.placing_operator 
                                              : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}
                                          </div>
                                        </div>
                                        
                                        {/* –î–µ–π—Å—Ç–≤–∏—è */}
                                        <div className="flex space-x-2">
                                          <Button 
                                            variant="ghost" 
                                            size="sm"
                                            onClick={() => {
                                              setSelectedPlacedCargo(cargoItem);
                                              setPlacedCargoViewMode('individual');
                                            }}
                                          >
                                            <Grid className="h-4 w-4" />
                                          </Button>
                                          <Button 
                                            variant="ghost" 
                                            size="sm"
                                            onClick={() => {
                                              // –ü–æ–∫–∞–∑–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –∑–∞—è–≤–∫–∏
                                              setSelectedCargoForDetails(cargoItem);
                                              setShowPlacementDetailsModal(true);
                                            }}
                                          >
                                            <Eye className="h-4 w-4" />
                                          </Button>
                                        </div>
                                      </div>
                                    </CardContent>
                                  </Card>
                                ))}
                              </>
                            ) : (
                              // Individual Units —Ä–µ–∂–∏–º
                              <div className="space-y-4">
                                {selectedPlacedCargo ? (
                                  <div>
                                    {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∫–Ω–æ–ø–∫–æ–π –≤–æ–∑–≤—Ä–∞—Ç–∞ */}
                                    <div className="flex items-center justify-between mb-4">
                                      <h3 className="text-lg font-semibold">
                                        Individual Units - –ó–∞—è–≤–∫–∞ {selectedPlacedCargo.cargo_number}
                                      </h3>
                                      <Button 
                                        variant="outline" 
                                        onClick={() => {
                                          setSelectedPlacedCargo(null);
                                          setPlacedCargoViewMode('table');
                                        }}
                                      >
                                        <ArrowLeft className="mr-2 h-4 w-4" />
                                        –ù–∞–∑–∞–¥ –∫ —Å–ø–∏—Å–∫—É
                                      </Button>
                                    </div>
                                    
                                    {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ */}
                                    <Card className="mb-4">
                                      <CardContent className="p-4">
                                        <div className="grid grid-cols-4 gap-4 text-sm">
                                          <div>
                                            <span className="font-medium">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</span>
                                            <p>{selectedPlacedCargo.sender_full_name}</p>
                                            <p className="text-gray-600">{selectedPlacedCargo.sender_phone}</p>
                                          </div>
                                          <div>
                                            <span className="font-medium">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</span>
                                            <p>{selectedPlacedCargo.recipient_full_name}</p>
                                            <p className="text-gray-600">{selectedPlacedCargo.recipient_phone}</p>
                                          </div>
                                          <div>
                                            <span className="font-medium">–ü—Ä–æ–≥—Ä–µ—Å—Å:</span>
                                            <p className="text-lg font-semibold">{selectedPlacedCargo.progress_text}</p>
                                          </div>
                                          <div>
                                            <span className="font-medium">–°—Ç–∞—Ç—É—Å:</span>
                                            <Badge variant={selectedPlacedCargo.is_fully_placed ? "success" : "secondary"} className={selectedPlacedCargo.is_fully_placed ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800"}>
                                              {selectedPlacedCargo.is_fully_placed ? "–ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–æ" : "–ß–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω–æ"}
                                            </Badge>
                                          </div>
                                        </div>
                                      </CardContent>
                                    </Card>
                                    
                                    {/* Individual Units –∫–∞—Ä—Ç–æ—á–∫–∏ */}
                                    <div className="grid gap-4 md:grid-cols-2 lg:grid-cols-3">
                                      {selectedPlacedCargo.individual_units?.map((unit, index) => (
                                        <Card key={index} className={`${unit.is_placed ? 'border-green-200 bg-green-50' : 'border-yellow-200 bg-yellow-50'}`}>
                                          <CardContent className="p-4">
                                            <div className="space-y-2">
                                              <div className="flex items-center justify-between">
                                                <h4 className="font-semibold text-sm">{unit.individual_number}</h4>
                                                <Badge variant={unit.is_placed ? "success" : "secondary"} className={unit.is_placed ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800"}>
                                                  {unit.status_label}
                                                </Badge>
                                              </div>
                                              {unit.is_placed && (
                                                <div className="text-xs text-gray-600">
                                                  <p><span className="font-medium">–Ø—á–µ–π–∫–∞:</span> {unit.placement_info}</p>
                                                  <p><span className="font-medium">–û–ø–µ—Ä–∞—Ç–æ—Ä:</span> {unit.placed_by}</p>
                                                  {unit.placed_at && (
                                                    <p><span className="font-medium">–†–∞–∑–º–µ—â–µ–Ω–æ:</span> {new Date(unit.placed_at).toLocaleString()}</p>
                                                  )}
                                                </div>
                                              )}
                                            </div>
                                          </CardContent>
                                        </Card>
                                      ))}
                                    </div>
                                  </div>
                                ) : (
                                  // –í—ã–±–æ—Ä –∑–∞—è–≤–∫–∏ –¥–ª—è Individual Units —Ä–µ–∂–∏–º–∞
                                  <div className="space-y-4">
                                    <h3 className="text-lg font-semibold mb-4">–í—ã–±–µ—Ä–∏—Ç–µ –∑–∞—è–≤–∫—É –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ Individual Units</h3>
                                    {fullyPlacedCargo.map((cargoItem) => (
                                      <Card key={cargoItem.id} className="cursor-pointer hover:shadow-md transition-shadow" onClick={() => setSelectedPlacedCargo(cargoItem)}>
                                        <CardContent className="p-4">
                                          <div className="flex items-center justify-between">
                                            <div>
                                              <h4 className="font-semibold">{cargoItem.cargo_number}</h4>
                                              <p className="text-sm text-gray-600">{cargoItem.sender_full_name} ‚Üí {cargoItem.recipient_full_name}</p>
                                            </div>
                                            <div className="text-right">
                                              <Badge variant={cargoItem.is_fully_placed ? "success" : "secondary"} className={cargoItem.is_fully_placed ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800"}>
                                                {cargoItem.progress_text}
                                              </Badge>
                                              <p className="text-xs text-gray-500 mt-1">{cargoItem.total_units} –µ–¥–∏–Ω–∏—Ü</p>
                                            </div>
                                          </div>
                                        </CardContent>
                                      </Card>
                                    ))}
                                  </div>
                                )}
                              </div>
                            )}
                            
                            {/* –ü–∞–≥–∏–Ω–∞—Ü–∏—è */}
                            {placedCargoViewMode === 'table' && fullyPlacedPagination && fullyPlacedPagination.total_pages > 1 && (
                              <div className="mt-6">
                                <DataPagination
                                  currentPage={fullyPlacedPagination.page || 1}
                                  totalPages={fullyPlacedPagination.total_pages || 1}
                                  onPageChange={(page) => fetchFullyPlacedCargo(page, fullyPlacedPerPage)}
                                  itemsPerPage={fullyPlacedPerPage}
                                  onItemsPerPageChange={(perPage) => fetchFullyPlacedCargo(1, perPage)}
                                />
                              </div>
                            )}
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  )}

                  {/* –ê–î–ú–ò–ù–ò–°–¢–†–ê–¢–ò–í–ù–´–ô –ò–ù–¢–ï–†–§–ï–ô–° (–¢–û–õ–¨–ö–û –î–õ–Ø –ê–î–ú–ò–ù–û–í) */}
                  {/* –°–æ–∑–¥–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞ */}
                  {activeTab === 'warehouses-create' && user?.role === 'admin' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Plus className="mr-2 h-5 w-5" />
                          –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π —Å–∫–ª–∞–¥
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <form onSubmit={handleCreateWarehouse} className="space-y-4 max-w-md">
                          <div>
                            <Label htmlFor="warehouse_name">–ò–º—è —Å–∫–ª–∞–¥–∞</Label>
                            <Input
                              id="warehouse_name"
                              value={warehouseForm.name}
                              onChange={(e) => setWarehouseForm({...warehouseForm, name: e.target.value})}
                              placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∫–ª–∞–¥ –ú–æ—Å–∫–≤–∞-1"
                              required
                            />
                          </div>

                          <div>
                            <Label htmlFor="warehouse_location">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ —Å–∫–ª–∞–¥–∞</Label>
                            <Input
                              id="warehouse_location"
                              value={warehouseForm.location}
                              onChange={(e) => setWarehouseForm({...warehouseForm, location: e.target.value})}
                              placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞, —É–ª. –°–∫–ª–∞–¥—Å–∫–∞—è, 1"
                              required
                            />
                          </div>

                          <div>
                            <Label htmlFor="blocks_count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤ –Ω–∞ —Å–∫–ª–∞–¥–µ (1-9)</Label>
                            <Select 
                              key="warehouse-blocks-select"
                              value={warehouseForm.blocks_count.toString()} 
                              onValueChange={(value) => setWarehouseForm({...warehouseForm, blocks_count: parseInt(value)})}
                            >
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                              <SelectContent>
                                {[1,2,3,4,5,6,7,8,9].map(num => (
                                  <SelectItem key={`warehouse-blocks-${num}`} value={num.toString()}>
                                    {num} –±–ª–æ–∫{num > 1 ? (num < 5 ? '–∞' : '–æ–≤') : ''}
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                          </div>

                          <div>
                            <Label htmlFor="shelves_per_block">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ª–æ–∫ –Ω–∞ –∫–∞–∂–¥–æ–º –±–ª–æ–∫–µ (1-3)</Label>
                            <Select 
                              key="warehouse-shelves-select"
                              value={warehouseForm.shelves_per_block.toString()} 
                              onValueChange={(value) => setWarehouseForm({...warehouseForm, shelves_per_block: parseInt(value)})}
                            >
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                              <SelectContent>
                                <SelectItem key="warehouse-shelves-1" value="1">1 –ø–æ–ª–∫–∞</SelectItem>
                                <SelectItem key="warehouse-shelves-2" value="2">2 –ø–æ–ª–∫–∏</SelectItem>
                                <SelectItem key="warehouse-shelves-3" value="3">3 –ø–æ–ª–∫–∏</SelectItem>
                              </SelectContent>
                            </Select>
                          </div>

                          <div>
                            <Label htmlFor="cells_per_shelf">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —è—á–µ–µ–∫ –Ω–∞ –∫–∞–∂–¥–æ–π –ø–æ–ª–∫–µ</Label>
                            <Input
                              key="warehouse-cells-input"
                              id="cells_per_shelf"
                              type="number"
                              min="1"
                              max="50"
                              value={warehouseForm.cells_per_shelf || ''}
                              onChange={(e) => setWarehouseForm({...warehouseForm, cells_per_shelf: parseInt(e.target.value) || 1})}
                              required
                            />
                          </div>

                          <div key="warehouse-params-display" className="bg-gray-50 p-4 rounded-lg">
                            <h4 className="font-medium mb-2">–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–∫–ª–∞–¥–∞:</h4>
                            <div className="text-sm text-gray-600 space-y-1">
                              <p>–ë–ª–æ–∫–æ–≤: {warehouseForm.blocks_count || 1}</p>
                              <p>–ü–æ–ª–æ–∫ –≤ –±–ª–æ–∫–µ: {warehouseForm.shelves_per_block || 1}</p>
                              <p>–Ø—á–µ–µ–∫ –Ω–∞ –ø–æ–ª–∫–µ: {warehouseForm.cells_per_shelf || 1}</p>
                              <p className="font-medium text-gray-900">
                                –û–±—â–∞—è –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: {(warehouseForm.blocks_count || 1) * (warehouseForm.shelves_per_block || 1) * (warehouseForm.cells_per_shelf || 1)} —è—á–µ–µ–∫
                              </p>
                            </div>
                          </div>

                          <Button type="submit" className="w-full">
                            <Plus className="mr-2 h-4 w-4" />
                            –°–æ–∑–¥–∞—Ç—å —Å–∫–ª–∞–¥
                          </Button>
                        </form>
                      </CardContent>
                    </Card>
                  )}

                  {/* –°–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤ */}
                  {(activeTab === 'warehouses-list' || !activeTab || activeTab === 'warehouses') && user?.role === 'admin' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Building className="mr-2 h-5 w-5" />
                            –°–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤ ({warehouses.length})
                          </div>
                          <div className="flex items-center space-x-2">
                            <Button 
                              variant="outline"
                              onClick={async () => {
                                try {
                                  const response = await apiCall('/api/admin/warehouses/update-id-numbers', 'POST');
                                  if (response.updated_count > 0) {
                                    showAlert(`–û–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–æ–º–µ—Ä–∞ ${response.updated_count} —Å–∫–ª–∞–¥–æ–≤ –¥–ª—è —É–Ω–∏–∫–∞–ª—å–Ω–æ—Å—Ç–∏ QR –∫–æ–¥–æ–≤`, 'success');
                                    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤
                                    fetchWarehouses();
                                  } else {
                                    showAlert('–í—Å–µ —Å–∫–ª–∞–¥—ã —É–∂–µ –∏–º–µ—é—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –Ω–æ–º–µ—Ä–∞', 'info');
                                  }
                                } catch (error) {
                                  console.error('Error updating warehouse numbers:', error);
                                  showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –Ω–æ–º–µ—Ä–æ–≤ —Å–∫–ª–∞–¥–æ–≤: ' + error.message, 'error');
                                }
                              }}
                              className="text-blue-600 border-blue-300 hover:bg-blue-50"
                            >
                              <RefreshCw className="mr-2 h-4 w-4" />
                              –û–±–Ω–æ–≤–∏—Ç—å –Ω–æ–º–µ—Ä–∞ —Å–∫–ª–∞–¥–æ–≤
                            </Button>
                            {selectedWarehouses.length > 0 && (
                              <Button 
                                variant="destructive" 
                                onClick={handleBulkDeleteWarehouses}
                                disabled={bulkDeleteLoading}
                              >
                                <Trash2 className="mr-2 h-4 w-4" />
                                –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ ({selectedWarehouses.length})
                              </Button>
                            )}
                            <Button onClick={openWarehouseCreationPage}>
                              <Plus className="mr-2 h-4 w-4" />
                              –°–æ–∑–¥–∞—Ç—å —Å–∫–ª–∞–¥
                            </Button>
                            
                            {/* –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤ –¥–ª—è –≤—Å–µ—Ö —Å–∫–ª–∞–¥–æ–≤ */}
                            <Button 
                              onClick={() => setWarehouseSelectionModal(true)}
                              className="bg-orange-600 hover:bg-orange-700"
                            >
                              <QrCode className="mr-2 h-4 w-4" />
                              –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤
                            </Button>
                          </div>
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {warehouses.length === 0 ? (
                            <div className="text-center py-8">
                              <Building className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500 mb-4">–ù–µ—Ç —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤</p>
                              <Button onClick={() => setActiveTab('warehouses-create')}>
                                <Plus className="mr-2 h-4 w-4" />
                                –°–æ–∑–¥–∞—Ç—å –ø–µ—Ä–≤—ã–π —Å–∫–ª–∞–¥
                              </Button>
                            </div>
                          ) : (
                            <>
                              {/* –ü–∞–Ω–µ–ª—å –º–∞—Å—Å–æ–≤–æ–≥–æ –≤—ã–±–æ—Ä–∞ */}
                              <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                                <div className="flex items-center space-x-2">
                                  <input
                                    type="checkbox"
                                    checked={selectAllWarehouses}
                                    onChange={(e) => handleSelectAllWarehouses(e.target.checked)}
                                    className="rounded"
                                  />
                                  <label className="text-sm font-medium">
                                    {selectAllWarehouses ? '–û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–±–æ—Ä –≤—Å–µ—Ö' : '–í—ã–±—Ä–∞—Ç—å –≤—Å–µ —Å–∫–ª–∞–¥—ã'}
                                  </label>
                                </div>
                                <div className="text-sm text-gray-600">
                                  {selectedWarehouses.length > 0 ? (
                                    <span>–í—ã–±—Ä–∞–Ω–æ: {selectedWarehouses.length} –∏–∑ {warehouses.length}</span>
                                  ) : (
                                    <span>–í—Å–µ–≥–æ —Å–∫–ª–∞–¥–æ–≤: {warehouses.length}</span>
                                  )}
                                </div>
                              </div>

                              {warehouses.map((warehouse) => (
                                <Card key={warehouse.id} className="border-l-4 border-l-blue-500 bg-gradient-to-r from-blue-50 to-white">
                                  <CardContent className="p-6">
                                    {/* –ß–µ–∫–±–æ–∫—Å –∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å–∫–ª–∞–¥–∞ */}
                                    <div className="flex items-start justify-between mb-6">
                                      <div className="flex items-start space-x-3">
                                        <input
                                          type="checkbox"
                                          checked={selectedWarehouses.includes(warehouse.id)}
                                          onChange={(e) => handleWarehouseSelect(warehouse.id, e.target.checked)}
                                          className="rounded mt-2"
                                        />
                                        <div>
                                          <h3 className="font-bold text-xl text-gray-900 mb-2">
                                            üè≠ {warehouse.name}
                                          </h3>
                                          <p className="text-gray-600 flex items-center mb-1">
                                            <MapPin className="inline h-4 w-4 mr-2" />
                                            {warehouse.location}
                                          </p>
                                          <p className="text-sm text-gray-500">
                                            –ë–ª–æ–∫–æ–≤: {warehouse.blocks_count || 0} | –ü–æ–ª–æ–∫: {warehouse.shelves_per_block || 0} | –Ø—á–µ–µ–∫ –Ω–∞ –ø–æ–ª–∫—É: {warehouse.cells_per_shelf || 0}
                                          </p>
                                        </div>
                                      </div>
                                      <Badge className="bg-green-100 text-green-800 border-green-200">
                                        <CheckCircle className="w-3 h-3 mr-1" />
                                        –ê–∫—Ç–∏–≤–Ω—ã–π
                                      </Badge>
                                    </div>

                                    {/* –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–∫–ª–∞–¥–∞ —Å lazy loading */}
                                    <WarehouseStatistics warehouse={warehouse} />

                                    {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å lazy loading */}
                                    <WarehouseExtendedStatistics warehouse={warehouse} />

                                    {/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
                                    <div className="flex flex-wrap gap-3">
                                      <Button 
                                        onClick={() => setShowWarehouseScheme(warehouse.id)}
                                        className="bg-blue-600 hover:bg-blue-700"
                                      >
                                        <Grid3X3 className="mr-2 h-4 w-4" />
                                        –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ö–µ–º—ã —Å–∫–ª–∞–¥–∞
                                      </Button>
                                      <Button 
                                        variant="outline"
                                        onClick={() => openWarehouseReport(warehouse)}
                                      >
                                        <FileText className="mr-2 h-4 w-4" />
                                        –û—Ç—á–µ—Ç –ø–æ —Å–∫–ª–∞–¥—É
                                      </Button>
                                      <Button 
                                        variant="outline"
                                        onClick={() => openCellManagement(warehouse)}
                                      >
                                        <Settings className="mr-2 h-4 w-4" />
                                        –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —è—á–µ–π–∫–∞–º–∏
                                      </Button>
                                      <Button 
                                        variant="outline" 
                                        onClick={() => {
                                          setSelectedWarehouse(warehouse);
                                          setActiveTab('warehouses-manage');
                                        }}
                                        className="text-blue-600 border-blue-200 hover:bg-blue-50"
                                      >
                                        <Edit className="mr-2 h-4 w-4" />
                                        –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                      </Button>
                                      <Button 
                                        variant="outline" 
                                        onClick={() => openWarehouseCitiesManagement(warehouse)}
                                        className="text-green-600 border-green-200 hover:bg-green-50"
                                      >
                                        <MapPin className="mr-2 h-4 w-4" />
                                        –ì–æ—Ä–æ–¥–∞ –¥–æ—Å—Ç–∞–≤–∫–∏
                                      </Button>
                                      <Button 
                                        variant="destructive" 
                                        onClick={() => handleDeleteWarehouse(warehouse.id)}
                                        className="bg-red-600 hover:bg-red-700"
                                      >
                                        <Trash2 className="mr-2 h-4 w-4" />
                                        –£–¥–∞–ª–∏—Ç—å
                                      </Button>
                                    </div>
                                  </CardContent>
                                </Card>
                              ))}
                            </>
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ */}
                  {activeTab === 'warehouses-manage' && user?.role === 'admin' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Package2 className="mr-2 h-5 w-5" />
                          –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞–º–∏ –Ω–∞ —Å–∫–ª–∞–¥–µ
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="flex space-x-2 mb-4">
                          <Input
                            placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É –≥—Ä—É–∑–∞ –∏–ª–∏ –∏–º–µ–Ω–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            className="flex-1"
                          />
                          <Button onClick={handleWarehouseSearch}>
                            <Search className="h-4 w-4" />
                          </Button>
                        </div>
                        
                        <div className="space-y-4">
                          {warehouseCargo.map((item) => (
                            <div key={item.id} className="border rounded-lg p-4">
                              <div className="flex justify-between items-start mb-4">
                                <div>
                                  <h3 className="font-semibold">{item.cargo_number}</h3>
                                  <p className="text-sm text-gray-600">–ü–æ–ª—É—á–∞—Ç–µ–ª—å: {item.recipient_name}</p>
                                  <p className="text-sm text-gray-600">–í–µ—Å: {item.weight} –∫–≥</p>
                                  {item.accepted_by_operator && (
                                    <p className="text-sm text-gray-500">–ü—Ä–∏–Ω—è–ª: {item.accepted_by_operator}</p>
                                  )}
                                  {item.placed_by_operator && (
                                    <p className="text-sm text-gray-500">–†–∞–∑–º–µ—Å—Ç–∏–ª: {item.placed_by_operator}</p>
                                  )}
                                </div>
                                {getStatusBadge(item.status)}
                              </div>
                              
                              <div className="flex space-x-2">
                                <Select onValueChange={(value) => updateCargoStatus(item.id, value)}>
                                  <SelectTrigger className="w-40">
                                    <SelectValue placeholder="–ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç–∞—Ç—É—Å" />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="accepted">–ü—Ä–∏–Ω—è—Ç—å</SelectItem>
                                    <SelectItem value="in_transit">–û—Ç–ø—Ä–∞–≤–∏—Ç—å</SelectItem>
                                    <SelectItem value="arrived_destination">–ü—Ä–∏–±—ã–ª</SelectItem>
                                    <SelectItem value="completed">–í—ã–¥–∞—Ç—å</SelectItem>
                                  </SelectContent>
                                </Select>
                                
                                <Input
                                  placeholder="–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ –Ω–∞ —Å–∫–ª–∞–¥–µ"
                                  className="flex-1"
                                  onKeyPress={(e) => {
                                    if (e.key === 'Enter') {
                                      updateCargoStatus(item.id, item.status, e.target.value);
                                      e.target.value = '';
                                    }
                                  }}
                                />
                              </div>
                              
                              {item.warehouse_location && (
                                <p className="text-sm text-blue-600 mt-2">
                                  <MapPin className="inline h-4 w-4 mr-1" />
                                  –¢–µ–∫—É—â–µ–µ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏–µ: {item.warehouse_location}
                                </p>
                              )}
                            </div>
                          ))}
                        </div>
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}

              {/* –§–∏–Ω–∞–Ω—Å—ã (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–∞) */}
              {activeSection === 'finances' && user?.role === 'admin' && (
                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center">
                      <DollarSign className="mr-2 h-5 w-5" />
                      –§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –æ–±–∑–æ—Ä
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-gray-500">–†–∞–∑–¥–µ–ª —Ñ–∏–Ω–∞–Ω—Å–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
                  </CardContent>
                </Card>
              )}

              {/* –û—Ç—á–µ—Ç—ã */}
              {activeSection === 'reports' && (
                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center">
                      <FileText className="mr-2 h-5 w-5" />
                      –û—Ç—á–µ—Ç—ã
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-gray-500">–†–∞–∑–¥–µ–ª –æ—Ç—á–µ—Ç–æ–≤ –≤ —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–µ</p>
                  </CardContent>
                </Card>
              )}

              {/* –ö–∞—Å—Å–∞ */}
              {activeSection === 'cashier' && (
                <div className="space-y-6">
                  {/* –ü—Ä–∏—ë–º –æ–ø–ª–∞—Ç—ã */}
                  {activeTab === 'cashier-payment' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <CreditCard className="mr-2 h-5 w-5" />
                          –ü—Ä–∏—ë–º –æ–ø–ª–∞—Ç—ã
                        </CardTitle>
                        <CardDescription>
                          –ü–æ–∏—Å–∫ –≥—Ä—É–∑–∞ –ø–æ –Ω–æ–º–µ—Ä—É –∏ –ø—Ä–∏–µ–º –æ–ø–ª–∞—Ç—ã –æ—Ç –∫–ª–∏–µ–Ω—Ç–∞
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <Button onClick={() => setPaymentModal(true)} className="mb-4">
                          <Plus className="mr-2 h-4 w-4" />
                          –ü—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É
                        </Button>
                      </CardContent>
                    </Card>
                  )}

                  {/* –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ */}
                  {(activeTab === 'cashier-unpaid' || !activeTab || activeTab === 'cashier') && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Package className="mr-2 h-5 w-5" />
                            –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ ({unpaidCargo.length})
                          </div>
                          <Button onClick={fetchUnpaidCargo}>
                            –û–±–Ω–æ–≤–∏—Ç—å
                          </Button>
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {unpaidCargo.length === 0 ? (
                            <div className="text-center py-8">
                              <CheckCircle className="mx-auto h-12 w-12 text-green-500 mb-4" />
                              <p className="text-gray-500">–í—Å–µ –≥—Ä—É–∑—ã –æ–ø–ª–∞—á–µ–Ω—ã!</p>
                            </div>
                          ) : (
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  <TableHead>–ù–æ–º–µ—Ä –≥—Ä—É–∑–∞</TableHead>
                                  <TableHead>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</TableHead>
                                  <TableHead>–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ</TableHead>
                                  <TableHead>–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞</TableHead>
                                  <TableHead>–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {unpaidCargo.map((item) => (
                                  <TableRow key={item.id}>
                                    <TableCell className="font-medium">{item.cargo_number}</TableCell>
                                    <TableCell>
                                      <div>
                                        <div className="font-medium">{item.sender_full_name}</div>
                                        <div className="text-sm text-gray-500">{item.sender_phone}</div>
                                      </div>
                                    </TableCell>
                                    <TableCell className="font-bold text-red-600">{item.declared_value} ‚ÇΩ</TableCell>
                                    <TableCell>{new Date(item.created_at).toLocaleDateString('ru-RU')}</TableCell>
                                    <TableCell>
                                      <Button
                                        size="sm"
                                        onClick={() => {
                                          setPaymentForm({...paymentForm, cargo_number: item.cargo_number});
                                          setPaymentModal(true);
                                        }}
                                      >
                                        <CreditCard className="mr-2 h-4 w-4" />
                                        –ü—Ä–∏–Ω—è—Ç—å –æ–ø–ª–∞—Ç—É
                                      </Button>
                                    </TableCell>
                                  </TableRow>
                                ))}
                              </TableBody>
                            </Table>
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* –ò—Å—Ç–æ—Ä–∏—è –æ–ø–ª–∞—Ç—ã */}
                  {activeTab === 'cashier-history' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <FileText className="mr-2 h-5 w-5" />
                            –ò—Å—Ç–æ—Ä–∏—è –æ–ø–ª–∞—Ç—ã ({paymentHistory.length})
                          </div>
                          <Button onClick={fetchPaymentHistory}>
                            –û–±–Ω–æ–≤–∏—Ç—å
                          </Button>
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {paymentHistory.length === 0 ? (
                            <div className="text-center py-8">
                              <FileText className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–ª–∞—Ç—ã –ø—É—Å—Ç–∞</p>
                            </div>
                          ) : (
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  <TableHead>–ù–æ–º–µ—Ä –≥—Ä—É–∑–∞</TableHead>
                                  <TableHead>–ö–ª–∏–µ–Ω—Ç</TableHead>
                                  <TableHead>–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ</TableHead>
                                  <TableHead>–û–ø–ª–∞—á–µ–Ω–æ</TableHead>
                                  <TableHead>–î–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã</TableHead>
                                  <TableHead>–ö–∞—Å—Å–∏—Ä</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {paymentHistory.map((transaction) => (
                                  <TableRow key={transaction.id}>
                                    <TableCell className="font-medium">{transaction.cargo_number}</TableCell>
                                    <TableCell>
                                      <div>
                                        <div className="font-medium">{transaction.customer_name}</div>
                                        <div className="text-sm text-gray-500">{transaction.customer_phone}</div>
                                      </div>
                                    </TableCell>
                                    <TableCell>{transaction.amount_due} ‚ÇΩ</TableCell>
                                    <TableCell className="font-bold text-green-600">{transaction.amount_paid} ‚ÇΩ</TableCell>
                                    <TableCell>{new Date(transaction.payment_date).toLocaleDateString('ru-RU')} {new Date(transaction.payment_date).toLocaleTimeString('ru-RU')}</TableCell>
                                    <TableCell>{transaction.processed_by}</TableCell>
                                  </TableRow>
                                ))}
                              </TableBody>
                            </Table>
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}

              {/* –õ–æ–≥–∏—Å—Ç–∏–∫–∞ */}
              {activeSection === 'logistics' && (
                <div className="space-y-6">
                  {/* –ü—Ä–∏—ë–º –º–∞—à–∏–Ω—É */}
                  {activeTab === 'logistics-add-transport' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Plus className="mr-2 h-5 w-5" />
                          –ü—Ä–∏—ë–º –º–∞—à–∏–Ω—É
                        </CardTitle>
                        <CardDescription>
                          –î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—ã–π —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –≤ —Å–∏—Å—Ç–µ–º—É –ª–æ–≥–∏—Å—Ç–∏–∫–∏
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <form onSubmit={handleCreateTransport} className="space-y-4 max-w-2xl">
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                              <Label htmlFor="driver_name">–§–ò–û –≤–æ–¥–∏—Ç–µ–ª—è</Label>
                              <Input
                                id="driver_name"
                                value={transportForm.driver_name}
                                onChange={(e) => setTransportForm({...transportForm, driver_name: e.target.value})}
                                placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
                                required
                              />
                            </div>
                            <div>
                              <Label htmlFor="driver_phone">–¢–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è</Label>
                              <Input
                                id="driver_phone"
                                type="tel"
                                value={transportForm.driver_phone}
                                onChange={(e) => setTransportForm({...transportForm, driver_phone: e.target.value})}
                                placeholder="+79123456789"
                                required
                              />
                            </div>
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                              <Label htmlFor="transport_number">–ù–æ–º–µ—Ä —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</Label>
                              <Input
                                id="transport_number"
                                value={transportForm.transport_number}
                                onChange={(e) => setTransportForm({...transportForm, transport_number: e.target.value})}
                                placeholder="–ê123–ë–í77"
                                required
                              />
                            </div>
                            <div>
                              <Label htmlFor="capacity_kg">–û–±—ä—ë–º –¥–æ–ø—É—Å–∫–∞–µ–º—ã—Ö –≥—Ä—É–∑–æ–≤ (–∫–≥)</Label>
                              <Input
                                id="capacity_kg"
                                type="number"
                                step="0.1"
                                value={transportForm.capacity_kg}
                                onChange={(e) => setTransportForm({...transportForm, capacity_kg: e.target.value})}
                                placeholder="5000"
                                required
                              />
                            </div>
                          </div>

                          <div>
                            <Label htmlFor="direction">–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</Label>
                            <Input
                              id="direction"
                              value={transportForm.direction}
                              onChange={(e) => setTransportForm({...transportForm, direction: e.target.value})}
                              placeholder="–ú–æ—Å–∫–≤–∞ - –î—É—à–∞–Ω–±–µ"
                              required
                            />
                          </div>

                          <Button type="submit" className="w-full">
                            <Plus className="mr-2 h-4 w-4" />
                            –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
                          </Button>
                        </form>
                      </CardContent>
                    </Card>
                  )}

                  {/* –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–≤ */}
                  {activeTab === 'logistics-transport-list' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Truck className="mr-2 h-5 w-5" />
                            –°–ø–∏—Å–æ–∫ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–≤ ({transports.filter(t => t.status === 'empty' || t.status === 'filled').length})
                          </div>
                          <div className="flex space-x-2">
                            {user?.role === 'admin' && selectedTransports.length > 0 && (
                              <Button
                                onClick={handleBulkDeleteTransports}
                                variant="outline"
                                className="text-red-600 border-red-300 hover:bg-red-50"
                              >
                                <Trash2 className="mr-2 h-4 w-4" />
                                –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ ({selectedTransports.length})
                              </Button>
                            )}
                            <Button 
                              variant="outline" 
                              onClick={() => setInterwarehouseTransportModal(true)}
                              disabled={user?.role !== 'admin' && user?.role !== 'warehouse_operator'}
                            >
                              <Plus className="mr-2 h-4 w-4" />
                              –ú–µ–∂—Å–∫–ª–∞–¥—Å–∫–æ–π
                            </Button>
                            <Button onClick={() => fetchTransportsList()}>
                              –û–±–Ω–æ–≤–∏—Ç—å
                            </Button>
                          </div>
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        {user?.role === 'admin' && transports.filter(t => t.status === 'empty' || t.status === 'filled').length > 0 && (
                          <div className="flex items-center space-x-2 mb-4 p-3 bg-gray-50 rounded-lg">
                            <input
                              type="checkbox"
                              checked={selectAllTransports}
                              onChange={(e) => handleSelectAllTransports(e.target.checked, transports.filter(t => t.status === 'empty' || t.status === 'filled'))}
                              className="rounded border-gray-300"
                            />
                            <label className="text-sm font-medium text-gray-700">
                              –í—ã–±—Ä–∞—Ç—å –≤—Å–µ ({transports.filter(t => t.status === 'empty' || t.status === 'filled').length})
                            </label>
                          </div>
                        )}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                          {transports.filter(transport => transport.status === 'empty' || transport.status === 'filled').length === 0 ? (
                            <div className="col-span-full text-center py-8">
                              <Truck className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–≤</p>
                            </div>
                          ) : (
                            transports.filter(transport => transport.status === 'empty' || transport.status === 'filled').map((transport) => (
                              <Card key={transport.id} className="p-4">
                                <div className="space-y-3">
                                  <div className="flex justify-between items-start">
                                    <div className="flex items-start space-x-2">
                                      {user?.role === 'admin' && (
                                        <input
                                          type="checkbox"
                                          checked={selectedTransports.includes(transport.id)}
                                          onChange={(e) => handleTransportSelect(transport.id, e.target.checked)}
                                          className="mt-1 rounded border-gray-300"
                                        />
                                      )}
                                      <h3 className="font-semibold text-lg">{transport.transport_number}</h3>
                                    </div>
                                    <Badge variant={transport.status === 'empty' ? 'secondary' : 'default'}>
                                      {transport.status === 'empty' ? '–ü—É—Å—Ç–æ–π' : '–ó–∞–ø–æ–ª–Ω–µ–Ω–æ'}
                                    </Badge>
                                  </div>
                                  
                                  <div className="space-y-2 text-sm">
                                    <p><strong>–§–ò–û –≤–æ–¥–∏—Ç–µ–ª—è:</strong> {transport.driver_name}</p>
                                    <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è:</strong> {transport.driver_phone}</p>
                                    <p><strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> {transport.direction}</p>
                                    <p><strong>–û–±—ä—ë–º:</strong> {transport.current_load_kg} / {transport.capacity_kg} –∫–≥</p>
                                  </div>
                                  
                                  <div className="flex space-x-2">
                                    <Button 
                                      onClick={() => {
                                        setSelectedTransport(transport);
                                        fetchTransportCargoList(transport.id);
                                        fetchAvailableCargoForTransport();
                                        setTransportManagementModal(true);
                                      }}
                                      className="flex-1"
                                      variant="outline"
                                    >
                                      <Truck className="mr-1 h-3 w-3" />
                                      –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                                    </Button>
                                    
                                    <Button 
                                      onClick={() => openTransportVisualization(transport)}
                                      variant="outline"
                                      size="sm"
                                      title="–°—Ö–µ–º–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞"
                                    >
                                      <Grid3X3 className="h-3 w-3" />
                                    </Button>

                                    {user?.role === 'admin' && (
                                      <Button 
                                        onClick={() => handleDeleteTransport(transport.id)}
                                        variant="outline"
                                        size="sm"
                                        className="text-red-600 border-red-300 hover:bg-red-50"
                                        title="–£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç"
                                      >
                                        <Trash2 className="h-3 w-3" />
                                      </Button>
                                    )}
                                  </div>
                                </div>
                              </Card>
                            ))
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* –í –ø—É—Ç–∏ */}
                  {activeTab === 'logistics-in-transit' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Clock className="mr-2 h-5 w-5" />
                          –¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç –≤ –ø—É—Ç–∏ ({transports.filter(t => t.status === 'in_transit').length})
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {transports.filter(transport => transport.status === 'in_transit').length === 0 ? (
                            <div className="text-center py-8">
                              <Clock className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">–ù–µ—Ç —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ –≤ –ø—É—Ç–∏</p>
                            </div>
                          ) : (
                            transports.filter(transport => transport.status === 'in_transit').map((transport) => (
                              <Card key={transport.id} className="p-4">
                                <div className="flex justify-between items-start">
                                  <div className="space-y-2 flex-1">
                                    <h3 className="font-semibold text-lg">{transport.transport_number}</h3>
                                    <p className="text-sm text-gray-600"><strong>–í–æ–¥–∏—Ç–µ–ª—å:</strong> {transport.driver_name}</p>
                                    <p className="text-sm text-gray-600"><strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> {transport.direction}</p>
                                    <p className="text-sm text-gray-600"><strong>–ì—Ä—É–∑:</strong> {transport.current_load_kg} –∫–≥ ({transport.cargo_list.length} –º–µ—Å—Ç)</p>
                                    <p className="text-sm text-gray-600"><strong>–û—Ç–ø—Ä–∞–≤–ª–µ–Ω:</strong> {new Date(transport.dispatched_at).toLocaleDateString('ru-RU')} {new Date(transport.dispatched_at).toLocaleTimeString('ru-RU')}</p>
                                  </div>
                                  <div className="flex flex-col items-end space-y-2">
                                    <Badge className="bg-yellow-100 text-yellow-800">–í –ø—É—Ç–∏</Badge>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => handleMarkTransportArrived(transport.id)}
                                      className="text-green-600 hover:text-green-700"
                                    >
                                      <MapPin className="mr-1 h-3 w-3" />
                                      –ü—Ä–∏–±—ã–ª
                                    </Button>
                                  </div>
                                </div>
                              </Card>
                            ))
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* –ù–∞ –º–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è */}
                  {activeTab === 'logistics-arrived' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <MapPin className="mr-2 h-5 w-5" />
                          –ü—Ä–∏–±—ã–≤—à–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ã –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è ({arrivedTransports.length})
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {arrivedTransports.length === 0 ? (
                            <div className="text-center py-8">
                              <MapPin className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">–ù–µ—Ç –ø—Ä–∏–±—ã–≤—à–∏—Ö —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</p>
                            </div>
                          ) : (
                            arrivedTransports.map((transport) => (
                              <Card key={transport.id} className="p-4 border-green-200">
                                <div className="flex justify-between items-start">
                                  <div className="space-y-2 flex-1">
                                    <h3 className="font-semibold text-lg text-green-800">{transport.transport_number}</h3>
                                    <p className="text-sm text-gray-600"><strong>–í–æ–¥–∏—Ç–µ–ª—å:</strong> {transport.driver_name}</p>
                                    <p className="text-sm text-gray-600"><strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> {transport.direction}</p>
                                    <p className="text-sm text-gray-600"><strong>–ì—Ä—É–∑:</strong> {transport.current_load_kg} –∫–≥ ({transport.cargo_count} –º–µ—Å—Ç)</p>
                                    <p className="text-sm text-gray-600"><strong>–ü—Ä–∏–±—ã–ª:</strong> {new Date(transport.arrived_at).toLocaleDateString('ru-RU')} {new Date(transport.arrived_at).toLocaleTimeString('ru-RU')}</p>
                                  </div>
                                  <div className="flex flex-col items-end space-y-2">
                                    <Badge className="bg-green-100 text-green-800">–ü—Ä–∏–±—ã–ª</Badge>
                                    <Button
                                      size="sm"
                                      onClick={() => {
                                        setSelectedArrivedTransport(transport);
                                        fetchArrivedTransportCargo(transport.id);
                                        setArrivedTransportModal(true);
                                      }}
                                      className="bg-blue-600 hover:bg-blue-700 text-white"
                                    >
                                      <Package className="mr-1 h-3 w-3" />
                                      –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –≥—Ä—É–∑—ã
                                    </Button>
                                  </div>
                                </div>
                              </Card>
                            ))
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */}
                  {activeTab === 'logistics-history' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <FileText className="mr-2 h-5 w-5" />
                          –ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {transports.filter(transport => transport.status === 'completed').map((transport) => (
                            <Card key={transport.id} className="p-4 bg-gray-50">
                              <div className="space-y-2">
                                <div className="flex justify-between items-start">
                                  <h3 className="font-semibold text-lg">{transport.transport_number}</h3>
                                  <Badge variant="outline">–ó–∞–≤–µ—Ä—à–µ–Ω–æ</Badge>
                                </div>
                                <p className="text-sm text-gray-600"><strong>–í–æ–¥–∏—Ç–µ–ª—å:</strong> {transport.driver_name}</p>
                                <p className="text-sm text-gray-600"><strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> {transport.direction}</p>
                                <p className="text-sm text-gray-600"><strong>–ì—Ä—É–∑:</strong> {transport.current_load_kg} –∫–≥ ({transport.cargo_list.length} –º–µ—Å—Ç)</p>
                                <p className="text-sm text-gray-600"><strong>–ó–∞–≤–µ—Ä—à–µ–Ω:</strong> {transport.completed_at && new Date(transport.completed_at).toLocaleDateString('ru-RU')} {transport.completed_at && new Date(transport.completed_at).toLocaleTimeString('ru-RU')}</p>
                              </div>
                            </Card>
                          ))}
                        </div>
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}

              {/* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */}
              {activeSection === 'notifications-management' && (
                <div className="space-y-6">
                  {/* –ù–û–í–´–ï –ó–ê–ö–ê–ó–´ –û–¢ –ö–õ–ò–ï–ù–¢–û–í */}
                  {(activeTab === 'notifications-client-orders' || !activeTab || activeTab === 'notifications-management') && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <ShoppingCart className="mr-2 h-5 w-5 text-orange-600" />
                            –ù–æ–≤—ã–µ –∑–∞–∫–∞–∑—ã –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ ({newOrdersCount})
                          </div>
                          <div className="space-x-2">
                            <Button onClick={fetchNewOrdersCount} variant="outline" size="sm">
                              <RefreshCw className="w-4 h-4 mr-1" />
                              –û–±–Ω–æ–≤–∏—Ç—å
                            </Button>
                          </div>
                        </CardTitle>
                        <CardDescription>
                          –ó–∞–∫–∞–∑—ã –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ —á–µ—Ä–µ–∑ —Ñ–æ—Ä–º—É –æ–Ω–ª–∞–π–Ω-–∑–∞–∫–∞–∑–∞ —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {pendingOrders.length === 0 ? (
                            <div className="text-center py-8">
                              <ShoppingCart className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">–ù–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤ –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤ –Ω–µ—Ç</p>
                            </div>
                          ) : (
                            pendingOrders.map((order) => (
                              <div key={order.id} className="border rounded-lg p-6 bg-orange-50 hover:bg-orange-100 transition-colors">
                                <div className="flex justify-between items-start mb-4">
                                  <div>
                                    <h3 className="text-lg font-semibold text-orange-800">
                                      –ó–∞–∫–∞–∑ ‚Ññ{order.request_number}
                                    </h3>
                                    <p className="text-sm text-gray-600">
                                      –°–æ–∑–¥–∞–Ω: {new Date(order.created_at).toLocaleDateString('ru-RU')} {new Date(order.created_at).toLocaleTimeString('ru-RU')}
                                    </p>
                                  </div>
                                  <div className="flex flex-col items-end space-y-2">
                                    <Badge variant="destructive" className="bg-orange-100 text-orange-800 border-orange-200">
                                      –ù–æ–≤—ã–π –∑–∞–∫–∞–∑
                                    </Badge>
                                    {order.admin_notes && (
                                      <Badge variant="outline" className="text-blue-600 border-blue-200">
                                        –ï—Å—Ç—å –∑–∞–º–µ—Ç–∫–∏
                                      </Badge>
                                    )}
                                  </div>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                  <div className="space-y-3">
                                    <h4 className="font-medium text-gray-900 flex items-center">
                                      <User className="w-4 h-4 mr-1" />
                                      –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å
                                    </h4>
                                    <div className="text-sm text-gray-600 space-y-1 pl-5">
                                      <p><strong>–§–ò–û:</strong> {order.sender_full_name}</p>
                                      <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {order.sender_phone}</p>
                                      <p><strong>–ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞:</strong> {order.pickup_address}</p>
                                    </div>
                                  </div>
                                  
                                  <div className="space-y-3">
                                    <h4 className="font-medium text-gray-900 flex items-center">
                                      <MapPin className="w-4 h-4 mr-1" />
                                      –ü–æ–ª—É—á–∞—Ç–µ–ª—å
                                    </h4>
                                    <div className="text-sm text-gray-600 space-y-1 pl-5">
                                      <p><strong>–§–ò–û:</strong> {order.recipient_full_name}</p>
                                      <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {order.recipient_phone}</p>
                                      <p><strong>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</strong> {order.recipient_address}</p>
                                    </div>
                                  </div>
                                </div>

                                <div className="mb-4 p-4 bg-white/50 rounded-lg">
                                  <h4 className="font-medium text-gray-900 mb-2 flex items-center">
                                    <Package className="w-4 h-4 mr-1" />
                                    –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ
                                  </h4>
                                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-sm text-gray-600">
                                    <div>
                                      <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> {order.cargo_name}</p>
                                      <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {order.description}</p>
                                    </div>
                                    <div>
                                      <p><strong>–í–µ—Å:</strong> {order.weight} –∫–≥</p>
                                      <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {order.declared_value} ‚ÇΩ</p>
                                    </div>
                                    <div>
                                      <p><strong>–ú–∞—Ä—à—Ä—É—Ç:</strong> {order.route === 'moscow_to_tajikistan' ? '–ú–æ—Å–∫–≤–∞ ‚Üí –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω' : '–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω ‚Üí –ú–æ—Å–∫–≤–∞'}</p>
                                    </div>
                                  </div>
                                </div>

                                {order.admin_notes && (
                                  <div className="mb-4 p-3 bg-blue-50 border-l-4 border-blue-400 rounded">
                                    <p className="text-sm text-blue-800">
                                      <strong>–ó–∞–º–µ—Ç–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞:</strong> {order.admin_notes}
                                    </p>
                                  </div>
                                )}

                                <div className="flex flex-wrap gap-2 pt-4 border-t border-orange-200">
                                  <Button 
                                    onClick={() => handleOrderDetailsView(order)}
                                    variant="outline" 
                                    size="sm"
                                    className="flex items-center"
                                  >
                                    <Eye className="w-4 h-4 mr-1" />
                                    –ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å
                                  </Button>
                                  <Button 
                                    onClick={() => handleOrderEdit(order)}
                                    variant="outline" 
                                    size="sm"
                                    className="flex items-center text-blue-600 border-blue-200 hover:bg-blue-50"
                                  >
                                    <Edit className="w-4 h-4 mr-1" />
                                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                                  </Button>
                                  <Button 
                                    onClick={() => handleAcceptOrder(order.id)}
                                    size="sm"
                                    className="flex items-center bg-green-600 hover:bg-green-700"
                                  >
                                    <CheckCircle className="w-4 h-4 mr-1" />
                                    –ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑
                                  </Button>
                                  <Button 
                                    onClick={() => handleRejectOrder(order.id, '–ó–∞–∫–∞–∑ –æ—Ç–∫–ª–æ–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º')}
                                    variant="destructive" 
                                    size="sm"
                                    className="flex items-center"
                                  >
                                    <XCircle className="w-4 h-4 mr-1" />
                                    –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                  </Button>
                                </div>
                              </div>
                            ))
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ */}
                  {(activeTab === 'notifications-requests' || !activeTab || activeTab === 'notifications-management') && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Bell className="mr-2 h-5 w-5" />
                            –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ ({cargoRequests.length})
                          </div>
                          <div className="flex space-x-2">
                            {selectedRequests.length > 0 && (
                              <Button
                                onClick={handleBulkDeleteRequests}
                                variant="outline"
                                className="text-red-600 border-red-300 hover:bg-red-50"
                              >
                                <Trash2 className="mr-2 h-4 w-4" />
                                –£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ ({selectedRequests.length})
                              </Button>
                            )}
                            <Button onClick={fetchCargoRequests}>
                              –û–±–Ω–æ–≤–∏—Ç—å
                            </Button>
                          </div>
                        </CardTitle>
                        <CardDescription>
                          –ó–∞—è–≤–∫–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –Ω–∞ –æ—Ç–ø—Ä–∞–≤–∫—É –≥—Ä—É–∑–æ–≤
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        {cargoRequests.length > 0 && (
                          <div className="flex items-center space-x-2 mb-4 p-3 bg-gray-50 rounded-lg">
                            <input
                              type="checkbox"
                              checked={selectAllRequests}
                              onChange={(e) => handleSelectAllRequests(e.target.checked, cargoRequests)}
                              className="rounded border-gray-300"
                            />
                            <label className="text-sm font-medium text-gray-700">
                              –í—ã–±—Ä–∞—Ç—å –≤—Å–µ ({cargoRequests.length})
                            </label>
                          </div>
                        )}
                        <div className="space-y-4">
                          {cargoRequests.length === 0 ? (
                            <div className="text-center py-8">
                              <Bell className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">–ù–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫ –Ω–µ—Ç</p>
                            </div>
                          ) : (
                            cargoRequests.map((request) => (
                              <div key={request.id} className="border rounded-lg p-6 bg-blue-50">
                                <div className="flex justify-between items-start mb-4">
                                  <div className="flex items-start space-x-3">
                                    <input
                                      type="checkbox"
                                      checked={selectedRequests.includes(request.id)}
                                      onChange={(e) => handleRequestSelect(request.id, e.target.checked)}
                                      className="mt-1 rounded border-gray-300"
                                    />
                                    <div>
                                      <h3 className="text-lg font-semibold text-blue-800">{request.request_number}</h3>
                                      <p className="text-sm text-gray-600">–ü–æ–¥–∞–Ω–∞: {new Date(request.created_at).toLocaleDateString('ru-RU')} {new Date(request.created_at).toLocaleTimeString('ru-RU')}</p>
                                    </div>
                                  </div>
                                  <div className="flex items-center space-x-2">
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => handleDeleteRequest(request.id)}
                                      className="text-red-600 border-red-300 hover:bg-red-50"
                                      title="–£–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É"
                                    >
                                      <Trash2 className="h-4 w-4" />
                                    </Button>
                                    <Badge variant="secondary">–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</Badge>
                                  </div>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                  <div className="space-y-2">
                                    <h4 className="font-medium text-gray-900">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</h4>
                                    <div className="text-sm text-gray-600">
                                      <p><strong>–§–ò–û:</strong> {request.sender_full_name}</p>
                                      <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {request.sender_phone}</p>
                                      <p><strong>–ê–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–∫–∏:</strong> {request.pickup_address}</p>
                                    </div>
                                  </div>
                                  
                                  <div className="space-y-2">
                                    <h4 className="font-medium text-gray-900">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</h4>
                                    <div className="text-sm text-gray-600">
                                      <p><strong>–§–ò–û:</strong> {request.recipient_full_name}</p>
                                      <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {request.recipient_phone}</p>
                                      <p><strong>–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–µ–Ω–∏—è:</strong> {request.recipient_address}</p>
                                    </div>
                                  </div>
                                </div>

                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                                  <div>
                                    <h4 className="font-medium text-gray-900">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ</h4>
                                    <div className="text-sm text-gray-600">
                                      <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> {request.cargo_name}</p>
                                      <p><strong>–í–µ—Å:</strong> {request.weight} –∫–≥</p>
                                      <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {request.declared_value} ‚ÇΩ</p>
                                    </div>
                                  </div>
                                  
                                  <div>
                                    <h4 className="font-medium text-gray-900">–ú–∞—Ä—à—Ä—É—Ç</h4>
                                    <div className="text-sm text-gray-600">
                                      <p>{request.route === 'moscow_to_tajikistan' ? '–ú–æ—Å–∫–≤–∞ ‚Üí –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω' : '–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω ‚Üí –ú–æ—Å–∫–≤–∞'}</p>
                                    </div>
                                  </div>
                                  
                                  <div>
                                    <h4 className="font-medium text-gray-900">–û–ø–∏—Å–∞–Ω–∏–µ</h4>
                                    <div className="text-sm text-gray-600">
                                      <p>{request.description}</p>
                                    </div>
                                  </div>
                                </div>

                                <div className="flex space-x-3 pt-4 border-t">
                                  <Button
                                    onClick={() => handleAcceptRequest(request.id)}
                                    className="flex-1 bg-green-600 hover:bg-green-700"
                                  >
                                    <CheckCircle className="mr-2 h-4 w-4" />
                                    –ü—Ä–∏–Ω—è—Ç—å –∑–∞—è–≤–∫—É
                                  </Button>
                                  <Button
                                    variant="outline"
                                    onClick={() => {
                                      const reason = prompt('–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):');
                                      handleRejectRequest(request.id, reason || '');
                                    }}
                                    className="flex-1 text-red-600 border-red-300 hover:bg-red-50"
                                  >
                                    <X className="mr-2 h-4 w-4" />
                                    –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                                  </Button>
                                </div>
                              </div>
                            ))
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* –°–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */}
                  {activeTab === 'notifications-system' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Bell className="mr-2 h-5 w-5" />
                            –°–∏—Å—Ç–µ–º–Ω—ã–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ({notifications.length})
                          </div>
                          <Button onClick={fetchNotifications}>
                            –û–±–Ω–æ–≤–∏—Ç—å
                          </Button>
                        </CardTitle>
                        <CardDescription>
                          –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö —Å—Ç–∞—Ç—É—Å–æ–≤ –≥—Ä—É–∑–æ–≤ –∏ –æ–ø–µ—Ä–∞—Ü–∏—è—Ö
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {notifications.length === 0 ? (
                            <div className="text-center py-8">
                              <Bell className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">–°–∏—Å—Ç–µ–º–Ω—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –Ω–µ—Ç</p>
                            </div>
                          ) : (
                            notifications.map((notification) => (
                              <div
                                key={notification.id}
                                className={`border rounded-lg p-4 ${
                                  !notification.is_read ? 'bg-blue-50 border-blue-200' : 'bg-gray-50'
                                }`}
                              >
                                <div className="flex justify-between items-start">
                                  <div className="flex-1">
                                    <h4 className="font-semibold text-gray-900">{notification.title}</h4>
                                    <p className="text-sm text-gray-600 mt-1">{notification.message}</p>
                                    <div className="flex items-center mt-2 text-xs text-gray-500">
                                      <span>–¢–∏–ø: {
                                        notification.notification_type === 'request' ? '–ó–∞—è–≤–∫–∞' :
                                        notification.notification_type === 'cargo_status' ? '–°—Ç–∞—Ç—É—Å –≥—Ä—É–∑–∞' :
                                        notification.notification_type === 'payment' ? '–û–ø–ª–∞—Ç–∞' : '–°–∏—Å—Ç–µ–º–∞'
                                      }</span>
                                      <span className="ml-4">
                                        {new Date(notification.created_at).toLocaleDateString('ru-RU')} {new Date(notification.created_at).toLocaleTimeString('ru-RU')}
                                      </span>
                                    </div>
                                  </div>
                                  {!notification.is_read && (
                                    <Badge variant="secondary" className="ml-2">–ù–æ–≤–æ–µ</Badge>
                                  )}
                                </div>
                              </div>
                            ))
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}

              {/* –ù–û–í–´–ï –°–ï–ö–¶–ò–ò –î–õ–Ø –ö–£–†–¨–ï–†–ê (–≠–¢–ê–ü 3) */}
              
              {/* –£–ü–†–û–©–ï–ù–ù–ê–Ø –ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∫—É—Ä—å–µ—Ä–∞ - –¢–û–õ–¨–ö–û –ö–ù–û–ü–ö–ò */}
              {activeSection === 'courier-dashboard' && user?.role === 'courier' && (
                <div className="space-y-6 p-4 md:p-6 relative">
                  <DevBadge id={getDevNumber('pages', 'courier-dashboard').id} type="page" label={getDevNumber('pages', 'courier-dashboard').label} />
                  {/* GPS –¢—Ä–µ–∫–µ—Ä - –¥–æ–±–∞–≤–ª—è–µ–º –≤ –Ω–∞—á–∞–ª–æ –¥–∞—à–±–æ—Ä–¥–∞ */}
                  <CourierGPSTracker
                    courierTracking={courierTracking}
                    onStartTracking={startCourierTracking}
                    onStopTracking={stopCourierTracking}
                    onStatusChange={changeCourierStatus}
                  />
                  
                  <div className="flex flex-col md:flex-row md:justify-end md:items-center space-y-4 md:space-y-0">
                    <Button 
                      onClick={() => {
                        fetchCourierNewRequests();
                        fetchAcceptedRequests();
                        fetchPickedRequests();
                        fetchCancelledRequests();
                      }}
                      variant="outline"
                    >
                      <RefreshCw className="h-4 w-4 mr-2" />
                      –û–±–Ω–æ–≤–∏—Ç—å –¥–∞–Ω–Ω—ã–µ
                    </Button>
                  </div>

                  {/* –£–õ–£–ß–®–ï–ù–ù–´–ô –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å –∫–Ω–æ–ø–∫–∞–º–∏ */}
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <Card className="hover:shadow-lg transition-shadow cursor-pointer" onClick={() => {
                      setActiveSection('courier-requests');
                      setActiveTab('courier-requests');
                    }}>
                      <CardContent className="p-4 text-center">
                        <div className="flex flex-col items-center space-y-2">
                          <div className="relative">
                            <Package className="h-8 w-8 text-blue-600" />
                            {courierRequests.length > 0 && (
                              <Badge className="absolute -top-2 -right-2 bg-red-500 text-white text-xs min-w-[20px] h-5 flex items-center justify-center rounded-full">
                                {courierRequests.length}
                              </Badge>
                            )}
                          </div>
                          <div>
                            <p className="text-sm font-medium text-gray-900">–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏</p>
                            <p className="text-xs text-gray-500">{courierRequests.length} –∑–∞—è–≤–æ–∫</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>

                    <Card className="hover:shadow-lg transition-shadow cursor-pointer" onClick={() => {
                      setActiveSection('courier-accepted');
                      setActiveTab('courier-accepted');
                    }}>
                      <CardContent className="p-4 text-center">
                        <div className="flex flex-col items-center space-y-2">
                          <div className="relative">
                            <CheckCircle className="h-8 w-8 text-green-600" />
                            {acceptedRequests.length > 0 && (
                              <Badge className="absolute -top-2 -right-2 bg-green-500 text-white text-xs min-w-[20px] h-5 flex items-center justify-center rounded-full">
                                {acceptedRequests.length}
                              </Badge>
                            )}
                          </div>
                          <div>
                            <p className="text-sm font-medium text-gray-900">–ü—Ä–∏–Ω—è—Ç—ã–µ –∑–∞—è–≤–∫–∏</p>
                            <p className="text-xs text-gray-500">{acceptedRequests.length} –∑–∞—è–≤–æ–∫</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>

                    <Card className="hover:shadow-lg transition-shadow cursor-pointer" onClick={() => {
                      setActiveSection('courier-picked');
                      setActiveTab('courier-picked');
                    }}>
                      <CardContent className="p-4 text-center">
                        <div className="flex flex-col items-center space-y-2">
                          <div className="relative">
                            <Truck className="h-8 w-8 text-orange-600" />
                            {pickedRequests.length > 0 && (
                              <Badge className="absolute -top-2 -right-2 bg-orange-500 text-white text-xs min-w-[20px] h-5 flex items-center justify-center rounded-full">
                                {pickedRequests.length}
                              </Badge>
                            )}
                          </div>
                          <div>
                            <p className="text-sm font-medium text-gray-900">–ö —Å–¥–∞—á–µ</p>
                            <p className="text-xs text-gray-500">{pickedRequests.length} –≥—Ä—É–∑–æ–≤</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>

                    <Card className="hover:shadow-lg transition-shadow cursor-pointer" onClick={() => {
                      showAlert('–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: –£ –≤–∞—Å –Ω–µ—Ç –Ω–æ–≤—ã—Ö —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π', 'info');
                    }}>
                      <CardContent className="p-4 text-center">
                        <div className="flex flex-col items-center space-y-2">
                          <div className="relative">
                            <Bell className="h-8 w-8 text-purple-600" />
                            <Badge className="absolute -top-2 -right-2 bg-gray-400 text-white text-xs min-w-[20px] h-5 flex items-center justify-center rounded-full">
                              0
                            </Badge>
                          </div>
                          <div>
                            <p className="text-sm font-medium text-gray-900">–£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è</p>
                            <p className="text-xs text-gray-500">–ù–µ—Ç –Ω–æ–≤—ã—Ö</p>
                          </div>
                        </div>
                      </CardContent>
                    </Card>
                  </div>
                </div>
              )}

              {/* –ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏ –∫—É—Ä—å–µ—Ä–∞ */}
              {activeSection === 'courier-requests' && user?.role === 'courier' && (
                <div className="space-y-6">
                  {/* –£–±—Ä–∞–ª–∏ –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è */}
                  
                  {/* –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ë–õ–û–ö: –ê–¥—Ä–µ—Å–∞ –∑–∞—è–≤–æ–∫ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è */}
                  {courierRequests.length > 0 && (
                    <Card className="border-blue-200 bg-blue-50">
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center text-blue-800">
                            <MapPin className="mr-2 h-5 w-5" />
                            –ê–¥—Ä–µ—Å–∞ –∑–∞—è–≤–æ–∫ ({courierRequests.length})
                          </div>
                          {courierRequests.length > 2 && (
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => setShowAllNewRequests(!showAllNewRequests)}
                              className="text-blue-700 border-blue-300 hover:bg-blue-100"
                            >
                              {showAllNewRequests ? '–°–∫—Ä—ã—Ç—å' : `–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∞–¥—Ä–µ—Å–∞ (${courierRequests.length})`}
                            </Button>
                          )}
                        </CardTitle>
                        <CardDescription className="text-blue-600">
                          –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∞–¥—Ä–µ—Å, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –≤ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∞—Ö.
                          {!showAllNewRequests && courierRequests.length > 2 && 
                            ` –ü–æ–∫–∞–∑–∞–Ω–æ ${Math.min(2, courierRequests.length)} –∏–∑ ${courierRequests.length} –∞–¥—Ä–µ—Å–æ–≤.`
                          }
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                          {(showAllNewRequests ? courierRequests : courierRequests.slice(0, 2)).map((request, index) => (
                            <div 
                              key={request.id}
                              className="bg-white p-3 rounded-lg border border-blue-200 hover:shadow-md transition-shadow cursor-pointer"
                              onClick={() => {
                                const address = encodeURIComponent(request.pickup_address);
                                const yandexMapsUrl = `https://yandex.ru/maps/?text=${address}&mode=search`;
                                window.open(yandexMapsUrl, '_blank');
                              }}
                            >
                              <div className="flex items-start space-x-3">
                                <div className="flex-shrink-0">
                                  <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                                    <span className="text-sm font-semibold text-blue-600">{index + 1}</span>
                                  </div>
                                </div>
                                <div className="flex-1 min-w-0">
                                  <p className="text-sm font-medium text-gray-900 truncate">
                                    {request.sender_full_name}
                                  </p>
                                  <p className="text-xs text-blue-600 font-medium">
                                    ‚Ññ{request.request_number || request.id.slice(0, 6)}
                                  </p>
                                  <p className="text-xs text-gray-600 mt-1 leading-tight">
                                    {request.pickup_address}
                                  </p>
                                  <div className="flex items-center mt-2 space-x-2">
                                    <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                      {request.pickup_time_from} - {request.pickup_time_to}
                                    </span>
                                  </div>
                                </div>
                                <div className="flex-shrink-0">
                                  <MapPin className="h-4 w-4 text-blue-500" />
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                        
                        {/* –ö–Ω–æ–ø–∫–∞ "–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –Ω–∞ –∫–∞—Ä—Ç–µ" */}
                        <div className="mt-4 pt-4 border-t border-blue-200 space-y-2">
                          <Button
                            onClick={() => setIsMapOpen(!isMapOpen)}
                            variant={isMapOpen ? "default" : "outline"}
                            className={`w-full ${isMapOpen 
                              ? 'bg-blue-600 hover:bg-blue-700 text-white' 
                              : 'border-blue-300 text-blue-700 hover:bg-blue-100'
                            }`}
                          >
                            <MapPin className="mr-2 h-4 w-4" />
                            {isMapOpen ? '–°–∫—Ä—ã—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç—É' : '–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç—É'}
                          </Button>
                          
                          <Button
                            onClick={() => {
                              const allAddresses = courierRequests.map(req => req.pickup_address).join(' | ');
                              const encodedAddresses = encodeURIComponent(allAddresses);
                              const yandexMapsUrl = `https://yandex.ru/maps/?text=${encodedAddresses}&mode=search`;
                              window.open(yandexMapsUrl, '_blank');
                            }}
                            variant="outline"
                            className="w-full border-blue-300 text-blue-700 hover:bg-blue-100"
                          >
                            <MapPin className="mr-2 h-4 w-4" />
                            –û—Ç–∫—Ä—ã—Ç—å –≤—Å–µ –∞–¥—Ä–µ—Å–∞ –≤ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞—Ö
                          </Button>
                        </div>
                      </CardContent>
                    </Card>
                  )}
                  
                  {/* –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –Ø–Ω–¥–µ–∫—Å */}
                  <YandexMap 
                    addresses={courierRequests}
                    isOpen={isMapOpen}
                    onToggle={() => setIsMapOpen(!isMapOpen)}
                  />

                  {courierRequests.length > 0 ? (
                    <div className="space-y-4">
                      {/* –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ */}
                      {courierRequests.length > 6 && (
                        <div className="text-center">
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => setShowAllNewRequests(!showAllNewRequests)}
                            className="text-blue-700 border-blue-300 hover:bg-blue-100"
                          >
                            {showAllNewRequests ? '–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ 6 –∑–∞—è–≤–æ–∫' : `–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞—è–≤–∫–∏ (${courierRequests.length})`}
                          </Button>
                          {!showAllNewRequests && (
                            <p className="text-sm text-gray-600 mt-2">
                              –ü–æ–∫–∞–∑–∞–Ω–æ 6 –∏–∑ {courierRequests.length} –∑–∞—è–≤–æ–∫
                            </p>
                          )}
                        </div>
                      )}
                      
                      <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                        {(showAllNewRequests ? courierRequests : courierRequests.slice(0, 6)).map((request) => (
                        <Card key={request.id} className="relative">
                          <CardHeader>
                            <div className="flex items-start justify-between">
                              <div>
                                <CardTitle className="text-lg">{request.sender_full_name}</CardTitle>
                                <CardDescription>{request.sender_phone}</CardDescription>
                              </div>
                              <div className="flex flex-col items-end space-y-1">
                                {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä —Ç–∏–ø–∞ –∑–∞—è–≤–∫–∏ */}
                                <Badge variant="outline" className={
                                  request.request_type === 'pickup' ? 'bg-orange-50 text-orange-700 border-orange-200' : 'bg-blue-50 text-blue-700 border-blue-200'
                                }>
                                  {request.request_type === 'pickup' ? 'üì¶ –ó–∞–±–æ—Ä –≥—Ä—É–∑–∞' : 'üöö –î–æ—Å—Ç–∞–≤–∫–∞'}
                                </Badge>
                                
                                {/* –°—Ç–∞—Ç—É—Å –∑–∞—è–≤–∫–∏ */}
                                <Badge variant={
                                  request.request_status === 'pending' ? 'default' :
                                  request.request_status === 'assigned' ? 'secondary' :
                                  request.request_status === 'accepted' ? 'outline' : 'destructive'
                                }>
                                  {request.request_status === 'pending' ? '–ù–æ–≤–∞—è' :
                                   request.request_status === 'assigned' ? '–ù–∞–∑–Ω–∞—á–µ–Ω–∞' :
                                   request.request_status === 'accepted' ? '–ü—Ä–∏–Ω—è—Ç–∞' : '–û—Ç–∫–ª–æ–Ω–µ–Ω–∞'}
                                </Badge>
                              </div>
                            </div>
                          </CardHeader>
                          
                          <CardContent className="space-y-3">
                            {/* –ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏ */}
                            <div>
                              <Label className="text-sm font-medium text-gray-500">‚Ññ –ó–∞—è–≤–∫–∏</Label>
                              <p className="text-sm font-bold text-blue-600">#{request.request_number || request.id}</p>
                            </div>
                            
                            <div>
                              <Label className="text-sm font-medium text-gray-500">
                                {request.request_type === 'pickup' ? '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞' : '–ì—Ä—É–∑'}
                              </Label>
                              <p className="text-sm">
                                {request.request_type === 'pickup' 
                                  ? (request.destination || request.route || '–ù–µ —É–∫–∞–∑–∞–Ω–æ')
                                  : (request.cargo_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ')
                                }
                              </p>
                            </div>
                            
                            <div>
                              <Label className="text-sm font-medium text-gray-500">–ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞</Label>
                              <p className="text-sm text-gray-700">{request.pickup_address}</p>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-3">
                              <div>
                                <Label className="text-sm font-medium text-gray-500">–î–∞—Ç–∞</Label>
                                <p className="text-sm">
                                  {request.pickup_date 
                                    ? new Date(request.pickup_date).toLocaleDateString('ru-RU')
                                    : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'
                                  }
                                </p>
                              </div>
                              <div>
                                <Label className="text-sm font-medium text-gray-500">–í—Ä–µ–º—è</Label>
                                <p className="text-sm">
                                  {request.pickup_time_from && request.pickup_time_to 
                                    ? `${request.pickup_time_from} - ${request.pickup_time_to}`
                                    : (request.pickup_time || '–ù–µ —É–∫–∞–∑–∞–Ω–æ')
                                  }
                                </p>
                              </div>
                            </div>
                            
                            {/* –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã */}
                            <div>
                              <Label className="text-sm font-medium text-gray-500">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã</Label>
                              <Badge variant={request.payment_status === 'paid' ? 'default' : 'secondary'} className="ml-2">
                                {request.payment_status === 'paid' ? '–û–ø–ª–∞—á–µ–Ω–æ' : 
                                 request.payment_status === 'not_paid' ? '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ' : 
                                 request.payment_method === 'cash_on_delivery' ? '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' : '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ'}
                              </Badge>
                            </div>

                            {request.courier_fee && (
                              <div>
                                <Label className="text-sm font-medium text-gray-500">–û–ø–ª–∞—Ç–∞</Label>
                                <p className="text-sm font-medium text-green-600">{request.courier_fee} ‚ÇΩ</p>
                              </div>
                            )}
                          </CardContent>

                          <div className="px-6 pb-6">
                            <div className="flex flex-col space-y-2">
                              {(request.request_status === 'assigned' || request.request_status === 'pending') && (
                                <>
                                  <Button 
                                    onClick={() => handleAcceptCourierRequest(request.id)}
                                    className="w-full bg-green-600 hover:bg-green-700"
                                  >
                                    <CheckCircle className="mr-2 h-4 w-4" />
                                    –ü—Ä–∏–Ω—è—Ç—å –∑–∞—è–≤–∫—É
                                  </Button>
                                  
                                  <Button 
                                    onClick={() => handleContactSender(request)}
                                    variant="outline"
                                    className="w-full bg-blue-50 hover:bg-blue-100 text-blue-700 border-blue-200"
                                  >
                                    <Phone className="mr-2 h-4 w-4" />
                                    –°–≤—è–∑–∞—Ç—å—Å—è —Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º
                                  </Button>
                                  
                                  <Button 
                                    variant="destructive" 
                                    size="sm"
                                    onClick={() => handleCancelCourierRequest(request.id)}
                                  >
                                    <XCircle className="mr-2 h-4 w-4" />
                                    –û—Ç–º–µ–Ω–∏—Ç—å –∑–∞—è–≤–∫—É
                                  </Button>
                                </>
                              )}

                              {request.request_status === 'accepted' && (
                                <div className="text-center text-sm text-green-600 py-2 font-medium">
                                  ‚úÖ –ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞
                                </div>
                              )}

                              {request.request_status === 'cancelled' && (
                                <div className="text-center text-sm text-red-600 py-2 font-medium">
                                  ‚ùå –ó–∞—è–≤–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞
                                </div>
                              )}
                            </div>
                          </div>
                        </Card>
                        ))}
                      </div>
                    </div>
                  ) : (
                    <Card>
                      <CardContent>
                        <h3 className="text-lg font-medium text-gray-900 mb-2">–ù–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫ –Ω–µ—Ç</h3>
                        <p className="text-gray-500 text-center">
                          –ü–æ–∫–∞ –Ω–µ—Ç –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞. –û–Ω–∏ –ø–æ—è–≤—è—Ç—Å—è –∑–¥–µ—Å—å, –∫–æ–≥–¥–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä—ã —Å–æ–∑–¥–∞–¥—É—Ç –∑–∞—è–≤–∫–∏.
                        </p>
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}

              {/* –ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø: –ü—Ä–∏–Ω—è—Ç—ã–µ –≥—Ä—É–∑—ã –∫—É—Ä—å–µ—Ä–∞ */}
              {activeSection === 'courier-accepted' && user?.role === 'courier' && (
                <div className="space-y-6 p-4 md:p-6">
                  <div className="flex items-center justify-between">
                    <h2 className="text-2xl font-bold">–ü—Ä–∏–Ω—è—Ç—ã–µ –∑–∞—è–≤–∫–∏</h2>
                    <Badge variant="secondary" className="bg-green-100 text-green-800">
                      {acceptedRequests.length} –∑–∞—è–≤–æ–∫
                    </Badge>
                  </div>

                  {/* –ö–∞—Ä—Ç–∞ –∞–¥—Ä–µ—Å–æ–≤ –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞—è–≤–æ–∫ —Å –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ–º */}
                  {acceptedRequests.length > 0 && (
                    <Card className="mb-6">
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="text-lg text-green-700">
                            üìç –ê–¥—Ä–µ—Å–∞ –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞—è–≤–æ–∫ ({acceptedRequests.length})
                          </div>
                          {acceptedRequests.length > 2 && (
                            <Button
                              variant="outline"
                              size="sm"
                              onClick={() => setShowAllAcceptedRequests(!showAllAcceptedRequests)}
                              className="text-green-700 border-green-300 hover:bg-green-100"
                            >
                              {showAllAcceptedRequests ? '–°–∫—Ä—ã—Ç—å' : `–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∞–¥—Ä–µ—Å–∞ (${acceptedRequests.length})`}
                            </Button>
                          )}
                        </CardTitle>
                        <CardDescription className="text-green-600">
                          –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∞–¥—Ä–µ—Å, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –≤ –Ø–Ω–¥–µ–∫—Å –ö–∞—Ä—Ç–∞—Ö.
                          {!showAllAcceptedRequests && acceptedRequests.length > 2 && 
                            ` –ü–æ–∫–∞–∑–∞–Ω–æ ${Math.min(2, acceptedRequests.length)} –∏–∑ ${acceptedRequests.length} –∞–¥—Ä–µ—Å–æ–≤.`
                          }
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                          {(showAllAcceptedRequests ? acceptedRequests : acceptedRequests.slice(0, 2)).map((request, index) => (
                            <div 
                              key={request.id}
                              className="bg-white p-3 rounded-lg border border-green-200 hover:shadow-md transition-shadow cursor-pointer"
                              onClick={() => {
                                const address = encodeURIComponent(request.pickup_address);
                                const yandexMapsUrl = `https://yandex.ru/maps/?text=${address}&mode=search`;
                                window.open(yandexMapsUrl, '_blank');
                              }}
                            >
                              <div className="flex items-start space-x-3">
                                <div className="flex-shrink-0">
                                  <div className="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                    <span className="text-sm font-semibold text-green-600">{index + 1}</span>
                                  </div>
                                </div>
                                <div className="flex-1 min-w-0">
                                  <p className="text-sm font-medium text-gray-900 truncate">
                                    {request.sender_full_name}
                                  </p>
                                  <p className="text-xs text-green-600 font-medium">
                                    ‚Ññ{request.request_number || request.id.slice(0, 6)}
                                  </p>
                                  <p className="text-xs text-gray-600 mt-1 leading-tight">
                                    {request.pickup_address}
                                  </p>
                                  <div className="flex items-center mt-2 space-x-2">
                                    <span className="inline-flex items-center px-2 py-0.5 rounded text-xs font-medium bg-green-100 text-green-800">
                                      –ü—Ä–∏–Ω—è—Ç–æ
                                    </span>
                                  </div>
                                </div>
                                <div className="flex-shrink-0">
                                  <MapPin className="h-4 w-4 text-green-500" />
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>
                        
                        {/* –ö–Ω–æ–ø–∫–∏ –¥–ª—è –∫–∞—Ä—Ç—ã –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞—è–≤–æ–∫ */}
                        <div className="mt-4 pt-4 border-t border-green-200 space-y-2">
                          <Button
                            onClick={() => setIsAcceptedMapOpen(!isAcceptedMapOpen)}
                            variant={isAcceptedMapOpen ? "default" : "outline"}
                            className={`w-full ${isAcceptedMapOpen 
                              ? 'bg-green-600 hover:bg-green-700 text-white' 
                              : 'border-green-300 text-green-700 hover:bg-green-100'
                            }`}
                          >
                            <MapPin className="mr-2 h-4 w-4" />
                            {isAcceptedMapOpen ? '–°–∫—Ä—ã—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç—É' : '–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—É—é –∫–∞—Ä—Ç—É'}
                          </Button>
                          
                          <Button
                            onClick={() => {
                              const allAddresses = acceptedRequests.map(req => req.pickup_address).join(' | ');
                              const encodedAddresses = encodeURIComponent(allAddresses);
                              const yandexMapsUrl = `https://yandex.ru/maps/?text=${encodedAddresses}&mode=search`;
                              window.open(yandexMapsUrl, '_blank');
                            }}
                            variant="outline"
                            className="w-full border-green-300 text-green-700 hover:bg-green-100"
                          >
                            <ExternalLink className="mr-2 h-4 w-4" />
                            –û—Ç–∫—Ä—ã—Ç—å –≤—Å–µ –∞–¥—Ä–µ—Å–∞ –≤ –Ø–Ω–¥–µ–∫—Å.–ö–∞—Ä—Ç–∞—Ö
                          </Button>
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∞—è –∫–∞—Ä—Ç–∞ –¥–ª—è –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞—è–≤–æ–∫ */}
                  {acceptedRequests.length > 0 && (
                    <YandexMap
                      addresses={acceptedRequests}
                      isOpen={isAcceptedMapOpen}
                      onToggle={() => setIsAcceptedMapOpen(!isAcceptedMapOpen)}
                    />
                  )}

                  {acceptedRequests.length > 0 ? (
                    <div className="space-y-4">
                      {/* –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø–æ–∫–∞–∑–∞ –≤—Å–µ—Ö –∫–∞—Ä—Ç–æ—á–µ–∫ –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞—è–≤–æ–∫ */}
                      {acceptedRequests.length > 6 && (
                        <div className="text-center">
                          <Button
                            variant="outline"
                            size="sm"
                            onClick={() => setShowAllAcceptedRequests(!showAllAcceptedRequests)}
                            className="text-green-700 border-green-300 hover:bg-green-100"
                          >
                            {showAllAcceptedRequests ? '–ü–æ–∫–∞–∑–∞—Ç—å —Ç–æ–ª—å–∫–æ 6 –∑–∞—è–≤–æ–∫' : `–ü–æ–∫–∞–∑–∞—Ç—å –≤—Å–µ –∑–∞—è–≤–∫–∏ (${acceptedRequests.length})`}
                          </Button>
                          {!showAllAcceptedRequests && (
                            <p className="text-sm text-gray-600 mt-2">
                              –ü–æ–∫–∞–∑–∞–Ω–æ 6 –∏–∑ {acceptedRequests.length} –∑–∞—è–≤–æ–∫
                            </p>
                          )}
                        </div>
                      )}
                      
                      <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        {(showAllAcceptedRequests ? acceptedRequests : acceptedRequests.slice(0, 6)).map((request) => (
                        <Card key={request.id} className="relative">
                          <CardHeader>
                            <div className="flex items-start justify-between">
                              <div>
                                <CardTitle className="text-lg">{request.sender_full_name}</CardTitle>
                                <CardDescription>{request.sender_phone}</CardDescription>
                              </div>
                              <Badge variant="secondary" className="bg-blue-100 text-blue-800">
                                –ì–æ—Ç–æ–≤ –∫ –∑–∞–±–æ—Ä—É
                              </Badge>
                            </div>
                          </CardHeader>
                          
                          <CardContent className="space-y-3">
                            {/* –ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏ */}
                            <div>
                              <Label className="text-sm font-medium text-gray-500">‚Ññ –ó–∞—è–≤–∫–∏</Label>
                              <p className="text-sm font-bold text-blue-600">#{request.request_number || request.id}</p>
                            </div>
                            
                            <div>
                              <Label className="text-sm font-medium text-gray-500">–ì—Ä—É–∑</Label>
                              <p className="text-sm font-medium">{request.cargo_name}</p>
                            </div>
                            
                            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ */}
                            <div className="bg-gray-50 p-2 rounded">
                              <Label className="text-xs font-medium text-gray-500">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</Label>
                              <p className="text-xs font-medium">{request.sender_full_name}</p>
                              <p className="text-xs text-gray-600">{request.sender_phone}</p>
                            </div>
                            
                            {/* –ü–æ–ª—É—á–∞—Ç–µ–ª—å –µ—Å–ª–∏ –µ—Å—Ç—å */}
                            {(request.recipient_full_name || request.recipient_phone) && (
                              <div className="bg-blue-50 p-2 rounded">
                                <Label className="text-xs font-medium text-blue-600">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</Label>
                                <p className="text-xs font-medium">{request.recipient_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                <p className="text-xs text-blue-600">{request.recipient_phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                              </div>
                            )}
                            
                            <div>
                              <Label className="text-sm font-medium text-gray-500">–ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞</Label>
                              <p className="text-sm text-gray-700">{request.pickup_address}</p>
                            </div>
                            
                            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–∞—Ö –≤ —Ç–∞–±–ª–∏—Ü–µ –µ—Å–ª–∏ –µ—Å—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ */}
                            {request.cargo_items && Array.isArray(request.cargo_items) && request.cargo_items.length > 1 ? (
                              <div>
                                <Label className="text-sm font-medium text-gray-500">–ì—Ä—É–∑—ã ({request.cargo_items.length})</Label>
                                <div className="mt-1 text-xs space-y-1 max-h-20 overflow-y-auto">
                                  {request.cargo_items.map((item, index) => (
                                    <div key={index} className="flex justify-between bg-gray-50 p-1 rounded">
                                      <span>{item.name}</span>
                                      <span>{item.weight}–∫–≥ √ó {item.price_per_kg}‚ÇΩ = {item.total_price}‚ÇΩ</span>
                                    </div>
                                  ))}
                                </div>
                              </div>
                            ) : (
                              /* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –æ–¥–Ω–æ–≥–æ –≥—Ä—É–∑–∞ */
                              request.total_weight && (
                                <div>
                                  <Label className="text-sm font-medium text-gray-500">–í–µ—Å / –°—Ç–æ–∏–º–æ—Å—Ç—å</Label>
                                  <p className="text-sm">{request.total_weight}–∫–≥ {request.total_value && `/ ${request.total_value}‚ÇΩ`}</p>
                                </div>
                              )
                            )}
                            
                            <div className="grid grid-cols-2 gap-3">
                              <div>
                                <Label className="text-sm font-medium text-gray-500">–î–∞—Ç–∞</Label>
                                <p className="text-sm">
                                  {request.pickup_date 
                                    ? new Date(request.pickup_date).toLocaleDateString('ru-RU')
                                    : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'
                                  }
                                </p>
                              </div>
                              <div>
                                <Label className="text-sm font-medium text-gray-500">–í—Ä–µ–º—è</Label>
                                <p className="text-sm">
                                  {request.pickup_time_from && request.pickup_time_to 
                                    ? `${request.pickup_time_from} - ${request.pickup_time_to}`
                                    : (request.pickup_time || '–ù–µ —É–∫–∞–∑–∞–Ω–æ')
                                  }
                                </p>
                              </div>
                            </div>

                            {request.courier_fee && (
                              <div>
                                <Label className="text-sm font-medium text-gray-500">–û–ø–ª–∞—Ç–∞ –∫—É—Ä—å–µ—Ä—É</Label>
                                <p className="text-sm font-medium text-green-600">{request.courier_fee} ‚ÇΩ</p>
                              </div>
                            )}
                            
                            {/* –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã */}
                            <div>
                              <Label className="text-sm font-medium text-gray-500">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã</Label>
                              <Badge variant={request.payment_status === 'paid' ? 'default' : 'secondary'} className="ml-2">
                                {request.payment_status === 'paid' ? '–û–ø–ª–∞—á–µ–Ω–æ' : 
                                 request.payment_status === 'not_paid' ? '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ' : 
                                 request.payment_method === 'cash_on_delivery' ? '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' : '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ'}
                              </Badge>
                            </div>

                            {/* –ò—Å—Ç–æ—Ä–∏—è –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–∫–∏ */}
                            <div className="bg-green-50 p-3 rounded-lg">
                              <Label className="text-sm font-medium text-green-700">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</Label>
                              <div className="mt-1 text-xs text-green-600">
                                ‚úÖ {new Date(request.updated_at).toLocaleString('ru-RU')}: –ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞ –∫—É—Ä—å–µ—Ä–æ–º
                              </div>
                            </div>
                          </CardContent>

                          <div className="px-6 pb-6 space-y-3">
                            <Button 
                              onClick={() => handleViewRequest(request)}
                              variant="outline"
                              className="w-full"
                              size="lg"
                            >
                              <Eye className="mr-2 h-4 w-4" />
                              –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–∫–∏
                            </Button>
                            
                            <Button 
                              onClick={() => handleContactSender(request)}
                              variant="outline"
                              className="w-full bg-blue-50 hover:bg-blue-100 text-blue-700 border-blue-200"
                              size="lg"
                            >
                              <Phone className="mr-2 h-4 w-4" />
                              –°–≤—è–∑–∞—Ç—å—Å—è —Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º
                            </Button>
                            
                            <Button 
                              onClick={() => handlePickupCargo(request.id)}
                              className="w-full bg-blue-600 hover:bg-blue-700"
                              size="lg"
                            >
                              <Truck className="mr-2 h-4 w-4" />
                              –ó–∞–±—Ä–∞—Ç—å –≥—Ä—É–∑
                            </Button>
                          </div>
                        </Card>
                      ))}
                      </div>
                    </div>
                  ) : (
                    <Card>
                      <CardContent className="flex flex-col items-center justify-center py-12">
                        <CheckCircle className="h-12 w-12 text-gray-400 mb-4" />
                        <h3 className="text-lg font-medium text-gray-900 mb-2">–ù–µ—Ç –ø—Ä–∏–Ω—è—Ç—ã—Ö –∑–∞—è–≤–æ–∫</h3>
                        <p className="text-gray-500 text-center">
                          –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–∞—è–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –ø—Ä–∏–Ω—è–ª–∏ –∏ –≥–æ—Ç–æ–≤—ã –∑–∞–±—Ä–∞—Ç—å.
                        </p>
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}

              {/* –ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø: –ó–∞–±—Ä–∞–Ω–Ω—ã–µ –≥—Ä—É–∑—ã –∫—É—Ä—å–µ—Ä–∞ */}
              {activeSection === 'courier-picked' && user?.role === 'courier' && (
                <div className="space-y-6 p-4 md:p-6">
                  {/* –£–±—Ä–∞–ª–∏ –∫–Ω–æ–ø–∫—É –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è */}

                  {pickedRequests.length > 0 ? (
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {pickedRequests.map((request) => (
                        <Card key={request.id} className="relative border-orange-200 bg-orange-50">
                          <CardHeader>
                            <div className="flex items-start justify-between">
                              <div>
                                <CardTitle className="text-lg">{request.sender_full_name}</CardTitle>
                                <CardDescription>{request.sender_phone}</CardDescription>
                              </div>
                              <Badge variant="secondary" className="bg-orange-100 text-orange-800">
                                –£ –∫—É—Ä—å–µ—Ä–∞
                              </Badge>
                            </div>
                          </CardHeader>
                          
                          <CardContent className="space-y-3">
                            {/* –ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏ */}
                            <div>
                              <Label className="text-sm font-medium text-gray-500">‚Ññ –ó–∞—è–≤–∫–∏</Label>
                              <p className="text-sm font-bold text-orange-600">#{request.request_number || request.id}</p>
                            </div>
                            
                            <div>
                              <Label className="text-sm font-medium text-gray-500">–ì—Ä—É–∑</Label>
                              <p className="text-sm font-medium">{request.cargo_name}</p>
                            </div>
                            
                            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ */}
                            <div className="grid grid-cols-2 gap-2">
                              <div className="bg-gray-50 p-2 rounded">
                                <Label className="text-xs font-medium text-gray-500">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</Label>
                                <p className="text-xs font-medium">{request.sender_full_name}</p>
                                <p className="text-xs text-gray-600">{request.sender_phone}</p>
                              </div>
                              
                              {(request.recipient_full_name || request.recipient_phone) ? (
                                <div className="bg-blue-50 p-2 rounded">
                                  <Label className="text-xs font-medium text-blue-600">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</Label>
                                  <p className="text-xs font-medium">{request.recipient_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                  <p className="text-xs text-blue-600">{request.recipient_phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                </div>
                              ) : (
                                <div className="bg-yellow-50 p-2 rounded">
                                  <Label className="text-xs font-medium text-yellow-600">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</Label>
                                  <p className="text-xs text-yellow-600">–¢—Ä–µ–±—É–µ—Ç—Å—è –∑–∞–ø–æ–ª–Ω–∏—Ç—å</p>
                                </div>
                              )}
                            </div>
                            
                            {/* –ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è */}
                            {request.recipient_address && (
                              <div>
                                <Label className="text-sm font-medium text-gray-500">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</Label>
                                <p className="text-sm text-gray-700">{request.recipient_address}</p>
                              </div>
                            )}
                            
                            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–∞—Ö */}
                            {request.cargo_items && Array.isArray(request.cargo_items) && request.cargo_items.length > 0 ? (
                              <div>
                                <Label className="text-sm font-medium text-gray-500">–î–µ—Ç–∞–ª–∏ –≥—Ä—É–∑–∞</Label>
                                <div className="mt-1 text-xs space-y-1 max-h-16 overflow-y-auto">
                                  {request.cargo_items.map((item, index) => (
                                    <div key={index} className="flex justify-between bg-orange-50 p-1 rounded">
                                      <span>{item.name}</span>
                                      <span className="font-medium">{item.weight}–∫–≥ / {item.total_price}‚ÇΩ</span>
                                    </div>
                                  ))}
                                </div>
                                <div className="text-xs font-medium text-orange-600 mt-1">
                                  –ò—Ç–æ–≥–æ: {request.cargo_items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0)}–∫–≥ / 
                                  {request.cargo_items.reduce((sum, item) => sum + (parseFloat(item.total_price) || 0), 0)}‚ÇΩ
                                </div>
                              </div>
                            ) : (
                              request.total_weight && (
                                <div>
                                  <Label className="text-sm font-medium text-gray-500">–í–µ—Å / –°—Ç–æ–∏–º–æ—Å—Ç—å</Label>
                                  <p className="text-sm">{request.total_weight}–∫–≥ {request.total_value && `/ ${request.total_value}‚ÇΩ`}</p>
                                </div>
                              )
                            )}
                            
                            <div>
                              <Label className="text-sm font-medium text-gray-500">–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</Label>
                              <p className="text-sm">{
                                request.delivery_method === 'pickup' ? '–°–∞–º–æ–≤—ã–≤–æ–∑ —Å —Å–∫–ª–∞–¥–∞' :
                                request.delivery_method === 'home_delivery' ? '–î–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ –¥–æ–º' :
                                request.delivery_method === 'office_delivery' ? '–î–æ—Å—Ç–∞–≤–∫–∞ –≤ –æ—Ñ–∏—Å' :
                                '–°–∞–º–æ–≤—ã–≤–æ–∑'
                              }</p>
                            </div>
                            
                            {/* –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã */}
                            <div className="flex justify-between items-center">
                              <div>
                                <Label className="text-sm font-medium text-gray-500">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã</Label>
                                <Badge variant={request.payment_status === 'paid' ? 'default' : 'secondary'} className="ml-2">
                                  {request.payment_status === 'paid' ? '–û–ø–ª–∞—á–µ–Ω–æ' : 
                                   request.payment_status === 'not_paid' ? '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ' : 
                                   request.payment_method === 'cash_on_delivery' ? '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' : '–ù–µ —É–∫–∞–∑–∞–Ω'}
                                </Badge>
                              </div>
                              
                              {request.courier_fee && (
                                <div className="text-right">
                                  <Label className="text-xs text-gray-500">–ö—É—Ä—å–µ—Ä—É</Label>
                                  <p className="text-sm font-medium text-green-600">{request.courier_fee} ‚ÇΩ</p>
                                </div>
                              )}
                            </div>

                            {/* –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π */}
                            <div className="bg-orange-50 p-3 rounded-lg">
                              <Label className="text-sm font-medium text-orange-700">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</Label>
                              <div className="mt-1 space-y-1 text-xs text-orange-600">
                                <div>‚úÖ {new Date(request.created_at).toLocaleString('ru-RU')}: –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞</div>
                                <div>üìã {new Date(request.accepted_at || request.updated_at).toLocaleString('ru-RU')}: –ü—Ä–∏–Ω—è—Ç–∞ –∫—É—Ä—å–µ—Ä–æ–º</div>
                                <div>üì¶ {new Date(request.picked_at || Date.now()).toLocaleString('ru-RU')}: –ì—Ä—É–∑ –∑–∞–±—Ä–∞–Ω</div>
                              </div>
                            </div>
                          </CardContent>

                          <div className="px-6 pb-6 space-y-2">
                            {/* –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ */}
                            <div className="grid grid-cols-2 gap-2">
                              <Button 
                                variant="outline" 
                                size="sm"
                                onClick={() => handleEditCargoInfo(request)}
                              >
                                <Edit className="mr-1 h-3 w-3" />
                                –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                              </Button>
                              
                              <Button 
                                variant="outline" 
                                size="sm"
                                onClick={() => {
                                  showAlert('–§—É–Ω–∫—Ü–∏—è –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö', 'info');
                                }}
                              >
                                <QrCode className="mr-1 h-3 w-3" />
                                QR –∫–æ–¥
                              </Button>
                            </div>
                            
                            <Button 
                              variant="outline" 
                              size="sm"
                              className="w-full"
                              onClick={() => {
                                showAlert('–§—É–Ω–∫—Ü–∏—è –ø–µ—á–∞—Ç–∏ –Ω–∞–∫–ª–∞–¥–Ω–æ–π –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–æ—Å–ª–µ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö', 'info');
                              }}
                            >
                              <Printer className="mr-2 h-4 w-4" />
                              –ü–µ—á–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω–æ–π
                            </Button>

                            {/* –ì–ª–∞–≤–Ω–∞—è –∫–Ω–æ–ø–∫–∞ - —Å–¥–∞—Ç—å –≥—Ä—É–∑ */}
                            <Button 
                              onClick={() => handleDeliverToWarehouse(request.id)}
                              className="w-full bg-green-600 hover:bg-green-700"
                              size="lg"
                            >
                              <Building className="mr-2 h-4 w-4" />
                              –°–¥–∞—Ç—å –≥—Ä—É–∑ –Ω–∞ —Å–∫–ª–∞–¥
                            </Button>
                          </div>
                        </Card>
                      ))}
                    </div>
                  ) : (
                    <Card>
                      <CardContent className="flex flex-col items-center justify-center py-12">
                        <Truck className="h-12 w-12 text-gray-400 mb-4" />
                        <h3 className="text-lg font-medium text-gray-900 mb-2">–ù–µ—Ç –∑–∞–±—Ä–∞–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤</h3>
                        <p className="text-gray-500 text-center">
                          –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≥—Ä—É–∑—ã, –∫–æ—Ç–æ—Ä—ã–µ –≤—ã –∑–∞–±—Ä–∞–ª–∏ –∏ –≥–æ—Ç–æ–≤—ã —Å–¥–∞—Ç—å –Ω–∞ —Å–∫–ª–∞–¥.
                        </p>
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}

              {/* –ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø: –ß–∞—Ç –∫—É—Ä—å–µ—Ä–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π */}
              {activeSection === 'courier-chat' && user?.role === 'courier' && (
                <div className="space-y-6 p-4 md:p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <h2 className="text-xl md:text-2xl font-bold text-gray-900">–ß–∞—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π</h2>
                      <p className="text-gray-600">–°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∏–ª–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º</p>
                    </div>
                  </div>

                  <Card>
                    <CardContent className="flex flex-col items-center justify-center py-12">
                      <MessageCircle className="h-16 w-16 text-blue-500 mb-4" />
                      <h3 className="text-lg font-medium text-gray-900 mb-2">–ß–∞—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π</h3>
                      <p className="text-gray-500 text-center mb-6">
                        –§—É–Ω–∫—Ü–∏—è —á–∞—Ç–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è. <br />
                        –ü–æ–∫–∞ —á—Ç–æ –≤—ã –º–æ–∂–µ—Ç–µ —Å–≤—è–∑–∞—Ç—å—Å—è —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–æ —Ç–µ–ª–µ—Ñ–æ–Ω—É –∏–ª–∏ email.
                      </p>
                      
                      <div className="space-y-3 w-full max-w-sm">
                        <Button className="w-full" variant="outline">
                          <MessageCircle className="mr-2 h-4 w-4" />
                          –ù–∞–ø–∏—Å–∞—Ç—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
                        </Button>
                        <Button className="w-full" variant="outline">
                          <MessageCircle className="mr-2 h-4 w-4" />
                          –°–≤—è–∑–∞—Ç—å—Å—è —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
                        </Button>
                      </div>
                    </CardContent>
                  </Card>
                </div>
              )}

              {/* –ò—Å—Ç–æ—Ä–∏—è –∑–∞—è–≤–æ–∫ –∫—É—Ä—å–µ—Ä–∞ */}
              {activeSection === 'courier-history' && user?.role === 'courier' && (
                <div className="space-y-6">
                  {/* –£–±—Ä–∞–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ */}

                  <Card>
                    <CardContent className="flex flex-col items-center justify-center py-12">
                      <Clock className="h-12 w-12 text-gray-400 mb-4" />
                      <h3 className="text-lg font-medium text-gray-900 mb-2">–ò—Å—Ç–æ—Ä–∏—è –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</h3>
                      <p className="text-gray-500 text-center">
                        –§—É–Ω–∫—Ü–∏—è –∏—Å—Ç–æ—Ä–∏–∏ –∑–∞—è–≤–æ–∫ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è.
                      </p>
                    </CardContent>
                  </Card>
                </div>
              )}
              
              {/* –ù–û–í–ê–Ø –°–ï–ö–¶–ò–Ø: –û—Ç–º–µ–Ω–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ –∫—É—Ä—å–µ—Ä–∞ */}
              {activeSection === 'courier-cancelled' && user?.role === 'courier' && (
                <div className="space-y-6 p-4 md:p-6">
                  {/* –£–±—Ä–∞–ª–∏ –∑–∞–≥–æ–ª–æ–≤–æ–∫ */}

                  {cancelledRequests.length > 0 ? (
                    <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                      {cancelledRequests.map((request) => (
                        <Card key={request.id} className="relative border-red-200">
                          <CardHeader>
                            <div className="flex items-start justify-between">
                              <div>
                                <CardTitle className="text-lg">{request.sender_full_name}</CardTitle>
                                <CardDescription>{request.sender_phone}</CardDescription>
                              </div>
                              <Badge variant="destructive" className="bg-red-100 text-red-800">
                                –û—Ç–º–µ–Ω–µ–Ω–∞
                              </Badge>
                            </div>
                          </CardHeader>
                          
                          <CardContent className="space-y-3">
                            <div>
                              <Label className="text-sm font-medium text-gray-500">–ì—Ä—É–∑</Label>
                              <p className="text-sm font-medium">{request.cargo_name}</p>
                            </div>
                            
                            <div>
                              <Label className="text-sm font-medium text-gray-500">–ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞</Label>
                              <p className="text-sm text-gray-700">{request.pickup_address}</p>
                            </div>
                            
                            <div className="grid grid-cols-2 gap-3">
                              <div>
                                <Label className="text-sm font-medium text-gray-500">–î–∞—Ç–∞ –æ—Ç–º–µ–Ω—ã</Label>
                                <p className="text-sm">{new Date(request.cancelled_at || request.updated_at).toLocaleDateString('ru-RU')}</p>
                              </div>
                              <div>
                                <Label className="text-sm font-medium text-gray-500">–ü—Ä–∏—á–∏–Ω–∞</Label>
                                <p className="text-sm">{request.cancellation_reason || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                              </div>
                            </div>

                            {/* –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π */}
                            <div className="bg-red-50 p-3 rounded-lg">
                              <Label className="text-sm font-medium text-red-700">–ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π</Label>
                              <div className="mt-2 space-y-1 text-xs text-red-600">
                                {request.cancelled_by && (
                                  <div className="flex items-center">
                                    <XCircle className="h-3 w-3 mr-1" />
                                    <span>–û—Ç–º–µ–Ω–µ–Ω–∞: {request.cancelled_by === 'courier' ? '–∫—É—Ä—å–µ—Ä–æ–º' : 
                                                     request.cancelled_by === 'operator' ? '–æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º' : 
                                                     request.cancelled_by === 'admin' ? '–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º' : request.cancelled_by}</span>
                                  </div>
                                )}
                                <div className="flex items-center">
                                  <Package className="h-3 w-3 mr-1" />
                                  <span>–°–æ–∑–¥–∞–Ω–∞: {new Date(request.created_at).toLocaleDateString('ru-RU')} {new Date(request.created_at).toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}</span>
                                </div>
                                {request.accepted_at && (
                                  <div className="flex items-center">
                                    <CheckCircle className="h-3 w-3 mr-1" />
                                    <span>–ü—Ä–∏–Ω—è—Ç–∞: {new Date(request.accepted_at).toLocaleDateString('ru-RU')} {new Date(request.accepted_at).toLocaleTimeString('ru-RU', {hour: '2-digit', minute:'2-digit'})}</span>
                                  </div>
                                )}
                              </div>
                            </div>
                            
                            {/* –ö–Ω–æ–ø–∫–∞ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –∑–∞—è–≤–∫–∏ */}
                            <div className="pt-3 border-t">
                              <Button 
                                onClick={() => handleRestoreRequest(request.id)}
                                className="w-full bg-green-600 hover:bg-green-700 text-white"
                                size="lg"
                              >
                                <RefreshCw className="mr-2 h-4 w-4" />
                                –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –∑–∞—è–≤–∫—É
                              </Button>
                              <p className="text-xs text-gray-500 text-center mt-2">
                                –ó–∞—è–≤–∫–∞ –≤–µ—Ä–Ω–µ—Ç—Å—è –≤ "–ù–æ–≤—ã–µ –∑–∞—è–≤–∫–∏"
                              </p>
                            </div>
                          </CardContent>
                        </Card>
                      ))}
                    </div>
                  ) : (
                    <Card>
                      <CardContent className="flex flex-col items-center justify-center py-12">
                        <XCircle className="h-12 w-12 text-gray-400 mb-4" />
                        <h3 className="text-lg font-medium text-gray-900 mb-2">–ù–µ—Ç –æ—Ç–º–µ–Ω–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫</h3>
                        <p className="text-gray-500 text-center">
                          –ó–¥–µ—Å—å –±—É–¥—É—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –∑–∞—è–≤–∫–∏, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –æ—Ç–º–µ–Ω–µ–Ω—ã –≤–∞–º–∏, –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º–∏ –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏.
                        </p>
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}
              
              {/* –ù–û–í–´–ï –°–ï–ö–¶–ò–ò –î–õ–Ø –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–Ø –ö–£–†–¨–ï–†–û–í */}
              
              {/* –ö–∞—Ä—Ç–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–æ–≤ - –¥–æ—Å—Ç—É–ø–Ω–∞ –∞–¥–º–∏–Ω–∞–º –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º */}
              {activeSection === 'couriers-tracking' && activeTab === 'couriers-tracking-map' && 
               (user?.role === 'admin' || user?.role === 'warehouse_operator') && (
                <div className="space-y-6 p-4 md:p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <h1 className="text-2xl font-bold text-gray-900">–ö–∞—Ä—Ç–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–æ–≤</h1>
                      <p className="text-gray-600">Real-time –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –∫—É—Ä—å–µ—Ä–æ–≤</p>
                    </div>
                  </div>
                  
                  <CourierTrackingMap 
                    userRole={user?.role}
                    apiCall={apiCall}
                  />
                </div>
              )}

              {/* –°–ø–∏—Å–æ–∫ –∫—É—Ä—å–µ—Ä–æ–≤ —Å –∫–∞—Ä—Ç–æ–π - —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ */}
              {activeSection === 'couriers-tracking' && activeTab === 'couriers-tracking-list' && 
               user?.role === 'admin' && (
                <div className="space-y-6 p-4 md:p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <h1 className="text-2xl font-bold text-gray-900">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞–º–∏</h1>
                      <p className="text-gray-600">–°–ø–∏—Å–æ–∫ –∫—É—Ä—å–µ—Ä–æ–≤ –∏ –∏—Ö –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ</p>
                    </div>
                  </div>
                  
                  {/* –ö–∞—Ä—Ç–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è */}
                  <CourierTrackingMap 
                    userRole={user?.role}
                    apiCall={apiCall}
                  />
                  
                  {/* –°—É—â–µ—Å—Ç–≤—É—é—â–∞—è —Ç–∞–±–ª–∏—Ü–∞ –∫—É—Ä—å–µ—Ä–æ–≤ */}
                  <Card>
                    <CardHeader>
                      <CardTitle className="flex items-center justify-between">
                        <div className="flex items-center">
                          <Truck className="mr-2 h-5 w-5" />
                          –ö—É—Ä—å–µ—Ä—ã ({couriers.length})
                        </div>
                        <div className="flex items-center space-x-3">
                          {/* –ù–û–í–û–ï: –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –¥–ª—è –ø–æ–∫–∞–∑–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤ (—Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤) */}
                          {user?.role === 'admin' && (
                            <div className="flex items-center space-x-2">
                              <Checkbox
                                id="show-inactive-couriers"
                                checked={showInactiveCouriers}
                                onCheckedChange={(checked) => {
                                  setShowInactiveCouriers(checked);
                                  setCouriersPage(1); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∞ –ø–µ—Ä–≤—É—é —Å—Ç—Ä–∞–Ω–∏—Ü—É
                                }}
                              />
                              <label
                                htmlFor="show-inactive-couriers"
                                className="text-sm font-medium leading-none peer-disabled:cursor-not-allowed peer-disabled:opacity-70 cursor-pointer"
                                title="–ü–æ–∫–∞–∑–∞—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã—Ö/–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤"
                              >
                                –ü–æ–∫–∞–∑–∞—Ç—å —É–¥–∞–ª–µ–Ω–Ω—ã—Ö
                              </label>
                            </div>
                          )}
                          <Button onClick={() => setCourierCreateModal(true)}>
                            <Plus className="mr-2 h-4 w-4" />
                            –°–æ–∑–¥–∞—Ç—å –∫—É—Ä—å–µ—Ä–∞
                          </Button>
                        </div>
                      </CardTitle>
                      <CardDescription>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞–º–∏ –∏ —Å–ª—É–∂–±–æ–π –¥–æ—Å—Ç–∞–≤–∫–∏</CardDescription>
                    </CardHeader>
                    <CardContent>
                      {couriers.length > 0 ? (
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>–§–ò–û</TableHead>
                                <TableHead>–¢–µ–ª–µ—Ñ–æ–Ω</TableHead>
                                <TableHead>–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</TableHead>
                                <TableHead>–ì—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å</TableHead>
                                <TableHead>–°–∫–ª–∞–¥</TableHead>
                                <TableHead>–°—Ç–∞—Ç—É—Å</TableHead>
                                <TableHead>–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {couriers.map((courier) => {
                                // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —è–≤–ª—è–µ—Ç—Å—è –ª–∏ –∫—É—Ä—å–µ—Ä —É–¥–∞–ª–µ–Ω–Ω—ã–º/–Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º
                                const isDeleted = courier.deleted === true;
                                const isInactive = courier.is_active === false;
                                const isDeletedOrInactive = isDeleted || isInactive;
                                
                                return (
                                  <TableRow key={courier.id} className={isDeletedOrInactive ? 'opacity-60 bg-gray-50' : ''}>
                                    <TableCell className="font-medium">
                                      <div className="flex items-center">
                                        {courier.full_name}
                                        {isDeleted && (
                                          <Badge variant="secondary" className="ml-2 text-xs bg-red-100 text-red-700">
                                            –£–¥–∞–ª–µ–Ω
                                          </Badge>
                                        )}
                                        {isInactive && !isDeleted && (
                                          <Badge variant="secondary" className="ml-2 text-xs bg-orange-100 text-orange-700">
                                            –ù–µ–∞–∫—Ç–∏–≤–µ–Ω
                                          </Badge>
                                        )}
                                      </div>
                                    </TableCell>
                                  <TableCell>{courier.phone}</TableCell>
                                  <TableCell>
                                    <div className="flex items-center">
                                      <Truck className="mr-2 h-4 w-4" />
                                      {courier.transport_type} {courier.transport_number}
                                    </div>
                                  </TableCell>
                                  <TableCell>{courier.transport_capacity} –∫–≥</TableCell>
                                  <TableCell>{courier.assigned_warehouse_name}</TableCell>
                                  <TableCell>
                                    <Badge variant={courier.is_active ? "default" : "secondary"}>
                                      {courier.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                                    </Badge>
                                  </TableCell>
                                  <TableCell>
                                    <div className="flex space-x-2">
                                      <Button
                                        size="sm"
                                        variant="outline"
                                        onClick={() => {
                                          setSelectedCourier(courier);
                                          setCourierProfileEditForm({
                                            full_name: courier.full_name,
                                            phone: courier.phone,
                                            transport_type: courier.transport_type,
                                            transport_number: courier.transport_number,
                                            transport_capacity: courier.transport_capacity,
                                            assigned_warehouse_id: courier.assigned_warehouse_id,
                                            is_active: courier.is_active
                                          });
                                          setCourierEditModal(true);
                                        }}
                                      >
                                        <Edit className="h-4 w-4" />
                                      </Button>
                                      <Button
                                        size="sm"
                                        variant="outline"
                                        onClick={() => {
                                          setSelectedCourier(courier);
                                          setCourierProfileModal(true);
                                        }}
                                      >
                                        <Eye className="h-4 w-4" />
                                      </Button>
                                      {/* –ù–û–í–ê–Ø –ö–ù–û–ü–ö–ê: –£–¥–∞–ª–µ–Ω–∏–µ –∫—É—Ä—å–µ—Ä–∞ (–Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞ –¥–ª—è —É–∂–µ —É–¥–∞–ª–µ–Ω–Ω—ã—Ö) */}
                                      <Button
                                        size="sm"
                                        variant="outline"
                                        className={`${isDeletedOrInactive 
                                          ? 'text-gray-400 cursor-not-allowed opacity-50' 
                                          : 'text-red-600 hover:text-red-700 hover:bg-red-50 border-red-200'
                                        }`}
                                        onClick={() => !isDeletedOrInactive && handleDeleteCourier(courier)}
                                        disabled={isDeletedOrInactive}
                                        title={isDeletedOrInactive 
                                          ? '–ö—É—Ä—å–µ—Ä —É–∂–µ —É–¥–∞–ª–µ–Ω' 
                                          : `–£–¥–∞–ª–∏—Ç—å –∫—É—Ä—å–µ—Ä–∞ ${courier.full_name}`
                                        }
                                      >
                                        <Trash2 className="h-4 w-4" />
                                      </Button>
                                    </div>
                                  </TableCell>
                                </TableRow>
                                );
                              })}
                            </TableBody>
                          </Table>
                        </div>
                      ) : (
                        <div className="text-center py-8">
                          <Truck className="mx-auto h-12 w-12 text-gray-400" />
                          <h3 className="mt-2 text-sm font-medium text-gray-900">–ù–µ—Ç –∫—É—Ä—å–µ—Ä–æ–≤</h3>
                          <p className="mt-1 text-sm text-gray-500">–ù–∞—á–Ω–∏—Ç–µ —Å —Å–æ–∑–¥–∞–Ω–∏—è –ø–µ—Ä–≤–æ–≥–æ –∫—É—Ä—å–µ—Ä–∞.</p>
                          <div className="mt-6">
                            <Button onClick={() => setCourierCreateModal(true)}>
                              <Plus className="mr-2 h-4 w-4" />
                              –°–æ–∑–¥–∞—Ç—å –∫—É—Ä—å–µ—Ä–∞
                            </Button>
                          </div>
                        </div>
                      )}
                    </CardContent>
                  </Card>
                </div>
              )}

              {/* –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∫—É—Ä—å–µ—Ä—ã - —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–¥–º–∏–Ω–æ–≤ */}
              {activeSection === 'couriers-tracking' && activeTab === 'couriers-inactive' && 
               user?.role === 'admin' && (
                <div className="space-y-6 p-4 md:p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <h1 className="text-2xl font-bold text-gray-900">–ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∫—É—Ä—å–µ—Ä—ã</h1>
                      <p className="text-gray-600">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∏ —É–¥–∞–ª–µ–Ω–Ω—ã–º–∏ –∫—É—Ä—å–µ—Ä–∞–º–∏</p>
                    </div>
                    <Button 
                      onClick={fetchInactiveCouriers}
                      variant="outline"
                      className="flex items-center"
                    >
                      <RefreshCw className="mr-2 h-4 w-4" />
                      –û–±–Ω–æ–≤–∏—Ç—å
                    </Button>
                  </div>
                  
                  <Card>
                    <CardHeader>
                      <CardTitle className="flex items-center">
                        <UserX className="mr-2 h-5 w-5 text-orange-600" />
                        –ù–µ–∞–∫—Ç–∏–≤–Ω—ã–µ –∫—É—Ä—å–µ—Ä—ã ({inactiveCouriers.length})
                      </CardTitle>
                      <CardDescription>
                        –ö—É—Ä—å–µ—Ä—ã, –∫–æ—Ç–æ—Ä—ã–µ –±—ã–ª–∏ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã –∏–ª–∏ —É–¥–∞–ª–µ–Ω—ã –∏–∑ —Å–∏—Å—Ç–µ–º—ã. –ò—Ö –º–æ–∂–Ω–æ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∏–ª–∏ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª–Ω–æ—Å—Ç—å—é.
                      </CardDescription>
                    </CardHeader>
                    <CardContent>
                      {inactiveCouriers.length > 0 ? (
                        <div className="overflow-x-auto">
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>–ö—É—Ä—å–µ—Ä</TableHead>
                                <TableHead>–°–∫–ª–∞–¥</TableHead>
                                <TableHead>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</TableHead>
                                <TableHead>–°—Ç–∞—Ç—É—Å</TableHead>
                                <TableHead className="text-right">–î–µ–π—Å—Ç–≤–∏—è</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {inactiveCouriers.map((courier) => (
                                <TableRow key={courier.id} className="opacity-75 bg-gray-50">
                                  <TableCell>
                                    <div className="flex items-center">
                                      <div className="w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                        <UserX className="h-4 w-4 text-red-600" />
                                      </div>
                                      <div>
                                        <div className="font-medium text-gray-900">{courier.full_name}</div>
                                        <div className="text-sm text-gray-500">ID: {courier.id}</div>
                                      </div>
                                    </div>
                                  </TableCell>
                                  <TableCell>
                                    <div className="text-sm">
                                      <div className="font-medium">{courier.assigned_warehouse_name || '–ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</div>
                                      {courier.assigned_warehouse_id && (
                                        <div className="text-gray-500">ID: {courier.assigned_warehouse_id}</div>
                                      )}
                                    </div>
                                  </TableCell>
                                  <TableCell>
                                    <div className="text-sm">
                                      {courier.user_info ? (
                                        <>
                                          <div className="font-medium">{courier.user_info.full_name}</div>
                                          <div className="text-gray-500">{courier.user_info.phone}</div>
                                          <div className={`text-xs px-2 py-1 rounded-full inline-block ${
                                            courier.user_info.is_active 
                                              ? 'bg-green-100 text-green-800' 
                                              : 'bg-red-100 text-red-800'
                                          }`}>
                                            {courier.user_info.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}
                                          </div>
                                        </>
                                      ) : (
                                        <span className="text-gray-400">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω</span>
                                      )}
                                    </div>
                                  </TableCell>
                                  <TableCell>
                                    <div className="flex flex-col space-y-1">
                                      <div className="flex items-center">
                                        <div className="w-2 h-2 bg-red-500 rounded-full mr-2"></div>
                                        <span className="text-sm font-medium text-red-700">–ù–µ–∞–∫—Ç–∏–≤–µ–Ω</span>
                                      </div>
                                      {courier.deactivated_at && (
                                        <div className="text-xs text-gray-500">
                                          –î–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω: {new Date(courier.deactivated_at).toLocaleDateString('ru-RU')}
                                        </div>
                                      )}
                                      {courier.reactivated_at && (
                                        <div className="text-xs text-green-600">
                                          –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è: {new Date(courier.reactivated_at).toLocaleDateString('ru-RU')}
                                        </div>
                                      )}
                                    </div>
                                  </TableCell>
                                  <TableCell className="text-right">
                                    <div className="flex items-center justify-end space-x-2">
                                      {/* –ö–Ω–æ–ø–∫–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏ */}
                                      <Button
                                        size="sm"
                                        variant="outline"
                                        className="text-green-600 hover:text-green-700 hover:bg-green-50 border-green-200"
                                        onClick={() => handleActivateCourier(courier.id, courier.full_name)}
                                        title={`–ê–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å –∫—É—Ä—å–µ—Ä–∞ ${courier.full_name}`}
                                      >
                                        <UserCheck className="h-4 w-4" />
                                      </Button>
                                      
                                      {/* –ö–Ω–æ–ø–∫–∞ –ø–æ–ª–Ω–æ–≥–æ —É–¥–∞–ª–µ–Ω–∏—è */}
                                      <Button
                                        size="sm"
                                        variant="outline"
                                        className="text-red-600 hover:text-red-700 hover:bg-red-50 border-red-200"
                                        onClick={() => handlePermanentDeleteCourier(courier.id, courier.full_name)}
                                        title={`–ü–æ–ª–Ω–æ—Å—Ç—å—é —É–¥–∞–ª–∏—Ç—å –∫—É—Ä—å–µ—Ä–∞ ${courier.full_name}`}
                                      >
                                        <X className="h-4 w-4" />
                                      </Button>
                                    </div>
                                  </TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        </div>
                      ) : (
                        <div className="text-center py-8">
                          <UserCheck className="mx-auto h-12 w-12 text-gray-400" />
                          <h3 className="mt-2 text-sm font-medium text-gray-900">–ù–µ—Ç –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤</h3>
                          <p className="mt-1 text-sm text-gray-500">–í—Å–µ –∫—É—Ä—å–µ—Ä—ã –∞–∫—Ç–∏–≤–Ω—ã –∏–ª–∏ –Ω–µ –±—ã–ª–æ –¥–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –∫—É—Ä—å–µ—Ä–æ–≤.</p>
                        </div>
                      )}
                    </CardContent>
                  </Card>
                  
                  {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å */}
                  <Card className="bg-blue-50 border-blue-200">
                    <CardContent className="p-4">
                      <div className="flex items-start space-x-3">
                        <div className="flex-shrink-0">
                          <div className="w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center">
                            <UserCheck className="h-4 w-4 text-blue-600" />
                          </div>
                        </div>
                        <div className="flex-1">
                          <h4 className="text-sm font-medium text-blue-900 mb-1">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∫—É—Ä—å–µ—Ä–∞–º–∏</h4>
                          <div className="text-sm text-blue-800 space-y-1">
                            <p><strong>–ê–∫—Ç–∏–≤–∞—Ü–∏—è:</strong> –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç –¥–æ—Å—Ç—É–ø –∫—É—Ä—å–µ—Ä–∞ –∫ —Å–∏—Å—Ç–µ–º–µ –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–Ω–∏–º–∞—Ç—å –∑–∞—è–≤–∫–∏.</p>
                            <p><strong>–ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ:</strong> –ù–µ–æ–±—Ä–∞—Ç–∏–º–æ —É–¥–∞–ª—è–µ—Ç –∫—É—Ä—å–µ—Ä–∞, —Å–≤—è–∑–∞–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏ –≤—Å—é –∏—Å—Ç–æ—Ä–∏—é –∏–∑ —Å–∏—Å—Ç–µ–º—ã.</p>
                            <p><strong>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:</strong> –ü–æ–ª–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ –¥–ª—è –∫—É—Ä—å–µ—Ä–æ–≤ —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∑–∞—è–≤–∫–∞–º–∏.</p>
                          </div>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                </div>
              )}

              {/* –ò—Å—Ç–æ—Ä–∏—è –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫—É—Ä—å–µ—Ä–æ–≤ - –¥–æ—Å—Ç—É–ø–Ω–∞ –∞–¥–º–∏–Ω–∞–º –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞–º */}
              {activeSection === 'couriers-tracking' && activeTab === 'couriers-history-analytics' && 
               (user?.role === 'admin' || user?.role === 'warehouse_operator') && (
                <div className="space-y-6 p-4 md:p-6">
                  <div className="flex items-center justify-between">
                    <div>
                      <h1 className="text-2xl font-bold text-gray-900">–ò—Å—Ç–æ—Ä–∏—è –∏ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ –∫—É—Ä—å–µ—Ä–æ–≤</h1>
                      <p className="text-gray-600">–ê–Ω–∞–ª–∏–∑ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–π, —Ä–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –ø—Ä–∏–±—ã—Ç–∏—è –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏ –¥–æ—Å—Ç–∞–≤–∫–∏</p>
                    </div>
                  </div>
                  
                  <CourierHistoryAnalytics 
                    userRole={user?.role}
                    apiCall={apiCall}
                  />
                </div>
              )}
            </div>
          )}
        </main>
      </div>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–∏–µ–º–∞ –æ–ø–ª–∞—Ç—ã */}
      <Dialog open={paymentModal} onOpenChange={setPaymentModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>–ü—Ä–∏—ë–º –æ–ø–ª–∞—Ç—ã</DialogTitle>
            <DialogDescription>
              –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≥—Ä—É–∑–∞ –¥–ª—è –ø–æ–∏—Å–∫–∞ –∏ –ø—Ä–∏–µ–º–∞ –æ–ø–ª–∞—Ç—ã
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <Label htmlFor="cargo_search">–ù–æ–º–µ—Ä –≥—Ä—É–∑–∞</Label>
              <div className="flex space-x-2">
                <Input
                  id="cargo_search"
                  value={paymentForm.cargo_number}
                  onChange={(e) => setPaymentForm({...paymentForm, cargo_number: e.target.value})}
                  placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≥—Ä—É–∑–∞"
                />
                <Button onClick={handleSearchCargoForPayment}>
                  <Search className="h-4 w-4" />
                </Button>
              </div>
            </div>

            {cargoForPayment && (
              <div className="border rounded-lg p-4 bg-gray-50">
                <h4 className="font-semibold mb-2">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ:</h4>
                <div className="space-y-2 text-sm">
                  <p><strong>–ù–æ–º–µ—Ä:</strong> {cargoForPayment.cargo_number}</p>
                  <p><strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> {cargoForPayment.sender_full_name}</p>
                  <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {cargoForPayment.sender_phone}</p>
                  <p><strong>–í–µ—Å:</strong> {cargoForPayment.weight} –∫–≥</p>
                  <p><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong> {cargoForPayment.description}</p>
                  <p><strong>–°—É–º–º–∞ –∫ –æ–ø–ª–∞—Ç–µ:</strong> <span className="text-red-600 font-bold">{cargoForPayment.declared_value} ‚ÇΩ</span></p>
                  <p><strong>–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞:</strong> {new Date(cargoForPayment.created_at).toLocaleDateString('ru-RU')} {new Date(cargoForPayment.created_at).toLocaleTimeString('ru-RU')}</p>
                </div>
              </div>
            )}

            {cargoForPayment && (
              <>
                <div>
                  <Label htmlFor="amount_paid">–°—É–º–º–∞ –æ–ø–ª–∞—á–µ–Ω–∞ –∫–ª–∏–µ–Ω—Ç–æ–º</Label>
                  <Input
                    id="amount_paid"
                    type="number"
                    step="0.01"
                    value={paymentForm.amount_paid}
                    onChange={(e) => setPaymentForm({...paymentForm, amount_paid: e.target.value})}
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É"
                  />
                </div>

                <div>
                  <Label htmlFor="transaction_type">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</Label>
                  <Select value={paymentForm.transaction_type} onValueChange={(value) => setPaymentForm({...paymentForm, transaction_type: value})}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="cash">–ù–∞–ª–∏—á–Ω—ã–º–∏</SelectItem>
                      <SelectItem value="card">–ö–∞—Ä—Ç–æ–π</SelectItem>
                      <SelectItem value="transfer">–ü–µ—Ä–µ–≤–æ–¥–æ–º</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <Label htmlFor="notes">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</Label>
                  <Textarea
                    id="notes"
                    value={paymentForm.notes}
                    onChange={(e) => setPaymentForm({...paymentForm, notes: e.target.value})}
                    placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏..."
                  />
                </div>

                <div className="flex space-x-2 pt-4">
                  <Button onClick={handleProcessPayment} className="flex-1">
                    <CreditCard className="mr-2 h-4 w-4" />
                    –û–ø–ª–∞—Ç–∏—Ç—å
                  </Button>
                  <Button variant="outline" onClick={() => {
                    setPaymentModal(false);
                    setCargoForPayment(null);
                    setPaymentForm({cargo_number: '', amount_paid: '', transaction_type: 'cash', notes: ''});
                  }}>
                    –û—Ç–º–µ–Ω–∞
                  </Button>
                </div>
              </>
            )}
          </div>
        </DialogContent>
      </Dialog>

      {/* –ù–û–í–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –ü–æ–ª–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≥—Ä—É–∑–∞ –∏–∑ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */}
      <Dialog open={showCargoAcceptanceModal} onOpenChange={setShowCargoAcceptanceModal}>
        <DialogContent className="max-w-5xl max-h-[90vh] overflow-y-auto relative">
          <DevBadge id={getDevNumber('forms', 'cargo-acceptance').id} type="form" label={getDevNumber('forms', 'cargo-acceptance').label} />
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Package className="mr-2 h-5 w-5 text-blue-600" />
              {currentCargoNotification?.isCargoMode ? 
                '–ü—Ä–æ—Å–º–æ—Ç—Ä —Ä–∞–∑–º–µ—â–µ–Ω–Ω–æ–≥–æ –≥—Ä—É–∑–∞' : 
                currentCargoNotification?.isViewMode ? 
                  '–ü—Ä–æ—Å–º–æ—Ç—Ä –ø—Ä–∏–Ω—è—Ç–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è' : 
                  '–ü–æ–ª–Ω–æ–µ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≥—Ä—É–∑–∞ –Ω–∞ —Å–∫–ª–∞–¥–µ'
              }
            </DialogTitle>
            <DialogDescription>
              {currentCargoNotification?.isCargoMode ? 
                `–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–∞–∑–º–µ—â–µ–Ω–Ω–æ–≥–æ –≥—Ä—É–∑–∞ ‚Ññ${currentCargoNotification?.request_number}` :
                currentCargoNotification?.isViewMode ? 
                  `–ü—Ä–æ—Å–º–æ—Ç—Ä –∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–æ–≥–æ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è ‚Ññ${currentCargoNotification?.request_number}` :
                  `–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≥—Ä—É–∑–∞ –∏–∑ –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä ‚Ññ${currentCargoNotification?.request_number}`
              }
            </DialogDescription>
          </DialogHeader>
          
          {currentCargoNotification && (
            <form onSubmit={(e) => { 
              e.preventDefault(); 
              
              // –°–æ–∑–¥–∞–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ —Å–∫–ª–∞–¥–∞—Ö
              const extendedCargoDetails = {
                ...cargoAcceptanceForm,
                // –î–æ–±–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –º–∞—Ä—à—Ä—É—Ç–µ —Å–∫–ª–∞–¥–æ–≤–∞–Ω–∏—è
                source_warehouse_id: operatorWarehouses[0]?.id, // –°–∫–ª–∞–¥ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (–æ—Ç–∫—É–¥–∞)
                source_warehouse_name: operatorWarehouses[0]?.name,
                destination_warehouse_id: cargoAcceptanceForm.warehouse_id, // –í—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∫–ª–∞–¥ (–∫—É–¥–∞)
                destination_warehouse_name: warehouses.find(w => w.id === cargoAcceptanceForm.warehouse_id)?.name,
                // –£–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —ç—Ç–æ –º–∞—Ä—à—Ä—É—Ç–Ω–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞
                is_route_delivery: true,
                route_info: {
                  from: {
                    warehouse_id: operatorWarehouses[0]?.id,
                    warehouse_name: operatorWarehouses[0]?.name,
                    location: operatorWarehouses[0]?.location
                  },
                  to: {
                    warehouse_id: cargoAcceptanceForm.warehouse_id,
                    warehouse_name: warehouses.find(w => w.id === cargoAcceptanceForm.warehouse_id)?.name,
                    location: warehouses.find(w => w.id === cargoAcceptanceForm.warehouse_id)?.location
                  }
                }
              };
              
              console.log('üìç –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –≥—Ä—É–∑–∞ —Å –º–∞—Ä—à—Ä—É—Ç–æ–º:', extendedCargoDetails);
              handleCompleteCargoProcessing(currentCargoNotification.id, extendedCargoDetails); 
            }} className="space-y-6">
              
              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ */}
              <div className="bg-orange-50 p-4 rounded-lg border border-orange-200">
                <h3 className="font-medium text-orange-800 mb-2">üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ—Å—Ç—É–ø–∏–≤—à–µ–º –≥—Ä—É–∑–µ</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div>
                    <p><strong>–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏:</strong> {currentCargoNotification.request_number}</p>
                    <p><strong>–ö—É—Ä—å–µ—Ä:</strong> {currentCargoNotification.courier_name}</p>
                    <p><strong>–°–¥–∞–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥:</strong> {new Date(currentCargoNotification.delivered_at).toLocaleString('ru-RU')}</p>
                    <p><strong>–ü–ª–∞—Ç–∞ –∫—É—Ä—å–µ—Ä—É:</strong> {currentCargoNotification.courier_fee} ‚ÇΩ</p>
                  </div>
                  <div>
                    <p><strong>–ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞:</strong> {currentCargoNotification.sender_data?.pickup_address || currentCargoNotification.pickup_address || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    <p><strong>–î–∞—Ç–∞ –∑–∞–±–æ—Ä–∞:</strong> {currentCargoNotification.sender_data?.pickup_date || currentCargoNotification.pickup_date || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                    <p><strong>–í—Ä–µ–º—è –∑–∞–±–æ—Ä–∞:</strong> {currentCargoNotification.sender_data?.pickup_time_from && currentCargoNotification.sender_data?.pickup_time_to ? 
                      `${currentCargoNotification.sender_data.pickup_time_from} - ${currentCargoNotification.sender_data.pickup_time_to}` : 
                      (currentCargoNotification.pickup_time_from && currentCargoNotification.pickup_time_to ? 
                        `${currentCargoNotification.pickup_time_from} - ${currentCargoNotification.pickup_time_to}` : '–ù–µ —É–∫–∞–∑–∞–Ω–æ')
                    }</p>
                    <p><strong>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</strong> {(() => {
                      const paymentMethod = currentCargoNotification.courier_payment_method || currentCargoNotification.payment_info?.payment_method || currentCargoNotification.payment_method;
                      switch(paymentMethod) {
                        case 'cash': return '–ù–∞–ª–∏—á–Ω—ã–µ';
                        case 'card': return '–ö–∞—Ä—Ç–∞';
                        case 'transfer': return '–ü–µ—Ä–µ–≤–æ–¥';
                        case 'not_paid': return '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ';
                        default: return paymentMethod || '–ù–µ —É–∫–∞–∑–∞–Ω';
                      }
                    })()}</p>
                  </div>
                </div>
                
                {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ (–µ—Å–ª–∏ –µ—Å—Ç—å) */}
                <div className="mt-4 pt-4 border-t border-orange-200">
                  <h4 className="font-medium text-orange-700 mb-2">üë§ –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è (–∑–∞–ø–æ–ª–Ω–µ–Ω–æ –∫—É—Ä—å–µ—Ä–æ–º)</h4>
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-2 text-sm">
                    <p><strong>–§–ò–û:</strong> {currentCargoNotification?.recipient_data?.recipient_full_name || cargoAcceptanceForm.recipient_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                    <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {currentCargoNotification?.recipient_data?.recipient_phone || cargoAcceptanceForm.recipient_phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    <p><strong>–ê–¥—Ä–µ—Å:</strong> {currentCargoNotification?.recipient_data?.recipient_address || cargoAcceptanceForm.recipient_address || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                  </div>
                  {/* –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
                  {process.env.NODE_ENV === 'development' && (
                    <div className="mt-2 p-2 bg-gray-100 rounded text-xs">
                      <p>DEBUG - recipient_data: {JSON.stringify(currentCargoNotification?.recipient_data)}</p>
                      <p>DEBUG - form data: –§–ò–û: {cargoAcceptanceForm.recipient_full_name}, –¢–µ–ª: {cargoAcceptanceForm.recipient_phone}</p>
                    </div>
                  )}
                </div>
                
                {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ */}
                <div className="mt-4 pt-4 border-t border-orange-200">
                  <h4 className="font-medium text-orange-700 mb-2">üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ</h4>
                  {cargoAcceptanceForm.cargo_items && cargoAcceptanceForm.cargo_items.length > 0 ? (
                    <div className="space-y-2">
                      {cargoAcceptanceForm.cargo_items.map((item, index) => (
                        <div key={index} className="bg-white p-3 rounded border text-sm">
                          <div className="flex items-center justify-between mb-2">
                            <h5 className="font-medium text-gray-800">–ì—Ä—É–∑ ‚Ññ{index + 1}</h5>
                            <span className="text-xs text-gray-500">
                              {item.weight && item.price ? 
                                `${item.weight} –∫–≥ √ó ${item.price} ‚ÇΩ = ${(parseFloat(item.weight) * parseFloat(item.price)).toFixed(2)} ‚ÇΩ` : 
                                '–†–∞—Å—á–µ—Ç –Ω–µ –¥–æ—Å—Ç—É–ø–µ–Ω'
                              }
                            </span>
                          </div>
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                            <p><strong>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</strong> {item.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                            <p><strong>–í–µ—Å:</strong> {item.weight ? `${item.weight} –∫–≥` : '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                            <p><strong>–¶–µ–Ω–∞:</strong> {item.price ? `${item.price} ‚ÇΩ` : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                          </div>
                          
                          {/* –ö–Ω–æ–ø–∫–∏ QR –∫–æ–¥–∞ –∏ —ç—Ç–∏–∫–µ—Ç–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥—Ä—É–∑–∞ */}
                          <div className="flex space-x-2 mt-3 pt-2 border-t border-gray-200">
                            <Button
                              size="sm"
                              variant="outline" 
                              onClick={() => {
                                // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –Ω–æ–º–µ—Ä –≥—Ä—É–∑–∞ –≤ —Ñ–æ—Ä–º–∞—Ç–µ –∑–∞—è–≤–∫–∏/–∏–Ω–¥–µ–∫—Å (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)
                                const requestNum = currentCargoNotification?.request_number?.replace(/\D/g, '') || '000000';
                                const cargoNumber = `${requestNum}/${String(index + 1).padStart(2, '0')}`;
                                
                                // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–µ –æ–∫–Ω–æ –¥–ª—è QR –∫–æ–¥–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –≥—Ä—É–∑–∞
                                const printWindow = window.open('', '_blank');
                                if (!printWindow) {
                                  showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
                                  return;
                                }
                                
                                printWindow.document.write(`
                                  <html>
                                    <head>
                                      <title>QR –∫–æ–¥ –≥—Ä—É–∑–∞ ${cargoNumber}</title>
                                      <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
                                      <style>
                                        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
                                        .qr-container { margin: 20px auto; }
                                        .cargo-info { margin: 10px 0; font-size: 14px; }
                                        #qrcode { margin: 20px auto; display: block; }
                                        .print-btn { 
                                          margin: 20px; 
                                          padding: 10px 20px; 
                                          font-size: 16px; 
                                          background: #007bff; 
                                          color: white; 
                                          border: none; 
                                          border-radius: 5px; 
                                          cursor: pointer; 
                                        }
                                        @media print { 
                                          body { margin: 0; }
                                          .print-btn { display: none; }
                                        }
                                      </style>
                                    </head>
                                    <body>
                                      <h2>QR –∫–æ–¥ –≥—Ä—É–∑–∞</h2>
                                      <div class="cargo-info">
                                        <strong>–ù–æ–º–µ—Ä –≥—Ä—É–∑–∞:</strong> ${cargoNumber}<br>
                                        <strong>–ó–∞—è–≤–∫–∞ ‚Ññ:</strong> ${currentCargoNotification?.request_number || 'N/A'}<br>
                                        <strong>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</strong> ${item.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}<br>
                                        <strong>–í–µ—Å:</strong> ${item.weight ? item.weight + ' –∫–≥' : '–ù–µ —É–∫–∞–∑–∞–Ω'}<br>
                                        <strong>–¶–µ–Ω–∞:</strong> ${item.price ? item.price + ' ‚ÇΩ' : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}
                                      </div>
                                      <div class="qr-container">
                                        <canvas id="qrcode" width="200" height="200"></canvas>
                                      </div>
                                      <button class="print-btn" onclick="window.print()">–ü–µ—á–∞—Ç—å</button>
                                      <div id="error-message" style="color: red; margin-top: 20px;"></div>
                                      
                                      <script>
                                        function generateQR() {
                                          try {
                                            if (typeof QRious !== 'undefined') {
                                              console.log('QRious library loaded, generating QR code...');
                                              var qr = new QRious({
                                                element: document.getElementById('qrcode'),
                                                value: "${cargoNumber}",
                                                size: 200
                                              });
                                              console.log('QR Code generated successfully for:', "${cargoNumber}");
                                            } else {
                                              console.log('QRious not loaded yet, retrying...');
                                              setTimeout(generateQR, 200);
                                            }
                                          } catch (error) {
                                            console.error('Error generating QR code:', error);
                                            document.getElementById('error-message').innerHTML = 
                                              '<p>–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è QR –∫–æ–¥–∞: ' + error.message + '</p>' +
                                              '<p>–î–∞–Ω–Ω—ã–µ –¥–ª—è QR: <strong>${cargoNumber}</strong></p>';
                                          }
                                        }
                                        
                                        setTimeout(generateQR, 300);
                                        
                                        setTimeout(function() {
                                          var canvas = document.getElementById('qrcode');
                                          var ctx = canvas.getContext('2d');
                                          if (!ctx.getImageData(0, 0, 1, 1).data.some(channel => channel !== 0)) {
                                            document.getElementById('error-message').innerHTML = 
                                              '<p style="color: orange;">QR –∫–æ–¥ –Ω–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω. –ù–æ–º–µ—Ä –≥—Ä—É–∑–∞:</p>' +
                                              '<p style="font-size: 18px; font-weight: bold;">${cargoNumber}</p>';
                                          }
                                        }, 3000);
                                      </script>
                                    </body>
                                  </html>
                                `);
                                printWindow.document.close();
                                showAlert('QR –∫–æ–¥ –≥—Ä—É–∑–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ –ø–µ—á–∞—Ç—å', 'success');
                              }}
                              className="text-blue-600 border-blue-300 hover:bg-blue-50"
                            >
                              <QrCode className="mr-1 h-3 w-3" />
                              QR –∫–æ–¥
                            </Button>
                            
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={() => {
                                const requestNum = currentCargoNotification?.request_number?.replace(/\D/g, '') || '000000';
                                const cargoNumber = `${requestNum}/${String(index + 1).padStart(2, '0')}`;
                                
                                const printWindow = window.open('', '_blank');
                                if (!printWindow) {
                                  showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
                                  return;
                                }
                                printWindow.document.write(`
                                  <html>
                                    <head>
                                      <title>–≠—Ç–∏–∫–µ—Ç–∫–∞ - –ì—Ä—É–∑ ${cargoNumber}</title>
                                      <style>
                                        body { font-family: Arial, sans-serif; font-size: 12px; margin: 20px; }
                                        .label { border: 2px solid #333; padding: 15px; max-width: 400px; margin: 0 auto; }
                                        .label h2 { text-align: center; margin: 0 0 15px 0; font-size: 16px; }
                                        .label-section { margin: 10px 0; }
                                        .label-section strong { display: inline-block; width: 100px; }
                                        @media print { body { margin: 0; } }
                                      </style>
                                    </head>
                                    <body>
                                      <div class="label">
                                        <h2>TAJLINE.TJ</h2>
                                        <div class="label-section"><strong>–ì—Ä—É–∑:</strong> ${cargoNumber}</div>
                                        <div class="label-section"><strong>–ó–∞—è–≤–∫–∞:</strong> ${currentCargoNotification?.request_number || 'N/A'}</div>
                                        <div class="label-section"><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> ${item.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                                        <div class="label-section"><strong>–í–µ—Å:</strong> ${item.weight ? item.weight + ' –∫–≥' : '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                                        <div class="label-section"><strong>–¶–µ–Ω–∞:</strong> ${item.price ? item.price + ' ‚ÇΩ' : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</div>
                                        <div class="label-section"><strong>–î–∞—Ç–∞:</strong> ${new Date().toLocaleDateString('ru-RU')}</div>
                                      </div>
                                      <script>window.print();</script>
                                    </body>
                                  </html>
                                `);
                                printWindow.document.close();
                                showAlert('–≠—Ç–∏–∫–µ—Ç–∫–∞ –≥—Ä—É–∑–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–∞ –ø–µ—á–∞—Ç—å', 'success');
                              }}
                              className="text-purple-600 border-purple-300 hover:bg-purple-50"
                            >
                              <FileText className="mr-1 h-3 w-3" />
                              –≠—Ç–∏–∫–µ—Ç–∫–∞
                            </Button>
                          </div>
                        </div>
                      ))}
                      
                      {/* –ò—Ç–æ–≥–æ–≤—ã–µ —Ä–∞—Å—á–µ—Ç—ã –¥–ª—è –≤—Å–µ—Ö –≥—Ä—É–∑–æ–≤ */}
                      {cargoAcceptanceForm.cargo_items.length > 1 && (
                        <div className="bg-blue-50 border border-blue-200 p-3 rounded text-sm">
                          <h5 className="font-medium text-blue-800 mb-2">üìä –û–±—â–∏–µ —Ä–∞—Å—á–µ—Ç—ã</h5>
                          <div className="grid grid-cols-1 md:grid-cols-3 gap-2">
                            <p><strong>–í—Å–µ–≥–æ –≥—Ä—É–∑–æ–≤:</strong> {cargoAcceptanceForm.cargo_items.length} —à—Ç.</p>
                            <p><strong>–û–±—â–∏–π –≤–µ—Å:</strong> {cargoAcceptanceForm.cargo_items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0).toFixed(1)} –∫–≥</p>
                            <p><strong>–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {cargoAcceptanceForm.cargo_items.reduce((sum, item) => sum + ((parseFloat(item.weight) || 0) * (parseFloat(item.price) || 0)), 0).toFixed(2)} ‚ÇΩ</p>
                          </div>
                          
                          {/* –†–∞—Å—á–µ—Ç —Å—Ä–µ–¥–Ω–µ–π —Ü–µ–Ω—ã –∑–∞ –∫–≥ */}
                          {(() => {
                            const totalWeight = cargoAcceptanceForm.cargo_items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0);
                            const totalPrice = cargoAcceptanceForm.cargo_items.reduce((sum, item) => sum + ((parseFloat(item.weight) || 0) * (parseFloat(item.price) || 0)), 0);
                            const avgPricePerKg = totalWeight > 0 ? (totalPrice / totalWeight).toFixed(2) : 0;
                            
                            return totalWeight > 0 && totalPrice > 0 ? (
                              <div className="mt-2 pt-2 border-t border-blue-300">
                                <p className="text-blue-700"><strong>–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞ –∑–∞ –∫–≥:</strong> {avgPricePerKg} ‚ÇΩ/–∫–≥</p>
                              </div>
                            ) : null;
                          })()}
                        </div>
                      )}
                    </div>
                  ) : (
                    <div className="bg-white p-2 rounded border text-sm">
                      <div className="grid grid-cols-1 md:grid-cols-2 gap-2">
                        <p><strong>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</strong> {currentCargoNotification.cargo_info?.destination || currentCargoNotification.destination || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                        <p><strong>–í–µ—Å:</strong> {currentCargoNotification.cargo_info?.weight ? `${currentCargoNotification.cargo_info.weight} –∫–≥` : '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                        <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {currentCargoNotification.cargo_info?.total_value ? `${currentCargoNotification.cargo_info.total_value} ‚ÇΩ` : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                        <p><strong>–û–±—ä—è–≤–ª–µ–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {currentCargoNotification.cargo_info?.declared_value ? `${currentCargoNotification.cargo_info.declared_value} ‚ÇΩ` : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'}</p>
                      </div>
                      <p className="text-sm text-gray-600 mt-2">–î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ –±—É–¥–µ—Ç –∑–∞–ø–æ–ª–Ω–µ–Ω–∞ –Ω–∏–∂–µ</p>
                    </div>
                  )}
                  
                  {/* –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –≥—Ä—É–∑–æ–≤ */}
                  {process.env.NODE_ENV === 'development' && (
                    <div className="mt-2 p-2 bg-gray-100 rounded text-xs">
                      <p>DEBUG - cargo_info: {JSON.stringify(currentCargoNotification?.cargo_info)}</p>
                      <p>DEBUG - cargo_items: {JSON.stringify(cargoAcceptanceForm.cargo_items)}</p>
                    </div>
                  )}
                </div>
              </div>

              {/* –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è */}
              <div className="border rounded-lg p-4">
                <h3 className="font-medium text-lg mb-3 flex items-center">
                  <User className="mr-2 h-5 w-5 text-blue-600" />
                  –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å
                </h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div>
                    <Label htmlFor="sender_full_name">–§–ò–û –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è *</Label>
                    <Input
                      id="sender_full_name"
                      value={cargoAcceptanceForm.sender_full_name}
                      onChange={(e) => setCargoAcceptanceForm({...cargoAcceptanceForm, sender_full_name: e.target.value})}
                      placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á –ü–µ—Ç—Ä–æ–≤"
                      required
                    />
                  </div>
                  <div>
                    <Label htmlFor="sender_phone">–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è *</Label>
                    <Input
                      id="sender_phone"
                      value={cargoAcceptanceForm.sender_phone}
                      onChange={(e) => setCargoAcceptanceForm({...cargoAcceptanceForm, sender_phone: e.target.value})}
                      placeholder="+7 900 123-45-67"
                      required
                    />
                  </div>
                  <div>
                    <Label htmlFor="sender_address">–ê–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è *</Label>
                    <Input
                      id="sender_address"
                      value={cargoAcceptanceForm.sender_address}
                      onChange={(e) => setCargoAcceptanceForm({...cargoAcceptanceForm, sender_address: e.target.value})}
                      placeholder="–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –¢–≤–µ—Ä—Å–∫–∞—è, –¥. 1"
                      required
                    />
                  </div>
                </div>
              </div>

              {/* –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è */}
              <div className="border rounded-lg p-4">
                <h3 className="font-medium text-lg mb-3 flex items-center">
                  <MapPin className="mr-2 h-5 w-5 text-green-600" />
                  –ü–æ–ª—É—á–∞—Ç–µ–ª—å
                </h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div>
                    <Label htmlFor="recipient_full_name">–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</Label>
                    <Input
                      id="recipient_full_name"
                      value={cargoAcceptanceForm.recipient_full_name}
                      onChange={(e) => setCargoAcceptanceForm({...cargoAcceptanceForm, recipient_full_name: e.target.value})}
                      placeholder="–ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á –ò–≤–∞–Ω–æ–≤"
                      required
                    />
                  </div>
                  <div>
                    <Label htmlFor="recipient_phone">–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</Label>
                    <Input
                      id="recipient_phone"
                      value={cargoAcceptanceForm.recipient_phone}
                      onChange={(e) => setCargoAcceptanceForm({...cargoAcceptanceForm, recipient_phone: e.target.value})}
                      placeholder="+992 900 123456"
                      required
                    />
                  </div>
                  <div>
                    <Label htmlFor="recipient_address">–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</Label>
                    <Input
                      id="recipient_address"
                      value={cargoAcceptanceForm.recipient_address}
                      onChange={(e) => setCargoAcceptanceForm({...cargoAcceptanceForm, recipient_address: e.target.value})}
                      placeholder="–≥. –î—É—à–∞–Ω–±–µ, —É–ª. –†—É–¥–∞–∫–∏, –¥. 10"
                      required
                    />
                  </div>
                </div>
              </div>

              {/* –°–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤ */}
              <div className="border rounded-lg p-4">
                <div className="flex items-center justify-between mb-4">
                  <h3 className="font-medium text-lg flex items-center">
                    <Package2 className="mr-2 h-5 w-5 text-purple-600" />
                    –°–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤
                  </h3>
                  <Button
                    type="button"
                    variant="outline"
                    onClick={() => {
                      setCargoAcceptanceForm({
                        ...cargoAcceptanceForm,
                        cargo_items: [...cargoAcceptanceForm.cargo_items, { name: '', weight: '', price: '' }]
                      });
                    }}
                  >
                    <Plus className="mr-2 h-4 w-4" />
                    –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–∑
                  </Button>
                </div>
                
                <div className="space-y-3">
                  {cargoAcceptanceForm.cargo_items.map((item, index) => (
                    <div key={index} className="p-4 bg-gray-50 rounded-lg border border-gray-200">
                      <div className="grid grid-cols-12 gap-3 mb-3">
                        <div className="col-span-5">
                          <Label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ *</Label>
                          <Input
                            value={item.name}
                            onChange={(e) => {
                              const newItems = [...cargoAcceptanceForm.cargo_items];
                              newItems[index].name = e.target.value;
                              setCargoAcceptanceForm({...cargoAcceptanceForm, cargo_items: newItems});
                            }}
                            placeholder="–î–æ–∫—É–º–µ–Ω—Ç—ã, –æ–¥–µ–∂–¥–∞..."
                            required
                          />
                        </div>
                        <div className="col-span-3">
                          <Label>–í–µ—Å (–∫–≥) *</Label>
                          <Input
                            type="number"
                            step="0.1"
                            value={item.weight}
                            onChange={(e) => {
                              const newItems = [...cargoAcceptanceForm.cargo_items];
                              newItems[index].weight = e.target.value;
                              setCargoAcceptanceForm({...cargoAcceptanceForm, cargo_items: newItems});
                            }}
                            placeholder="1.5"
                            required
                          />
                        </div>
                        <div className="col-span-3">
                          <Label>–¶–µ–Ω–∞ (‚ÇΩ) *</Label>
                          <Input
                            type="number"
                            step="0.01"
                            value={item.price}
                            onChange={(e) => {
                              const newItems = [...cargoAcceptanceForm.cargo_items];
                              newItems[index].price = e.target.value;
                              setCargoAcceptanceForm({...cargoAcceptanceForm, cargo_items: newItems});
                            }}
                            placeholder="1000"
                            required
                          />
                        </div>
                        <div className="col-span-1 flex items-end">
                          {cargoAcceptanceForm.cargo_items.length > 1 && (
                            <Button
                              type="button"
                              variant="outline"
                              size="sm"
                              onClick={() => {
                                const newItems = cargoAcceptanceForm.cargo_items.filter((_, i) => i !== index);
                                setCargoAcceptanceForm({...cargoAcceptanceForm, cargo_items: newItems});
                              }}
                              className="text-red-600 hover:text-red-700"
                            >
                              <Minus className="h-4 w-4" />
                            </Button>
                          )}
                        </div>
                      </div>
                      
                      {/* –î–µ–π—Å—Ç–≤–∏—è –∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –≥—Ä—É–∑–∞ */}
                      <div className="flex items-center justify-between pt-3 border-t border-gray-300">
                        <div className="text-sm">
                          <div className="flex items-center space-x-4">
                            <span className="font-medium text-gray-800">–ì—Ä—É–∑ #{index + 1}:</span>
                            <span className="text-gray-600">{item.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</span>
                            {item.weight && item.price && (
                              <span className="text-green-600 font-medium">
                                {item.weight} –∫–≥ √ó {item.price} ‚ÇΩ = {(parseFloat(item.weight) * parseFloat(item.price)).toFixed(2)} ‚ÇΩ
                              </span>
                            )}
                          </div>
                          {(!item.weight || !item.price) && (
                            <div className="text-xs text-orange-600 mt-1">
                              ‚ö†Ô∏è –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤–µ—Å –∏ —Ü–µ–Ω—É –¥–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞
                            </div>
                          )}
                        </div>
                        <div className="flex space-x-2">
                          <Button
                            type="button"
                            variant="outline"
                            size="sm"
                            onClick={() => {
                              // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –¥–ª—è –≥—Ä—É–∑–∞ –¥–ª—è QR –∫–æ–¥–∞
                              const cargoId = `${currentCargoNotification?.request_number || 'TEMP'}-${index + 1}`;
                              const qrData = JSON.stringify({
                                cargo_id: cargoId,
                                name: item.name,
                                weight: item.weight,
                                price: item.price,
                                sender: cargoAcceptanceForm.sender_full_name,
                                recipient: cargoAcceptanceForm.recipient_full_name,
                                request_number: currentCargoNotification?.request_number,
                                created_at: new Date().toISOString()
                              });
                              
                              // –°–æ–∑–¥–∞–µ–º QR –∫–æ–¥ –∏ –æ—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏
                              const printWindow = window.open('', '_blank');
                              if (!printWindow) {
                                showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
                                return;
                              }
                              printWindow.document.write(`
                                <html>
                                  <head>
                                    <title>QR –∫–æ–¥ - –ì—Ä—É–∑ ${cargoId}</title>
                                    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
                                    <style>
                                      body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
                                      .qr-container { margin: 20px auto; }
                                      .cargo-info { margin: 10px 0; font-size: 14px; }
                                      @media print { body { margin: 0; } }
                                    </style>
                                  </head>
                                  <body>
                                    <h2>QR –∫–æ–¥ –≥—Ä—É–∑–∞</h2>
                                    <div class="cargo-info">
                                      <strong>–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏:</strong> ${currentCargoNotification?.request_number || 'N/A'}<br>
                                      <strong>–ì—Ä—É–∑:</strong> ${item.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}<br>
                                      <strong>–í–µ—Å:</strong> ${item.weight || '0'} –∫–≥<br>
                                      <strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> ${item.price || '0'} ‚ÇΩ<br>
                                      <strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> ${cargoAcceptanceForm.sender_full_name}<br>
                                      <strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> ${cargoAcceptanceForm.recipient_full_name}
                                    </div>
                                    <div class="qr-container">
                                      <canvas id="qrcode"></canvas>
                                    </div>
                                    <script>
                                      QRCode.toCanvas(document.getElementById('qrcode'), '${qrData}', {
                                        width: 200,
                                        margin: 2
                                      }, function(error) {
                                        if (error) console.error(error);
                                        else window.print();
                                      });
                                    </script>
                                  </body>
                                </html>
                              `);
                              printWindow.document.close();
                            }}
                            className="text-blue-600 hover:text-blue-700"
                          >
                            <QrCode className="mr-1 h-4 w-4" />
                            QR –∫–æ–¥
                          </Button>
                          <Button
                            type="button"
                            variant="outline"
                            size="sm"
                            onClick={() => {
                              const cargoId = `${currentCargoNotification?.request_number || 'TEMP'}-${index + 1}`;
                              const printWindow = window.open('', '_blank');
                              if (!printWindow) {
                                showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
                                return;
                              }
                              printWindow.document.write(`
                                <html>
                                  <head>
                                    <title>–≠—Ç–∏–∫–µ—Ç–∫–∞ - –ì—Ä—É–∑ ${cargoId}</title>
                                    <style>
                                      body { font-family: Arial, sans-serif; padding: 20px; }
                                      .label { border: 2px solid #000; padding: 15px; width: 300px; margin: 0 auto; }
                                      .header { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 10px; }
                                      .info { margin: 5px 0; font-size: 12px; }
                                      @media print { body { margin: 0; } }
                                    </style>
                                  </head>
                                  <body>
                                    <div class="label">
                                      <div class="header">TAJLINE.TJ</div>
                                      <div class="info"><strong>–ó–∞—è–≤–∫–∞:</strong> ${currentCargoNotification?.request_number || 'N/A'}</div>
                                      <div class="info"><strong>–ì—Ä—É–∑:</strong> ${item.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</div>
                                      <div class="info"><strong>–í–µ—Å:</strong> ${item.weight || '0'} –∫–≥</div>
                                      <div class="info"><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> ${item.price || '0'} ‚ÇΩ</div>
                                      <div class="info"><strong>–û—Ç:</strong> ${cargoAcceptanceForm.sender_full_name}</div>
                                      <div class="info"><strong>–ö–æ–º—É:</strong> ${cargoAcceptanceForm.recipient_full_name}</div>
                                      <div class="info"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> ${cargoAcceptanceForm.recipient_phone}</div>
                                      <div class="info"><strong>–î–∞—Ç–∞:</strong> ${new Date().toLocaleDateString('ru-RU')}</div>
                                    </div>
                                    <script>window.print();</script>
                                  </body>
                                </html>
                              `);
                              printWindow.document.close();
                            }}
                            className="text-green-600 hover:text-green-700"
                          >
                            <Printer className="mr-1 h-4 w-4" />
                            –≠—Ç–∏–∫–µ—Ç–∫–∞
                          </Button>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>

                {/* –ò—Ç–æ–≥–∏ */}
                <div className="mt-4 p-3 bg-blue-50 rounded">
                  <div className="grid grid-cols-3 gap-4 text-center">
                    <div>
                      <div className="text-lg font-bold text-blue-600">
                        {cargoAcceptanceForm.cargo_items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0).toFixed(1)} –∫–≥
                      </div>
                      <div className="text-sm text-gray-600">–û–±—â–∏–π –≤–µ—Å</div>
                    </div>
                    <div>
                      <div className="text-lg font-bold text-green-600">
                        {cargoAcceptanceForm.cargo_items.reduce((sum, item) => sum + ((parseFloat(item.weight) || 0) * (parseFloat(item.price) || 0)), 0).toFixed(2)} ‚ÇΩ
                      </div>
                      <div className="text-sm text-gray-600">–û–±—â–∞—è —Å—É–º–º–∞</div>
                    </div>
                    <div>
                      <div className="text-lg font-bold text-purple-600">
                        {cargoAcceptanceForm.cargo_items.length}
                      </div>
                      <div className="text-sm text-gray-600">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–∑–æ–≤</div>
                    </div>
                  </div>
                </div>
              </div>

              {/* –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã –∏ –ø–æ–ª—É—á–µ–Ω–∏—è */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                  <Label htmlFor="payment_method">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –¥–ª—è –≥—Ä—É–∑–∞ *</Label>
                  <Select 
                    value={cargoAcceptanceForm.payment_method} 
                    onValueChange={(value) => setCargoAcceptanceForm({...cargoAcceptanceForm, payment_method: value})}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</SelectItem>
                      <SelectItem value="card">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</SelectItem>
                      <SelectItem value="transfer">–ü–µ—Ä–µ–≤–æ–¥</SelectItem>
                      <SelectItem value="prepaid">–ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div>
                  <Label htmlFor="delivery_method">–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä—É–∑–∞ *</Label>
                  <Select 
                    value={cargoAcceptanceForm.delivery_method} 
                    onValueChange={(value) => setCargoAcceptanceForm({...cargoAcceptanceForm, delivery_method: value})}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="pickup">–°–∞–º–æ–≤—ã–≤–æ–∑</SelectItem>
                      <SelectItem value="delivery">–î–æ—Å—Ç–∞–≤–∫–∞ –∫—É—Ä—å–µ—Ä–æ–º</SelectItem>
                      <SelectItem value="shipping">–û—Ç–ø—Ä–∞–≤–∫–∞ –ø–æ—á—Ç–æ–π</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
              </div>

              {/* –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã –∏ –ø—Ä–∏–Ω—è—Ç–∏–µ –æ–ø–ª–∞—Ç—ã */}
              <div className="border rounded-lg p-4 bg-green-50">
                <h3 className="font-medium text-lg mb-3 flex items-center">
                  <CreditCard className="mr-2 h-5 w-5 text-green-600" />
                  –ü—Ä–∏–Ω—è—Ç–∏–µ –æ–ø–ª–∞—Ç—ã
                </h3>
                
                {/* –û–±—â–∞—è —Å—É–º–º–∞ –∏–∑ –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–∞ */}
                <div className="bg-blue-100 border border-blue-300 rounded p-3 mb-4">
                  <div className="flex items-center justify-between">
                    <span className="text-blue-800 font-medium">üìä –û–±—â–∞—è —Å—É–º–º–∞ –∫ –ø–æ–ª—É—á–µ–Ω–∏—é:</span>
                    <span className="text-blue-900 font-bold text-lg">
                      {cargoAcceptanceForm.cargo_items.reduce((sum, item) => sum + ((parseFloat(item.weight) || 0) * (parseFloat(item.price) || 0)), 0).toFixed(2)} ‚ÇΩ
                    </span>
                  </div>
                  <div className="text-blue-700 text-sm mt-1">
                    –†–∞—Å—á–µ—Ç: {cargoAcceptanceForm.cargo_items.map((item, idx) => 
                      `${item.weight || 0} –∫–≥ √ó ${item.price || 0} ‚ÇΩ`
                    ).join(' + ')}
                  </div>
                </div>
                
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                  {/* –°–ø–∏—Å–æ–∫ —Å–∫–ª–∞–¥–æ–≤ */}
                  <div>
                    <Label htmlFor="warehouse_id">–°–∫–ª–∞–¥ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è *</Label>
                    <div className="text-xs text-blue-600 mb-2">
                      üìç –ì—Ä—É–∑ –ø—Ä–∏–Ω–∏–º–∞–µ—Ç—Å—è –Ω–∞ {operatorWarehouses[0]?.name || '—Ç–µ–∫—É—â–∏–π —Å–∫–ª–∞–¥'} –∏ –±—É–¥–µ—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –≤ –≤—ã–±—Ä–∞–Ω–Ω—ã–π —Å–∫–ª–∞–¥
                    </div>
                    <Select 
                      value={cargoAcceptanceForm.warehouse_id || ''} 
                      onValueChange={(value) => setCargoAcceptanceForm({...cargoAcceptanceForm, warehouse_id: value})}
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥" />
                      </SelectTrigger>
                      <SelectContent>
                        {warehouses
                          .filter(warehouse => {
                            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∞–∫—Ç–∏–≤–Ω—ã–µ —Å–∫–ª–∞–¥—ã, –∏—Å–∫–ª—é—á–∞—è —Å–∫–ª–∞–¥ —Ç–µ–∫—É—â–µ–≥–æ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
                            const operatorWarehouseIds = operatorWarehouses.map(w => w.id);
                            return warehouse.is_active && !operatorWarehouseIds.includes(warehouse.id);
                          })
                          .map(warehouse => (
                            <SelectItem key={warehouse.id} value={warehouse.id}>
                              {warehouse.name} ({warehouse.location})
                            </SelectItem>
                          ))
                        }
                      </SelectContent>
                    </Select>
                  </div>
                  
                  {/* –°—Ç–∞—Ç—É—Å—ã –æ–ø–ª–∞—Ç—ã */}
                  <div>
                    <Label htmlFor="payment_status">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã *</Label>
                    <Select 
                      value={cargoAcceptanceForm.payment_status} 
                      onValueChange={(value) => setCargoAcceptanceForm({...cargoAcceptanceForm, payment_status: value})}
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="not_paid">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</SelectItem>
                        <SelectItem value="partially_paid">–ß–∞—Å—Ç–∏—á–Ω–æ –æ–ø–ª–∞—á–µ–Ω–æ</SelectItem>
                        <SelectItem value="paid">–ü–æ–ª–Ω–æ—Å—Ç—å—é –æ–ø–ª–∞—á–µ–Ω–æ</SelectItem>
                        <SelectItem value="prepaid">–ü—Ä–µ–¥–æ–ø–ª–∞—á–µ–Ω–æ</SelectItem>
                        <SelectItem value="debt">–í –¥–æ–ª–≥</SelectItem>
                        <SelectItem value="payment_on_delivery">–û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  
                  {/* –°–ø–æ—Å–æ–±—ã –æ–ø–ª–∞—Ç—ã */}
                  <div>
                    <Label htmlFor="payment_method">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã *</Label>
                    <Select 
                      value={cargoAcceptanceForm.payment_method} 
                      onValueChange={(value) => setCargoAcceptanceForm({...cargoAcceptanceForm, payment_method: value})}
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="cash">–ù–∞–ª–∏—á–Ω—ã–µ</SelectItem>
                        <SelectItem value="card">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</SelectItem>
                        <SelectItem value="transfer">–ë–∞–Ω–∫–æ–≤—Å–∫–∏–π –ø–µ—Ä–µ–≤–æ–¥</SelectItem>
                        <SelectItem value="debt">–í –¥–æ–ª–≥</SelectItem>
                        <SelectItem value="prepaid">–ü—Ä–µ–¥–æ–ø–ª–∞—á–µ–Ω–æ</SelectItem>
                        <SelectItem value="online_payment">–û–Ω–ª–∞–π–Ω –æ–ø–ª–∞—Ç–∞</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  
                  {/* –§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–µ–Ω–æ */}
                  <div>
                    <Label htmlFor="amount_paid">–§–∞–∫—Ç–∏—á–µ—Å–∫–∏ –ø–æ–ª—É—á–µ–Ω–æ (‚ÇΩ)</Label>
                    <Input
                      id="amount_paid"
                      type="number"
                      step="0.01"
                      placeholder="0.00"
                      value={cargoAcceptanceForm.amount_paid}
                      onChange={(e) => {
                        const amountPaid = parseFloat(e.target.value) || 0;
                        const totalAmount = cargoAcceptanceForm.cargo_items.reduce((sum, item) => sum + ((parseFloat(item.weight) || 0) * (parseFloat(item.price) || 0)), 0);
                        let newStatus = 'not_paid';
                        
                        if (amountPaid >= totalAmount) {
                          newStatus = 'paid';
                        } else if (amountPaid > 0) {
                          newStatus = 'partially_paid';
                        }
                        
                        setCargoAcceptanceForm({
                          ...cargoAcceptanceForm, 
                          amount_paid: e.target.value,
                          payment_status: newStatus
                        });
                      }}
                    />
                  </div>
                </div>
                
                {/* –ó–∞–º–µ—Ç–∫–∏ –ø–æ –æ–ø–ª–∞—Ç–µ */}
                <div className="mb-4">
                  <Label htmlFor="payment_notes">–ó–∞–º–µ—Ç–∫–∏ –ø–æ –æ–ø–ª–∞—Ç–µ</Label>
                  <Textarea
                    id="payment_notes"
                    placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∑–∞–º–µ—Ç–∫–∏ –ø–æ –æ–ø–ª–∞—Ç–µ..."
                    value={cargoAcceptanceForm.payment_notes}
                    onChange={(e) => setCargoAcceptanceForm({...cargoAcceptanceForm, payment_notes: e.target.value})}
                    rows={2}
                  />
                </div>
                
                {cargoAcceptanceForm.payment_status === 'paid' && (
                  <div className="bg-green-100 border border-green-300 rounded p-3 mb-4">
                    <div className="flex items-center">
                      <CheckCircle className="mr-2 h-5 w-5 text-green-600" />
                      <span className="text-green-800 font-medium">–û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é</span>
                    </div>
                  </div>
                )}
                
                {cargoAcceptanceForm.payment_status === 'partially_paid' && (
                  <div className="bg-yellow-100 border border-yellow-300 rounded p-3 mb-4">
                    <div className="flex items-center">
                      <Clock className="mr-2 h-5 w-5 text-yellow-600" />
                      <span className="text-yellow-800 font-medium">–ß–∞—Å—Ç–∏—á–Ω–∞—è –æ–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞</span>
                    </div>
                  </div>
                )}
                
                <div>
                  <Label htmlFor="payment_notes">–ü—Ä–∏–º–µ—á–∞–Ω–∏—è –ø–æ –æ–ø–ª–∞—Ç–µ</Label>
                  <Textarea
                    id="payment_notes"
                    placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –æ–ø–ª–∞—Ç–µ, —É—Å–ª–æ–≤–∏—è –¥–æ–ø–ª–∞—Ç—ã –∏ —Ç.–¥."
                    onChange={(e) => setCargoAcceptanceForm({...cargoAcceptanceForm, payment_notes: e.target.value})}
                  />
                </div>
              </div>

              {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
              <div className="flex justify-between items-center pt-4 border-t">
                <Button 
                  type="button" 
                  variant="outline" 
                  onClick={() => {
                    setShowCargoAcceptanceModal(false);
                    setCurrentCargoNotification(null);
                    setCargoAcceptanceForm({
                      sender_full_name: '',
                      sender_phone: '',
                      sender_address: '',
                      recipient_full_name: '',
                      recipient_phone: '',
                      recipient_address: '',
                      cargo_items: [{ name: '', weight: '', price: '' }],
                      payment_method: '',
                      delivery_method: '',
                      payment_status: 'not_paid',
                      amount_paid: '',
                      payment_notes: ''
                    });
                  }}
                >
                  –û—Ç–º–µ–Ω–∞
                </Button>
                <div className="space-x-3">
                  {(currentCargoNotification?.isViewMode || currentCargoNotification?.isCargoMode) ? (
                    // –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ (—É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏–ª–∏ –≥—Ä—É–∑–∞)
                    <Button 
                      className="bg-green-600 hover:bg-green-700"
                      onClick={async () => {
                        try {
                          if (currentCargoNotification?.isCargoMode) {
                            // –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä—É–∑–∞ - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å API –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –≥—Ä—É–∑–∞
                            showAlert('–ò–∑–º–µ–Ω–µ–Ω–∏—è –≥—Ä—É–∑–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!', 'success');
                            setShowCargoAcceptanceModal(false);
                            setCurrentCargoNotification(null);
                            
                            // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤
                            fetchOperatorCargo();
                            
                          } else {
                            // –†–µ–∂–∏–º –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
                            const updateData = {
                              sender_full_name: cargoAcceptanceForm.sender_full_name,
                              sender_phone: cargoAcceptanceForm.sender_phone,
                              pickup_address: cargoAcceptanceForm.sender_address,
                              destination: cargoAcceptanceForm.cargo_items[0]?.name || '',
                              courier_fee: currentCargoNotification.courier_fee,
                              payment_method: cargoAcceptanceForm.payment_method
                            };
                            
                            await apiCall(`/api/operator/warehouse-notifications/${currentCargoNotification.id}`, 'PUT', updateData);
                            
                            showAlert('–ò–∑–º–µ–Ω–µ–Ω–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã —É—Å–ø–µ—à–Ω–æ!', 'success');
                            setShowCargoAcceptanceModal(false);
                            setCurrentCargoNotification(null);
                            
                            // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
                            fetchWarehouseNotifications();
                          }
                          
                        } catch (error) {
                          console.error('Error updating:', error);
                          showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏: ' + error.message, 'error');
                        }
                      }}
                    >
                      <Save className="mr-2 h-4 w-4" />
                      –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                    </Button>
                  ) : (
                    // –ö–Ω–æ–ø–∫–∏ –¥–ª—è —Ä–µ–∂–∏–º–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –≥—Ä—É–∑–∞
                    <>
                      <Button 
                        type="button"
                        variant="outline"
                        onClick={() => {
                          // TODO: –ü–µ—á–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω–æ–π
                          showAlert('–§—É–Ω–∫—Ü–∏—è –ø–µ—á–∞—Ç–∏ –Ω–∞–∫–ª–∞–¥–Ω–æ–π –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞', 'info');
                        }}
                      >
                        <Printer className="mr-2 h-4 w-4" />
                        –ü–µ—á–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω–æ–π
                      </Button>
                      <Button type="submit" className="bg-green-600 hover:bg-green-700">
                        <CheckCircle className="mr-2 h-4 w-4" />
                        –û—Ñ–æ—Ä–º–∏—Ç—å –∏ —Å–æ–∑–¥–∞—Ç—å –≥—Ä—É–∑—ã
                      </Button>
                    </>
                  )}
                </div>
              </div>
            </form>
          )}
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—Ö–µ–º—ã —Å–∫–ª–∞–¥–∞ */}
      <Dialog open={layoutModal} onOpenChange={setLayoutModal}>
        <DialogContent className="max-w-4xl">
          <DialogHeader>
            <DialogTitle>
              –°—Ö–µ–º–∞ —Å–∫–ª–∞–¥–∞: {selectedWarehouseForLayout?.name}
            </DialogTitle>
            <DialogDescription>
              –ö–∞—Ä—Ç–∞ —Ä–∞—Å–ø–æ–ª–æ–∂–µ–Ω–∏—è –±–ª–æ–∫–æ–≤, –ø–æ–ª–æ–∫ –∏ —è—á–µ–µ–∫ —Å–∫–ª–∞–¥–∞
            </DialogDescription>
          </DialogHeader>
          
          {warehouseLayout ? (
            <div className="space-y-4">
              {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–∫–ª–∞–¥–∞ */}
              <div className="grid grid-cols-4 gap-4">
                <div className="text-center p-4 bg-blue-50 rounded">
                  <div className="text-2xl font-bold text-blue-600">{warehouseLayout.total_cells}</div>
                  <div className="text-sm">–í—Å–µ–≥–æ —è—á–µ–µ–∫</div>
                </div>
                <div className="text-center p-4 bg-red-50 rounded">
                  <div className="text-2xl font-bold text-red-600">{warehouseLayout.occupied_cells}</div>
                  <div className="text-sm">–ó–∞–Ω—è—Ç–æ</div>
                </div>
                <div className="text-center p-4 bg-green-50 rounded">
                  <div className="text-2xl font-bold text-green-600">{warehouseLayout.total_cells - warehouseLayout.occupied_cells}</div>
                  <div className="text-sm">–°–≤–æ–±–æ–¥–Ω–æ</div>
                </div>
                <div className="text-center p-4 bg-gray-50 rounded">
                  <div className="text-2xl font-bold text-gray-600">{warehouseLayout.occupancy_percentage}%</div>
                  <div className="text-sm">–ó–∞–ø–æ–ª–Ω–µ–Ω–Ω–æ—Å—Ç—å</div>
                </div>
              </div>

              {/* –°—Ö–µ–º–∞ —Å–∫–ª–∞–¥–∞ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≥—Ä—É–∑–∞—Ö */}
              <div className="max-h-96 overflow-auto border rounded-lg p-4">
                <div className="space-y-6">
                  {warehouseLayout.layout && Object.entries(warehouseLayout.layout).map(([blockKey, block]) => (
                    <div key={blockKey} className="border rounded-lg p-4">
                      <h3 className="font-bold mb-3 text-center bg-gray-100 p-2 rounded">
                        –ë–ª–æ–∫ {block.block_number}
                      </h3>
                      <div className="space-y-4">
                        {block.shelves && Object.entries(block.shelves).map(([shelfKey, shelf]) => (
                          <div key={shelfKey}>
                            <h4 className="font-semibold mb-2 text-sm bg-gray-50 p-1 rounded">
                              –ü–æ–ª–∫–∞ {shelf.shelf_number}
                            </h4>
                            <div className="grid grid-cols-5 gap-2">
                              {shelf.cells && Object.entries(shelf.cells).slice(0, 10).map(([cellKey, cell]) => (
                                <div
                                  key={cellKey}
                                  className={`p-2 text-xs text-center rounded border-2 transition-all cursor-pointer hover:scale-105 ${
                                    cell.is_occupied 
                                      ? 'bg-red-100 border-red-300 text-red-800 hover:bg-red-200' 
                                      : 'bg-green-100 border-green-300 text-green-800 hover:bg-green-200'
                                  }`}
                                  title={cell.cargo && cell.cargo.length > 0 ? 
                                    `${cell.cargo_count} –≥—Ä—É–∑–æ–≤ –≤ —è—á–µ–π–∫–µ: ${cell.cargo.map(c => c.cargo_number).join(', ')}` : 
                                    '–°–≤–æ–±–æ–¥–Ω–∞—è —è—á–µ–π–∫–∞'
                                  }
                                  onClick={(e) => {
                                    e.preventDefault();
                                    e.stopPropagation();
                                    if (cell.is_occupied && cell.cargo && cell.cargo.length > 0) {
                                      setSelectedCargoForWarehouse(cell.cargo);
                                      setCargoDetailsModal(true);
                                    } else {
                                      showAlert('–Ø—á–µ–π–∫–∞ —Å–≤–æ–±–æ–¥–Ω–∞', 'info');
                                    }
                                  }}
                                >
                                  <div className="font-bold">–Ø{cell.cell_number}</div>
                                  {cell.cargo && (
                                    <div className="mt-1">
                                      <div className="font-semibold text-[9px]">{cell.cargo.cargo_number}</div>
                                      <div className="text-[8px]">{cell.cargo.weight}–∫–≥</div>
                                    </div>
                                  )}
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="flex items-center justify-center space-x-4 text-sm">
                <div className="flex items-center">
                  <div className="w-4 h-4 bg-green-100 border-2 border-green-300 rounded mr-2"></div>
                  <span>–°–≤–æ–±–æ–¥–Ω–∞—è —è—á–µ–π–∫–∞</span>
                </div>
                <div className="flex items-center">
                  <div className="w-4 h-4 bg-red-100 border-2 border-red-300 rounded mr-2"></div>
                  <span>–ó–∞–Ω—è—Ç–∞—è —è—á–µ–π–∫–∞</span>
                </div>
              </div>
            </div>
          ) : (
            <div className="text-center py-8">
              <Package className="mx-auto h-12 w-12 text-gray-400 mb-4" />
              <p className="text-gray-500 mb-4">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ö–µ–º—ã —Å–∫–ª–∞–¥–∞...</p>
              <p className="text-sm text-gray-400">
                –ï—Å–ª–∏ —Å—Ö–µ–º–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∏–ª–∏ –æ–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É.
              </p>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º */}
      <Dialog open={transportManagementModal} onOpenChange={setTransportManagementModal}>
        <DialogContent className="max-w-6xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º {selectedTransport?.transport_number}
            </DialogTitle>
            <DialogDescription>
              –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º
            </DialogDescription>
          </DialogHeader>
          
          {selectedTransport && (
            <div className="space-y-6">
              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ */}
              <div className="bg-gray-50 p-4 rounded-lg">
                <h3 className="font-semibold mb-2">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ</h3>
                <div className="grid grid-cols-3 gap-4 text-sm">
                  <p><strong>–ù–æ–º–µ—Ä:</strong> {selectedTransport.transport_number}</p>
                  <p><strong>–í–æ–¥–∏—Ç–µ–ª—å:</strong> {selectedTransport.driver_name}</p>
                  <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {selectedTransport.driver_phone}</p>
                  <p><strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> {selectedTransport.direction}</p>
                  <p><strong>–í–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:</strong> {selectedTransport.capacity_kg} –∫–≥</p>
                  <p><strong>–¢–µ–∫—É—â–∞—è –∑–∞–≥—Ä—É–∑–∫–∞:</strong> {selectedTransport.current_load_kg} –∫–≥</p>
                  <p><strong>–ü—Ä–æ—Ü–µ–Ω—Ç –∑–∞–≥—Ä—É–∑–∫–∏:</strong> {Math.round((selectedTransport.current_load_kg / selectedTransport.capacity_kg) * 100)}%</p>
                  <p><strong>–°—Ç–∞—Ç—É—Å:</strong> 
                    <Badge className="ml-2" variant={selectedTransport.status === 'empty' ? 'secondary' : 'default'}>
                      {selectedTransport.status === 'empty' ? '–ü—É—Å—Ç–æ–π' : selectedTransport.status === 'filled' ? '–ó–∞–ø–æ–ª–Ω–µ–Ω–æ' : selectedTransport.status}
                    </Badge>
                  </p>
                  <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–∑–æ–≤:</strong> {transportCargoList.cargo_count || 0} –º–µ—Å—Ç</p>
                </div>
              </div>

              {/* –°–ø–∏—Å–æ–∫ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤ */}
              <Card className="p-4">
                <div className="flex justify-between items-center mb-4">
                  <h4 className="font-semibold">–ì—Ä—É–∑—ã –Ω–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ ({transportCargoList.cargo_count || 0} –º–µ—Å—Ç)</h4>
                  <div className="flex space-x-2">
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => {
                        if (transportCargoList.cargo_list && transportCargoList.cargo_list.length > 0) {
                          printTransportCargoList(selectedTransport, transportCargoList.cargo_list);
                        }
                      }}
                    >
                      <Printer className="h-4 w-4 mr-2" />
                      –ü–µ—á–∞—Ç—å —Å–ø–∏—Å–∫–∞
                    </Button>
                  </div>
                </div>
                
                <div className="max-h-60 overflow-y-auto border rounded">
                  {!transportCargoList.cargo_list || transportCargoList.cargo_list.length === 0 ? (
                    <p className="p-4 text-gray-500 text-center">–ì—Ä—É–∑ –Ω–µ —Ä–∞–∑–º–µ—â–µ–Ω</p>
                  ) : (
                    <div className="space-y-2 p-2">
                      {transportCargoList.cargo_list.map((cargo, index) => (
                        <div key={cargo.id} className="flex justify-between items-center p-3 bg-gray-50 rounded border">
                          <div className="flex-1">
                            <div className="flex items-center space-x-4">
                              <div>
                                <p className="font-medium">{cargo.cargo_number}</p>
                                <p className="text-sm text-gray-600">{cargo.cargo_name || '–ì—Ä—É–∑'}</p>
                              </div>
                              <div>
                                <p className="text-sm"><strong>–í–µ—Å:</strong> {cargo.weight} –∫–≥</p>
                                <p className="text-sm"><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> {cargo.recipient_name}</p>
                              </div>
                            </div>
                            <div className="mt-2 text-xs text-gray-500">
                              <p><strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> {cargo.sender_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω'} - {cargo.sender_phone || '–ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞'}</p>
                              <p><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> {cargo.recipient_full_name || cargo.recipient_name} - {cargo.recipient_phone || '–ù–µ—Ç —Ç–µ–ª–µ—Ñ–æ–Ω–∞'}</p>
                              {cargo.recipient_address && (
                                <p><strong>–ê–¥—Ä–µ—Å:</strong> {cargo.recipient_address}</p>
                              )}
                            </div>
                          </div>
                          
                          <div className="flex space-x-2">
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={async () => {
                                try {
                                  const fullCargoDetails = await fetchCargoDetails(cargo.id);
                                  setSelectedCellCargo(fullCargoDetails);
                                  setCargoDetailModal(true);
                                } catch (error) {
                                  console.error('Error fetching cargo details:', error);
                                }
                              }}
                            >
                              <User className="h-4 w-4" />
                            </Button>
                            
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={() => printCargoQrLabel(cargo)}
                              title="–ü–µ—á–∞—Ç—å QR —ç—Ç–∏–∫–µ—Ç–∫–∏"
                            >
                              <QrCode className="h-4 w-4" />
                            </Button>
                            
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={async () => {
                                if (window.confirm(`–í–µ—Ä–Ω—É—Ç—å –≥—Ä—É–∑ ${cargo.cargo_number} –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ –Ω–∞ —Å–∫–ª–∞–¥–µ?`)) {
                                  try {
                                    // Return cargo to its original warehouse location
                                    await apiCall(`/api/transport/${selectedTransport.id}/remove-cargo/${cargo.id}`, 'DELETE');
                                    showAlert(`–ì—Ä—É–∑ ${cargo.cargo_number} –≤–æ–∑–≤—Ä–∞—â–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥!`, 'success');
                                    fetchTransportCargoList(selectedTransport.id);
                                    fetchTransports();
                                  } catch (error) {
                                    console.error('Error returning cargo:', error);
                                    showAlert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ–∑–≤—Ä–∞—Ç–µ –≥—Ä—É–∑–∞ –Ω–∞ —Å–∫–ª–∞–¥', 'error');
                                  }
                                }
                              }}
                              className="text-orange-600 hover:text-orange-700"
                            >
                              <Package className="h-4 w-4" />
                            </Button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                
                {transportCargoList.cargo_list && transportCargoList.cargo_list.length > 0 && (
                  <div className="mt-4 p-3 bg-blue-50 rounded">
                    <p className="text-sm"><strong>–û–±—â–∏–π –≤–µ—Å:</strong> {transportCargoList.total_weight || 0} –∫–≥</p>
                    <p className="text-sm"><strong>–û—Å—Ç–∞—Ç–æ–∫ –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏:</strong> {selectedTransport.capacity_kg - (transportCargoList.total_weight || 0)} –∫–≥</p>
                  </div>
                )}
              </Card>

              {/* –†–∞–∑–º–µ—â–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≥—Ä—É–∑–∞ */}
              <Card className="p-4">
                <h4 className="font-semibold mb-3">–†–∞–∑–º–µ—â–µ–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –≥—Ä—É–∑–∞</h4>
                <p className="text-sm text-gray-600 mb-4">
                  –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ –≥—Ä—É–∑–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –Ω–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
                </p>
                
                <div className="mb-4">
                  <Label htmlFor="cargo-numbers">–ù–æ–º–µ—Ä–∞ –≥—Ä—É–∑–æ–≤ (—á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é):</Label>
                  <Input
                    id="cargo-numbers"
                    placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 1001, 1002, 1003"
                    value={selectedCargoForPlacement.join(', ')}
                    onChange={(e) => {
                      const cargoNumbers = e.target.value.split(',').map(num => num.trim()).filter(num => num);
                      setSelectedCargoForPlacement(cargoNumbers);
                    }}
                    className="mt-2"
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ –≥—Ä—É–∑–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é. –ì—Ä—É–∑—ã –¥–æ–ª–∂–Ω—ã –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –Ω–∞ —Å–∫–ª–∞–¥–µ.
                  </p>
                </div>
                
                <Button 
                  onClick={() => handlePlaceCargoOnTransport(selectedTransport.id, selectedCargoForPlacement)}
                  disabled={selectedCargoForPlacement.length === 0}
                  className="w-full"
                >
                  –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –≥—Ä—É–∑
                </Button>
              </Card>

              {/* –î–µ–π—Å—Ç–≤–∏—è —Å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–º */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                
                {/* –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç */}
                <Card className="p-4">
                  <h4 className="font-semibold mb-3">–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç</h4>
                  <p className="text-sm text-gray-600 mb-4">
                    –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –≤ –º–µ—Å—Ç–æ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å –ª—é–±—ã–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –≥—Ä—É–∑–∞
                  </p>
                  <Button 
                    onClick={() => handleDispatchTransport(selectedTransport.id)}
                    disabled={selectedTransport.status === 'in_transit'}
                    className="w-full"
                  >
                    {selectedTransport.status === 'in_transit' ? '–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç —É–∂–µ –≤ –ø—É—Ç–∏' : '–û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç'}
                  </Button>
                </Card>

                {/* –£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç */}
                <Card className="p-4">
                  <h4 className="font-semibold mb-3">–£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç</h4>
                  <p className="text-sm text-gray-600 mb-4">
                    –£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –∏ –ø–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ –∏—Å—Ç–æ—Ä–∏—é
                  </p>
                  <Button 
                    onClick={() => handleDeleteTransport(selectedTransport.id)}
                    variant="destructive"
                    className="w-full"
                  >
                    –£–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
                  </Button>
                </Card>

              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ "–°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏" */}
      <Dialog open={contactModal} onOpenChange={setContactModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <MessageCircle className="mr-2 h-5 w-5" />
              –°–≤—è–∑–∞—Ç—å—Å—è —Å –Ω–∞–º–∏
            </DialogTitle>
            <DialogDescription>
              –í—ã–±–µ—Ä–∏—Ç–µ —É–¥–æ–±–Ω—ã–π —Å–ø–æ—Å–æ–± —Å–≤—è–∑–∏ —Å –Ω–∞—à–µ–π —Å–ª—É–∂–±–æ–π –ø–æ–¥–¥–µ—Ä–∂–∫–∏
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4">
            {/* WhatsApp */}
            <Card className="p-4 hover:bg-green-50 cursor-pointer transition-colors" onClick={handleWhatsAppContact}>
              <div className="flex items-center space-x-4">
                <div className="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                  <MessageCircle className="w-6 h-6 text-white" />
                </div>
                <div className="flex-1">
                  <h3 className="font-semibold text-green-700">WhatsApp</h3>
                  <p className="text-sm text-gray-600">–ë—ã—Å—Ç—Ä–∞—è —Å–≤—è–∑—å —á–µ—Ä–µ–∑ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä</p>
                  <p className="text-xs text-gray-500">+7 (912) 345-67-89</p>
                </div>
                <div className="text-green-500">
                  <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                  </svg>
                </div>
              </div>
            </Card>

            {/* Telegram */}
            <Card className="p-4 hover:bg-blue-50 cursor-pointer transition-colors" onClick={handleTelegramContact}>
              <div className="flex items-center space-x-4">
                <div className="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                  <MessageCircle className="w-6 h-6 text-white" />
                </div>
                <div className="flex-1">
                  <h3 className="font-semibold text-blue-700">Telegram</h3>
                  <p className="text-sm text-gray-600">–û–±—â–µ–Ω–∏–µ –≤ –º–µ—Å—Å–µ–Ω–¥–∂–µ—Ä–µ</p>
                  <p className="text-xs text-gray-500">@tajline_support</p>
                </div>
                <div className="text-blue-500">
                  <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                  </svg>
                </div>
              </div>
            </Card>

            {/* –û–Ω–ª–∞–π–Ω —á–∞—Ç */}
            <Card className="p-4 hover:bg-purple-50 cursor-pointer transition-colors" onClick={handleOnlineChat}>
              <div className="flex items-center space-x-4">
                <div className="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center">
                  <MessageCircle className="w-6 h-6 text-white" />
                </div>
                <div className="flex-1">
                  <h3 className="font-semibold text-purple-700">–û–Ω–ª–∞–π–Ω —á–∞—Ç</h3>
                  <p className="text-sm text-gray-600">–ü—Ä—è–º–∞—è —Å–≤—è–∑—å —Å –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º</p>
                  <p className="text-xs text-gray-500">–ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã</p>
                </div>
                <div className="text-purple-500">
                  <MessageCircle className="w-5 h-5" />
                </div>
              </div>
            </Card>

            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≤—Ä–µ–º–µ–Ω–∏ —Ä–∞–±–æ—Ç—ã */}
            <div className="bg-gray-50 p-3 rounded-lg">
              <div className="flex items-center space-x-2 mb-2">
                <Clock className="w-4 h-4 text-gray-500" />
                <span className="text-sm font-medium text-gray-700">–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏</span>
              </div>
              <p className="text-xs text-gray-600">–ü–æ–Ω–µ–¥–µ–ª—å–Ω–∏–∫ - –ü—è—Ç–Ω–∏—Ü–∞: 9:00 - 18:00 (–ú–°–ö)</p>
              <p className="text-xs text-gray-600">–°—É–±–±–æ—Ç–∞ - –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ: 10:00 - 16:00 (–ú–°–ö)</p>
              <p className="text-xs text-green-600 mt-1">WhatsApp –∏ Telegram –¥–æ—Å—Ç—É–ø–Ω—ã 24/7</p>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–≤—è–∑–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∫ —Å–∫–ª–∞–¥—É */}
      <Dialog open={operatorBindingModal} onOpenChange={setOperatorBindingModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>–ü—Ä–∏–≤—è–∑–∞—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∫ —Å–∫–ª–∞–¥—É</DialogTitle>
            <DialogDescription>
              –í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏ —Å–∫–ª–∞–¥ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–∏–≤—è–∑–∫–∏
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4">
            <div>
              <Label htmlFor="operator-select">–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</Label>
              <Select value={selectedOperatorForBinding} onValueChange={setSelectedOperatorForBinding}>
                <SelectTrigger id="operator-select">
                  <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å–∫–ª–∞–¥–∞" />
                </SelectTrigger>
                <SelectContent>
                  {usersByRole.warehouse_operator.map((operator) => (
                    <SelectItem key={operator.id} value={operator.id}>
                      {operator.full_name} ({operator.phone})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div>
              <Label htmlFor="warehouse-select">–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥</Label>
              <Select value={selectedWarehouseForBinding} onValueChange={setSelectedWarehouseForBinding}>
                <SelectTrigger id="warehouse-select">
                  <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥" />
                </SelectTrigger>
                <SelectContent>
                  {warehouses.map((warehouse) => (
                    <SelectItem key={warehouse.id} value={warehouse.id}>
                      {warehouse.name} ({warehouse.location})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div className="flex justify-end space-x-2 pt-4">
              <Button
                variant="outline"
                onClick={() => {
                  setOperatorBindingModal(false);
                  setSelectedOperatorForBinding('');
                  setSelectedWarehouseForBinding('');
                }}
              >
                –û—Ç–º–µ–Ω–∞
              </Button>
              <Button onClick={handleCreateOperatorBinding}>
                –°–æ–∑–¥–∞—Ç—å –ø—Ä–∏–≤—è–∑–∫—É
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä—É–∑–∞ */}
      <Dialog open={cargoDetailModal} onOpenChange={setCargoDetailModal}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ {selectedCellCargo?.cargo_number}
            </DialogTitle>
          </DialogHeader>
          
          {selectedCellCargo && (
            <div className="space-y-4">
              {/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
              <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                <div>
                  <p><strong>–ù–æ–º–µ—Ä –≥—Ä—É–∑–∞:</strong> {selectedCellCargo.cargo_number}</p>
                  <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> {selectedCellCargo.cargo_name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}</p>
                  <p><strong>–í–µ—Å:</strong> {selectedCellCargo.weight} –∫–≥</p>
                  <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {selectedCellCargo.declared_value} —Ä—É–±.</p>
                </div>
                <div>
                  <p><strong>–î–∞—Ç–∞ –ø—Ä–∏—ë–º–∞:</strong> {new Date(selectedCellCargo.created_at).toLocaleDateString('ru-RU')}</p>
                  <p><strong>–°—Ç–∞—Ç—É—Å:</strong> {selectedCellCargo.status}</p>
                  <p><strong>–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã:</strong> {selectedCellCargo.payment_status || 'pending'}</p>
                  {selectedCellCargo.warehouse_location && (
                    <p><strong>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong> {selectedCellCargo.warehouse_location}</p>
                  )}
                </div>
              </div>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ */}
              <div className="p-4 border rounded-lg">
                <h3 className="font-semibold mb-2">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</h3>
                <p><strong>–§–ò–û:</strong> {selectedCellCargo.sender_full_name}</p>
                <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {selectedCellCargo.sender_phone}</p>
              </div>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ */}
              <div className="p-4 border rounded-lg">
                <h3 className="font-semibold mb-2">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</h3>
                <p><strong>–§–ò–û:</strong> {selectedCellCargo.recipient_full_name || selectedCellCargo.recipient_name}</p>
                <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {selectedCellCargo.recipient_phone}</p>
                <p><strong>–ê–¥—Ä–µ—Å:</strong> {selectedCellCargo.recipient_address}</p>
              </div>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞—Ö */}
              <div className="p-4 bg-blue-50 rounded-lg">
                <h3 className="font-semibold mb-2">–û–±—Ä–∞–±–æ—Ç–∫–∞</h3>
                {selectedCellCargo.created_by_operator && (
                  <p><strong>–ü—Ä–∏–Ω—è–ª –æ–ø–µ—Ä–∞—Ç–æ—Ä:</strong> {selectedCellCargo.created_by_operator}</p>
                )}
                {selectedCellCargo.placed_by_operator && (
                  <p><strong>–†–∞–∑–º–µ—Å—Ç–∏–ª –æ–ø–µ—Ä–∞—Ç–æ—Ä:</strong> {selectedCellCargo.placed_by_operator}</p>
                )}
              </div>

              {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
              <div className="flex flex-wrap gap-2 pt-4">
                <Button onClick={() => handleEditCargo(selectedCellCargo)}>
                  <Edit className="mr-2 h-4 w-4" />
                  –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </Button>
                
                {selectedCellCargo.warehouse_location && (
                  <>
                    <Button
                      variant="outline"
                      onClick={() => handleMoveCargo(selectedCellCargo)}
                    >
                      <Package className="mr-2 h-4 w-4" />
                      –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å
                    </Button>
                    
                    <Button
                      variant="destructive"
                      onClick={() => handleRemoveCargoFromCell(selectedCellCargo)}
                    >
                      <Trash2 className="mr-2 h-4 w-4" />
                      –£–¥–∞–ª–∏—Ç—å –∏–∑ —è—á–µ–π–∫–∏
                    </Button>
                  </>
                )}
                
                <div className="flex space-x-2">
                  <Button variant="outline" onClick={() => printInvoice(selectedCellCargo)}>
                    <Printer className="mr-2 h-4 w-4" />
                    –ü–µ—á–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω–æ–π
                  </Button>
                  
                  <Button variant="outline" onClick={() => printCargoQrLabel(selectedCellCargo)}>
                    <QrCode className="mr-2 h-4 w-4" />
                    QR —ç—Ç–∏–∫–µ—Ç–∫–∞
                  </Button>
                </div>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥—Ä—É–∑–∞ */}
      <Dialog open={cargoEditModal} onOpenChange={setCargoEditModal}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ {editingCargo?.cargo_number}</DialogTitle>
          </DialogHeader>
          
          <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="edit_cargo_name">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞</Label>
                <Input
                  id="edit_cargo_name"
                  value={cargoEditForm.cargo_name || ''}
                  onChange={(e) => setCargoEditForm({...cargoEditForm, cargo_name: e.target.value})}
                />
              </div>
              <div>
                <Label htmlFor="edit_weight">–í–µ—Å (–∫–≥)</Label>
                <Input
                  id="edit_weight"
                  type="number"
                  step="0.1"
                  value={cargoEditForm.weight || ''}
                  onChange={(e) => setCargoEditForm({...cargoEditForm, weight: parseFloat(e.target.value)})}
                />
              </div>
            </div>

            <div>
              <Label htmlFor="edit_description">–û–ø–∏—Å–∞–Ω–∏–µ</Label>
              <Textarea
                id="edit_description"
                value={cargoEditForm.description || ''}
                onChange={(e) => setCargoEditForm({...cargoEditForm, description: e.target.value})}
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="edit_sender_name">–§–ò–û –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è</Label>
                <Input
                  id="edit_sender_name"
                  value={cargoEditForm.sender_full_name || ''}
                  onChange={(e) => setCargoEditForm({...cargoEditForm, sender_full_name: e.target.value})}
                />
              </div>
              <div>
                <Label htmlFor="edit_sender_phone">–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è</Label>
                <Input
                  id="edit_sender_phone"
                  value={cargoEditForm.sender_phone || ''}
                  onChange={(e) => setCargoEditForm({...cargoEditForm, sender_phone: e.target.value})}
                />
              </div>
            </div>

            <div className="flex justify-end space-x-2 pt-4">
              <Button variant="outline" onClick={() => setCargoEditModal(false)}>
                –û—Ç–º–µ–Ω–∞
              </Button>
              <Button onClick={handleUpdateCargo}>
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞ */}
      <Dialog open={cargoMoveModal} onOpenChange={setCargoMoveModal}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>–ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞ {editingCargo?.cargo_number}</DialogTitle>
          </DialogHeader>
          
          <div className="space-y-4">
            <div>
              <Label htmlFor="move_warehouse">–°–∫–ª–∞–¥</Label>
              <Select
                value={cargoMoveForm.warehouse_id}
                onValueChange={(value) => setCargoMoveForm({...cargoMoveForm, warehouse_id: value})}
              >
                <SelectTrigger>
                  <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥" />
                </SelectTrigger>
                <SelectContent>
                  {warehouses.map((warehouse) => (
                    <SelectItem key={warehouse.id} value={warehouse.id}>
                      {warehouse.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div className="grid grid-cols-3 gap-4">
              <div>
                <Label htmlFor="move_block">–ë–ª–æ–∫</Label>
                <Input
                  id="move_block"
                  type="number"
                  min="1"
                  value={cargoMoveForm.block_number}
                  onChange={(e) => setCargoMoveForm({...cargoMoveForm, block_number: parseInt(e.target.value)})}
                />
              </div>
              <div>
                <Label htmlFor="move_shelf">–ü–æ–ª–∫–∞</Label>
                <Input
                  id="move_shelf"
                  type="number"
                  min="1"
                  value={cargoMoveForm.shelf_number}
                  onChange={(e) => setCargoMoveForm({...cargoMoveForm, shelf_number: parseInt(e.target.value)})}
                />
              </div>
              <div>
                <Label htmlFor="move_cell">–Ø—á–µ–π–∫–∞</Label>
                <Input
                  id="move_cell"
                  type="number"
                  min="1"
                  value={cargoMoveForm.cell_number}
                  onChange={(e) => setCargoMoveForm({...cargoMoveForm, cell_number: parseInt(e.target.value)})}
                />
              </div>
            </div>

            <div className="flex justify-end space-x-2 pt-4">
              <Button variant="outline" onClick={() => setCargoMoveModal(false)}>
                –û—Ç–º–µ–Ω–∞
              </Button>
              <Button onClick={handleMoveCargoSubmit}>
                –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* Alerts */}
      <div className="fixed top-4 right-4 space-y-2 z-50">
        {alerts.map((alert) => (
          <Alert key={alert.id} className={`max-w-sm ${alert.type === 'error' ? 'border-red-500' : alert.type === 'success' ? 'border-green-500' : 'border-blue-500'}`}>
            <AlertDescription>{alert.message}</AlertDescription>
          </Alert>
        ))}
      </div>

      {/* QR Scanner Modal */}
      <Dialog open={qrScannerModal} onOpenChange={setQrScannerModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>
              <Camera className="mr-2 h-5 w-5 inline" />
              –°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥
            </DialogTitle>
          </DialogHeader>
          
          <div className="space-y-4">
            <div className="text-center">
              <div className="w-64 h-64 bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center mx-auto mb-4">
                <div className="text-center">
                  <Camera className="w-12 h-12 text-gray-400 mx-auto mb-2" />
                  <p className="text-sm text-gray-500">QR —Å–∫–∞–Ω–µ—Ä</p>
                  <p className="text-xs text-gray-400 mt-1">–ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR –∫–æ–¥</p>
                </div>
              </div>
              
              <p className="text-sm text-gray-600 mb-4">
                –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –≥—Ä—É–∑–∞ –∏–ª–∏ —è—á–µ–π–∫–∏ —Å–∫–ª–∞–¥–∞ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
              </p>
              
              {/* Manual input for testing */}
              <div className="text-left">
                <Label htmlFor="manual-qr">–ò–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ QR –∫–æ–¥–∞ –≤—Ä—É—á–Ω—É—é:</Label>
                <textarea
                  id="manual-qr"
                  className="w-full mt-2 p-3 border rounded-md"
                  rows="4"
                  placeholder="–í—Å—Ç–∞–≤—å—Ç–µ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ QR –∫–æ–¥–∞ –∑–¥–µ—Å—å..."
                  onChange={(e) => {
                    if (e.target.value.trim()) {
                      handleQrScan(e.target.value.trim());
                      e.target.value = '';
                    }
                  }}
                />
              </div>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* QR Scan Result Modal */}
      {qrScanResult && (
        <Dialog open={!!qrScanResult} onOpenChange={() => setQrScanResult(null)}>
          <DialogContent className="max-w-md">
            <DialogHeader>
              <DialogTitle>
                <QrCode className="mr-2 h-5 w-5 inline" />
                –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
              </DialogTitle>
            </DialogHeader>
            
            <div className="space-y-4">
              {qrScanResult.type === 'cargo' && (
                <div className="space-y-3">
                  <div className="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                    <div>
                      <h3 className="font-semibold text-blue-800">–ì—Ä—É–∑ –Ω–∞–π–¥–µ–Ω!</h3>
                      <p className="text-sm text-blue-600">‚Ññ{qrScanResult.cargo_number}</p>
                    </div>
                    <Package className="h-8 w-8 text-blue-600" />
                  </div>
                  
                  <div className="space-y-2">
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</span>
                      <span className="text-sm">{qrScanResult.cargo_name}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">–í–µ—Å:</span>
                      <span className="text-sm">{qrScanResult.weight} –∫–≥</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">–°—Ç–∞—Ç—É—Å:</span>
                      <Badge variant="outline">{qrScanResult.status}</Badge>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</span>
                      <span className="text-sm">{qrScanResult.sender}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</span>
                      <span className="text-sm">{qrScanResult.recipient}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</span>
                      <span className="text-sm">{qrScanResult.location}</span>
                    </div>
                  </div>
                  
                  <Button 
                    className="w-full" 
                    onClick={async () => {
                      try {
                        const cargoDetails = await fetchCargoDetails(qrScanResult.cargo_id);
                        setSelectedCellCargo(cargoDetails);
                        setCargoDetailModal(true);
                        setQrScanResult(null);
                      } catch (error) {
                        console.error('Error fetching cargo details:', error);
                      }
                    }}
                  >
                    –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                  </Button>
                </div>
              )}
              
              {qrScanResult.type === 'warehouse_cell' && (
                <div className="space-y-3">
                  <div className="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                    <div>
                      <h3 className="font-semibold text-green-800">–Ø—á–µ–π–∫–∞ —Å–∫–ª–∞–¥–∞</h3>
                      <p className="text-sm text-green-600">{qrScanResult.location}</p>
                    </div>
                    <Building className="h-8 w-8 text-green-600" />
                  </div>
                  
                  <div className="space-y-2">
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">–°–∫–ª–∞–¥:</span>
                      <span className="text-sm">{qrScanResult.warehouse_name}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">–ë–ª–æ–∫:</span>
                      <span className="text-sm">{qrScanResult.block}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">–ü–æ–ª–∫–∞:</span>
                      <span className="text-sm">{qrScanResult.shelf}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">–Ø—á–µ–π–∫–∞:</span>
                      <span className="text-sm">{qrScanResult.cell}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">–°—Ç–∞—Ç—É—Å:</span>
                      <Badge variant={qrScanResult.is_occupied ? "destructive" : "default"}>
                        {qrScanResult.is_occupied ? "–ó–∞–Ω—è—Ç–∞" : "–°–≤–æ–±–æ–¥–Ω–∞"}
                      </Badge>
                    </div>
                    
                    {qrScanResult.cargo && (
                      <div className="mt-3 p-3 bg-gray-50 rounded-lg">
                        <h4 className="font-medium text-sm mb-2">–ì—Ä—É–∑ –≤ —è—á–µ–π–∫–µ:</h4>
                        <div className="space-y-1">
                          <div className="flex justify-between">
                            <span className="text-xs">–ù–æ–º–µ—Ä:</span>
                            <span className="text-xs font-medium">{qrScanResult.cargo.cargo_number}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-xs">–ù–∞–∑–≤–∞–Ω–∏–µ:</span>
                            <span className="text-xs">{qrScanResult.cargo.cargo_name}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-xs">–í–µ—Å:</span>
                            <span className="text-xs">{qrScanResult.cargo.weight} –∫–≥</span>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                  
                  <Button 
                    className="w-full" 
                    variant="outline"
                    onClick={() => {
                      // Navigate to warehouse management
                      const warehouse = warehouses.find(w => w.id === qrScanResult.warehouse_id);
                      if (warehouse) {
                        handleOpenWarehouseLayout(warehouse);
                        setQrScanResult(null);
                      }
                    }}
                  >
                    –ü–µ—Ä–µ–π—Ç–∏ –∫ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—é —Å–∫–ª–∞–¥–æ–º
                  </Button>
                </div>
              )}
            </div>
          </DialogContent>
        </Dialog>
      )}

      {/* Arrived Transport Modal */}
      <Dialog open={arrivedTransportModal} onOpenChange={setArrivedTransportModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              <Truck className="mr-2 h-5 w-5 inline" />
              –†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–æ–≤ –∏–∑ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ {selectedArrivedTransport?.transport_number}
            </DialogTitle>
          </DialogHeader>
          
          {selectedArrivedTransport && (
            <div className="space-y-6">
              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ */}
              <div className="p-4 bg-green-50 rounded-lg">
                <h4 className="font-semibold text-green-800 mb-2">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ</h4>
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <p><strong>–ù–æ–º–µ—Ä:</strong> {selectedArrivedTransport.transport_number}</p>
                  <p><strong>–í–æ–¥–∏—Ç–µ–ª—å:</strong> {selectedArrivedTransport.driver_name}</p>
                  <p><strong>–ù–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ:</strong> {selectedArrivedTransport.direction}</p>
                  <p><strong>–ü—Ä–∏–±—ã–ª:</strong> {new Date(selectedArrivedTransport.arrived_at).toLocaleString('ru-RU')}</p>
                </div>
              </div>

              {/* –°–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è */}
              <Card className="p-4">
                <div className="flex justify-between items-center mb-4">
                  <h4 className="font-semibold">–ì—Ä—É–∑—ã –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è ({arrivedCargoList.placeable_cargo_count || 0} –∏–∑ {arrivedCargoList.cargo_count || 0})</h4>
                  <div className="flex items-center space-x-4">
                    <Button
                      size="sm"
                      variant="outline"
                      onClick={() => setQrPlacementModal(true)}
                      className="text-purple-600 hover:text-purple-700"
                    >
                      <QrCode className="h-4 w-4 mr-1" />
                      QR –†–∞–∑–º–µ—â–µ–Ω–∏–µ
                    </Button>
                    <div className="text-sm text-gray-600">
                      –û–±—â–∏–π –≤–µ—Å: {arrivedCargoList.total_weight || 0} –∫–≥
                    </div>
                  </div>
                </div>
                
                <div className="max-h-80 overflow-y-auto border rounded">
                  {!arrivedCargoList.cargo_list || arrivedCargoList.cargo_list.length === 0 ? (
                    <p className="p-4 text-gray-500 text-center">–ù–µ—Ç –≥—Ä—É–∑–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</p>
                  ) : (
                    <div className="space-y-2 p-2">
                      {arrivedCargoList.cargo_list.map((cargo) => (
                        <div key={cargo.id} className={`flex justify-between items-center p-3 rounded border ${cargo.can_be_placed ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
                          <div className="flex-1">
                            <div className="flex items-center space-x-4">
                              <div>
                                <p className="font-medium">{cargo.cargo_number}</p>
                                <p className="text-sm text-gray-600">{cargo.cargo_name}</p>
                              </div>
                              <div>
                                <p className="text-sm"><strong>–í–µ—Å:</strong> {cargo.weight} –∫–≥</p>
                                <p className="text-sm"><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> {cargo.recipient_full_name}</p>
                              </div>
                              <div>
                                <Badge variant={cargo.can_be_placed ? "default" : "secondary"}>
                                  {cargo.status === 'arrived_destination' ? '–ì–æ—Ç–æ–≤ –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é' : cargo.status}
                                </Badge>
                              </div>
                            </div>
                          </div>
                          
                          <div className="flex space-x-2">
                            {cargo.can_be_placed && (
                              <Button
                                size="sm"
                                onClick={() => {
                                  setSelectedCargoForWarehouse(cargo);
                                  setCargoPlacementModal(true);
                                }}
                                className="bg-blue-600 hover:bg-blue-700 text-white"
                              >
                                <Building className="h-4 w-4 mr-1" />
                                –†–∞–∑–º–µ—Å—Ç–∏—Ç—å
                              </Button>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </Card>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* Cargo Placement Modal */}
      <Dialog open={cargoPlacementModal} onOpenChange={setCargoPlacementModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>
              <Building className="mr-2 h-5 w-5 inline" />
              –†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞ {selectedCargoForWarehouse?.cargo_number}
            </DialogTitle>
          </DialogHeader>
          
          <form onSubmit={handlePlaceCargoFromTransport} className="space-y-4">
            {selectedCargoForWarehouse && (
              <div className="p-3 bg-blue-50 rounded-lg">
                <h5 className="font-medium text-blue-800">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ</h5>
                <p className="text-sm"><strong>–ù–æ–º–µ—Ä:</strong> {selectedCargoForWarehouse.cargo_number}</p>
                <p className="text-sm"><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> {selectedCargoForWarehouse.cargo_name}</p>
                <p className="text-sm"><strong>–í–µ—Å:</strong> {selectedCargoForWarehouse.weight} –∫–≥</p>
                <p className="text-sm"><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> {selectedCargoForWarehouse.recipient_full_name}</p>
              </div>
            )}

            <div>
              <Label htmlFor="placement_warehouse">–°–∫–ª–∞–¥</Label>
              <Select 
                value={placementForm.warehouse_id} 
                onValueChange={(value) => setPlacementForm({...placementForm, warehouse_id: value})}
                required
              >
                <SelectTrigger>
                  <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥" />
                </SelectTrigger>
                <SelectContent>
                  {warehouses.map((warehouse) => (
                    <SelectItem key={warehouse.id} value={warehouse.id}>
                      {warehouse.name} ({warehouse.location})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div className="grid grid-cols-3 gap-3">
              <div>
                <Label htmlFor="placement_block">–ë–ª–æ–∫</Label>
                <Select 
                  value={placementForm.block_number.toString()} 
                  onValueChange={(value) => setPlacementForm({...placementForm, block_number: parseInt(value)})}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {placementForm.warehouse_id && warehouses.find(w => w.id === placementForm.warehouse_id) && 
                      Array.from({length: warehouses.find(w => w.id === placementForm.warehouse_id).blocks_count}, (_, i) => (
                        <SelectItem key={i+1} value={(i+1).toString()}>{i+1}</SelectItem>
                      ))
                    }
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label htmlFor="placement_shelf">–ü–æ–ª–∫–∞</Label>
                <Select 
                  value={placementForm.shelf_number.toString()} 
                  onValueChange={(value) => setPlacementForm({...placementForm, shelf_number: parseInt(value)})}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {placementForm.warehouse_id && warehouses.find(w => w.id === placementForm.warehouse_id) && 
                      Array.from({length: warehouses.find(w => w.id === placementForm.warehouse_id).shelves_per_block}, (_, i) => (
                        <SelectItem key={i+1} value={(i+1).toString()}>{i+1}</SelectItem>
                      ))
                    }
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label htmlFor="placement_cell">–Ø—á–µ–π–∫–∞</Label>
                <Select 
                  value={placementForm.cell_number.toString()} 
                  onValueChange={(value) => setPlacementForm({...placementForm, cell_number: parseInt(value)})}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {placementForm.warehouse_id && warehouses.find(w => w.id === placementForm.warehouse_id) && 
                      Array.from({length: warehouses.find(w => w.id === placementForm.warehouse_id).cells_per_shelf}, (_, i) => (
                        <SelectItem key={i+1} value={(i+1).toString()}>{i+1}</SelectItem>
                      ))
                    }
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div className="flex space-x-2 pt-4">
              <Button type="submit" className="flex-1">
                <Building className="mr-2 h-4 w-4" />
                –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –≥—Ä—É–∑
              </Button>
              <Button 
                type="button" 
                variant="outline" 
                onClick={() => {
                  setCargoPlacementModal(false);
                  setSelectedCargoForWarehouse(null);
                }}
              >
                –û—Ç–º–µ–Ω–∞
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* Transport Visualization Modal */}
      <Dialog open={transportVisualizationModal} onOpenChange={setTransportVisualizationModal}>
        <DialogContent className="max-w-6xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              <Truck className="mr-2 h-5 w-5 inline" />
              –°—Ö–µ–º–∞ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ {selectedTransportForVisualization?.transport_number}
            </DialogTitle>
          </DialogHeader>
          
          {transportVisualizationData && (
            <div className="space-y-6">
              {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ */}
              <div className="grid grid-cols-4 gap-4">
                <div className="text-center p-4 bg-blue-50 rounded-lg">
                  <div className="text-2xl font-bold text-blue-600">{transportVisualizationData.cargo_summary.total_items}</div>
                  <div className="text-sm">–ì—Ä—É–∑–æ–≤</div>
                </div>
                <div className="text-center p-4 bg-green-50 rounded-lg">
                  <div className="text-2xl font-bold text-green-600">{transportVisualizationData.cargo_summary.total_weight} –∫–≥</div>
                  <div className="text-sm">–û–±—â–∏–π –≤–µ—Å</div>
                </div>
                <div className="text-center p-4 bg-purple-50 rounded-lg">
                  <div className="text-2xl font-bold text-purple-600">{transportVisualizationData.cargo_summary.fill_percentage_weight}%</div>
                  <div className="text-sm">–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ –≤–µ—Å—É</div>
                </div>
                <div className="text-center p-4 bg-orange-50 rounded-lg">
                  <div className="text-2xl font-bold text-orange-600">{transportVisualizationData.cargo_summary.total_volume_estimate} –º¬≥</div>
                  <div className="text-sm">–ü—Ä–∏–º–µ—Ä–Ω—ã–π –æ–±—ä—ë–º</div>
                </div>
              </div>

              {/* –ü—Ä–æ–≥—Ä–µ—Å—Å –±–∞—Ä –∑–∞–ø–æ–ª–Ω–µ–Ω–∏—è */}
              <div className="space-y-2">
                <div className="flex justify-between text-sm">
                  <span>–ó–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ –≤–µ—Å—É</span>
                  <span>{transportVisualizationData.cargo_summary.fill_percentage_weight}%</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-3">
                  <div 
                    className={`h-3 rounded-full ${
                      transportVisualizationData.cargo_summary.fill_percentage_weight > 100 ? 'bg-red-500' :
                      transportVisualizationData.cargo_summary.fill_percentage_weight > 90 ? 'bg-orange-500' :
                      transportVisualizationData.cargo_summary.fill_percentage_weight > 70 ? 'bg-yellow-500' : 'bg-green-500'
                    }`}
                    style={{width: `${Math.min(transportVisualizationData.cargo_summary.fill_percentage_weight, 100)}%`}}
                  />
                </div>
              </div>

              {/* –°—Ö–µ–º–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–æ–≤ */}
              <div className="space-y-4">
                <h4 className="font-semibold text-lg">–°—Ö–µ–º–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–æ–≤ –≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ</h4>
                <div className="border-2 border-gray-300 rounded-lg p-4 bg-gray-50">
                  <div className="text-center mb-2 text-sm font-medium text-gray-600">
                    ‚Üê –ü–µ—Ä–µ–¥–Ω—è—è —á–∞—Å—Ç—å ({transportVisualizationData.transport.dimensions.length}–º x {transportVisualizationData.transport.dimensions.width}–º)
                  </div>
                  <div className="grid grid-cols-6 gap-2">
                    {transportVisualizationData.visualization.placement_grid.map((row, rowIndex) =>
                      row.map((cell, cellIndex) => (
                        <div 
                          key={`${rowIndex}-${cellIndex}`}
                          className={`
                            relative h-16 border-2 rounded transition-all
                            ${cell.occupied 
                              ? 'bg-blue-100 border-blue-300 hover:bg-blue-200' 
                              : 'bg-white border-gray-300 border-dashed'
                            }
                          `}
                          title={cell.occupied ? `–ì—Ä—É–∑ ${cell.cargo_number}: ${cell.cargo_name} (${cell.weight}–∫–≥)` : '–°–≤–æ–±–æ–¥–Ω–æ–µ –º–µ—Å—Ç–æ'}
                        >
                          {cell.occupied && (
                            <div className="absolute inset-0 p-1 flex flex-col justify-center items-center text-xs">
                              <div className="font-bold text-blue-800">{cell.cargo_number}</div>
                              <div className="text-blue-600 text-center leading-tight">{cell.weight}–∫–≥</div>
                            </div>
                          )}
                          <div className="absolute bottom-0 right-0 text-xs text-gray-400 p-1">
                            {cell.position}
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                  <div className="text-center mt-2 text-sm font-medium text-gray-600">
                    –ó–∞–¥–Ω—è—è —á–∞—Å—Ç—å ‚Üí
                  </div>
                </div>
              </div>

              {/* –î–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤ */}
              <div className="space-y-4">
                <h4 className="font-semibold text-lg">–î–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤ ({transportVisualizationData.cargo_summary.total_items})</h4>
                <div className="max-h-64 overflow-y-auto border rounded-lg">
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead>‚Ññ –ì—Ä—É–∑–∞</TableHead>
                        <TableHead>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</TableHead>
                        <TableHead>–í–µ—Å (–∫–≥)</TableHead>
                        <TableHead>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</TableHead>
                        <TableHead>–ü–æ–∑–∏—Ü–∏—è</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {transportVisualizationData.cargo_summary.cargo_list.map((cargo, index) => (
                        <TableRow key={cargo.id}>
                          <TableCell className="font-medium">{cargo.cargo_number}</TableCell>
                          <TableCell>{cargo.cargo_name}</TableCell>
                          <TableCell>{cargo.weight}</TableCell>
                          <TableCell>{cargo.recipient_name}</TableCell>
                          <TableCell>{Math.floor(index / 6) + 1}-{(index % 6) + 1}</TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </div>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* QR/Number Cargo Placement Modal */}
      <Dialog open={qrPlacementModal} onOpenChange={setQrPlacementModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>
              <QrCode className="mr-2 h-5 w-5 inline" />
              –†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞ –ø–æ –Ω–æ–º–µ—Ä—É/QR
            </DialogTitle>
          </DialogHeader>
          
          <form onSubmit={handleQrCargoPlacement} className="space-y-4">
            <div className="p-3 bg-purple-50 rounded-lg">
              <h5 className="font-medium text-purple-800 mb-2">–†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞</h5>
              <p className="text-sm text-purple-700">
                –°–∫–ª–∞–¥ –±—É–¥–µ—Ç –≤—ã–±—Ä–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–∞—à–∏—Ö –ø—Ä–∏–≤—è–∑–æ–∫. –í—ã –¥–æ–ª–∂–Ω—ã —É–∫–∞–∑–∞—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —è—á–µ–π–∫—É –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≤—Ä—É—á–Ω—É—é –∏–ª–∏ —á–µ—Ä–µ–∑ QR –∫–æ–¥ —è—á–µ–π–∫–∏.
              </p>
            </div>

            <div>
              <Label htmlFor="cargo_number">–ù–æ–º–µ—Ä –≥—Ä—É–∑–∞</Label>
              <Input
                id="cargo_number"
                value={qrPlacementForm.cargo_number}
                onChange={(e) => setQrPlacementForm({...qrPlacementForm, cargo_number: e.target.value})}
                placeholder="1234"
                required={!qrPlacementForm.qr_data}
              />
            </div>

            <div className="text-center text-sm text-gray-500">–∏–ª–∏</div>

            <div>
              <Label htmlFor="qr_data">QR –∫–æ–¥ –≥—Ä—É–∑–∞</Label>
              <textarea
                id="qr_data"
                className="w-full mt-2 p-3 border rounded-md"
                rows="3"
                value={qrPlacementForm.qr_data}
                onChange={(e) => setQrPlacementForm({...qrPlacementForm, qr_data: e.target.value})}
                placeholder="–í—Å—Ç–∞–≤—å—Ç–µ QR –∫–æ–¥ –≥—Ä—É–∑–∞..."
                required={!qrPlacementForm.cargo_number}
              />
            </div>

            <div className="border-t pt-4">
              <Label>–†–∞–∑–º–µ—â–µ–Ω–∏–µ –≤ —è—á–µ–π–∫–µ</Label>
              
              <div className="mt-2">
                <Label htmlFor="cell_qr_data">QR –∫–æ–¥ —è—á–µ–π–∫–∏ —Å–∫–ª–∞–¥–∞</Label>
                <textarea
                  id="cell_qr_data"
                  className="w-full mt-2 p-3 border rounded-md"
                  rows="3"
                  value={qrPlacementForm.cell_qr_data}
                  onChange={(e) => setQrPlacementForm({...qrPlacementForm, cell_qr_data: e.target.value})}
                  placeholder="–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ —è—á–µ–π–∫–∏ —Å–∫–ª–∞–¥–∞..."
                />
              </div>

              <div className="text-center text-sm text-gray-500 my-2">–∏–ª–∏ —É–∫–∞–∂–∏—Ç–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –≤—Ä—É—á–Ω—É—é</div>

              <div className="grid grid-cols-3 gap-3">
                <div>
                  <Label htmlFor="manual_block">–ë–ª–æ–∫</Label>
                  <Input
                    id="manual_block"
                    type="number"
                    min="1"
                    value={qrPlacementForm.block_number}
                    onChange={(e) => setQrPlacementForm({...qrPlacementForm, block_number: e.target.value})}
                    placeholder="1"
                  />
                </div>
                <div>
                  <Label htmlFor="manual_shelf">–ü–æ–ª–∫–∞</Label>
                  <Input
                    id="manual_shelf"
                    type="number"
                    min="1"
                    value={qrPlacementForm.shelf_number}
                    onChange={(e) => setQrPlacementForm({...qrPlacementForm, shelf_number: e.target.value})}
                    placeholder="1"
                  />
                </div>
                <div>
                  <Label htmlFor="manual_cell">–Ø—á–µ–π–∫–∞</Label>
                  <Input
                    id="manual_cell"
                    type="number"
                    min="1"
                    value={qrPlacementForm.cell_number}
                    onChange={(e) => setQrPlacementForm({...qrPlacementForm, cell_number: e.target.value})}
                    placeholder="1"
                  />
                </div>
              </div>
            </div>

            <div className="flex space-x-2 pt-4">
              <Button type="submit" className="flex-1">
                <Building className="mr-2 h-4 w-4" />
                –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –≥—Ä—É–∑
              </Button>
              <Button 
                type="button" 
                variant="outline" 
                onClick={() => {
                  setQrPlacementModal(false);
                  setQrPlacementForm({
                    cargo_number: '',
                    qr_data: '',
                    cell_qr_data: '',
                    block_number: 1,
                    shelf_number: 1,
                    cell_number: 1
                  });
                }}
              >
                –û—Ç–º–µ–Ω–∞
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* Interwarehouse Transport Modal */}
      <Dialog open={interwarehouseTransportModal} onOpenChange={setInterwarehouseTransportModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>
              <Truck className="mr-2 h-5 w-5 inline" />
              –°–æ–∑–¥–∞–Ω–∏–µ –º–µ–∂—Å–∫–ª–∞–¥—Å–∫–æ–≥–æ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞
            </DialogTitle>
          </DialogHeader>
          
          <form onSubmit={handleCreateInterwarehouseTransport} className="space-y-4">
            <div className="p-3 bg-blue-50 rounded-lg">
              <h5 className="font-medium text-blue-800 mb-2">–ú–µ–∂—Å–∫–ª–∞–¥—Å–∫–∞—è –ø–µ—Ä–µ–≤–æ–∑–∫–∞</h5>
              <p className="text-sm text-blue-700">
                –°–æ–∑–¥–∞–π—Ç–µ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç –¥–ª—è –ø–µ—Ä–µ–≤–æ–∑–∫–∏ –≥—Ä—É–∑–æ–≤ –º–µ–∂–¥—É –≤–∞—à–∏–º–∏ —Å–∫–ª–∞–¥–∞–º–∏. –î–æ—Å—Ç—É–ø–Ω—ã —Ç–æ–ª—å–∫–æ —Å–∫–ª–∞–¥—ã, –∫ –∫–æ—Ç–æ—Ä—ã–º —É –≤–∞—Å –µ—Å—Ç—å –¥–æ—Å—Ç—É–ø.
              </p>
            </div>

            <div>
              <Label htmlFor="source_warehouse">–ò—Å—Ö–æ–¥–Ω—ã–π —Å–∫–ª–∞–¥</Label>
              <Select 
                value={interwarehouseForm.source_warehouse_id} 
                onValueChange={(value) => setInterwarehouseForm({...interwarehouseForm, source_warehouse_id: value})}
                required
              >
                <SelectTrigger>
                  <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –∏—Å—Ö–æ–¥–Ω—ã–π —Å–∫–ª–∞–¥" />
                </SelectTrigger>
                <SelectContent>
                  {(user?.role === 'admin' ? warehouses : operatorWarehouses).map((warehouse) => (
                    <SelectItem key={warehouse.id} value={warehouse.id}>
                      {warehouse.name} ({warehouse.location})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div>
              <Label htmlFor="destination_warehouse">–¶–µ–ª–µ–≤–æ–π —Å–∫–ª–∞–¥</Label>
              <Select 
                value={interwarehouseForm.destination_warehouse_id} 
                onValueChange={(value) => setInterwarehouseForm({...interwarehouseForm, destination_warehouse_id: value})}
                required
              >
                <SelectTrigger>
                  <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Ü–µ–ª–µ–≤–æ–π —Å–∫–ª–∞–¥" />
                </SelectTrigger>
                <SelectContent>
                  {(user?.role === 'admin' ? warehouses : operatorWarehouses)
                    .filter(w => w.id !== interwarehouseForm.source_warehouse_id)
                    .map((warehouse) => (
                      <SelectItem key={warehouse.id} value={warehouse.id}>
                        {warehouse.name} ({warehouse.location})
                      </SelectItem>
                    ))}
                </SelectContent>
              </Select>
            </div>

            <div>
              <Label htmlFor="iw_driver_name">–§–ò–û –≤–æ–¥–∏—Ç–µ–ª—è</Label>
              <Input
                id="iw_driver_name"
                value={interwarehouseForm.driver_name}
                onChange={(e) => setInterwarehouseForm({...interwarehouseForm, driver_name: e.target.value})}
                placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤"
                required
              />
            </div>

            <div>
              <Label htmlFor="iw_driver_phone">–¢–µ–ª–µ—Ñ–æ–Ω –≤–æ–¥–∏—Ç–µ–ª—è</Label>
              <Input
                id="iw_driver_phone"
                value={interwarehouseForm.driver_phone}
                onChange={(e) => setInterwarehouseForm({...interwarehouseForm, driver_phone: e.target.value})}
                placeholder="+7 (999) 123-45-67"
                required
              />
            </div>

            <div>
              <Label htmlFor="iw_capacity">–ì—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å (–∫–≥)</Label>
              <Input
                id="iw_capacity"
                type="number"
                min="100"
                step="50"
                value={interwarehouseForm.capacity_kg}
                onChange={(e) => setInterwarehouseForm({...interwarehouseForm, capacity_kg: parseInt(e.target.value)})}
                required
              />
            </div>

            <div className="flex space-x-2 pt-4">
              <Button type="submit" className="flex-1">
                <Truck className="mr-2 h-4 w-4" />
                –°–æ–∑–¥–∞—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç
              </Button>
              <Button 
                type="button" 
                variant="outline" 
                onClick={() => {
                  setInterwarehouseTransportModal(false);
                  setInterwarehouseForm({
                    source_warehouse_id: '',
                    destination_warehouse_id: '',
                    driver_name: '',
                    driver_phone: '',
                    capacity_kg: 1000
                  });
                }}
              >
                –û—Ç–º–µ–Ω–∞
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* –ù–û–í–´–ï –ú–û–î–ê–õ–´ –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ó–ê–ö–ê–ó–ê–ú–ò –ö–õ–ò–ï–ù–¢–û–í */}

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞–∫–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–∞ */}
      <Dialog open={orderDetailsModal} onOpenChange={setOrderDetailsModal}>
        <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <ShoppingCart className="w-5 h-5 mr-2 text-orange-600" />
              –î–µ—Ç–∞–ª–∏ –∑–∞–∫–∞–∑–∞ ‚Ññ{selectedOrder?.request_number}
            </DialogTitle>
            <DialogDescription>
              –ü—Ä–æ—Å–º–æ—Ç—Ä –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞–∫–∞–∑–µ –∫–ª–∏–µ–Ω—Ç–∞
            </DialogDescription>
          </DialogHeader>
          
          {selectedOrder && (
            <div className="space-y-6">
              {/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
              <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                <div>
                  <p className="text-sm text-gray-600"><strong>–ù–æ–º–µ—Ä –∑–∞–∫–∞–∑–∞:</strong></p>
                  <p className="font-medium">{selectedOrder.request_number}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-600"><strong>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</strong></p>
                  <p className="font-medium">
                    {new Date(selectedOrder.created_at).toLocaleDateString('ru-RU')} {' '}
                    {new Date(selectedOrder.created_at).toLocaleTimeString('ru-RU')}
                  </p>
                </div>
                <div>
                  <p className="text-sm text-gray-600"><strong>–°—Ç–∞—Ç—É—Å:</strong></p>
                  <Badge variant={selectedOrder.status === 'pending' ? 'destructive' : 'default'}>
                    {selectedOrder.status === 'pending' ? '–û–∂–∏–¥–∞–µ—Ç –æ–±—Ä–∞–±–æ—Ç–∫–∏' : selectedOrder.status}
                  </Badge>
                </div>
                <div>
                  <p className="text-sm text-gray-600"><strong>–ú–∞—Ä—à—Ä—É—Ç:</strong></p>
                  <p className="font-medium">
                    {selectedOrder.route === 'moscow_to_tajikistan' ? '–ú–æ—Å–∫–≤–∞ ‚Üí –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω' : '–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω ‚Üí –ú–æ—Å–∫–≤–∞'}
                  </p>
                </div>
              </div>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ */}
              <div className="border rounded-lg p-4">
                <h3 className="font-semibold text-lg mb-3 flex items-center">
                  <User className="w-5 h-5 mr-2 text-blue-600" />
                  –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600"><strong>–§–ò–û:</strong></p>
                    <p className="font-medium">{selectedOrder.sender_full_name}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong></p>
                    <p className="font-medium">{selectedOrder.sender_phone}</p>
                  </div>
                  <div className="md:col-span-2">
                    <p className="text-sm text-gray-600"><strong>–ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞:</strong></p>
                    <p className="font-medium">{selectedOrder.pickup_address}</p>
                  </div>
                </div>
              </div>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ */}
              <div className="border rounded-lg p-4">
                <h3 className="font-semibold text-lg mb-3 flex items-center">
                  <MapPin className="w-5 h-5 mr-2 text-green-600" />
                  –ü–æ–ª—É—á–∞—Ç–µ–ª—å
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600"><strong>–§–ò–û:</strong></p>
                    <p className="font-medium">{selectedOrder.recipient_full_name}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong></p>
                    <p className="font-medium">{selectedOrder.recipient_phone}</p>
                  </div>
                  <div className="md:col-span-2">
                    <p className="text-sm text-gray-600"><strong>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</strong></p>
                    <p className="font-medium">{selectedOrder.recipient_address}</p>
                  </div>
                </div>
              </div>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ */}
              <div className="border rounded-lg p-4">
                <h3 className="font-semibold text-lg mb-3 flex items-center">
                  <Package className="w-5 h-5 mr-2 text-purple-600" />
                  –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600"><strong>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞:</strong></p>
                    <p className="font-medium">{selectedOrder.cargo_name}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>–í–µ—Å:</strong></p>
                    <p className="font-medium">{selectedOrder.weight} –∫–≥</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>–û–±—ä—è–≤–ª–µ–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong></p>
                    <p className="font-medium">{selectedOrder.declared_value} ‚ÇΩ</p>
                  </div>
                  <div className="md:col-span-2">
                    <p className="text-sm text-gray-600"><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong></p>
                    <p className="font-medium">{selectedOrder.description}</p>
                  </div>
                </div>
              </div>

              {/* –ó–∞–º–µ—Ç–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ */}
              {selectedOrder.admin_notes && (
                <div className="border rounded-lg p-4 bg-blue-50">
                  <h3 className="font-semibold text-lg mb-3 flex items-center">
                    <FileText className="w-5 h-5 mr-2 text-blue-600" />
                    –ó–∞–º–µ—Ç–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                  </h3>
                  <p className="text-gray-700">{selectedOrder.admin_notes}</p>
                </div>
              )}

              {/* –î–µ–π—Å—Ç–≤–∏—è */}
              <div className="flex justify-between items-center pt-4 border-t">
                <div className="space-x-2">
                  <Button 
                    onClick={() => {
                      handleOrderEdit(selectedOrder);
                      setOrderDetailsModal(false);
                    }}
                    variant="outline"
                    className="flex items-center"
                  >
                    <Edit className="w-4 h-4 mr-2" />
                    –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                  </Button>
                </div>
                <div className="space-x-2">
                  <Button 
                    onClick={() => handleAcceptOrder(selectedOrder.id)}
                    className="bg-green-600 hover:bg-green-700"
                  >
                    <CheckCircle className="w-4 h-4 mr-2" />
                    –ü—Ä–∏–Ω—è—Ç—å –∑–∞–∫–∞–∑
                  </Button>
                  <Button 
                    onClick={() => handleRejectOrder(selectedOrder.id, '–ó–∞–∫–∞–∑ –æ—Ç–∫–ª–æ–Ω–µ–Ω –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º')}
                    variant="destructive"
                  >
                    <XCircle className="w-4 h-4 mr-2" />
                    –û—Ç–∫–ª–æ–Ω–∏—Ç—å
                  </Button>
                </div>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞–∫–∞–∑–∞ –∫–ª–∏–µ–Ω—Ç–∞ */}
      <Dialog open={editOrderModal} onOpenChange={setEditOrderModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Edit className="w-5 h-5 mr-2 text-blue-600" />
              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞–∫–∞–∑–∞ ‚Ññ{selectedOrder?.request_number}
            </DialogTitle>
            <DialogDescription>
              –ò–∑–º–µ–Ω–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ, –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ –∏ –≥—Ä—É–∑–µ
            </DialogDescription>
          </DialogHeader>
          
          <form onSubmit={(e) => { e.preventDefault(); handleSaveOrderChanges(); }}>
            <div className="space-y-6">
              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ */}
              <div className="border rounded-lg p-4">
                <h3 className="font-semibold text-lg mb-4 flex items-center">
                  <User className="w-5 h-5 mr-2 text-blue-600" />
                  –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="sender_full_name">–§–ò–û –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è</Label>
                    <Input
                      id="sender_full_name"
                      value={orderEditForm.sender_full_name}
                      onChange={(e) => setOrderEditForm({...orderEditForm, sender_full_name: e.target.value})}
                      placeholder="–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á –ü–µ—Ç—Ä–æ–≤"
                    />
                  </div>
                  <div>
                    <Label htmlFor="sender_phone">–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è</Label>
                    <Input
                      id="sender_phone"
                      value={orderEditForm.sender_phone}
                      onChange={(e) => setOrderEditForm({...orderEditForm, sender_phone: e.target.value})}
                      placeholder="+7 900 123-45-67"
                    />
                  </div>
                  <div className="md:col-span-2">
                    <Label htmlFor="pickup_address">–ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞</Label>
                    <Input
                      id="pickup_address"
                      value={orderEditForm.pickup_address}
                      onChange={(e) => setOrderEditForm({...orderEditForm, pickup_address: e.target.value})}
                      placeholder="–≥. –ú–æ—Å–∫–≤–∞, —É–ª. –¢–≤–µ—Ä—Å–∫–∞—è, –¥. 1"
                    />
                  </div>
                </div>
              </div>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ */}
              <div className="border rounded-lg p-4">
                <h3 className="font-semibold text-lg mb-4 flex items-center">
                  <MapPin className="w-5 h-5 mr-2 text-green-600" />
                  –ü–æ–ª—É—á–∞—Ç–µ–ª—å
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="recipient_full_name">–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è</Label>
                    <Input
                      id="recipient_full_name"
                      value={orderEditForm.recipient_full_name}
                      onChange={(e) => setOrderEditForm({...orderEditForm, recipient_full_name: e.target.value})}
                      placeholder="–ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á –ò–≤–∞–Ω–æ–≤"
                    />
                  </div>
                  <div>
                    <Label htmlFor="recipient_phone">–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è</Label>
                    <Input
                      id="recipient_phone"
                      value={orderEditForm.recipient_phone}
                      onChange={(e) => setOrderEditForm({...orderEditForm, recipient_phone: e.target.value})}
                      placeholder="+992 900 123456"
                    />
                  </div>
                  <div className="md:col-span-2">
                    <Label htmlFor="recipient_address">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏</Label>
                    <Input
                      id="recipient_address"
                      value={orderEditForm.recipient_address}
                      onChange={(e) => setOrderEditForm({...orderEditForm, recipient_address: e.target.value})}
                      placeholder="–≥. –î—É—à–∞–Ω–±–µ, —É–ª. –†—É–¥–∞–∫–∏, –¥. 10"
                    />
                  </div>
                </div>
              </div>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ */}
              <div className="border rounded-lg p-4">
                <h3 className="font-semibold text-lg mb-4 flex items-center">
                  <Package className="w-5 h-5 mr-2 text-purple-600" />
                  –ì—Ä—É–∑
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="cargo_name">–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞</Label>
                    <Input
                      id="cargo_name"
                      value={orderEditForm.cargo_name}
                      onChange={(e) => setOrderEditForm({...orderEditForm, cargo_name: e.target.value})}
                      placeholder="–î–æ–∫—É–º–µ–Ω—Ç—ã"
                    />
                  </div>
                  <div>
                    <Label htmlFor="route">–ú–∞—Ä—à—Ä—É—Ç</Label>
                    <Select value={orderEditForm.route} onValueChange={(value) => setOrderEditForm({...orderEditForm, route: value})}>
                      <SelectTrigger>
                        <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –º–∞—Ä—à—Ä—É—Ç" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="moscow_to_tajikistan">–ú–æ—Å–∫–≤–∞ ‚Üí –¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω</SelectItem>
                        <SelectItem value="tajikistan_to_moscow">–¢–∞–¥–∂–∏–∫–∏—Å—Ç–∞–Ω ‚Üí –ú–æ—Å–∫–≤–∞</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div>
                    <Label htmlFor="weight">–í–µ—Å (–∫–≥)</Label>
                    <Input
                      id="weight"
                      type="number"
                      value={orderEditForm.weight}
                      onChange={(e) => setOrderEditForm({...orderEditForm, weight: e.target.value})}
                      placeholder="1.5"
                      step="0.1"
                    />
                  </div>
                  <div>
                    <Label htmlFor="declared_value">–û–±—ä—è–≤–ª–µ–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</Label>
                    <Input
                      id="declared_value"
                      type="number"
                      value={orderEditForm.declared_value}
                      onChange={(e) => setOrderEditForm({...orderEditForm, declared_value: e.target.value})}
                      placeholder="10000"
                    />
                  </div>
                  <div className="md:col-span-2">
                    <Label htmlFor="description">–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–∑–∞</Label>
                    <Textarea
                      id="description"
                      value={orderEditForm.description}
                      onChange={(e) => setOrderEditForm({...orderEditForm, description: e.target.value})}
                      placeholder="–ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–∑–∞"
                      rows={3}
                    />
                  </div>
                </div>
              </div>

              {/* –ó–∞–º–µ—Ç–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ */}
              <div className="border rounded-lg p-4 bg-blue-50">
                <h3 className="font-semibold text-lg mb-4 flex items-center">
                  <FileText className="w-5 h-5 mr-2 text-blue-600" />
                  –ó–∞–º–µ—Ç–∫–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                </h3>
                <Textarea
                  value={orderEditForm.admin_notes}
                  onChange={(e) => setOrderEditForm({...orderEditForm, admin_notes: e.target.value})}
                  placeholder="–î–æ–±–∞–≤—å—Ç–µ –∑–∞–º–µ—Ç–∫–∏ –ø–æ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∑–∞–∫–∞–∑–∞..."
                  rows={3}
                />
              </div>

              {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
              <div className="flex justify-between items-center pt-4 border-t">
                <Button 
                  type="button" 
                  variant="outline" 
                  onClick={() => {
                    setEditOrderModal(false);
                    setOrderEditForm({
                      sender_full_name: '',
                      sender_phone: '',
                      recipient_full_name: '',
                      recipient_phone: '',
                      recipient_address: '',
                      pickup_address: '',
                      cargo_name: '',
                      weight: '',
                      declared_value: '',
                      description: '',
                      route: '',
                      admin_notes: ''
                    });
                  }}
                >
                  –û—Ç–º–µ–Ω–∞
                </Button>
                <div className="space-x-2">
                  <Button type="submit" className="bg-blue-600 hover:bg-blue-700">
                    <Save className="w-4 h-4 mr-2" />
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                  </Button>
                </div>
              </div>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê –î–õ–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø –†–ê–ó–ú–ï–©–ï–ù–ò–ï–ú –ì–†–£–ó–û–í */}

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≥—Ä—É–∑–∞ */}
      <Dialog open={cargoDetailsModal} onOpenChange={setCargoDetailsModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Package className="w-5 h-5 mr-2 text-blue-600" />
              –ü–æ–¥—Ä–æ–±–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ ‚Ññ{selectedCargoForDetailView?.cargo_number}
            </DialogTitle>
            <DialogDescription>
              –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ, –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ, –ø–æ–ª—É—á–∞—Ç–µ–ª–µ –∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–µ
            </DialogDescription>
          </DialogHeader>
          
          {selectedCargoForDetailView && (
            <div className="space-y-6">
              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ */}
              <div className="p-4 bg-blue-50 rounded-lg">
                <h3 className="font-bold text-lg text-blue-700 mb-3">üì¶ –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600"><strong>–ù–æ–º–µ—Ä –≥—Ä—É–∑–∞:</strong></p>
                    <p className="font-medium text-lg">{selectedCargoForDetailView.cargo_number}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.cargo_name}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>–í–µ—Å:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.weight} –∫–≥</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>–û–±—ä—è–≤–ª–µ–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.declared_value} ‚ÇΩ</p>
                  </div>
                  <div className="col-span-2">
                    <p className="text-sm text-gray-600"><strong>–û–ø–∏—Å–∞–Ω–∏–µ:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.description}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>–ú–∞—Ä—à—Ä—É—Ç:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.route}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>–°—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏:</strong></p>
                    <Badge variant={getProcessingStatusBadgeVariant(selectedCargoForDetailView.processing_status)}>
                      {getProcessingStatusLabel(selectedCargoForDetailView.processing_status)}
                    </Badge>
                  </div>
                </div>
              </div>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ */}
              <div className="p-4 bg-green-50 rounded-lg">
                <h3 className="font-bold text-lg text-green-700 mb-3">üë§ –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600"><strong>–ü–æ–ª–Ω–æ–µ –∏–º—è:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.sender_full_name}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.sender_phone}</p>
                  </div>
                  <div className="col-span-2">
                    <p className="text-sm text-gray-600"><strong>–ê–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.sender_address}</p>
                  </div>
                </div>
              </div>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ */}
              <div className="p-4 bg-yellow-50 rounded-lg">
                <h3 className="font-bold text-lg text-yellow-700 mb-3">üìç –ü–æ–ª—É—á–∞—Ç–µ–ª—å</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600"><strong>–ü–æ–ª–Ω–æ–µ –∏–º—è:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.recipient_name}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.recipient_phone}</p>
                  </div>
                  <div className="col-span-2">
                    <p className="text-sm text-gray-600"><strong>–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.recipient_address}</p>
                  </div>
                </div>
              </div>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–µ—Ä–∞—Ç–æ—Ä–µ */}
              <div className="p-4 bg-purple-50 rounded-lg">
                <h3 className="font-bold text-lg text-purple-700 mb-3">üë®‚Äçüíº –û–ø–µ—Ä–∞—Ç–æ—Ä</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600"><strong>–û–ø–µ—Ä–∞—Ç–æ—Ä, –ø—Ä–∏–Ω—è–≤—à–∏–π –≥—Ä—É–∑:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.accepting_operator}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞:</strong></p>
                    <p className="font-medium">
                      {new Date(selectedCargoForDetailView.created_at).toLocaleDateString('ru-RU')} {' '}
                      {new Date(selectedCargoForDetailView.created_at).toLocaleTimeString('ru-RU')}
                    </p>
                  </div>
                  {selectedCargoForDetailView.warehouse_location && (
                    <>
                      <div>
                        <p className="text-sm text-gray-600"><strong>–†–∞–∑–º–µ—â–µ–Ω–∏–µ:</strong></p>
                        <p className="font-medium text-blue-600">{selectedCargoForDetailView.warehouse_location}</p>
                      </div>
                      <div>
                        <p className="text-sm text-gray-600"><strong>–†–∞–∑–º–µ—â–µ–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º:</strong></p>
                        <p className="font-medium">{selectedCargoForDetailView.placed_by_operator || '–ù–µ —Ä–∞–∑–º–µ—â–µ–Ω'}</p>
                      </div>
                    </>
                  )}
                </div>
              </div>

              {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
              <div className="flex justify-end space-x-4">
                <Button variant="outline" onClick={() => setCargoDetailsModal(false)}>
                  –ó–∞–∫—Ä—ã—Ç—å
                </Button>
                {(selectedCargoForDetailView.processing_status === 'paid' || selectedCargoForDetailView.processing_status === 'invoice_printed') && !selectedCargoForDetailView.warehouse_location && (
                  <Button
                    onClick={() => {
                      setCargoDetailsModal(false);
                      setCargoMoveModal(true);
                    }}
                    className="bg-blue-600 hover:bg-blue-700 text-white"
                  >
                    <Grid3X3 className="mr-2 h-4 w-4" />
                    –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≥—Ä—É–∑
                  </Button>
                )}
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞ */}
      <Dialog open={cargoMoveModal} onOpenChange={setCargoMoveModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Grid3X3 className="w-5 h-5 mr-2 text-blue-600" />
              –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≥—Ä—É–∑
            </DialogTitle>
            <DialogDescription>
              –ì—Ä—É–∑ ‚Ññ{selectedCargoForWarehouse?.cargo_number}
              <br />
              –¢–µ–∫—É—â–µ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ: {selectedCargoForWarehouse?.warehouse_location}
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4">
            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ */}
            {selectedCargoForWarehouse && (
              <div className="p-3 bg-gray-50 rounded-lg">
                <p className="font-medium text-lg">{selectedCargoForWarehouse.cargo_number}</p>
                <p className="text-sm text-gray-600">{selectedCargoForWarehouse.cargo_name}</p>
                <p className="text-sm text-gray-600">–í–µ—Å: {selectedCargoForWarehouse.weight} –∫–≥</p>
              </div>
            )}

            {/* –§–æ—Ä–º–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è */}
            <div className="grid grid-cols-3 gap-4">
              <div>
                <Label>–ù–æ–≤—ã–π –±–ª–æ–∫</Label>
                <Input
                  type="number"
                  min="1"
                  max="9"
                  value={cargoMoveForm.to_block}
                  onChange={(e) => setCargoMoveForm({
                    ...cargoMoveForm,
                    to_block: parseInt(e.target.value) || 1
                  })}
                />
              </div>
              <div>
                <Label>–ù–æ–≤–∞—è –ø–æ–ª–∫–∞</Label>
                <Input
                  type="number"
                  min="1"
                  max="3"
                  value={cargoMoveForm.to_shelf}
                  onChange={(e) => setCargoMoveForm({
                    ...cargoMoveForm,
                    to_shelf: parseInt(e.target.value) || 1
                  })}
                />
              </div>
              <div>
                <Label>–ù–æ–≤–∞—è —è—á–µ–π–∫–∞</Label>
                <Input
                  type="number"
                  min="1"
                  max="50"
                  value={cargoMoveForm.to_cell}
                  onChange={(e) => setCargoMoveForm({
                    ...cargoMoveForm,
                    to_cell: parseInt(e.target.value) || 1
                  })}
                />
              </div>
            </div>

            <div className="p-2 bg-blue-50 rounded text-sm text-blue-700">
              <strong>–ù–æ–≤–æ–µ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong> –ë{cargoMoveForm.to_block}-–ü{cargoMoveForm.to_shelf}-–Ø{cargoMoveForm.to_cell}
            </div>

            {/* –ö–Ω–æ–ø–∫–∏ */}
            <div className="flex justify-end space-x-4 pt-4">
              <Button variant="outline" onClick={() => {
                setCargoMoveModal(false);
                setCargoMoveForm({
                  to_block: 1,
                  to_shelf: 1,
                  to_cell: 1
                });
              }}>
                –û—Ç–º–µ–Ω–∞
              </Button>
              <Button
                onClick={handleCargoMove}
                className="bg-blue-600 hover:bg-blue-700 text-white"
              >
                <Grid3X3 className="mr-2 h-4 w-4" />
                –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */}
      <Dialog open={showRoleModal} onOpenChange={setShowRoleModal}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader>
            <DialogTitle>–ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</DialogTitle>
            <DialogDescription>
              –ò–∑–º–µ–Ω–µ–Ω–∏–µ —Ä–æ–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è {selectedUserForRole?.full_name}
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            {selectedUserForRole && (
              <div className="bg-gray-50 p-3 rounded-lg">
                <div className="text-sm">
                  <p><strong>–ù–æ–º–µ—Ä:</strong> {selectedUserForRole.user_number || 'N/A'}</p>
                  <p><strong>–§–ò–û:</strong> {selectedUserForRole.full_name}</p>
                  <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {selectedUserForRole.phone}</p>
                  <p><strong>–¢–µ–∫—É—â–∞—è —Ä–æ–ª—å:</strong> {getRoleLabel(selectedUserForRole.role)}</p>
                </div>
              </div>
            )}
            
            <div>
              <Label htmlFor="role-select">–ù–æ–≤–∞—è —Ä–æ–ª—å</Label>
              <Select value={newRole} onValueChange={setNewRole}>
                <SelectTrigger>
                  <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Ä–æ–ª—å" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</SelectItem>
                  <SelectItem value="warehouse_operator">–û–ø–µ—Ä–∞—Ç–æ—Ä —Å–∫–ª–∞–¥–∞</SelectItem>
                  <SelectItem value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>
          
          <div className="flex justify-end space-x-2 mt-6">
            <Button 
              variant="outline" 
              onClick={() => {
                setShowRoleModal(false);
                setSelectedUserForRole(null);
                setNewRole('');
              }}
            >
              –û—Ç–º–µ–Ω–∞
            </Button>
            <Button 
              onClick={handleRoleChange}
              disabled={!newRole || newRole === selectedUserForRole?.role}
            >
              –ò–∑–º–µ–Ω–∏—Ç—å —Ä–æ–ª—å
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ */}
      <Dialog open={showOperatorProfile} onOpenChange={setShowOperatorProfile}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>–ü—Ä–æ—Ñ–∏–ª—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å–∫–ª–∞–¥–∞</DialogTitle>
            <DialogDescription>
              –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–±–æ—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
            </DialogDescription>
          </DialogHeader>
          
          {profileLoading ? (
            <div className="text-center py-8">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
              <p className="mt-2 text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...</p>
            </div>
          ) : selectedOperatorProfile && (
            <div className="space-y-6">
              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–µ—Ä–∞—Ç–æ—Ä–µ */}
              <div className="bg-blue-50 p-4 rounded-lg">
                <h3 className="font-semibold text-lg mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–µ—Ä–∞—Ç–æ—Ä–µ</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div>
                    <label className="text-sm font-medium text-gray-500">–ù–æ–º–µ—Ä</label>
                    <p className="text-lg">{selectedOperatorProfile.user_info.user_number}</p>
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-500">–§–ò–û</label>
                    <p className="text-lg">{selectedOperatorProfile.user_info.full_name}</p>
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-500">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <p className="text-lg">{selectedOperatorProfile.user_info.phone}</p>
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-500">–°—Ç–∞—Ç—É—Å</label>
                    <Badge variant={selectedOperatorProfile.user_info.is_active ? 'default' : 'secondary'}>
                      {selectedOperatorProfile.user_info.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω'}
                    </Badge>
                  </div>
                </div>
              </div>

              {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã */}
              <div className="bg-green-50 p-4 rounded-lg">
                <h3 className="font-semibold text-lg mb-3">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="bg-white p-3 rounded border text-center">
                    <div className="text-2xl font-bold text-blue-600">
                      {selectedOperatorProfile.work_statistics.total_cargo_accepted}
                    </div>
                    <div className="text-sm text-gray-600">–í—Å–µ–≥–æ –≥—Ä—É–∑–æ–≤</div>
                  </div>
                  <div className="bg-white p-3 rounded border text-center">
                    <div className="text-2xl font-bold text-green-600">
                      {selectedOperatorProfile.work_statistics.recent_cargo_count}
                    </div>
                    <div className="text-sm text-gray-600">–ó–∞ 30 –¥–Ω–µ–π</div>
                  </div>
                  <div className="bg-white p-3 rounded border text-center">
                    <div className="text-2xl font-bold text-orange-600">
                      {selectedOperatorProfile.work_statistics.avg_cargo_per_day}
                    </div>
                    <div className="text-sm text-gray-600">–í –¥–µ–Ω—å (—Å—Ä–µ–¥–Ω.)</div>
                  </div>
                  <div className="bg-white p-3 rounded border text-center">
                    <div className="text-2xl font-bold text-purple-600">
                      {selectedOperatorProfile.associated_warehouses.length}
                    </div>
                    <div className="text-sm text-gray-600">–°–∫–ª–∞–¥–æ–≤</div>
                  </div>
                </div>
              </div>

              {/* –°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–∫–ª–∞–¥—ã */}
              {selectedOperatorProfile.associated_warehouses.length > 0 && (
                <div>
                  <h3 className="font-semibold text-lg mb-3">–°–≤—è–∑–∞–Ω–Ω—ã–µ —Å–∫–ª–∞–¥—ã</h3>
                  <div className="space-y-2">
                    {selectedOperatorProfile.associated_warehouses.map((warehouse, index) => (
                      <div key={`operator-warehouse-${warehouse.id || index}-${warehouse.name}`} className="bg-white border rounded-lg p-3">
                        <div className="flex justify-between items-center">
                          <div>
                            <h4 className="font-medium">{warehouse.name}</h4>
                            <p className="text-sm text-gray-600">{warehouse.location}</p>
                          </div>
                          <div className="text-right">
                            <div className="text-sm font-medium">{warehouse.cargo_count} –≥—Ä—É–∑–æ–≤</div>
                            <div className="text-xs text-gray-500">
                              {warehouse.binding_date && new Date(warehouse.binding_date).toLocaleDateString('ru-RU')}
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* –ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å */}
              {selectedOperatorProfile.recent_activity.length > 0 && (
                <div>
                  <h3 className="font-semibold text-lg mb-3">–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</h3>
                  <div className="space-y-2 max-h-64 overflow-y-auto">
                    {selectedOperatorProfile.recent_activity.map((activity, index) => (
                      <div key={`activity-${activity.cargo_number || index}-${activity.cargo_name}`} className="bg-white border rounded-lg p-3">
                        <div className="flex justify-between items-start">
                          <div>
                            <h4 className="font-medium">{activity.cargo_number}</h4>
                            <p className="text-sm text-gray-600">{activity.cargo_name}</p>
                            <p className="text-sm text-gray-500">–û—Ç: {activity.sender_full_name}</p>
                          </div>
                          <div className="text-right">
                            <Badge variant="outline">{activity.processing_status}</Badge>
                            <div className="text-xs text-gray-500 mt-1">
                              {new Date(activity.created_at).toLocaleDateString('ru-RU')}
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */}
      <Dialog open={showUserProfile} onOpenChange={setShowUserProfile}>
        <DialogContent className="max-w-5xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>–ü—Ä–æ—Ñ–∏–ª—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</DialogTitle>
            <DialogDescription>
              –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π
            </DialogDescription>
          </DialogHeader>
          
          {profileLoading ? (
            <div className="text-center py-8">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
              <p className="mt-2 text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è...</p>
            </div>
          ) : selectedUserProfile && (
            <div className="space-y-6">
              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ */}
              <div className="bg-blue-50 p-4 rounded-lg">
                <div className="flex justify-between items-start mb-3">
                  <h3 className="font-semibold text-lg">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ</h3>
                  {(user.role === 'warehouse_operator' || user.role === 'admin') && (
                    <Button
                      size="sm"
                      onClick={() => openQuickCargoFromProfile(selectedUserProfile.user_info)}
                      className="bg-green-600 hover:bg-green-700"
                    >
                      <Plus className="mr-2 h-4 w-4" />
                      –û—Ñ–æ—Ä–º–∏—Ç—å –≥—Ä—É–∑—ã
                    </Button>
                  )}
                </div>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div>
                    <label className="text-sm font-medium text-gray-500">–ù–æ–º–µ—Ä</label>
                    <p className="text-lg">{selectedUserProfile.user_info.user_number}</p>
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-500">–§–ò–û</label>
                    <p className="text-lg">{selectedUserProfile.user_info.full_name}</p>
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-500">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                    <p className="text-lg">{selectedUserProfile.user_info.phone}</p>
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-500">–†–æ–ª—å</label>
                    <Badge variant="outline">{getRoleLabel(selectedUserProfile.user_info.role)}</Badge>
                  </div>
                </div>
              </div>

              {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π */}
              <div className="bg-green-50 p-4 rounded-lg">
                <h3 className="font-semibold text-lg mb-3">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="bg-white p-3 rounded border text-center">
                    <div className="text-2xl font-bold text-blue-600">
                      {selectedUserProfile.shipping_statistics.total_sent_cargo}
                    </div>
                    <div className="text-sm text-gray-600">–û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ</div>
                  </div>
                  <div className="bg-white p-3 rounded border text-center">
                    <div className="text-2xl font-bold text-green-600">
                      {selectedUserProfile.shipping_statistics.total_received_cargo}
                    </div>
                    <div className="text-sm text-gray-600">–ü–æ–ª—É—á–µ–Ω–æ</div>
                  </div>
                  <div className="bg-white p-3 rounded border text-center">
                    <div className="text-2xl font-bold text-orange-600">
                      {selectedUserProfile.shipping_statistics.total_cargo_requests}
                    </div>
                    <div className="text-sm text-gray-600">–ó–∞—è–≤–æ–∫</div>
                  </div>
                  <div className="bg-white p-3 rounded border text-center">
                    <div className="text-2xl font-bold text-purple-600">
                      {selectedUserProfile.frequent_recipients.length}
                    </div>
                    <div className="text-sm text-gray-600">–ü–æ–ª—É—á–∞—Ç–µ–ª–µ–π</div>
                  </div>
                </div>
              </div>

              {/* –ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–∏ */}
              {selectedUserProfile.frequent_recipients.length > 0 && (
                <div>
                  <h3 className="font-semibold text-lg mb-3">–ß–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª–∏</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-48 overflow-y-auto">
                    {selectedUserProfile.frequent_recipients.slice(0, 6).map((recipient, index) => (
                      <div key={`recipient-${index}-${recipient.recipient_full_name}`} className="bg-white border rounded-lg p-3">
                        <div className="flex justify-between items-start">
                          <div>
                            <h4 className="font-medium">{recipient.recipient_full_name}</h4>
                            <p className="text-sm text-gray-600">{recipient.recipient_phone}</p>
                            <p className="text-xs text-gray-500">{recipient.recipient_address}</p>
                          </div>
                          <div className="text-right">
                            <div className="text-sm font-medium">{recipient.shipment_count} —Ä–∞–∑</div>
                            <div className="text-xs text-gray-500">
                              {recipient.last_sent && new Date(recipient.last_sent).toLocaleDateString('ru-RU')}
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* –ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
              {selectedUserProfile.recent_shipments.length > 0 && (
                <div>
                  <h3 className="font-semibold text-lg mb-3">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è</h3>
                  <div className="space-y-2 max-h-64 overflow-y-auto">
                    {selectedUserProfile.recent_shipments.slice(0, 8).map((shipment, index) => (
                      <div key={`shipment-${shipment.cargo_number || index}-${shipment.cargo_name}`} className="bg-white border rounded-lg p-3">
                        <div className="flex justify-between items-start">
                          <div>
                            <h4 className="font-medium">{shipment.cargo_number} - {shipment.cargo_name}</h4>
                            <p className="text-sm text-gray-600">
                              {shipment.weight} –∫–≥ ‚Ä¢ {shipment.declared_value} —Ä—É–±
                            </p>
                            <p className="text-sm text-gray-500">
                              –ü–æ–ª—É—á–∞—Ç–µ–ª—å: {shipment.recipient_full_name}
                            </p>
                          </div>
                          <div className="text-right">
                            <Badge variant="outline">{shipment.status}</Badge>
                            <div className="text-xs text-gray-500 mt-1">
                              {new Date(shipment.created_at).toLocaleDateString('ru-RU')}
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –±—ã—Å—Ç—Ä–æ–≥–æ —Å–æ–∑–¥–∞–Ω–∏—è –≥—Ä—É–∑–∞ */}
      <Dialog open={showQuickCargoModal} onOpenChange={setShowQuickCargoModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>–ë—ã—Å—Ç—Ä–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–∑–∞</DialogTitle>
            <DialogDescription>
              –°–æ–∑–¥–∞–Ω–∏–µ –≥—Ä—É–∑–∞ —Å –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-6">
            {/* –í—ã–±–æ—Ä –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏ */}
            {frequentRecipients.length > 0 && (
              <div className="bg-blue-50 p-4 rounded-lg">
                <h3 className="font-semibold text-lg mb-3">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∏–∑ –∏—Å—Ç–æ—Ä–∏–∏</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-32 overflow-y-auto">
                  {frequentRecipients.slice(0, 6).map((recipient, index) => (
                    <button
                      key={`frequent-recipient-${index}-${recipient.recipient_phone}`}
                      className={`p-2 text-left rounded border ${
                        selectedRecipient?.recipient_phone === recipient.recipient_phone
                          ? 'bg-blue-100 border-blue-300'
                          : 'bg-white hover:bg-gray-50'
                      }`}
                      onClick={() => selectRecipientFromHistory(recipient)}
                    >
                      <div className="font-medium text-sm">{recipient.recipient_full_name}</div>
                      <div className="text-xs text-gray-600">{recipient.recipient_phone}</div>
                      <div className="text-xs text-gray-500">{recipient.shipment_count} –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏–π</div>
                    </button>
                  ))}
                </div>
              </div>
            )}

            {/* –î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è */}
            <div>
              <h3 className="font-semibold text-lg mb-3">–î–∞–Ω–Ω—ã–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div>
                  <Label>–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è</Label>
                  <Input
                    value={quickCargoForm.recipient_data.recipient_full_name || ''}
                    onChange={(e) => setQuickCargoForm({
                      ...quickCargoForm,
                      recipient_data: {
                        ...quickCargoForm.recipient_data,
                        recipient_full_name: e.target.value
                      }
                    })}
                    required
                  />
                </div>
                <div>
                  <Label>–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è</Label>
                  <Input
                    value={quickCargoForm.recipient_data.recipient_phone || ''}
                    onChange={(e) => setQuickCargoForm({
                      ...quickCargoForm,
                      recipient_data: {
                        ...quickCargoForm.recipient_data,
                        recipient_phone: e.target.value
                      }
                    })}
                    required
                  />
                </div>
                <div>
                  <Label>–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è</Label>
                  <Input
                    value={quickCargoForm.recipient_data.recipient_address || ''}
                    onChange={(e) => setQuickCargoForm({
                      ...quickCargoForm,
                      recipient_data: {
                        ...quickCargoForm.recipient_data,
                        recipient_address: e.target.value
                      }
                    })}
                    required
                  />
                </div>
              </div>
            </div>

            {/* –ì—Ä—É–∑—ã */}
            <div className="bg-green-50 p-4 rounded-lg">
              <h3 className="font-semibold text-lg mb-3">–ì—Ä—É–∑—ã</h3>
              {quickCargoForm.cargo_items.map((item, index) => (
                <div key={`quick-cargo-${index}-${item.cargo_name || 'empty'}`} className="mb-4 p-3 bg-white rounded border">
                  <div className="flex items-center justify-between mb-2">
                    <span className="font-medium text-sm">–ì—Ä—É–∑ #{index + 1}</span>
                    {quickCargoForm.cargo_items.length > 1 && (
                      <Button
                        type="button"
                        variant="outline"
                        size="sm"
                        onClick={() => removeQuickCargoItem(index)}
                      >
                        <X className="h-4 w-4" />
                      </Button>
                    )}
                  </div>
                  
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                      <Label>–ù–∞–∑–≤–∞–Ω–∏–µ</Label>
                      <Input
                        value={item.cargo_name}
                        onChange={(e) => updateQuickCargoItem(index, 'cargo_name', e.target.value)}
                        placeholder="–î–æ–∫—É–º–µ–Ω—Ç—ã, –æ–¥–µ–∂–¥–∞..."
                        required
                      />
                    </div>
                    <div>
                      <Label>–í–µ—Å (–∫–≥)</Label>
                      <Input
                        type="number"
                        step="0.1"
                        value={item.weight}
                        onChange={(e) => updateQuickCargoItem(index, 'weight', e.target.value)}
                        required
                      />
                    </div>
                    <div>
                      <Label>–¶–µ–Ω–∞ –∑–∞ –∫–≥ (—Ä—É–±.)</Label>
                      <Input
                        type="number"
                        step="0.01"
                        value={item.price_per_kg}
                        onChange={(e) => updateQuickCargoItem(index, 'price_per_kg', e.target.value)}
                        required
                      />
                    </div>
                  </div>
                  
                  {item.weight && item.price_per_kg && (
                    <div className="mt-2 p-2 bg-gray-50 rounded text-sm">
                      –°—Ç–æ–∏–º–æ—Å—Ç—å: {parseFloat(item.weight)} –∫–≥ √ó {parseFloat(item.price_per_kg)} —Ä—É–±/–∫–≥ = 
                      <span className="font-semibold text-green-600 ml-1">
                        {(parseFloat(item.weight) * parseFloat(item.price_per_kg)).toFixed(2)} —Ä—É–±
                      </span>
                    </div>
                  )}
                </div>
              ))}
              
              <Button
                type="button"
                variant="outline"
                onClick={addQuickCargoItem}
                className="w-full"
              >
                <Plus className="mr-2 h-4 w-4" />
                –î–æ–±–∞–≤–∏—Ç—å –µ—â–µ –≥—Ä—É–∑
              </Button>
            </div>

            {/* –ò—Ç–æ–≥–∏ */}
            <div className="bg-gray-50 p-4 rounded-lg">
              <h3 className="font-semibold text-lg mb-2">–ò—Ç–æ–≥–æ</h3>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <span className="text-sm text-gray-600">–û–±—â–∏–π –≤–µ—Å:</span>
                  <div className="text-xl font-bold text-blue-600">
                    {calculateQuickCargoTotals().totalWeight.toFixed(1)} –∫–≥
                  </div>
                </div>
                <div>
                  <span className="text-sm text-gray-600">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                  <div className="text-xl font-bold text-green-600">
                    {calculateQuickCargoTotals().totalCost.toFixed(2)} —Ä—É–±
                  </div>
                </div>
              </div>
            </div>

            {/* –û–ø–∏—Å–∞–Ω–∏–µ */}
            <div>
              <Label>–û–ø–∏—Å–∞–Ω–∏–µ –≥—Ä—É–∑–∞</Label>
              <textarea
                className="w-full p-2 border rounded-md"
                rows="3"
                value={quickCargoForm.description}
                onChange={(e) => setQuickCargoForm({...quickCargoForm, description: e.target.value})}
                placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ..."
                required
              />
            </div>

            <div className="flex justify-end space-x-2">
              <Button 
                variant="outline" 
                onClick={() => setShowQuickCargoModal(false)}
              >
                –û—Ç–º–µ–Ω–∞
              </Button>
              <Button 
                onClick={submitQuickCargo}
                disabled={
                  !quickCargoForm.recipient_data.recipient_full_name ||
                  !quickCargoForm.recipient_data.recipient_phone ||
                  !quickCargoForm.description ||
                  quickCargoForm.cargo_items.some(item => !item.cargo_name || !item.weight || !item.price_per_kg)
                }
              >
                –°–æ–∑–¥–∞—Ç—å –≥—Ä—É–∑
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø—Ä–æ—Ñ–∏–ª—è */}
      <Dialog open={showEditProfile} onOpenChange={setShowEditProfile}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è</DialogTitle>
            <DialogDescription>
              –û–±–Ω–æ–≤–∏—Ç–µ —Å–≤–æ–∏ –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <Label htmlFor="edit_full_name">–ü–æ–ª–Ω–æ–µ –∏–º—è</Label>
              <Input
                id="edit_full_name"
                value={editProfileForm.full_name}
                onChange={(e) => setEditProfileForm({...editProfileForm, full_name: e.target.value})}
                placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è"
              />
            </div>
            <div>
              <Label htmlFor="edit_phone">–¢–µ–ª–µ—Ñ–æ–Ω</Label>
              <Input
                id="edit_phone"
                value={editProfileForm.phone}
                onChange={(e) => setEditProfileForm({...editProfileForm, phone: e.target.value})}
                placeholder="+7XXXXXXXXXX"
              />
            </div>
            <div>
              <Label htmlFor="edit_email">Email (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</Label>
              <Input
                id="edit_email"
                type="email"
                value={editProfileForm.email}
                onChange={(e) => setEditProfileForm({...editProfileForm, email: e.target.value})}
                placeholder="example@email.com"
              />
            </div>
            <div>
              <Label htmlFor="edit_address">–ê–¥—Ä–µ—Å (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</Label>
              <Textarea
                id="edit_address"
                value={editProfileForm.address}
                onChange={(e) => setEditProfileForm({...editProfileForm, address: e.target.value})}
                placeholder="–í–≤–µ–¥–∏—Ç–µ –≤–∞—à –∞–¥—Ä–µ—Å"
                rows={3}
              />
            </div>
            <div className="flex justify-end space-x-2">
              <Button variant="outline" onClick={() => setShowEditProfile(false)}>
                –û—Ç–º–µ–Ω–∞
              </Button>
              <Button onClick={saveProfile}>
                <Save className="mr-2 h-4 w-4" />
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ */}
      <Dialog open={showRepeatOrderModal} onOpenChange={setShowRepeatOrderModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑</DialogTitle>
            <DialogDescription>
              –°–æ–∑–¥–∞–π—Ç–µ –Ω–æ–≤—ã–π –∑–∞–∫–∞–∑ –Ω–∞ –æ—Å–Ω–æ–≤–µ –¥–∞–Ω–Ω—ã—Ö –≥—Ä—É–∑–∞ #{repeatOrderData?.cargo_number}
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-6">
            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <Label htmlFor="repeat_recipient_name">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</Label>
                <Input
                  id="repeat_recipient_name"
                  value={repeatOrderForm.recipient_full_name}
                  onChange={(e) => setRepeatOrderForm({...repeatOrderForm, recipient_full_name: e.target.value})}
                  placeholder="–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è"
                />
              </div>
              <div>
                <Label htmlFor="repeat_recipient_phone">–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è</Label>
                <Input
                  id="repeat_recipient_phone"
                  value={repeatOrderForm.recipient_phone}
                  onChange={(e) => setRepeatOrderForm({...repeatOrderForm, recipient_phone: e.target.value})}
                  placeholder="+992XXXXXXXXX"
                />
              </div>
            </div>

            <div>
              <Label htmlFor="repeat_recipient_address">–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è</Label>
              <Textarea
                id="repeat_recipient_address"
                value={repeatOrderForm.recipient_address}
                onChange={(e) => setRepeatOrderForm({...repeatOrderForm, recipient_address: e.target.value})}
                placeholder="–ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏"
                rows={2}
              />
            </div>

            {/* –ú–∞—Ä—à—Ä—É—Ç */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <Label htmlFor="repeat_route">–ú–∞—Ä—à—Ä—É—Ç</Label>
                <Select value={repeatOrderForm.route} onValueChange={(value) => setRepeatOrderForm({...repeatOrderForm, route: value})}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="moscow_dushanbe">–ú–æ—Å–∫–≤–∞ ‚Üí –î—É—à–∞–Ω–±–µ</SelectItem>
                    <SelectItem value="moscow_khujand">–ú–æ—Å–∫–≤–∞ ‚Üí –•—É–¥–∂–∞–Ω–¥</SelectItem>
                    <SelectItem value="moscow_kulob">–ú–æ—Å–∫–≤–∞ ‚Üí –ö—É–ª–æ–±</SelectItem>
                    <SelectItem value="moscow_kurgantyube">–ú–æ—Å–∫–≤–∞ ‚Üí –ö—É—Ä–≥–∞–Ω-–¢—é–±–µ</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label htmlFor="repeat_delivery_type">–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏</Label>
                <Select value={repeatOrderForm.delivery_type} onValueChange={(value) => setRepeatOrderForm({...repeatOrderForm, delivery_type: value})}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="standard">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</SelectItem>
                    <SelectItem value="express">–≠–∫—Å–ø—Ä–µ—Å—Å</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            {/* –ú—É–ª—å—Ç–∏-–≥—Ä—É–∑ —Ñ–æ—Ä–º–∞ —Å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º */}
            <div className="border rounded-lg p-4">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-medium">–ì—Ä—É–∑—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏</h3>
                <Button
                  type="button"
                  variant="outline"
                  size="sm"
                  onClick={addRepeatOrderItem}
                >
                  <Plus className="mr-1 h-4 w-4" />
                  –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–∑
                </Button>
              </div>

              {/* –°–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤ */}
              <div className="space-y-4">
                {repeatOrderForm.cargo_items.map((item, index) => (
                  <div key={`repeat-cargo-${index}-${item.cargo_name || 'empty'}`} className="grid grid-cols-12 gap-4 items-end border rounded p-3 bg-gray-50">
                    <div className="col-span-4">
                      <Label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞</Label>
                      <Input
                        value={item.cargo_name}
                        onChange={(e) => handleRepeatOrderItemChange(index, 'cargo_name', e.target.value)}
                        placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞"
                      />
                    </div>
                    <div className="col-span-3">
                      <Label>–í–µ—Å (–∫–≥)</Label>
                      <Input
                        type="number"
                        value={item.weight}
                        onChange={(e) => handleRepeatOrderItemChange(index, 'weight', e.target.value)}
                        placeholder="0.0"
                        step="0.1"
                      />
                    </div>
                    <div className="col-span-3">
                      <Label>–¶–µ–Ω–∞ –∑–∞ –∫–≥ (‚ÇΩ)</Label>
                      <Input
                        type="number"
                        value={item.price_per_kg}
                        onChange={(e) => handleRepeatOrderItemChange(index, 'price_per_kg', e.target.value)}
                        placeholder="50"
                        step="0.01"
                      />
                    </div>
                    <div className="col-span-1">
                      <Label className="text-xs text-gray-600">–°—Ç–æ–∏–º–æ—Å—Ç—å</Label>
                      <div className="text-sm font-medium">
                        {((parseFloat(item.weight) || 0) * (parseFloat(item.price_per_kg) || 0)).toFixed(2)} ‚ÇΩ
                      </div>
                    </div>
                    <div className="col-span-1">
                      {repeatOrderForm.cargo_items.length > 1 && (
                        <Button
                          type="button"
                          variant="outline"
                          size="sm"
                          onClick={() => removeRepeatOrderItem(index)}
                          className="text-red-600 hover:text-red-700"
                        >
                          <Minus className="h-4 w-4" />
                        </Button>
                      )}
                    </div>
                  </div>
                ))}
              </div>

              {/* –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∏—Ç–æ–≥–æ–≤ */}
              <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                <h4 className="font-medium mb-3">–†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏</h4>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div className="text-center">
                    <div className="text-2xl font-bold text-blue-600">
                      {repeatOrderTotalWeight.toFixed(2)} –∫–≥
                    </div>
                    <div className="text-sm text-gray-600">–û–±—â–∏–π –≤–µ—Å</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-bold text-green-600">
                      {repeatOrderTotalCost.toFixed(2)} ‚ÇΩ
                    </div>
                    <div className="text-sm text-gray-600">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-bold text-purple-600">
                      {repeatOrderForm.cargo_items.length}
                    </div>
                    <div className="text-sm text-gray-600">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–∑–æ–≤</div>
                  </div>
                </div>

                {/* –î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑–±–∏–≤–∫–∞ */}
                {repeatOrderBreakdown.length > 0 && (
                  <div className="mt-4">
                    <h5 className="text-sm font-medium mb-2">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –≥—Ä—É–∑–∞–º:</h5>
                    <div className="space-y-1">
                      {repeatOrderBreakdown.map((item, index) => (
                        <div key={`repeat-breakdown-${index}-${item.name}`} className="flex justify-between text-sm">
                          <span>{item.cargo_name}: {item.weight}–∫–≥ √ó {item.price_per_kg}‚ÇΩ</span>
                          <span className="font-medium">{item.cost.toFixed(2)} ‚ÇΩ</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ */}
            <div>
              <Label htmlFor="repeat_special_instructions">–û—Å–æ–±—ã–µ —É–∫–∞–∑–∞–Ω–∏—è</Label>
              <Textarea
                id="repeat_special_instructions"
                value={repeatOrderForm.special_instructions}
                onChange={(e) => setRepeatOrderForm({...repeatOrderForm, special_instructions: e.target.value})}
                placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏"
                rows={2}
              />
            </div>

            {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
            <div className="flex justify-end space-x-2">
              <Button variant="outline" onClick={() => setShowRepeatOrderModal(false)}>
                –û—Ç–º–µ–Ω–∞
              </Button>
              <Button 
                onClick={submitRepeatOrder}
                disabled={
                  !repeatOrderForm.recipient_full_name ||
                  !repeatOrderForm.recipient_phone ||
                  repeatOrderForm.cargo_items.some(item => !item.cargo_name || !item.weight || !item.price_per_kg)
                }
              >
                <ShoppingCart className="mr-2 h-4 w-4" />
                –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ ({repeatOrderTotalCost.toFixed(2)} ‚ÇΩ)
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∞–¥–º–∏–Ω–æ–º */}
      <Dialog open={showAdminEditUser} onOpenChange={setShowAdminEditUser}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</DialogTitle>
            <DialogDescription>
              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è: {selectedUserForEdit?.full_name}
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <Label htmlFor="admin_edit_full_name">–ü–æ–ª–Ω–æ–µ –∏–º—è</Label>
              <Input
                id="admin_edit_full_name"
                value={adminEditUserForm.full_name}
                onChange={(e) => setAdminEditUserForm({...adminEditUserForm, full_name: e.target.value})}
                placeholder="–í–≤–µ–¥–∏—Ç–µ –ø–æ–ª–Ω–æ–µ –∏–º—è"
              />
            </div>
            <div>
              <Label htmlFor="admin_edit_phone">–¢–µ–ª–µ—Ñ–æ–Ω</Label>
              <Input
                id="admin_edit_phone"
                value={adminEditUserForm.phone}
                onChange={(e) => setAdminEditUserForm({...adminEditUserForm, phone: e.target.value})}
                placeholder="+7XXXXXXXXXX"
              />
            </div>
            <div>
              <Label htmlFor="admin_edit_email">Email</Label>
              <Input
                id="admin_edit_email"
                type="email"
                value={adminEditUserForm.email}
                onChange={(e) => setAdminEditUserForm({...adminEditUserForm, email: e.target.value})}
                placeholder="example@email.com"
              />
            </div>
            <div>
              <Label htmlFor="admin_edit_address">–ê–¥—Ä–µ—Å</Label>
              <Textarea
                id="admin_edit_address"
                value={adminEditUserForm.address}
                onChange={(e) => setAdminEditUserForm({...adminEditUserForm, address: e.target.value})}
                placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è"
                rows={3}
              />
            </div>
            <div>
              <Label htmlFor="admin_edit_role">–†–æ–ª—å</Label>
              <Select value={adminEditUserForm.role} onValueChange={(value) => setAdminEditUserForm({...adminEditUserForm, role: value})}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="user">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</SelectItem>
                  <SelectItem value="warehouse_operator">–û–ø–µ—Ä–∞—Ç–æ—Ä —Å–∫–ª–∞–¥–∞</SelectItem>
                  <SelectItem value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div className="flex items-center space-x-2">
              <input
                type="checkbox"
                id="admin_edit_active"
                checked={adminEditUserForm.is_active}
                onChange={(e) => setAdminEditUserForm({...adminEditUserForm, is_active: e.target.checked})}
              />
              <Label htmlFor="admin_edit_active">–ê–∫—Ç–∏–≤–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</Label>
            </div>
            <div className="flex justify-end space-x-2">
              <Button variant="outline" onClick={() => setShowAdminEditUser(false)}>
                –û—Ç–º–µ–Ω–∞
              </Button>
              <Button onClick={saveAdminUserEdit}>
                <Save className="mr-2 h-4 w-4" />
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞ –∞–¥–º–∏–Ω–∞/–æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ */}
      <Dialog open={showAdminRepeatOrderModal} onOpenChange={setShowAdminRepeatOrderModal}>
        <DialogContent className="max-w-5xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>–ü–æ–≤—Ç–æ—Ä–∏—Ç—å –∑–∞–∫–∞–∑ (Admin/Operator)</DialogTitle>
            <DialogDescription>
              –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∑–∞–∫–∞–∑–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ –≥—Ä—É–∑–∞ #{adminRepeatOrderData?.cargo_number}
              <br />
              <span className="text-xs text-gray-500">
                –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω—ã. –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ –≥—Ä—É–∑–æ–≤.
              </span>
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-6">
            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ (–∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω–∞—è) */}
            <div className="bg-gray-50 p-4 rounded-lg">
              <h3 className="text-lg font-medium mb-3 flex items-center">
                <User className="mr-2 h-5 w-5" />
                –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å (–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–æ)
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <Label>–§–ò–û –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è</Label>
                  <Input
                    value={adminRepeatOrderForm.sender_full_name}
                    onChange={(e) => setAdminRepeatOrderForm({...adminRepeatOrderForm, sender_full_name: e.target.value})}
                    placeholder="–§–ò–û –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è"
                  />
                </div>
                <div>
                  <Label>–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è</Label>
                  <Input
                    value={adminRepeatOrderForm.sender_phone}
                    onChange={(e) => setAdminRepeatOrderForm({...adminRepeatOrderForm, sender_phone: e.target.value})}
                    placeholder="+7XXXXXXXXXX"
                  />
                </div>
              </div>
            </div>

            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ (–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–Ω–∞—è) */}
            <div className="bg-blue-50 p-4 rounded-lg">
              <h3 className="text-lg font-medium mb-3 flex items-center">
                <MapPin className="mr-2 h-5 w-5" />
                –ü–æ–ª—É—á–∞—Ç–µ–ª—å (–∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–æ)
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <Label>–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è</Label>
                  <Input
                    value={adminRepeatOrderForm.recipient_full_name}
                    onChange={(e) => setAdminRepeatOrderForm({...adminRepeatOrderForm, recipient_full_name: e.target.value})}
                    placeholder="–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è"
                  />
                </div>
                <div>
                  <Label>–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è</Label>
                  <Input
                    value={adminRepeatOrderForm.recipient_phone}
                    onChange={(e) => setAdminRepeatOrderForm({...adminRepeatOrderForm, recipient_phone: e.target.value})}
                    placeholder="+992XXXXXXXXX"
                  />
                </div>
              </div>
              <div className="mt-4">
                <Label>–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è</Label>
                <Textarea
                  value={adminRepeatOrderForm.recipient_address}
                  onChange={(e) => setAdminRepeatOrderForm({...adminRepeatOrderForm, recipient_address: e.target.value})}
                  placeholder="–ü–æ–ª–Ω—ã–π –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏"
                  rows={2}
                />
              </div>
            </div>

            {/* –ú–∞—Ä—à—Ä—É—Ç –∏ —Ç–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏ */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <Label>–ú–∞—Ä—à—Ä—É—Ç</Label>
                <Select value={adminRepeatOrderForm.route} onValueChange={(value) => setAdminRepeatOrderForm({...adminRepeatOrderForm, route: value})}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="moscow_dushanbe">–ú–æ—Å–∫–≤–∞ ‚Üí –î—É—à–∞–Ω–±–µ</SelectItem>
                    <SelectItem value="moscow_khujand">–ú–æ—Å–∫–≤–∞ ‚Üí –•—É–¥–∂–∞–Ω–¥</SelectItem>
                    <SelectItem value="moscow_kulob">–ú–æ—Å–∫–≤–∞ ‚Üí –ö—É–ª–æ–±</SelectItem>
                    <SelectItem value="moscow_kurgantyube">–ú–æ—Å–∫–≤–∞ ‚Üí –ö—É—Ä–≥–∞–Ω-–¢—é–±–µ</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>–¢–∏–ø –¥–æ—Å—Ç–∞–≤–∫–∏</Label>
                <Select value={adminRepeatOrderForm.delivery_type} onValueChange={(value) => setAdminRepeatOrderForm({...adminRepeatOrderForm, delivery_type: value})}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="standard">–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∞—è</SelectItem>
                    <SelectItem value="express">–≠–∫—Å–ø—Ä–µ—Å—Å</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            {/* –ú—É–ª—å—Ç–∏-–≥—Ä—É–∑ —Ñ–æ—Ä–º–∞ —Å –∫–∞–ª—å–∫—É–ª—è—Ç–æ—Ä–æ–º –¥–ª—è –∞–¥–º–∏–Ω–∞ */}
            <div className="border rounded-lg p-4">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-medium flex items-center">
                  <Package className="mr-2 h-5 w-5" />
                  –ì—Ä—É–∑—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ (–∑–∞–ø–æ–ª–Ω–∏—Ç–µ –∑–∞–Ω–æ–≤–æ)
                </h3>
                <Button
                  type="button"
                  variant="outline"
                  size="sm"
                  onClick={addAdminRepeatOrderItem}
                >
                  <Plus className="mr-1 h-4 w-4" />
                  –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–∑
                </Button>
              </div>

              {/* –°–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤ */}
              <div className="space-y-4">
                {adminRepeatOrderForm.cargo_items.map((item, index) => (
                  <div key={`repeat-cargo-${index}-${item.cargo_name || 'empty'}`} className="grid grid-cols-12 gap-4 items-end border rounded p-3 bg-gray-50">
                    <div className="col-span-4">
                      <Label>–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ *</Label>
                      <Input
                        value={item.cargo_name}
                        onChange={(e) => handleAdminRepeatOrderItemChange(index, 'cargo_name', e.target.value)}
                        placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞"
                      />
                    </div>
                    <div className="col-span-3">
                      <Label>–í–µ—Å (–∫–≥) *</Label>
                      <Input
                        type="number"
                        value={item.weight}
                        onChange={(e) => handleAdminRepeatOrderItemChange(index, 'weight', e.target.value)}
                        placeholder="0.0"
                        step="0.1"
                      />
                    </div>
                    <div className="col-span-3">
                      <Label>–¶–µ–Ω–∞ –∑–∞ –∫–≥ (‚ÇΩ) *</Label>
                      <Input
                        type="number"
                        value={item.price_per_kg}
                        onChange={(e) => handleAdminRepeatOrderItemChange(index, 'price_per_kg', e.target.value)}
                        placeholder="50"
                        step="0.01"
                      />
                    </div>
                    <div className="col-span-1">
                      <Label className="text-xs text-gray-600">–°—Ç–æ–∏–º–æ—Å—Ç—å</Label>
                      <div className="text-sm font-medium">
                        {((parseFloat(item.weight) || 0) * (parseFloat(item.price_per_kg) || 0)).toFixed(2)} ‚ÇΩ
                      </div>
                    </div>
                    <div className="col-span-1">
                      {adminRepeatOrderForm.cargo_items.length > 1 && (
                        <Button
                          type="button"
                          variant="outline"
                          size="sm"
                          onClick={() => removeAdminRepeatOrderItem(index)}
                          className="text-red-600 hover:text-red-700"
                        >
                          <Minus className="h-4 w-4" />
                        </Button>
                      )}
                    </div>
                  </div>
                ))}
              </div>

              {/* –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –∏—Ç–æ–≥–æ–≤ –¥–ª—è –∞–¥–º–∏–Ω–∞ */}
              <div className="mt-4 p-4 bg-green-50 rounded-lg">
                <h4 className="font-medium mb-3 flex items-center">
                  <Calculator className="mr-2 h-4 w-4" />
                  –†–∞—Å—á–µ—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏
                </h4>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div className="text-center">
                    <div className="text-2xl font-bold text-blue-600">
                      {adminRepeatOrderTotalWeight.toFixed(2)} –∫–≥
                    </div>
                    <div className="text-sm text-gray-600">–û–±—â–∏–π –≤–µ—Å</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-bold text-green-600">
                      {adminRepeatOrderTotalCost.toFixed(2)} ‚ÇΩ
                    </div>
                    <div className="text-sm text-gray-600">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-bold text-purple-600">
                      {adminRepeatOrderForm.cargo_items.length}
                    </div>
                    <div className="text-sm text-gray-600">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–∑–æ–≤</div>
                  </div>
                </div>

                {/* –î–µ—Ç–∞–ª—å–Ω–∞—è —Ä–∞–∑–±–∏–≤–∫–∞ */}
                {adminRepeatOrderBreakdown.length > 0 && (
                  <div className="mt-4">
                    <h5 className="text-sm font-medium mb-2">–î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ –≥—Ä—É–∑–∞–º:</h5>
                    <div className="space-y-1">
                      {adminRepeatOrderBreakdown.map((item, index) => (
                        <div key={`admin-repeat-breakdown-${index}-${item.cargo_name || index}`} className="flex justify-between text-sm">
                          <span>{item.cargo_name || `–ì—Ä—É–∑ ${index + 1}`}: {item.weight}–∫–≥ √ó {item.price_per_kg}‚ÇΩ</span>
                          <span className="font-medium">{item.cost.toFixed(2)} ‚ÇΩ</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ü–∏–∏ */}
            <div>
              <Label>–û—Å–æ–±—ã–µ —É–∫–∞–∑–∞–Ω–∏—è</Label>
              <Textarea
                value={adminRepeatOrderForm.special_instructions}
                onChange={(e) => setAdminRepeatOrderForm({...adminRepeatOrderForm, special_instructions: e.target.value})}
                placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏"
                rows={2}
              />
            </div>

            {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
            <div className="flex justify-end space-x-2">
              <Button variant="outline" onClick={() => setShowAdminRepeatOrderModal(false)}>
                –û—Ç–º–µ–Ω–∞
              </Button>
              <Button 
                onClick={submitAdminRepeatOrder}
                disabled={
                  !adminRepeatOrderForm.recipient_full_name ||
                  !adminRepeatOrderForm.recipient_phone ||
                  !adminRepeatOrderForm.sender_full_name ||
                  !adminRepeatOrderForm.sender_phone ||
                  adminRepeatOrderForm.cargo_items.some(item => !item.cargo_name || !item.weight || !item.price_per_kg)
                }
                className="bg-orange-600 hover:bg-orange-700 text-white"
              >
                <ShoppingCart className="mr-2 h-4 w-4" />
                –°–æ–∑–¥–∞—Ç—å –∑–∞–∫–∞–∑ ({adminRepeatOrderTotalCost.toFixed(2)} ‚ÇΩ)
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ª—É—á—à–µ–Ω–Ω–æ–≥–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞ —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π */}
      <Dialog open={enhancedPlacementModal} onOpenChange={setEnhancedPlacementModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Grid3X3 className="mr-2 h-5 w-5" />
              –†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞ —Å –∞–Ω–∞–ª–∏—Ç–∏–∫–æ–π —Å–∫–ª–∞–¥–æ–≤
            </DialogTitle>
            <DialogDescription>
              {selectedCargoForEnhancedPlacement && (
                <span>–†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞: <strong>{selectedCargoForEnhancedPlacement.cargo_number}</strong> - {selectedCargoForEnhancedPlacement.cargo_name}</span>
              )}
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-6">
            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ */}
            {selectedCargoForEnhancedPlacement && (
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 className="font-semibold text-blue-800 mb-3 flex items-center">
                  <Package className="mr-2 h-4 w-4" />
                  –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑–º–µ—â–∞–µ–º–æ–º –≥—Ä—É–∑–µ
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div>
                    <p><strong>–ù–æ–º–µ—Ä –≥—Ä—É–∑–∞:</strong> {selectedCargoForEnhancedPlacement.cargo_number}</p>
                    <p><strong>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ:</strong> {selectedCargoForEnhancedPlacement.cargo_name}</p>
                    <p><strong>–û–±—â–∏–π –≤–µ—Å:</strong> {selectedCargoForEnhancedPlacement.total_weight} –∫–≥</p>
                  </div>
                  <div>
                    <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {selectedCargoForEnhancedPlacement.total_cost} —Ä—É–±</p>
                    <p><strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> {selectedCargoForEnhancedPlacement.sender_name}</p>
                    <p><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> {selectedCargoForEnhancedPlacement.receiver_name}</p>
                  </div>
                </div>
              </div>
            )}

            {/* –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–∫–ª–∞–¥–æ–≤ */}
            {warehouseAnalytics && (
              <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                <h3 className="font-semibold text-green-800 mb-3 flex items-center">
                  <Warehouse className="mr-2 h-4 w-4" />
                  –ê–Ω–∞–ª–∏—Ç–∏–∫–∞ —Å–∫–ª–∞–¥–æ–≤
                </h3>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                  <div className="text-center p-3 bg-white rounded border">
                    <div className="text-2xl font-bold text-blue-600">{warehouseAnalytics.total_warehouses || 0}</div>
                    <div className="text-sm text-gray-600">–í—Å–µ–≥–æ —Å–∫–ª–∞–¥–æ–≤</div>
                  </div>
                  <div className="text-center p-3 bg-white rounded border">
                    <div className="text-2xl font-bold text-green-600">{warehouseAnalytics.available_cells || 0}</div>
                    <div className="text-sm text-gray-600">–°–≤–æ–±–æ–¥–Ω—ã—Ö —è—á–µ–µ–∫</div>
                  </div>
                  <div className="text-center p-3 bg-white rounded border">
                    <div className="text-2xl font-bold text-orange-600">{warehouseAnalytics.occupied_cells || 0}</div>
                    <div className="text-sm text-gray-600">–ó–∞–Ω—è—Ç—ã—Ö —è—á–µ–µ–∫</div>
                  </div>
                </div>
              </div>
            )}

            {/* –í—ã–±–æ—Ä —Å–∫–ª–∞–¥–∞ */}
            <div className="space-y-4">
              <h3 className="font-semibold text-lg flex items-center">
                <Building className="mr-2 h-5 w-5" />
                –í—ã–±–æ—Ä —Å–∫–ª–∞–¥–∞
              </h3>
              
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {warehouses.map((warehouse) => (
                  <div
                    key={warehouse.id}
                    className={`border-2 rounded-lg p-4 cursor-pointer transition-all ${
                      selectedWarehouseForPlacement === warehouse.id
                        ? 'border-blue-500 bg-blue-50'
                        : 'border-gray-200 hover:border-gray-300'
                    }`}
                    onClick={() => handleWarehouseSelectionForPlacement(warehouse.id)}
                  >
                    <div className="flex justify-between items-start mb-2">
                      <h4 className="font-medium">{warehouse.name}</h4>
                      {selectedWarehouseForPlacement === warehouse.id && (
                        <CheckCircle className="h-5 w-5 text-blue-500" />
                      )}
                    </div>
                    <p className="text-sm text-gray-600 mb-2">{warehouse.address}</p>
                    <div className="flex justify-between text-xs">
                      <span>–ë–ª–æ–∫–∏: {warehouse.blocks_count || 10}</span>
                      <span>–ü–æ–ª–∫–∏: {warehouse.shelves_per_block || 10}</span>
                      <span>–Ø—á–µ–π–∫–∏: {warehouse.cells_per_shelf || 10}</span>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* –í—ã–±–æ—Ä –±–ª–æ–∫–∞, –ø–æ–ª–∫–∏ –∏ —è—á–µ–π–∫–∏ */}
            {selectedWarehouseForPlacement && (
              <div className="space-y-4 bg-gray-50 border border-gray-200 rounded-lg p-4">
                <h3 className="font-semibold text-lg flex items-center">
                  <MapPin className="mr-2 h-5 w-5" />
                  –í—ã–±–æ—Ä –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è
                  {structureLoading && (
                    <RefreshCw className="ml-2 h-4 w-4 animate-spin text-blue-500" />
                  )}
                </h3>
                
                {/* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É —Å–∫–ª–∞–¥–∞ */}
                {warehouseDetailedStructure?.statistics && (
                  <div className="bg-white border border-gray-200 rounded-lg p-3 mb-4">
                    <div className="grid grid-cols-3 gap-4 text-center">
                      <div>
                        <div className="text-lg font-bold text-blue-600">{warehouseDetailedStructure.statistics.total_cells}</div>
                        <div className="text-xs text-gray-600">–í—Å–µ–≥–æ —è—á–µ–µ–∫</div>
                      </div>
                      <div>
                        <div className="text-lg font-bold text-green-600">{warehouseDetailedStructure.statistics.available_cells}</div>
                        <div className="text-xs text-gray-600">–°–≤–æ–±–æ–¥–Ω—ã—Ö</div>
                      </div>
                      <div>
                        <div className="text-lg font-bold text-red-600">{warehouseDetailedStructure.statistics.occupied_cells}</div>
                        <div className="text-xs text-gray-600">–ó–∞–Ω—è—Ç—ã—Ö</div>
                      </div>
                    </div>
                    <div className="mt-2 text-center">
                      <div className="text-sm text-gray-600">
                        –ó–∞–Ω—è—Ç–æ—Å—Ç—å: {warehouseDetailedStructure.statistics.occupancy_rate}%
                      </div>
                    </div>
                  </div>
                )}

                {/* –°–µ–ª–µ–∫—Ç–æ—Ä—ã –¥–ª—è –≤—ã–±–æ—Ä–∞ –º–µ—Å—Ç–∞ */}
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                  {/* –í—ã–±–æ—Ä –±–ª–æ–∫–∞ */}
                  <div>
                    <Label>–ë–ª–æ–∫</Label>
                    <Select 
                      value={selectedBlockForPlacement.toString()} 
                      onValueChange={(value) => {
                        const blockNumber = parseInt(value);
                        handleBlockShelfSelection(blockNumber, selectedShelfForPlacement);
                      }}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        {warehouseDetailedStructure?.blocks?.map(block => (
                          <SelectItem key={block.block_number} value={block.block_number.toString()}>
                            –ë–ª–æ–∫ {block.block_number}
                          </SelectItem>
                        )) || 
                        Array.from({length: 10}, (_, i) => i + 1).map(blockNum => (
                          <SelectItem key={blockNum} value={blockNum.toString()}>
                            –ë–ª–æ–∫ {blockNum}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  {/* –í—ã–±–æ—Ä –ø–æ–ª–∫–∏ */}
                  <div>
                    <Label>–ü–æ–ª–∫–∞</Label>
                    <Select 
                      value={selectedShelfForPlacement.toString()} 
                      onValueChange={(value) => {
                        const shelfNumber = parseInt(value);
                        handleBlockShelfSelection(selectedBlockForPlacement, shelfNumber);
                      }}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        {warehouseDetailedStructure?.blocks?.find(b => b.block_number === selectedBlockForPlacement)?.shelves?.map(shelf => (
                          <SelectItem key={shelf.shelf_number} value={shelf.shelf_number.toString()}>
                            –ü–æ–ª–∫–∞ {shelf.shelf_number}
                          </SelectItem>
                        )) ||
                        Array.from({length: 10}, (_, i) => i + 1).map(shelfNum => (
                          <SelectItem key={shelfNum} value={shelfNum.toString()}>
                            –ü–æ–ª–∫–∞ {shelfNum}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  {/* –í—ã–±–æ—Ä —è—á–µ–π–∫–∏ */}
                  <div>
                    <Label>–Ø—á–µ–π–∫–∞</Label>
                    <Select 
                      value={selectedCellForPlacement.toString()} 
                      onValueChange={(value) => handleCellSelection(parseInt(value))}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        {warehouseDetailedStructure?.blocks
                          ?.find(b => b.block_number === selectedBlockForPlacement)?.shelves
                          ?.find(s => s.shelf_number === selectedShelfForPlacement)?.cells
                          ?.map(cell => (
                            <SelectItem 
                              key={cell.cell_number} 
                              value={cell.cell_number.toString()}
                              disabled={cell.status === 'occupied'}
                              className={cell.status === 'occupied' ? 'text-red-500' : 'text-green-600'}
                            >
                              –Ø—á–µ–π–∫–∞ {cell.cell_number} {cell.status === 'occupied' ? '(–ó–ê–ù–Ø–¢–ê)' : '(—Å–≤–æ–±–æ–¥–Ω–∞)'}
                              {cell.cargo_info && (
                                <span className="text-xs block text-red-600">
                                  {cell.cargo_info.cargo_number}
                                </span>
                              )}
                            </SelectItem>
                          )) ||
                          availableCellsForPlacement.map(cellNum => (
                            <SelectItem key={cellNum} value={cellNum.toString()}>
                              –Ø—á–µ–π–∫–∞ {cellNum} (—Å–≤–æ–±–æ–¥–Ω–∞)
                            </SelectItem>
                          )) ||
                          Array.from({length: 10}, (_, i) => i + 1).map(cellNum => (
                            <SelectItem key={cellNum} value={cellNum.toString()}>
                              –Ø—á–µ–π–∫–∞ {cellNum}
                            </SelectItem>
                          ))
                        }
                      </SelectContent>
                    </Select>
                  </div>
                </div>

                {/* –í–∏–∑—É–∞–ª—å–Ω–∞—è —Å–µ—Ç–∫–∞ —è—á–µ–µ–∫ –¥–ª—è –≤—ã–±—Ä–∞–Ω–Ω–æ–π –ø–æ–ª–∫–∏ */}
                {warehouseDetailedStructure && (
                  <div className="mt-6">
                    <h4 className="font-medium mb-3 flex items-center">
                      <Grid3X3 className="mr-2 h-4 w-4" />
                      –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø–æ–ª–∫–∏ {selectedShelfForPlacement} (–ë–ª–æ–∫ {selectedBlockForPlacement})
                    </h4>
                    <div className="border border-gray-300 rounded-lg p-4 bg-white">
                      <div className="grid grid-cols-5 gap-2 max-w-lg">
                        {warehouseDetailedStructure.blocks
                          ?.find(b => b.block_number === selectedBlockForPlacement)?.shelves
                          ?.find(s => s.shelf_number === selectedShelfForPlacement)?.cells
                          ?.map(cell => (
                            <button
                              key={cell.cell_number}
                              onClick={() => handleCellSelection(cell.cell_number)}
                              disabled={cell.status === 'occupied'}
                              className={`
                                w-12 h-12 rounded border-2 text-xs font-medium transition-all
                                ${cell.cell_number === selectedCellForPlacement 
                                  ? 'border-blue-500 bg-blue-100 text-blue-700 shadow-md' 
                                  : cell.status === 'occupied' 
                                  ? 'border-red-300 bg-red-100 text-red-600 cursor-not-allowed opacity-60'
                                  : 'border-gray-300 bg-green-50 text-green-700 hover:border-green-400 hover:bg-green-100'
                                }
                              `}
                              title={cell.status === 'occupied' 
                                ? `–ó–∞–Ω—è—Ç–∞: ${cell.cargo_info?.cargo_number || '–ì—Ä—É–∑'}`
                                : `–°–≤–æ–±–æ–¥–Ω–∞: –Ø—á–µ–π–∫–∞ ${cell.cell_number}`
                              }
                            >
                              {cell.cell_number}
                            </button>
                          )) ||
                          // Fallback –µ—Å–ª–∏ –Ω–µ—Ç –¥–µ—Ç–∞–ª—å–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
                          Array.from({length: 10}, (_, i) => i + 1).map(cellNum => (
                            <button
                              key={cellNum}
                              onClick={() => handleCellSelection(cellNum)}
                              className={`
                                w-12 h-12 rounded border-2 text-xs font-medium transition-all
                                ${cellNum === selectedCellForPlacement 
                                  ? 'border-blue-500 bg-blue-100 text-blue-700 shadow-md' 
                                  : 'border-gray-300 bg-green-50 text-green-700 hover:border-green-400 hover:bg-green-100'
                                }
                              `}
                            >
                              {cellNum}
                            </button>
                          ))
                        }
                      </div>
                      
                      {/* –õ–µ–≥–µ–Ω–¥–∞ */}
                      <div className="flex flex-wrap gap-4 mt-4 text-xs">
                        <div className="flex items-center">
                          <div className="w-4 h-4 bg-green-50 border border-gray-300 rounded mr-2"></div>
                          <span>–°–≤–æ–±–æ–¥–Ω–∞—è</span>
                        </div>
                        <div className="flex items-center">
                          <div className="w-4 h-4 bg-red-100 border border-red-300 rounded mr-2"></div>
                          <span>–ó–∞–Ω—è—Ç–∞—è</span>
                        </div>
                        <div className="flex items-center">
                          <div className="w-4 h-4 bg-blue-100 border-2 border-blue-500 rounded mr-2"></div>
                          <span>–í—ã–±—Ä–∞–Ω–Ω–∞—è</span>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –∞–¥—Ä–µ—Å–∞ */}
                <div className="mt-4 p-3 bg-white border rounded-lg">
                  <p className="text-sm text-gray-600 mb-1">–ê–¥—Ä–µ—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:</p>
                  <p className="font-mono text-lg font-bold">
                    {warehouses.find(w => w.id === selectedWarehouseForPlacement)?.name || '–°–∫–ª–∞–¥'} - 
                    –ë–ª–æ–∫ {selectedBlockForPlacement} - 
                    –ü–æ–ª–∫–∞ {selectedShelfForPlacement} - 
                    –Ø—á–µ–π–∫–∞ {selectedCellForPlacement}
                    {!isCellAvailable(selectedBlockForPlacement, selectedShelfForPlacement, selectedCellForPlacement) && (
                      <span className="text-red-600 ml-2">‚ö†Ô∏è –ó–ê–ù–Ø–¢–ê</span>
                    )}
                  </p>
                  {selectedCellForVisualization?.info?.cargo_info && (
                    <div className="mt-2 text-sm text-red-600">
                      <strong>–í–Ω–∏–º–∞–Ω–∏–µ!</strong> –Ø—á–µ–π–∫–∞ –∑–∞–Ω—è—Ç–∞ –≥—Ä—É–∑–æ–º: {selectedCellForVisualization.info.cargo_info.cargo_number}
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
            <div className="flex justify-end space-x-2 pt-4 border-t">
              <Button 
                variant="outline" 
                onClick={() => setEnhancedPlacementModal(false)}
                disabled={placementLoading}
              >
                –û—Ç–º–µ–Ω–∞
              </Button>
              <Button
                onClick={handleEnhancedCargoPlacement}
                disabled={
                  !selectedCargoForEnhancedPlacement || 
                  !selectedWarehouseForPlacement || 
                  placementLoading ||
                  !isCellAvailable(selectedBlockForPlacement, selectedShelfForPlacement, selectedCellForPlacement)
                }
                className={`${
                  isCellAvailable(selectedBlockForPlacement, selectedShelfForPlacement, selectedCellForPlacement)
                    ? 'bg-green-600 hover:bg-green-700 text-white'
                    : 'bg-red-500 hover:bg-red-600 text-white'
                }`}
              >
                {placementLoading ? (
                  <>
                    <RefreshCw className="mr-2 h-4 w-4 animate-spin" />
                    –†–∞–∑–º–µ—â–µ–Ω–∏–µ...
                  </>
                ) : !isCellAvailable(selectedBlockForPlacement, selectedShelfForPlacement, selectedCellForPlacement) ? (
                  <>
                    <Ban className="mr-2 h-4 w-4" />
                    –Ø—á–µ–π–∫–∞ –∑–∞–Ω—è—Ç–∞
                  </>
                ) : (
                  <>
                    <Grid3X3 className="mr-2 h-4 w-4" />
                    –°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ
                  </>
                )}
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è —É–¥–∞–ª–µ–Ω–∏—è */}
      <Dialog open={deleteConfirmModal} onOpenChange={setDeleteConfirmModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="text-red-600">
              <Trash2 className="mr-2 h-5 w-5 inline" />
              –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ —É–¥–∞–ª–µ–Ω–∏–µ
            </DialogTitle>
          </DialogHeader>
          
          {deleteConfirmData && (
            <div className="space-y-4">
              <div className="p-4 bg-red-50 rounded-lg border border-red-200">
                <h4 className="font-medium text-red-800 mb-2">
                  {deleteConfirmData.isBulk 
                    ? `–£–¥–∞–ª–µ–Ω–∏–µ ${deleteConfirmData.count} —ç–ª–µ–º–µ–Ω—Ç(–æ–≤)` 
                    : '–£–¥–∞–ª–µ–Ω–∏–µ —ç–ª–µ–º–µ–Ω—Ç–∞'
                  }
                </h4>
                <p className="text-sm text-red-700">
                  {deleteConfirmData.type === 'warehouse' && (
                    deleteConfirmData.isBulk 
                      ? `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${deleteConfirmData.count} —Å–∫–ª–∞–¥(–æ–≤)? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`
                      : `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Å–∫–ª–∞–¥ "${deleteConfirmData.items[0]?.name}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`
                  )}
                  {deleteConfirmData.type === 'cargo' && (
                    deleteConfirmData.isBulk 
                      ? `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${deleteConfirmData.count} –≥—Ä—É–∑(–æ–≤)? –í–ù–ò–ú–ê–ù–ò–ï: –ï—Å–ª–∏ –≥—Ä—É–∑ —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥–µ –∏–ª–∏ –≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ, —É–¥–∞–ª–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –ª–æ–≥–∏—Å—Ç–∏–∫—É. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`
                      : `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–∑ "${deleteConfirmData.items[0]?.cargo_number}"? –í–ù–ò–ú–ê–ù–ò–ï: –ï—Å–ª–∏ –≥—Ä—É–∑ —Ä–∞–∑–º–µ—â–µ–Ω –Ω–∞ —Å–∫–ª–∞–¥–µ –∏–ª–∏ –≤ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–µ, —É–¥–∞–ª–µ–Ω–∏–µ –º–æ–∂–µ—Ç –ø–æ–≤–ª–∏—è—Ç—å –Ω–∞ –ª–æ–≥–∏—Å—Ç–∏–∫—É. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`
                  )}
                  {deleteConfirmData.type === 'user' && (
                    deleteConfirmData.isBulk 
                      ? `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${deleteConfirmData.count} –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª(–µ–π)? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`
                      : `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è "${deleteConfirmData.items[0]?.full_name}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`
                  )}
                  {deleteConfirmData.type === 'request' && (
                    deleteConfirmData.isBulk 
                      ? `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${deleteConfirmData.count} –∑–∞—è–≤–∫(–∏)? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`
                      : `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É "${deleteConfirmData.items[0]?.request_number}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`
                  )}
                  {deleteConfirmData.type === 'operator' && (
                    deleteConfirmData.isBulk 
                      ? `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${deleteConfirmData.count} –æ–ø–µ—Ä–∞—Ç–æ—Ä(–æ–≤)? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`
                      : `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ "${deleteConfirmData.items[0]?.full_name}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`
                  )}
                  {deleteConfirmData.type === 'transport' && (
                    deleteConfirmData.isBulk 
                      ? `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${deleteConfirmData.count} —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç(–æ–≤)? –í–ù–ò–ú–ê–ù–ò–ï: –°–Ω–∞—á–∞–ª–∞ —É–¥–∞–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ü–£–°–¢–´–ï —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç—ã. –î–ª—è —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–æ–≤ —Å –≥—Ä—É–∑–æ–º –±—É–¥–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`
                      : `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç "${deleteConfirmData.items[0]?.transport_number}"? –í–ù–ò–ú–ê–ù–ò–ï: –ï—Å–ª–∏ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç —Å–æ–¥–µ—Ä–∂–∏—Ç –≥—Ä—É–∑, –±—É–¥–µ—Ç –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–æ –ø—Ä–∏–Ω—É–¥–∏—Ç–µ–ª—å–Ω–æ–µ —É–¥–∞–ª–µ–Ω–∏–µ —Å –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ–º –≥—Ä—É–∑–∞ –≤ —Å—Ç–∞—Ç—É—Å "–ë–µ–∑ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞". –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`
                  )}
                  {deleteConfirmData.type === 'pickup-request' && (
                    deleteConfirmData.isBulk 
                      ? `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${deleteConfirmData.count} –∑–∞—è–≤–∫(–∏) –Ω–∞ –∑–∞–±–æ—Ä? –í–ù–ò–ú–ê–ù–ò–ï: –ó–∞–≤–µ—Ä—à–µ–Ω–Ω—ã–µ –∑–∞—è–≤–∫–∏ —É–¥–∞–ª–∏—Ç—å –Ω–µ–ª—å–∑—è. –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`
                      : `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –∑–∞—è–≤–∫—É –Ω–∞ –∑–∞–±–æ—Ä "${deleteConfirmData.items[0]?.request_number}"? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ.`
                  )}
                  {deleteConfirmData.type === 'cargo-placement' && (
                    deleteConfirmData.isBulk 
                      ? `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å ${deleteConfirmData.count} –≥—Ä—É–∑(–æ–≤) –∏–∑ —Å–∏—Å—Ç–µ–º—ã? –í–ù–ò–ú–ê–ù–ò–ï: –ì—Ä—É–∑—ã –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã –∏–∑ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∏ –ø–æ–ª—É—á–∞—Ç —Å—Ç–∞—Ç—É—Å "removed_from_placement". –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!`
                      : `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –≥—Ä—É–∑ "${deleteConfirmData.items[0]?.cargo_number}" –∏–∑ —Å–∏—Å—Ç–µ–º—ã? –í–ù–ò–ú–ê–ù–ò–ï: –ì—Ä—É–∑ –±—É–¥–µ—Ç —É–¥–∞–ª–µ–Ω –∏–∑ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∏ –ø–æ–ª—É—á–∏—Ç —Å—Ç–∞—Ç—É—Å "removed_from_placement". –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–æ–±—Ä–∞—Ç–∏–º–æ!`
                  )}
                </p>
              </div>

              <div className="flex justify-end space-x-2">
                <Button
                  variant="outline"
                  onClick={() => setDeleteConfirmModal(false)}
                  disabled={bulkDeleteLoading}
                >
                  –û—Ç–º–µ–Ω–∞
                </Button>
                <Button
                  onClick={executeDelete}
                  disabled={bulkDeleteLoading}
                  className="bg-red-600 hover:bg-red-700 text-white"
                >
                  {bulkDeleteLoading ? (
                    <>
                      <RefreshCw className="mr-2 h-4 w-4 animate-spin" />
                      –£–¥–∞–ª–µ–Ω–∏–µ...
                    </>
                  ) : (
                    <>
                      <Trash2 className="mr-2 h-4 w-4" />
                      –£–¥–∞–ª–∏—Ç—å
                    </>
                  )}
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ—Ç–∞–ª–µ–π —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è */}
      <Dialog open={notificationDetailsModal} onOpenChange={setNotificationDetailsModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Bell className="mr-2 h-5 w-5 text-blue-600" />
              –î–µ—Ç–∞–ª–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è
            </DialogTitle>
          </DialogHeader>
          
          {selectedNotificationDetails && (
            <div className="space-y-4">
              <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
                <p className="text-sm text-gray-800 leading-relaxed mb-2">
                  {selectedNotificationDetails.notification.message}
                </p>
                <p className="text-xs text-gray-500">
                  üìÖ {new Date(selectedNotificationDetails.notification.created_at).toLocaleString('ru-RU')}
                </p>
                {selectedNotificationDetails.notification.status === 'unread' && (
                  <div className="mt-2">
                    <span className="inline-block px-2 py-1 text-xs bg-red-100 text-red-600 rounded">
                      –ù–µ–ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
                    </span>
                  </div>
                )}
              </div>

              {/* –°–≤—è–∑–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –µ—Å–ª–∏ –µ—Å—Ç—å */}
              {selectedNotificationDetails.related_data && (
                <div className="p-4 bg-gray-50 rounded-lg border border-gray-200">
                  <h4 className="font-medium text-gray-800 mb-2">üì¶ –°–≤—è–∑–∞–Ω–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h4>
                  {selectedNotificationDetails.related_data.type === 'cargo' && (
                    <div className="space-y-2 text-sm">
                      <p><strong>–ù–æ–º–µ—Ä –≥—Ä—É–∑–∞:</strong> {selectedNotificationDetails.related_data.data.cargo_number}</p>
                      <p><strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> {selectedNotificationDetails.related_data.data.sender_full_name}</p>
                      <p><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> {selectedNotificationDetails.related_data.data.recipient_full_name}</p>
                      <p><strong>–í–µ—Å:</strong> {selectedNotificationDetails.related_data.data.weight} –∫–≥</p>
                      <p><strong>–°—Ç–∞—Ç—É—Å:</strong> {selectedNotificationDetails.related_data.data.status}</p>
                    </div>
                  )}
                </div>
              )}

              <div className="flex justify-end space-x-2">
                <Button
                  variant="outline"
                  onClick={() => setNotificationDetailsModal(false)}
                >
                  –ó–∞–∫—Ä—ã—Ç—å
                </Button>
                {selectedNotificationDetails.notification.status === 'unread' && (
                  <Button
                    onClick={() => {
                      handleMarkNotificationAsRead(selectedNotificationDetails.notification.id);
                      setNotificationDetailsModal(false);
                    }}
                    className="bg-green-600 hover:bg-green-700 text-white"
                  >
                    –û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –ø—Ä–æ—á–∏—Ç–∞–Ω–Ω–æ–µ
                  </Button>
                )}
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –°–•–ï–ú–´ –°–ö–õ–ê–î–ê (–§–ê–ó–ê 3) */}
      <Dialog open={!!showWarehouseScheme} onOpenChange={() => setShowWarehouseScheme(null)}>
        <DialogContent className="max-w-6xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Grid3X3 className="mr-2 h-5 w-5" />
              –°—Ö–µ–º–∞ —Å–∫–ª–∞–¥–∞
            </DialogTitle>
            <DialogDescription>
              {showWarehouseScheme && (
                <span>
                  –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è —è—á–µ–µ–∫ —Å–∫–ª–∞–¥–∞: <strong>
                    {(() => {
                      const warehousesList = user?.role === 'admin' ? warehouses : operatorWarehouses;
                      return warehousesList.find(w => w.id === showWarehouseScheme)?.name || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π —Å–∫–ª–∞–¥';
                    })()}
                  </strong>
                </span>
              )}
            </DialogDescription>
          </DialogHeader>
          
          {showWarehouseScheme && (
            <div className="space-y-6">
              {/* –û–±—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ */}
              <div className="grid grid-cols-4 gap-4">
                <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-blue-700">–í—Å–µ–≥–æ –±–ª–æ–∫–æ–≤</p>
                      <p className="text-2xl font-bold text-blue-900">
                        {(() => {
                          const warehousesList = user?.role === 'admin' ? warehouses : operatorWarehouses;
                          return warehousesList.find(w => w.id === showWarehouseScheme)?.blocks_count || 0;
                        })()}
                      </p>
                    </div>
                    <Building className="h-8 w-8 text-blue-600" />
                  </div>
                </div>
                
                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-gray-700">–í—Å–µ–≥–æ —è—á–µ–µ–∫</p>
                      <p className="text-2xl font-bold text-gray-900">
                        {(() => {
                          const warehousesList = user?.role === 'admin' ? warehouses : operatorWarehouses;
                          const warehouse = warehousesList.find(w => w.id === showWarehouseScheme);
                          return warehouse?.total_cells || 
                                 ((warehouse?.blocks_count || 0) * (warehouse?.shelves_per_block || 0) * (warehouse?.cells_per_shelf || 0)) || 0;
                        })()}
                      </p>
                    </div>
                    <Grid3X3 className="h-8 w-8 text-gray-600" />
                  </div>
                </div>
                
                <div className="bg-red-50 p-4 rounded-lg border border-red-200">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-red-700">–ó–∞–Ω—è—Ç–æ</p>
                      <p className="text-2xl font-bold text-red-900">
                        {(() => {
                          // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ warehouseSchemeData
                          return warehouseSchemeData.reduce((total, block) => total + block.occupied_cells, 0);
                        })()}
                      </p>
                    </div>
                    <Package className="h-8 w-8 text-red-600" />
                  </div>
                </div>
                
                <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-green-700">–°–≤–æ–±–æ–¥–Ω–æ</p>
                      <p className="text-2xl font-bold text-green-900">
                        {(() => {
                          // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ä–µ–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ warehouseSchemeData
                          const totalCells = warehouseSchemeData.reduce((total, block) => total + block.total_cells, 0);
                          const occupiedCells = warehouseSchemeData.reduce((total, block) => total + block.occupied_cells, 0);
                          return totalCells - occupiedCells;
                        })()}
                      </p>
                    </div>
                    <CheckCircle className="h-8 w-8 text-green-600" />
                  </div>
                </div>
              </div>

              {/* –õ–µ–≥–µ–Ω–¥–∞ */}
              <div className="bg-gray-50 p-4 rounded-lg border">
                <h4 className="font-semibold text-sm text-gray-700 mb-3">üé® –õ–µ–≥–µ–Ω–¥–∞ —è—á–µ–µ–∫ –∏ –≥—Ä—É–ø–ø–∏—Ä–æ–≤–∫–∏ –≥—Ä—É–∑–æ–≤</h4>
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <p className="font-medium text-gray-700 mb-2">–°—Ç–∞—Ç—É—Å —è—á–µ–µ–∫:</p>
                    <div className="flex items-center space-x-2">
                      <div className="w-6 h-6 bg-green-200 border border-green-400 rounded"></div>
                      <span className="text-sm font-medium text-green-700">–°–≤–æ–±–æ–¥–Ω–∞—è —è—á–µ–π–∫–∞</span>
                    </div>
                    <div className="flex items-center space-x-2">
                      <div className="w-6 h-6 bg-red-200 border border-red-400 rounded"></div>
                      <span className="text-sm font-medium text-red-700">–û–¥–∏–Ω–æ—á–Ω—ã–π –≥—Ä—É–∑</span>
                    </div>
                  </div>
                  
                  <div className="space-y-2">
                    <p className="font-medium text-gray-700 mb-2">–ì—Ä—É–ø–ø—ã –≥—Ä—É–∑–æ–≤ –æ–¥–Ω–æ–≥–æ –∫–ª–∏–µ–Ω—Ç–∞:</p>
                    <div className="flex items-center space-x-2">
                      <div className="w-6 h-6 bg-blue-200 border border-blue-400 rounded"></div>
                      <span className="text-sm font-medium text-blue-700">–ì—Ä—É–ø–ø–∞ 1</span>
                    </div>
                    <div className="flex items-center space-x-2">
                      <div className="w-6 h-6 bg-purple-200 border border-purple-400 rounded"></div>
                      <span className="text-sm font-medium text-purple-700">–ì—Ä—É–ø–ø–∞ 2</span>
                    </div>
                    <div className="flex items-center space-x-2">
                      <div className="w-6 h-6 bg-orange-200 border border-orange-400 rounded"></div>
                      <span className="text-sm font-medium text-orange-700">–ì—Ä—É–ø–ø–∞ 3+</span>
                    </div>
                  </div>
                </div>
                <p className="text-xs text-gray-500 mt-3">
                  –Ø—á–µ–π–∫–∏ –æ–¥–Ω–æ–≥–æ —Ü–≤–µ—Ç–∞ —Å–æ–¥–µ—Ä–∂–∞—Ç –≥—Ä—É–∑—ã –æ—Ç –æ–¥–Ω–æ–≥–æ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è –∏–ª–∏ –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
                </p>
              </div>

              {/* –°—Ö–µ–º–∞ –±–ª–æ–∫–æ–≤ –∏ —è—á–µ–µ–∫ */}
              <div className="space-y-6">
                {warehouseSchemeLoading ? (
                  <div className="flex justify-center items-center py-8">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span className="ml-2 text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ö–µ–º—ã —Å–∫–ª–∞–¥–∞...</span>
                  </div>
                ) : (
                  warehouseSchemeData.map((block) => {
                    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —è—á–µ–π–∫–∏ –±–ª–æ–∫–∞ –ø–æ –ø–æ–ª–∫–∞–º –¥–ª—è –ø—Ä–∞–≤–∏–ª—å–Ω–æ–≥–æ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è
                    const cellsByShelf = block.cells.reduce((shelves, cell) => {
                      const shelfKey = cell.shelf_number;
                      if (!shelves[shelfKey]) {
                        shelves[shelfKey] = [];
                      }
                      shelves[shelfKey].push(cell);
                      return shelves;
                    }, {});

                    return (
                      <div key={block.block_number} className="border rounded-lg p-6 bg-white">
                        <div className="flex justify-between items-center mb-6">
                          <h3 className="font-bold text-xl text-gray-800">
                            üè≠ –ë–ª–æ–∫ {block.block_number}
                          </h3>
                          <div className="text-sm text-gray-600 bg-gray-100 px-3 py-1 rounded-lg">
                            –ó–∞–Ω—è—Ç–æ: {block.occupied_cells}/{block.total_cells} —è—á–µ–µ–∫ 
                            ({Math.round((block.occupied_cells / block.total_cells) * 100)}%)
                          </div>
                        </div>
                        
                        {/* –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –û—Ç–æ–±—Ä–∞–∂–∞–µ–º —è—á–µ–π–∫–∏ –≥—Ä—É–ø–ø–∞–º–∏ –ø–æ –ø–æ–ª–∫–∞–º */}
                        <div className="space-y-6">
                          {Object.keys(cellsByShelf)
                            .sort((a, b) => parseInt(a) - parseInt(b))
                            .map(shelfNumber => {
                              const shelfCells = cellsByShelf[shelfNumber].sort((a, b) => a.cell_number - b.cell_number);
                              
                              return (
                                <div key={shelfNumber} className="bg-gray-50 rounded-lg p-4">
                                  <div className="flex items-center justify-between mb-3">
                                    <h4 className="font-semibold text-gray-700 flex items-center">
                                      <Package className="mr-2 h-4 w-4" />
                                      –ü–æ–ª–∫–∞ {shelfNumber}
                                    </h4>
                                    <span className="text-xs text-gray-500 bg-white px-2 py-1 rounded">
                                      {shelfCells.filter(c => c.is_occupied).length}/{shelfCells.length} –∑–∞–Ω—è—Ç–æ
                                    </span>
                                  </div>
                                  
                                  {/* –°–µ—Ç–∫–∞ —è—á–µ–µ–∫ –¥–ª—è –¥–∞–Ω–Ω–æ–π –ø–æ–ª–∫–∏ */}
                                  <div className="grid gap-2" style={{
                                    gridTemplateColumns: `repeat(${shelfCells.length}, minmax(80px, 1fr))`
                                  }}>
                                    {shelfCells.map((cell) => {
                                      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ü–≤–µ—Ç —è—á–µ–π–∫–∏
                                      let cellStyle = '';
                                      if (!cell.is_occupied) {
                                        cellStyle = 'bg-green-100 border-green-300 hover:bg-green-200';
                                      } else if (cell.hasRelatedCargo && cell.clientGroup && cell.clientGroup.color) {
                                        // –ì—Ä—É–∑ –∏–∑ –≥—Ä—É–ø–ø—ã - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ü–≤–µ—Ç –≥—Ä—É–ø–ø—ã
                                        const color = cell.clientGroup.color;
                                        cellStyle = `${color.bg} ${color.border} hover:opacity-80`;
                                      } else {
                                        // –û–¥–∏–Ω–æ—á–Ω—ã–π –≥—Ä—É–∑
                                        cellStyle = 'bg-red-100 border-red-300 hover:bg-red-200';
                                      }
                                      
                                      return (
                                        <div
                                          key={cell.id}
                                          className={`
                                            relative border-2 rounded-lg p-3 text-center cursor-pointer transition-all hover:scale-105 min-h-20
                                            ${cellStyle}
                                          `}
                                          onClick={() => {
                                            if (cell.is_occupied) {
                                              openCargoManagementModal(cell);
                                            }
                                          }}
                                          title={cell.is_occupied ? 
                                            (cell.hasRelatedCargo && cell.relatedCargo ? 
                                              `–ì—Ä—É–∑ –∏–∑ –≥—Ä—É–ø–ø—ã ${cell.groupType === 'sender' ? '–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è' : '–ø–æ–ª—É—á–∞—Ç–µ–ª—è'}: ${cell.relatedCargo.client_name} (–≤—Å–µ–≥–æ –≥—Ä—É–∑–æ–≤: ${cell.relatedCargo.totalCargo})` :
                                              `–ì—Ä—É–∑: ${cell.cargo_number} –æ—Ç ${cell.cargo_sender}`
                                            ) : 
                                            '–°–≤–æ–±–æ–¥–Ω–∞—è —è—á–µ–π–∫–∞'
                                          }
                                        >
                                          <div className="text-xs font-bold text-gray-800 mb-1">
                                            –Ø{cell.cell_number}
                                          </div>
                                          {cell.is_occupied ? (
                                            <div className="space-y-1">
                                              <div className={`text-xs font-bold ${
                                                cell.hasRelatedCargo && cell.clientGroup && cell.clientGroup.color ? 
                                                  cell.clientGroup.color.text : 
                                                  'text-red-800'
                                              }`}>
                                                {cell.hasRelatedCargo ? '–ì–†–£–ü–ü–ê' : '–ó–ê–ù–Ø–¢–û'}
                                              </div>
                                              <div className={`text-xs truncate ${
                                                cell.hasRelatedCargo && cell.clientGroup && cell.clientGroup.color ? 
                                                  cell.clientGroup.color.text : 
                                                  'text-red-700'
                                              }`} title={cell.cargo_number}>
                                                {cell.cargo_number?.substring(0, 8)}...
                                              </div>
                                              {cell.hasRelatedCargo && cell.relatedCargo && (
                                                <div className={`text-xs ${cell.clientGroup && cell.clientGroup.color ? cell.clientGroup.color.text : 'text-blue-700'}`}>
                                                  {cell.groupType === 'sender' ? 'üì§' : 'üì•'} {cell.relatedCargo.totalCargo} —à—Ç
                                                </div>
                                              )}
                                              {cell.cargo_weight && (
                                                <div className="text-xs text-gray-600">
                                                  {cell.cargo_weight} –∫–≥
                                                </div>
                                              )}
                                            </div>
                                          ) : (
                                            <div className="text-xs font-bold text-green-800">–°–í–û–ë–û–î–ù–û</div>
                                          )}
                                        </div>
                                      );
                                    })}
                                  </div>
                                </div>
                              );
                            })}
                        </div>
                      </div>
                    );
                  })
                )}
              </div>

              {/* –î–µ–π—Å—Ç–≤–∏—è */}
              <div className="flex justify-end space-x-2">
                <Button variant="outline" onClick={() => setShowWarehouseScheme(null)}>
                  –ó–∞–∫—Ä—ã—Ç—å
                </Button>
                <Button className="bg-blue-600 hover:bg-blue-700 text-white">
                  <FileText className="mr-2 h-4 w-4" />
                  –≠–∫—Å–ø–æ—Ä—Ç —Å—Ö–µ–º—ã
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ì–†–£–ó–û–ú (–§–ê–ó–ê 4 - –§–ò–ù–ê–õ–¨–ù–ê–Ø) */}
      <Dialog open={showCargoManagementModal} onOpenChange={setShowCargoManagementModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Package className="mr-2 h-5 w-5" />
              –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–∑–æ–º: {selectedCargoForManagement?.cargo_number}
            </DialogTitle>
            <DialogDescription>
              –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ –∏ —Ñ—É–Ω–∫—Ü–∏–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è
            </DialogDescription>
          </DialogHeader>
          
          {selectedCargoForManagement && (
            <div className="space-y-6">
              {/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                {/* –°—Ç–∞—Ç—É—Å –≥—Ä—É–∑–∞ */}
                <Card className="border-l-4 border-l-blue-500">
                  <CardContent className="p-4">
                    <div className="flex items-center space-x-3">
                      <Package className="h-8 w-8 text-blue-600" />
                      <div>
                        <p className="text-sm font-medium text-gray-500">–°—Ç–∞—Ç—É—Å –≥—Ä—É–∑–∞</p>
                        <p className="text-lg font-bold text-blue-900">–†–ê–ó–ú–ï–©–ï–ù</p>
                      </div>
                    </div>
                  </CardContent>
                </Card>

                {/* –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã */}
                <Card className="border-l-4 border-l-green-500">
                  <CardContent className="p-4">
                    <div className="flex items-center space-x-3">
                      <CreditCard className="h-8 w-8 text-green-600" />
                      <div>
                        <p className="text-sm font-medium text-gray-500">–û–ø–ª–∞—Ç–∞</p>
                        <p className="text-lg font-bold text-green-900">–û–ü–õ–ê–ß–ï–ù</p>
                      </div>
                    </div>
                  </CardContent>
                </Card>

                {/* –í–µ—Å –∏ —Å—Ç–æ–∏–º–æ—Å—Ç—å */}
                <Card className="border-l-4 border-l-orange-500">
                  <CardContent className="p-4">
                    <div className="flex items-center space-x-3">
                      <DollarSign className="h-8 w-8 text-orange-600" />
                      <div>
                        <p className="text-sm font-medium text-gray-500">–í–µ—Å / –°—É–º–º–∞</p>
                        <p className="text-lg font-bold text-orange-900">
                          {selectedCargoForManagement.weight || '–ù/–î'} –∫–≥ / {selectedCargoForManagement.payment_amount}‚ÇΩ
                        </p>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </div>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ */}
              <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                {/* –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å */}
                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center text-lg">
                      <User className="mr-2 h-5 w-5" />
                      –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-3">
                    <div>
                      <p className="text-sm text-gray-500">–§–ò–û</p>
                      <p className="font-semibold">{selectedCargoForManagement.sender.full_name}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">–¢–µ–ª–µ—Ñ–æ–Ω</p>
                      <p className="font-semibold">{selectedCargoForManagement.sender.phone}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">–ê–¥—Ä–µ—Å</p>
                      <p className="font-semibold">{selectedCargoForManagement.sender.address}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Email</p>
                      <p className="font-semibold text-blue-600">{selectedCargoForManagement.sender.email}</p>
                    </div>
                  </CardContent>
                </Card>

                {/* –ü–æ–ª—É—á–∞—Ç–µ–ª—å */}
                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center text-lg">
                      <Users className="mr-2 h-5 w-5" />
                      –ü–æ–ª—É—á–∞—Ç–µ–ª—å
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-3">
                    <div>
                      <p className="text-sm text-gray-500">–§–ò–û</p>
                      <p className="font-semibold">{selectedCargoForManagement.recipient.full_name}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">–¢–µ–ª–µ—Ñ–æ–Ω</p>
                      <p className="font-semibold">{selectedCargoForManagement.recipient.phone}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">–ê–¥—Ä–µ—Å</p>
                      <p className="font-semibold">{selectedCargoForManagement.recipient.address}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Email</p>
                      <p className="font-semibold text-blue-600">{selectedCargoForManagement.recipient.email}</p>
                    </div>
                  </CardContent>
                </Card>
              </div>

              {/* –î–µ—Ç–∞–ª–∏ –≥—Ä—É–∑–∞ */}
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center text-lg">
                    <FileText className="mr-2 h-5 w-5" />
                    –î–µ—Ç–∞–ª–∏ –≥—Ä—É–∑–∞
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                      <p className="text-sm text-gray-500">–í–µ—Å</p>
                      <p className="font-semibold">{selectedCargoForManagement.weight || '–ù/–î'} –∫–≥</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">–û–±—ä—è–≤–ª–µ–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å</p>
                      <p className="font-semibold">{selectedCargoForManagement.payment_amount || '–ù/–î'}‚ÇΩ</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</p>
                      <p className="font-semibold">
                        –ë–ª–æ–∫ {selectedCargoForManagement.location?.block}, 
                        –ü–æ–ª–∫–∞ {selectedCargoForManagement.location?.shelf}, 
                        –Ø—á–µ–π–∫–∞ {selectedCargoForManagement.location?.cell}
                      </p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">–°–∫–ª–∞–¥</p>
                      <p className="font-semibold">{selectedCargoForManagement.location?.warehouse_name}</p>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π */}
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center text-lg">
                    <Clock className="mr-2 h-5 w-5" />
                    –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    {selectedCargoForManagement.history.map((item, index) => (
                      <div key={index} className="flex items-start space-x-4 p-3 bg-gray-50 rounded-lg">
                        <div className="w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"></div>
                        <div className="flex-1">
                          <div className="flex justify-between items-start">
                            <div>
                              <p className="font-semibold text-gray-900">{item.action}</p>
                              <p className="text-sm text-gray-500">–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å: {item.user}</p>
                            </div>
                            <p className="text-xs text-gray-400 whitespace-nowrap">{item.date}</p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </CardContent>
              </Card>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–≤—è–∑–∞–Ω–Ω—ã—Ö –≥—Ä—É–∑–∞—Ö (–µ—Å–ª–∏ –µ—Å—Ç—å) */}
              {selectedCargoForManagement?.hasRelatedCargo && (
                <Card className="bg-gradient-to-r from-indigo-50 to-purple-50 border-indigo-200">
                  <CardHeader>
                    <CardTitle className="flex items-center text-lg text-indigo-900">
                      <Package2 className="mr-2 h-5 w-5" />
                      –°–≤—è–∑–∞–Ω–Ω—ã–µ –≥—Ä—É–∑—ã —Ç–æ–≥–æ –∂–µ –∫–ª–∏–µ–Ω—Ç–∞
                    </CardTitle>
                    <CardDescription className="text-indigo-700">
                      –î—Ä—É–≥–∏–µ –≥—Ä—É–∑—ã –æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è: <strong>{selectedCargoForManagement.relatedCargo?.sender}</strong>
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-4">
                      {/* –°–≤–æ–¥–∫–∞ */}
                      <div className="bg-white p-4 rounded-lg border border-indigo-200">
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                          <div>
                            <p className="text-sm text-indigo-600">–í—Å–µ–≥–æ –≥—Ä—É–∑–æ–≤ –∫–ª–∏–µ–Ω—Ç–∞</p>
                            <p className="text-2xl font-bold text-indigo-900">
                              {selectedCargoForManagement.relatedCargo?.totalCargo || 0}
                            </p>
                          </div>
                          <div>
                            <p className="text-sm text-indigo-600">–†–∞–∑–º–µ—â–µ–Ω–æ –Ω–∞ —Å–∫–ª–∞–¥–µ</p>
                            <p className="text-2xl font-bold text-green-900">
                              {selectedCargoForManagement.relatedCargo?.cargoNumbers?.length || 0}
                            </p>
                          </div>
                          <div>
                            <p className="text-sm text-indigo-600">–û–∂–∏–¥–∞–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</p>
                            <p className="text-2xl font-bold text-orange-900">
                              {Math.max(0, (selectedCargoForManagement.relatedCargo?.totalCargo || 0) - (selectedCargoForManagement.relatedCargo?.cargoNumbers?.length || 0))}
                            </p>
                          </div>
                        </div>
                      </div>

                      {/* –°–ø–∏—Å–æ–∫ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤ */}
                      <div>
                        <h4 className="font-semibold text-indigo-800 mb-3">üì¶ –†–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã:</h4>
                        <div className="space-y-2">
                          {selectedCargoForManagement.relatedCargo?.cargoNumbers?.map((cargoNumber, index) => {
                            const blockNum = Math.floor(Math.random() * 3) + 1;
                            const cellNum = Math.floor(Math.random() * 20) + 1;
                            const isCurrentCargo = cargoNumber === selectedCargoForManagement.cargo_number;
                            
                            return (
                              <div key={index} className={`flex items-center justify-between p-3 rounded-lg border ${
                                isCurrentCargo ? 'bg-yellow-50 border-yellow-300' : 'bg-gray-50 border-gray-200'
                              }`}>
                                <div className="flex items-center space-x-3">
                                  <div className={`w-3 h-3 rounded-full ${
                                    isCurrentCargo ? 'bg-yellow-500' : 'bg-indigo-500'
                                  }`}></div>
                                  <div>
                                    <p className="font-semibold text-gray-900">
                                      {cargoNumber}
                                      {isCurrentCargo && <span className="ml-2 text-yellow-600">(—Ç–µ–∫—É—â–∏–π)</span>}
                                    </p>
                                    <p className="text-sm text-gray-600">
                                      üìç –ë–ª–æ–∫ {blockNum}, –Ø—á–µ–π–∫–∞ {cellNum}
                                    </p>
                                  </div>
                                </div>
                                <div className="text-right">
                                  <div className="flex items-center space-x-2">
                                    <span className="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                      –†–∞–∑–º–µ—â–µ–Ω
                                    </span>
                                    <span className="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                      –û–ø–ª–∞—á–µ–Ω
                                    </span>
                                  </div>
                                  <p className="text-xs text-gray-500 mt-1">
                                    {new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}
                                  </p>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>

                      {/* –ù–µ—Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã */}
                      {(selectedCargoForManagement.relatedCargo?.totalCargo || 0) > (selectedCargoForManagement.relatedCargo?.cargoNumbers?.length || 0) && (
                        <div>
                          <h4 className="font-semibold text-orange-800 mb-3">‚è≥ –û–∂–∏–¥–∞—é—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:</h4>
                          <div className="space-y-2">
                            {Array.from({
                              length: Math.max(0, (selectedCargoForManagement.relatedCargo?.totalCargo || 0) - (selectedCargoForManagement.relatedCargo?.cargoNumbers?.length || 0))
                            }, (_, index) => (
                              <div key={index} className="flex items-center justify-between p-3 rounded-lg border bg-orange-50 border-orange-200">
                                <div className="flex items-center space-x-3">
                                  <div className="w-3 h-3 rounded-full bg-orange-500"></div>
                                  <div>
                                    <p className="font-semibold text-gray-900">
                                      CRG{Date.now()}-PENDING-{index + 1}
                                    </p>
                                    <p className="text-sm text-gray-600">
                                      üìç –ù–∞ —Å–∫–ª–∞–¥–µ: –ú–æ—Å–∫–≤–∞ (–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π)
                                    </p>
                                  </div>
                                </div>
                                <div className="text-right">
                                  <div className="flex items-center space-x-2">
                                    <span className="px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                      –û–∂–∏–¥–∞–µ—Ç
                                    </span>
                                    <span className="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                      –û–ø–ª–∞—á–µ–Ω
                                    </span>
                                  </div>
                                  <p className="text-xs text-gray-500 mt-1">
                                    –ü–æ—Å—Ç—É–ø–∏–ª: {new Date().toISOString().split('T')[0]}
                                  </p>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </CardContent>
                </Card>
              )}

              {/* –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
              <Card className="bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200">
                <CardHeader>
                  <CardTitle className="flex items-center text-lg text-blue-900">
                    <Settings className="mr-2 h-5 w-5" />
                    –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥—Ä—É–∑–æ–º
                  </CardTitle>
                  <CardDescription className="text-blue-700">
                    –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –≥—Ä—É–∑–æ–º
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {/* –ü–µ—Ä–µ–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞ */}
                    <Button
                      className="h-16 flex-col space-y-1 bg-blue-600 hover:bg-blue-700 text-white"
                      onClick={() => {
                        const newCell = prompt('–í–≤–µ–¥–∏—Ç–µ ID –Ω–æ–≤–æ–π —è—á–µ–π–∫–∏ –¥–ª—è –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞:');
                        if (newCell) {
                          handleMoveCargoToCell(selectedCargoForManagement.id, newCell);
                          setShowCargoManagementModal(false);
                        }
                      }}
                    >
                      <ArrowUp className="h-5 w-5" />
                      <span className="text-sm font-medium">–ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≥—Ä—É–∑</span>
                      <span className="text-xs opacity-90">–≤ –¥—Ä—É–≥—É—é —è—á–µ–π–∫—É</span>
                    </Button>

                    {/* –í–æ–∑–≤—Ä–∞—Ç —Ç–æ–≤–∞—Ä–∞ */}
                    <Button
                      className="h-16 flex-col space-y-1 bg-red-600 hover:bg-red-700 text-white"
                      onClick={() => {
                        const reason = prompt('–£–∫–∞–∂–∏—Ç–µ –ø—Ä–∏—á–∏–Ω—É –≤–æ–∑–≤—Ä–∞—Ç–∞:');
                        if (reason) {
                          handleReturnCargo(selectedCargoForManagement.id, reason);
                          setShowCargoManagementModal(false);
                        }
                      }}
                    >
                      <Ban className="h-5 w-5" />
                      <span className="text-sm font-medium">–í–æ–∑–≤—Ä–∞—Ç —Ç–æ–≤–∞—Ä–∞</span>
                      <span className="text-xs opacity-90">–æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é</span>
                    </Button>

                    {/* –†–∞–∑–º–µ—â–µ–Ω–∏–µ –Ω–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç */}
                    <Button
                      className="h-16 flex-col space-y-1 bg-green-600 hover:bg-green-700 text-white"
                      onClick={() => {
                        const transportId = prompt('–í–≤–µ–¥–∏—Ç–µ ID —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞:');
                        if (transportId) {
                          handleMoveCargoToTransport(selectedCargoForManagement.id, transportId);
                          setShowCargoManagementModal(false);
                        }
                      }}
                    >
                      <Truck className="h-5 w-5" />
                      <span className="text-sm font-medium">–ù–∞ —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç</span>
                      <span className="text-xs opacity-90">–¥–ª—è –¥–æ—Å—Ç–∞–≤–∫–∏</span>
                    </Button>

                    {/* –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ */}
                    <Button
                      className="h-16 flex-col space-y-1 bg-orange-600 hover:bg-orange-700 text-white"
                      onClick={() => {
                        alert('–§—É–Ω–∫—Ü–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≥—Ä—É–∑–∞ –±—É–¥–µ—Ç —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –≤ —Å–ª–µ–¥—É—é—â–∏—Ö –≤–µ—Ä—Å–∏—è—Ö');
                      }}
                    >
                      <Edit className="h-5 w-5" />
                      <span className="text-sm font-medium">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</span>
                      <span className="text-xs opacity-90">–∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é</span>
                    </Button>
                  </div>
                </CardContent>
              </Card>

              {/* –ö–Ω–æ–ø–∫–∏ –∑–∞–∫—Ä—ã—Ç–∏—è */}
              <div className="flex justify-end space-x-2">
                <Button variant="outline" onClick={() => setShowCargoManagementModal(false)}>
                  –ó–∞–∫—Ä—ã—Ç—å
                </Button>
                <Button className="bg-blue-600 hover:bg-blue-700 text-white">
                  <Printer className="mr-2 h-4 w-4" />
                  –ü–µ—á–∞—Ç—å –æ—Ç—á–µ—Ç–∞
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –û–¢–ß–ï–¢–ê –ü–û –°–ö–õ–ê–î–£ */}
      <Dialog open={!!showWarehouseReport} onOpenChange={() => setShowWarehouseReport(null)}>
        <DialogContent className="max-w-7xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <FileText className="mr-2 h-5 w-5" />
              –û—Ç—á–µ—Ç –ø–æ —Å–∫–ª–∞–¥—É
            </DialogTitle>
            <DialogDescription>
              {showWarehouseReport && (
                <span>
                  –ü–æ–¥—Ä–æ–±–Ω—ã–π –æ—Ç—á–µ—Ç –æ –≥—Ä—É–∑–∞—Ö —Å–∫–ª–∞–¥–∞: <strong>
                    {operatorWarehouses.find(w => w.id === showWarehouseReport)?.name}
                  </strong>
                </span>
              )}
            </DialogDescription>
          </DialogHeader>
          
          {showWarehouseReport && (
            <div className="space-y-6">
              {/* –°–≤–æ–¥–Ω–∞—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∞ */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                  <div className="text-center">
                    <Package className="mx-auto h-8 w-8 text-blue-600 mb-2" />
                    <p className="text-sm font-medium text-blue-700">–í—Å–µ–≥–æ –≥—Ä—É–∑–æ–≤</p>
                    <p className="text-2xl font-bold text-blue-900">{warehouseReportData.length}</p>
                  </div>
                </div>
                
                <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                  <div className="text-center">
                    <DollarSign className="mx-auto h-8 w-8 text-green-600 mb-2" />
                    <p className="text-sm font-medium text-green-700">–û–±—â–∞—è —Å—É–º–º–∞</p>
                    <p className="text-2xl font-bold text-green-900">
                      {warehouseReportData.reduce((sum, item) => sum + item.total_amount, 0).toLocaleString()} ‚ÇΩ
                    </p>
                  </div>
                </div>
                
                <div className="bg-purple-50 p-4 rounded-lg border border-purple-200">
                  <div className="text-center">
                    <Package2 className="mx-auto h-8 w-8 text-purple-600 mb-2" />
                    <p className="text-sm font-medium text-purple-700">–û–±—â–∏–π –≤–µ—Å</p>
                    <p className="text-2xl font-bold text-purple-900">
                      {warehouseReportData.reduce((sum, item) => sum + item.weight, 0).toFixed(1)} –∫–≥
                    </p>
                  </div>
                </div>
                
                <div className="bg-orange-50 p-4 rounded-lg border border-orange-200">
                  <div className="text-center">
                    <Users className="mx-auto h-8 w-8 text-orange-600 mb-2" />
                    <p className="text-sm font-medium text-orange-700">–£–Ω–∏–∫. –∫–ª–∏–µ–Ω—Ç—ã</p>
                    <p className="text-2xl font-bold text-orange-900">
                      {new Set(warehouseReportData.map(item => item.sender)).size}
                    </p>
                  </div>
                </div>
              </div>

              {/* –§–∏–ª—å—Ç—Ä—ã –∏ –ø–æ–∏—Å–∫ */}
              <div className="flex justify-between items-center">
                <div className="flex space-x-4">
                  <input
                    type="text"
                    placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–æ–º–µ—Ä—É –≥—Ä—É–∑–∞ –∏–ª–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—é..."
                    className="px-4 py-2 border border-gray-300 rounded-lg w-80"
                  />
                  <select className="px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã –æ–ø–ª–∞—Ç—ã</option>
                    <option value="paid">–û–ø–ª–∞—á–µ–Ω–æ</option>
                    <option value="transfer">–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É</option>
                    <option value="cod">–û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏</option>
                    <option value="debt">–û–ø–ª–∞—Ç–∞ –≤ –¥–æ–ª–≥</option>
                  </select>
                </div>
                
                <Button className="bg-green-600 hover:bg-green-700">
                  <Download className="mr-2 h-4 w-4" />
                  –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel
                </Button>
              </div>

              {/* –¢–∞–±–ª–∏—Ü–∞ –æ—Ç—á–µ—Ç–∞ */}
              <div className="overflow-x-auto">
                <table className="w-full border-collapse border border-gray-300">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        –ù–æ–º–µ—Ä –≥—Ä—É–∑–∞
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        –í–µ—Å (–∫–≥)
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        –°—É–º–º–∞ (‚ÇΩ)
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        –ü–æ–ª—É—á–∞—Ç–µ–ª—å
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        –¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        –ú–∞—Ä—à—Ä—É—Ç
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        –°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        –î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {warehouseReportData.map((item, index) => (
                      <tr key={item.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="border border-gray-300 px-3 py-2 text-sm font-semibold text-blue-600">
                          {item.cargo_number}
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm">
                          {item.cargo_name}
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm text-center">
                          {item.weight}
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm font-semibold text-green-600">
                          {item.total_amount.toLocaleString()}
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm">
                          {item.sender}
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm">
                          {item.recipient}
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm font-mono">
                          {item.recipient_phone}
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm">
                          {item.route}
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm">
                          <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                            item.payment_status === '–û–ø–ª–∞—á–µ–Ω–æ' ? 'bg-green-100 text-green-800' :
                            item.payment_status === '–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É' ? 'bg-blue-100 text-blue-800' :
                            item.payment_status === '–û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                          }`}>
                            {item.payment_status}
                          </span>
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm">
                          {item.acceptance_date}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* –î–µ–π—Å—Ç–≤–∏—è */}
              <div className="flex justify-end space-x-2">
                <Button variant="outline" onClick={() => setShowWarehouseReport(null)}>
                  –ó–∞–∫—Ä—ã—Ç—å
                </Button>
                <Button className="bg-blue-600 hover:bg-blue-700">
                  <Printer className="mr-2 h-4 w-4" />
                  –ü–µ—á–∞—Ç—å –æ—Ç—á–µ—Ç–∞
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* QR –∫–æ–¥ —Å–æ–∑–¥–∞–Ω–Ω–æ–≥–æ –≥—Ä—É–∑–∞ */}
      <Dialog open={showCreatedCargoQRModal} onOpenChange={setShowCreatedCargoQRModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <QrCode className="mr-2 h-5 w-5" />
              QR –∫–æ–¥ –≥—Ä—É–∑–∞ –≥–æ—Ç–æ–≤!
            </DialogTitle>
            <DialogDescription>
              –ì—Ä—É–∑ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ QR –∫–æ–¥ –¥–ª—è –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π —Å –≥—Ä—É–∑–æ–º.
            </DialogDescription>
          </DialogHeader>
          {createdCargoQR && (
            <div className="space-y-4">
              <div className="text-center">
                <img 
                  src={createdCargoQR.qr_code} 
                  alt={`QR –∫–æ–¥ –≥—Ä—É–∑–∞ ${createdCargoQR.cargo_number}`}
                  className="mx-auto max-w-[200px] border rounded-lg"
                />
                <p className="mt-2 font-bold text-lg">{createdCargoQR.cargo_number}</p>
                <p className="text-sm text-green-600">{createdCargoQR.message}</p>
              </div>
              
              <div className="bg-gray-50 p-3 rounded-lg text-sm space-y-1">
                <div><strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> {createdCargoQR.cargo_info?.sender_name}</div>
                <div><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> {createdCargoQR.cargo_info?.recipient_name}</div>
                <div><strong>–ì—Ä—É–∑:</strong> {createdCargoQR.cargo_info?.cargo_name}</div>
                <div><strong>–í–µ—Å:</strong> {createdCargoQR.cargo_info?.weight} –∫–≥</div>
                <div><strong>–û–ø–ª–∞—Ç–∞:</strong> {getPaymentMethodText(createdCargoQR.cargo_info?.payment_method)}</div>
              </div>
              
              <div className="flex gap-2">
                <Button 
                  className="flex-1" 
                  onClick={() => {
                    const printWindow = window.open('', '_blank');
                    if (!printWindow) {
                      showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
                      return;
                    }
                    const printContent = `
                      <html>
                        <head>
                          <title>QR –∫–æ–¥ –≥—Ä—É–∑–∞ ${createdCargoQR.cargo_number}</title>
                          <style>
                            body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
                            .qr-container { border: 2px solid #333; padding: 20px; max-width: 400px; margin: 0 auto; }
                            .qr-code img { width: 200px; height: 200px; margin: 10px 0; }
                            .info { text-align: left; margin-top: 15px; line-height: 1.4; }
                          </style>
                        </head>
                        <body>
                          <div class="qr-container">
                            <h2>–ì–†–£–ó TAJLINE.TJ</h2>
                            <div class="qr-code">
                              <img src="${createdCargoQR.qr_code}" alt="QR –∫–æ–¥ –≥—Ä—É–∑–∞" />
                            </div>
                            <div class="info">
                              <div><strong>–ù–æ–º–µ—Ä –≥—Ä—É–∑–∞:</strong> ${createdCargoQR.cargo_number}</div>
                              <div><strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> ${createdCargoQR.cargo_info?.sender_name}</div>
                              <div><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> ${createdCargoQR.cargo_info?.recipient_name}</div>
                              <div><strong>–ì—Ä—É–∑:</strong> ${createdCargoQR.cargo_info?.cargo_name}</div>
                              <div><strong>–í–µ—Å:</strong> ${createdCargoQR.cargo_info?.weight} –∫–≥</div>
                            </div>
                            <div style="margin-top: 15px; font-size: 12px;">
                              –°–∫–∞–Ω–∏—Ä—É–π—Ç–µ –¥–ª—è –æ–ø–µ—Ä–∞—Ü–∏–π —Å –≥—Ä—É–∑–æ–º
                            </div>
                          </div>
                        </body>
                      </html>
                    `;
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    printWindow.print();
                  }}
                >
                  <Printer className="mr-2 h-4 w-4" />
                  –ü–µ—á–∞—Ç—å QR –∫–æ–¥–∞
                </Button>
                <Button 
                  variant="outline"
                  onClick={() => setShowCreatedCargoQRModal(false)}
                >
                  –ó–∞–∫—Ä—ã—Ç—å
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –≥—Ä—É–∑ */}
      <Dialog open={showScannedCargoModal} onOpenChange={setShowScannedCargoModal}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Package className="mr-2 h-5 w-5" />
              –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ
            </DialogTitle>
            <DialogDescription>
              –†–µ–∑—É–ª—å—Ç–∞—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è QR –∫–æ–¥–∞
            </DialogDescription>
          </DialogHeader>
          {scannedCargoInfo && (
            <div className="space-y-4">
              <div className="bg-blue-50 p-4 rounded-lg">
                <h3 className="font-bold text-lg mb-2">{scannedCargoInfo.cargo_number}</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div>
                    <p><strong>–ì—Ä—É–∑:</strong> {scannedCargoInfo.cargo_name}</p>
                    <p><strong>–í–µ—Å:</strong> {scannedCargoInfo.weight} –∫–≥</p>
                    <p><strong>–°—Ç–æ–∏–º–æ—Å—Ç—å:</strong> {scannedCargoInfo.declared_value} ‚ÇΩ</p>
                  </div>
                  <div>
                    <p><strong>–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</strong> {scannedCargoInfo.sender_name}</p>
                    <p><strong>–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</strong> {scannedCargoInfo.recipient_name}</p>
                    <p><strong>–¢–µ–ª–µ—Ñ–æ–Ω:</strong> {scannedCargoInfo.recipient_phone}</p>
                  </div>
                </div>
              </div>
              
              <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 text-sm">
                <div className="bg-gray-50 p-3 rounded-lg">
                  <p className="font-medium">–°—Ç–∞—Ç—É—Å –≥—Ä—É–∑–∞</p>
                  <p className="text-blue-600">{getStatusText(scannedCargoInfo.status)}</p>
                </div>
                <div className="bg-gray-50 p-3 rounded-lg">
                  <p className="font-medium">–û–±—Ä–∞–±–æ—Ç–∫–∞</p>
                  <p className="text-green-600">{getProcessingStatusText(scannedCargoInfo.processing_status)}</p>
                </div>
                <div className="bg-gray-50 p-3 rounded-lg">
                  <p className="font-medium">–û–ø–ª–∞—Ç–∞</p>
                  <p className="text-orange-600">{getPaymentStatusText(scannedCargoInfo.payment_status)}</p>
                </div>
              </div>
              
              {(scannedCargoInfo.block_number || scannedCargoInfo.warehouse_name) && (
                <div className="bg-green-50 p-3 rounded-lg">
                  <p className="font-medium mb-1">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ</p>
                  <p className="text-sm">
                    {scannedCargoInfo.warehouse_name}
                    {scannedCargoInfo.block_number && `, –ë–ª–æ–∫ ${scannedCargoInfo.block_number}`}
                    {scannedCargoInfo.shelf_number && `, –ü–æ–ª–∫–∞ ${scannedCargoInfo.shelf_number}`}
                    {scannedCargoInfo.cell_number && `, –Ø—á–µ–π–∫–∞ ${scannedCargoInfo.cell_number}`}
                  </p>
                </div>
              )}
              
              {scannedCargoInfo.available_operations && scannedCargoInfo.available_operations.length > 0 && (
                <div>
                  <p className="font-medium mb-2">–î–æ—Å—Ç—É–ø–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:</p>
                  <div className="flex flex-wrap gap-2">
                    {scannedCargoInfo.available_operations.map((operation, index) => (
                      <Button 
                        key={index}
                        variant="outline" 
                        size="sm"
                        onClick={() => handleCargoOperation(operation, scannedCargoInfo)}
                      >
                        {getOperationText(operation)}
                      </Button>
                    ))}
                  </div>
                </div>
              )}
              
              <div className="flex justify-end">
                <Button onClick={() => setShowScannedCargoModal(false)}>
                  –ó–∞–∫—Ä—ã—Ç—å
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* QR —Å–∫–∞–Ω–µ—Ä */}
      <Dialog open={showQRScannerModal} onOpenChange={setShowQRScannerModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Camera className="mr-2 h-5 w-5" />
              –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ QR –∫–æ–¥–∞ –≥—Ä—É–∑–∞
            </DialogTitle>
            <DialogDescription>
              –ù–∞–≤–µ–¥–∏—Ç–µ –∫–∞–º–µ—Ä—É –Ω–∞ QR –∫–æ–¥ –≥—Ä—É–∑–∞ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div className="bg-black rounded-lg overflow-hidden" style={{aspectRatio: '1/1'}}>
              <div id="qr-reader-modal" style={{width: '100%', height: '100%'}}></div>
            </div>
            <div className="flex gap-2">
              <Button 
                variant="outline" 
                onClick={() => {
                  // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º –∫–∞–º–µ—Ä—É
                  switchModalCamera();
                }}
                className="flex-1"
              >
                <RefreshCw className="mr-2 h-4 w-4" />
                –ü–µ—Ä–µ–∫–ª—é—á–∏—Ç—å –∫–∞–º–µ—Ä—É
              </Button>
              <Button 
                variant="outline" 
                onClick={stopCargoQRScanner}
                className="flex-1"
              >
                –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* New QR Generation Modal - Mobile Adapted */}
      <Dialog open={showQRGenerateModal} onOpenChange={setShowQRGenerateModal}>
        <DialogContent className="w-full max-w-[95vw] max-h-[95vh] p-3 sm:p-6 overflow-y-auto">
          <DialogHeader className="pb-2">
            <DialogTitle className="flex items-center text-lg">
              <QrCode className="mr-2 h-5 w-5" />
              –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞
            </DialogTitle>
            <DialogDescription className="text-sm">
              –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≥—Ä—É–∑–∞ –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <Label htmlFor="cargo-number-input">–ù–æ–º–µ—Ä –≥—Ä—É–∑–∞</Label>
              <Input
                id="cargo-number-input"
                type="text"
                placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –≥—Ä—É–∑–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: TEMP-123456)"
                value={qrGenerateCargoNumber}
                onChange={(e) => {
                  setQrGenerateCargoNumber(e.target.value);
                  // Clear previous QR when user changes input
                  if (generatedSingleQR) {
                    setGeneratedSingleQR(null);
                  }
                }}
                disabled={qrGenerateLoading}
                className="mt-1"
              />
              <p className="text-xs text-gray-500 mt-1">
                –°–∏—Å—Ç–µ–º–∞ –ø—Ä–æ–≤–µ—Ä–∏—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ –ø–µ—Ä–µ–¥ –≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π QR –∫–æ–¥–∞
              </p>
            </div>
            
            {generatedSingleQR && (
              <div className="space-y-3">
                <div className="text-center">
                  <p className="text-sm font-medium text-green-600 mb-2">
                    QR –∫–æ–¥ –¥–ª—è –≥—Ä—É–∑–∞: {generatedSingleQR.cargo_number}
                  </p>
                  <div className="bg-white p-4 rounded-lg border inline-block">
                    <img 
                      src={generatedSingleQR.qr_code} 
                      alt={`QR –∫–æ–¥ ${generatedSingleQR.cargo_number}`}
                      className="w-48 h-48 mx-auto"
                    />
                  </div>
                </div>
                <div className="flex gap-2">
                  <Button
                    variant="outline"
                    onClick={() => {
                      const link = document.createElement('a');
                      link.href = generatedSingleQR.qr_code;
                      link.download = `qr-${generatedSingleQR.cargo_number}.png`;
                      link.click();
                    }}
                    className="flex-1"
                  >
                    <Download className="mr-2 h-4 w-4" />
                    –°–∫–∞—á–∞—Ç—å
                  </Button>
                  <Button
                    variant="outline"
                    onClick={() => {
                      const printWindow = window.open('', '_blank');
                      if (!printWindow) {
                        showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
                        return;
                      }
                      printWindow.document.write(`
                        <html>
                          <head><title>QR –∫–æ–¥ ${generatedSingleQR.cargo_number}</title></head>
                          <body style="text-align: center; padding: 20px;">
                            <h2>QR –∫–æ–¥ –≥—Ä—É–∑–∞: ${generatedSingleQR.cargo_number}</h2>
                            <img src="${generatedSingleQR.qr_code}" style="width: 300px; height: 300px;" />
                            <p>–ì—Ä—É–∑: ${generatedSingleQR.cargo_name}</p>
                          </body>
                        </html>
                      `);
                      printWindow.document.close();
                      printWindow.print();
                    }}
                    className="flex-1"
                  >
                    <Printer className="mr-2 h-4 w-4" />
                    –ü–µ—á–∞—Ç—å
                  </Button>
                </div>
              </div>
            )}
            
            <div className="flex gap-2">
              <Button 
                onClick={generateQRByCargoNumber}
                disabled={!qrGenerateCargoNumber.trim() || qrGenerateLoading}
                className="flex-1"
              >
                {qrGenerateLoading ? (
                  <>
                    <RefreshCw className="mr-2 h-4 w-4 animate-spin" />
                    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...
                  </>
                ) : (
                  <>
                    <QrCode className="mr-2 h-4 w-4" />
                    –°–æ–∑–¥–∞—Ç—å QR –∫–æ–¥
                  </>
                )}
              </Button>
              <Button 
                variant="outline" 
                onClick={() => {
                  setShowQRGenerateModal(false);
                  setQrGenerateCargoNumber('');
                  setGeneratedSingleQR(null);
                }}
              >
                –ó–∞–∫—Ä—ã—Ç—å
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ù–û–í–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: QR –∫–æ–¥ –∑–∞—è–≤–∫–∏ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π –æ –≤—Å–µ—Ö –≥—Ä—É–∑–∞—Ö */}
      <Dialog open={showRequestQRModal} onOpenChange={setShowRequestQRModal}>
        <DialogContent className="w-full max-w-[95vw] max-h-[95vh] p-4 sm:p-6 overflow-y-auto">
          <DialogHeader className="pb-4">
            <DialogTitle className="flex items-center text-lg">
              <QrCode className="mr-2 h-5 w-5 text-orange-600" />
              QR –∫–æ–¥ –∑–∞—è–≤–∫–∏ ‚Ññ{selectedRequestForQR?.cargo_number}
            </DialogTitle>
            <DialogDescription className="text-sm">
              QR –∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Å–µ—Ö –≥—Ä—É–∑–∞—Ö –≤ –∑–∞—è–≤–∫–µ –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º
            </DialogDescription>
          </DialogHeader>
          
          {requestQRLoading ? (
            <div className="flex flex-col items-center justify-center py-8">
              <RefreshCw className="h-8 w-8 animate-spin text-orange-600 mb-4" />
              <p className="text-sm text-gray-600">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞ –∑–∞—è–≤–∫–∏...</p>
            </div>
          ) : requestQRCode && selectedRequestForQR ? (
            <div className="space-y-6">
              {/* QR –∫–æ–¥ */}
              <div className="text-center">
                <div className="bg-white p-6 rounded-lg border-2 border-orange-200 inline-block">
                  <img 
                    src={requestQRCode.image} 
                    alt={`QR –∫–æ–¥ –∑–∞—è–≤–∫–∏ ${selectedRequestForQR.cargo_number}`}
                    className="w-64 h-64 mx-auto"
                  />
                </div>
                <p className="text-sm text-gray-500 mt-2">
                  –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞—è–≤–∫–µ
                </p>
              </div>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ */}
              <div className="bg-gray-50 p-4 rounded-lg">
                <h4 className="font-medium mb-3 text-gray-800">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –≤ QR –∫–æ–¥–µ:</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 text-sm">
                  <div>
                    <span className="font-medium text-gray-600">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</span>
                    <p>{requestQRCode.data.sender.name}</p>
                    <p className="text-gray-500">{requestQRCode.data.sender.phone}</p>
                  </div>
                  <div>
                    <span className="font-medium text-gray-600">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</span>
                    <p>{requestQRCode.data.recipient.name}</p>
                    <p className="text-gray-500">{requestQRCode.data.recipient.phone}</p>
                  </div>
                  <div>
                    <span className="font-medium text-gray-600">–û–±—â–∏–π –≤–µ—Å:</span>
                    <p>{requestQRCode.data.total_weight} –∫–≥</p>
                  </div>
                  <div>
                    <span className="font-medium text-gray-600">–°—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                    <p>{requestQRCode.data.total_value} ‚ÇΩ</p>
                  </div>
                  <div>
                    <span className="font-medium text-gray-600">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–∑–æ–≤:</span>
                    <p>{requestQRCode.data.cargo_items.length} —à—Ç.</p>
                  </div>
                  <div>
                    <span className="font-medium text-gray-600">–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:</span>
                    <p>{requestQRCode.data.created_date}</p>
                  </div>
                </div>
              </div>

              {/* –°–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤ */}
              <div className="bg-blue-50 p-4 rounded-lg">
                <h4 className="font-medium mb-3 text-gray-800">–ì—Ä—É–∑—ã –≤ –∑–∞—è–≤–∫–µ:</h4>
                <div className="space-y-2">
                  {requestQRCode.data.cargo_items.map((item, index) => (
                    <div key={index} className="bg-white p-3 rounded border">
                      <div className="flex justify-between items-start">
                        <div>
                          <p className="font-medium">{item.name}</p>
                          <p className="text-sm text-gray-600">
                            –í–µ—Å: {item.weight} –∫–≥ √ó –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {item.quantity} —à—Ç.
                          </p>
                        </div>
                        <div className="text-right">
                          <p className="font-medium text-blue-600">{item.total_amount} ‚ÇΩ</p>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
              <div className="flex gap-2">
                <Button 
                  onClick={handlePrintRequestQR}
                  className="flex-1 bg-orange-600 hover:bg-orange-700"
                >
                  <Printer className="mr-2 h-4 w-4" />
                  –ü–µ—á–∞—Ç—å QR –∫–æ–¥–∞
                </Button>
                <Button 
                  variant="outline" 
                  onClick={() => {
                    const link = document.createElement('a');
                    link.href = requestQRCode.image;
                    link.download = `QR_–∑–∞—è–≤–∫–∞_${selectedRequestForQR.cargo_number}.png`;
                    link.click();
                    showAlert('QR –∫–æ–¥ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
                  }}
                  className="flex-1"
                >
                  <Download className="mr-2 h-4 w-4" />
                  –°–∫–∞—á–∞—Ç—å
                </Button>
              </div>

              {/* –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è (—Å–≤–æ—Ä–∞—á–∏–≤–∞–µ–º–∞—è) */}
              <details className="mt-4">
                <summary className="cursor-pointer text-sm text-gray-600 hover:text-gray-800">
                  –ü–æ–∫–∞–∑–∞—Ç—å –¥–∞–Ω–Ω—ã–µ QR –∫–æ–¥–∞ (JSON)
                </summary>
                <pre className="mt-2 bg-gray-100 p-3 rounded text-xs overflow-auto max-h-40">
                  {requestQRCode.raw_data}
                </pre>
              </details>
            </div>
          ) : (
            <div className="text-center py-8">
              <p className="text-gray-500">–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞</p>
            </div>
          )}

          <div className="flex justify-end mt-6">
            <Button 
              variant="outline" 
              onClick={() => {
                setShowRequestQRModal(false);
                setSelectedRequestForQR(null);
                setRequestQRCode(null);
              }}
            >
              –ó–∞–∫—Ä—ã—Ç—å
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ù–û–í–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: QR –∫–æ–¥ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏ –∏–∑ —Ñ–æ—Ä–º—ã –ø—Ä–∏–µ–º–∞ –≥—Ä—É–∑–∞ */}
      <Dialog open={showCargoNumberQRModal} onOpenChange={setShowCargoNumberQRModal}>
        <DialogContent className="w-full max-w-md p-4 sm:p-6">
          <DialogHeader className="pb-4">
            <DialogTitle className="flex items-center text-lg">
              <QrCode className="mr-2 h-5 w-5 text-orange-600" />
              QR –∫–æ–¥ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏
            </DialogTitle>
            <DialogDescription className="text-sm">
              QR –∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä –∑–∞—è–≤–∫–∏. –†–∞–∑–º–µ—Ä –ø–µ—á–∞—Ç–∏: 90–º–º √ó 100–º–º
            </DialogDescription>
          </DialogHeader>
          
          {cargoNumberQRLoading ? (
            <div className="flex flex-col items-center justify-center py-8">
              <RefreshCw className="h-8 w-8 animate-spin text-orange-600 mb-4" />
              <p className="text-sm text-gray-600">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏...</p>
            </div>
          ) : cargoNumberQRCode ? (
            <div className="space-y-6">
              {/* QR –∫–æ–¥ */}
              <div className="text-center">
                <div className="bg-white p-6 rounded-lg border-2 border-orange-200 inline-block">
                  <img 
                    src={cargoNumberQRCode.image} 
                    alt={`QR –∫–æ–¥ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏ ${cargoNumberQRCode.number}`}
                    className="w-48 h-48 mx-auto"
                  />
                </div>
                <p className="text-lg font-bold text-gray-800 mt-3">
                  –ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏: {cargoNumberQRCode.number}
                </p>
                <p className="text-sm text-gray-500 mt-1">
                  –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏
                </p>
              </div>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ QR –∫–æ–¥–µ */}
              <div className="bg-orange-50 p-4 rounded-lg">
                <h4 className="font-medium mb-2 text-gray-800">–°–æ–¥–µ—Ä–∂–∏–º–æ–µ QR –∫–æ–¥–∞:</h4>
                <div className="text-center">
                  <div className="text-2xl font-mono font-bold text-orange-800 bg-white px-4 py-2 rounded border">
                    {cargoNumberQRCode.number}
                  </div>
                </div>
                <p className="text-sm text-gray-600 mt-2">
                  QR –∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç —Ç–æ–ª—å–∫–æ –Ω–æ–º–µ—Ä –∑–∞—è–≤–∫–∏ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏
                </p>
                <p className="text-xs text-gray-500 mt-1">
                  –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω: {cargoNumberQRCode.generated_at}
                </p>
              </div>

              {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
              <div className="flex gap-2">
                <Button 
                  onClick={handlePrintCargoNumberQR}
                  className="flex-1 bg-orange-600 hover:bg-orange-700"
                >
                  <Printer className="mr-2 h-4 w-4" />
                  –ü–µ—á–∞—Ç—å (90√ó100–º–º)
                </Button>
                <Button 
                  variant="outline" 
                  onClick={() => {
                    const link = document.createElement('a');
                    link.href = cargoNumberQRCode.image;
                    link.download = `QR_–Ω–æ–º–µ—Ä_–∑–∞—è–≤–∫–∏_${cargoNumberQRCode.number}.png`;
                    link.click();
                    showAlert('QR –∫–æ–¥ –Ω–æ–º–µ—Ä–∞ –∑–∞—è–≤–∫–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!', 'success');
                  }}
                  className="flex-1"
                >
                  <Download className="mr-2 h-4 w-4" />
                  –°–∫–∞—á–∞—Ç—å
                </Button>
              </div>
            </div>
          ) : (
            <div className="text-center py-8">
              <p className="text-gray-500">–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–∞</p>
            </div>
          )}

          <div className="flex justify-end mt-6">
            <Button 
              variant="outline" 
              onClick={() => {
                setShowCargoNumberQRModal(false);
                setCargoNumberQRCode(null);
              }}
            >
              –ó–∞–∫—Ä—ã—Ç—å
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ù–û–í–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –î–µ—Ç–∞–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–æ–≤ (–∞–Ω–∞–ª–æ–≥ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ "–ü—Ä–∏–Ω—è—Ç—å –≥—Ä—É–∑") */}
      <Dialog open={showPlacementDetailsModal} onOpenChange={setShowPlacementDetailsModal}>
        <DialogContent className="w-full max-w-[95vw] max-h-[95vh] p-4 sm:p-6 overflow-y-auto">
          <DialogHeader className="pb-4">
            <DialogTitle className="flex items-center text-lg">
              <Settings className="mr-2 h-5 w-5 text-purple-600" />
              –î–µ—Ç–∞–ª—å–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ - –ó–∞—è–≤–∫–∞ ‚Ññ{selectedCargoForDetails?.cargo_number}
            </DialogTitle>
            <DialogDescription className="text-sm">
              –°—Ç–∞—Ç—É—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∫–∞–∂–¥–æ–≥–æ –≥—Ä—É–∑–∞ –≤ –∑–∞—è–≤–∫–µ. –ü–æ–∫–∞–∑–∞–Ω—ã —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –∏ –æ–∂–∏–¥–∞—é—â–∏–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑—ã.
            </DialogDescription>
          </DialogHeader>
          
          {placementDetailsLoading ? (
            <div className="flex flex-col items-center justify-center py-8">
              <RefreshCw className="h-8 w-8 animate-spin text-purple-600 mb-4" />
              <p className="text-sm text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ –¥–µ—Ç–∞–ª–µ–π —Ä–∞–∑–º–µ—â–µ–Ω–∏—è...</p>
            </div>
          ) : placementDetails ? (
            <div className="space-y-6">
              {/* –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ */}
              <div className="bg-blue-50 p-4 rounded-lg">
                <h4 className="font-medium mb-3 text-gray-800">üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 text-sm">
                  <div>
                    <span className="font-medium text-gray-600">–ù–æ–º–µ—Ä –∑–∞—è–≤–∫–∏:</span>
                    <p>‚Ññ{placementDetails.cargo_number}</p>
                  </div>
                  <div>
                    <span className="font-medium text-gray-600">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å:</span>
                    <p>{placementDetails.sender_full_name}</p>
                    <p className="text-gray-500">{placementDetails.sender_phone}</p>
                  </div>
                  <div>
                    <span className="font-medium text-gray-600">–ü–æ–ª—É—á–∞—Ç–µ–ª—å:</span>
                    <p>{placementDetails.recipient_full_name}</p>
                    <p className="text-gray-500">{placementDetails.recipient_phone}</p>
                  </div>
                  
                  {/* –ò–°–ü–†–ê–í–õ–ï–ù–û: –°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä—É–∑–∞ */}
                  <div>
                    <span className="font-medium text-gray-600">–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è:</span>
                    <p className="font-semibold text-green-600">
                      {placementDetails.delivery_method === 'pickup' ? 'üè™ –°–∞–º–æ–≤—ã–≤–æ–∑' :
                       placementDetails.delivery_method === 'city_delivery' ? 'üöö –î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –≥–æ—Ä–æ–¥–∞' :
                       placementDetails.delivery_method === 'home_delivery' ? 'üè† –î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –¥–æ–º–∞' :
                       placementDetails.delivery_method || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                    </p>
                  </div>
                  
                  {/* –ò–°–ü–†–ê–í–õ–ï–ù–û: –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã - —á–∏—Ç–∞–µ–º—ã–µ –Ω–∞–∑–≤–∞–Ω–∏—è */}
                  <div>
                    <span className="font-medium text-gray-600">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</span>
                    <p className="font-semibold text-blue-600">
                      {placementDetails.payment_method === 'cash' ? 'üí∏ –ù–∞–ª–∏—á–Ω—ã–º–∏' :
                       placementDetails.payment_method === 'card' ? 'üí≥ –ö–∞—Ä—Ç–æ–π' :
                       placementDetails.payment_method === 'transfer' ? 'üè¶ –ë–∞–Ω–∫–æ–≤—Å–∫–∏–º –ø–µ—Ä–µ–≤–æ–¥–æ–º' :
                       placementDetails.payment_method === 'debt' ? 'üìã –í –¥–æ–ª–≥' :
                       placementDetails.payment_method === 'not_paid' ? '‚è≥ –ù–µ –æ–ø–ª–∞—á–µ–Ω–æ' :
                       placementDetails.payment_method === 'cash_on_delivery' ? 'üí∞ –û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' :
                       placementDetails.payment_method === 'prepaid' ? '‚úÖ –ü—Ä–µ–¥–æ–ø–ª–∞—Ç–∞' :
                       placementDetails.payment_method || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                    </p>
                  </div>
                  
                  {/* –ù–û–í–û–ï: –ì–æ—Ä–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä—É–∑–∞ */}
                  <div>
                    <span className="font-medium text-gray-600">–ì–æ—Ä–æ–¥ –ø–æ–ª—É—á–µ–Ω–∏—è:</span>
                    <p className="font-semibold text-purple-600">
                      üèôÔ∏è {placementDetails.delivery_city || placementDetails.recipient_address?.split(',')[0] || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                    </p>
                  </div>
                  
                  {/* –ò–°–ü–†–ê–í–õ–ï–ù–û: –°–∫–ª–∞–¥ –ø—Ä–∏–µ–º–∞ - –ø–æ–∫–∞–∑–∞—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ */}
                  <div>
                    <span className="font-medium text-gray-600">–°–∫–ª–∞–¥ –ø—Ä–∏–µ–º–∞:</span>
                    <p className="font-semibold text-indigo-600">
                      üè≠ {placementDetails.source_warehouse_name || 
                           placementDetails.accepting_warehouse ||
                           operatorWarehouses[0]?.warehouse_name ||
                           '–ù–µ —É–∫–∞–∑–∞–Ω'}
                    </p>
                  </div>
                  
                  {/* –ù–û–í–û–ï: –°–∫–ª–∞–¥ –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –≤—ã–¥–∞–≤–∞—Ç—å –≥—Ä—É–∑ */}
                  <div>
                    <span className="font-medium text-gray-600">–°–∫–ª–∞–¥ –≤—ã–¥–∞—á–∏:</span>
                    <p className="font-semibold text-teal-600">
                      üè™ {placementDetails.target_warehouse_name || 
                           placementDetails.delivery_warehouse_name || 
                           placementDetails.delivery_warehouse ||
                           '–ù–µ —É–∫–∞–∑–∞–Ω'}
                    </p>
                  </div>
                  
                  {/* –ò–°–ü–†–ê–í–õ–ï–ù–û: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–µ—Ä–∞—Ç–æ—Ä–µ - –ø–æ–∫–∞–∑–∞—Ç—å –§–ò–û */}
                  <div>
                    <span className="font-medium text-gray-600">–û–ø–µ—Ä–∞—Ç–æ—Ä –ø—Ä–∏–µ–º–∞:</span>
                    <p className="font-semibold text-green-600">
                      üë§ {placementDetails.operator_full_name || 
                           placementDetails.accepting_operator ||
                           placementDetails.operator_name ||
                           user?.full_name || 
                           '–¢–µ—Å—Ç–æ–≤—ã–π –û–ø–µ—Ä–∞—Ç–æ—Ä –ü—Ä–∏—ë–º–∞ –ó–∞—è–≤–æ–∫'}
                    </p>
                    <p className="text-gray-500 text-xs">
                      {placementDetails.operator_phone || user?.phone || '+79777888999'}
                    </p>
                  </div>
                  
                  {/* –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ */}
                  <div>
                    <span className="font-medium text-gray-600">–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞:</span>
                    <p className="font-semibold text-gray-700">
                      üìÖ {placementDetails.created_date ? 
                          new Date(placementDetails.created_date).toLocaleDateString('ru-RU') : 
                          '–ù–µ —É–∫–∞–∑–∞–Ω–∞'} 
                      {placementDetails.created_date && (
                        <span className="text-xs text-gray-500 block">
                          –≤ {new Date(placementDetails.created_date).toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}
                        </span>
                      )}
                    </p>
                  </div>
                  
                  <div>
                    <span className="font-medium text-gray-600">–û–±—â–∏–π –ø—Ä–æ–≥—Ä–µ—Å—Å:</span>
                    {(() => {
                      // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö individual_units
                      let totalUnits = 0;
                      let placedUnits = 0;
                      
                      (placementDetails.cargo_types || []).forEach(cargoType => {
                        if (cargoType.individual_units && cargoType.individual_units.length > 0) {
                          totalUnits += cargoType.individual_units.length;
                          placedUnits += cargoType.individual_units.filter(unit => unit.is_placed === true).length;
                        } else {
                          // Fallback –∫ quantity –µ—Å–ª–∏ individual_units –Ω–µ—Ç
                          totalUnits += cargoType.quantity || 0;
                          placedUnits += cargoType.placed_count || 0;
                        }
                      });
                      
                      const progressText = `${placedUnits}/${totalUnits}`;
                      const overallStatus = totalUnits > 0 && placedUnits === totalUnits ? 'fully_placed' : 
                                           placedUnits > 0 ? 'partially_placed' : 'pending';
                      
                      return (
                        <>
                          <p className="font-bold text-blue-600 text-lg">
                            {progressText}
                          </p>
                          <p className={`text-sm ${
                            overallStatus === 'fully_placed' ? 'text-green-600' :
                            overallStatus === 'partially_placed' ? 'text-yellow-600' :
                            'text-red-600'
                          }`}>
                            {overallStatus === 'fully_placed' ? '‚úÖ –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–æ' :
                             overallStatus === 'partially_placed' ? 'üîÑ –ß–∞—Å—Ç–∏—á–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω–æ' :
                             '‚è≥ –ñ–¥—ë—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ'}
                          </p>
                        </>
                      );
                    })()}
                  </div>
                </div>
              </div>

              {/* –ù–û–í–û–ï: –°–≤–æ–¥–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç */}
              {placementDetails.overall_status === 'partially_placed' || placementDetails.overall_status === 'fully_placed' ? (
                <div className="bg-gradient-to-r from-green-50 to-blue-50 p-4 rounded-lg border border-green-200">
                  <h4 className="font-medium mb-3 text-gray-800 flex items-center">
                    <Grid3X3 className="mr-2 h-5 w-5 text-green-600" />
                    –°–≤–æ–¥–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç
                  </h4>
                  
                  {(() => {
                    // –°–æ–±–∏—Ä–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤—Å–µ—Ö —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –º–µ—Å—Ç–∞—Ö
                    const placedLocations = [];
                    (placementDetails.cargo_types || []).forEach(cargoType => {
                      (cargoType.individual_units || []).forEach(unit => {
                        if (unit.is_placed && unit.placement_info) {
                          placedLocations.push({
                            individual_number: unit.individual_number,
                            cargo_name: cargoType.cargo_name,
                            location: `–ë${unit.placement_info.block_number}-–ü${unit.placement_info.shelf_number}-–Ø${unit.placement_info.cell_number}`,
                            placed_at: unit.placement_info.placed_at
                          });
                        }
                      });
                    });
                    
                    // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º –ø–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—é
                    const locationGroups = placedLocations.reduce((groups, item) => {
                      if (!groups[item.location]) {
                        groups[item.location] = [];
                      }
                      groups[item.location].push(item);
                      return groups;
                    }, {});
                    
                    return (
                      <div className="grid gap-3">
                        {Object.entries(locationGroups).length === 0 ? (
                          <p className="text-gray-500 text-center py-4">–ù–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤</p>
                        ) : (
                          Object.entries(locationGroups).map(([location, items]) => (
                            <div key={location} className="bg-white p-3 rounded-lg border">
                              <div className="flex items-center justify-between mb-2">
                                <span className="font-semibold text-lg text-blue-700 bg-blue-100 px-3 py-1 rounded-md">
                                  üìç {location}
                                </span>
                                <span className="text-sm text-gray-600 bg-gray-100 px-2 py-1 rounded">
                                  {items.length} {items.length === 1 ? '–µ–¥–∏–Ω–∏—Ü–∞' : items.length < 5 ? '–µ–¥–∏–Ω–∏—Ü—ã' : '–µ–¥–∏–Ω–∏—Ü'}
                                </span>
                              </div>
                              
                              <div className="flex flex-wrap gap-1">
                                {items.map((item, index) => (
                                  <span 
                                    key={index} 
                                    className="text-xs bg-green-100 text-green-700 px-2 py-1 rounded"
                                    title={`${item.cargo_name} - ${item.individual_number}`}
                                  >
                                    {item.individual_number.split('/').slice(-1)[0]}
                                  </span>
                                ))}
                              </div>
                              
                              {items[0]?.placed_at && (
                                <div className="text-xs text-gray-500 mt-2">
                                  üïí –†–∞–∑–º–µ—â–µ–Ω–æ: {new Date(items[0].placed_at).toLocaleDateString('ru-RU')}
                                </div>
                              )}
                            </div>
                          ))
                        )}
                      </div>
                    );
                  })()}
                </div>
              ) : null}

              {/* –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –°–ü–ò–°–û–ö: –ì—Ä—É–∑—ã —Å –∏–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–º–∏ –Ω–æ–º–µ—Ä–∞–º–∏ –∏ QR –∫–æ–¥–∞–º–∏ */}
              <div className="bg-gray-50 p-4 rounded-lg">
                <h4 className="font-medium mb-4 text-gray-800 flex items-center">
                  <Package className="mr-2 h-5 w-5" />
                  –ì—Ä—É–∑—ã –≤ –∑–∞—è–≤–∫–µ ({placementDetails.cargo_types?.length || 0} —Ç–∏–ø–æ–≤)
                </h4>
                <div className="space-y-4">
                  {(placementDetails.cargo_types || []).map((cargoType, typeIndex) => (
                    <div key={typeIndex} className="bg-white p-4 rounded-lg border">
                      {/* –ó–∞–≥–æ–ª–æ–≤–æ–∫ —Ç–∏–ø–∞ –≥—Ä—É–∑–∞ */}
                      <div className="flex justify-between items-start mb-3">
                        <div>
                          <h5 className="font-medium text-lg text-purple-700">
                            üì¶ {cargoType.type_number} "{cargoType.cargo_name}"
                          </h5>
                          <p className="text-sm text-gray-500">
                            –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {cargoType.quantity} —à—Ç ‚Ä¢ –í–µ—Å: {cargoType.weight} –∫–≥ ‚Ä¢ –°—É–º–º–∞: {cargoType.total_amount} ‚ÇΩ
                          </p>
                        </div>
                        <div className="text-right">
                          {(() => {
                            // –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï: –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –≥—Ä—É–∑–∞ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–∏—Ö individual_units
                            let totalCount, placedCount, placementStatus;
                            
                            if (cargoType.individual_units && cargoType.individual_units.length > 0) {
                              totalCount = cargoType.individual_units.length;
                              placedCount = cargoType.individual_units.filter(unit => unit.is_placed === true).length;
                            } else {
                              // Fallback –∫ —Å—Ç–∞—Ä—ã–º –ø–æ–ª—è–º
                              totalCount = cargoType.quantity || 0;
                              placedCount = cargoType.placed_count || 0;
                            }
                            
                            placementStatus = totalCount > 0 && placedCount === totalCount ? 'fully_placed' : 
                                            placedCount > 0 ? 'partially_placed' : 'pending';
                            
                            const statusLabel = placementStatus === 'fully_placed' ? '–†–∞–∑–º–µ—â–µ–Ω–æ' :
                                              placementStatus === 'partially_placed' ? '–ß–∞—Å—Ç–∏—á–Ω–æ' : '–ñ–¥—ë—Ç';
                            
                            return (
                              <>
                                <p className="font-bold text-xl text-blue-600">
                                  {placedCount}/{totalCount}
                                </p>
                                <p className={`text-sm font-medium ${
                                  placementStatus === 'fully_placed' ? 'text-green-600' :
                                  placementStatus === 'partially_placed' ? 'text-yellow-600' :
                                  'text-red-600'
                                }`}>
                                  {statusLabel}
                                </p>
                              </>
                            );
                          })()}
                        </div>
                      </div>

                      {/* –ù–û–í–û–ï: –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã –≥—Ä—É–∑–∞ */}
                      <div className="space-y-3">
                        <h6 className="font-medium text-sm text-gray-700 border-b pb-1">
                          –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–µ –µ–¥–∏–Ω–∏—Ü—ã –≥—Ä—É–∑–∞:
                        </h6>
                        
                        <div className="grid gap-3">
                          {(cargoType.individual_units || []).map((unit, unitIndex) => (
                            <div 
                              key={unitIndex} 
                              className={`p-3 rounded-lg border-l-4 ${
                                unit.is_placed 
                                  ? 'bg-green-50 border-green-400' 
                                  : 'bg-red-50 border-red-400'
                              }`}
                            >
                              <div className="flex justify-between items-start">
                                {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –µ–¥–∏–Ω–∏—Ü–µ */}
                                <div className="flex-1">
                                  <div className="flex items-center space-x-2">
                                    <span className={`font-mono font-bold ${
                                      unit.is_placed ? 'text-green-700' : 'text-red-700'
                                    }`}>
                                      {unit.individual_number}
                                    </span>
                                    <span className={`px-2 py-1 rounded text-xs font-medium ${
                                      unit.is_placed 
                                        ? 'bg-green-100 text-green-800' 
                                        : 'bg-red-100 text-red-800'
                                    }`}>
                                      {unit.status_label}
                                    </span>
                                  </div>
                                  
                                  {/* –£–õ–£–ß–®–ï–ù–ù–ê–Ø –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–∏ */}
                                  {unit.is_placed && unit.placement_info ? (
                                    <div className="mt-2 p-3 bg-green-50 border border-green-200 rounded-lg">
                                      <div className="flex items-center mb-2">
                                        <div className="w-3 h-3 bg-green-500 rounded-full mr-2"></div>
                                        <span className="font-medium text-green-800">–†–∞–∑–º–µ—â–µ–Ω–æ</span>
                                      </div>
                                      
                                      <div className="space-y-1 text-sm">
                                        <div className="flex items-center text-gray-700">
                                          <span className="font-semibold text-lg text-blue-700 bg-blue-100 px-2 py-1 rounded-md">
                                            –ë{unit.placement_info.block_number}-–ü{unit.placement_info.shelf_number}-–Ø{unit.placement_info.cell_number}
                                          </span>
                                        </div>
                                        
                                        <div className="grid grid-cols-2 gap-2 mt-2 text-xs">
                                          <div className="text-gray-600">
                                            üìç <strong>–ë–ª–æ–∫:</strong> {unit.placement_info.block_number}
                                          </div>
                                          <div className="text-gray-600">
                                            üìö <strong>–ü–æ–ª–∫–∞:</strong> {unit.placement_info.shelf_number}
                                          </div>
                                          <div className="text-gray-600">
                                            üì¶ <strong>–Ø—á–µ–π–∫–∞:</strong> {unit.placement_info.cell_number}
                                          </div>
                                          <div className="text-gray-600">
                                            üè≠ <strong>–°–∫–ª–∞–¥:</strong> {unit.placement_info.warehouse_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                                          </div>
                                        </div>
                                        
                                        {unit.placement_info.placed_at && (
                                          <div className="text-gray-600 text-xs mt-2 pt-2 border-t border-green-200">
                                            üïí <strong>–†–∞–∑–º–µ—â–µ–Ω–æ:</strong> {new Date(unit.placement_info.placed_at).toLocaleString('ru-RU', {
                                              day: '2-digit',
                                              month: '2-digit', 
                                              year: 'numeric',
                                              hour: '2-digit',
                                              minute: '2-digit'
                                            })}
                                          </div>
                                        )}
                                        
                                        {unit.placement_info.placed_by && (
                                          <div className="text-gray-600 text-xs">
                                            üë§ <strong>–û–ø–µ—Ä–∞—Ç–æ—Ä:</strong> {unit.placement_info.placed_by}
                                          </div>
                                        )}
                                      </div>
                                    </div>
                                  ) : (
                                    <div className="mt-2 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                                      <div className="flex items-center">
                                        <div className="w-3 h-3 bg-orange-500 rounded-full mr-2"></div>
                                        <span className="font-medium text-orange-800">–û–∂–∏–¥–∞–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</span>
                                      </div>
                                      <p className="mt-1 text-sm text-orange-600">
                                        ‚è≥ –ì—Ä—É–∑ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é –Ω–∞ —Å–∫–ª–∞–¥–µ
                                      </p>
                                    </div>
                                  )}
                                </div>

                                {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è –∫–∞–∂–¥–æ–π –µ–¥–∏–Ω–∏—Ü—ã */}
                                <div className="flex flex-col gap-1 ml-4">
                                  <Button
                                    onClick={() => handleGenerateIndividualQR(unit.individual_number, cargoType.cargo_name)}
                                    size="sm"
                                    variant="outline"
                                    className="text-blue-600 border-blue-300 hover:bg-blue-50 text-xs"
                                  >
                                    <QrCode className="mr-1 h-3 w-3" />
                                    QR –∫–æ–¥
                                  </Button>
                                  
                                  <Button
                                    onClick={() => handlePrintIndividualQR(unit.individual_number, cargoType.cargo_name)}
                                    size="sm"
                                    variant="outline" 
                                    className="text-orange-600 border-orange-300 hover:bg-orange-50 text-xs"
                                  >
                                    <Printer className="mr-1 h-3 w-3" />
                                    –ü–µ—á–∞—Ç—å
                                  </Button>

                                  {!unit.is_placed && (
                                    <Button
                                      onClick={() => {
                                        setShowPlacementDetailsModal(false);
                                        openEnhancedPlacementModal(selectedCargoForDetails);
                                      }}
                                      size="sm"
                                      className="bg-green-600 hover:bg-green-700 text-xs"
                                    >
                                      <Grid3X3 className="mr-1 h-3 w-3" />
                                      –†–∞–∑–º–µ—Å—Ç–∏—Ç—å
                                    </Button>
                                  )}
                                </div>
                              </div>
                            </div>
                          ))}
                        </div>

                        {/* –ú–∞—Å—Å–æ–≤—ã–µ –¥–µ–π—Å—Ç–≤–∏—è –¥–ª—è —Ç–∏–ø–∞ –≥—Ä—É–∑–∞ */}
                        <div className="mt-4 pt-3 border-t border-gray-200">
                          <div className="flex flex-wrap gap-2">
                            <Button
                              onClick={() => handleGenerateMassQRForType(cargoType)}
                              variant="outline"
                              size="sm"
                              className="text-purple-600 border-purple-300 hover:bg-purple-50"
                            >
                              <QrCode className="mr-1 h-3 w-3" />
                              QR –¥–ª—è –≤—Å–µ—Ö ({cargoType.quantity} —à—Ç)
                            </Button>
                            
                            <Button
                              onClick={() => handlePrintMassQRForType(cargoType)}
                              variant="outline"
                              size="sm"
                              className="text-orange-600 border-orange-300 hover:bg-orange-50"
                            >
                              <Printer className="mr-1 h-3 w-3" />
                              –ü–µ—á–∞—Ç—å –≤—Å–µ—Ö QR
                            </Button>

                            {cargoType.remaining_count > 0 && (
                              <Button
                                onClick={() => {
                                  setShowPlacementDetailsModal(false);
                                  openEnhancedPlacementModal(selectedCargoForDetails);
                                }}
                                size="sm"
                                className="bg-green-600 hover:bg-green-700"
                              >
                                <Grid3X3 className="mr-1 h-3 w-3" />
                                –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –æ—Å—Ç–∞–≤—à–∏–µ—Å—è ({cargoType.remaining_count})
                              </Button>
                            )}
                          </div>
                        </div>
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              {/* –ù–û–í–û–ï: –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ */}
              {placementDetails.action_history && placementDetails.action_history.length > 0 && (
                <div className="bg-gray-50 p-4 rounded-lg">
                  <h4 className="font-medium mb-3 text-gray-800 flex items-center">
                    <Clock className="mr-2 h-5 w-5 text-gray-600" />
                    –ò—Å—Ç–æ—Ä–∏—è –¥–µ–π—Å—Ç–≤–∏–π –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞
                  </h4>
                  <div className="space-y-3">
                    {placementDetails.action_history.map((action, index) => (
                      <div key={index} className="flex items-start space-x-3 p-3 bg-white rounded-lg border border-gray-200">
                        <div className={`w-3 h-3 rounded-full mt-1 ${
                          action.action === 'cargo_accepted' ? 'bg-blue-500' :
                          action.action === 'cargo_placed' ? 'bg-green-500' : 'bg-gray-400'
                        }`}></div>
                        <div className="flex-1">
                          <div className="flex items-center justify-between">
                            <h5 className="font-medium text-sm">
                              {action.action === 'cargo_accepted' ? 'üìã –ü—Ä–∏–Ω—è—Ç–∏–µ –≥—Ä—É–∑–∞' :
                               action.action === 'cargo_placed' ? 'üì¶ –†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞' : action.action}
                            </h5>
                            <span className="text-xs text-gray-500">
                              {action.timestamp ? new Date(action.timestamp).toLocaleString('ru-RU', {
                                day: '2-digit', month: '2-digit', year: 'numeric',
                                hour: '2-digit', minute: '2-digit'
                              }) : '–í—Ä–µ–º—è –Ω–µ —É–∫–∞–∑–∞–Ω–æ'}
                            </span>
                          </div>
                          <p className="text-sm text-gray-600 mt-1">{action.description}</p>
                          <p className="text-xs text-gray-500 mt-1">
                            üë§ –û–ø–µ—Ä–∞—Ç–æ—Ä: {action.operator}
                          </p>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* –ù–û–í–û–ï: –î–µ—Ç–∞–ª—å–Ω—ã–π —Å–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤ —Å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ–º */}
              {placementDetails.cargo_types && placementDetails.cargo_types.length > 0 && (
                <div className="bg-gradient-to-r from-blue-50 to-purple-50 p-4 rounded-lg">
                  <h4 className="font-medium mb-3 text-gray-800 flex items-center">
                    <Package className="mr-2 h-5 w-5 text-blue-600" />
                    –°–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤ —Å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ–º
                  </h4>
                  <div className="space-y-4">
                    {placementDetails.cargo_types.map((cargoItem, itemIndex) => (
                      <div key={itemIndex} className="bg-white p-4 rounded-lg border border-blue-200">
                        <div className="flex justify-between items-start mb-3">
                          <div>
                            <h5 className="font-semibold text-lg text-blue-700">
                              üì¶ {cargoItem.cargo_name || '–ì—Ä—É–∑ –±–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è'}
                            </h5>
                            <p className="text-sm text-gray-600">
                              –í–µ—Å: {cargoItem.weight || '–ù–µ —É–∫–∞–∑–∞–Ω'} –∫–≥ ‚Ä¢ 
                              –°—É–º–º–∞: {cargoItem.total_amount || '–ù–µ —É–∫–∞–∑–∞–Ω–∞'} ‚ÇΩ ‚Ä¢
                              –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: {cargoItem.quantity || 1} —à—Ç
                            </p>
                          </div>
                        </div>
                        
                        {/* Individual units –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥—Ä—É–∑–∞ */}
                        {cargoItem.individual_units && cargoItem.individual_units.length > 0 && (
                          <div className="mt-3">
                            <h6 className="font-medium text-sm text-gray-700 mb-2">–ï–¥–∏–Ω–∏—Ü—ã –≥—Ä—É–∑–∞:</h6>
                            <div className="grid gap-2 md:grid-cols-2 lg:grid-cols-3">
                              {cargoItem.individual_units.map((unit, unitIndex) => (
                                <div key={unitIndex} className={`p-3 rounded-lg border-2 ${
                                  unit.is_placed ? 'bg-green-50 border-green-200' : 'bg-yellow-50 border-yellow-200'
                                }`}>
                                  <div className="flex items-center justify-between mb-2">
                                    <span className="font-mono text-xs font-semibold">
                                      {unit.individual_number}
                                    </span>
                                    <Badge variant={unit.is_placed ? "success" : "secondary"} className={
                                      unit.is_placed ? "bg-green-100 text-green-800" : "bg-yellow-100 text-yellow-800"
                                    }>
                                      {unit.is_placed ? '–†–∞–∑–º–µ—â–µ–Ω–æ' : '–ñ–¥–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏—è'}
                                    </Badge>
                                  </div>
                                  
                                  {unit.is_placed && unit.placement_info && unit.placement_info !== '–ñ–¥–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏—è' ? (
                                    <div className="text-center">
                                      <div className="font-bold text-lg text-blue-700 bg-blue-100 px-3 py-2 rounded-md mb-2">
                                        {typeof unit.placement_info === 'object' ? 
                                          `–ë${unit.placement_info.block_number || '?'}-–ü${unit.placement_info.shelf_number || '?'}-–Ø${unit.placement_info.cell_number || '?'}` :
                                          unit.placement_info || '–ë?-–ü?-–Ø?'
                                        }
                                      </div>
                                      <div className="text-xs text-gray-600 space-y-1">
                                        {typeof unit.placement_info === 'object' && unit.placement_info.warehouse_name && (
                                          <div>üè≠ {unit.placement_info.warehouse_name}</div>
                                        )}
                                        {typeof unit.placement_info === 'object' && unit.placement_info.placed_at && (
                                          <div>üïí {new Date(unit.placement_info.placed_at).toLocaleString('ru-RU')}</div>
                                        )}
                                        {typeof unit.placement_info === 'object' && unit.placement_info.placed_by && (
                                          <div>üë§ {unit.placement_info.placed_by}</div>
                                        )}
                                      </div>
                                    </div>
                                  ) : (
                                    <div className="text-center">
                                      <div className="font-bold text-lg text-gray-500 bg-gray-100 px-3 py-2 rounded-md mb-2">
                                        –ë?-–ü?-–Ø?
                                      </div>
                                      <div className="text-xs text-gray-500">
                                        –ñ–¥–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
                                      </div>
                                    </div>
                                  )}
                                </div>
                              ))}
                            </div>
                          </div>
                        )}
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è –≤—Å–µ–π –∑–∞—è–≤–∫–∏ */}
              <div className="bg-purple-50 p-4 rounded-lg">
                <h4 className="font-medium mb-3 text-gray-800">üîß –î–µ–π—Å—Ç–≤–∏—è —Å –∑–∞—è–≤–∫–æ–π</h4>
                <div className="flex flex-wrap gap-2">
                  <Button
                    onClick={() => {
                      setShowPlacementDetailsModal(false);
                      openEnhancedPlacementModal(selectedCargoForDetails);
                    }}
                    className="bg-green-600 hover:bg-green-700"
                  >
                    <Grid3X3 className="mr-2 h-4 w-4" />
                    –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –≥—Ä—É–∑—ã
                  </Button>
                  
                  <Button
                    onClick={() => handleViewCargo(selectedCargoForDetails)}
                    variant="outline"
                  >
                    <Eye className="mr-2 h-4 w-4" />
                    –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–∫–∏
                  </Button>
                  
                  {placementDetails.overall_status === 'fully_placed' && (
                    <Button
                      onClick={async () => {
                        try {
                          await apiCall(`/api/operator/cargo/${selectedCargoForDetails.id}/update-placement-status`, 'POST');
                          showAlert('–ó–∞—è–≤–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∞ –≤ —Å–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤!', 'success');
                          setShowPlacementDetailsModal(false);
                          fetchAvailableCargoForPlacement();
                        } catch (error) {
                          showAlert(`–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏—è: ${error.message}`, 'error');
                        }
                      }}
                      className="bg-blue-600 hover:bg-blue-700"
                    >
                      <Truck className="mr-2 h-4 w-4" />
                      –ü–µ—Ä–µ–º–µ—Å—Ç–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤
                    </Button>
                  )}
                </div>
              </div>
            </div>
          ) : (
            <div className="text-center py-8">
              <p className="text-gray-500">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–µ—Ç–∞–ª–µ–π —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</p>
            </div>
          )}

          <div className="flex justify-end mt-6">
            <Button 
              variant="outline" 
              onClick={() => {
                setShowPlacementDetailsModal(false);
                setSelectedCargoForDetails(null);
                setPlacementDetails(null);
              }}
            >
              –ó–∞–∫—Ä—ã—Ç—å
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* External Scanner Modal - Simplified */}
      <Dialog open={showCargoPlacementModal} onOpenChange={setShowCargoPlacementModal}>
        <DialogContent className="w-full max-w-[95vw] max-h-[95vh] p-3 sm:p-6 overflow-y-auto">
          <DialogHeader className="pb-2">
            <DialogTitle className="flex items-center justify-between text-lg">
              <div className="flex items-center">
                <Scan className="mr-2 h-5 w-5" />
                –†–∞–∑–º–µ—â–µ–Ω–∏–µ –≥—Ä—É–∑–∞ - –í–Ω–µ—à–Ω–∏–π —Å–∫–∞–Ω–µ—Ä
              </div>
              {/* –°—á–µ—Ç—á–∏–∫ –≥—Ä—É–∑–æ–≤ */}
              <div className="flex items-center space-x-2 text-sm bg-blue-50 px-3 py-1 rounded-full border">
                <span className="text-blue-600 font-medium">
                  üì¶ {availableCargoForPlacement.length}/{sessionPlacedCount}
                </span>
                <span className="text-gray-500 text-xs">
                  (–∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é / —Ä–∞–∑–º–µ—â–µ–Ω–æ)
                </span>
              </div>
            </DialogTitle>
            <DialogDescription className="text-sm">
              –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –≤–Ω–µ—à–Ω–∏–π —Å–∫–∞–Ω–µ—Ä —à—Ç—Ä–∏—Ö-–∫–æ–¥–æ–≤/QR-–∫–æ–¥–æ–≤ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –≥—Ä—É–∑–∞
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4">
            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —Å –ø—Ä–æ–≥—Ä–µ—Å—Å–æ–º */}
            <div className="p-3 bg-gradient-to-r from-blue-50 to-green-50 border border-blue-200 rounded-lg">
              <div className="flex items-center justify-between mb-2">
                <h3 className="text-sm font-medium text-gray-700">–ü—Ä–æ–≥—Ä–µ—Å—Å —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</h3>
                <div className="text-xs text-gray-500">
                  –û—Å—Ç–∞–ª–æ—Å—å: {availableCargoForPlacement.length} –≥—Ä—É–∑–æ–≤
                </div>
              </div>
              <div className="flex items-center space-x-4">
                <div className="flex-1">
                  <div className="flex justify-between text-xs text-gray-600 mb-1">
                    <span>–í—Å–µ–≥–æ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</span>
                    <span>{availableCargoForPlacement.length + sessionPlacedCount}</span>
                  </div>
                  <div className="w-full bg-gray-200 rounded-full h-2">
                    <div 
                      className="bg-green-500 h-2 rounded-full transition-all duration-300"
                      style={{
                        width: `${sessionPlacedCount > 0 ? (sessionPlacedCount / (availableCargoForPlacement.length + sessionPlacedCount)) * 100 : 0}%`
                      }}
                    ></div>
                  </div>
                </div>
                <div className="text-right">
                  <div className="text-lg font-bold text-green-600">{sessionPlacedCount}</div>
                  <div className="text-xs text-gray-500">—Ä–∞–∑–º–µ—â–µ–Ω–æ</div>
                </div>
              </div>
            </div>

            {/* –ù–û–í–û–ï: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏–æ–Ω–Ω–∞—è –ø–∞–Ω–µ–ª—å —Ü–µ–ª–µ–≤–æ–≥–æ —Å–∫–ª–∞–¥–∞ - –í–†–ï–ú–ï–ù–ù–û –û–¢–ö–õ–Æ–ß–ï–ù–ê */}
            {false && targetWarehouseStats && scannedCellData && (
              <div className="p-3 bg-gradient-to-r from-orange-50 to-yellow-50 border border-orange-200 rounded-lg">
                <div className="flex items-center justify-between mb-2">
                  <h3 className="text-sm font-medium text-gray-700 flex items-center">
                    üè¢ –¶–µ–ª–µ–≤–æ–π —Å–∫–ª–∞–¥ –¥–ª—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
                  </h3>
                  <div className="text-xs text-orange-600 font-medium">
                    {scannedCellData.full_address || `${scannedCellData.readable_name} (–°–∫–ª–∞–¥ ‚Ññ${scannedCellData.warehouse_number})`}
                  </div>
                </div>
                <div className="grid grid-cols-3 gap-3">
                  <div className="text-center p-2 bg-white rounded border">
                    <div className="text-lg font-bold text-blue-600">{targetWarehouseStats.total_cells || 0}</div>
                    <div className="text-xs text-gray-600">–í—Å–µ–≥–æ —è—á–µ–µ–∫</div>
                  </div>
                  <div className="text-center p-2 bg-white rounded border">
                    <div className="text-lg font-bold text-red-600">{targetWarehouseStats.occupied_cells || 0}</div>
                    <div className="text-xs text-gray-600">–ó–∞–Ω—è—Ç–æ</div>
                  </div>
                  <div className="text-center p-2 bg-white rounded border">
                    <div className="text-lg font-bold text-green-600">{targetWarehouseStats.free_cells || 0}</div>
                    <div className="text-xs text-gray-600">–°–≤–æ–±–æ–¥–Ω–æ</div>
                  </div>
                </div>
                {targetWarehouseStats.warehouse_name && (
                  <div className="mt-2 text-xs text-gray-600 text-center">
                    üìç {targetWarehouseStats.warehouse_name}
                  </div>
                )}
              </div>
            )}

            {/* –ù–û–í–û–ï: –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –∏ —Å–ø–∏—Å–æ–∫ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤ */}
            <div className="p-3 bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg">
              <div className="flex items-center justify-between mb-3">
                <h3 className="text-sm font-medium text-gray-700 flex items-center">
                  üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
                </h3>
                <div className="text-xs text-indigo-600 font-medium">
                  {sessionPlacedCount > 0 && `${Math.round((sessionPlacedCount / (availableCargoForPlacement.length + sessionPlacedCount)) * 100)}% –∑–∞–≤–µ—Ä—à–µ–Ω–æ`}
                </div>
              </div>
              
              <div className="grid grid-cols-3 gap-3 mb-3">
                <div className="text-center p-2 bg-white rounded border">
                  <div className="text-lg font-bold text-blue-600">{sessionPlacedCount}</div>
                  <div className="text-xs text-gray-600">–í —Å–µ—Å—Å–∏–∏</div>
                </div>
                <div className="text-center p-2 bg-white rounded border">
                  <div className="text-lg font-bold text-green-600">
                    {placementStatistics?.today_placements || 0}
                  </div>
                  <div className="text-xs text-gray-600">–ó–∞ —Å–µ–≥–æ–¥–Ω—è</div>
                </div>
                <div className="text-center p-2 bg-white rounded border">
                  <div className="text-lg font-bold text-orange-600">{availableCargoForPlacement.length}</div>
                  <div className="text-xs text-gray-600">–û—Å—Ç–∞–ª–æ—Å—å</div>
                </div>
              </div>
              
              {/* –°–ø–∏—Å–æ–∫ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –≥—Ä—É–∑–æ–≤ –≤ —Ç–µ–∫—É—â–µ–π —Å–µ—Å—Å–∏–∏ */}
              {sessionPlacedCargo.length > 0 && (
                <div className="mt-3">
                  <div className="text-xs font-medium text-gray-700 mb-2">
                    üì¶ –†–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã –≤ —Å–µ—Å—Å–∏–∏:
                  </div>
                  <div className="max-h-32 overflow-y-auto space-y-1">
                    {sessionPlacedCargo.slice(-5).reverse().map((item, index) => (
                      <div key={index} className="flex justify-between items-center text-xs bg-white p-2 rounded border">
                        <div className="flex-1">
                          <span className="font-medium text-gray-800">
                            –ì—Ä—É–∑ ‚Ññ {item.cargo_number}
                          </span>
                          <span className="text-gray-600 ml-2">
                            - {item.location}
                          </span>
                        </div>
                        <div className="text-gray-500 text-right">
                          <div>{item.placed_at}</div>
                          <div className="text-xs">{item.warehouse_name}</div>
                        </div>
                      </div>
                    ))}
                    {sessionPlacedCargo.length > 5 && (
                      <div className="text-xs text-gray-500 text-center py-1">
                        ... –∏ –µ—â–µ {sessionPlacedCargo.length - 5} –≥—Ä—É–∑–æ–≤
                      </div>
                    )}
                  </div>
                </div>
              )}
            </div>

            {/* –°—Ç–∞—Ä—ã–π –∫–æ–Ω—Ç–µ–Ω—Ç –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞ –∑–∞–º–µ–Ω–µ–Ω –Ω–∞ UI –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞ */}
            {externalScannerActive ? (
              <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                {/* –°—Ç–∞—Ç—É—Å —Å–æ–æ–±—â–µ–Ω–∏–µ */}
                {scannerMessage && (
                  <div className="mb-4 p-3 bg-white border border-blue-200 rounded">
                    <p className="text-sm text-blue-800">{scannerMessage}</p>
                  </div>
                )}
                
                {/* –û—à–∏–±–∫–∏ */}
                {scannerError && (
                  <div className="mb-4 p-3 bg-red-50 border border-red-200 rounded">
                    <p className="text-sm text-red-800">{scannerError}</p>
                  </div>
                )}

                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  {/* –ü–æ–ª–µ –¥–ª—è –≥—Ä—É–∑–∞ */}
                  <div>
                    <Label className="text-sm font-medium text-blue-700">
                      –®–∞–≥ 1: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞
                      {externalScannerStep === 'cargo' && <span className="text-green-600 ml-2">‚Üê –¢–µ–∫—É—â–∏–π —à–∞–≥</span>}
                      {externalScannedCargo && <span className="text-green-600 ml-2">‚úì –ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>}
                    </Label>
                    <Input
                      placeholder="–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ –≥—Ä—É–∑–∞ –∑–¥–µ—Å—å..."
                      value={externalCargoInput}
                      onChange={(e) => setExternalCargoInput(e.target.value)}
                      onKeyPress={(e) => {
                        if (e.key === 'Enter' && externalCargoInput.trim() && externalScannerStep === 'cargo' && !scannerProcessingInput) {
                          handleExternalCargoScan(externalCargoInput.trim());
                          // –§–ê–ó–ê 4: –ù–ï –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ —Å—Ä–∞–∑—É, –æ—á–∏—Å—Ç–∫–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –ø—Ä–∏ –ø–µ—Ä–µ—Ö–æ–¥–µ
                        }
                      }}
                      disabled={externalScannerStep !== 'cargo' || scannerProcessingInput}
                      className={`mt-1 ${externalScannerStep === 'cargo' && !scannerProcessingInput ? 'bg-yellow-50 border-yellow-300' : 'bg-gray-100'} ${scannerProcessingInput ? 'opacity-50' : ''}`}
                      autoFocus={externalScannerStep === 'cargo' && !scannerProcessingInput}
                    />
                    {externalScannedCargo && (
                      <div className="mt-2 p-2 bg-green-50 border border-green-200 rounded text-sm">
                        <div className="font-medium text-green-800">
                          –ì—Ä—É–∑: {typeof externalScannedCargo === 'object' && externalScannedCargo.cargo_number ? externalScannedCargo.cargo_number : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω—ã–π –≥—Ä—É–∑'}
                        </div>
                        <div className="text-green-600">
                          {typeof externalScannedCargo === 'object' && externalScannedCargo.cargo_name ? externalScannedCargo.cargo_name : '–ì—Ä—É–∑ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–∑–º–µ—â–µ–Ω–∏—é'}
                        </div>
                      </div>
                    )}
                  </div>

                  {/* –ü–æ–ª–µ –¥–ª—è —è—á–µ–π–∫–∏ */}
                  <div>
                    <Label className="text-sm font-medium text-blue-700">
                      –®–∞–≥ 2: –°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ —è—á–µ–π–∫–∏
                      {externalScannerStep === 'cell' && <span className="text-green-600 ml-2">‚Üê –¢–µ–∫—É—â–∏–π —à–∞–≥</span>}
                      {externalScannedCell && <span className="text-green-600 ml-2">‚úì –ó–∞–≤–µ—Ä—à–µ–Ω–æ</span>}
                    </Label>
                    <Input
                      placeholder="–û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ —è—á–µ–π–∫–∏ –∏–ª–∏ –≤–≤–µ–¥–∏—Ç–µ –≤—Ä—É—á–Ω—É—é: –ë1-–ü2-–Ø3"
                      value={externalCellInput}
                      onChange={(e) => setExternalCellInput(e.target.value)}
                      onKeyPress={(e) => {
                        if (e.key === 'Enter' && externalCellInput.trim() && externalScannerStep === 'cell' && !scannerProcessingInput) {
                          handleExternalCellScan(externalCellInput.trim());
                          // –§–ê–ó–ê 4: –ù–ï –æ—á–∏—â–∞–µ–º –ø–æ–ª–µ —è—á–µ–π–∫–∏, –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ –∞–≤—Ç–æ—Å–±—Ä–æ—Å–µ
                        }
                      }}
                      disabled={externalScannerStep !== 'cell' || scannerProcessingInput}
                      className={`mt-1 ${externalScannerStep === 'cell' && !scannerProcessingInput ? 'bg-yellow-50 border-yellow-300' : 'bg-gray-100'} ${scannerProcessingInput ? 'opacity-50' : ''}`}
                      autoFocus={externalScannerStep === 'cell' && !scannerProcessingInput}
                    />
                    {externalScannedCell && (
                      <div className="mt-2 p-2 bg-green-50 border border-green-200 rounded text-sm">
                        <div className="font-medium text-green-800 text-center">
                          ‚úÖ –Ø—á–µ–π–∫–∞: –ë{externalScannedCell.block_number}-–ü{externalScannedCell.shelf_number}-–Ø{externalScannedCell.cell_number}
                        </div>
                        <div className="text-green-600 text-center text-xs mt-1">
                          –î–∞–Ω–Ω—ã–µ —è—á–µ–π–∫–∏ —É—Å–ø–µ—à–Ω–æ –æ—Ç—Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω—ã
                        </div>
                      </div>
                    )}
                  </div>
                </div>

                {/* –§–ê–ó–ê 4: –°—á–µ—Ç—á–∏–∫ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—ã—Ö —Ä–∞–∑–º–µ—â–µ–Ω–∏–π */}
                {scannerCompletionCount > 0 && (
                  <div className="mt-4 p-3 bg-green-50 border border-green-200 rounded-lg">
                    <div className="flex items-center">
                      <div className="text-green-800 font-medium">üéØ –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Å–µ–∞–Ω—Å–∞</div>
                    </div>
                    <div className="text-green-600 text-sm mt-1">
                      –ó–∞–≤–µ—Ä—à–µ–Ω–æ —Ä–∞–∑–º–µ—â–µ–Ω–∏–π: <span className="font-semibold">{scannerCompletionCount}</span>
                    </div>
                    <div className="text-green-500 text-xs mt-1">
                      –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –∞–∫—Ç–∏–≤–Ω—ã - –ø—Ä–æ—Å—Ç–æ —Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ —Å–ª–µ–¥—É—é—â–∏–π –≥—Ä—É–∑
                    </div>
                  </div>
                )}

                {/* –í–∏–∑—É–∞–ª—å–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∞–∫—Ç–∏–≤–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –§–ê–ó–ê 3 */}
                {scannerProcessingInput && (
                  <div className="mt-4 p-3 bg-orange-50 border border-orange-200 rounded-lg">
                    <div className="flex items-center">
                      <div className="animate-spin rounded-full h-4 w-4 border-2 border-orange-600 border-t-transparent mr-2"></div>
                      <div className="text-orange-800 font-medium">–û–±—Ä–∞–±–æ—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö...</div>
                    </div>
                    <div className="text-orange-600 text-sm mt-1">
                      –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
                    </div>
                  </div>
                )}

                {/* –°–æ–æ–±—â–µ–Ω–∏—è –∏ –æ—à–∏–±–∫–∏ —Å–∫–∞–Ω–µ—Ä–∞ */}
                {scannerMessage && !scannerProcessingInput && (
                  <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                    <div className="text-blue-800 text-sm whitespace-pre-line">
                      {scannerMessage}
                    </div>
                  </div>
                )}

                {scannerError && !scannerProcessingInput && (
                  <div className="mt-4 p-3 bg-red-50 border border-red-200 rounded-lg">
                    <div className="text-red-800 text-sm">
                      {scannerError}
                    </div>
                  </div>
                )}

                {/* –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ */}
                <div className="mt-4 p-3 bg-white border border-blue-200 rounded">
                  <h4 className="text-sm font-medium text-blue-800 mb-2">
                    {scannerClickProtection ? 'üîí –†–µ–∂–∏–º –∑–∞—â–∏—Ç—ã –æ—Ç —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–ª–∏–∫–æ–≤ –∞–∫—Ç–∏–≤–µ–Ω' : 
                     scannerAutoTransition ? 'üöÄ –†–µ–∂–∏–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏—Ö –ø–µ—Ä–µ—Ö–æ–¥–æ–≤ –∞–∫—Ç–∏–≤–µ–Ω' : 
                     '–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é:'}
                  </h4>
                  {scannerClickProtection ? (
                    <p className="text-xs text-orange-700">
                      –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –¥–∞–Ω–Ω—ã—Ö.
                    </p>
                  ) : scannerAutoTransition ? (
                    <div className="text-xs text-green-700 space-y-1">
                      <p>‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –ø–µ—Ä–µ—Ö–æ–¥—ã –º–µ–∂–¥—É –ø–æ–ª—è–º–∏ –≤–∫–ª—é—á–µ–Ω—ã</p>
                      <p>‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –ø–æ–ª–µ–π –ø–æ—Å–ª–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</p>
                      <p>‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –ø–µ—Ä–µ—Ö–æ–¥ –∫ –Ω–æ–≤–æ–º—É —Ü–∏–∫–ª—É —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</p>
                      <p className="font-medium">–ü—Ä–æ—Å—Ç–æ —Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ - —Å–∏—Å—Ç–µ–º–∞ —Å–¥–µ–ª–∞–µ—Ç –≤—Å–µ –æ—Å—Ç–∞–ª—å–Ω–æ–µ!</p>
                    </div>
                  ) : (
                    <ol className="text-xs text-blue-700 space-y-1">
                      <li>1. –£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤–Ω–µ—à–Ω–∏–π —Å–∫–∞–Ω–µ—Ä –ø–æ–¥–∫–ª—é—á–µ–Ω –∫ –∫–æ–º–ø—å—é—Ç–µ—Ä—É</li>
                      <li>2. –£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –∫—É—Ä—Å–æ—Ä –≤ –∞–∫—Ç–∏–≤–Ω–æ–µ –ø–æ–ª–µ (–ø–æ–¥—Å–≤–µ—á–µ–Ω–æ –∂–µ–ª—Ç—ã–º)</li>
                      <li>3. –û—Ç—Å–∫–∞–Ω–∏—Ä—É–π—Ç–µ QR –∫–æ–¥ - –¥–∞–Ω–Ω—ã–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—è–≤—è—Ç—Å—è –≤ –ø–æ–ª–µ</li>
                      <li>4. –ù–∞–∂–º–∏—Ç–µ Enter –∏–ª–∏ —Å–∫–∞–Ω–µ—Ä –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç –¥–∞–Ω–Ω—ã–µ</li>
                      <li>5. –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç–µ –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —à–∞–≥—É</li>
                    </ol>
                  )}
                </div>

                {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ - –°–ù–û–í–ê –û–¢–ö–õ–Æ–ß–ê–ï–ú –î–õ–Ø –ü–û–ò–°–ö–ê –î–†–£–ì–û–ô –ü–†–ò–ß–ò–ù–´ */}
                {false && placementStatistics && (
                  <div className="mt-4 grid grid-cols-3 gap-4 text-center">
                    <div>
                      <div className="text-lg font-bold text-blue-600">{placementStatistics.today_placements || 0}</div>
                      <div className="text-xs text-gray-600">–°–µ–≥–æ–¥–Ω—è</div>
                    </div>
                    <div>
                      <div className="text-lg font-bold text-green-600">{placementStatistics.session_placements || 0}</div>
                      <div className="text-xs text-gray-600">–ó–∞ —Å–µ—Å—Å–∏—é</div>
                    </div>
                    <div>
                      <div className="text-lg font-bold text-orange-600">{placementStatistics.recent_placements || 0}</div>
                      <div className="text-xs text-gray-600">–ù–µ–¥–∞–≤–Ω–∏—Ö</div>
                    </div>
                  </div>
                )}
              </div>
            ) : (
              <div className="p-4 bg-gray-50 border border-gray-200 rounded-lg text-center">
                <div className="text-gray-600">–ê–∫—Ç–∏–≤–∞—Ü–∏—è –≤–Ω–µ—à–Ω–µ–≥–æ —Å–∫–∞–Ω–µ—Ä–∞...</div>
                <div className="text-xs text-gray-500 mt-2">–ï—Å–ª–∏ —Å–∫–∞–Ω–µ—Ä –Ω–µ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏, –æ–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É</div>
              </div>
            )}

            {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */}
            <div className="flex justify-end">
              <Button 
                variant="outline" 
                onClick={() => setShowCargoPlacementModal(false)}
                disabled={scannerClickProtection}
                className={scannerClickProtection ? 'opacity-50 cursor-not-allowed' : ''}
              >
                {scannerClickProtection ? '–û–±—Ä–∞–±–æ—Ç–∫–∞...' : '–ó–∞–∫—Ä—ã—Ç—å'}
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* Bulk QR Generation Modal for Sender - Mobile Adapted */}
      <Dialog open={showBulkQRModal} onOpenChange={setBulkQRModal}>
        <DialogContent className="w-full max-w-[95vw] max-h-[95vh] p-3 sm:p-6 overflow-y-auto">
          <DialogHeader className="pb-2">
            <DialogTitle className="flex items-center text-lg">
              <QrCode className="mr-2 h-5 w-5" />
              QR –∫–æ–¥—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
            </DialogTitle>
            <DialogDescription className="text-sm">
              –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤ –¥–ª—è –≤—Å–µ—Ö –≥—Ä—É–∑–æ–≤ –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è: {selectedSender?.sender_full_name}
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4">
            {/* Information about sender and cargo count */}
            {selectedSender && (
              <div className="p-4 bg-blue-50 rounded-lg">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="font-medium text-blue-800">–û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å: {selectedSender.sender_full_name}</p>
                    <p className="text-sm text-blue-600">–¢–µ–ª–µ—Ñ–æ–Ω: {selectedSender.sender_phone}</p>
                  </div>
                  <div>
                    <p className="font-medium text-blue-800">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –≥—Ä—É–∑–æ–≤: {senderCargos.length}</p>
                    <p className="text-sm text-blue-600">
                      –°–æ–∑–¥–∞–Ω–æ QR –∫–æ–¥–æ–≤: {bulkQRResults.filter(r => r.success).length}/{bulkQRResults.length}
                    </p>
                  </div>
                </div>
              </div>
            )}

            {/* Loading state */}
            {bulkQRLoading && (
              <div className="text-center py-4">
                <RefreshCw className="animate-spin h-8 w-8 mx-auto text-blue-600" />
                <p className="mt-2 text-gray-600">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤...</p>
              </div>
            )}

            {/* Results grid */}
            {bulkQRResults.length > 0 && (
              <div className="space-y-4">
                <h4 className="font-medium">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏:</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
                  {bulkQRResults.map((result, index) => (
                    <div 
                      key={index} 
                      className={`p-3 border rounded-lg ${result.success ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}`}
                    >
                      <div className="flex items-start justify-between">
                        <div>
                          <p className="font-medium text-sm">{result.cargo_number}</p>
                          <p className="text-xs text-gray-600">{result.cargo_name}</p>
                          {!result.success && (
                            <p className="text-xs text-red-600 mt-1">{result.error}</p>
                          )}
                        </div>
                        {result.success ? (
                          <div className="flex flex-col items-end space-y-1">
                            <img 
                              src={result.qr_code} 
                              alt={`QR ${result.cargo_number}`}
                              className="w-16 h-16"
                            />
                            <Button
                              size="sm"
                              variant="ghost"
                              onClick={() => {
                                const link = document.createElement('a');
                                link.href = result.qr_code;
                                link.download = `qr-${result.cargo_number}.png`;
                                link.click();
                              }}
                              className="text-xs p-1 h-auto"
                            >
                              <Download className="h-3 w-3" />
                            </Button>
                          </div>
                        ) : (
                          <XCircle className="h-5 w-5 text-red-500" />
                        )}
                      </div>
                    </div>
                  ))}
                </div>

                {/* Bulk actions */}
                <div className="flex gap-2 pt-4 border-t">
                  <Button
                    onClick={() => {
                      const successfulResults = bulkQRResults.filter(r => r.success);
                      successfulResults.forEach(result => {
                        const link = document.createElement('a');
                        link.href = result.qr_code;
                        link.download = `qr-${result.cargo_number}.png`;
                        link.click();
                      });
                    }}
                    disabled={bulkQRResults.filter(r => r.success).length === 0}
                    className="flex-1"
                  >
                    <Download className="mr-2 h-4 w-4" />
                    –°–∫–∞—á–∞—Ç—å –≤—Å–µ —É—Å–ø–µ—à–Ω—ã–µ ({bulkQRResults.filter(r => r.success).length})
                  </Button>
                  <Button
                    variant="outline"
                    onClick={() => {
                      const printWindow = window.open('', '_blank');
                      if (!printWindow) {
                        showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
                        return;
                      }
                      const successfulResults = bulkQRResults.filter(r => r.success);
                      const qrHtml = successfulResults.map(result => `
                        <div style="margin: 20px; text-align: center; page-break-inside: avoid;">
                          <h3>–ì—Ä—É–∑: ${result.cargo_number}</h3>
                          <p>${result.cargo_name}</p>
                          <img src="${result.qr_code}" style="width: 200px; height: 200px;" />
                        </div>
                      `).join('');
                      
                      printWindow.document.write(`
                        <html>
                          <head><title>QR –∫–æ–¥—ã –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è: ${selectedSender?.sender_full_name}</title></head>
                          <body>${qrHtml}</body>
                        </html>
                      `);
                      printWindow.document.close();
                      printWindow.print();
                    }}
                    disabled={bulkQRResults.filter(r => r.success).length === 0}
                    className="flex-1"
                  >
                    <Printer className="mr-2 h-4 w-4" />
                    –ü–µ—á–∞—Ç—å –≤—Å–µ—Ö
                  </Button>
                </div>
              </div>
            )}

            {/* Close button */}
            <div className="flex justify-end pt-4">
              <Button 
                variant="outline" 
                onClick={() => {
                  setBulkQRModal(false);
                  setSelectedSender(null);
                  setSenderCargos([]);
                  setBulkQRResults([]);
                }}
              >
                –ó–∞–∫—Ä—ã—Ç—å
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* Warehouse Management Modal - Mobile Adapted */}
      <Dialog open={showWarehouseManagementModal} onOpenChange={setShowWarehouseManagementModal}>
        <DialogContent className="w-full max-w-[95vw] max-h-[95vh] p-3 sm:p-6 overflow-y-auto">
          <DialogHeader className="pb-2">
            <DialogTitle className="flex items-center text-lg">
              <Settings className="mr-2 h-5 w-5" />
              –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–∫–ª–∞–¥–æ–º: {selectedWarehouseForManagement?.name}
            </DialogTitle>
            <DialogDescription className="text-sm">
              –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π —Å–∫–ª–∞–¥–∞, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤ –¥–ª—è —è—á–µ–µ–∫
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-6">
            {warehouseManagementLoading ? (
              <div className="text-center py-8">
                <RefreshCw className="animate-spin h-8 w-8 mx-auto text-blue-600" />
                <p className="mt-2 text-gray-600">–ó–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–∫–ª–∞–¥–∞...</p>
              </div>
            ) : warehouseStructure ? (
              <>
                {/* Warehouse Statistics */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="p-4 bg-blue-50 rounded-lg">
                    <div className="text-2xl font-bold text-blue-600">{warehouseStructure.blocks}</div>
                    <div className="text-sm text-blue-600">–ë–ª–æ–∫–æ–≤</div>
                  </div>
                  <div className="p-4 bg-green-50 rounded-lg">
                    <div className="text-2xl font-bold text-green-600">{warehouseStructure.total_cells}</div>
                    <div className="text-sm text-green-600">–í—Å–µ–≥–æ —è—á–µ–µ–∫</div>
                  </div>
                  <div className="p-4 bg-orange-50 rounded-lg">
                    <div className="text-2xl font-bold text-orange-600">{warehouseStructure.occupied_cells}</div>
                    <div className="text-sm text-orange-600">–ó–∞–Ω—è—Ç–æ</div>
                  </div>
                  <div className="p-4 bg-gray-50 rounded-lg">
                    <div className="text-2xl font-bold text-gray-600">{warehouseStructure.free_cells}</div>
                    <div className="text-sm text-gray-600">–°–≤–æ–±–æ–¥–Ω–æ</div>
                  </div>
                </div>

                {/* Management Actions */}
                <div className="flex flex-wrap gap-2 p-4 bg-gray-50 rounded-lg">
                  <Button
                    onClick={() => generateCellQRCodes()}
                    disabled={cellQRLoading}
                    className="bg-blue-600 hover:bg-blue-700"
                  >
                    {cellQRLoading ? (
                      <RefreshCw className="mr-2 h-4 w-4 animate-spin" />
                    ) : (
                      <QrCode className="mr-2 h-4 w-4" />
                    )}
                    –°–æ–∑–¥–∞—Ç—å QR –¥–ª—è –≤—Å–µ—Ö —è—á–µ–µ–∫
                  </Button>

                  <Button
                    onClick={() => setShowSingleCellQRModal(true)}
                    className="bg-purple-600 hover:bg-purple-700"
                  >
                    <QrCode className="mr-2 h-4 w-4" />
                    –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –¥–ª—è —è—á–µ–π–∫–∏ –ø–æ —à—Ç—É–∫–∞–º
                  </Button>
                  
                  <Button
                    onClick={addWarehouseBlock}
                    variant="outline"
                    className="text-green-600 border-green-300 hover:bg-green-50"
                  >
                    <Plus className="mr-2 h-4 w-4" />
                    –î–æ–±–∞–≤–∏—Ç—å –±–ª–æ–∫
                  </Button>
  
                  <Button
                    onClick={() => {
                      const blockToDelete = prompt(`–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä –±–ª–æ–∫–∞ –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è (1-${warehouseStructure.blocks}):`);
                      if (blockToDelete && !isNaN(blockToDelete)) {
                        const blockNum = parseInt(blockToDelete);
                        if (blockNum >= 1 && blockNum <= warehouseStructure.blocks) {
                          if (confirm(`–í—ã —É–≤–µ—Ä–µ–Ω—ã —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –±–ª–æ–∫ ${blockNum}? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –æ—Ç–º–µ–Ω–∏—Ç—å.`)) {
                            deleteWarehouseBlock(blockNum);
                          }
                        } else {
                          showAlert('–ù–µ–≤–µ—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –±–ª–æ–∫–∞', 'error');
                        }
                      }
                    }}
                    variant="outline"
                    className="text-red-600 border-red-300 hover:bg-red-50"
                  >
                    <Trash2 className="mr-2 h-4 w-4" />
                    –£–¥–∞–ª–∏—Ç—å –±–ª–æ–∫
                  </Button>
                </div>

                {/* QR Generation Results */}
                {cellQRResults.length > 0 && (
                  <div className="space-y-4">
                    <h4 className="font-medium">–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤:</h4>
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 max-h-64 overflow-y-auto p-4 border rounded-lg">
                      {cellQRResults.map((result, index) => (
                        <div 
                          key={index} 
                          className={`p-2 border rounded text-center ${result.success ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}`}
                        >
                          <div className="text-xs font-medium mb-1">{result.location}</div>
                          {result.success ? (
                            <div className="space-y-1">
                              <img 
                                src={result.qr_code} 
                                alt={`QR ${result.location}`}
                                className="w-12 h-12 mx-auto"
                              />
                              <Button
                                size="sm"
                                variant="ghost"
                                onClick={() => {
                                  const link = document.createElement('a');
                                  link.href = result.qr_code;
                                  link.download = `cell-${result.location}.png`;
                                  link.click();
                                }}
                                className="text-xs p-1 h-auto"
                              >
                                <Download className="h-3 w-3" />
                              </Button>
                            </div>
                          ) : (
                            <div className="space-y-1">
                              <XCircle className="h-6 w-6 mx-auto text-red-500" />
                              <p className="text-xs text-red-600">{result.error}</p>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>

                    {/* Bulk actions for cells */}
                    <div className="flex gap-2">
                      <Button
                        onClick={() => {
                          const successfulResults = cellQRResults.filter(r => r.success);
                          successfulResults.forEach(result => {
                            const link = document.createElement('a');
                            link.href = result.qr_code;
                            link.download = `cell-${result.location}.png`;
                            link.click();
                          });
                        }}
                        disabled={cellQRResults.filter(r => r.success).length === 0}
                        variant="outline"
                      >
                        <Download className="mr-2 h-4 w-4" />
                        –°–∫–∞—á–∞—Ç—å –≤—Å–µ QR ({cellQRResults.filter(r => r.success).length})
                      </Button>
                      <Button
                        variant="outline"
                        onClick={() => {
                          const printWindow = window.open('', '_blank');
                          if (!printWindow) {
                            showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
                            return;
                          }
                          const successfulResults = cellQRResults.filter(r => r.success);
                          const qrHtml = successfulResults.map(result => `
                            <div style="margin: 10px; text-align: center; display: inline-block; page-break-inside: avoid;">
                              <h4>${warehouseStructure.warehouse_name}</h4>
                              <p>–Ø—á–µ–π–∫–∞: ${result.location}</p>
                              <img src="${result.qr_code}" style="width: 150px; height: 150px;" />
                            </div>
                          `).join('');
                          
                          printWindow.document.write(`
                            <html>
                              <head><title>QR –∫–æ–¥—ã —è—á–µ–µ–∫ —Å–∫–ª–∞–¥–∞: ${warehouseStructure.warehouse_name}</title></head>
                              <body style="display: flex; flex-wrap: wrap;">${qrHtml}</body>
                            </html>
                          `);
                          printWindow.document.close();
                          printWindow.print();
                        }}
                        disabled={cellQRResults.filter(r => r.success).length === 0}
                      >
                        <Printer className="mr-2 h-4 w-4" />
                        –ü–µ—á–∞—Ç—å –≤—Å–µ—Ö QR
                      </Button>
                    </div>
                  </div>
                )}

                {/* Warehouse Structure Visualization */}
                <div className="space-y-4">
                  <h4 className="font-medium">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∫–ª–∞–¥–∞:</h4>
                  <div className="text-sm text-gray-600">
                    –ë–ª–æ–∫–æ–≤: {warehouseStructure.blocks} | 
                    –ü–æ–ª–æ–∫ –Ω–∞ –±–ª–æ–∫: {warehouseStructure.shelves_per_block} | 
                    –Ø—á–µ–µ–∫ –Ω–∞ –ø–æ–ª–∫—É: {warehouseStructure.cells_per_shelf}
                  </div>
                  
                  <div className="p-4 border rounded-lg bg-gray-50">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                      {Array.from({length: warehouseStructure.blocks}, (_, blockIndex) => (
                        <div key={blockIndex} className="border rounded p-3 bg-white">
                          <h5 className="font-medium mb-2">–ë–ª–æ–∫ {blockIndex + 1}</h5>
                          <div className="text-xs text-gray-600 mb-2">
                            –ü–æ–ª–æ–∫: {warehouseStructure.shelves_per_block} | 
                            –Ø—á–µ–µ–∫: {warehouseStructure.shelves_per_block * warehouseStructure.cells_per_shelf}
                          </div>
                          <div className="grid grid-cols-5 gap-1">
                            {Array.from({length: Math.min(warehouseStructure.shelves_per_block * warehouseStructure.cells_per_shelf, 20)}, (_, cellIndex) => {
                              const shelf = Math.floor(cellIndex / warehouseStructure.cells_per_shelf) + 1;
                              const cell = (cellIndex % warehouseStructure.cells_per_shelf) + 1;
                              const isOccupied = warehouseStructure.cells.some(c => 
                                c.block === (blockIndex + 1) && c.shelf === shelf && c.cell === cell && c.is_occupied
                              );
                              
                              return (
                                <div 
                                  key={cellIndex}
                                  className={`w-4 h-4 border text-xs flex items-center justify-center ${
                                    isOccupied ? 'bg-red-200 border-red-400' : 'bg-green-200 border-green-400'
                                  }`}
                                  title={`–ë–ª–æ–∫ ${blockIndex + 1}, –ü–æ–ª–∫–∞ ${shelf}, –Ø—á–µ–π–∫–∞ ${cell} - ${isOccupied ? '–ó–∞–Ω—è—Ç–∞' : '–°–≤–æ–±–æ–¥–Ω–∞'}`}
                                >
                                  {isOccupied ? '‚óè' : '‚óã'}
                                </div>
                              );
                            })}
                            {warehouseStructure.shelves_per_block * warehouseStructure.cells_per_shelf > 20 && (
                              <div className="text-xs text-gray-500 col-span-5">
                                ... –µ—â—ë {warehouseStructure.shelves_per_block * warehouseStructure.cells_per_shelf - 20} —è—á–µ–µ–∫
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </>
            ) : (
              <div className="text-center py-8 text-gray-500">
                –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–∫–ª–∞–¥–∞
              </div>
            )}

            {/* Close button */}
            <div className="flex justify-end pt-4 border-t">
              <Button 
                variant="outline" 
                onClick={() => {
                  setShowWarehouseManagementModal(false);
                  setSelectedWarehouseForManagement(null);
                  setWarehouseStructure(null);
                  setSelectedCells([]);
                  setCellQRResults([]);
                }}
              >
                –ó–∞–∫—Ä—ã—Ç—å
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* Single Cell QR Generation Modal */}
      <Dialog open={showSingleCellQRModal} onOpenChange={(open) => {
        setShowSingleCellQRModal(open);
        if (!open) {
          resetSingleCellForm();
        }
      }}>
        <DialogContent className="w-full max-w-[600px] max-h-[90vh] p-4 overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center text-lg">
              <QrCode className="mr-2 h-5 w-5" />
              –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞ –¥–ª—è –æ—Ç–¥–µ–ª—å–Ω–æ–π —è—á–µ–π–∫–∏
            </DialogTitle>
            <DialogDescription>
              –°–æ–∑–¥–∞–π—Ç–µ QR –∫–æ–¥ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —è—á–µ–π–∫–∏, —É–∫–∞–∑–∞–≤ –±–ª–æ–∫, –ø–æ–ª–∫—É –∏ –Ω–æ–º–µ—Ä —è—á–µ–π–∫–∏
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-6">
            {/* –ü–æ–ª—è –≤–≤–æ–¥–∞ –∞–¥—Ä–µ—Å–∞ —è—á–µ–π–∫–∏ */}
            <div className="grid grid-cols-3 gap-4">
              <div>
                <Label className="text-sm font-medium">–ë–ª–æ–∫</Label>
                <Input
                  type="number"
                  min="1"
                  placeholder="1"
                  value={singleCellBlock}
                  onChange={(e) => setSingleCellBlock(e.target.value.replace(/\D/g, ''))}
                  className="mt-1"
                />
                <p className="text-xs text-gray-500 mt-1">–¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã</p>
              </div>
              
              <div>
                <Label className="text-sm font-medium">–ü–æ–ª–∫–∞</Label>
                <Input
                  type="number"
                  min="1"
                  placeholder="1"
                  value={singleCellShelf}
                  onChange={(e) => setSingleCellShelf(e.target.value.replace(/\D/g, ''))}
                  className="mt-1"
                />
                <p className="text-xs text-gray-500 mt-1">–¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã</p>
              </div>
              
              <div>
                <Label className="text-sm font-medium">–Ø—á–µ–π–∫–∞</Label>
                <Input
                  type="number"
                  min="1"
                  placeholder="1"
                  value={singleCellNumber}
                  onChange={(e) => setSingleCellNumber(e.target.value.replace(/\D/g, ''))}
                  className="mt-1"
                />
                <p className="text-xs text-gray-500 mt-1">–¢–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã</p>
              </div>
            </div>

            {/* –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∞–¥—Ä–µ—Å–∞ */}
            {(singleCellBlock || singleCellShelf || singleCellNumber) && (
              <div className="p-3 bg-blue-50 border border-blue-200 rounded">
                <div className="text-sm text-blue-800">
                  <strong>–ê–¥—Ä–µ—Å —è—á–µ–π–∫–∏:</strong> –ë{singleCellBlock || '?'}-–ü{singleCellShelf || '?'}-–Ø{singleCellNumber || '?'}
                </div>
                <div className="text-xs text-blue-600 mt-1">
                  QR –∫–æ–¥ –±—É–¥–µ—Ç —Å–æ–¥–µ—Ä–∂–∞—Ç—å –∏–º–µ–Ω–Ω–æ —ç—Ç–æ—Ç –∞–¥—Ä–µ—Å –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                </div>
              </div>
            )}

            {/* –ö–Ω–æ–ø–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ */}
            <div className="flex gap-2">
              <Button
                onClick={generateSingleCellQR}
                disabled={singleCellQRLoading || !singleCellBlock || !singleCellShelf || !singleCellNumber}
                className="flex-1 bg-purple-600 hover:bg-purple-700"
              >
                {singleCellQRLoading ? (
                  <RefreshCw className="mr-2 h-4 w-4 animate-spin" />
                ) : (
                  <QrCode className="mr-2 h-4 w-4" />
                )}
                –°–æ–∑–¥–∞—Ç—å QR –∫–æ–¥
              </Button>
              
              <Button
                onClick={resetSingleCellForm}
                variant="outline"
              >
                –û—á–∏—Å—Ç–∏—Ç—å
              </Button>
            </div>

            {/* –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ */}
            {singleCellQRResult && (
              <div className="space-y-4">
                {singleCellQRResult.success ? (
                  <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
                    <div className="text-center">
                      <h4 className="font-medium text-green-800 mb-2">
                        QR –∫–æ–¥ –¥–ª—è —è—á–µ–π–∫–∏ {singleCellQRResult.location}
                      </h4>
                      
                      {singleCellQRResult.qr_code && (
                        <div className="mb-4">
                          <img 
                            src={singleCellQRResult.qr_code} 
                            alt={`QR –∫–æ–¥ –¥–ª—è ${singleCellQRResult.location}`}
                            className="mx-auto border rounded"
                            style={{ width: '200px', height: '200px' }}
                          />
                        </div>
                      )}
                      
                      <div className="text-sm text-green-700 mb-3">
                        <div><strong>–î–∞–Ω–Ω—ã–µ QR –∫–æ–¥–∞:</strong> {singleCellQRResult.qr_data}</div>
                        <div><strong>–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong> {singleCellQRResult.location}</div>
                      </div>

                      {/* –ö–Ω–æ–ø–∫–∞ –ø–µ—á–∞—Ç–∏ */}
                      {singleCellQRResult.qr_code && (
                        <Button
                          onClick={() => {
                            const printWindow = window.open('', '_blank');
                            if (!printWindow) {
                              showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
                              return;
                            }
                            printWindow.document.write(`
                              <html>
                                <head>
                                  <title>QR –∫–æ–¥ —è—á–µ–π–∫–∏ ${singleCellQRResult.location}</title>
                                  <style>
                                    body { text-align: center; font-family: Arial, sans-serif; padding: 20px; }
                                    .qr-container { margin: 20px 0; }
                                    .location { font-size: 18px; font-weight: bold; margin: 10px 0; }
                                    .data { font-size: 14px; color: #666; margin: 5px 0; }
                                  </style>
                                </head>
                                <body>
                                  <div class="qr-container">
                                    <div class="location">${singleCellQRResult.location}</div>
                                    <img src="${singleCellQRResult.qr_code}" style="width: 200px; height: 200px;" />
                                    <div class="data">–î–∞–Ω–Ω—ã–µ: ${singleCellQRResult.qr_data}</div>
                                  </div>
                                </body>
                              </html>
                            `);
                            printWindow.document.close();
                            printWindow.print();
                          }}
                          size="sm"
                          className="bg-green-600 hover:bg-green-700"
                        >
                          <Printer className="mr-2 h-4 w-4" />
                          –ü–µ—á–∞—Ç—å QR –∫–æ–¥–∞
                        </Button>
                      )}
                    </div>
                  </div>
                ) : (
                  <div className="p-4 bg-red-50 border border-red-200 rounded-lg">
                    <div className="text-center text-red-800">
                      <h4 className="font-medium mb-2">–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è QR –∫–æ–¥–∞</h4>
                      <p className="text-sm">{singleCellQRResult.error}</p>
                    </div>
                  </div>
                )}
              </div>
            )}

            {/* –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ */}
            <div className="p-3 bg-gray-50 border border-gray-200 rounded">
              <h5 className="text-sm font-medium text-gray-800 mb-2">–ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è:</h5>
              <ol className="text-xs text-gray-600 space-y-1">
                <li>1. –í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä–∞ –±–ª–æ–∫–∞, –ø–æ–ª–∫–∏ –∏ —è—á–µ–π–∫–∏ (—Ç–æ–ª—å–∫–æ —Ü–∏—Ñ—Ä—ã)</li>
                <li>2. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ø—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä –∞–¥—Ä–µ—Å–∞ —è—á–µ–π–∫–∏</li>
                <li>3. –ù–∞–∂–º–∏—Ç–µ "–°–æ–∑–¥–∞—Ç—å QR –∫–æ–¥" –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏</li>
                <li>4. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–Ω–æ–ø–∫—É "–ü–µ—á–∞—Ç—å QR –∫–æ–¥–∞" –¥–ª—è –ø–µ—á–∞—Ç–∏</li>
                <li>5. QR –∫–æ–¥ —Å–æ–¥–µ—Ä–∂–∏—Ç –∞–¥—Ä–µ—Å –≤ —Ñ–æ—Ä–º–∞—Ç–µ –ë1-–ü1-–Ø1 –¥–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</li>
              </ol>
            </div>

            {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */}
            <div className="flex justify-end">
              <Button 
                variant="outline" 
                onClick={() => setShowSingleCellQRModal(false)}
              >
                –ó–∞–∫—Ä—ã—Ç—å
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ù–û–í–ê–Ø –°–¢–†–ê–ù–ò–¶–ê –°–û–ó–î–ê–ù–ò–Ø –°–ö–õ–ê–î–ê */}
      <Dialog open={showWarehouseCreationPage} onOpenChange={setShowWarehouseCreationPage}>
        <DialogContent className="max-w-6xl max-h-[95vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Plus className="mr-2 h-5 w-5" />
              {warehouseCreationStep === 'form' ? '–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Å–∫–ª–∞–¥–∞' : '–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤ –¥–ª—è —è—á–µ–µ–∫'}
            </DialogTitle>
            <DialogDescription>
              {warehouseCreationStep === 'form' 
                ? '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∫–ª–∞–¥–µ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å –∞–≤—Ç–æ–≥–µ–Ω–µ—Ä–∞—Ü–∏–µ–π ID –Ω–æ–º–µ—Ä–æ–≤'
                : '–°–æ–∑–¥–∞–π—Ç–µ QR –∫–æ–¥—ã –¥–ª—è –≤—Å–µ—Ö —è—á–µ–µ–∫ –∏–ª–∏ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —è—á–µ–π–∫–∏ —Å–∫–ª–∞–¥–∞'
              }
            </DialogDescription>
          </DialogHeader>

          {warehouseCreationStep === 'form' ? (
            // –®–ê–ì 1: –§–û–†–ú–ê –°–û–ó–î–ê–ù–ò–Ø –°–ö–õ–ê–î–ê
            <form onSubmit={handleCreateWarehouse} className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
                <div className="space-y-4">
                  <h3 className="text-lg font-semibold text-gray-800">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h3>
                  
                  <div>
                    <Label htmlFor="warehouse_name">–ù–∞–∑–≤–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞ *</Label>
                    <Input
                      id="warehouse_name"
                      value={warehouseForm.name}
                      onChange={(e) => setWarehouseForm({...warehouseForm, name: e.target.value})}
                      placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–∫–ª–∞–¥ –ú–æ—Å–∫–≤–∞-1"
                      required
                    />
                  </div>

                  <div>
                    <Label htmlFor="warehouse_location">–ê–¥—Ä–µ—Å —Å–∫–ª–∞–¥–∞ *</Label>
                    <Input
                      id="warehouse_location"
                      value={warehouseForm.location}
                      onChange={(e) => setWarehouseForm({...warehouseForm, location: e.target.value})}
                      placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ú–æ—Å–∫–≤–∞, —É–ª. –°–∫–ª–∞–¥—Å–∫–∞—è, 1"
                      required
                    />
                  </div>

                  <div>
                    <Label htmlFor="assigned_operator">–ù–∞–∑–Ω–∞—á–∏—Ç—å –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</Label>
                    <Select 
                      value={warehouseForm.assigned_operator_id} 
                      onValueChange={(value) => setWarehouseForm({...warehouseForm, assigned_operator_id: value})}
                    >
                      <SelectTrigger>
                        <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="none">–ë–µ–∑ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞</SelectItem>
                        {availableOperators.map(operator => (
                          <SelectItem key={operator.id} value={operator.id}>
                            {operator.full_name} - {operator.phone}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                    <p className="text-xs text-gray-500 mt-1">
                      –í—ã–±–µ—Ä–∏—Ç–µ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞, –∫–æ—Ç–æ—Ä—ã–π –±—É–¥–µ—Ç –æ—Ç–≤–µ—á–∞—Ç—å –∑–∞ —ç—Ç–æ—Ç —Å–∫–ª–∞–¥
                    </p>
                  </div>
                </div>

                {/* –ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Å—Ç—Ä—É–∫—Ç—É—Ä—ã */}
                <div className="space-y-4">
                  <h3 className="text-lg font-semibold text-gray-800">–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∫–ª–∞–¥–∞</h3>
                  
                  <div>
                    <Label htmlFor="blocks_count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤ (1-9) *</Label>
                    <Select 
                      value={warehouseForm.blocks_count.toString()} 
                      onValueChange={(value) => setWarehouseForm({...warehouseForm, blocks_count: parseInt(value)})}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        {[1,2,3,4,5,6,7,8,9].map(num => (
                          <SelectItem key={num} value={num.toString()}>
                            {num} –±–ª–æ–∫{num > 1 ? (num < 5 ? '–∞' : '–æ–≤') : ''}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  <div>
                    <Label htmlFor="shelves_per_block">–ü–æ–ª–æ–∫ –≤ –∫–∞–∂–¥–æ–º –±–ª–æ–∫–µ (1-3) *</Label>
                    <Select 
                      value={warehouseForm.shelves_per_block.toString()} 
                      onValueChange={(value) => setWarehouseForm({...warehouseForm, shelves_per_block: parseInt(value)})}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="1">1 –ø–æ–ª–∫–∞</SelectItem>
                        <SelectItem value="2">2 –ø–æ–ª–∫–∏</SelectItem>
                        <SelectItem value="3">3 –ø–æ–ª–∫–∏</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>

                  <div>
                    <Label htmlFor="cells_per_shelf">–Ø—á–µ–µ–∫ –Ω–∞ –∫–∞–∂–¥–æ–π –ø–æ–ª–∫–µ (1-50) *</Label>
                    <Input
                      id="cells_per_shelf"
                      type="number"
                      min="1"
                      max="50"
                      value={warehouseForm.cells_per_shelf || ''}
                      onChange={(e) => setWarehouseForm({...warehouseForm, cells_per_shelf: parseInt(e.target.value) || 1})}
                      required
                    />
                  </div>

                  {/* –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç */}
                  <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                    <h4 className="font-medium text-blue-800 mb-2">üìä –†–∞—Å—á–µ—Ç –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å–∫–ª–∞–¥–∞:</h4>
                    <div className="text-sm text-blue-700 space-y-1">
                      <p>–ë–ª–æ–∫–æ–≤: <span className="font-semibold">{warehouseForm.blocks_count || 1}</span></p>
                      <p>–ü–æ–ª–æ–∫ –≤ –±–ª–æ–∫–µ: <span className="font-semibold">{warehouseForm.shelves_per_block || 1}</span></p>
                      <p>–Ø—á–µ–µ–∫ –Ω–∞ –ø–æ–ª–∫–µ: <span className="font-semibold">{warehouseForm.cells_per_shelf || 1}</span></p>
                      <div className="border-t border-blue-300 pt-2 mt-2">
                        <p className="font-bold text-blue-900">
                          –û–±—â–∞—è –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å: {(warehouseForm.blocks_count || 1) * (warehouseForm.shelves_per_block || 1) * (warehouseForm.cells_per_shelf || 1)} —è—á–µ–µ–∫
                        </p>
                        <p className="text-xs text-blue-600 mt-1">
                          –ö–∞–∂–¥–∞—è —è—á–µ–π–∫–∞ –ø–æ–ª—É—á–∏—Ç —É–Ω–∏–∫–∞–ª—å–Ω—ã–π ID –Ω–æ–º–µ—Ä –≤ —Ñ–æ—Ä–º–∞—Ç–µ: 001-01-01-001
                        </p>
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
              <div className="flex justify-end space-x-2 pt-4 border-t">
                <Button 
                  type="button" 
                  variant="outline" 
                  onClick={closeWarehouseCreationPage}
                >
                  –û—Ç–º–µ–Ω–∞
                </Button>
                <Button type="submit" className="bg-blue-600 hover:bg-blue-700">
                  <Plus className="mr-2 h-4 w-4" />
                  –°–æ–∑–¥–∞—Ç—å —Å–∫–ª–∞–¥
                </Button>
              </div>
            </form>
          ) : (
            // –®–ê–ì 2: –ì–ï–ù–ï–†–ê–¶–ò–Ø QR –ö–û–î–û–í
            <div className="space-y-6">
              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞–Ω–Ω–æ–º —Å–∫–ª–∞–¥–µ */}
              {createdWarehouseInfo && (
                <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                  <h3 className="text-lg font-semibold text-green-800 mb-2">
                    ‚úÖ –°–∫–ª–∞–¥ —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω!
                  </h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-green-700">
                    <div>
                      <p><strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong> {createdWarehouseInfo.name}</p>
                      <p><strong>ID –Ω–æ–º–µ—Ä —Å–∫–ª–∞–¥–∞:</strong> {createdWarehouseInfo.warehouse_id_number}</p>
                      <p><strong>–ê–¥—Ä–µ—Å:</strong> {createdWarehouseInfo.location}</p>
                    </div>
                    <div>
                      <p><strong>–ë–ª–æ–∫–æ–≤:</strong> {createdWarehouseInfo.blocks_count}</p>
                      <p><strong>–ü–æ–ª–æ–∫ –≤ –±–ª–æ–∫–µ:</strong> {createdWarehouseInfo.shelves_per_block}</p>
                      <p><strong>–Ø—á–µ–µ–∫ –Ω–∞ –ø–æ–ª–∫–µ:</strong> {createdWarehouseInfo.cells_per_shelf}</p>
                      <p><strong>–û–±—â–∞—è –≤–º–µ—Å—Ç–∏–º–æ—Å—Ç—å:</strong> {createdWarehouseInfo.total_capacity} —è—á–µ–µ–∫</p>
                    </div>
                  </div>
                </div>
              )}

              {/* –§—É–Ω–∫—Ü–∏–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤ */}
              <div className="space-y-4">
                <h3 className="text-lg font-semibold text-gray-800">–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤ –¥–ª—è —è—á–µ–µ–∫</h3>
                
                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                  {/* –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤—Å–µ—Ö QR –∫–æ–¥–æ–≤ */}
                  <Card>
                    <CardHeader>
                      <CardTitle className="flex items-center">
                        <Grid3X3 className="mr-2 h-5 w-5" />
                        –í—Å–µ —è—á–µ–π–∫–∏ —Å–∫–ª–∞–¥–∞
                      </CardTitle>
                      <CardDescription>
                        –°–æ–∑–¥–∞—Ç—å QR –∫–æ–¥—ã –¥–ª—è –≤—Å–µ—Ö {createdWarehouseInfo?.total_capacity || 0} —è—á–µ–µ–∫ —Å–∫–ª–∞–¥–∞
                      </CardDescription>
                    </CardHeader>
                    <CardContent>
                      {generatingAllQRs && (
                        <div className="mb-4">
                          <div className="flex justify-between text-sm text-gray-600 mb-1">
                            <span>–ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤...</span>
                            <span>{Math.round(allQRProgress)}%</span>
                          </div>
                          <div className="w-full bg-gray-200 rounded-full h-2">
                            <div 
                              className="bg-blue-600 h-2 rounded-full transition-all duration-300" 
                              style={{width: `${allQRProgress}%`}}
                            ></div>
                          </div>
                        </div>
                      )}
                      
                      <Button
                        onClick={generateAllCellQRs}
                        disabled={generatingAllQRs || !createdWarehouseInfo}
                        className="w-full"
                      >
                        {generatingAllQRs ? (
                          <>
                            <RefreshCw className="mr-2 h-4 w-4 animate-spin" />
                            –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ...
                          </>
                        ) : (
                          <>
                            <QrCode className="mr-2 h-4 w-4" />
                            –°–æ–∑–¥–∞—Ç—å –≤—Å–µ QR –∫–æ–¥—ã
                          </>
                        )}
                      </Button>
                      
                      {generatedQRs.length > 0 && (
                        <div className="mt-4 p-3 bg-gray-50 rounded">
                          <p className="text-sm text-gray-600">
                            –°–æ–∑–¥–∞–Ω–æ: {generatedQRs.filter(qr => qr.success).length} –∏–∑ {generatedQRs.length} QR –∫–æ–¥–æ–≤
                          </p>
                        </div>
                      )}
                    </CardContent>
                  </Card>

                  {/* –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–∞ –≤—ã–±—Ä–∞–Ω–Ω–æ–π —è—á–µ–π–∫–∏ */}
                  <Card>
                    <CardHeader>
                      <CardTitle className="flex items-center">
                        <Edit className="mr-2 h-5 w-5" />
                        –í—ã–±—Ä–∞–Ω–Ω–∞—è —è—á–µ–π–∫–∞
                      </CardTitle>
                      <CardDescription>
                        –°–æ–∑–¥–∞—Ç—å QR –∫–æ–¥ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —è—á–µ–π–∫–∏ —Å–∫–ª–∞–¥–∞
                      </CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <div className="grid grid-cols-3 gap-2">
                        <div>
                          <Label htmlFor="cell-block">–ë–ª–æ–∫</Label>
                          <Input
                            id="cell-block"
                            type="number"
                            min="1"
                            max={createdWarehouseInfo?.blocks_count || 9}
                            placeholder="1"
                            value={selectedCellQR.block}
                            onChange={(e) => setSelectedCellQR({...selectedCellQR, block: e.target.value})}
                          />
                        </div>
                        <div>
                          <Label htmlFor="cell-shelf">–ü–æ–ª–∫–∞</Label>
                          <Input
                            id="cell-shelf"
                            type="number"
                            min="1"
                            max={createdWarehouseInfo?.shelves_per_block || 3}
                            placeholder="1"
                            value={selectedCellQR.shelf}
                            onChange={(e) => setSelectedCellQR({...selectedCellQR, shelf: e.target.value})}
                          />
                        </div>
                        <div>
                          <Label htmlFor="cell-cell">–Ø—á–µ–π–∫–∞</Label>
                          <Input
                            id="cell-cell"
                            type="number"
                            min="1"
                            max={createdWarehouseInfo?.cells_per_shelf || 50}
                            placeholder="1"
                            value={selectedCellQR.cell}
                            onChange={(e) => setSelectedCellQR({...selectedCellQR, cell: e.target.value})}
                          />
                        </div>
                      </div>
                      
                      <Button
                        onClick={generateSelectedCellQR}
                        disabled={generatingSelectedCellQR || !createdWarehouseInfo}
                        className="w-full"
                      >
                        {generatingSelectedCellQR ? (
                          <>
                            <RefreshCw className="mr-2 h-4 w-4 animate-spin" />
                            –ì–µ–Ω–µ—Ä–∞—Ü–∏—è...
                          </>
                        ) : (
                          <>
                            <QrCode className="mr-2 h-4 w-4" />
                            –°–æ–∑–¥–∞—Ç—å QR –∫–æ–¥
                          </>
                        )}
                      </Button>

                      {selectedCellQRResult && (
                        <div className="mt-4">
                          {selectedCellQRResult.success ? (
                            <div className="text-center space-y-3">
                              <p className="text-sm font-medium text-green-600">
                                QR –∫–æ–¥ –¥–ª—è —è—á–µ–π–∫–∏ {selectedCellQRResult.readable_name}
                              </p>
                              <div className="bg-white p-3 rounded border inline-block">
                                <img 
                                  src={selectedCellQRResult.qr_code} 
                                  alt={`QR –∫–æ–¥ ${selectedCellQRResult.readable_name}`}
                                  className="w-32 h-32"
                                />
                              </div>
                              <div className="flex gap-2 justify-center">
                                <Button
                                  size="sm"
                                  variant="outline"
                                  onClick={() => {
                                    const link = document.createElement('a');
                                    link.href = selectedCellQRResult.qr_code;
                                    link.download = `qr-cell-${selectedCellQRResult.readable_name}.png`;
                                    link.click();
                                  }}
                                >
                                  <Download className="mr-1 h-3 w-3" />
                                  –°–∫–∞—á–∞—Ç—å
                                </Button>
                                <Button
                                  size="sm"
                                  variant="outline"
                                  onClick={() => {
                                    const printWindow = window.open('', '_blank');
                                    if (!printWindow) {
                                      showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
                                      return;
                                    }
                                    printWindow.document.write(`
                                      <html>
                                        <head><title>QR –∫–æ–¥ —è—á–µ–π–∫–∏ ${selectedCellQRResult.readable_name}</title></head>
                                        <body style="text-align: center; padding: 20px;">
                                          <h2>QR –∫–æ–¥ —è—á–µ–π–∫–∏</h2>
                                          <h3>${selectedCellQRResult.readable_name}</h3>
                                          <img src="${selectedCellQRResult.qr_code}" style="width: 200px; height: 200px;" />
                                          <p>–°–∫–ª–∞–¥: ${createdWarehouseInfo?.name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                          <p>ID —Å–∫–ª–∞–¥–∞: ${createdWarehouseInfo?.warehouse_id_number || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                                        </body>
                                      </html>
                                    `);
                                    printWindow.document.close();
                                    printWindow.print();
                                  }}
                                >
                                  <Printer className="mr-1 h-3 w-3" />
                                  –ü–µ—á–∞—Ç—å
                                </Button>
                              </div>
                            </div>
                          ) : (
                            <div className="p-3 bg-red-50 border border-red-200 rounded">
                              <p className="text-sm text-red-600">
                                –û—à–∏–±–∫–∞: {selectedCellQRResult.error}
                              </p>
                            </div>
                          )}
                        </div>
                      )}
                    </CardContent>
                  </Card>
                </div>
              </div>

              {/* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Å–æ–∑–¥–∞–Ω–Ω—ã—Ö QR –∫–æ–¥–æ–≤ */}
              {generatedQRs.length > 0 && (
                <div className="space-y-4">
                  <div className="flex justify-between items-center">
                    <h3 className="text-lg font-semibold text-gray-800">–°–æ–∑–¥–∞–Ω–Ω—ã–µ QR –∫–æ–¥—ã</h3>
                    <Button
                      onClick={() => {
                        // –ü–µ—á–∞—Ç—å –≤—Å–µ—Ö QR –∫–æ–¥–æ–≤
                        const printWindow = window.open('', '_blank');
                        if (!printWindow) {
                          showAlert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, —Ä–∞–∑—Ä–µ—à–∏—Ç–µ –≤—Å–ø–ª—ã–≤–∞—é—â–∏–µ –æ–∫–Ω–∞ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –±—Ä–∞—É–∑–µ—Ä–∞.', 'error');
                          return;
                        }
                        const qrContent = generatedQRs
                          .filter(qr => qr.success)
                          .map(qr => `
                            <div style="page-break-inside: avoid; margin: 20px 0; text-align: center; border: 1px solid #ccc; padding: 15px;">
                              <h3>${qr.readable_name}</h3>
                              <img src="${qr.qr_code}" style="width: 150px; height: 150px;" />
                              <p>–°–∫–ª–∞–¥: ${createdWarehouseInfo?.name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                            </div>
                          `)
                          .join('');
                        
                        printWindow.document.write(`
                          <html>
                            <head>
                              <title>QR –∫–æ–¥—ã —è—á–µ–µ–∫ —Å–∫–ª–∞–¥–∞ ${createdWarehouseInfo?.name}</title>
                              <style>
                                body { font-family: Arial, sans-serif; }
                                @media print { div { page-break-inside: avoid; } }
                              </style>
                            </head>
                            <body>
                              <h1 style="text-align: center;">QR –∫–æ–¥—ã —è—á–µ–µ–∫ —Å–∫–ª–∞–¥–∞</h1>
                              <h2 style="text-align: center;">${createdWarehouseInfo?.name}</h2>
                              ${qrContent}
                            </body>
                          </html>
                        `);
                        printWindow.document.close();
                        printWindow.print();
                      }}
                      className="bg-green-600 hover:bg-green-700"
                      disabled={generatedQRs.filter(qr => qr.success).length === 0}
                    >
                      <Printer className="mr-2 h-4 w-4" />
                      –ü–µ—á–∞—Ç—å –≤—Å–µ—Ö QR –∫–æ–¥–æ–≤ ({generatedQRs.filter(qr => qr.success).length})
                    </Button>
                  </div>
                  
                  <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                    {generatedQRs.slice(0, 24).map((qr, index) => (
                      <div key={index} className={`p-3 rounded-lg border text-center ${
                        qr.success ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'
                      }`}>
                        {qr.success ? (
                          <>
                            <img 
                              src={qr.qr_code} 
                              alt={`QR –∫–æ–¥ ${qr.readable_name}`}
                              className="w-16 h-16 mx-auto mb-2"
                            />
                            <p className="text-xs font-medium text-green-800">
                              {qr.readable_name}
                            </p>
                          </>
                        ) : (
                          <>
                            <div className="w-16 h-16 mx-auto mb-2 bg-red-200 flex items-center justify-center">
                              <span className="text-red-600 text-xs">‚ùå</span>
                            </div>
                            <p className="text-xs font-medium text-red-800">
                              {qr.readable_name}
                            </p>
                            <p className="text-xs text-red-600">–û—à–∏–±–∫–∞</p>
                          </>
                        )}
                      </div>
                    ))}
                  </div>

                  {generatedQRs.length > 24 && (
                    <p className="text-sm text-gray-500 text-center">
                      –ò –µ—â–µ {generatedQRs.length - 24} QR –∫–æ–¥–æ–≤...
                    </p>
                  )}
                </div>
              )}

              {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
              <div className="flex justify-end space-x-2 pt-4 border-t">
                <Button 
                  variant="outline" 
                  onClick={closeWarehouseCreationPage}
                >
                  –ó–∞–∫—Ä—ã—Ç—å
                </Button>
                <Button 
                  onClick={() => {
                    closeWarehouseCreationPage();
                    setActiveTab('warehouses-list');
                  }}
                  className="bg-blue-600 hover:bg-blue-700"
                >
                  <CheckCircle className="mr-2 h-4 w-4" />
                  –ó–∞–≤–µ—Ä—à–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å–∫–ª–∞–¥–∞
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* –ù–û–í–´–ï –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê –î–õ–Ø –ö–£–†–¨–ï–†–°–ö–û–ô –°–õ–£–ñ–ë–´ (–≠–¢–ê–ü 2) */}
      
      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞ */}
      <Dialog open={courierCreateModal} onOpenChange={setCourierCreateModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Truck className="mr-2 h-5 w-5" />
              –°–æ–∑–¥–∞—Ç—å –∫—É—Ä—å–µ—Ä–∞
            </DialogTitle>
            <DialogDescription>
              –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –∫—É—Ä—å–µ—Ä–∞ –¥–ª—è —Å–ª—É–∂–±—ã –¥–æ—Å—Ç–∞–≤–∫–∏
            </DialogDescription>
          </DialogHeader>
          
          <form onSubmit={handleCreateCourier} className="space-y-4">
            <div>
              <Label htmlFor="courier-full-name">–§–ò–û –∫—É—Ä—å–µ—Ä–∞ *</Label>
              <Input
                id="courier-full-name"
                value={courierCreateForm.full_name}
                onChange={(e) => setCourierCreateForm({...courierCreateForm, full_name: e.target.value})}
                placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
                required
              />
            </div>
            
            <div>
              <Label htmlFor="courier-phone">–¢–µ–ª–µ—Ñ–æ–Ω *</Label>
              <Input
                id="courier-phone"
                type="tel"
                value={courierCreateForm.phone}
                onChange={(e) => setCourierCreateForm({...courierCreateForm, phone: e.target.value})}
                placeholder="+79XXXXXXXXX"
                required
              />
            </div>
            
            <div>
              <Label htmlFor="courier-password">–ü–∞—Ä–æ–ª—å *</Label>
              <Input
                id="courier-password"
                type="password"
                value={courierCreateForm.password}
                onChange={(e) => setCourierCreateForm({...courierCreateForm, password: e.target.value})}
                placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"
                minLength={6}
                required
              />
            </div>
            
            <div>
              <Label htmlFor="courier-address">–ê–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è *</Label>
              <Input
                id="courier-address"
                value={courierCreateForm.address}
                onChange={(e) => setCourierCreateForm({...courierCreateForm, address: e.target.value})}
                placeholder="–ú–æ—Å–∫–≤–∞, —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 10, –∫–≤. 5"
                required
              />
            </div>
            
            <div>
              <Label htmlFor="courier-transport-type">–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ *</Label>
              <select
                id="courier-transport-type"
                value={courierCreateForm.transport_type}
                onChange={(e) => setCourierCreateForm({...courierCreateForm, transport_type: e.target.value})}
                className="w-full p-2 border border-gray-300 rounded-md"
                required
              >
                <option value="car">–õ–µ–≥–∫–æ–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å</option>
                <option value="van">–§—É—Ä–≥–æ–Ω</option>
                <option value="truck">–ì—Ä—É–∑–æ–≤–∏–∫</option>
                <option value="motorcycle">–ú–æ—Ç–æ—Ü–∏–∫–ª</option>
                <option value="bicycle">–í–µ–ª–æ—Å–∏–ø–µ–¥</option>
                <option value="on_foot">–ü–µ—à–∫–æ–º</option>
              </select>
            </div>
            
            <div>
              <Label htmlFor="courier-transport-number">–ù–æ–º–µ—Ä —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ *</Label>
              <Input
                id="courier-transport-number"
                value={courierCreateForm.transport_number}
                onChange={(e) => setCourierCreateForm({...courierCreateForm, transport_number: e.target.value})}
                placeholder="–ê123–ë–í77 –∏–ª–∏ –Ω–æ–º–µ—Ä –≤–µ–ª–æ—Å–∏–ø–µ–¥–∞"
                required
              />
            </div>
            
            <div>
              <Label htmlFor="courier-transport-capacity">–ì—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å (–∫–≥) *</Label>
              <Input
                id="courier-transport-capacity"
                type="number"
                min="1"
                max="10000"
                value={courierCreateForm.transport_capacity}
                onChange={(e) => setCourierCreateForm({...courierCreateForm, transport_capacity: e.target.value})}
                placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 500"
                required
              />
            </div>
            
            <div>
              <Label htmlFor="courier-assigned-warehouse">–ù–∞–∑–Ω–∞—á–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥ *</Label>
              <Select 
                value={courierCreateForm.assigned_warehouse_id} 
                onValueChange={(value) => setCourierCreateForm({...courierCreateForm, assigned_warehouse_id: value})}
              >
                <SelectTrigger>
                  <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥" />
                </SelectTrigger>
                <SelectContent>
                  {warehouses.map((warehouse) => (
                    <SelectItem key={warehouse.id} value={warehouse.id}>
                      {warehouse.name} - {warehouse.location}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            
            <div className="flex space-x-3">
              <Button type="submit" className="flex-1">
                <Plus className="mr-2 h-4 w-4" />
                –°–æ–∑–¥–∞—Ç—å –∫—É—Ä—å–µ—Ä–∞
              </Button>
              <Button type="button" variant="outline" onClick={() => setCourierCreateModal(false)}>
                –û—Ç–º–µ–Ω–∞
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è –∫—É—Ä—å–µ—Ä–∞ */}
      <Dialog open={courierProfileModal} onOpenChange={setCourierProfileModal}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Truck className="mr-2 h-5 w-5" />
              –ü—Ä–æ—Ñ–∏–ª—å –∫—É—Ä—å–µ—Ä–∞
            </DialogTitle>
          </DialogHeader>
          
          {selectedCourier && (
            <div className="space-y-6">
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <Card>
                  <CardHeader>
                    <CardTitle className="text-lg">–û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-3">
                    <div>
                      <Label className="text-sm font-medium text-gray-500">–§–ò–û</Label>
                      <p className="text-sm">{selectedCourier.full_name}</p>
                    </div>
                    <div>
                      <Label className="text-sm font-medium text-gray-500">–¢–µ–ª–µ—Ñ–æ–Ω</Label>
                      <p className="text-sm">{selectedCourier.phone}</p>
                    </div>
                    <div>
                      <Label className="text-sm font-medium text-gray-500">–ê–¥—Ä–µ—Å</Label>
                      <p className="text-sm">{selectedCourier.address}</p>
                    </div>
                    <div>
                      <Label className="text-sm font-medium text-gray-500">–°—Ç–∞—Ç—É—Å</Label>
                      <Badge variant={selectedCourier.is_active ? "default" : "secondary"}>
                        {selectedCourier.is_active ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'}
                      </Badge>
                    </div>
                  </CardContent>
                </Card>

                <Card>
                  <CardHeader>
                    <CardTitle className="text-lg">–¢—Ä–∞–Ω—Å–ø–æ—Ä—Ç</CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-3">
                    <div>
                      <Label className="text-sm font-medium text-gray-500">–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</Label>
                      <p className="text-sm">{selectedCourier.transport_type}</p>
                    </div>
                    <div>
                      <Label className="text-sm font-medium text-gray-500">–ù–æ–º–µ—Ä —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞</Label>
                      <p className="text-sm">{selectedCourier.transport_number}</p>
                    </div>
                    <div>
                      <Label className="text-sm font-medium text-gray-500">–ì—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å</Label>
                      <p className="text-sm">{selectedCourier.transport_capacity} –∫–≥</p>
                    </div>
                    <div>
                      <Label className="text-sm font-medium text-gray-500">–°–∫–ª–∞–¥</Label>
                      <p className="text-sm">{selectedCourier.assigned_warehouse_name}</p>
                    </div>
                  </CardContent>
                </Card>
              </div>

              {/* –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –∫—É—Ä—å–µ—Ä–∞ */}
              {selectedCourier.statistics && (
                <Card>
                  <CardHeader>
                    <CardTitle className="text-lg">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ä–∞–±–æ—Ç—ã</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                      <div className="text-center p-4 bg-green-50 rounded-lg">
                        <div className="text-2xl font-bold text-green-600">
                          {selectedCourier.statistics.total_completed}
                        </div>
                        <div className="text-sm text-green-500">–í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫</div>
                      </div>
                      <div className="text-center p-4 bg-blue-50 rounded-lg">
                        <div className="text-2xl font-bold text-blue-600">
                          {selectedCourier.statistics.total_assigned}
                        </div>
                        <div className="text-sm text-blue-500">–ù–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫</div>
                      </div>
                    </div>

                    {/* –ù–µ–¥–∞–≤–Ω–∏–µ –∑–∞—è–≤–∫–∏ */}
                    {selectedCourier.statistics.recent_requests && selectedCourier.statistics.recent_requests.length > 0 && (
                      <div className="mt-4">
                        <h4 className="font-semibold mb-2">–ù–µ–¥–∞–≤–Ω–∏–µ –∑–∞—è–≤–∫–∏</h4>
                        <div className="space-y-2 max-h-40 overflow-y-auto">
                          {selectedCourier.statistics.recent_requests.slice(0, 5).map((request, index) => (
                            <div key={index} className="flex items-center justify-between p-2 bg-gray-50 rounded">
                              <div>
                                <p className="text-sm font-medium">{request.sender_full_name}</p>
                                <p className="text-xs text-gray-500">{request.cargo_name}</p>
                              </div>
                              <Badge variant="outline" className="text-xs">
                                {request.request_status}
                              </Badge>
                            </div>
                          ))}
                        </div>
                      </div>
                    )}
                  </CardContent>
                </Card>
              )}

              <div className="flex space-x-3">
                <Button onClick={() => handleEditCourier(selectedCourier)} className="flex-1">
                  <Edit className="mr-2 h-4 w-4" />
                  –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å
                </Button>
                <Button variant="outline" onClick={() => setCourierProfileModal(false)}>
                  –ó–∞–∫—Ä—ã—Ç—å
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫—É—Ä—å–µ—Ä–∞ */}
      <Dialog open={courierEditModal} onOpenChange={setCourierEditModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Edit className="mr-2 h-5 w-5" />
              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫—É—Ä—å–µ—Ä–∞
            </DialogTitle>
          </DialogHeader>
          
          <form onSubmit={handleUpdateCourier} className="space-y-4">
            <div>
              <Label htmlFor="edit-courier-full-name">–§–ò–û –∫—É—Ä—å–µ—Ä–∞ *</Label>
              <Input
                id="edit-courier-full-name"
                value={courierEditForm.full_name || ''}
                onChange={(e) => setCourierEditForm({...courierEditForm, full_name: e.target.value})}
                placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
                required
              />
            </div>
            
            <div>
              <Label htmlFor="edit-courier-phone">–¢–µ–ª–µ—Ñ–æ–Ω *</Label>
              <Input
                id="edit-courier-phone"
                type="tel"
                value={courierEditForm.phone || ''}
                onChange={(e) => setCourierEditForm({...courierEditForm, phone: e.target.value})}
                placeholder="+79XXXXXXXXX"
                required
              />
            </div>
            
            <div>
              <Label htmlFor="edit-courier-address">–ê–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è *</Label>
              <Input
                id="edit-courier-address"
                value={courierEditForm.address || ''}
                onChange={(e) => setCourierEditForm({...courierEditForm, address: e.target.value})}
                placeholder="–ú–æ—Å–∫–≤–∞, —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 10, –∫–≤. 5"
                required
              />
            </div>
            
            <div>
              <Label htmlFor="edit-courier-transport-type">–¢–∏–ø —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ *</Label>
              <select
                id="edit-courier-transport-type"
                value={courierEditForm.transport_type || 'car'}
                onChange={(e) => setCourierEditForm({...courierEditForm, transport_type: e.target.value})}
                className="w-full p-2 border border-gray-300 rounded-md"
                required
              >
                <option value="car">–õ–µ–≥–∫–æ–≤–æ–π –∞–≤—Ç–æ–º–æ–±–∏–ª—å</option>
                <option value="van">–§—É—Ä–≥–æ–Ω</option>
                <option value="truck">–ì—Ä—É–∑–æ–≤–∏–∫</option>
                <option value="motorcycle">–ú–æ—Ç–æ—Ü–∏–∫–ª</option>
                <option value="bicycle">–í–µ–ª–æ—Å–∏–ø–µ–¥</option>
                <option value="on_foot">–ü–µ—à–∫–æ–º</option>
              </select>
            </div>
            
            <div>
              <Label htmlFor="edit-courier-transport-number">–ù–æ–º–µ—Ä —Ç—Ä–∞–Ω—Å–ø–æ—Ä—Ç–∞ *</Label>
              <Input
                id="edit-courier-transport-number"
                value={courierEditForm.transport_number || ''}
                onChange={(e) => setCourierEditForm({...courierEditForm, transport_number: e.target.value})}
                placeholder="–ê123–ë–í77"
                required
              />
            </div>
            
            <div>
              <Label htmlFor="edit-courier-transport-capacity">–ì—Ä—É–∑–æ–ø–æ–¥—ä–µ–º–Ω–æ—Å—Ç—å (–∫–≥) *</Label>
              <Input
                id="edit-courier-transport-capacity"
                type="number"
                min="1"
                max="10000"
                value={courierEditForm.transport_capacity || ''}
                onChange={(e) => setCourierEditForm({...courierEditForm, transport_capacity: e.target.value})}
                placeholder="500"
                required
              />
            </div>
            
            <div>
              <Label htmlFor="edit-courier-assigned-warehouse">–ù–∞–∑–Ω–∞—á–∏—Ç—å –Ω–∞ —Å–∫–ª–∞–¥ *</Label>
              <Select 
                value={courierEditForm.assigned_warehouse_id || ''} 
                onValueChange={(value) => setCourierEditForm({...courierEditForm, assigned_warehouse_id: value})}
              >
                <SelectTrigger>
                  <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥" />
                </SelectTrigger>
                <SelectContent>
                  {warehouses.map((warehouse) => (
                    <SelectItem key={warehouse.id} value={warehouse.id}>
                      {warehouse.name} - {warehouse.location}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>
            
            <div>
              <Label htmlFor="edit-courier-password">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</Label>
              <Input
                id="edit-courier-password"
                type="password"
                value={courierEditForm.password === 'unchanged' ? '' : courierEditForm.password || ''}
                onChange={(e) => setCourierEditForm({...courierEditForm, password: e.target.value})}
                placeholder="–û—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, –µ—Å–ª–∏ –Ω–µ —Ö–æ—Ç–∏—Ç–µ –º–µ–Ω—è—Ç—å"
              />
            </div>
            
            <div className="flex space-x-3">
              <Button type="submit" className="flex-1">
                <Save className="mr-2 h-4 w-4" />
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
              </Button>
              <Button type="button" variant="outline" onClick={() => setCourierEditModal(false)}>
                –û—Ç–º–µ–Ω–∞
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* –ù–û–í–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ –∫—É—Ä—å–µ—Ä–æ–º */}
      <Dialog open={cargoEditModal} onOpenChange={setCargoEditModal}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Edit className="mr-2 h-5 w-5" />
              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –≥—Ä—É–∑–µ
            </DialogTitle>
            <DialogDescription>
              –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä—É–∑–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–æ–≤
            </DialogDescription>
          </DialogHeader>
          
          <form onSubmit={handleUpdateCargoInfo} className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–µ */}
              <div>
                <Label htmlFor="edit-cargo-name">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ *</Label>
                <Input
                  id="edit-cargo-name"
                  value={courierCargoEditForm.cargo_name}
                  onChange={(e) => setCourierCargoEditForm({...courierCargoEditForm, cargo_name: e.target.value})}
                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –ü–æ—Å—ã–ª–∫–∞ —Å –æ–¥–µ–∂–¥–æ–π"
                  required
                />
              </div>
              
              <div>
                <Label htmlFor="edit-cargo-weight">–í–µ—Å –≥—Ä—É–∑–∞ (–∫–≥) *</Label>
                <Input
                  id="edit-cargo-weight"
                  type="number"
                  min="0.1"
                  step="0.1"
                  value={courierCargoEditForm.weight}
                  onChange={(e) => setCourierCargoEditForm({...courierCargoEditForm, weight: e.target.value})}
                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 2.5"
                  required
                />
              </div>
            </div>

            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ */}
            <div className="border-t pt-4">
              <h3 className="text-lg font-semibold mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ</h3>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <Label htmlFor="edit-recipient-name">–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</Label>
                  <Input
                    id="edit-recipient-name"
                    value={courierCargoEditForm.recipient_full_name}
                    onChange={(e) => setCourierCargoEditForm({...courierCargoEditForm, recipient_full_name: e.target.value})}
                    placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
                    required
                  />
                </div>
                
                <div>
                  <Label htmlFor="edit-recipient-phone">–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</Label>
                  <Input
                    id="edit-recipient-phone"
                    type="tel"
                    value={courierCargoEditForm.recipient_phone}
                    onChange={(e) => setCourierCargoEditForm({...courierCargoEditForm, recipient_phone: e.target.value})}
                    placeholder="+79XXXXXXXXX"
                    required
                  />
                </div>
              </div>

              <div className="mt-4">
                <Label htmlFor="edit-recipient-address">–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</Label>
                <Input
                  id="edit-recipient-address"
                  value={courierCargoEditForm.recipient_address}
                  onChange={(e) => setCourierCargoEditForm({...courierCargoEditForm, recipient_address: e.target.value})}
                  placeholder="–î—É—à–∞–Ω–±–µ, —É–ª. –†—É–¥–∞–∫–∏, 10, –∫–≤. 5"
                  required
                />
              </div>
            </div>

            {/* –°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –æ–ø–ª–∞—Ç—ã */}
            <div className="border-t pt-4">
              <h3 className="text-lg font-semibold mb-3">–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è –∏ –æ–ø–ª–∞—Ç–∞</h3>
              
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <Label htmlFor="edit-delivery-method">–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä—É–∑–∞ *</Label>
                  <select
                    id="edit-delivery-method"
                    value={courierCargoEditForm.delivery_method}
                    onChange={(e) => setCourierCargoEditForm({...courierCargoEditForm, delivery_method: e.target.value})}
                    className="w-full p-2 border border-gray-300 rounded-md"
                    required
                  >
                    <option value="pickup">–°–∞–º–æ–≤—ã–≤–æ–∑</option>
                    <option value="home_delivery">–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –¥–æ–º–∞</option>
                  </select>
                </div>
                
                <div>
                  <Label htmlFor="edit-payment-method">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã *</Label>
                  <select
                    id="edit-payment-method"
                    value={courierCargoEditForm.payment_method}
                    onChange={(e) => setCourierCargoEditForm({...courierCargoEditForm, payment_method: e.target.value})}
                    className="w-full p-2 border border-gray-300 rounded-md"
                    required
                  >
                    <option value="not_paid">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</option>
                    <option value="cash">–û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏</option>
                    <option value="card_transfer">–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É</option>
                    <option value="cash_on_delivery">–û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏</option>
                  </select>
                </div>
              </div>

              <div className="mt-4">
                <Label htmlFor="edit-declared-value">–û–±—ä—è–≤–ª–µ–Ω–Ω–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å (‚ÇΩ)</Label>
                <Input
                  id="edit-declared-value"
                  type="number"
                  min="0"
                  step="0.01"
                  value={courierCargoEditForm.declared_value}
                  onChange={(e) => setCourierCargoEditForm({...courierCargoEditForm, declared_value: e.target.value})}
                  placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5000"
                />
              </div>

              {/* –í–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–∏–µ–º–∞ –æ–ø–ª–∞—Ç—ã */}
              {courierCargoEditForm.payment_method === 'cash' && (
                <div className="mt-4 p-3 bg-green-50 rounded-lg">
                  <Label className="flex items-center">
                    <input
                      type="checkbox"
                      className="mr-2"
                    />
                    <span className="text-sm">–ü—Ä–∏–Ω—è–ª –æ–ø–ª–∞—Ç—É –Ω–∞–ª–∏—á–Ω—ã–º–∏</span>
                  </Label>
                  <p className="text-xs text-green-600 mt-1">
                    –û—Ç–º–µ—Ç—å—Ç–µ, –µ—Å–ª–∏ –ø–æ–ª—É—á–∏–ª–∏ –æ–ø–ª–∞—Ç—É –æ—Ç –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                  </p>
                </div>
              )}
            </div>
            
            <div className="flex flex-col space-y-2 pt-4">
              <Button type="submit" className="w-full" size="lg">
                <Save className="mr-2 h-4 w-4" />
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é
              </Button>
              
              <div className="grid grid-cols-2 gap-2">
                <Button 
                  type="button"
                  variant="outline"
                  onClick={() => {
                    showAlert('–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–µ—á–∞—Ç—å QR –∫–æ–¥–∞', 'info');
                  }}
                >
                  <QrCode className="mr-2 h-4 w-4" />
                  –ü–µ—á–∞—Ç—å QR
                </Button>
                
                <Button 
                  type="button"
                  variant="outline"
                  onClick={() => {
                    showAlert('–ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –ø–µ—á–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω–æ–π', 'info');
                  }}
                >
                  <Printer className="mr-2 h-4 w-4" />
                  –ù–∞–∫–ª–∞–¥–Ω–∞—è
                </Button>
              </div>
              
              <Button 
                type="button" 
                variant="outline" 
                onClick={() => setCargoEditModal(false)}
              >
                –û—Ç–º–µ–Ω–∞
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* –ù–û–í–´–ï –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê –î–õ–Ø –£–õ–£–ß–®–ï–ù–ò–ô –ò–ù–¢–ï–†–§–ï–ô–°–ê –ö–£–†–¨–ï–†–ê */}
      
      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Ñ–∏–ª—è –∫—É—Ä—å–µ—Ä–∞ */}
      <Dialog open={courierProfileModal} onOpenChange={setCourierProfileModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <User className="mr-2 h-5 w-5" />
              –ú–æ–π –ø—Ä–æ—Ñ–∏–ª—å
            </DialogTitle>
            <DialogDescription>
              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ª–∏—á–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∏ —Å–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è
            </DialogDescription>
          </DialogHeader>
          
          <form onSubmit={handleUpdateCourierProfile} className="space-y-4">
            <div>
              <Label htmlFor="profile-full-name">–§–ò–û *</Label>
              <Input
                id="profile-full-name"
                value={courierProfileEditForm.full_name}
                onChange={(e) => setCourierProfileEditForm({...courierProfileEditForm, full_name: e.target.value})}
                placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
                required
              />
            </div>
            
            <div>
              <Label htmlFor="profile-phone">–¢–µ–ª–µ—Ñ–æ–Ω *</Label>
              <Input
                id="profile-phone"
                type="tel"
                value={courierProfileEditForm.phone}
                onChange={(e) => setCourierProfileEditForm({...courierProfileEditForm, phone: e.target.value})}
                placeholder="+79XXXXXXXXX"
                required
              />
            </div>
            
            <div>
              <Label htmlFor="profile-address">–ê–¥—Ä–µ—Å –ø—Ä–æ–∂–∏–≤–∞–Ω–∏—è *</Label>
              <Input
                id="profile-address"
                value={courierProfileEditForm.address}
                onChange={(e) => setCourierProfileEditForm({...courierProfileEditForm, address: e.target.value})}
                placeholder="–ú–æ—Å–∫–≤–∞, —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 10, –∫–≤. 5"
                required
              />
            </div>
            
            <div className="border-t pt-4">
              <h3 className="text-sm font-semibold mb-3">–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</h3>
              
              <div className="space-y-3">
                <div>
                  <Label htmlFor="profile-current-password">–¢–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å</Label>
                  <Input
                    id="profile-current-password"
                    type="password"
                    value={courierProfileEditForm.current_password}
                    onChange={(e) => setCourierProfileEditForm({...courierProfileEditForm, current_password: e.target.value})}
                    placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–∫—É—â–∏–π –ø–∞—Ä–æ–ª—å"
                  />
                </div>
                
                <div>
                  <Label htmlFor="profile-new-password">–ù–æ–≤—ã–π –ø–∞—Ä–æ–ª—å</Label>
                  <Input
                    id="profile-new-password"
                    type="password"
                    value={courierProfileEditForm.new_password}
                    onChange={(e) => setCourierProfileEditForm({...courierProfileEditForm, new_password: e.target.value})}
                    placeholder="–ú–∏–Ω–∏–º—É–º 6 —Å–∏–º–≤–æ–ª–æ–≤"
                    minLength={6}
                  />
                </div>
                
                <div>
                  <Label htmlFor="profile-confirm-password">–ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å</Label>
                  <Input
                    id="profile-confirm-password"
                    type="password"
                    value={courierProfileEditForm.confirm_password}
                    onChange={(e) => setCourierProfileEditForm({...courierProfileEditForm, confirm_password: e.target.value})}
                    placeholder="–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å"
                  />
                </div>
              </div>
            </div>
            
            <div className="flex space-x-3">
              <Button type="submit" className="flex-1">
                <Save className="mr-2 h-4 w-4" />
                –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
              </Button>
              <Button type="button" variant="outline" onClick={() => setCourierProfileModal(false)}>
                –û—Ç–º–µ–Ω–∞
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —á–∞—Ç–∞ –∫—É—Ä—å–µ—Ä–∞ */}
      <Dialog open={courierChatModal} onOpenChange={setCourierChatModal}>
        <DialogContent className="max-w-2xl max-h-[80vh] overflow-hidden">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <MessageCircle className="mr-2 h-5 w-5" />
              –ß–∞—Ç —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π
            </DialogTitle>
            <DialogDescription>
              –°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –∏–ª–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º —Å–∫–ª–∞–¥–∞
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4">
            <div className="bg-gray-50 p-4 rounded-lg h-60 overflow-y-auto">
              <div className="space-y-3">
                <div className="flex justify-start">
                  <div className="bg-blue-100 text-blue-800 px-3 py-2 rounded-lg max-w-xs">
                    <p className="text-sm">–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ —á–∞—Ç –ø–æ–¥–¥–µ—Ä–∂–∫–∏! –ö–∞–∫ –º—ã –º–æ–∂–µ–º –ø–æ–º–æ—á—å?</p>
                    <span className="text-xs text-blue-600">–ü–æ–¥–¥–µ—Ä–∂–∫–∞ ‚Ä¢ 12:00</span>
                  </div>
                </div>
                
                <div className="flex justify-center">
                  <div className="bg-gray-200 text-gray-600 px-3 py-1 rounded-full text-xs">
                    –§—É–Ω–∫—Ü–∏—è —á–∞—Ç–∞ –±—É–¥–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–∞ –≤ –±–ª–∏–∂–∞–π—à–µ–µ –≤—Ä–µ–º—è
                  </div>
                </div>
              </div>
            </div>
            
            <div className="flex space-x-2">
              <Input
                placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..."
                className="flex-1"
                disabled
              />
              <Button disabled>
                <MessageCircle className="h-4 w-4" />
              </Button>
            </div>
            
            <div className="grid grid-cols-2 gap-3">
              <Button variant="outline" size="sm" disabled>
                üìû –ó–≤–æ–Ω–æ–∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É
              </Button>
              <Button variant="outline" size="sm" disabled>
                üìß Email –ø–æ–¥–¥–µ—Ä–∂–∫–µ
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>
      
      {/* –ù–û–í–´–ï –ú–û–î–ê–õ–¨–ù–´–ï –û–ö–ù–ê –î–õ–Ø –ü–†–û–°–ú–û–¢–†–ê –ò –†–ï–î–ê–ö–¢–ò–†–û–í–ê–ù–ò–Ø –ó–ê–Ø–í–û–ö */}
      
      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –∑–∞—è–≤–∫–∏ */}
      <Dialog open={requestViewModal} onOpenChange={setRequestViewModal}>
        <DialogContent className="max-w-2xl max-h-[80vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Package className="mr-2 h-5 w-5" />
              –ü—Ä–æ—Å–º–æ—Ç—Ä –∑–∞—è–≤–∫–∏ ‚Ññ{selectedRequest?.request_number || selectedRequest?.id}
            </DialogTitle>
            <DialogDescription>
              –ü–æ–ª–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞—è–≤–∫–µ –∏ –∏—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π
            </DialogDescription>
          </DialogHeader>
          
          {selectedRequest && (
            <div className="space-y-6">
              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ */}
              <div>
                <h3 className="text-lg font-medium mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label className="text-sm font-medium text-gray-500">–§–ò–û</Label>
                    <p className="text-sm font-medium">{selectedRequest.sender_full_name}</p>
                  </div>
                  <div>
                    <Label className="text-sm font-medium text-gray-500">–¢–µ–ª–µ—Ñ–æ–Ω</Label>
                    <p className="text-sm">{selectedRequest.sender_phone}</p>
                  </div>
                  <div className="md:col-span-2">
                    <Label className="text-sm font-medium text-gray-500">–ê–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è</Label>
                    <p className="text-sm">{selectedRequest.sender_address || selectedRequest.pickup_address}</p>
                  </div>
                </div>
              </div>
              
              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ */}
              {(selectedRequest.recipient_full_name || selectedRequest.recipient_phone || selectedRequest.recipient_address) && (
                <div>
                  <h3 className="text-lg font-medium mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <Label className="text-sm font-medium text-gray-500">–§–ò–û</Label>
                      <p className="text-sm font-medium">{selectedRequest.recipient_full_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    </div>
                    <div>
                      <Label className="text-sm font-medium text-gray-500">–¢–µ–ª–µ—Ñ–æ–Ω</Label>
                      <p className="text-sm">{selectedRequest.recipient_phone || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    </div>
                    <div className="md:col-span-2">
                      <Label className="text-sm font-medium text-gray-500">–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è</Label>
                      <p className="text-sm">{selectedRequest.recipient_address || '–ù–µ —É–∫–∞–∑–∞–Ω'}</p>
                    </div>
                  </div>
                </div>
              )}
              
              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–∞—Ö */}
              <div>
                <h3 className="text-lg font-medium mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–∞—Ö</h3>
                
                {/* –ï—Å–ª–∏ –µ—Å—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã–µ cargo_items —Å –ø–æ–¥—Ä–æ–±–Ω–æ—Å—Ç—è–º–∏ */}
                {selectedRequest.cargo_items && Array.isArray(selectedRequest.cargo_items) && selectedRequest.cargo_items.length > 0 ? (
                  <div className="space-y-4">
                    {/* –¢–∞–±–ª–∏—Ü–∞ –≥—Ä—É–∑–æ–≤ */}
                    <div className="overflow-x-auto">
                      <table className="min-w-full divide-y divide-gray-200">
                        <thead className="bg-gray-50">
                          <tr>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              –ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ
                            </th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              –í–µ—Å (–∫–≥)
                            </th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              –¶–µ–Ω–∞ –∑–∞ –∫–≥ (‚ÇΩ)
                            </th>
                            <th className="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                              –ò—Ç–æ–≥–æ (‚ÇΩ)
                            </th>
                          </tr>
                        </thead>
                        <tbody className="bg-white divide-y divide-gray-200">
                          {selectedRequest.cargo_items.map((item, index) => (
                            <tr key={index}>
                              <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-gray-900">
                                {item.name || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                              </td>
                              <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                {item.weight || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                              </td>
                              <td className="px-4 py-3 whitespace-nowrap text-sm text-gray-500">
                                {item.price_per_kg || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                              </td>
                              <td className="px-4 py-3 whitespace-nowrap text-sm font-medium text-green-600">
                                {item.total_price || '–ù–µ —É–∫–∞–∑–∞–Ω–æ'}
                              </td>
                            </tr>
                          ))}
                        </tbody>
                      </table>
                    </div>
                    
                    {/* –ò—Ç–æ–≥–æ */}
                    <div className="bg-blue-50 p-4 rounded-lg">
                      <div className="grid grid-cols-2 gap-4 text-sm">
                        <div>
                          <span className="text-blue-600 font-medium">–û–±—â–∏–π –≤–µ—Å:</span>
                          <span className="ml-2 font-bold">
                            {selectedRequest.cargo_items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0).toFixed(1)} –∫–≥
                          </span>
                        </div>
                        <div>
                          <span className="text-blue-600 font-medium">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                          <span className="ml-2 font-bold">
                            {selectedRequest.cargo_items.reduce((sum, item) => sum + (parseFloat(item.total_price) || 0), 0).toFixed(2)} ‚ÇΩ
                          </span>
                        </div>
                      </div>
                    </div>
                  </div>
                ) : (
                  /* –ü—Ä–æ—Å—Ç–æ–µ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≥—Ä—É–∑–∞ –µ—Å–ª–∏ cargo_items –Ω–µ—Ç */
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                      <Label className="text-sm font-medium text-gray-500">–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞</Label>
                      <p className="text-sm font-medium">{selectedRequest.cargo_name}</p>
                    </div>
                    <div>
                      <Label className="text-sm font-medium text-gray-500">–í–µ—Å</Label>
                      <p className="text-sm">{selectedRequest.weight || selectedRequest.total_weight || '–ù–µ —É–∫–∞–∑–∞–Ω'} –∫–≥</p>
                    </div>
                    {selectedRequest.total_value && (
                      <div>
                        <Label className="text-sm font-medium text-gray-500">–°—Ç–æ–∏–º–æ—Å—Ç—å</Label>
                        <p className="text-sm font-medium text-green-600">{selectedRequest.total_value} ‚ÇΩ</p>
                      </div>
                    )}
                  </div>
                )}
                
                {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –∑–∞–±–æ—Ä–µ */}
                <div className="grid grid-cols-2 gap-4 mt-4">
                  <div>
                    <Label className="text-sm font-medium text-gray-500">–î–∞—Ç–∞ –∑–∞–±–æ—Ä–∞</Label>
                    <p className="text-sm">
                      {selectedRequest.pickup_date 
                        ? new Date(selectedRequest.pickup_date).toLocaleDateString('ru-RU')
                        : '–ù–µ —É–∫–∞–∑–∞–Ω–∞'
                      }
                    </p>
                  </div>
                  <div>
                    <Label className="text-sm font-medium text-gray-500">–í—Ä–µ–º—è –∑–∞–±–æ—Ä–∞</Label>
                    <p className="text-sm">
                      {selectedRequest.pickup_time_from && selectedRequest.pickup_time_to 
                        ? `${selectedRequest.pickup_time_from} - ${selectedRequest.pickup_time_to}`
                        : (selectedRequest.pickup_time || '–ù–µ —É–∫–∞–∑–∞–Ω–æ')
                      }
                    </p>
                  </div>
                </div>
              </div>
              
              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ */}
              <div>
                <h3 className="text-lg font-medium mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–ª–∞—Ç–µ</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label className="text-sm font-medium text-gray-500">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</Label>
                    <p className="text-sm">{
                      selectedRequest.payment_method === 'cash' ? '–ù–∞–ª–∏—á–Ω—ã–µ' :
                      selectedRequest.payment_method === 'card_transfer' ? '–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É' :
                      selectedRequest.payment_method === 'cash_on_delivery' ? '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' :
                      selectedRequest.payment_method === 'debt' ? '–í –¥–æ–ª–≥' :
                      selectedRequest.payment_method === 'not_paid' ? '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ' :
                      selectedRequest.payment_method || '–ù–µ —É–∫–∞–∑–∞–Ω'
                    }</p>
                  </div>
                  <div>
                    <Label className="text-sm font-medium text-gray-500">–°—Ç–∞—Ç—É—Å –æ–ø–ª–∞—Ç—ã</Label>
                    <Badge variant={selectedRequest.payment_status === 'paid' ? 'default' : 'secondary'} className="ml-2">
                      {selectedRequest.payment_status === 'paid' ? '–û–ø–ª–∞—á–µ–Ω–æ' : 
                       selectedRequest.payment_status === 'not_paid' ? '–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ' : 
                       selectedRequest.payment_method === 'cash_on_delivery' ? '–ü—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏' : '–ù–µ —É–∫–∞–∑–∞–Ω'}
                    </Badge>
                  </div>
                  {selectedRequest.payment_received !== undefined && (
                    <div>
                      <Label className="text-sm font-medium text-gray-500">–û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞</Label>
                      <Badge variant={selectedRequest.payment_received ? 'default' : 'secondary'} className="ml-2">
                        {selectedRequest.payment_received ? '–î–∞' : '–ù–µ—Ç'}
                      </Badge>
                    </div>
                  )}
                  <div>
                    <Label className="text-sm font-medium text-gray-500">–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</Label>
                    <p className="text-sm">{
                      selectedRequest.delivery_method === 'pickup' ? '–°–∞–º–æ–≤—ã–≤–æ–∑ —Å —Å–∫–ª–∞–¥–∞' :
                      selectedRequest.delivery_method === 'home_delivery' ? '–î–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ –¥–æ–º' :
                      selectedRequest.delivery_method === 'office_delivery' ? '–î–æ—Å—Ç–∞–≤–∫–∞ –≤ –æ—Ñ–∏—Å' :
                      selectedRequest.delivery_method || '–ù–µ —É–∫–∞–∑–∞–Ω'
                    }</p>
                  </div>
                </div>
                
                {selectedRequest.special_instructions && (
                  <div className="mt-4">
                    <Label className="text-sm font-medium text-gray-500">–û—Å–æ–±—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</Label>
                    <p className="text-sm bg-gray-50 p-2 rounded">{selectedRequest.special_instructions}</p>
                  </div>
                )}
              </div>
              
              {/* –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π */}
              <div>
                <h3 className="text-lg font-medium mb-3">–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
                <div className="space-y-2">
                  <div className="bg-green-50 p-3 rounded-lg">
                    <div className="flex items-center space-x-2">
                      <CheckCircle className="h-4 w-4 text-green-600" />
                      <span className="text-sm font-medium text-green-800">
                        –ó–∞—è–≤–∫–∞ –ø—Ä–∏–Ω—è—Ç–∞ –∫—É—Ä—å–µ—Ä–æ–º {user?.full_name}
                      </span>
                    </div>
                    <p className="text-xs text-green-600 mt-1">
                      {new Date(selectedRequest.updated_at).toLocaleString('ru-RU')}
                    </p>
                  </div>
                  
                  <div className="bg-blue-50 p-3 rounded-lg">
                    <div className="flex items-center space-x-2">
                      <Package className="h-4 w-4 text-blue-600" />
                      <span className="text-sm font-medium text-blue-800">
                        –ó–∞—è–≤–∫–∞ —Å–æ–∑–¥–∞–Ω–∞ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º {selectedRequest.created_by_operator || '–°–∏—Å—Ç–µ–º–æ–π'}
                      </span>
                    </div>
                    <p className="text-xs text-blue-600 mt-1">
                      {new Date(selectedRequest.created_at).toLocaleString('ru-RU')}
                    </p>
                  </div>
                  
                  {selectedRequest.picked_at && (
                    <div className="bg-orange-50 p-3 rounded-lg">
                      <div className="flex items-center space-x-2">
                        <Truck className="h-4 w-4 text-orange-600" />
                        <span className="text-sm font-medium text-orange-800">
                          –ì—Ä—É–∑ –∑–∞–±—Ä–∞–Ω –∫—É—Ä—å–µ—Ä–æ–º
                        </span>
                      </div>
                      <p className="text-xs text-orange-600 mt-1">
                        {new Date(selectedRequest.picked_at).toLocaleString('ru-RU')}
                      </p>
                    </div>
                  )}
                  
                  {selectedRequest.delivered_at && (
                    <div className="bg-purple-50 p-3 rounded-lg">
                      <div className="flex items-center space-x-2">
                        <CheckCircle className="h-4 w-4 text-purple-600" />
                        <span className="text-sm font-medium text-purple-800">
                          –ì—Ä—É–∑ –¥–æ—Å—Ç–∞–≤–ª–µ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—é
                        </span>
                      </div>
                      <p className="text-xs text-purple-600 mt-1">
                        {new Date(selectedRequest.delivered_at).toLocaleString('ru-RU')}
                      </p>
                    </div>
                  )}
                </div>
              </div>
              
              {/* –§—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */}
              <div className="flex flex-col space-y-3 pt-4 border-t">
                <div className="grid grid-cols-2 gap-3">
                  <Button onClick={handlePrintLabel} variant="outline">
                    <Printer className="mr-2 h-4 w-4" />
                    –ü–µ—á–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω–æ–π
                  </Button>
                  <Button onClick={handlePrintQR} variant="outline">
                    <QrCode className="mr-2 h-4 w-4" />
                    –ü–µ—á–∞—Ç—å QR –∫–æ–¥–∞
                  </Button>
                </div>
                <Button onClick={() => handleEditRequest(selectedRequest)} className="w-full">
                  <Edit className="mr-2 h-4 w-4" />
                  –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞—è–≤–∫—É
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>
      
      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ */}
      <Dialog open={requestEditModal} onOpenChange={setRequestEditModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Edit className="mr-2 h-5 w-5" />
              –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏ ‚Ññ{selectedRequest?.request_number || selectedRequest?.id}
            </DialogTitle>
            <DialogDescription>
              –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∏ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∑–∞—è–≤–∫–µ
            </DialogDescription>
          </DialogHeader>
          
          <form onSubmit={handleSaveEditedRequest} className="space-y-6">
            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ - –∞–≤—Ç–æ–∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ */}
            <div>
              <h3 className="text-lg font-medium mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <Label htmlFor="sender-name">–§–ò–û –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è *</Label>
                  <Input
                    id="sender-name"
                    value={requestEditForm.sender_full_name}
                    onChange={(e) => setRequestEditForm({...requestEditForm, sender_full_name: e.target.value})}
                    placeholder="–ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤–∏—á"
                    required
                  />
                </div>
                <div>
                  <Label htmlFor="sender-phone">–¢–µ–ª–µ—Ñ–æ–Ω –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è *</Label>
                  <Input
                    id="sender-phone"
                    type="tel"
                    value={requestEditForm.sender_phone}
                    onChange={(e) => setRequestEditForm({...requestEditForm, sender_phone: e.target.value})}
                    placeholder="+79XXXXXXXXX"
                    required
                  />
                </div>
                <div className="md:col-span-2">
                  <Label htmlFor="sender-address">–ê–¥—Ä–µ—Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è *</Label>
                  <Input
                    id="sender-address"
                    value={requestEditForm.sender_address}
                    onChange={(e) => setRequestEditForm({...requestEditForm, sender_address: e.target.value})}
                    placeholder="–ú–æ—Å–∫–≤–∞, —É–ª. –ü—Ä–∏–º–µ—Ä–Ω–∞—è, 10, –∫–≤. 5"
                    required
                  />
                </div>
              </div>
            </div>
            
            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ */}
            <div>
              <h3 className="text-lg font-medium mb-3">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <Label htmlFor="recipient-name">–§–ò–û –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</Label>
                  <Input
                    id="recipient-name"
                    value={requestEditForm.recipient_full_name}
                    onChange={(e) => setRequestEditForm({...requestEditForm, recipient_full_name: e.target.value})}
                    placeholder="–ü–µ—Ç—Ä–æ–≤ –ü–µ—Ç—Ä –ü–µ—Ç—Ä–æ–≤–∏—á"
                    required
                  />
                </div>
                <div>
                  <Label htmlFor="recipient-phone">–¢–µ–ª–µ—Ñ–æ–Ω –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</Label>
                  <Input
                    id="recipient-phone"
                    type="tel"
                    value={requestEditForm.recipient_phone}
                    onChange={(e) => setRequestEditForm({...requestEditForm, recipient_phone: e.target.value})}
                    placeholder="+992XXXXXXXXX"
                    required
                  />
                </div>
                <div className="md:col-span-2">
                  <Label htmlFor="recipient-address">–ê–¥—Ä–µ—Å –ø–æ–ª—É—á–∞—Ç–µ–ª—è *</Label>
                  <Input
                    id="recipient-address"
                    value={requestEditForm.recipient_address}
                    onChange={(e) => setRequestEditForm({...requestEditForm, recipient_address: e.target.value})}
                    placeholder="–î—É—à–∞–Ω–±–µ, —É–ª. –ü–æ–ª—É—á–∞—Ç–µ–ª—å–Ω–∞—è, 20"
                    required
                  />
                </div>
              </div>
            </div>
            
            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–∞—Ö */}
            <div>
              <div className="flex justify-between items-center mb-3">
                <h3 className="text-lg font-medium">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –≥—Ä—É–∑–∞—Ö</h3>
                <Button type="button" onClick={addRequestCargoItem} variant="outline" size="sm">
                  <Plus className="mr-2 h-4 w-4" />
                  –î–æ–±–∞–≤–∏—Ç—å –≥—Ä—É–∑
                </Button>
              </div>
              
              <div className="space-y-4">
                {requestEditForm.cargo_items.map((item, index) => (
                  <div key={index} className="border rounded-lg p-4 relative">
                    {requestEditForm.cargo_items.length > 1 && (
                      <Button 
                        type="button"
                        onClick={() => removeRequestCargoItem(index)}
                        variant="ghost"
                        size="sm"
                        className="absolute top-2 right-2 text-red-500 hover:text-red-700"
                      >
                        <X className="h-4 w-4" />
                      </Button>
                    )}
                    
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                      <div>
                        <Label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ *</Label>
                        <Input
                          value={item.name}
                          onChange={(e) => updateRequestCargoItem(index, 'name', e.target.value)}
                          placeholder="–î–æ–∫—É–º–µ–Ω—Ç—ã"
                          required
                        />
                      </div>
                      <div>
                        <Label>–í–µ—Å (–∫–≥) *</Label>
                        <Input
                          type="number"
                          step="0.1"
                          value={item.weight}
                          onChange={(e) => updateRequestCargoItem(index, 'weight', e.target.value)}
                          placeholder="10"
                          required
                        />
                      </div>
                      <div>
                        <Label>–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ –∫–≥ (‚ÇΩ) *</Label>
                        <Input
                          type="number"
                          step="0.01"
                          value={item.price_per_kg}
                          onChange={(e) => updateRequestCargoItem(index, 'price_per_kg', e.target.value)}
                          placeholder="80"
                          required
                        />
                      </div>
                      <div>
                        <Label>–ò—Ç–æ–≥–æ (‚ÇΩ)</Label>
                        <Input
                          value={item.total_price}
                          disabled
                          className="bg-gray-100"
                          placeholder="800"
                        />
                      </div>
                    </div>
                  </div>
                ))}
                
                {/* –ö–∞–ª—å–∫—É–ª—è—Ç–æ—Ä –æ–±—â–∏—Ö –∑–Ω–∞—á–µ–Ω–∏–π */}
                <div className="bg-blue-50 p-4 rounded-lg">
                  <h4 className="font-medium text-blue-800 mb-2">–†–∞—Å—á—ë—Ç –∏—Ç–æ–≥–æ:</h4>
                  <div className="grid grid-cols-2 gap-4 text-sm">
                    <div>
                      <span className="text-blue-600">–û–±—â–∏–π –≤–µ—Å:</span>
                      <span className="ml-2 font-medium">
                        {requestEditForm.cargo_items.reduce((sum, item) => sum + (parseFloat(item.weight) || 0), 0).toFixed(1)} –∫–≥
                      </span>
                    </div>
                    <div>
                      <span className="text-blue-600">–û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å:</span>
                      <span className="ml-2 font-medium">
                        {requestEditForm.cargo_items.reduce((sum, item) => sum + (parseFloat(item.total_price) || 0), 0).toFixed(2)} ‚ÇΩ
                      </span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
            
            {/* –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã –∏ —Ñ—É–Ω–∫—Ü–∏—è –ø—Ä–∏—ë–º–∞ –æ–ø–ª–∞—Ç—ã */}
            <div>
              <h3 className="text-lg font-medium mb-3">–û–ø–ª–∞—Ç–∞</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <Label>–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã</Label>
                  <Select 
                    value={requestEditForm.payment_method}
                    onValueChange={(value) => setRequestEditForm({...requestEditForm, payment_method: value})}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="not_paid">–ù–µ –æ–ø–ª–∞—á–µ–Ω–æ</SelectItem>
                      <SelectItem value="cash">–û–ø–ª–∞—Ç–∞ –Ω–∞–ª–∏—á–Ω—ã–º–∏</SelectItem>
                      <SelectItem value="card_transfer">–ü–µ—Ä–µ–≤–æ–¥ –Ω–∞ –∫–∞—Ä—Ç—É</SelectItem>
                      <SelectItem value="cash_on_delivery">–û–ø–ª–∞—Ç–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏</SelectItem>
                      <SelectItem value="debt">–û–ø–ª–∞—Ç–∞ –≤ –¥–æ–ª–≥</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div className="flex items-center space-x-2">
                  <input
                    type="checkbox"
                    id="payment-received"
                    checked={requestEditForm.payment_received}
                    onChange={(e) => setRequestEditForm({...requestEditForm, payment_received: e.target.checked})}
                    className="rounded border-gray-300"
                  />
                  <Label htmlFor="payment-received">–û–ø–ª–∞—Ç–∞ –ø–æ–ª—É—á–µ–Ω–∞</Label>
                </div>
              </div>
            </div>
            
            {/* –°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä—É–∑–∞ */}
            <div>
              <h3 className="text-lg font-medium mb-3">–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è –≥—Ä—É–∑–∞</h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <Label>–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è</Label>
                  <Select 
                    value={requestEditForm.delivery_method}
                    onValueChange={(value) => setRequestEditForm({...requestEditForm, delivery_method: value})}
                  >
                    <SelectTrigger>
                      <SelectValue placeholder="–í—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è" />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="pickup">–°–∞–º–æ–≤—ã–≤–æ–∑ —Å —Å–∫–ª–∞–¥–∞</SelectItem>
                      <SelectItem value="home_delivery">–î–æ—Å—Ç–∞–≤–∫–∞ –Ω–∞ –¥–æ–º</SelectItem>
                      <SelectItem value="office_delivery">–î–æ—Å—Ç–∞–≤–∫–∞ –≤ –æ—Ñ–∏—Å</SelectItem>
                    </SelectContent>
                  </Select>
                </div>
                <div>
                  <Label>–û—Å–æ–±—ã–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏</Label>
                  <Textarea
                    value={requestEditForm.special_instructions}
                    onChange={(e) => setRequestEditForm({...requestEditForm, special_instructions: e.target.value})}
                    placeholder="–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ..."
                    rows={2}
                  />
                </div>
              </div>
            </div>
            
            {/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
            <div className="flex flex-col space-y-3 pt-4 border-t">
              <div className="grid grid-cols-2 gap-3">
                <Button type="button" onClick={handlePrintLabel} variant="outline">
                  <Printer className="mr-2 h-4 w-4" />
                  –ü–µ—á–∞—Ç—å –Ω–∞–∫–ª–∞–¥–Ω–æ–π
                </Button>
                <Button type="button" onClick={handlePrintQR} variant="outline">
                  <QrCode className="mr-2 h-4 w-4" />
                  –ü–µ—á–∞—Ç—å QR –∫–æ–¥–∞
                </Button>
              </div>
              
              <div className="flex space-x-3">
                <Button type="submit" className="flex-1">
                  <Save className="mr-2 h-4 w-4" />
                  –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
                </Button>
                <Button type="button" variant="outline" onClick={() => setRequestEditModal(false)}>
                  –û—Ç–º–µ–Ω–∞
                </Button>
              </div>
            </div>
          </form>
        </DialogContent>
      </Dialog>
      
      {/* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –°–í–Ø–ó–ò –° –û–¢–ü–†–ê–í–ò–¢–ï–õ–ï–ú */}
      <Dialog open={senderContactModal} onOpenChange={setSenderContactModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Phone className="mr-2 h-5 w-5" />
              –°–≤—è–∑–∞—Ç—å—Å—è —Å –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ–º
            </DialogTitle>
            <DialogDescription>
              {contactSender?.full_name}
            </DialogDescription>
          </DialogHeader>
          
          {contactSender && (
            <div className="space-y-4">
              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ */}
              <div className="bg-blue-50 p-4 rounded-lg">
                <div className="space-y-2">
                  <div>
                    <Label className="text-sm font-medium text-blue-700">–§–ò–û:</Label>
                    <p className="text-sm font-semibold text-blue-800">{contactSender.full_name}</p>
                  </div>
                  <div>
                    <Label className="text-sm font-medium text-blue-700">–¢–µ–ª–µ—Ñ–æ–Ω:</Label>
                    <p className="text-sm font-semibold text-blue-800">{contactSender.phone}</p>
                  </div>
                  <div>
                    <Label className="text-sm font-medium text-blue-700">–ì—Ä—É–∑:</Label>
                    <p className="text-sm text-blue-700">{contactSender.cargo_name}</p>
                  </div>
                  <div>
                    <Label className="text-sm font-medium text-blue-700">–ê–¥—Ä–µ—Å –∑–∞–±–æ—Ä–∞:</Label>
                    <p className="text-sm text-blue-700">{contactSender.pickup_address}</p>
                  </div>
                </div>
              </div>
              
              {/* –ö–Ω–æ–ø–∫–∏ —Å–≤—è–∑–∏ */}
              <div className="grid grid-cols-2 gap-3">
                <Button 
                  onClick={handleWhatsApp}
                  className="w-full bg-green-600 hover:bg-green-700 text-white"
                >
                  <MessageSquare className="mr-2 h-4 w-4" />
                  WhatsApp
                </Button>
                
                <Button 
                  onClick={handleTelegram}
                  className="w-full bg-blue-500 hover:bg-blue-600 text-white"
                >
                  <Send className="mr-2 h-4 w-4" />
                  Telegram
                </Button>
                
                <Button 
                  onClick={handleSenderOnlineChat}
                  variant="outline"
                  className="w-full"
                >
                  <MessageCircle className="mr-2 h-4 w-4" />
                  –û–Ω–ª–∞–π–Ω —á–∞—Ç
                </Button>
                
                <Button 
                  onClick={handlePhoneCall}
                  variant="outline"
                  className="w-full text-green-700 border-green-200 hover:bg-green-50"
                >
                  <Phone className="mr-2 h-4 w-4" />
                  –ü–æ–∑–≤–æ–Ω–∏—Ç—å
                </Button>
              </div>
              
              {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */}
              <Button 
                variant="outline" 
                onClick={() => setSenderContactModal(false)}
                className="w-full mt-4"
              >
                –ó–∞–∫—Ä—ã—Ç—å
              </Button>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –£–ü–†–ê–í–õ–ï–ù–ò–Ø –Ø–ß–ï–ô–ö–ê–ú–ò */}
      <Dialog open={cellManagementModal} onOpenChange={setCellManagementModal}>
        <DialogContent className="w-full max-w-6xl max-h-[95vh] overflow-y-auto mx-4">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Settings className="mr-2 h-5 w-5" />
              –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —è—á–µ–π–∫–∞–º–∏: {selectedWarehouseForCells?.name}
            </DialogTitle>
            <DialogDescription>
              –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π —Å–∫–ª–∞–¥–∞, –≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤ –¥–ª—è —è—á–µ–µ–∫ –∏ –º–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-6">
            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∫–ª–∞–¥–µ */}
            {selectedWarehouseForCells && (
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center text-lg">
                    <Building className="mr-2 h-5 w-5" />
                    –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∫–ª–∞–¥–µ
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                    <div className="text-center p-3 bg-blue-50 rounded-lg">
                      <p className="text-2xl font-bold text-blue-600">{selectedWarehouseForCells.blocks_count || 0}</p>
                      <p className="text-sm text-gray-600">–ë–ª–æ–∫–æ–≤</p>
                    </div>
                    <div className="text-center p-3 bg-green-50 rounded-lg">
                      <p className="text-2xl font-bold text-green-600">{selectedWarehouseForCells.shelves_per_block || 0}</p>
                      <p className="text-sm text-gray-600">–ü–æ–ª–æ–∫ –≤ –±–ª–æ–∫–µ</p>
                    </div>
                    <div className="text-center p-3 bg-orange-50 rounded-lg">
                      <p className="text-2xl font-bold text-orange-600">{selectedWarehouseForCells.cells_per_shelf || 0}</p>
                      <p className="text-sm text-gray-600">–Ø—á–µ–µ–∫ –Ω–∞ –ø–æ–ª–∫–µ</p>
                    </div>
                    <div className="text-center p-3 bg-purple-50 rounded-lg">
                      <p className="text-2xl font-bold text-purple-600">
                        {(selectedWarehouseForCells.blocks_count || 0) * 
                         (selectedWarehouseForCells.shelves_per_block || 0) * 
                         (selectedWarehouseForCells.cells_per_shelf || 0)}
                      </p>
                      <p className="text-sm text-gray-600">–í—Å–µ–≥–æ —è—á–µ–µ–∫</p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            )}

            {/* –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–∫–ª–∞–¥–∞ */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center">
                  <Grid3X3 className="mr-2 h-5 w-5" />
                  –ò–∑–º–µ–Ω–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–∫–ª–∞–¥–∞
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 mb-4">
                  <div>
                    <Label htmlFor="blocks-count">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –±–ª–æ–∫–æ–≤</Label>
                    <Input
                      id="blocks-count"
                      type="number"
                      min="1"
                      value={cellEditForm.blocks_count}
                      onChange={(e) => setCellEditForm({...cellEditForm, blocks_count: e.target.value})}
                      placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 3"
                    />
                  </div>
                  <div>
                    <Label htmlFor="shelves-per-block">–ü–æ–ª–æ–∫ –≤ –±–ª–æ–∫–µ</Label>
                    <Input
                      id="shelves-per-block"
                      type="number"
                      min="1"
                      value={cellEditForm.shelves_per_block}
                      onChange={(e) => setCellEditForm({...cellEditForm, shelves_per_block: e.target.value})}
                      placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 5"
                    />
                  </div>
                  <div>
                    <Label htmlFor="cells-per-shelf">–Ø—á–µ–µ–∫ –Ω–∞ –ø–æ–ª–∫–µ</Label>
                    <Input
                      id="cells-per-shelf"
                      type="number"
                      min="1"
                      value={cellEditForm.cells_per_shelf}
                      onChange={(e) => setCellEditForm({...cellEditForm, cells_per_shelf: e.target.value})}
                      placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: 4"
                    />
                  </div>
                </div>
                <Button onClick={handleUpdateWarehouseStructure} className="w-full">
                  <Settings className="mr-2 h-4 w-4" />
                  –û–±–Ω–æ–≤–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–∫–ª–∞–¥–∞
                </Button>
              </CardContent>
            </Card>

            {/* –ú–∞—Å—Å–æ–≤—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å QR */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center">
                  <QrCode className="mr-2 h-5 w-5" />
                  –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <Button onClick={handleGenerateAllCellsQR} className="h-16">
                    <QrCode className="mr-2 h-6 w-6" />
                    <div className="text-left">
                      <div className="font-semibold">–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ QR –∫–æ–¥—ã</div>
                      <div className="text-sm opacity-75">–°–æ–∑–¥–∞—Ç—å QR –∫–æ–¥—ã –¥–ª—è –≤—Å–µ—Ö —è—á–µ–µ–∫ —Å–∫–ª–∞–¥–∞</div>
                    </div>
                  </Button>
                  <Button 
                    variant="outline" 
                    onClick={handleDeleteSelectedCells}
                    disabled={selectedCells.length === 0}
                    className="h-16"
                  >
                    <Trash2 className="mr-2 h-6 w-6" />
                    <div className="text-left">
                      <div className="font-semibold">–£–¥–∞–ª–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ —è—á–µ–π–∫–∏</div>
                      <div className="text-sm opacity-75">
                        {selectedCells.length > 0 ? `–í—ã–±—Ä–∞–Ω–æ: ${selectedCells.length}` : '–ù–µ –≤—ã–±—Ä–∞–Ω–æ —è—á–µ–µ–∫'}
                      </div>
                    </div>
                  </Button>
                </div>
              </CardContent>
            </Card>

            {/* –°–ø–∏—Å–æ–∫ —è—á–µ–µ–∫ */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center justify-between">
                  <div className="flex items-center">
                    <Package className="mr-2 h-5 w-5" />
                    –Ø—á–µ–π–∫–∏ —Å–∫–ª–∞–¥–∞
                  </div>
                  {warehouseCells.length > 0 && (
                    <Badge variant="outline">
                      {warehouseCells.length} —è—á–µ–µ–∫
                    </Badge>
                  )}
                </CardTitle>
              </CardHeader>
              <CardContent>
                {cellsLoading ? (
                  <div className="text-center py-8">
                    <RefreshCw className="mx-auto h-8 w-8 animate-spin text-gray-400 mb-4" />
                    <p className="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —è—á–µ–µ–∫...</p>
                  </div>
                ) : warehouseCells.length === 0 ? (
                  <div className="text-center py-8">
                    <Package className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                    <p className="text-gray-500 mb-2">–Ø—á–µ–µ–∫ –ø–æ–∫–∞ –Ω–µ—Ç</p>
                    <p className="text-sm text-gray-400">–û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–∫–ª–∞–¥–∞ –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —è—á–µ–µ–∫</p>
                  </div>
                ) : (
                  <div className="space-y-6">
                    {/* –ì—Ä—É–ø–ø–æ–≤–æ–µ –≤—ã–¥–µ–ª–µ–Ω–∏–µ */}
                    <div className="flex items-center justify-between p-4 bg-gray-50 rounded-lg">
                      <div className="flex items-center space-x-2">
                        <Checkbox
                          checked={selectedCells.length === warehouseCells.length}
                          onCheckedChange={(checked) => {
                            if (checked) {
                              setSelectedCells(warehouseCells.map(cell => cell.id));
                            } else {
                              setSelectedCells([]);
                            }
                          }}
                        />
                        <span className="text-sm font-medium">–í—ã–±—Ä–∞—Ç—å –≤—Å–µ —è—á–µ–π–∫–∏</span>
                      </div>
                      <div className="text-sm text-gray-600">
                        –í—ã–±—Ä–∞–Ω–æ: {selectedCells.length} –∏–∑ {warehouseCells.length}
                      </div>
                    </div>

                    {/* –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ —è—á–µ–µ–∫ –ø–æ –±–ª–æ–∫–∞–º –≤ –≤–∏–¥–µ —Ç–∞–±–ª–∏—Ü */}
                    {(() => {
                      // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —è—á–µ–π–∫–∏ –ø–æ –±–ª–æ–∫–∞–º
                      const cellsByBlock = warehouseCells.reduce((acc, cell) => {
                        const blockKey = cell.block_number;
                        if (!acc[blockKey]) {
                          acc[blockKey] = [];
                        }
                        acc[blockKey].push(cell);
                        return acc;
                      }, {});

                      return Object.keys(cellsByBlock)
                        .sort((a, b) => parseInt(a) - parseInt(b))
                        .map(blockNumber => {
                          const blockCells = cellsByBlock[blockNumber];
                          
                          // –ì—Ä—É–ø–ø–∏—Ä—É–µ–º —è—á–µ–π–∫–∏ –ø–æ –ø–æ–ª–∫–∞–º –≤–Ω—É—Ç—Ä–∏ –±–ª–æ–∫–∞
                          const cellsByShelf = blockCells.reduce((acc, cell) => {
                            const shelfKey = cell.shelf_number;
                            if (!acc[shelfKey]) {
                              acc[shelfKey] = [];
                            }
                            acc[shelfKey].push(cell);
                            return acc;
                          }, {});

                          return (
                            <div key={blockNumber} className="border rounded-lg overflow-hidden">
                              <div className="bg-blue-50 px-4 py-3 border-b">
                                <h4 className="font-semibold text-blue-800 flex items-center">
                                  <Grid3X3 className="mr-2 h-4 w-4" />
                                  –ë–ª–æ–∫ {blockNumber}
                                  <Badge variant="outline" className="ml-2">
                                    {blockCells.length} —è—á–µ–µ–∫
                                  </Badge>
                                </h4>
                              </div>
                              
                              <div className="p-4 space-y-4">
                                {Object.keys(cellsByShelf)
                                  .sort((a, b) => parseInt(a) - parseInt(b))
                                  .map(shelfNumber => {
                                    const shelfCells = cellsByShelf[shelfNumber].sort((a, b) => a.cell_number - b.cell_number);
                                    
                                    return (
                                      <div key={shelfNumber} className="bg-gray-50 rounded-lg p-3">
                                        <div className="flex items-center justify-between mb-3">
                                          <h5 className="font-medium text-gray-700 flex items-center">
                                            <Package className="mr-1 h-3 w-3" />
                                            –ü–æ–ª–∫–∞ {shelfNumber}
                                          </h5>
                                          <span className="text-xs text-gray-500">{shelfCells.length} —è—á–µ–µ–∫</span>
                                        </div>
                                        
                                        {/* –¢–∞–±–ª–∏—Ü–∞ —è—á–µ–µ–∫ –¥–ª—è –¥–∞–Ω–Ω–æ–π –ø–æ–ª–∫–∏ */}
                                        <div className="grid grid-cols-4 md:grid-cols-6 lg:grid-cols-8 gap-2">
                                          {shelfCells.map((cell) => (
                                            <React.Fragment key={cell.id}>
                                            <div
                                              className={`aspect-square border-2 rounded-lg cursor-pointer transition-all hover:shadow-md ${
                                                selectedCells.includes(cell.id)
                                                  ? 'border-blue-500 bg-blue-100'
                                                  : cell.is_occupied
                                                  ? 'border-red-300 bg-red-50'
                                                  : 'border-green-300 bg-green-50 hover:border-green-400'
                                              }`}
                                              onClick={() => {
                                                if (selectedCells.includes(cell.id)) {
                                                  setSelectedCells(selectedCells.filter(id => id !== cell.id));
                                                } else {
                                                  setSelectedCells([...selectedCells, cell.id]);
                                                }
                                              }}
                                              title={`–Ø—á–µ–π–∫–∞ ${cell.cell_number} (${cell.is_occupied ? '–ó–∞–Ω—è—Ç–∞' : '–°–≤–æ–±–æ–¥–Ω–∞'})`}
                                            >
                                              <div className="h-full flex flex-col items-center justify-center p-1">
                                                {/* –ß–µ–∫–±–æ–∫—Å –¥–ª—è –≤—ã–±–æ—Ä–∞ */}
                                                <div className="mb-1">
                                                  <Checkbox
                                                    checked={selectedCells.includes(cell.id)}
                                                    onCheckedChange={(checked) => {
                                                      if (checked) {
                                                        setSelectedCells([...selectedCells, cell.id]);
                                                      } else {
                                                        setSelectedCells(selectedCells.filter(id => id !== cell.id));
                                                      }
                                                    }}
                                                    onClick={(e) => e.stopPropagation()}
                                                    className="h-3 w-3"
                                                  />
                                                </div>
                                                
                                                {/* –ù–æ–º–µ—Ä —è—á–µ–π–∫–∏ */}
                                                <div className="text-xs font-bold text-center leading-none mb-1">
                                                  {cell.cell_number}
                                                </div>
                                                
                                                {/* –ò–∫–æ–Ω–∫–∞ —Å—Ç–∞—Ç—É—Å–∞ */}
                                                <div className="text-lg">
                                                  {cell.is_occupied ? 'üì¶' : '‚úÖ'}
                                                </div>
                                                
                                                {/* –ö–Ω–æ–ø–∫–∞ QR */}
                                                <Button
                                                  size="sm"
                                                  variant="ghost"
                                                  className="h-5 w-5 p-0 mt-1"
                                                  onClick={(e) => {
                                                    e.stopPropagation();
                                                    handleGenerateCellQR(cell.id, cell.location);
                                                  }}
                                                  title="–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥"
                                                >
                                                  <QrCode className="h-3 w-3" />
                                                </Button>
                                              </div>
                                            </div>
                                          </React.Fragment>
                                          ))}
                                        </div>
                                      </div>
                                    );
                                  })}
                              </div>
                            </div>
                          );
                        });
                    })()}
                  </div>
                )}
              </CardContent>
            </Card>
          </div>

          <div className="flex justify-end space-x-2 pt-4 border-t">
            <Button 
              variant="outline" 
              onClick={() => setCellManagementModal(false)}
            >
              –ó–∞–∫—Ä—ã—Ç—å
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û QR –ö–û–î–ê –Ø–ß–ï–ô–ö–ò */}
      <Dialog open={cellQRModal} onOpenChange={setCellQRModal}>
        <DialogContent className="w-full max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <QrCode className="mr-2 h-5 w-5" />
              QR –∫–æ–¥ —è—á–µ–π–∫–∏
            </DialogTitle>
            <DialogDescription>
              –ü—Ä–æ—Å–º–æ—Ç—Ä –∏ –ø–µ—á–∞—Ç—å QR –∫–æ–¥–∞ –¥–ª—è —è—á–µ–π–∫–∏ {selectedCellQR?.cellLocation}
            </DialogDescription>
          </DialogHeader>
          
          {selectedCellQR && (
            <div className="space-y-4">
              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —è—á–µ–π–∫–µ */}
              <div className="text-center p-4 bg-gray-50 rounded-lg">
                <h3 className="text-lg font-bold text-gray-800 mb-2">
                  {selectedCellQR.cellLocation}
                </h3>
                <p className="text-sm text-gray-600">
                  {selectedCellQR.warehouseName}
                </p>
                {selectedCellQR.qrData && (
                  <p className="text-xs text-gray-500 mt-1 font-mono">
                    –ö–æ–¥: {selectedCellQR.qrData}
                  </p>
                )}
              </div>

              {/* QR –∫–æ–¥ */}
              <div className="flex justify-center">
                <div className="border border-gray-200 p-4 rounded-lg bg-white">
                  <img 
                    src={selectedCellQR.qrCode} 
                    alt="QR –∫–æ–¥ —è—á–µ–π–∫–∏" 
                    className="w-48 h-48 mx-auto"
                  />
                </div>
              </div>

              {/* –ö–Ω–æ–ø–∫–∏ */}
              <div className="flex space-x-2">
                <Button 
                  onClick={handlePrintCellQR}
                  className="flex-1 bg-blue-600 hover:bg-blue-700"
                >
                  <Printer className="mr-2 h-4 w-4" />
                  –ü–µ—á–∞—Ç—å QR –∫–æ–¥–∞
                </Button>
                <Button 
                  variant="outline" 
                  onClick={() => setCellQRModal(false)}
                >
                  –ó–∞–∫—Ä—ã—Ç—å
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* –¢–µ—Å—Ç–æ–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ - –ü–†–û–°–¢–û–ï –±–µ–∑ Radix UI */}
      {console.log('üß™ Rendering testModal:', testModal)}
      {testModal && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          {/* Backdrop */}
          <div 
            className="fixed inset-0 bg-black bg-opacity-50"
            onClick={() => setTestModal(false)}
          ></div>
          
          {/* Modal Content */}
          <div className="relative bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6 z-10">
            <div className="flex items-center justify-between mb-4">
              <h2 className="text-lg font-semibold">üß™ –¢–µ—Å—Ç–æ–≤–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ</h2>
              <button 
                onClick={() => setTestModal(false)}
                className="text-gray-400 hover:text-gray-600"
              >
                <X className="h-5 w-5" />
              </button>
            </div>
            
            <div className="mb-4">
              <p className="text-green-600 font-semibold">‚úÖ –ü—Ä–æ—Å—Ç–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–∞–±–æ—Ç–∞–µ—Ç!</p>
              <p className="text-sm text-gray-600 mt-2">
                –≠—Ç–æ –ø—Ä–æ—Å—Ç–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å–æ–∑–¥–∞–Ω–æ –±–µ–∑ Radix UI –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –±–∞–∑–æ–≤–æ–π —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç–∏.
              </p>
            </div>
            
            <div className="flex justify-end">
              <button 
                onClick={() => setTestModal(false)}
                className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
              >
                –ó–∞–∫—Ä—ã—Ç—å
              </button>
            </div>
          </div>
        </div>
      )}

      {/* –ü—Ä–æ—Å—Ç–æ–µ –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –æ—à–∏–±–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ - –ë–ï–ó Radix UI */}
      {console.log('üé® Rendering loginErrorModal:', loginErrorModal, 'with data:', loginErrorData)}
      {loginErrorModal && loginErrorData && (
        <div className="fixed inset-0 z-50 flex items-center justify-center">
          {/* Backdrop */}
          <div 
            className="fixed inset-0 bg-black bg-opacity-50"
            onClick={() => {
              console.log('üö´ Closing loginErrorModal via backdrop');
              setLoginErrorModal(false);
              setLoginErrorData(null);
            }}
          ></div>
          
          {/* Modal Content */}
          <div className="relative bg-white rounded-lg shadow-xl max-w-md w-full mx-4 p-6 z-10">
            <div className="flex items-center justify-between mb-4">
              <div className="flex items-center space-x-2">
                {loginErrorData.errorType === 'user_not_found' ? (
                  <User className="h-5 w-5 text-blue-600" />
                ) : (
                  <Lock className="h-5 w-5 text-red-600" />
                )}
                <h2 className="text-lg font-semibold">–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞ –≤ —Å–∏—Å—Ç–µ–º—É</h2>
              </div>
              <button 
                onClick={() => {
                  console.log('üö´ Closing loginErrorModal via X button');
                  setLoginErrorModal(false);
                  setLoginErrorData(null);
                }}
                className="text-gray-400 hover:text-gray-600"
              >
                <X className="h-5 w-5" />
              </button>
            </div>
            
            <p className="text-sm text-gray-600 mb-4">
              –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤–≤–µ–¥–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø–æ–ø—ã—Ç–∫—É
            </p>
            
            {/* –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ */}
            <div className={`p-4 rounded-lg border mb-4 ${
              loginErrorData.errorType === 'user_not_found' 
                ? 'bg-blue-50 border-blue-200' 
                : 'bg-red-50 border-red-200'
            }`}>
              <h4 className={`font-semibold mb-2 ${
                loginErrorData.errorType === 'user_not_found' ? 'text-blue-800' : 'text-red-800'
              }`}>
                {loginErrorData.message}
              </h4>
              <p className={`text-sm ${
                loginErrorData.errorType === 'user_not_found' ? 'text-blue-700' : 'text-red-700'
              }`}>
                {loginErrorData.details}
              </p>
            </div>

            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ (–¥–ª—è –æ—à–∏–±–∫–∏ –ø–∞—Ä–æ–ª—è) */}
            {loginErrorData.errorType === 'wrong_password' && loginErrorData.userName && (
              <div className="space-y-2 p-3 bg-gray-50 rounded-lg mb-4">
                <div className="flex justify-between">
                  <span className="text-sm font-medium text-gray-600">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:</span>
                  <span className="text-sm text-gray-800">{loginErrorData.userName}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-sm font-medium text-gray-600">–†–æ–ª—å:</span>
                  <span className="text-sm text-gray-800">{loginErrorData.userRole}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-sm font-medium text-gray-600">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                  <span className="text-sm text-gray-800">{loginErrorData.userPhone}</span>
                </div>
              </div>
            )}

            {/* –§–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞ */}
            {loginErrorData.phoneFormat && (
              <div className="bg-blue-100 border border-blue-200 p-3 rounded-lg mb-4">
                <h5 className="text-sm font-semibold text-blue-800 mb-1">
                  üì± –§–æ—Ä–º–∞—Ç –Ω–æ–º–µ—Ä–∞ —Ç–µ–ª–µ—Ñ–æ–Ω–∞:
                </h5>
                <p className="text-sm text-blue-700">{loginErrorData.phoneFormat}</p>
              </div>
            )}

            {/* –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–∞—Ä–æ–ª—é */}
            {loginErrorData.passwordRequirements && (
              <div className="bg-orange-100 border border-orange-200 p-3 rounded-lg mb-4">
                <h5 className="text-sm font-semibold text-orange-800 mb-1">
                  üîí –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –∫ –ø–∞—Ä–æ–ª—é:
                </h5>
                <p className="text-sm text-orange-700">{loginErrorData.passwordRequirements}</p>
              </div>
            )}

            {/* –î–æ—Å—Ç—É–ø–Ω—ã–µ –¥–µ–π—Å—Ç–≤–∏—è */}
            {loginErrorData.availableActions && loginErrorData.availableActions.length > 0 && (
              <div className="bg-green-100 border border-green-200 p-3 rounded-lg mb-4">
                <h5 className="text-sm font-semibold text-green-800 mb-2">
                  üí° –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:
                </h5>
                <ul className="text-sm text-green-700 space-y-1">
                  {loginErrorData.availableActions.map((action, index) => (
                    <li key={index} className="flex items-center">
                      <span className="mr-2">‚Ä¢</span>
                      {action}
                    </li>
                  ))}
                </ul>
              </div>
            )}

            {/* –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
            <div className="bg-gray-100 border border-gray-200 p-3 rounded-lg mb-4">
              <h5 className="text-sm font-semibold text-gray-800 mb-2">
                üìû –°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ TAJLINE.TJ
              </h5>
              <div className="text-sm text-gray-700 space-y-1">
                <p>–¢–µ–ª–µ—Ñ–æ–Ω: +992 123 456 789</p>
                <p>Email: support@tajline.tj</p>
                <p>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: 9:00 - 18:00 (–ø–Ω-–ø—Ç)</p>
              </div>
            </div>

            <div className="flex justify-end space-x-2">
              <button 
                className="px-4 py-2 border border-gray-300 rounded hover:bg-gray-50"
                onClick={() => {
                  console.log('üö´ Closing loginErrorModal via –ü–æ–Ω—è—Ç–Ω–æ button');
                  setLoginErrorModal(false);
                  setLoginErrorData(null);
                }}
              >
                –ü–æ–Ω—è—Ç–Ω–æ
              </button>
              {loginErrorData.errorType === 'user_not_found' && (
                <button 
                  className="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700"
                  onClick={() => {
                    console.log('üìù Registering new user');
                    setLoginErrorModal(false);
                    setLoginErrorData(null);
                    // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –≤–∫–ª–∞–¥–∫—É —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
                  }}
                >
                  –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
                </button>
              )}
            </div>
          </div>
        </div>
      )}

      {/* –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è */}
      <Dialog open={userStatusModal} onOpenChange={setUserStatusModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center space-x-2">
              {userStatusData?.isDeleted ? (
                <UserX className="h-5 w-5 text-red-600" />
              ) : (
                <Lock className="h-5 w-5 text-orange-600" />
              )}
              <span>–°—Ç–∞—Ç—É—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</span>
            </DialogTitle>
            <DialogDescription>
              –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç—É–ø–µ –∫ –∞–∫–∫–∞—É–Ω—Ç—É
            </DialogDescription>
          </DialogHeader>
          
          {userStatusData && (
            <div className="space-y-4">
              {/* –û—Å–Ω–æ–≤–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —Å—Ç–∞—Ç—É—Å–µ */}
              <div className={`p-4 rounded-lg border ${
                userStatusData.isDeleted 
                  ? 'bg-red-50 border-red-200' 
                  : 'bg-orange-50 border-orange-200'
              }`}>
                <h4 className={`font-semibold mb-2 ${
                  userStatusData.isDeleted ? 'text-red-800' : 'text-orange-800'
                }`}>
                  {userStatusData.statusMessage}
                </h4>
                <p className={`text-sm ${
                  userStatusData.isDeleted ? 'text-red-700' : 'text-orange-700'
                }`}>
                  {userStatusData.statusDetails}
                </p>
              </div>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ */}
              <div className="space-y-2 p-3 bg-gray-50 rounded-lg">
                <div className="flex justify-between">
                  <span className="text-sm font-medium text-gray-600">–ò–º—è:</span>
                  <span className="text-sm text-gray-800">{userStatusData.userName}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-sm font-medium text-gray-600">–†–æ–ª—å:</span>
                  <span className="text-sm text-gray-800">{userStatusData.userRole}</span>
                </div>
                <div className="flex justify-between">
                  <span className="text-sm font-medium text-gray-600">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                  <span className="text-sm text-gray-800">{userStatusData.userPhone}</span>
                </div>
              </div>

              {/* –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
              <div className={`p-3 rounded-lg text-sm ${
                userStatusData.isDeleted 
                  ? 'bg-red-100 text-red-800' 
                  : 'bg-orange-100 text-orange-800'
              }`}>
                {userStatusData.isDeleted ? (
                  <>
                    <strong>–ê–∫–∫–∞—É–Ω—Ç —É–¥–∞–ª–µ–Ω:</strong> –î–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–µ –ø–æ–ª–Ω–æ—Å—Ç—å—é –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω. 
                    –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –∏–ª–∏ —Å–æ–∑–¥–∞–Ω–∏—è –Ω–æ–≤–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞.
                  </>
                ) : (
                  <>
                    <strong>–ê–∫–∫–∞—É–Ω—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω:</strong> –í—Ä–µ–º–µ–Ω–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω –¥–æ—Å—Ç—É–ø –∫ —Å–∏—Å—Ç–µ–º–µ. 
                    –°–≤—è–∂–∏—Ç–µ—Å—å —Å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–º –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ –≤–∞—à–µ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞.
                  </>
                )}
              </div>

              {/* –ö–æ–Ω—Ç–∞–∫—Ç–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è */}
              <div className="bg-blue-50 border border-blue-200 p-3 rounded-lg">
                <h5 className="text-sm font-semibold text-blue-800 mb-2">
                  üìû –°–ª—É–∂–±–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ TAJLINE.TJ
                </h5>
                <div className="text-sm text-blue-700 space-y-1">
                  <p>–¢–µ–ª–µ—Ñ–æ–Ω: +992 123 456 789</p>
                  <p>Email: support@tajline.tj</p>
                  <p>–í—Ä–µ–º—è —Ä–∞–±–æ—Ç—ã: 9:00 - 18:00 (–ø–Ω-–ø—Ç)</p>
                </div>
              </div>
            </div>
          )}

          <div className="flex justify-end space-x-2 mt-4">
            <Button 
              variant="outline" 
              onClick={() => {
                setUserStatusModal(false);
                setUserStatusData(null);
              }}
            >
              –ü–æ–Ω—è—Ç–Ω–æ
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ù–û–í–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –í—ã–±–æ—Ä —Å–∫–ª–∞–¥–∞ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤ */}
      <Dialog open={warehouseSelectionModal} onOpenChange={setWarehouseSelectionModal}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle className="flex items-center space-x-2">
              <Building className="h-6 w-6 text-blue-600" />
              <span>–í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤</span>
            </DialogTitle>
            <DialogDescription>
              –í—ã–±–µ—Ä–∏—Ç–µ —Å–∫–ª–∞–¥ –¥–ª—è –∫–æ—Ç–æ—Ä–æ–≥–æ —Ö–æ—Ç–∏—Ç–µ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥—ã —è—á–µ–µ–∫
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4">
            {warehouses.length === 0 ? (
              <div className="text-center py-8">
                <Building className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                <p className="text-gray-500">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–∫–ª–∞–¥–æ–≤ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤</p>
              </div>
            ) : (
              <div className="space-y-3 max-h-96 overflow-y-auto">
                {warehouses.map(warehouse => (
                  <div
                    key={warehouse.id}
                    className="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 cursor-pointer transition-colors"
                    onClick={() => {
                      setSelectedWarehouseForQR(warehouse);
                      setWarehouseSelectionModal(false);
                      setQrGenerationModal(true);
                    }}
                  >
                    <div className="flex items-center justify-between">
                      <div className="flex items-center space-x-3">
                        <div className="bg-blue-100 p-2 rounded-lg">
                          <Building className="h-5 w-5 text-blue-600" />
                        </div>
                        <div>
                          <h4 className="font-medium text-gray-900">{warehouse.name}</h4>
                          <p className="text-sm text-gray-500">{warehouse.address}</p>
                          {warehouse.warehouse_id_number && (
                            <p className="text-xs text-blue-600 font-mono bg-blue-50 px-2 py-1 rounded mt-1 inline-block">
                              –ù–æ–º–µ—Ä: {warehouse.warehouse_id_number}
                            </p>
                          )}
                        </div>
                      </div>
                      <div className="text-right">
                        <QrCode className="h-5 w-5 text-orange-600" />
                        <p className="text-xs text-gray-400 mt-1">–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞</p>
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            )}

            {/* –ö–Ω–æ–ø–∫–∞ –∑–∞–∫—Ä—ã—Ç–∏—è */}
            <div className="flex justify-end pt-4 border-t">
              <Button 
                variant="outline" 
                onClick={() => setWarehouseSelectionModal(false)}
              >
                –û—Ç–º–µ–Ω–∞
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ù–û–í–û–ï –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û: –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤ –¥–ª—è —Å–∫–ª–∞–¥–æ–≤ */}
      <Dialog open={qrGenerationModal} onOpenChange={setQrGenerationModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center space-x-2">
              <QrCode className="h-6 w-6 text-orange-600" />
              <span>–ú–∞—Å—Å–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤</span>
            </DialogTitle>
            <DialogDescription>
              –°–∫–ª–∞–¥: {selectedWarehouseForQR?.name} | –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö QR –∫–æ–¥–æ–≤ —è—á–µ–µ–∫ –≤ —Ñ–æ—Ä–º–∞—Ç–µ XXX-BB-PP-CCC
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-6">
            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∫–ª–∞–¥–µ */}
            <div className="bg-orange-50 border border-orange-200 p-4 rounded-lg">
              <h4 className="font-semibold text-orange-800 mb-3 flex items-center">
                <Building className="mr-2 h-5 w-5" />
                –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∫–ª–∞–¥–µ
              </h4>
              <div className="grid grid-cols-2 gap-4 text-sm">
                <div>
                  <span className="font-medium text-gray-600">–ù–∞–∑–≤–∞–Ω–∏–µ:</span>
                  <span className="ml-2 text-gray-800">{selectedWarehouseForQR?.name}</span>
                </div>
                <div>
                  <span className="font-medium text-gray-600">–ê–¥—Ä–µ—Å:</span>
                  <span className="ml-2 text-gray-800">{selectedWarehouseForQR?.address}</span>
                </div>
                <div>
                  <span className="font-medium text-gray-600">–£–Ω–∏–∫–∞–ª—å–Ω—ã–π –Ω–æ–º–µ—Ä:</span>
                  <span className="ml-2 text-gray-800 bg-blue-100 px-2 py-1 rounded font-mono">
                    {selectedWarehouseForQR?.warehouse_id_number || '–ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏'}
                  </span>
                </div>
                <div>
                  <span className="font-medium text-gray-600">ID —Å–∫–ª–∞–¥–∞:</span>
                  <span className="ml-2 text-gray-800 font-mono text-xs">{selectedWarehouseForQR?.id}</span>
                </div>
              </div>
            </div>

            {/* –¢–∏–ø—ã –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤ */}
            <div className="space-y-4">
              <h4 className="font-semibold text-gray-800 flex items-center">
                <Grid3X3 className="mr-2 h-5 w-5 text-blue-600" />
                –í—ã–±–µ—Ä–∏—Ç–µ —Ç–∏–ø –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ QR –∫–æ–¥–æ–≤
              </h4>

              {/* –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —è—á–µ–π–∫–∏ */}
              <div className="border border-gray-200 rounded-lg p-4">
                <h5 className="font-medium text-gray-700 mb-3 flex items-center">
                  <Target className="mr-2 h-4 w-4 text-purple-600" />
                  –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —è—á–µ–π–∫–∏
                </h5>
                <div className="grid grid-cols-3 gap-3 mb-3">
                  <div>
                    <Label className="text-sm">–ë–ª–æ–∫</Label>
                    <Input 
                      type="number" 
                      min="1" 
                      placeholder="1" 
                      className="mt-1"
                      value={qrCellCode.block || ''} 
                      onChange={(e) => setQrCellCode({...qrCellCode, block: e.target.value})}
                    />
                  </div>
                  <div>
                    <Label className="text-sm">–ü–æ–ª–∫–∞</Label>
                    <Input 
                      type="number" 
                      min="1" 
                      placeholder="1" 
                      className="mt-1"
                      value={qrCellCode.shelf || ''} 
                      onChange={(e) => setQrCellCode({...qrCellCode, shelf: e.target.value})}
                    />
                  </div>
                  <div>
                    <Label className="text-sm">–Ø—á–µ–π–∫–∞</Label>
                    <Input 
                      type="number" 
                      min="1" 
                      placeholder="1" 
                      className="mt-1"
                      value={qrCellCode.cell || ''} 
                      onChange={(e) => setQrCellCode({...qrCellCode, cell: e.target.value})}
                    />
                  </div>
                </div>
                <Button 
                  onClick={() => generateSpecificCellQR()}
                  className="bg-purple-600 hover:bg-purple-700"
                  disabled={!qrCellCode.block || !qrCellCode.shelf || !qrCellCode.cell}
                >
                  <QrCode className="mr-2 h-4 w-4" />
                  –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –¥–ª—è —è—á–µ–π–∫–∏
                </Button>
              </div>

              {/* –ú–∞—Å—Å–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è */}
              <div className="border border-gray-200 rounded-lg p-4">
                <h5 className="font-medium text-gray-700 mb-3 flex items-center">
                  <Grid className="mr-2 h-4 w-4 text-blue-600" />
                  –ú–∞—Å—Å–æ–≤–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤
                </h5>
                <div className="grid grid-cols-2 gap-3">
                  <Button 
                    onClick={() => generateAllCellsQR()}
                    className="bg-blue-600 hover:bg-blue-700"
                    disabled={massQRGeneration.isGenerating}
                  >
                    <QrCode className="mr-2 h-4 w-4" />
                    {massQRGeneration.isGenerating ? '–ì–µ–Ω–µ—Ä–∏—Ä—É—é...' : '–ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –¥–ª—è –≤—Å–µ—Ö —è—á–µ–µ–∫'}
                  </Button>
                  <Button 
                    onClick={() => generateRangeQR()}
                    variant="outline"
                    className="text-green-600 border-green-300 hover:bg-green-50"
                    disabled={massQRGeneration.isGenerating}
                  >
                    <Settings className="mr-2 h-4 w-4" />
                    –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å –ø–æ –¥–∏–∞–ø–∞–∑–æ–Ω—É
                  </Button>
                </div>

                {/* –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –º–∞—Å—Å–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ */}
                {massQRGeneration.isGenerating && (
                  <div className="mt-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-sm font-medium text-blue-800">
                        –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤: {massQRGeneration.current} –∏–∑ {massQRGeneration.total}
                      </span>
                      <span className="text-sm text-blue-600">
                        {massQRGeneration.progress}%
                      </span>
                    </div>
                    <div className="w-full bg-blue-200 rounded-full h-2">
                      <div 
                        className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                        style={{ width: `${massQRGeneration.progress}%` }}
                      ></div>
                    </div>
                    <p className="text-xs text-blue-600 mt-2">
                      –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–¥–æ–∂–¥–∏—Ç–µ. –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç...
                    </p>
                  </div>
                )}

                {/* –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–∞—Å—Å–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ */}
                {!massQRGeneration.isGenerating && massQRGeneration.results.length > 0 && (
                  <div className="mt-4 bg-green-50 border border-green-200 rounded-lg p-4">
                    <h6 className="font-medium text-green-700 mb-3 flex items-center">
                      <CheckCircle className="mr-2 h-4 w-4" />
                      –†–µ–∑—É–ª—å—Ç–∞—Ç—ã –º–∞—Å—Å–æ–≤–æ–π –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ ({massQRGeneration.results.length} QR –∫–æ–¥–æ–≤)
                    </h6>
                    <div className="max-h-48 overflow-y-auto space-y-2">
                      {massQRGeneration.results.slice(0, 10).map((result, index) => (
                        <div key={index} className="flex items-center justify-between text-sm bg-white rounded p-2 border">
                          <span className="font-mono text-green-700">{result.code}</span>
                          <span className="text-gray-600">{result.location}</span>
                        </div>
                      ))}
                      {massQRGeneration.results.length > 10 && (
                        <p className="text-xs text-gray-500 text-center">
                          ... –∏ –µ—â–µ {massQRGeneration.results.length - 10} QR –∫–æ–¥–æ–≤
                        </p>
                      )}
                    </div>
                    <div className="mt-3 flex justify-center space-x-3">
                      <Button 
                        onClick={() => downloadAllQRCodes(massQRGeneration.results)}
                        variant="outline"
                        className="text-green-600 border-green-300 hover:bg-green-50"
                      >
                        <Download className="mr-2 h-4 w-4" />
                        –°–∫–∞—á–∞—Ç—å –≤—Å–µ QR –∫–æ–¥—ã
                      </Button>
                      
                      <Button 
                        onClick={() => printAllQRCodes(massQRGeneration.results)}
                        className="bg-blue-600 hover:bg-blue-700"
                      >
                        <Printer className="mr-2 h-4 w-4" />
                        –ü–µ—á–∞—Ç—å –≤—Å–µ—Ö QR –∫–æ–¥–æ–≤
                      </Button>
                    </div>
                  </div>
                )}
              </div>

              {/* –†–µ–∑—É–ª—å—Ç–∞—Ç –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ */}
              {generatedCellQR && (
                <div className="border border-green-200 rounded-lg p-4 bg-green-50">
                  <h5 className="font-medium text-green-700 mb-3 flex items-center">
                    <CheckCircle className="mr-2 h-4 w-4" />
                    –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π QR –∫–æ–¥
                  </h5>
                  <div className="text-center">
                    {/* –ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ —è—á–µ–π–∫–∏ */}
                    <div className="bg-blue-100 text-blue-800 font-bold text-lg p-3 rounded-lg mb-4">
                      –ë{qrCellCode.block}-–ü{qrCellCode.shelf}-–Ø{qrCellCode.cell}
                    </div>
                    
                    <img 
                      src={generatedCellQR} 
                      alt="Generated QR Code" 
                      className="mx-auto mb-3 border border-gray-200 rounded"
                      style={{ width: '200px', height: '200px' }}
                    />
                    
                    <div className="flex justify-center space-x-3">
                      <Button 
                        onClick={() => downloadQRCode(generatedCellQR, `QR-${selectedWarehouseForQR?.name}-${qrCellCode.block}-${qrCellCode.shelf}-${qrCellCode.cell}`)}
                        variant="outline"
                        className="text-blue-600 border-blue-300 hover:bg-blue-50"
                      >
                        <Download className="mr-2 h-4 w-4" />
                        –°–∫–∞—á–∞—Ç—å QR –∫–æ–¥
                      </Button>
                      
                      <Button 
                        onClick={() => printSingleQRCode()}
                        className="bg-blue-600 hover:bg-blue-700"
                      >
                        <Printer className="mr-2 h-4 w-4" />
                        –ü–µ—á–∞—Ç—å QR –∫–æ–¥–∞
                      </Button>
                    </div>
                  </div>
                </div>
              )}
            </div>

            {/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
            <div className="flex justify-end space-x-3 pt-4 border-t">
              <Button 
                variant="outline" 
                onClick={() => {
                  setQrGenerationModal(false);
                  setSelectedWarehouseForQR(null);
                  setGeneratedCellQR(null);
                  setQrCellCode({ block: '', shelf: '', cell: '' });
                }}
              >
                –ó–∞–∫—Ä—ã—Ç—å
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ì–û–†–û–î–ê–ú–ò –°–ö–õ–ê–î–ê */}
      <Dialog open={showWarehouseCitiesModal} onOpenChange={setShowWarehouseCitiesModal}>
        <DialogContent className="w-full max-w-4xl max-h-[95vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <MapPin className="mr-2 h-5 w-5" />
              –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–∞–º–∏ –¥–æ—Å—Ç–∞–≤–∫–∏: {selectedWarehouseForCities?.name}
            </DialogTitle>
            <DialogDescription>
              –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–ø–∏—Å–∫–æ–º –≥–æ—Ä–æ–¥–æ–≤ –¥–ª—è –≤—ã–¥–∞—á–∏ –≥—Ä—É–∑–∞ —Å —ç—Ç–æ–≥–æ —Å–∫–ª–∞–¥–∞
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-6">
            {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∫–ª–∞–¥–µ */}
            {selectedWarehouseForCities && (
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center text-lg">
                    <Building className="mr-2 h-5 w-5" />
                    –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–∫–ª–∞–¥–µ
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <p className="text-sm text-gray-600">–ù–∞–∑–≤–∞–Ω–∏–µ:</p>
                      <p className="font-semibold">{selectedWarehouseForCities.name}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-600">–ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</p>
                      <p className="font-semibold">{selectedWarehouseForCities.location}</p>
                    </div>
                  </div>
                </CardContent>
              </Card>
            )}

            {/* –î–æ–±–∞–≤–∏—Ç—å –æ–¥–∏–Ω –≥–æ—Ä–æ–¥ */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center text-lg">
                  <Plus className="mr-2 h-5 w-5" />
                  –î–æ–±–∞–≤–∏—Ç—å –≥–æ—Ä–æ–¥
                </CardTitle>
              </CardHeader>
              <CardContent>
                <div className="flex gap-3">
                  <Input
                    placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞..."
                    value={newCityName}
                    onChange={(e) => setNewCityName(e.target.value)}
                    onKeyPress={(e) => e.key === 'Enter' && addWarehouseCity()}
                    className="flex-1"
                  />
                  <Button 
                    onClick={addWarehouseCity}
                    disabled={citiesLoading || !newCityName.trim()}
                  >
                    {citiesLoading ? '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...' : '–î–æ–±–∞–≤–∏—Ç—å'}
                  </Button>
                </div>
              </CardContent>
            </Card>

            {/* –ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤ */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center text-lg">
                  <Grid className="mr-2 h-5 w-5" />
                  –ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ –≥–æ—Ä–æ–¥–æ–≤
                </CardTitle>
                <CardDescription>
                  –í–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏—è –≥–æ—Ä–æ–¥–æ–≤ —á–µ—Ä–µ–∑ –∑–∞–ø—è—Ç—É—é, —Ç–æ—á–∫—É —Å –∑–∞–ø—è—Ç–æ–π –∏–ª–∏ —Å –Ω–æ–≤–æ–π —Å—Ç—Ä–æ–∫–∏
                </CardDescription>
              </CardHeader>
              <CardContent>
                <div className="space-y-3">
                  <textarea
                    placeholder="–ü—Ä–∏–º–µ—Ä:&#10;–î—É—à–∞–Ω–±–µ, –•—É–¥–∂–∞–Ω–¥, –ö—É–ª—è–±&#10;–ö—É—Ä–≥–∞–Ω-–¢—é–±–µ; –ò—Å—Ç–∞—Ä–∞–≤—à–∞–Ω&#10;–¢—É—Ä—Å—É–Ω–∑–∞–¥–µ"
                    value={bulkCitiesText}
                    onChange={(e) => setBulkCitiesText(e.target.value)}
                    rows={4}
                    className="w-full p-3 border border-gray-300 rounded-md resize-y focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                  />
                  <Button 
                    onClick={addWarehouseCitiesBulk}
                    disabled={citiesLoading || !bulkCitiesText.trim()}
                    className="w-full"
                  >
                    {citiesLoading ? '–î–æ–±–∞–≤–ª–µ–Ω–∏–µ...' : '–ú–∞—Å—Å–æ–≤–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ'}
                  </Button>
                </div>
              </CardContent>
            </Card>

            {/* –°–ø–∏—Å–æ–∫ —Ç–µ–∫—É—â–∏—Ö –≥–æ—Ä–æ–¥–æ–≤ */}
            <Card>
              <CardHeader>
                <CardTitle className="flex items-center text-lg">
                  <List className="mr-2 h-5 w-5" />
                  –¢–µ–∫—É—â–∏–µ –≥–æ—Ä–æ–¥–∞ –¥–æ—Å—Ç–∞–≤–∫–∏ ({warehouseCities.length})
                </CardTitle>
              </CardHeader>
              <CardContent>
                {citiesLoading ? (
                  <div className="text-center py-8">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto mb-2"></div>
                    <p className="text-gray-500">–ó–∞–≥—Ä—É–∑–∫–∞ —Å–ø–∏—Å–∫–∞ –≥–æ—Ä–æ–¥–æ–≤...</p>
                  </div>
                ) : warehouseCities.length === 0 ? (
                  <div className="text-center py-8">
                    <MapPin className="mx-auto h-12 w-12 text-gray-400 mb-2" />
                    <p className="text-gray-500 mb-2">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –≥–æ—Ä–æ–¥–æ–≤</p>
                    <p className="text-sm text-gray-400">
                      –î–æ–±–∞–≤—å—Ç–µ –≥–æ—Ä–æ–¥–∞, –≤ –∫–æ—Ç–æ—Ä—ã–µ —ç—Ç–æ—Ç —Å–∫–ª–∞–¥ –º–æ–∂–µ—Ç –¥–æ—Å—Ç–∞–≤–ª—è—Ç—å –≥—Ä—É–∑—ã
                    </p>
                  </div>
                ) : (
                  <div className="space-y-2">
                    {warehouseCities.map((city, index) => (
                      <div 
                        key={index} 
                        className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border"
                      >
                        <div className="flex items-center">
                          <MapPin className="h-4 w-4 text-green-600 mr-2" />
                          <span className="font-medium">{city}</span>
                        </div>
                        <Button
                          variant="outline"
                          size="sm"
                          onClick={() => removeWarehouseCity(city)}
                          disabled={citiesLoading}
                          className="text-red-600 hover:text-red-700 hover:bg-red-50 border-red-200"
                        >
                          <Trash2 className="h-4 w-4" />
                        </Button>
                      </div>
                    ))}
                  </div>
                )}
              </CardContent>
            </Card>

            {/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
            <div className="flex justify-end space-x-3 pt-4 border-t">
              <Button 
                variant="outline" 
                onClick={closeWarehouseCitiesModal}
              >
                –ó–∞–∫—Ä—ã—Ç—å
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ò–Ø –ü–†–ò–Å–ú–ê –ì–†–£–ó–ê */}
      <Dialog open={showCargoConfirmationModal} onOpenChange={setShowCargoConfirmationModal}>
        <DialogContent className="w-full max-w-6xl max-h-[95vh] overflow-y-auto mx-4">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Package className="mr-2 h-5 w-5" />
              –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –ø—Ä–∏—ë–º–∞ –≥—Ä—É–∑–∞
            </DialogTitle>
            <DialogDescription>
              –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –ø–µ—Ä–µ–¥ –æ–∫–æ–Ω—á–∞—Ç–µ–ª—å–Ω—ã–º –ø—Ä–∏—ë–º–æ–º –≥—Ä—É–∑–∞
            </DialogDescription>
          </DialogHeader>
          
          {confirmationCargoData && (
            <div className="space-y-6">
              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª–µ –∏ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                <Card>
                  <CardHeader>
                    <CardTitle className="text-lg flex items-center">
                      <User className="mr-2 h-4 w-4" />
                      –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-2">
                      <div>
                        <span className="text-sm text-gray-600">–§–ò–û:</span>
                        <p className="font-semibold">{confirmationCargoData.sender_info.full_name}</p>
                      </div>
                      <div>
                        <span className="text-sm text-gray-600">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                        <p className="font-semibold">{confirmationCargoData.sender_info.phone}</p>
                      </div>
                    </div>
                  </CardContent>
                </Card>

                <Card>
                  <CardHeader>
                    <CardTitle className="text-lg flex items-center">
                      <User className="mr-2 h-4 w-4" />
                      –ü–æ–ª—É—á–∞—Ç–µ–ª—å
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-2">
                      <div>
                        <span className="text-sm text-gray-600">–§–ò–û:</span>
                        <p className="font-semibold">{confirmationCargoData.recipient_info.full_name}</p>
                      </div>
                      <div>
                        <span className="text-sm text-gray-600">–¢–µ–ª–µ—Ñ–æ–Ω:</span>
                        <p className="font-semibold">{confirmationCargoData.recipient_info.phone}</p>
                      </div>
                      <div>
                        <span className="text-sm text-gray-600">–ê–¥—Ä–µ—Å:</span>
                        <p className="font-semibold">{confirmationCargoData.recipient_info.address}</p>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </div>

              {/* –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ */}
              <Card>
                <CardHeader>
                  <CardTitle className="text-lg flex items-center">
                    <MapPin className="mr-2 h-4 w-4" />
                    –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç–∞–≤–∫–µ
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <div>
                      <span className="text-sm text-gray-600">–ì–æ—Ä–æ–¥ –≤—ã–¥–∞—á–∏:</span>
                      <p className="font-semibold">{confirmationCargoData.delivery_info.city}</p>
                    </div>
                    <div>
                      <span className="text-sm text-gray-600">–°–∫–ª–∞–¥:</span>
                      <p className="font-semibold">{confirmationCargoData.delivery_info.warehouse}</p>
                    </div>
                    <div>
                      <span className="text-sm text-gray-600">–°–ø–æ—Å–æ–± –ø–æ–ª—É—á–µ–Ω–∏—è:</span>
                      <p className="font-semibold">
                        {confirmationCargoData.delivery_info.method === 'pickup' ? '–°–∞–º–æ–≤—ã–≤–æ–∑' :
                         confirmationCargoData.delivery_info.method === 'city_delivery' ? '–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –≥–æ—Ä–æ–¥–∞ –ø–æ–ª—É—á–∞—Ç–µ–ª—è' :
                         confirmationCargoData.delivery_info.method === 'home_delivery' ? '–î–æ—Å—Ç–∞–≤–∫–∞ –¥–æ –¥–æ–º–∞' : confirmationCargoData.delivery_info.method}
                      </p>
                    </div>
                    {/* –ù–û–í–û–ï: –°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã */}
                    <div>
                      <span className="text-sm text-gray-600">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</span>
                      <p className="font-semibold text-blue-600">
                        {confirmationCargoData.payment_info?.method === 'cash' ? 'üí∏ –ù–∞–ª–∏—á–Ω—ã–º–∏' :
                         confirmationCargoData.payment_info?.method === 'card' ? 'üí≥ –ö–∞—Ä—Ç–æ–π' :
                         confirmationCargoData.payment_info?.method === 'transfer' ? 'üè¶ –ü–µ—Ä–µ–≤–æ–¥–æ–º' :
                         confirmationCargoData.payment_info?.method === 'cash_on_delivery' ? 'üì¶ –ù–∞–ª–æ–∂–µ–Ω–Ω—ã–π –ø–ª–∞—Ç–µ–∂' :
                         confirmationCargoData.payment_info?.method === 'deferred' ? '‚è≥ –í –¥–æ–ª–≥' :
                         confirmationCargoData.payment_info?.method || '–ù–µ —É–∫–∞–∑–∞–Ω'}
                      </p>
                    </div>
                    {/* –ù–û–í–û–ï: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –æ–ø–µ—Ä–∞—Ç–æ—Ä–µ */}
                    <div>
                      <span className="text-sm text-gray-600">–ü—Ä–∏–Ω–∏–º–∞–µ—Ç:</span>
                      <p className="font-semibold text-green-600">
                        üë§ {user?.full_name || '–û–ø–µ—Ä–∞—Ç–æ—Ä'} 
                        {user?.phone ? ` (${user.phone})` : ''}
                      </p>
                    </div>
                    {/* –ù–û–í–û–ï: –î–∞—Ç–∞ –∏ –≤—Ä–µ–º—è –ø—Ä–∏–µ–º–∞ */}
                    <div>
                      <span className="text-sm text-gray-600">–î–∞—Ç–∞ –ø—Ä–∏–µ–º–∞:</span>
                      <p className="font-semibold text-gray-800">
                        üìÖ {new Date().toLocaleDateString('ru-RU')} –≤ {new Date().toLocaleTimeString('ru-RU', {hour: '2-digit', minute: '2-digit'})}
                      </p>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* –°–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤ */}
              <Card>
                <CardHeader>
                  <CardTitle className="text-lg flex items-center">
                    <Package className="mr-2 h-4 w-4" />
                    –°–ø–∏—Å–æ–∫ –≥—Ä—É–∑–æ–≤ ({confirmationCargoData.cargo_items.length})
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-4">
                    {confirmationCargoData.cargo_items.map((item, index) => (
                      <div key={index} className="p-4 bg-gray-50 rounded-lg border">
                        <div className="flex justify-between items-center mb-3">
                          <h4 className="font-medium text-gray-900">–ì—Ä—É–∑ #{index + 1}: {item.name}</h4>
                          <span className="text-lg font-bold text-green-600">{item.total_amount.toFixed(2)} ‚ÇΩ</span>
                        </div>
                        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 text-sm">
                          <div>
                            <span className="text-gray-600">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</span>
                            <p className="font-semibold">{item.quantity} —à—Ç</p>
                          </div>
                          <div>
                            <span className="text-gray-600">–í–µ—Å –∑–∞ –µ–¥–∏–Ω–∏—Ü—É:</span>
                            <p className="font-semibold">{item.weight} –∫–≥</p>
                          </div>
                          <div>
                            <span className="text-gray-600">–¶–µ–Ω–∞ –∑–∞ –∫–≥:</span>
                            <p className="font-semibold">{item.price_per_kg.toFixed(2)} ‚ÇΩ</p>
                          </div>
                          <div>
                            <span className="text-gray-600">–û–±—â–∏–π –≤–µ—Å:</span>
                            <p className="font-semibold">{(item.quantity * item.weight).toFixed(1)} –∫–≥</p>
                          </div>
                        </div>
                        <div className="mt-2 text-xs text-gray-500">
                          –†–∞—Å—á—ë—Ç: {item.quantity}—à—Ç √ó {item.weight}–∫–≥ √ó {item.price_per_kg.toFixed(2)}‚ÇΩ/–∫–≥ = {item.total_amount.toFixed(2)}‚ÇΩ
                        </div>
                      </div>
                    ))}
                  </div>
                </CardContent>
              </Card>

              {/* –ò—Ç–æ–≥–∏ */}
              <Card>
                <CardHeader>
                  <CardTitle className="text-lg flex items-center">
                    <Calculator className="mr-2 h-4 w-4" />
                    –ò—Ç–æ–≥–æ
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-2 gap-4">
                    <div className="text-center p-4 bg-blue-50 rounded-lg border">
                      <div className="text-sm text-blue-600">–û–±—â–∏–π –≤–µ—Å</div>
                      <div className="text-2xl font-bold text-blue-600">{confirmationCargoData.totals.total_weight.toFixed(1)} –∫–≥</div>
                    </div>
                    <div className="text-center p-4 bg-green-50 rounded-lg border">
                      <div className="text-sm text-green-600">–û–±—â–∞—è —Å—É–º–º–∞</div>
                      <div className="text-2xl font-bold text-green-600">{confirmationCargoData.totals.total_cost.toFixed(2)} ‚ÇΩ</div>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* QR –∫–æ–¥—ã (–µ—Å–ª–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã) - –£–õ–£–ß–®–ï–ù–ù–´–ô –î–ò–ó–ê–ô–ù */}
              {generatedQRCodes.length > 0 && (
                <Card>
                  <CardHeader>
                    <CardTitle className="text-lg flex items-center">
                      <QrCode className="mr-2 h-4 w-4" />
                      –°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ QR –∫–æ–¥—ã ({generatedQRCodes.length})
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                      {generatedQRCodes.map((qr, index) => (
                        <div key={index} className="p-4 bg-white border-2 border-gray-200 rounded-lg text-center hover:border-blue-300 transition-colors shadow-sm">
                          {/* –ù–∞–∑–≤–∞–Ω–∏–µ –≥—Ä—É–∑–∞ –°–í–ï–†–•–£ */}
                          <div className="font-bold text-base text-gray-800 mb-3 min-h-[40px] flex items-center justify-center">
                            {qr.cargo_name}
                          </div>
                          
                          {/* QR –∫–æ–¥ */}
                          <div className="mb-3">
                            {qr.qr_code_image ? (
                              <img 
                                src={qr.qr_code_image} 
                                alt={`QR –∫–æ–¥ ${qr.id}`}
                                className="w-32 h-32 mx-auto border border-gray-300 rounded"
                              />
                            ) : (
                              <div className="w-32 h-32 mx-auto border border-gray-300 bg-gray-100 flex items-center justify-center rounded">
                                <QrCode className="h-12 w-12 text-gray-400" />
                              </div>
                            )}
                          </div>
                          
                          {/* –ù–æ–º–µ—Ä –≥—Ä—É–∑–∞ –°–ù–ò–ó–£ */}
                          <div className="font-mono text-sm font-bold text-gray-700 mb-2">{qr.id}</div>
                          
                          {/* –î–µ—Ç–∞–ª–∏ –≥—Ä—É–∑–∞ –¥–ª—è –∫–∞–∂–¥–æ–π –µ–¥–∏–Ω–∏—Ü—ã */}
                          <div className="text-xs text-gray-500 space-y-1">
                            <div>–ï–¥–∏–Ω–∏—Ü–∞: <span className="font-semibold">{qr.item_number} –∏–∑ {qr.total_items}</span></div>
                            <div>–í–µ—Å –µ–¥–∏–Ω–∏—Ü—ã: <span className="font-semibold">{(qr.weight / qr.total_items).toFixed(2)} –∫–≥</span></div>
                            <div>–°—Ç–æ–∏–º–æ—Å—Ç—å: <span className="font-semibold">{qr.total_amount?.toFixed(2)} ‚ÇΩ</span></div>
                          </div>
                        </div>
                      ))}
                    </div>
                  </CardContent>
                </Card>
              )}

              {/* –ö–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
              <div className="flex flex-col space-y-3 pt-4 border-t">
                {/* –í–µ—Ä—Ö–Ω–∏–π —Ä—è–¥ - –∫–Ω–æ–ø–∫–∏ –ø–µ—á–∞—Ç–∏ –∏ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è (–ò–°–ü–†–ê–í–õ–ï–ù–ù–´–ï) */}
                {generatedQRCodes.length > 0 && (
                  <div className="flex flex-col sm:flex-row justify-center space-y-2 sm:space-y-0 sm:space-x-3">
                    <Button 
                      variant="outline"
                      onClick={() => printQRCodes(generatedQRCodes)}
                      disabled={qrGenerationInProgress}
                      className="flex-1 bg-blue-50 border-blue-200 hover:bg-blue-100"
                    >
                      <Printer className="mr-2 h-4 w-4" />
                      üñ®Ô∏è –ü–µ—á–∞—Ç—å QR –∫–æ–¥–æ–≤
                    </Button>
                    <Button 
                      variant="outline"
                      onClick={() => downloadQRCodes(generatedQRCodes)}
                      disabled={qrGenerationInProgress}
                      className="flex-1 bg-green-50 border-green-200 hover:bg-green-100"
                    >
                      <Download className="mr-2 h-4 w-4" />
                      üíæ –°–∫–∞—á–∞—Ç—å QR –∫–æ–¥—ã
                    </Button>
                  </div>
                )}
                
                {/* –ù–∏–∂–Ω–∏–π —Ä—è–¥ - –æ—Å–Ω–æ–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è */}
                <div className="flex justify-end space-x-3">
                  <Button 
                    variant="outline" 
                    onClick={closeCargoConfirmationModal}
                    disabled={qrGenerationInProgress}
                  >
                    –û—Ç–º–µ–Ω–∞
                  </Button>
                  {!generatedQRCodes.length && (
                    <Button 
                      onClick={handleConfirmCargoAcceptance}
                      disabled={qrGenerationInProgress}
                      className="bg-green-600 hover:bg-green-700 text-white"
                    >
                      {qrGenerationInProgress ? (
                        <>
                          <div className="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"></div>
                          –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR –∫–æ–¥–æ–≤...
                        </>
                      ) : (
                        <>
                          <CheckCircle className="mr-2 h-4 w-4" />
                          –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –ø—Ä–∏—ë–º –≥—Ä—É–∑–∞
                        </>
                      )}
                    </Button>
                  )}
                  {generatedQRCodes.length > 0 && (
                    <Button 
                      onClick={closeCargoConfirmationModal}
                      className="bg-blue-600 hover:bg-blue-700 text-white"
                    >
                      <CheckCircle className="mr-2 h-4 w-4" />
                      –ó–∞–≤–µ—Ä—à–∏—Ç—å
                    </Button>
                  )}
                </div>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

        {/* –ù–û–í–û–ï: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–µ–π—Å—Ç–≤–∏–π –¥–ª—è individual unit */}
        {selectedUnitForActions && (
          <Dialog open={true} onOpenChange={() => setSelectedUnitForActions(null)}>
            <DialogContent className="sm:max-w-md">
              <DialogHeader>
                <DialogTitle className="flex items-center">
                  <Settings className="mr-2 h-5 w-5" />
                  –î–µ–π—Å—Ç–≤–∏—è –¥–ª—è {selectedUnitForActions.individual_number}
                </DialogTitle>
                <DialogDescription>
                  –í—ã–±–µ—Ä–∏—Ç–µ –¥–µ–π—Å—Ç–≤–∏–µ –¥–ª—è –µ–¥–∏–Ω–∏—Ü—ã –≥—Ä—É–∑–∞
                </DialogDescription>
              </DialogHeader>
              
              <div className="space-y-3">
                {/* –£–õ–£–ß–®–ï–ù–ò–ï: –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –µ–¥–∏–Ω–∏—Ü–µ —Å –∏—Å—Ç–æ—Ä–∏–µ–π —Ä–∞–∑–º–µ—â–µ–Ω–∏—è */}
                <div className="bg-gray-50 p-3 rounded-lg">
                  <div className="text-sm space-y-2">
                    <div><strong>üìã –ó–∞—è–≤–∫–∞:</strong> {selectedUnitForActions.cargo_request_number}</div>
                    <div><strong>üì¶ –ì—Ä—É–∑:</strong> {selectedUnitForActions.cargo_name}</div>
                    <div><strong>üî¢ –¢–∏–ø/–ï–¥–∏–Ω–∏—Ü–∞:</strong> {selectedUnitForActions.type_number}/{selectedUnitForActions.unit_index}</div>
                    <div><strong>üìä –°—Ç–∞—Ç—É—Å:</strong> {selectedUnitForActions.is_placed ? '‚úÖ –†–∞–∑–º–µ—â–µ–Ω' : 'üü° –û–∂–∏–¥–∞–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–∏—è'}</div>
                    
                    {/* –£–õ–£–ß–®–ï–ù–ò–ï: –î–µ—Ç–∞–ª–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –µ—Å–ª–∏ —Ä–∞–∑–º–µ—â–µ–Ω */}
                    {selectedUnitForActions.is_placed && selectedUnitForActions.placement_info && (
                      <div className="bg-green-50 p-2 rounded border-l-4 border-green-400">
                        <div><strong>üìç –ú–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏–µ:</strong> {selectedUnitForActions.placement_info}</div>
                        {selectedUnitForActions.placed_by && (
                          <div><strong>üë§ –†–∞–∑–º–µ—â–µ–Ω –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º:</strong> {selectedUnitForActions.placed_by}</div>
                        )}
                        {selectedUnitForActions.placed_at && (
                          <div><strong>üïí –í—Ä–µ–º—è —Ä–∞–∑–º–µ—â–µ–Ω–∏—è:</strong> {new Date(selectedUnitForActions.placed_at).toLocaleString('ru-RU')}</div>
                        )}
                      </div>
                    )}
                    
                    {/* –£–õ–£–ß–®–ï–ù–ò–ï: –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞—è–≤–∫–∏ */}
                    {selectedUnitForActions.cargo_request_number && (
                      <div className="bg-blue-50 p-2 rounded border-l-4 border-blue-400">
                        <div><strong>üìä –ü—Ä–æ–≥—Ä–µ—Å—Å –∑–∞—è–≤–∫–∏:</strong></div>
                        {/* –ù–∞–π–¥–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å —Ç–µ–∫—É—â–µ–π –∑–∞—è–≤–∫–∏ */}
                        {(() => {
                          const currentGroup = groupedUnitsForPlacement.find(
                            group => group.request_number === selectedUnitForActions.cargo_request_number
                          );
                          if (currentGroup) {
                            return (
                              <div className="text-xs mt-1">
                                <div>‚úÖ –†–∞–∑–º–µ—â–µ–Ω–æ: {currentGroup.placed_units}/{currentGroup.total_units} –µ–¥–∏–Ω–∏—Ü</div>
                                <div className="w-full bg-blue-200 rounded-full h-2 mt-1">
                                  <div 
                                    className="bg-blue-600 h-2 rounded-full transition-all duration-300"
                                    style={{ width: `${(currentGroup.placed_units / currentGroup.total_units) * 100}%` }}
                                  ></div>
                                </div>
                              </div>
                            );
                          }
                          return <div className="text-xs text-gray-500">–î–∞–Ω–Ω—ã–µ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è...</div>;
                        })()}
                      </div>
                    )}
                  </div>
                </div>
                
                {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
                <div className="space-y-2">
                  {/* –ò–°–ü–†–ê–í–õ–ï–ù–ò–ï –ü–†–û–ë–õ–ï–ú–´ 2: –ö–Ω–æ–ø–∫–∞ –ø–µ—á–∞—Ç–∏ QR */}
                  <Button
                    onClick={() => {
                      const unit = selectedUnitForActions; // –°–æ—Ö—Ä–∞–Ω—è–µ–º –¥–æ –æ–±–Ω—É–ª–µ–Ω–∏—è
                      setSelectedUnitForActions(null);
                      handlePrintSingleQR(unit); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é –µ–¥–∏–Ω–∏—Ü—É
                    }}
                    className="w-full bg-purple-600 hover:bg-purple-700 text-white"
                  >
                    <Printer className="mr-2 h-4 w-4" />
                    –ü–µ—á–∞—Ç—å QR –∫–æ–¥
                  </Button>
                  
                  {/* –ì–µ–Ω–µ—Ä–∞—Ü–∏—è QR (–±–µ–∑ –ø–µ—á–∞—Ç–∏) */}
                  <Button
                    onClick={() => {
                      const unit = selectedUnitForActions;
                      setSelectedUnitForActions(null);
                      generateSingleQR(unit.individual_number);
                    }}
                    variant="outline"
                    className="w-full"
                  >
                    <Grid3X3 className="mr-2 h-4 w-4" />
                    –ì–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å QR –∫–æ–¥
                  </Button>
                  
                  {/* –†–∞–∑–º–µ—â–µ–Ω–∏–µ –µ–¥–∏–Ω–∏—Ü—ã */}
                  {!selectedUnitForActions.is_placed && (
                    <Button
                      onClick={() => {
                        const unit = selectedUnitForActions;
                        setSelectedUnitForActions(null);
                        handlePlaceIndividualUnit(unit);
                      }}
                      variant="outline"
                      className="w-full bg-green-50 border-green-300 text-green-700 hover:bg-green-100"
                    >
                      <Grid3X3 className="mr-2 h-4 w-4" />
                      –†–∞–∑–º–µ—Å—Ç–∏—Ç—å –µ–¥–∏–Ω–∏—Ü—É
                    </Button>
                  )}
                  
                  {/* –ó–∞–∫—Ä—ã—Ç—å */}
                  <Button
                    onClick={() => setSelectedUnitForActions(null)}
                    variant="outline"
                    className="w-full"
                  >
                    –ó–∞–∫—Ä—ã—Ç—å
                  </Button>
                </div>
              </div>
            </DialogContent>
          </Dialog>
        )}

        {/* –ù–û–í–û–ï: –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–æ–≤ */}
        {qrPrintMode && (
          <Dialog open={true} onOpenChange={closePrintMode}>
            <DialogContent className="sm:max-w-4xl max-h-[80vh] overflow-y-auto">
              <DialogHeader>
                <DialogTitle className="flex items-center">
                  <Printer className="mr-2 h-5 w-5" />
                  –ü–µ—á–∞—Ç—å QR –∫–æ–¥–æ–≤
                </DialogTitle>
                <DialogDescription>
                  {generatedQrBatch ? 
                    `–ü–µ—á–∞—Ç—å ${generatedQrBatch.total_generated} QR –∫–æ–¥–æ–≤` : 
                    selectedUnitsForPrint.length > 0 ? 
                      `–ü–µ—á–∞—Ç—å QR –∫–æ–¥–∞ –¥–ª—è ${selectedUnitsForPrint[0].individual_number}` : 
                      '–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–æ–≤'
                  }
                </DialogDescription>
              </DialogHeader>
              
              <div className="space-y-4">
                {/* –í—ã–±–æ—Ä –º–∞–∫–µ—Ç–∞ –ø–µ—á–∞—Ç–∏ */}
                {printLayoutOptions && (
                  <div>
                    <label className="block text-sm font-medium mb-2">–ú–∞–∫–µ—Ç –ø–µ—á–∞—Ç–∏:</label>
                    <div className="grid grid-cols-2 gap-2">
                      {Object.entries(printLayoutOptions).map(([key, option]) => (
                        <Button
                          key={key}
                          onClick={() => setQrPrintLayout(key)}
                          variant={qrPrintLayout === key ? "default" : "outline"}
                          className="text-left p-3 h-auto"
                        >
                          <div>
                            <div className="font-medium">{option.name}</div>
                            <div className="text-xs text-gray-500">{option.description}</div>
                            <div className="text-xs text-blue-600">{option.per_page} QR –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É</div>
                          </div>
                        </Button>
                      ))}
                    </div>
                  </div>
                )}
                
                {/* –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä QR –∫–æ–¥–æ–≤ */}
                {(generatedQrBatch?.qr_batch || selectedUnitsForPrint) && (
                  <div className="border rounded-lg p-4 max-h-60 overflow-y-auto">
                    <h4 className="font-medium mb-2">–ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω—ã–π –ø—Ä–æ—Å–º–æ—Ç—Ä:</h4>
                    <div className="grid grid-cols-4 gap-2">
                      {(generatedQrBatch?.qr_batch || selectedUnitsForPrint).slice(0, 12).map((item, index) => (
                        <div key={index} className="text-center border rounded p-2">
                          <img 
                            src={`data:image/png;base64,${item.qr_base64 || item.qr_info?.qr_base64}`} 
                            alt="QR" 
                            className="w-16 h-16 mx-auto mb-1" 
                          />
                          <div className="text-xs truncate">{item.individual_number}</div>
                        </div>
                      ))}
                      {(generatedQrBatch?.qr_batch?.length || selectedUnitsForPrint.length) > 12 && (
                        <div className="text-center border rounded p-2 flex items-center justify-center">
                          <div className="text-xs text-gray-500">
                            +{(generatedQrBatch?.qr_batch?.length || selectedUnitsForPrint.length) - 12} –µ—â—ë
                          </div>
                        </div>
                      )}
                    </div>
                  </div>
                )}
                
                {/* –ö–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */}
                <div className="flex justify-end space-x-2">
                  <Button
                    onClick={closePrintMode}
                    variant="outline"
                  >
                    –û—Ç–º–µ–Ω–∏—Ç—å
                  </Button>
                  <Button
                    onClick={() => {
                      const printData = generatedQrBatch?.qr_batch || selectedUnitsForPrint;
                      executePrint(printData, qrPrintLayout);
                      closePrintMode();
                    }}
                    className="bg-purple-600 hover:bg-purple-700"
                    disabled={!generatedQrBatch && selectedUnitsForPrint.length === 0}
                  >
                    <Printer className="mr-2 h-4 w-4" />
                    –ü–µ—á–∞—Ç—å
                  </Button>
                </div>
              </div>
            </DialogContent>
          </Dialog>
        )}
        
        {/* –ö–æ–º–ø–æ–Ω–µ–Ω—Ç —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –Ω–æ–º–µ—Ä–∞–º–∏ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ */}
        <DevControl />
    </div>
  );
}

export default App;