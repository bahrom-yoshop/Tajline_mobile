import React, { useState, useEffect, useRef } from 'react';
import { Html5QrcodeScanner, Html5Qrcode, Html5QrcodeScannerState } from "html5-qrcode";
import './App.css';
import { Button } from './components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from './components/ui/card';
import { Input } from './components/ui/input';
import { Label } from './components/ui/label';
import { Tabs, TabsContent, TabsList, TabsTrigger } from './components/ui/tabs';
import { Badge } from './components/ui/badge';
import { Alert, AlertDescription } from './components/ui/alert';
import { Dialog, DialogContent, DialogDescription, DialogHeader, DialogTitle, DialogTrigger } from './components/ui/dialog';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from './components/ui/select';
import { Textarea } from './components/ui/textarea';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from './components/ui/table';
import { DropdownMenu, DropdownMenuContent, DropdownMenuItem, DropdownMenuSeparator, DropdownMenuTrigger } from './components/ui/dropdown-menu';
import DataPagination from './components/DataPagination'; // ÐÐ¾Ð²Ñ‹Ð¹ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸Ð¸
import { 
  Truck, Package, Users, Bell, Search, Plus, Edit, Trash2, CheckCircle, 
  Clock, MapPin, User, Shield, Warehouse, Menu, X, Building, 
  DollarSign, FileText, Grid3X3, Package2, Home, CreditCard, Printer, Zap, MessageCircle,
  QrCode, Camera, Download, Calculator, ShoppingCart, RefreshCw, Eye, XCircle, Save, Filter,
  ArrowUp, Ban, Settings, Copy, Minus, Palette, UserCheck, BarChart, Maximize, ArrowLeft, Edit3, BarChart3,
  Scan, Target, MousePointer
} from 'lucide-react';

const BACKEND_URL = process.env.REACT_APP_BACKEND_URL;

function App() {
  const [user, setUser] = useState(null);
  const [token, setToken] = useState(localStorage.getItem('token'));
  // Navigation states
  const [activeTab, setActiveTab] = useState('dashboard');
  const [activeSection, setActiveSection] = useState('dashboard');
  const [sidebarOpen, setSidebarOpen] = useState(true);
  const [currentPage, setCurrentPage] = useState('main'); // 'main', 'cargo-placement'
  const [notifications, setNotifications] = useState([]);
  const [cargo, setCargo] = useState([]);
  const [users, setUsers] = useState([]);
  const [usersPagination, setUsersPagination] = useState({}); // ÐŸÐ°Ð³Ð¸Ð½Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
  const [usersPage, setUsersPage] = useState(1);
  const [usersPerPage, setUsersPerPage] = useState(25);
  const [warehouses, setWarehouses] = useState([]);
  const [warehouseCargo, setWarehouseCargo] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [searchResults, setSearchResults] = useState([]);
  const [trackingNumber, setTrackingNumber] = useState('');
  const [trackingResult, setTrackingResult] = useState(null);

  // ÐÐ¾Ð²Ñ‹Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ð³Ð¾ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð° (Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ 1)
  const [clientDashboard, setClientDashboard] = useState(null);
  const [clientCargo, setClientCargo] = useState([]);
  const [clientCargoDetails, setClientCargoDetails] = useState(null);

  // ÐÐ¾Ð²Ñ‹Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° (Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ 2)
  const [operatorCreateForm, setOperatorCreateForm] = useState({
    full_name: '',
    phone: '',
    address: '',
    password: '',
    warehouse_id: ''
  });
  const [operatorCreationModal, setOperatorCreationModal] = useState(false);
  const [allOperators, setAllOperators] = useState([]);

  // ÐÐ¾Ð²Ñ‹Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°Ð¼Ð¸
  const [cargoOrderForm, setCargoOrderForm] = useState({
    cargo_name: '',
    description: '',
    weight: '',
    declared_value: '80', // ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð´Ð»Ñ ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð”ÑƒÑˆÐ°Ð½Ð±Ðµ
    recipient_full_name: '',
    recipient_phone: '',
    recipient_address: '',
    recipient_city: '',
    route: 'moscow_dushanbe',
    delivery_type: 'standard',
    insurance_requested: false,
    insurance_value: '',
    packaging_service: false,
    home_pickup: false,
    home_delivery: false,
    fragile: false,
    temperature_sensitive: false,
    special_instructions: ''
  });
  const [deliveryOptions, setDeliveryOptions] = useState(null);
  const [costCalculation, setCostCalculation] = useState(null);
  const [isCalculating, setIsCalculating] = useState(false);
  const [cargoOrderResult, setCargoOrderResult] = useState(null);

  // ÐÐžÐ’Ð«Ð• Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜ Ð”Ð›Ð¯ Ð£ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð¯ Ð—ÐÐšÐÐ—ÐÐœÐ˜ ÐšÐ›Ð˜Ð•ÐÐ¢ÐžÐ’

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ ÑƒÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¾Ð±ÑŠÑÐ²Ð»ÐµÐ½Ð½Ð¾Ð¹ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð°
  const getDefaultDeclaredValue = (route) => {
    switch(route) {
      case 'moscow_khujand':
        return '60'; // ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð¥ÑƒÐ´Ð¶Ð°Ð½Ð´: 60 Ñ€ÑƒÐ±Ð»ÐµÐ¹
      case 'moscow_dushanbe':
        return '80'; // ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð”ÑƒÑˆÐ°Ð½Ð±Ðµ: 80 Ñ€ÑƒÐ±Ð»ÐµÐ¹
      case 'moscow_kulob':
        return '80'; // ÐœÐ¾ÑÐºÐ²Ð° â†’ ÐšÑƒÐ»Ð¾Ð±: 80 Ñ€ÑƒÐ±Ð»ÐµÐ¹ 
      case 'moscow_kurgantyube':
        return '80'; // ÐœÐ¾ÑÐºÐ²Ð° â†’ ÐšÑƒÑ€Ð³Ð°Ð½-Ð¢ÑŽÐ±Ðµ: 80 Ñ€ÑƒÐ±Ð»ÐµÐ¹
      case 'moscow_to_tajikistan':
        return '80'; // ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð´Ð»Ñ Ð¾Ð±Ñ‰ÐµÐ³Ð¾ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð°
      default:
        return '80'; // ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ¸ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
  const stopMobileScanning = async () => {
    try {
      // ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð²ÑÐµ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ ÑÐºÐ°Ð½ÐµÑ€Ñ‹
      setSearchScannerActive(false);
      setPlacementActive(false);
      setScannerActive(false);
      setScannerMode('none');
      setScannerError(null);
      
      // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
      setMobilePlacementStep('start');
      setReceiveStep('start');
      setScannedCargo(null);
      setScannedCell(null);
      setReceivedCargo(null);
      setNewCell(null);
      setSearchResult(null);
      setPlacementInfoMessage('');
      
      // ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÐºÐ°Ð¼ÐµÑ€Ñƒ
      await stopCameraScanner();
      await completeQrCleanup("Mobile scanning stopped");
      
      showAlert('Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾', 'info');
    } catch (error) {
      console.error('Error stopping mobile scanning:', error);
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð²Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¾Ð¹
  const performMobilePlacement = async (cargo, cell) => {
    try {
      // Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ
      await handlePlaceCargo(
        cargo.id,
        cell.warehouse_id,
        cell.block_number,
        cell.shelf_number,
        cell.cell_number
      );
      
      // Ð¤Ð¾Ñ€Ð¼Ð¸Ñ€ÑƒÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ð¾Ð¼ Ð³Ñ€ÑƒÐ·Ðµ
      const placementInfo = `Ð“Ñ€ÑƒÐ·: ${cargo.cargo_number} - Ð‘${cell.block_number}-ÐŸ${cell.shelf_number}-Ð¯${cell.cell_number}`;
      
      // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð² ÑÐ¿Ð¸ÑÐ¾Ðº Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ð¹ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ ÑÐµÑÑÐ¸Ð¸
      setSessionPlacements(prev => [...prev, placementInfo]);
      setSessionPlacementCount(prev => prev + 1);
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ñ ÑƒÑÐ¿ÐµÑ…Ð¾Ð¼
      setPlacementInfoMessage(`ðŸŽ‰ Ð“Ñ€ÑƒÐ· ${cargo.cargo_number} ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½ Ð½Ð° Ð‘${cell.block_number}-ÐŸ${cell.shelf_number}-Ð¯${cell.cell_number}! ÐŸÑ€Ð¸ÑÑ‚ÑƒÐ¿Ð¸Ñ‚Ðµ Ðº ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¼Ñƒ Ð³Ñ€ÑƒÐ·Ñƒ.`);
      
      // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð´Ð»Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ
      setMobilePlacementStep('scan-cargo');
      setScannerMode('mobile-placement-cargo');
      setScannedCargo(null);
      setScannedCell(null);
      
      // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ
      showAlert(`Ð“Ñ€ÑƒÐ· ${cargo.cargo_number} Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½! Ð“Ð¾Ñ‚Ð¾Ð² Ðº ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¼Ñƒ.`, 'success');
      
      // ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð°ÐµÐ¼ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð´Ð»Ñ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð³Ñ€ÑƒÐ·Ð°
      setTimeout(() => {
        setPlacementInfoMessage('ÐžÑ‚ÑÐºÐ°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ QR ÐºÐ¾Ð´ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ³Ð¾ Ð³Ñ€ÑƒÐ·Ð° Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ.');
      }, 3000);
      
    } catch (error) {
      console.error('Error in mobile placement:', error);
      setPlacementInfoMessage(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð° ${cargo.cargo_number}: ${error.message}`);
      throw error;
    }
  };

  // New function: Validate cargo number
  const validateCargoNumber = async (cargoNumber) => {
    if (!cargoNumber.trim()) {
      setCargoValidation({ isValid: false, cargoInfo: null, isLoading: false });
      return;
    }

    setCargoValidation({ isValid: false, cargoInfo: null, isLoading: true });

    try {
      // Check if cargo exists by scanning QR endpoint
      const response = await apiCall('/api/qr/scan', 'POST', {
        qr_text: cargoNumber.trim()
      });
      
      if (response && response.type === 'cargo') {
        setCargoValidation({
          isValid: true,
          cargoInfo: {
            cargo_number: response.cargo_number,
            cargo_name: response.cargo_name,
            weight: response.weight,
            sender: response.sender,
            recipient: response.recipient
          },
          isLoading: false
        });
      } else {
        setCargoValidation({
          isValid: false,
          cargoInfo: null,
          isLoading: false
        });
      }
    } catch (error) {
      console.error('Error validating cargo:', error);
      setCargoValidation({
        isValid: false,
        cargoInfo: null,
        isLoading: false
      });
    }
  };

  // New function: Get available warehouse cells
  const getAvailableWarehouseCells = async () => {
    setCellValidation({ availableCells: [], selectedWarehouse: null, isLoading: true });

    try {
      // Get user's assigned warehouses
      const warehousesResponse = await apiCall('/api/warehouses');
      
      if (warehousesResponse && warehousesResponse.length > 0) {
        const warehouse = warehousesResponse[0]; // Use first available warehouse
        
        // Get warehouse structure
        const structureResponse = await apiCall(`/api/warehouses/${warehouse.id}/structure`);
        
        if (structureResponse) {
          // Generate available cells (free cells only)
          const availableCells = [];
          
          for (let block = 1; block <= structureResponse.blocks; block++) {
            for (let shelf = 1; shelf <= structureResponse.shelves_per_block; shelf++) {
              for (let cell = 1; cell <= structureResponse.cells_per_shelf; cell++) {
                // Check if cell is occupied
                const isOccupied = structureResponse.cells.some(c => 
                  c.block === block && c.shelf === shelf && c.cell === cell && c.is_occupied
                );
                
                if (!isOccupied) {
                  availableCells.push({
                    warehouse_id: warehouse.id,
                    warehouse_name: warehouse.name,
                    block: block,
                    shelf: shelf,
                    cell: cell,
                    code: `${warehouse.id}-Ð‘${block}-ÐŸ${shelf}-Ð¯${cell}`,
                    display: `Ð‘Ð»Ð¾Ðº ${block}, ÐŸÐ¾Ð»ÐºÐ° ${shelf}, Ð¯Ñ‡ÐµÐ¹ÐºÐ° ${cell}`
                  });
                }
              }
            }
          }
          
          setCellValidation({
            availableCells: availableCells.slice(0, 20), // Show first 20 available cells
            selectedWarehouse: warehouse,
            isLoading: false
          });
        }
      }
    } catch (error) {
      console.error('Error getting available cells:', error);
      setCellValidation({ availableCells: [], selectedWarehouse: null, isLoading: false });
    }
  };

  // New function: Manual cargo placement
  const handleManualPlacement = async () => {
    if (!manualCargoNumber.trim() || !manualCellCode.trim()) {
      showAlert('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð° Ð¸ ÐºÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸', 'error');
      return;
    }

    try {
      const success = await placeCargoInCell(manualCargoNumber.trim(), manualCellCode.trim());
      
      if (success) {
        showAlert('Ð“Ñ€ÑƒÐ· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ!', 'success');
        setManualCargoNumber('');
        setManualCellCode('');
        await fetchPlacementStatistics();
      }
    } catch (error) {
      console.error('Error in manual placement:', error);
      showAlert(`ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ: ${error.message}`, 'error');
    }
  };

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð° Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¼ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸
  const handleRouteChange = (newRoute) => {
    const defaultValue = getDefaultDeclaredValue(newRoute);
    setCargoOrderForm(prevForm => ({
      ...prevForm,
      route: newRoute,
      declared_value: defaultValue
    }));
  };

  // ÐÐ¾Ð²Ñ‹Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð°Ð¼Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²
  const [pendingOrders, setPendingOrders] = useState([]);
  const [selectedOrder, setSelectedOrder] = useState(null);
  const [orderDetailsModal, setOrderDetailsModal] = useState(false);
  const [editOrderModal, setEditOrderModal] = useState(false);
  const [newOrdersCount, setNewOrdersCount] = useState(0);
  const [orderEditForm, setOrderEditForm] = useState({
    sender_full_name: '',
    sender_phone: '',
    recipient_full_name: '',
    recipient_phone: '',
    recipient_address: '',
    pickup_address: '',
    cargo_name: '',
    weight: '',
    declared_value: '',
    description: '',
    route: '',
    admin_notes: ''
  });

  // Form states
  const [loginForm, setLoginForm] = useState({ phone: '', password: '' });
  const [registerForm, setRegisterForm] = useState({ full_name: '', phone: '', password: '' }); // Ð£Ð±Ñ€Ð°Ð½Ð° Ñ€Ð¾Ð»ÑŒ (Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ 3)
  const [cargoForm, setCargoForm] = useState({
    recipient_name: '',
    recipient_phone: '',
    route: 'moscow_to_tajikistan',
    weight: '',
    description: '',
    declared_value: '',
    sender_address: '',
    recipient_address: ''
  });
  const [warehouseForm, setWarehouseForm] = useState({
    name: '',
    location: '',
    blocks_count: 1,
    shelves_per_block: 1,
    cells_per_shelf: 10
  });
  const [operatorCargoForm, setOperatorCargoForm] = useState({
    sender_full_name: '',
    sender_phone: '',
    recipient_full_name: '',
    recipient_phone: '',
    recipient_address: '',
    weight: '',  // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸ ÑÐ¾ ÑÑ‚Ð°Ñ€Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ð¾Ð¹
    cargo_name: '',  // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸ ÑÐ¾ ÑÑ‚Ð°Ñ€Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ð¾Ð¹
    declared_value: '',  // Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð±ÑƒÐ´ÐµÑ‚ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒÑÑ ÐºÐ°Ðº price_per_kg Ð´Ð»Ñ ÑÑ‚Ð°Ñ€Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ñ‹
    description: '',
    route: 'moscow_to_tajikistan',
    // ÐÐ¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð´Ð»Ñ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð² Ñ Ð¸Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ñ†ÐµÐ½Ð°Ð¼Ð¸
    cargo_items: [{ cargo_name: '', weight: '', price_per_kg: '' }],  // ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð³Ñ€ÑƒÐ· Ð¸Ð¼ÐµÐµÑ‚ ÑÐ²Ð¾ÑŽ Ñ†ÐµÐ½Ñƒ
    price_per_kg: '',  // ÐžÐ±Ñ‰Ð°Ñ Ñ†ÐµÐ½Ð° Ð·Ð° ÐºÐ³ (Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸)
    use_multi_cargo: false,  // Ð¤Ð»Ð°Ð³ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ Ð¼ÐµÐ¶Ð´Ñƒ Ñ€ÐµÐ¶Ð¸Ð¼Ð°Ð¼Ð¸
    // ÐÐžÐ’Ð«Ð• ÐŸÐžÐ›Ð¯ Ð”Ð›Ð¯ Ð£Ð›Ð£Ð§Ð¨Ð•ÐÐÐžÐ™ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ«
    warehouse_id: '',  // Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ ÑÐºÐ»Ð°Ð´
    payment_method: 'not_paid',  // Ð¡Ð¿Ð¾ÑÐ¾Ð± Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹
    payment_amount: '',  // Ð¡ÑƒÐ¼Ð¼Ð° Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹
    debt_due_date: ''  // Ð”Ð°Ñ‚Ð° Ð¿Ð¾Ð³Ð°ÑˆÐµÐ½Ð¸Ñ Ð´Ð¾Ð»Ð³Ð°
  });
  // Operator cargo management states
  const [operatorCargo, setOperatorCargo] = useState([]);
  
  // Calculator states for multi-cargo functionality with individual prices
  const [totalWeight, setTotalWeight] = useState(0);
  const [totalCost, setTotalCost] = useState(0);
  const [cargoBreakdown, setCargoBreakdown] = useState([]);  // Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ñ€Ð°Ð·Ð±Ð¸Ð²ÐºÐ° Ð¿Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ Ð³Ñ€ÑƒÐ·Ñƒ

  // ÐÐžÐ’Ð«Ð• Ð¡ÐžÐ¡Ð¢ÐžÐ¯ÐÐ˜Ð¯ Ð”Ð›Ð¯ Ð£Ð›Ð£Ð§Ð¨Ð•ÐÐÐžÐ™ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ«  
  const [debtorsList, setDebtorsList] = useState([]);  // Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð·Ð°Ð´Ð¾Ð»Ð¶Ð½Ð¸ÐºÐ¾Ð²

  // Personal dashboard states
  const [personalDashboardData, setPersonalDashboardData] = useState(null);
  const [dashboardLoading, setDashboardLoading] = useState(false);
  
  // Admin dashboard analytics states
  const [adminDashboardAnalytics, setAdminDashboardAnalytics] = useState(null);
  const [adminAnalyticsLoading, setAdminAnalyticsLoading] = useState(false);
  
  // Operator dashboard analytics states
  const [operatorDashboardAnalytics, setOperatorDashboardAnalytics] = useState(null);
  const [operatorAnalyticsLoading, setOperatorAnalyticsLoading] = useState(false);
  
  // QR codes and invoice states
  const [cargoNumbers, setCargoNumbers] = useState('');
  const [generatedQRCodes, setGeneratedQRCodes] = useState([]);
  const [generatedInvoice, setGeneratedInvoice] = useState(null);
  const [qrCodeLoading, setQrCodeLoading] = useState(false);
  const [invoiceLoading, setInvoiceLoading] = useState(false);
  const [showQRCodesModal, setShowQRCodesModal] = useState(false);
  const [showInvoiceModal, setShowInvoiceModal] = useState(false);
  
  // New QR Generation Modal states
  const [showQRGenerateModal, setShowQRGenerateModal] = useState(false);
  const [qrGenerateCargoNumber, setQrGenerateCargoNumber] = useState('');
  const [generatedSingleQR, setGeneratedSingleQR] = useState(null);
  const [qrGenerateLoading, setQrGenerateLoading] = useState(false);
  
  // Bulk QR Generation states
  const [showBulkQRModal, setBulkQRModal] = useState(false);
  const [selectedSender, setSelectedSender] = useState(null);
  const [senderCargos, setSenderCargos] = useState([]);
  const [bulkQRResults, setBulkQRResults] = useState([]);
  const [bulkQRLoading, setBulkQRLoading] = useState(false);
  
  // New Cargo Placement Modal states  
  const [showCargoPlacementModal, setShowCargoPlacementModal] = useState(false);
  const [placementActive, setPlacementActive] = useState(false);
  const [placementStep, setPlacementStep] = useState('idle'); // 'idle', 'scan-cargo', 'scan-cell'
  const [scannedCargoForPlacement, setScannedCargoForPlacement] = useState(null);
  const [placementStatistics, setPlacementStatistics] = useState(null);
  
  // Warehouse Management Modal states
  const [showWarehouseManagementModal, setShowWarehouseManagementModal] = useState(false);
  const [selectedWarehouseForManagement, setSelectedWarehouseForManagement] = useState(null);
  const [warehouseStructure, setWarehouseStructure] = useState(null);
  const [warehouseManagementLoading, setWarehouseManagementLoading] = useState(false);
  const [selectedCells, setSelectedCells] = useState([]);
  const [cellQRResults, setCellQRResults] = useState([]);
  const [cellQRLoading, setCellQRLoading] = useState(false);
  
  // Manual placement states
  const [manualCargoNumber, setManualCargoNumber] = useState('');
  const [manualCellCode, setManualCellCode] = useState('');
  
  // Validation states for manual input
  const [cargoValidation, setCargoValidation] = useState({ isValid: false, cargoInfo: null, isLoading: false });
  const [cellValidation, setCellValidation] = useState({ availableCells: [], selectedWarehouse: null, isLoading: false });
  
  // Camera management states
  const [availablePlacementCameras, setAvailablePlacementCameras] = useState([]);
  const [currentPlacementCameraIndex, setCurrentPlacementCameraIndex] = useState(0);
  
  // Application QR code states
  const [applicationQRCode, setApplicationQRCode] = useState(null);
  const [showApplicationQRModal, setShowApplicationQRModal] = useState(false);
  const [applicationQRLoading, setApplicationQRLoading] = useState(false);
  
  // Cargo creation QR code states
  const [createdCargoQR, setCreatedCargoQR] = useState(null);
  const [showCreatedCargoQRModal, setShowCreatedCargoQRModal] = useState(false);
  
  // Modal QR scanner state
  const [modalCameraIndex, setModalCameraIndex] = useState(0);
  const [modalCameras, setModalCameras] = useState([]);
  
  // QR Scanner states
  const [showQRScannerModal, setShowQRScannerModal] = useState(false);
  const [scannerActive, setScannerActive] = useState(false);
  const [scannedCargoInfo, setScannedCargoInfo] = useState(null);
  const [showScannedCargoModal, setShowScannedCargoModal] = useState(false);
  
  // Role management states
  const [showRoleModal, setShowRoleModal] = useState(false);
  const [selectedUserForRole, setSelectedUserForRole] = useState(null);
  const [newRole, setNewRole] = useState('');

  // Advanced search states
  const [advancedSearchOpen, setAdvancedSearchOpen] = useState(false);
  const [searchFilters, setSearchFilters] = useState({
    cargo_status: '',
    payment_status: '',
    processing_status: '',
    route: '',
    sender_phone: '',
    recipient_phone: '',
    date_from: '',
    date_to: '',
    user_role: '',
    user_status: null,
    sort_by: 'created_at',
    sort_order: 'desc'
  });
  const [searchSuggestions, setSearchSuggestions] = useState([]);
  const [showSuggestions, setShowSuggestions] = useState(false);
  const [searchLoading, setSearchLoading] = useState(false);
  const [searchTime, setSearchTime] = useState(0);

  // Profile management states
  const [showOperatorProfile, setShowOperatorProfile] = useState(false);
  const [showUserProfile, setShowUserProfile] = useState(false);
  const [selectedOperatorProfile, setSelectedOperatorProfile] = useState(null);
  const [selectedUserProfile, setSelectedUserProfile] = useState(null);
  const [profileLoading, setProfileLoading] = useState(false);
  
  // Quick cargo creation states
  const [showQuickCargoModal, setShowQuickCargoModal] = useState(false);
  const [quickCargoForm, setQuickCargoForm] = useState({
    sender_id: '',
    recipient_data: {},
    cargo_items: [{ cargo_name: '', weight: '', price_per_kg: '' }],
    route: 'moscow_to_tajikistan',
    description: ''
  });
  const [frequentRecipients, setFrequentRecipients] = useState([]);
  const [selectedRecipient, setSelectedRecipient] = useState(null);
  const [operatorCargoFilter, setOperatorCargoFilter] = useState(''); // Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ Ð´Ð»Ñ ÑÐ¿Ð¸ÑÐºÐ° Ð³Ñ€ÑƒÐ·Ð¾Ð²
  const [operatorCargoPagination, setOperatorCargoPagination] = useState({}); // ÐŸÐ°Ð³Ð¸Ð½Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ ÑÐ¿Ð¸ÑÐºÐ° Ð³Ñ€ÑƒÐ·Ð¾Ð²
  const [operatorCargoPage, setOperatorCargoPage] = useState(1);
  const [operatorCargoPerPage, setOperatorCargoPerPage] = useState(25);
  
  const [availableCargo, setAvailableCargo] = useState([]);
  const [availableCargoForPlacement, setAvailableCargoForPlacement] = useState([]); // Ð“Ñ€ÑƒÐ·Ñ‹ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ
  const [availableCargoPagination, setAvailableCargoPagination] = useState({}); // ÐŸÐ°Ð³Ð¸Ð½Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ
  const [availableCargoPage, setAvailableCargoPage] = useState(1);
  const [availableCargoPerPage, setAvailableCargoPerPage] = useState(25);
  
  const [selectedCargoForDetailView, setSelectedCargoForDetailView] = useState(null); // Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ Ð³Ñ€ÑƒÐ· Ð´Ð»Ñ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹
  const [cargoDetailsModal, setCargoDetailsModal] = useState(false); // ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹ Ð³Ñ€ÑƒÐ·Ð°
  const [quickPlacementModal, setQuickPlacementModal] = useState(false); // Ð‘Ñ‹ÑÑ‚Ñ€Ð¾Ðµ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ
  const [quickPlacementForm, setQuickPlacementForm] = useState({
    block_number: 1,
    shelf_number: 1,
    cell_number: 1
  });
  const [cargoHistory, setCargoHistory] = useState([]);
  const [selectedWarehouse, setSelectedWarehouse] = useState('');
  const [availableCells, setAvailableCells] = useState([]);
  const [historyFilters, setHistoryFilters] = useState({
    status: 'all',
    search: ''
  });
  const [unpaidCargo, setUnpaidCargo] = useState([]);
  const [paymentHistory, setPaymentHistory] = useState([]);
  const [paymentModal, setPaymentModal] = useState(false);
  const [cargoForPayment, setCargoForPayment] = useState(null);
  const [paymentForm, setPaymentForm] = useState({
    cargo_number: '',
    amount_paid: '',
    transaction_type: 'cash',
    notes: ''
  });
  const [warehouseLayout, setWarehouseLayout] = useState(null);
  const [selectedWarehouseForLayout, setSelectedWarehouseForLayout] = useState(null);
  const [layoutModal, setLayoutModal] = useState(false);
  const [usersByRole, setUsersByRole] = useState({
    user: [],
    admin: [],
    warehouse_operator: []
  });
  const [cargoRequests, setCargoRequests] = useState([]);
  const [myRequests, setMyRequests] = useState([]);

  const [requestForm, setRequestForm] = useState({
    recipient_full_name: '',
    recipient_phone: '',
    recipient_address: '',
    pickup_address: '',
    cargo_name: '',
    weight: '',
    declared_value: '80', // ÐŸÐ¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ Ð´Ð»Ñ Ð¾Ð±Ñ‰ÐµÐ³Ð¾ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð° moscow_to_tajikistan
    description: '',
    route: 'moscow_to_tajikistan'
  });

  // Transport states
  const [transports, setTransports] = useState([]);
  const [transportForm, setTransportForm] = useState({
    driver_name: '',
    driver_phone: '',
    transport_number: '',
    capacity_kg: '',
    direction: ''
  });
  const [selectedTransport, setSelectedTransport] = useState(null);
  const [transportManagementModal, setTransportManagementModal] = useState(false);
  const [availableCargoForTransport, setAvailableCargoForTransport] = useState([]);
  const [selectedCargoForPlacement, setSelectedCargoForPlacement] = useState([]);
  const [transportCargoList, setTransportCargoList] = useState([]);
  const [contactModal, setContactModal] = useState(false);

  // Notification management states
  const [notificationDetailsModal, setNotificationDetailsModal] = useState(false);
  const [selectedNotificationDetails, setSelectedNotificationDetails] = useState(null);

  // Search and header states
  const [searchType, setSearchType] = useState('all');
  const [showSearchResults, setShowSearchResults] = useState(false);

  // Operator-warehouse management states
  const [operatorWarehouseBindings, setOperatorWarehouseBindings] = useState([]);
  const [operatorBindingModal, setOperatorBindingModal] = useState(false);
  const [selectedOperatorForBinding, setSelectedOperatorForBinding] = useState('');
  const [selectedWarehouseForBinding, setSelectedWarehouseForBinding] = useState('');

  // Warehouse cell management states
  const [selectedCellCargo, setSelectedCellCargo] = useState(null);
  const [cargoDetailModal, setCargoDetailModal] = useState(false);
  const [cargoEditModal, setCargoEditModal] = useState(false);
  const [cargoMoveModal, setCargoMoveModal] = useState(false);
  const [editingCargo, setEditingCargo] = useState(null);
  const [cargoEditForm, setCargoEditForm] = useState({});
  const [cargoMoveForm, setCargoMoveForm] = useState({
    warehouse_id: '',
    block_number: '',
    shelf_number: '',
    cell_number: ''
  });

  // QR Code states
  const [qrScannerModal, setQrScannerModal] = useState(false);
  const [qrPrintModal, setQrPrintModal] = useState(false);
  const [selectedCargoForQr, setSelectedCargoForQr] = useState(null);
  const [selectedWarehouseForQr, setSelectedWarehouseForQr] = useState(null);
  const [qrScanResult, setQrScanResult] = useState(null);

  // Arrived transport and cargo placement states
  const [arrivedTransports, setArrivedTransports] = useState([]);
  const [selectedArrivedTransport, setSelectedArrivedTransport] = useState(null);
  const [arrivedTransportModal, setArrivedTransportModal] = useState(false);
  const [arrivedCargoList, setArrivedCargoList] = useState([]);
  const [cargoPlacementModal, setCargoPlacementModal] = useState(false);
  const [selectedCargoForWarehouse, setSelectedCargoForWarehouse] = useState(null);
  const [placementForm, setPlacementForm] = useState({
    warehouse_id: '',
    block_number: 1,
    shelf_number: 1,
    cell_number: 1
  });

  // Transport visualization states
  const [transportVisualizationModal, setTransportVisualizationModal] = useState(false);
  const [selectedTransportForVisualization, setSelectedTransportForVisualization] = useState(null);
  const [transportVisualizationData, setTransportVisualizationData] = useState(null);

  // QR/Number cargo placement states
  const [qrPlacementModal, setQrPlacementModal] = useState(false);
  const [qrPlacementForm, setQrPlacementForm] = useState({
    cargo_number: '',
    qr_data: '',
    cell_qr_data: '',
    block_number: 1,
    shelf_number: 1,
    cell_number: 1
  });

  // Operator-specific states
  const [operatorWarehouses, setOperatorWarehouses] = useState([]);
  const [routeWarehouses, setRouteWarehouses] = useState([]);  // Ð¡ÐºÐ»Ð°Ð´Ñ‹ Ð¿Ð¾ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¼Ñƒ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñƒ
  const [showWarehouseScheme, setShowWarehouseScheme] = useState(null); // ID ÑÐºÐ»Ð°Ð´Ð° Ð´Ð»Ñ Ð¿Ð¾ÐºÐ°Ð·Ð° ÑÑ…ÐµÐ¼Ñ‹
  const [warehouseSchemeData, setWarehouseSchemeData] = useState([]); // Ð”Ð°Ð½Ð½Ñ‹Ðµ ÑÑ…ÐµÐ¼Ñ‹ ÑÐºÐ»Ð°Ð´Ð°
  const [warehouseSchemeLoading, setWarehouseSchemeLoading] = useState(false); // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÑ…ÐµÐ¼Ñ‹ ÑÐºÐ»Ð°Ð´Ð°
  const [warehouseCells, setWarehouseCells] = useState([]); // Ð¯Ñ‡ÐµÐ¹ÐºÐ¸ ÑÐºÐ»Ð°Ð´Ð°
  const [showCargoManagementModal, setShowCargoManagementModal] = useState(false); // ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð¾Ð¼
  const [selectedCargoForManagement, setSelectedCargoForManagement] = useState(null); // Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ Ð³Ñ€ÑƒÐ· Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
  const [showWarehouseReport, setShowWarehouseReport] = useState(null); // ID ÑÐºÐ»Ð°Ð´Ð° Ð´Ð»Ñ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
  const [warehouseReportData, setWarehouseReportData] = useState([]); // Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð¿Ð¾ ÑÐºÐ»Ð°Ð´Ñƒ
  const [warehouseDetailedAnalytics, setWarehouseDetailedAnalytics] = useState({}); // Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ° ÑÐºÐ»Ð°Ð´Ð¾Ð²
  const [interwarehouseTransportModal, setInterwarehouseTransportModal] = useState(false);
  const [interwarehouseForm, setInterwarehouseForm] = useState({
    source_warehouse_id: '',
    destination_warehouse_id: '',
    driver_name: '',
    driver_phone: '',
    capacity_kg: 1000
  });

  const [alerts, setAlerts] = useState([]);
  
  // Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ñ… logout'Ð¾Ð²
  const [isLoggingOut, setIsLoggingOut] = useState(false);
  
  // Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ° Ð»Ð¾Ð³Ð¸Ð½Ð°
  const [isLoggingIn, setIsLoggingIn] = useState(false);

  // ÐÐ¾Ð²Ñ‹Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  const [showEditProfile, setShowEditProfile] = useState(false);
  const [editProfileForm, setEditProfileForm] = useState({
    full_name: '',
    phone: '',
    email: '',
    address: ''
  });
  const [showRepeatOrderModal, setShowRepeatOrderModal] = useState(false);
  const [repeatOrderData, setRepeatOrderData] = useState(null);
  const [repeatOrderForm, setRepeatOrderForm] = useState({
    cargo_items: [{ cargo_name: '', weight: '', price_per_kg: '' }],
    recipient_full_name: '',
    recipient_phone: '',
    recipient_address: '',
    route: 'moscow_dushanbe',
    delivery_type: 'standard',
    insurance_requested: false,
    special_instructions: '',
    use_multi_cargo: true
  });
  
  // Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ Ð¼ÑƒÐ»ÑŒÑ‚Ð¸-Ð³Ñ€ÑƒÐ· ÐºÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€Ð° Ð² Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð¼ Ð·Ð°ÐºÐ°Ð·Ðµ
  const [repeatOrderTotalWeight, setRepeatOrderTotalWeight] = useState(0);
  const [repeatOrderTotalCost, setRepeatOrderTotalCost] = useState(0);
  const [repeatOrderBreakdown, setRepeatOrderBreakdown] = useState([]);

  // ÐÐ¾Ð²Ñ‹Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¹
  const [showAdminEditUser, setShowAdminEditUser] = useState(false);
  const [adminEditUserForm, setAdminEditUserForm] = useState({
    id: '',
    full_name: '',
    phone: '',
    email: '',
    address: '',
    role: 'user',
    is_active: true
  });
  const [selectedUserForEdit, setSelectedUserForEdit] = useState(null);
  
  // Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð° Ð°Ð´Ð¼Ð¸Ð½Ð¾Ð¼/Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼
  const [showAdminRepeatOrderModal, setShowAdminRepeatOrderModal] = useState(false);
  const [adminRepeatOrderData, setAdminRepeatOrderData] = useState(null);
  const [adminRepeatOrderForm, setAdminRepeatOrderForm] = useState({
    sender_id: '',
    sender_full_name: '',
    sender_phone: '',
    cargo_items: [{ cargo_name: '', weight: '', price_per_kg: '' }],
    recipient_full_name: '',
    recipient_phone: '',
    recipient_address: '',
    route: 'moscow_dushanbe',
    delivery_type: 'standard',
    insurance_requested: false,
    special_instructions: '',
    use_multi_cargo: true
  });
  
  // Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ Ð¼ÑƒÐ»ÑŒÑ‚Ð¸-Ð³Ñ€ÑƒÐ· ÐºÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€Ð° Ð°Ð´Ð¼Ð¸Ð½Ð°/Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°
  const [adminRepeatOrderTotalWeight, setAdminRepeatOrderTotalWeight] = useState(0);
  const [adminRepeatOrderTotalCost, setAdminRepeatOrderTotalCost] = useState(0);
  const [adminRepeatOrderBreakdown, setAdminRepeatOrderBreakdown] = useState([]);

  // Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ð¸Ð· Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ
  const [isFilledFromProfile, setIsFilledFromProfile] = useState(false);
  const [profileSourceUser, setProfileSourceUser] = useState(null);

  // Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑˆÑ‚Ñ€Ð¸Ñ…-ÐºÐ¾Ð´Ð¾Ð² Ð¸ QR-ÐºÐ¾Ð´Ð¾Ð² Ð¿Ñ€Ð¸ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ð¸
  const [scannerMode, setScannerMode] = useState('none'); // 'none', 'cargo-barcode', 'cell-qr', 'cargo-qr-search'
  const [scannedCargoData, setScannedCargoData] = useState(null);
  const [scannedCellData, setScannedCellData] = useState(null);
  const [placementInProgress, setPlacementInProgress] = useState(false);
  const [scannerError, setScannerError] = useState(null);
  
  // Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ ÐºÐ°Ð¼ÐµÑ€Ñ‹ - Ñ€Ð°Ð·Ð´ÐµÐ»ÐµÐ½Ñ‹ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ ÑÐºÐ°Ð½ÐµÑ€Ð°
  const [html5QrCode, setHtml5QrCode] = useState(null);  // ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÑÐºÐ°Ð½ÐµÑ€
  const [html5QrCodePlacement, setHtml5QrCodePlacement] = useState(null);  // Ð¡ÐºÐ°Ð½ÐµÑ€ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ
  const [html5QrCodeModal, setHtml5QrCodeModal] = useState(null);  // ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐºÐ°Ð½ÐµÑ€
  const scannerRef = useRef(null);
  const modalScannerRef = useRef(null);  // Ref Ð´Ð»Ñ Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐºÐ°Ð½ÐµÑ€Ð°
  
  // Enhanced refs for React-safe QR scanner isolation
  const placementQrReaderRef = useRef(null);
  const html5QrCodePlacementRef = useRef(null);
  const qrContainerRef = useRef(null);
  const isInitializingRef = useRef(false);

  // Complete isolation of Html5Qrcode from React DOM to prevent removeChild errors
  const [qrScannerContainer, setQrScannerContainer] = useState(null);
  
  // ÐœÐ¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
  // ÐŸÐ¾Ð¸ÑÐº Ð³Ñ€ÑƒÐ·Ð°
  const [searchScannerActive, setSearchScannerActive] = useState(false);
  const [searchResult, setSearchResult] = useState(null);
  
  // Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ QR ÐºÐ¾Ð´Ð¾Ð²
  const [qrCargoNumber, setQrCargoNumber] = useState('');
  const [qrCellCode, setQrCellCode] = useState('');
  const [generatedCargoQR, setGeneratedCargoQR] = useState(null);
  const [generatedCellQR, setGeneratedCellQR] = useState(null);
  
  // ÐœÐ¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ
  const [mobilePlacementStep, setMobilePlacementStep] = useState('start'); // 'start', 'scan-cargo', 'scan-cell', 'confirm'
  const [scannedCargo, setScannedCargo] = useState(null);
  const [scannedCell, setScannedCell] = useState(null);
  
  // Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° ÑÐµÑÑÐ¸Ð¸ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ
  const [sessionPlacements, setSessionPlacements] = useState([]);
  const [sessionPlacementCount, setSessionPlacementCount] = useState(0);
  const [placementInfoMessage, setPlacementInfoMessage] = useState('');
  
  // ÐœÐ¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ñ€Ð¸Ñ‘Ð¼ Ð³Ñ€ÑƒÐ·Ð°
  const [receiveStep, setReceiveStep] = useState('start'); // 'start', 'scan-cargo', 'scan-new-cell', 'confirm'
  const [receivedCargo, setReceivedCargo] = useState(null);
  const [newCell, setNewCell] = useState(null);

  // ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÐºÐ°Ð¼ÐµÑ€
  const [availableCameras, setAvailableCameras] = useState([]);
  const [currentCameraIndex, setCurrentCameraIndex] = useState(0);

  // Refs Ð´Ð»Ñ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… QR ÑÐºÐ°Ð½ÐµÑ€Ð¾Ð²
  const searchQrReaderRef = useRef(null);
  const mobilePlacementQrReaderRef = useRef(null);
  const mobileCellQrReaderRef = useRef(null);
  const receiveCargoQrReaderRef = useRef(null);
  const receiveNewCellQrReaderRef = useRef(null);
  
  // Create isolated container for QR scanner to avoid React conflicts
  const createIsolatedQrContainer = () => {
    if (qrContainerRef.current && !qrContainerRef.current.innerHTML.includes('qr-reader-placement-isolated')) {
      // Create completely isolated container
      const isolatedDiv = document.createElement('div');
      isolatedDiv.id = 'qr-reader-placement-isolated';
      isolatedDiv.style.cssText = `
        width: 100%;
        min-height: 400px;
        background-color: #000000;
        border-radius: 8px;
        position: relative;
        overflow: hidden;
      `;
      
      // Clear any existing content safely without React DOM conflicts
      while (qrContainerRef.current.firstChild) {
        qrContainerRef.current.firstChild.remove();
      }
      
      qrContainerRef.current.appendChild(isolatedDiv);
      console.log('ðŸ”§ Ð¡Ð¾Ð·Ð´Ð°Ð½ Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð´Ð»Ñ QR ÑÐºÐ°Ð½ÐµÑ€Ð°');
      return 'qr-reader-placement-isolated';
    }
    return 'qr-reader-placement-isolated';
  };

  // Enhanced cleanup with complete DOM isolation
  const completeQrCleanup = async (context = "Unknown") => {
    try {
      console.log(`ðŸ§¹ ${context}: ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸Ð·Ð¾Ð»ÑÑ†Ð¸Ð¾Ð½Ð½Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° QR ÑÐºÐ°Ð½ÐµÑ€Ð°...`);
      
      // Stop scanner instance first
      if (html5QrCodePlacementRef.current) {
        try {
          const state = html5QrCodePlacementRef.current.getState();
          if (state === Html5QrcodeScannerState.SCANNING) {
            console.log(`â¹ï¸ ${context}: ÐžÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾Ð³Ð¾ ÑÐºÐ°Ð½ÐµÑ€Ð°...`);
            await html5QrCodePlacementRef.current.stop();
          }
          
          // Clear scanner instance
          await html5QrCodePlacementRef.current.clear();
          console.log(`âœ… ${context}: Ð¡ÐºÐ°Ð½ÐµÑ€ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½`);
        } catch (error) {
          console.warn(`âš ï¸ ${context}: ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐµ ÑÐºÐ°Ð½ÐµÑ€Ð°:`, error.message);
        }
        
        html5QrCodePlacementRef.current = null;
        setHtml5QrCodePlacement(null);
      }
      
      // Force cleanup isolated container
      const isolatedContainer = document.getElementById('qr-reader-placement-isolated');
      if (isolatedContainer) {
        console.log(`ðŸ”§ ${context}: ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€Ð°...`);
        
        // Remove all Html5Qrcode elements safely without React DOM conflicts
        const qrElements = isolatedContainer.querySelectorAll('video, canvas, div[id*="html5"], img[id*="qr"]');
        qrElements.forEach(element => {
          try {
            // Use React-safe removal method
            element.remove();
          } catch (removeError) {
            console.debug(`Debug: Ð­Ð»ÐµÐ¼ÐµÐ½Ñ‚ ÑƒÐ¶Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½`);
          }
        });
        
        // Clear container content
        isolatedContainer.innerHTML = '';
        console.log(`âœ… ${context}: Ð˜Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð¾Ñ‡Ð¸Ñ‰ÐµÐ½`);
      }
      
      // Reset states
      setScannerActive(false);
      isInitializingRef.current = false;
      
      console.log(`âœ… ${context}: ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°`);
      
    } catch (error) {
      console.error(`ðŸ’¥ ${context}: ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐµ:`, error);
      // Force reset everything
      html5QrCodePlacementRef.current = null;
      setHtml5QrCodePlacement(null);
      setScannerActive(false);
      isInitializingRef.current = false;
    }
  };
  const [cameraPermission, setCameraPermission] = useState(null);
  const [camerasAvailable, setCamerasAvailable] = useState([]);
  const [selectedCamera, setSelectedCamera] = useState(null);

  // ÐÐ¾Ð²Ñ‹Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°
  const [enhancedPlacementModal, setEnhancedPlacementModal] = useState(false);
  const [selectedCargoForEnhancedPlacement, setSelectedCargoForEnhancedPlacement] = useState(null);
  const [warehouseAnalytics, setWarehouseAnalytics] = useState(null);
  const [selectedWarehouseForPlacement, setSelectedWarehouseForPlacement] = useState('');
  const [selectedBlockForPlacement, setSelectedBlockForPlacement] = useState(1);
  const [selectedShelfForPlacement, setSelectedShelfForPlacement] = useState(1);
  const [selectedCellForPlacement, setSelectedCellForPlacement] = useState(1);
  const [availableCellsForPlacement, setAvailableCellsForPlacement] = useState([]);
  const [placementLoading, setPlacementLoading] = useState(false);

  // Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ ÑÐºÐ»Ð°Ð´Ð°
  const [warehouseDetailedStructure, setWarehouseDetailedStructure] = useState(null);
  const [structureLoading, setStructureLoading] = useState(false);
  const [selectedCellForVisualization, setSelectedCellForVisualization] = useState(null);

  // Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð²
  const [placedCargoList, setPlacedCargoList] = useState([]);
  const [placedCargoPagination, setPlacedCargoPagination] = useState({});
  const [placedCargoPage, setPlacedCargoPage] = useState(1);
  const [placedCargoPerPage, setPlacedCargoPerPage] = useState(25);

  // Ð¡Ð¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ Ð´Ð»Ñ Ð¼Ð°ÑÑÐ¾Ð²Ð¾Ð³Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ (Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸)
  const [selectedWarehouses, setSelectedWarehouses] = useState([]);
  const [selectedCargo, setSelectedCargo] = useState([]);
  const [selectedUsers, setSelectedUsers] = useState([]);
  const [selectedRequests, setSelectedRequests] = useState([]); // Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ Ð·Ð°ÑÐ²ÐºÐ¸
  const [selectedOperators, setSelectedOperators] = useState([]); // Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñ‹
  const [selectedTransports, setSelectedTransports] = useState([]); // Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ñ‹
  const [bulkDeleteLoading, setBulkDeleteLoading] = useState(false);
  const [deleteConfirmModal, setDeleteConfirmModal] = useState(false);
  const [deleteConfirmData, setDeleteConfirmData] = useState(null);
  const [selectAllWarehouses, setSelectAllWarehouses] = useState(false);
  const [selectAllCargo, setSelectAllCargo] = useState(false);
  const [selectAllUsers, setSelectAllUsers] = useState(false);
  const [selectAllRequests, setSelectAllRequests] = useState(false); // Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð²ÑÐµ Ð·Ð°ÑÐ²ÐºÐ¸
  const [selectAllOperators, setSelectAllOperators] = useState(false); // Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð²ÑÐµÑ… Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²
  const [selectAllTransports, setSelectAllTransports] = useState(false); // Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð²ÑÐµ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ñ‹

  // Enhanced QR Scanner cleanup to prevent React removeChild errors
  const safeStopQrScanner = async (qrCodeInstance, elementId, context = "Unknown") => {
    if (!qrCodeInstance) {
      console.log(`âš ï¸ ${context}: QR scanner instance is null, no cleanup needed`);
      return;
    }
    
    try {
      console.log(`ðŸ›‘ ${context}: Safely stopping QR scanner...`);
      
      // Check if scanner is actually running
      const state = qrCodeInstance.getState();
      console.log(`ðŸ“Š ${context}: Scanner state before stop: ${state}`);
      
      if (state === Html5QrcodeScannerState.SCANNING) {
        console.log(`â¹ï¸ ${context}: Scanner is running, stopping...`);
        await qrCodeInstance.stop();
        console.log(`âœ… ${context}: Scanner stopped successfully`);
      } else {
        console.log(`â„¹ï¸ ${context}: Scanner not running (state: ${state}), no stop needed`);
      }
      
      // Clear the scanner instance to avoid React conflicts
      setTimeout(() => {
        try {
          if (qrCodeInstance) {
            qrCodeInstance.clear();
            console.log(`ðŸ§¹ ${context}: Scanner cleared successfully`);
          }
        } catch (clearError) {
          console.warn(`âš ï¸ ${context}: Error during clear (non-critical):`, clearError);
        }
      }, 100);
      
    } catch (error) {
      // Enhanced error handling for React conflicts
      console.warn(`âš ï¸ ${context}: Safe cleanup error:`, error);
      
      if (error.message.includes('removeChild') || error.message.includes('Node')) {
        console.log(`ðŸ”§ ${context}: React DOM conflict detected, forcing cleanup`);
        try {
          // Force cleanup the DOM element to avoid React conflicts
          const element = document.getElementById(elementId);
          if (element) {
            // Remove all Html5Qrcode added children safely without React DOM conflicts
            const children = element.querySelectorAll('video, canvas, div[id*="qr-"]');
            children.forEach(child => {
              try {
                // Use React-safe removal method
                child.remove();
              } catch (childError) {
                console.debug(`Debug: Child removal handled:`, childError);
              }
            });
            console.log(`ðŸ”§ ${context}: Forced DOM cleanup completed`);
          }
        } catch (forceError) {
          console.debug(`Debug: Force cleanup handled:`, forceError);
        }
      }
    }
  };

  const showAlert = (message, type = 'info') => {
    const id = Date.now();
    setAlerts(prev => [...prev, { id, message, type }]);
    setTimeout(() => {
      setAlerts(prev => prev.filter(alert => alert.id !== id));
    }, 5000);
  };

  // Enhanced QR Scanner lifecycle management with complete isolation
  useEffect(() => {
    // Cleanup function to prevent React removeChild errors when component unmounts
    return () => {
      console.log('ðŸ§¹ Component cleanup: ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° QR ÑÐºÐ°Ð½ÐµÑ€Ð¾Ð²...');
      
      // Use isolated cleanup method
      completeQrCleanup("Component Cleanup").catch(error => {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐµ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð°:', error);
      });
      
      console.log('âœ… Component cleanup Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½');
    };
  }, []); // Empty dependency array - only run on mount/unmount

  // Enhanced page navigation cleanup with isolation
  useEffect(() => {
    if (currentPage !== 'cargo-placement') {
      // Clean up placement scanner when leaving placement page
      console.log('ðŸ”„ Page change: Ð˜Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ° ÑÐºÐ°Ð½ÐµÑ€Ð° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ...');
      completeQrCleanup("Page Navigation").catch(error => {
        console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐµ Ð¿Ñ€Ð¸ Ð½Ð°Ð²Ð¸Ð³Ð°Ñ†Ð¸Ð¸:', error);
      });
    }
  }, [currentPage]);

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ ÐºÐ°Ð¼ÐµÑ€Ð¾Ð¹ Ð¸ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼
  const initializeCamera = async () => {
    try {
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÐºÐ°Ð¼ÐµÑ€Ñ‹
      const cameras = await Html5Qrcode.getCameras();
      setCamerasAvailable(cameras);
      
      if (cameras && cameras.length > 0) {
        setCameraPermission(true);
        
        // Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð°Ñ Ð»Ð¾Ð³Ð¸ÐºÐ° Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð·Ð°Ð´Ð½ÐµÐ¹ ÐºÐ°Ð¼ÐµÑ€Ñ‹
        console.log('Available cameras:', cameras.map(c => ({ id: c.id, label: c.label })));
        
        let backCamera = cameras.find(camera => {
          const label = camera.label.toLowerCase();
          return label.includes('back') || 
                 label.includes('rear') ||
                 label.includes('environment') ||
                 label.includes('0') || // Ð§Ð°ÑÑ‚Ð¾ Ð·Ð°Ð´Ð½ÑÑ ÐºÐ°Ð¼ÐµÑ€Ð° Ð¸Ð¼ÐµÐµÑ‚ Ð¸Ð½Ð´ÐµÐºÑ 0
                 label.includes('facing back');
        });

        // Ð•ÑÐ»Ð¸ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð·Ð°Ð´Ð½ÑÑ ÐºÐ°Ð¼ÐµÑ€Ð° Ð¿Ð¾ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑŽ, Ð±ÐµÑ€ÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑŽÑŽ (Ñ‡Ð°ÑÑ‚Ð¾ ÑÑ‚Ð¾ Ð·Ð°Ð´Ð½ÑÑ)
        if (!backCamera && cameras.length > 1) {
          backCamera = cameras[cameras.length - 1];
        }

        // Ð•ÑÐ»Ð¸ Ð²ÑÐµ ÐµÑ‰Ðµ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°, Ð±ÐµÑ€ÐµÐ¼ Ð¿ÐµÑ€Ð²ÑƒÑŽ
        if (!backCamera) {
          backCamera = cameras[0];
        }

        console.log('Selected camera for QR scanning:', backCamera.label);
        setSelectedCamera(backCamera.id);
        return true;
      } else {
        setCameraPermission(false);
        setScannerError('ÐšÐ°Ð¼ÐµÑ€Ð° Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°');
        return false;
      }
    } catch (error) {
      console.error('Camera initialization error:', error);
      setCameraPermission(false);
      setScannerError('ÐžÑˆÐ¸Ð±ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº ÐºÐ°Ð¼ÐµÑ€Ðµ. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ.');
      return false;
    }
  };

  const startCameraScanner = async () => {
    try {
      const cameraInitialized = await initializeCamera();
      if (!cameraInitialized) return;

      const qrCodeInstance = new Html5Qrcode("qr-reader");
      setHtml5QrCode(qrCodeInstance);

      const config = {
        fps: 10,
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0,
        disableFlip: false,
      };

      await qrCodeInstance.start(
        selectedCamera,
        config,
        (decodedText, decodedResult) => {
          console.log('QR Code scanned:', decodedText);
          handleBarcodeScan(decodedText);
          stopCameraScanner();
        },
        (errorMessage) => {
          // Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ÑÑ‚Ð¾ÑÐ½Ð½Ñ‹Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
          console.debug('QR scan error:', errorMessage);
        }
      );

      showAlert(scannerMode === 'cargo-barcode' ? 
        'ÐšÐ°Ð¼ÐµÑ€Ð° Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°. ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð° ÑˆÑ‚Ñ€Ð¸Ñ…-ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð°' : 
        'ÐšÐ°Ð¼ÐµÑ€Ð° Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°. ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð° QR-ÐºÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸', 'info');
    } catch (error) {
      console.error('Camera start error:', error);
      setScannerError('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ');
      showAlert('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ.', 'error');
    }
  };

  const stopCameraScanner = async () => {
    if (html5QrCode) {
      await safeStopQrScanner(html5QrCode, "qr-reader", "Main Scanner");
      setHtml5QrCode(null);
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑˆÑ‚Ñ€Ð¸Ñ…-ÐºÐ¾Ð´Ð¾Ð² Ð¸ QR-ÐºÐ¾Ð´Ð¾Ð²
  const startCargoScanner = async () => {
    setScannerMode('cargo-barcode');
    setScannerActive(true);
    setScannerError(null);
    setScannedCargoData(null);
    await startCameraScanner();
  };

  const startCellScanner = async () => {
    setScannerMode('cell-qr');
    setScannerActive(true);
    setScannerError(null);
    setScannedCellData(null);
    await startCameraScanner();
  };

  const stopScanner = async () => {
    setScannerMode('none');
    setScannerActive(false);
    setScannerError(null);
    await stopCameraScanner();
  };

  // ÐœÐ¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸
  const startCargoSearch = async () => {
    setSearchScannerActive(true);
    setSearchResult(null);
    setScannerMode('cargo-qr-search');
    
    // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½ÑƒÑŽ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð´Ð»Ñ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
    setPlacementActive(true);
    setScannerActive(true);
    setScannerError(null);
    await startMobileQRScanner();
  };

  const startMobilePlacement = async () => {
    setMobilePlacementStep('scan-cargo');
    setScannedCargo(null);
    setScannedCell(null);
    setScannerMode('mobile-placement-cargo');
    setPlacementInfoMessage('ÐžÑ‚ÑÐºÐ°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð° Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ.');
    
    // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½ÑƒÑŽ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð´Ð»Ñ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
    setPlacementActive(true);
    setScannerActive(true);  
    setScannerError(null);
    await startMobileQRScanner();
  };

  const startCargoReceive = async () => {
    setReceiveStep('scan-cargo');
    setReceivedCargo(null);
    setNewCell(null);
    setScannerMode('mobile-receive-cargo');
    
    // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½ÑƒÑŽ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð´Ð»Ñ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
    setPlacementActive(true);
    setScannerActive(true);
    setScannerError(null);
    await startMobileQRScanner();
  };

  const startMobileReceive = async () => {
    setReceiveStep('scan-cargo');
    setReceivedCargo(null);
    setNewCell(null);
    setScannerMode('mobile-receive-cargo');
    
    // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÐ¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½ÑƒÑŽ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ Ð´Ð»Ñ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
    setPlacementActive(true);
    setScannerActive(true);
    setScannerError(null);
    await startMobileQRScanner();
  };

  // Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ QR ÑÐºÐ°Ð½ÐµÑ€Ð° Ð´Ð»Ñ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
  const startMobileQRScanner = async () => {
    try {
      console.log('ðŸ“± Ð—Ð°Ð¿ÑƒÑÐº Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ QR ÑÐºÐ°Ð½ÐµÑ€Ð°...');
      
      // Prevent multiple simultaneous initializations
      if (isInitializingRef.current) {
        console.log('âš ï¸ Ð¡ÐºÐ°Ð½ÐµÑ€ ÑƒÐ¶Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ÑÑ, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐº...');
        return;
      }
      
      isInitializingRef.current = true;
      
      // Complete cleanup first
      await completeQrCleanup("Mobile Scanner Start");
      
      // Use existing container instead of creating isolated one
      const containerId = 'qr-reader-placement';
      const qrElement = document.getElementById(containerId);
      
      if (!qrElement) {
        throw new Error('QR ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½');
      }
      
      console.log('âœ… QR ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð´Ð»Ñ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐºÐ°Ð½ÐµÑ€Ð°');

      // Get cameras with retry logic
      let cameras = [];
      let cameraAttempts = 0;
      const maxCameraAttempts = 3;
      
      while (cameras.length === 0 && cameraAttempts < maxCameraAttempts) {
        try {
          cameraAttempts++;
          console.log(`ðŸŽ¥ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÐºÐ°Ð¼ÐµÑ€ Ð´Ð»Ñ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐºÐ°Ð½ÐµÑ€Ð° (Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° ${cameraAttempts}/${maxCameraAttempts})...`);
          cameras = await Html5Qrcode.getCameras();
          
          if (cameras.length === 0 && cameraAttempts < maxCameraAttempts) {
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        } catch (error) {
          console.error(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÐºÐ°Ð¼ÐµÑ€ (Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° ${cameraAttempts}):`, error);
          if (cameraAttempts < maxCameraAttempts) {
            await new Promise(resolve => setTimeout(resolve, 1000));
          }
        }
      }
      
      if (!cameras || cameras.length === 0) {
        throw new Error('ÐšÐ°Ð¼ÐµÑ€Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹');
      }
      
      console.log(`âœ… ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ ÐºÐ°Ð¼ÐµÑ€: ${cameras.length}`);
      
      // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… ÐºÐ°Ð¼ÐµÑ€ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
      setAvailableCameras(cameras);
      
      // Ð’Ñ‹Ð±Ð¾Ñ€ Ð·Ð°Ð´Ð½ÐµÐ¹ ÐºÐ°Ð¼ÐµÑ€Ñ‹ Ð¿Ñ€Ð¸Ð¾Ñ€Ð¸Ñ‚ÐµÑ‚Ð½Ð¾
      let selectedCameraIndex = 0; // fallback Ð½Ð° Ð¿ÐµÑ€Ð²ÑƒÑŽ ÐºÐ°Ð¼ÐµÑ€Ñƒ
      
      // ÐŸÐ¾Ð¸ÑÐº Ð·Ð°Ð´Ð½ÐµÐ¹ ÐºÐ°Ð¼ÐµÑ€Ñ‹ Ð¿Ð¾ label
      const backCameraIndex = cameras.findIndex(camera => 
        camera.label && (
          camera.label.toLowerCase().includes('back') ||
          camera.label.toLowerCase().includes('rear') ||
          camera.label.toLowerCase().includes('environment') ||
          camera.label.toLowerCase().includes('Ð¾ÑÐ½Ð¾Ð²Ð½Ð°Ñ') ||
          camera.label.toLowerCase().includes('Ð·Ð°Ð´Ð½ÑÑ')
        )
      );
      
      if (backCameraIndex !== -1) {
        selectedCameraIndex = backCameraIndex;
        console.log(`ðŸ“· Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð° Ð·Ð°Ð´Ð½ÑÑ ÐºÐ°Ð¼ÐµÑ€Ð°: ${cameras[backCameraIndex].label}`);
      } else {
        // Ð•ÑÐ»Ð¸ Ð·Ð°Ð´Ð½ÑÑ ÐºÐ°Ð¼ÐµÑ€Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð¿Ð¾ label, Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑŽÑŽ ÐºÐ°Ð¼ÐµÑ€Ñƒ (Ð¾Ð±Ñ‹Ñ‡Ð½Ð¾ Ð·Ð°Ð´Ð½ÑÑ)
        if (cameras.length > 1) {
          selectedCameraIndex = cameras.length - 1;
          console.log(`ðŸ“· Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð° Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑÑ ÐºÐ°Ð¼ÐµÑ€Ð° (Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ð»Ð¾Ð¶Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð·Ð°Ð´Ð½ÑÑ): ${cameras[cameras.length - 1].label}`);
        } else {
          console.log(`ðŸ“· Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð¿ÐµÑ€Ð²Ð°Ñ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°Ñ ÐºÐ°Ð¼ÐµÑ€Ð°: ${cameras[0].label}`);
        }
      }
      
      // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¸Ð½Ð´ÐµÐºÑ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ ÐºÐ°Ð¼ÐµÑ€Ñ‹
      setCurrentCameraIndex(selectedCameraIndex);
      const selectedCameraId = cameras[selectedCameraIndex].id;
      
      // Initialize Html5Qrcode
      const html5QrCode = new Html5Qrcode(containerId);
      html5QrCodePlacementRef.current = html5QrCode;
      
      // Enhanced camera configuration for mobile with improved initialization
      const cameraConfig = {
        width: { ideal: 1280, min: 640 },
        height: { ideal: 720, min: 480 },
        facingMode: "environment", // ÐœÑÐ³ÐºÐ¸Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ Ð´Ð»Ñ Ð»ÑƒÑ‡ÑˆÐµÐ¹ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸
        aspectRatio: 1.777777778
      };
      
      const scannerConfig = {
        fps: 10, // Ð£Ð²ÐµÐ»Ð¸Ñ‡Ð¸Ð»Ð¸ fps Ð´Ð»Ñ Ð»ÑƒÑ‡ÑˆÐµÐ³Ð¾ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
        qrbox: function(viewfinderWidth, viewfinderHeight) {
          const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
          const boxSize = Math.floor(minEdge * 0.7); // Ð£Ð¼ÐµÐ½ÑŒÑˆÐ¸Ð»Ð¸ Ñ€Ð°Ð·Ð¼ÐµÑ€ Ð´Ð»Ñ Ð»ÑƒÑ‡ÑˆÐµÐ³Ð¾ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
          return {
            width: boxSize,
            height: boxSize
          };
        },
        aspectRatio: 1.0
      };
      
      // Start scanning with enhanced error handling and selected camera
      try {
        await html5QrCode.start(
          selectedCameraId, // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½ÑƒÑŽ Ð·Ð°Ð´Ð½ÑŽÑŽ ÐºÐ°Ð¼ÐµÑ€Ñƒ
          cameraConfig,
          (decodedText) => {
            console.log('ðŸ“± ÐœÐ¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ðµ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ:', decodedText);
            handleBarcodeScan(decodedText);
          },
          (error) => {
            // Suppress frequent scanning errors
            if (!error.includes('NotFoundException')) {
              console.debug('Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ...', error);
            }
          },
          scannerConfig
        );
        
        console.log('âœ… ÐœÐ¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ QR ÑÐºÐ°Ð½ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ñ Ð·Ð°Ð´Ð½ÐµÐ¹ ÐºÐ°Ð¼ÐµÑ€Ð¾Ð¹');
        
        // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ Ð´Ð»Ñ ÑÑ‚Ð°Ð±Ð¸Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ ÐºÐ°Ð¼ÐµÑ€Ñ‹
        await new Promise(resolve => setTimeout(resolve, 2000));
        console.log('ðŸ“· ÐšÐ°Ð¼ÐµÑ€Ð° ÑÑ‚Ð°Ð±Ð¸Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°, Ð³Ð¾Ñ‚Ð¾Ð²Ð° Ðº ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ');
        
      } catch (cameraError) {
        console.warn('âš ï¸ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ñ Ð·Ð°Ð´Ð½ÐµÐ¹ ÐºÐ°Ð¼ÐµÑ€Ð¾Ð¹, Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ð¾Ð±Ñ‹Ñ‡Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼...', cameraError);
        
        // Fallback: Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐµÐ¼ Ñ Ð¿ÐµÑ€Ð²Ð¾Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾Ð¹ ÐºÐ°Ð¼ÐµÑ€Ð¾Ð¹
        const fallbackConfig = {
          width: { ideal: 1280, min: 640 },
          height: { ideal: 720, min: 480 }
        };
        
        await html5QrCode.start(
          cameras[0].id, // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿ÐµÑ€Ð²ÑƒÑŽ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½ÑƒÑŽ ÐºÐ°Ð¼ÐµÑ€Ñƒ
          fallbackConfig,
          (decodedText) => {
            console.log('ðŸ“± ÐœÐ¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ðµ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ (fallback):', decodedText);
            handleBarcodeScan(decodedText);
          },
          (error) => {
            if (!error.includes('NotFoundException')) {
              console.debug('Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ...', error);
            }
          },
          scannerConfig
        );
        
        console.log('âœ… ÐœÐ¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ QR ÑÐºÐ°Ð½ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð² fallback Ñ€ÐµÐ¶Ð¸Ð¼Ðµ');
        
        // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ Ð´Ð»Ñ ÑÑ‚Ð°Ð±Ð¸Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸
        await new Promise(resolve => setTimeout(resolve, 2000));
        console.log('ðŸ“· ÐšÐ°Ð¼ÐµÑ€Ð° ÑÑ‚Ð°Ð±Ð¸Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð° (fallback), Ð³Ð¾Ñ‚Ð¾Ð²Ð° Ðº ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ');
      }
      isInitializingRef.current = false;
      
    } catch (error) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ QR ÑÐºÐ°Ð½ÐµÑ€Ð°:', error);
      isInitializingRef.current = false;
      
      setScannerError('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° ÐºÐ°Ð¼ÐµÑ€Ñ‹');
      showAlert(
        'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ñ Ð¸Ð»Ð¸ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð²Ð²Ð¾Ð´.',
        'error'
      );
      
      // Fallback to manual input
      setPlacementActive(false);
      setScannerActive(false);
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ ÐºÐ°Ð¼ÐµÑ€
  const switchCamera = async () => {
    if (!availableCameras || availableCameras.length <= 1) {
      showAlert('Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð´Ð½Ð° ÐºÐ°Ð¼ÐµÑ€Ð°', 'info');
      return;
    }

    try {
      // ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ð¼ Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹ ÑÐºÐ°Ð½ÐµÑ€
      if (html5QrCodePlacementRef.current) {
        await html5QrCodePlacementRef.current.stop();
      }

      // ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð½Ð° ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÑƒÑŽ ÐºÐ°Ð¼ÐµÑ€Ñƒ
      const nextCameraIndex = (currentCameraIndex + 1) % availableCameras.length;
      setCurrentCameraIndex(nextCameraIndex);

      const nextCamera = availableCameras[nextCameraIndex];
      console.log(`ðŸ”„ ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð½Ð° ÐºÐ°Ð¼ÐµÑ€Ñƒ: ${nextCamera.label}`);

      // ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐºÐ°Ð½ÐµÑ€ Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÐºÐ°Ð¼ÐµÑ€Ð¾Ð¹
      const containerId = 'qr-reader-placement';
      const html5QrCode = new Html5Qrcode(containerId);
      html5QrCodePlacementRef.current = html5QrCode;

      // ÐšÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ð¾Ð¹ ÐºÐ°Ð¼ÐµÑ€Ñ‹
      const cameraConfig = {
        width: { ideal: 1280, min: 640 },
        height: { ideal: 720, min: 480 },
        aspectRatio: 1.777777778
      };

      const scannerConfig = {
        fps: 5,
        qrbox: function(viewfinderWidth, viewfinderHeight) {
          const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
          const boxSize = Math.floor(minEdge * 0.8);
          return {
            width: boxSize,
            height: boxSize
          };
        },
        aspectRatio: 1.0
      };

      await html5QrCode.start(
        nextCamera.id,
        cameraConfig,
        (decodedText) => {
          console.log('ðŸ“± Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð½Ð¾Ð¹ ÐºÐ°Ð¼ÐµÑ€Ñ‹:', decodedText);
          handleBarcodeScan(decodedText);
        },
        (error) => {
          if (!error.includes('NotFoundException')) {
            console.debug('Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ...', error);
          }
        },
        scannerConfig
      );

      const cameraType = nextCamera.label && (
        nextCamera.label.toLowerCase().includes('back') ||
        nextCamera.label.toLowerCase().includes('rear') ||
        nextCamera.label.toLowerCase().includes('environment')
      ) ? 'Ð·Ð°Ð´Ð½ÑÑ' : 'Ð¿ÐµÑ€ÐµÐ´Ð½ÑÑ';

      showAlert(`ÐšÐ°Ð¼ÐµÑ€Ð° Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð° Ð½Ð° ${cameraType}`, 'success');
      console.log(`âœ… ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð½Ð° ${cameraType} ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾`);

    } catch (error) {
      console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ ÐºÐ°Ð¼ÐµÑ€Ñ‹:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ ÐºÐ°Ð¼ÐµÑ€Ñ‹. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·.', 'error');
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ QR ÐºÐ¾Ð´Ð¾Ð²
  const generateCargoQR = async () => {
    if (!qrCargoNumber.trim()) {
      showAlert('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°', 'error');
      return;
    }

    try {
      const response = await apiCall('/api/cargo/generate-qr', 'POST', {
        cargo_number: qrCargoNumber.trim()
      });
      
      if (response && response.qr_code) {
        setGeneratedCargoQR(response.qr_code);
        showAlert('QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð° ÑÐ¾Ð·Ð´Ð°Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!', 'success');
      }
    } catch (error) {
      console.error('Error generating cargo QR:', error);
      showAlert(`ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ QR ÐºÐ¾Ð´Ð°: ${error.message}`, 'error');
    }
  };

  const generateCellQR = async () => {
    if (!qrCellCode.trim()) {
      showAlert('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸', 'error');
      return;
    }

    try {
      const response = await apiCall('/api/warehouse/cell/generate-qr', 'POST', {
        cell_code: qrCellCode.trim()
      });
      
      if (response && response.qr_code) {
        setGeneratedCellQR(response.qr_code);
        showAlert('QR ÐºÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸ ÑÐ¾Ð·Ð´Ð°Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!', 'success');
      }
    } catch (error) {
      console.error('Error generating cell QR:', error);
      showAlert(`ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ QR ÐºÐ¾Ð´Ð°: ${error.message}`, 'error');
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
  const confirmMobilePlacement = async () => {
    if (!scannedCargo || !scannedCell) {
      showAlert('ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ', 'error');
      return;
    }

    try {
      await handlePlaceCargo(
        scannedCargo.id,
        scannedCell.warehouse_id,
        scannedCell.block_number,
        scannedCell.shelf_number,
        scannedCell.cell_number
      );
      
      showAlert('Ð“Ñ€ÑƒÐ· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½!', 'success');
      setMobilePlacementStep('start');
      setScannedCargo(null);
      setScannedCell(null);
      setPlacementActive(false);
      setScannerActive(false);
      await completeQrCleanup("Mobile Placement Complete");
    } catch (error) {
      console.error('Error confirming placement:', error);
      showAlert(`ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ: ${error.message}`, 'error');
    }
  };

  const confirmCargoReceive = async () => {
    if (!receivedCargo || !newCell) {
      showAlert('ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð³Ñ€ÑƒÐ·Ð°', 'error');
      return;
    }

    try {
      await handlePlaceCargo(
        receivedCargo.id,
        newCell.warehouse_id,
        newCell.block_number,
        newCell.shelf_number,
        newCell.cell_number
      );
      
      showAlert('Ð“Ñ€ÑƒÐ· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ñ€Ð¸Ð½ÑÑ‚ Ð¸ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½!', 'success');
      setReceiveStep('start');
      setReceivedCargo(null);
      setNewCell(null);
      setPlacementActive(false);
      setScannerActive(false);
      await completeQrCleanup("Cargo Receive Complete");
    } catch (error) {
      console.error('Error confirming receive:', error);
      showAlert(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð³Ñ€ÑƒÐ·Ð°: ${error.message}`, 'error');
    }
  };

  const confirmMobileReceive = async () => {
    if (!receivedCargo || !newCell) {
      showAlert('ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð³Ñ€ÑƒÐ·Ð°', 'error');
      return;
    }

    try {
      await handlePlaceCargo(
        receivedCargo.id,
        newCell.warehouse_id,
        newCell.block_number,
        newCell.shelf_number,
        newCell.cell_number
      );
      
      showAlert('Ð“Ñ€ÑƒÐ· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ñ€Ð¸Ð½ÑÑ‚ Ð¸ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½!', 'success');
      setReceiveStep('start');
      setReceivedCargo(null);
      setNewCell(null);
      setPlacementActive(false);
      setScannerActive(false);
      await completeQrCleanup("Mobile Receive Complete");
    } catch (error) {
      console.error('Error confirming mobile receive:', error);
      showAlert(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð³Ñ€ÑƒÐ·Ð°: ${error.message}`, 'error');
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¿ÐµÑ‡Ð°Ñ‚Ð¸ QR ÐºÐ¾Ð´Ð°
  const printQR = (qrCodeData, title) => {
    if (!qrCodeData) {
      showAlert('QR ÐºÐ¾Ð´ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½', 'error');
      return;
    }

    const printWindow = window.open('', '_blank');
    printWindow.document.write(`
      <html>
        <head>
          <title>ÐŸÐµÑ‡Ð°Ñ‚ÑŒ QR ÐºÐ¾Ð´Ð° - ${title}</title>
          <style>
            body { 
              font-family: Arial, sans-serif; 
              text-align: center; 
              padding: 20px; 
            }
            .qr-container { 
              margin: 20px auto; 
              max-width: 300px; 
            }
            .qr-title { 
              font-size: 18px; 
              font-weight: bold; 
              margin-bottom: 10px; 
            }
            img { 
              max-width: 100%; 
              height: auto; 
            }
          </style>
        </head>
        <body>
          <div class="qr-container">
            <div class="qr-title">${title}</div>
            <img src="${qrCodeData}" alt="QR Code" />
          </div>
        </body>
      </html>
    `);
    printWindow.document.close();
    printWindow.print();
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ ÑÐ±Ñ€Ð¾ÑÐ° Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
  const resetMobilePlacement = async () => {
    setMobilePlacementStep('start');
    setScannedCargo(null);
    setScannedCell(null);
    setPlacementActive(false);
    setScannerActive(false);
    await completeQrCleanup("Mobile Placement Reset");
  };

  const resetCargoReceive = async () => {
    setReceiveStep('start');
    setReceivedCargo(null);
    setNewCell(null);
    setPlacementActive(false);
    setScannerActive(false);
    await completeQrCleanup("Cargo Receive Reset");
  };

  const resetMobileReceive = async () => {
    setReceiveStep('start');
    setReceivedCargo(null);
    setNewCell(null);
    setPlacementActive(false);
    setScannerActive(false);
    await completeQrCleanup("Mobile Receive Reset");
  };

  const resetCargoSearch = async () => {
    setSearchScannerActive(false);
    setSearchResult(null);
    setPlacementActive(false);
    setScannerActive(false);
    await completeQrCleanup("Cargo Search Reset");
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ Ð¿Ð¾ Ð½Ð¾Ð¼ÐµÑ€Ñƒ
  const getCargoByNumber = async (cargoNumber) => {
    try {
      const response = await apiCall(`/api/cargo/track/${cargoNumber}`, 'GET');
      return response;
    } catch (error) {
      console.error('Error getting cargo by number:', error);
      return null;
    }
  };

  const handleBarcodeScan = async (scannedData) => {
    try {
      if (scannerMode === 'cargo-barcode') {
        // Ð˜Ñ‰ÐµÐ¼ Ð³Ñ€ÑƒÐ· Ð¿Ð¾ Ð¾Ñ‚ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð¼Ñƒ Ð½Ð¾Ð¼ÐµÑ€Ñƒ
        const cargoNumber = extractCargoNumber(scannedData);
        const cargo = availableCargoForPlacement.find(item => 
          item.cargo_number === cargoNumber || 
          item.id === cargoNumber ||
          scannedData.includes(cargoNumber)
        );

        if (cargo) {
          setScannedCargoData(cargo);
          setScannerActive(false);
          showAlert(`Ð“Ñ€ÑƒÐ· ${cargo.cargo_number} Ð½Ð°Ð¹Ð´ÐµÐ½! Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¾Ñ‚ÑÐºÐ°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ QR-ÐºÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ.`, 'success');
          
          // ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ðº ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ ÑÑ‡ÐµÐ¹ÐºÐ¸
          setTimeout(() => {
            startCellScanner();
          }, 1500);
        } else {
          setScannerError('Ð“Ñ€ÑƒÐ· Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² ÑÐ¿Ð¸ÑÐºÐµ Ð¾Ð¶Ð¸Ð´Ð°ÑŽÑ‰Ð¸Ñ… Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ');
          showAlert('Ð“Ñ€ÑƒÐ· Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² ÑÐ¿Ð¸ÑÐºÐµ Ð¾Ð¶Ð¸Ð´Ð°ÑŽÑ‰Ð¸Ñ… Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°.', 'error');
        }
      } else if (scannerMode === 'cell-qr') {
        // ÐŸÐ°Ñ€ÑÐ¸Ð¼ QR-ÐºÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸
        const cellData = parseCellQRCode(scannedData);
        if (cellData) {
          setScannedCellData(cellData);
          setScannerActive(false);
          showAlert(`Ð¯Ñ‡ÐµÐ¹ÐºÐ° Ð½Ð°Ð¹Ð´ÐµÐ½Ð°: Ð¡ÐºÐ»Ð°Ð´ ${cellData.warehouse_id}, Ð‘Ð»Ð¾Ðº ${cellData.block_number}, ÐŸÐ¾Ð»ÐºÐ° ${cellData.shelf_number}, Ð¯Ñ‡ÐµÐ¹ÐºÐ° ${cellData.cell_number}`, 'success');
          
          // ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ñ€Ð°Ð·Ð¼ÐµÑ‰Ð°ÐµÐ¼ Ð³Ñ€ÑƒÐ·
          if (scannedCargoData) {
            await performAutoPlacement();
          }
        } else {
          setScannerError('ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ QR-ÐºÐ¾Ð´Ð° ÑÑ‡ÐµÐ¹ÐºÐ¸');
          showAlert('ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ QR-ÐºÐ¾Ð´Ð° ÑÑ‡ÐµÐ¹ÐºÐ¸. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·.', 'error');
        }
      } else if (scannerMode === 'cargo-qr-search') {
        // Ð ÐµÐ¶Ð¸Ð¼ Ð¿Ð¾Ð¸ÑÐºÐ° Ð³Ñ€ÑƒÐ·Ð°
        const cargoNumber = extractCargoNumber(scannedData);
        const cargoInfo = await getCargoByNumber(cargoNumber);
        
        if (cargoInfo) {
          setSearchResult(cargoInfo);
          setSearchScannerActive(false);
          setPlacementActive(false);
          setScannerActive(false);
          await completeQrCleanup("Cargo Search Complete");
          showAlert(`Ð“Ñ€ÑƒÐ· ${cargoInfo.cargo_number} Ð½Ð°Ð¹Ð´ÐµÐ½!`, 'success');
        } else {
          setScannerError('Ð“Ñ€ÑƒÐ· Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½');
          showAlert('Ð“Ñ€ÑƒÐ· Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ', 'error');
        }
      } else if (scannerMode === 'mobile-placement-cargo') {
        // ÐœÐ¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ - ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°
        const cargoNumber = extractCargoNumber(scannedData);
        const cargoInfo = await getCargoByNumber(cargoNumber);
        
        if (cargoInfo) {
          setScannedCargo(cargoInfo);
          setMobilePlacementStep('scan-cell');
          setScannerMode('mobile-placement-cell');
          
          // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
          setPlacementInfoMessage(`âœ… Ð“Ñ€ÑƒÐ· Ð¾Ñ‚ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½: ${cargoInfo.cargo_number} - ${cargoInfo.cargo_name || 'Ð“Ñ€ÑƒÐ·'}. Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¾Ñ‚ÑÐºÐ°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ QR ÐºÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ.`);
          
          // ÐÐµ Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐºÐ°Ð½ÐµÑ€, Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ðº ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ ÑÑ‡ÐµÐ¹ÐºÐ¸
          showAlert(`Ð“Ñ€ÑƒÐ· ${cargoInfo.cargo_number} Ð¾Ñ‚ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½. Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¾Ñ‚ÑÐºÐ°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÑ‡ÐµÐ¹ÐºÑƒ.`, 'success');
        } else {
          setScannerError('Ð“Ñ€ÑƒÐ· Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½');
          showAlert('Ð“Ñ€ÑƒÐ· Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ', 'error');
        }
      } else if (scannerMode === 'mobile-placement-cell') {
        // ÐœÐ¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ðµ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ - ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÑ‡ÐµÐ¹ÐºÐ¸
        const cellData = parseCellQRCode(scannedData);
        if (cellData) {
          setScannedCell(cellData);
          
          // Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸
          try {
            await performMobilePlacement(scannedCargo, cellData);
          } catch (error) {
            console.error('ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ:', error);
            showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ð¸ Ð³Ñ€ÑƒÐ·Ð°', 'error');
          }
        } else {
          setScannerError('ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ QR-ÐºÐ¾Ð´Ð° ÑÑ‡ÐµÐ¹ÐºÐ¸');
          showAlert('ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ QR-ÐºÐ¾Ð´Ð° ÑÑ‡ÐµÐ¹ÐºÐ¸. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·.', 'error');
        }
      } else if (scannerMode === 'mobile-receive-cargo') {
        // ÐœÐ¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ñ€Ð¸Ñ‘Ð¼ - ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°
        const cargoNumber = extractCargoNumber(scannedData);
        const cargoInfo = await getCargoByNumber(cargoNumber);
        
        if (cargoInfo) {
          setReceivedCargo(cargoInfo);
          setReceiveStep('scan-new-cell');
          setScannerMode('mobile-receive-cell');
          // ÐÐµ Ð¾ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐºÐ°Ð½ÐµÑ€, Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ðº ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ Ð½Ð¾Ð²Ð¾Ð¹ ÑÑ‡ÐµÐ¹ÐºÐ¸
          showAlert(`Ð“Ñ€ÑƒÐ· ${cargoInfo.cargo_number} Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ð¿Ñ€Ð¸Ñ‘Ð¼Ñƒ. ÐžÑ‚ÑÐºÐ°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð½Ð¾Ð²ÑƒÑŽ ÑÑ‡ÐµÐ¹ÐºÑƒ.`, 'success');
        } else {
          setScannerError('Ð“Ñ€ÑƒÐ· Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½');
          showAlert('Ð“Ñ€ÑƒÐ· Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ', 'error');
        }
      } else if (scannerMode === 'mobile-receive-cell') {
        // ÐœÐ¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ð¹ Ð¿Ñ€Ð¸Ñ‘Ð¼ - ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð¹ ÑÑ‡ÐµÐ¹ÐºÐ¸
        const cellData = parseCellQRCode(scannedData);
        if (cellData) {
          setNewCell(cellData);
          setReceiveStep('confirm');
          setPlacementActive(false);
          setScannerActive(false);
          await completeQrCleanup("New Cell Scanned");
          showAlert('ÐÐ¾Ð²Ð°Ñ ÑÑ‡ÐµÐ¹ÐºÐ° Ð¾Ñ‚ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°. ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¸Ñ‘Ð¼ Ð³Ñ€ÑƒÐ·Ð°.', 'success');
        } else {
          setScannerError('ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ QR-ÐºÐ¾Ð´Ð° ÑÑ‡ÐµÐ¹ÐºÐ¸');
          showAlert('ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ QR-ÐºÐ¾Ð´Ð° ÑÑ‡ÐµÐ¹ÐºÐ¸. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÐµÑ‰Ðµ Ñ€Ð°Ð·.', 'error');
        }
      }
    } catch (error) {
      console.error('Barcode scan error:', error);
      setScannerError('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¾Ñ‚ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…');
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¾Ñ‚ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…', 'error');
    }
  };

  const extractCargoNumber = (scannedData) => {
    // Ð˜Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ Ð½Ð¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð° Ð¸Ð· Ð¾Ñ‚ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
    // ÐŸÐ¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÐ¼ Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ñ‹: TEMP-123456, 2501999271, Ð¸ Ñ‚.Ð´.
    const match = scannedData.match(/(?:TEMP-)?(\d+)/);
    return match ? match[0] : scannedData;
  };

  const parseCellQRCode = (qrData) => {
    try {
      // ÐžÐ¶Ð¸Ð´Ð°ÐµÐ¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚: warehouse_id:block_number:shelf_number:cell_number
      // Ð˜Ð»Ð¸ JSON Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚: {"warehouse_id": "WH001", "block_number": 1, "shelf_number": 2, "cell_number": 5}
      
      if (qrData.includes('{')) {
        // JSON Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚
        const parsed = JSON.parse(qrData);
        return {
          warehouse_id: parsed.warehouse_id,
          block_number: parseInt(parsed.block_number),
          shelf_number: parseInt(parsed.shelf_number),
          cell_number: parseInt(parsed.cell_number)
        };
      } else {
        // ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ñ Ñ€Ð°Ð·Ð´ÐµÐ»Ð¸Ñ‚ÐµÐ»ÑÐ¼Ð¸
        const parts = qrData.split(':');
        if (parts.length === 4) {
          return {
            warehouse_id: parts[0],
            block_number: parseInt(parts[1]),
            shelf_number: parseInt(parts[2]),
            cell_number: parseInt(parts[3])
          };
        }
      }
      return null;
    } catch (error) {
      console.error('QR parsing error:', error);
      return null;
    }
  };

  const performAutoPlacement = async () => {
    if (!scannedCargoData || !scannedCellData) {
      showAlert('ÐÐµÐ´Ð¾ÑÑ‚Ð°Ñ‚Ð¾Ñ‡Ð½Ð¾ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°', 'error');
      return;
    }

    setPlacementInProgress(true);
    try {
      await handlePlaceCargo(
        scannedCargoData.id,
        scannedCellData.warehouse_id,
        scannedCellData.block_number,
        scannedCellData.shelf_number,
        scannedCellData.cell_number
      );
      
      showAlert(
        `Ð“Ñ€ÑƒÐ· ${scannedCargoData.cargo_number} ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½ Ð² ÑÑ‡ÐµÐ¹ÐºÐµ ${scannedCellData.block_number}-${scannedCellData.shelf_number}-${scannedCellData.cell_number}!`,
        'success'
      );
      
      // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
      await resetScannerState();
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐºÐ¸
      fetchAvailableCargoForPlacement();
      
    } catch (error) {
      console.error('Auto placement error:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°', 'error');
    } finally {
      setPlacementInProgress(false);
    }
  };

  const resetScannerState = async () => {
    setScannerMode('none');
    setScannerActive(false);
    setScannedCargoData(null);
    setScannedCellData(null);
    setScannerError(null);
    await stopCameraScanner();
  };

  // New functions for warehouse management
  const openWarehouseManagement = async (warehouse) => {
    try {
      setSelectedWarehouseForManagement(warehouse);
      setWarehouseManagementLoading(true);
      setShowWarehouseManagementModal(true);
      
      // Fetch detailed warehouse structure
      const response = await apiCall(`/api/warehouses/${warehouse.id}/structure`);
      setWarehouseStructure(response);
      
    } catch (error) {
      console.error('Error loading warehouse structure:', error);
      showAlert(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ ÑÐºÐ»Ð°Ð´Ð°: ${error.message}`, 'error');
    } finally {
      setWarehouseManagementLoading(false);
    }
  };

  // Generate QR codes for selected cells
  const generateCellQRCodes = async (selectedCells = null) => {
    if (!selectedWarehouseForManagement || !warehouseStructure) return;
    
    setCellQRLoading(true);
    try {
      const cellsToProcess = selectedCells || getAllCells();
      const qrResults = [];
      
      for (const cell of cellsToProcess) {
        try {
          const response = await apiCall('/api/warehouse/cell/generate-qr', 'POST', {
            warehouse_id: selectedWarehouseForManagement.id,
            block: cell.block,
            shelf: cell.shelf,
            cell: cell.cell
          });
          
          if (response && response.success) {
            qrResults.push({
              location: `Ð‘${cell.block}-ÐŸ${cell.shelf}-Ð¯${cell.cell}`,
              qr_code: response.qr_code,
              success: true
            });
          } else {
            qrResults.push({
              location: `Ð‘${cell.block}-ÐŸ${cell.shelf}-Ð¯${cell.cell}`,
              success: false,
              error: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ QR ÐºÐ¾Ð´'
            });
          }
        } catch (error) {
          qrResults.push({
            location: `Ð‘${cell.block}-ÐŸ${cell.shelf}-Ð¯${cell.cell}`,
            success: false,
            error: error.message
          });
        }
      }
      
      setCellQRResults(qrResults);
      showAlert(`Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾ QR ÐºÐ¾Ð´Ð¾Ð² Ð´Ð»Ñ ÑÑ‡ÐµÐµÐº: ${qrResults.filter(r => r.success).length}/${qrResults.length}`, 'success');
      
    } catch (error) {
      console.error('Error generating cell QR codes:', error);
      showAlert(`ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ QR ÐºÐ¾Ð´Ð¾Ð²: ${error.message}`, 'error');
    } finally {
      setCellQRLoading(false);
    }
  };

  // Get all cells from warehouse structure
  const getAllCells = () => {
    if (!warehouseStructure) return [];
    
    const allCells = [];
    for (let block = 1; block <= warehouseStructure.blocks; block++) {
      for (let shelf = 1; shelf <= warehouseStructure.shelves_per_block; shelf++) {
        for (let cell = 1; cell <= warehouseStructure.cells_per_shelf; cell++) {
          allCells.push({ block, shelf, cell });
        }
      }
    }
    return allCells;
  };

  // Add new block to warehouse
  const addWarehouseBlock = async () => {
    try {
      const response = await apiCall(`/api/warehouses/${selectedWarehouseForManagement.id}/add-block`, 'POST');
      
      if (response && response.success) {
        showAlert('Ð‘Ð»Ð¾Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½', 'success');
        // Refresh warehouse structure
        openWarehouseManagement(selectedWarehouseForManagement);
      }
    } catch (error) {
      console.error('Error adding block:', error);
      showAlert(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð±Ð»Ð¾ÐºÐ°: ${error.message}`, 'error');
    }
  };

  // Delete warehouse block
  const deleteWarehouseBlock = async (blockNumber) => {
    try {
      const response = await apiCall(`/api/warehouses/${selectedWarehouseForManagement.id}/delete-block`, 'POST', {
        block_number: blockNumber
      });
      
      if (response && response.success) {
        showAlert('Ð‘Ð»Ð¾Ðº ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½', 'success');
        // Refresh warehouse structure
        openWarehouseManagement(selectedWarehouseForManagement);
      }
    } catch (error) {
      console.error('Error deleting block:', error);
      showAlert(`ÐžÑˆÐ¸Ð±ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð±Ð»Ð¾ÐºÐ°: ${error.message}`, 'error');
    }
  };

  // ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð²ÑÐµÑ… ÐºÐ°Ð¼ÐµÑ€ Ð¿Ñ€Ð¸ Ñ€Ð°Ð·Ð¼Ð¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¸ ÐºÐ¾Ð¼Ð¿Ð¾Ð½ÐµÐ½Ñ‚Ð° - ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð°Ñ Ð²ÐµÑ€ÑÐ¸Ñ
  useEffect(() => {
    return () => {
      // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð¾ÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÑÐºÐ°Ð½ÐµÑ€
      if (html5QrCode) {
        safeStopQrScanner(html5QrCode, "qr-reader", "Main Scanner").catch(console.error);
      }
      
      // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÑÐºÐ°Ð½ÐµÑ€ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ
      if (html5QrCodePlacement) {
        safeStopQrScanner(html5QrCodePlacement, "qr-reader-placement", "Placement Scanner").catch(console.error);
      }
      
      // ÐžÑ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐºÐ°Ð½ÐµÑ€
      if (modalScannerRef.current) {
        safeStopQrScanner(modalScannerRef.current, "qr-reader-modal", "Modal Scanner").catch(console.error);
      }
    };
  }, [html5QrCode, html5QrCodePlacement]);

  const simulateBarcodeScan = (testData) => {
    // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ñ‚ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð±ÐµÐ· Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¹ ÐºÐ°Ð¼ÐµÑ€Ñ‹
    handleBarcodeScan(testData);
  };

  const apiCall = async (endpoint, method = 'GET', data = null, params = null, retryCount = 0) => {
    try {
      // Build URL with query parameters if provided
      let url = `${BACKEND_URL}${endpoint}`;
      if (params) {
        const urlParams = new URLSearchParams(params);
        url += `?${urlParams.toString()}`;
      }

      const config = {
        method,
        headers: {
          'Content-Type': 'application/json',
        },
      };

      if (token) {
        config.headers.Authorization = `Bearer ${token}`;
      }

      if (data) {
        config.body = JSON.stringify(data);
      }

      const response = await fetch(url, config);
      
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐµÑÑ‚ÑŒ Ð»Ð¸ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ Ð´Ð»Ñ Ð¿Ð°Ñ€ÑÐ¸Ð½Ð³Ð°
      const contentType = response.headers.get('content-type');
      let result = {};
      
      if (contentType && contentType.includes('application/json')) {
        const responseText = await response.text();
        if (responseText.trim()) {
          try {
            result = JSON.parse(responseText);
          } catch (jsonError) {
            console.error('JSON parsing error:', jsonError);
            console.error('Response text:', responseText);
            result = { error: 'Invalid JSON response', rawResponse: responseText };
          }
        }
      } else {
        // Ð•ÑÐ»Ð¸ Ð½Ðµ JSON, Ñ‡Ð¸Ñ‚Ð°ÐµÐ¼ ÐºÐ°Ðº Ñ‚ÐµÐºÑÑ‚
        const responseText = await response.text();
        result = { message: responseText || 'Empty response' };
      }

      if (!response.ok) {
        // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° 401 Ð¾ÑˆÐ¸Ð±ÐºÐ¸ (unauthorized) - Ñ‚Ð¾ÐºÐµÐ½ Ð¸ÑÑ‚ÐµÐº Ð¸Ð»Ð¸ Ð½ÐµÐ²Ð°Ð»Ð¸Ð´ÐµÐ½
        if (response.status === 401 && !isLoggingOut && !isLoggingIn) {
          console.log('Received 401 response, will logout after delay to prevent race conditions');
          
          // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÑƒÑŽ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ Ð¿ÐµÑ€ÐµÐ´ logout Ð´Ð»Ñ Ð¿Ñ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰ÐµÐ½Ð¸Ñ race conditions
          setTimeout(() => {
            if (!isLoggingOut && !isLoggingIn) {
              handleLogout();
            }
          }, 1000);
          
          throw new Error('Session expired');
        }
        
        // ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° detail - Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ ÑÑ‚Ñ€Ð¾ÐºÐ¾Ð¹ Ð¸Ð»Ð¸ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼ Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð²
        let errorMessage = 'ÐŸÑ€Ð¾Ð¸Ð·Ð¾ÑˆÐ»Ð° Ð¾ÑˆÐ¸Ð±ÐºÐ°';
        
        if (result.detail) {
          if (Array.isArray(result.detail)) {
            // Ð•ÑÐ»Ð¸ detail - Ð¼Ð°ÑÑÐ¸Ð² Ð¾Ð±ÑŠÐµÐºÑ‚Ð¾Ð² Ð¾ÑˆÐ¸Ð±Ð¾Ðº Ð²Ð°Ð»Ð¸Ð´Ð°Ñ†Ð¸Ð¸, Ð¸Ð·Ð²Ð»ÐµÐºÐ°ÐµÐ¼ msg Ð¸Ð· ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾
            errorMessage = result.detail.map(err => err.msg || err.message || JSON.stringify(err)).join(', ');
          } else if (typeof result.detail === 'string') {
            // Ð•ÑÐ»Ð¸ detail - ÑÑ‚Ñ€Ð¾ÐºÐ°, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÐºÐ°Ðº ÐµÑÑ‚ÑŒ
            errorMessage = result.detail;
          } else {
            // Ð•ÑÐ»Ð¸ detail - Ð¾Ð±ÑŠÐµÐºÑ‚, Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð°ÐµÐ¼ÑÑ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ message Ð¸Ð»Ð¸ Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·ÑƒÐµÐ¼ Ð² ÑÑ‚Ñ€Ð¾ÐºÑƒ
            errorMessage = result.detail.message || JSON.stringify(result.detail);
          }
        } else if (result.message) {
          errorMessage = result.message;
        }
        
        throw new Error(errorMessage);
      }

      return result;
    } catch (error) {
      // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ alert Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ ÑÑ‚Ð¾ Ð½Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¸ÑÑ‚ÐµÑ‡ÐµÐ½Ð¸Ñ ÑÐµÑÑÐ¸Ð¸
      if (error.message !== 'Session expired') {
        showAlert(error.message, 'error');
      }
      throw error;
    }
  };

  // ÐÐ¾Ð²Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ð³Ð¾ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð° (Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ 1)
  const fetchClientDashboard = async () => {
    try {
      const data = await apiCall('/api/client/dashboard');
      setClientDashboard(data);
    } catch (error) {
      console.error('Error fetching client dashboard:', error);
    }
  };

  const fetchClientCargo = async (status = null) => {
    try {
      const params = status ? `?status=${status}` : '';
      const data = await apiCall(`/api/client/cargo${params}`);
      setClientCargo(data.cargo || []);
    } catch (error) {
      console.error('Error fetching client cargo:', error);
    }
  };

  const fetchClientCargoDetails = async (cargoId) => {
    try {
      const data = await apiCall(`/api/client/cargo/${cargoId}/details`);
      setClientCargoDetails(data);
    } catch (error) {
      console.error('Error fetching client cargo details:', error);
    }
  };

  // ÐÐ¾Ð²Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² (Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ 2)
  const fetchAllOperators = async () => {
    try {
      const data = await apiCall('/api/admin/operators');
      setAllOperators(data.operators || []);
    } catch (error) {
      console.error('Error fetching operators:', error);
    }
  };

  const handleCreateOperator = async (e) => {
    e.preventDefault();
    try {
      await apiCall('/api/admin/create-operator', 'POST', operatorCreateForm);
      
      // Ð¡Ð±Ñ€Ð¾Ñ Ñ„Ð¾Ñ€Ð¼Ñ‹
      setOperatorCreateForm({
        full_name: '',
        phone: '',
        address: '',
        password: '',
        warehouse_id: ''
      });
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ…
      fetchAllOperators();
      fetchOperatorWarehouseBindings();
      fetchUsersByRole();
      
      // ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾Ð± ÑƒÑÐ¿ÐµÑ…Ðµ
      alert('ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½!');
      
    } catch (error) {
      console.error('Error creating operator:', error);
      alert(error.message || 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°');
    }
  };

  // ÐÐ¾Ð²Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°
  const fetchDeliveryOptions = async () => {
    try {
      const data = await apiCall('/api/client/cargo/delivery-options');
      setDeliveryOptions(data);
    } catch (error) {
      console.error('Error fetching delivery options:', error);
    }
  };

  const calculateCargoCost = async () => {
    if (!cargoOrderForm.weight || !cargoOrderForm.declared_value || !cargoOrderForm.cargo_name) {
      return;
    }

    setIsCalculating(true);
    try {
      // ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð°
      const calculationData = {
        ...cargoOrderForm,
        weight: parseFloat(cargoOrderForm.weight),
        declared_value: parseFloat(cargoOrderForm.declared_value),
        insurance_value: cargoOrderForm.insurance_requested ? parseFloat(cargoOrderForm.insurance_value || cargoOrderForm.declared_value) : null
      };

      const data = await apiCall('/api/client/cargo/calculate', 'POST', calculationData);
      setCostCalculation(data);
    } catch (error) {
      console.error('Error calculating cost:', error);
      alert('ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸: ' + (error.message || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°'));
    } finally {
      setIsCalculating(false);
    }
  };

  const handleCreateCargoOrder = async (e) => {
    e.preventDefault();
    
    if (!costCalculation) {
      showAlert('Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ñ€Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ð¹Ñ‚Ðµ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸', 'error');
      return;
    }

    try {
      // ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°
      const orderData = {
        ...cargoOrderForm,
        weight: parseFloat(cargoOrderForm.weight),
        declared_value: parseFloat(cargoOrderForm.declared_value),
        insurance_value: cargoOrderForm.insurance_requested ? parseFloat(cargoOrderForm.insurance_value || cargoOrderForm.declared_value) : null
      };

      const result = await apiCall('/api/client/cargo/create', 'POST', orderData);
      setCargoOrderResult(result);
      
      // Ð¡Ð±Ñ€Ð¾Ñ Ñ„Ð¾Ñ€Ð¼Ñ‹
      setCargoOrderForm({
        cargo_name: '',
        description: '',
        weight: '',
        declared_value: getDefaultDeclaredValue('moscow_dushanbe'), // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
        recipient_full_name: '',
        recipient_phone: '',
        recipient_address: '',
        recipient_city: '',
        route: 'moscow_dushanbe',
        delivery_type: 'standard',
        insurance_requested: false,
        insurance_value: '',
        packaging_service: false,
        home_pickup: false,
        home_delivery: false,
        fragile: false,
        temperature_sensitive: false,
        special_instructions: ''
      });
      setCostCalculation(null);
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
      fetchClientDashboard();
      fetchClientCargo();
      
      // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
      showAlert(`Ð“Ñ€ÑƒÐ· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½! ÐÐ¾Ð¼ÐµÑ€: ${result.cargo_number}, Ð¢Ñ€ÐµÐºÐ¸Ð½Ð³: ${result.tracking_code}`, 'success');
      
    } catch (error) {
      console.error('Error creating cargo order:', error);
      
      // ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
      let errorMessage = 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ð¸ Ð³Ñ€ÑƒÐ·Ð°';
      
      if (error.message) {
        errorMessage = error.message;
      } else if (typeof error === 'string') {
        errorMessage = error;
      } else if (error.detail) {
        errorMessage = error.detail;
      }
      
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°: ' + errorMessage, 'error');
    }
  };

  useEffect(() => {
    if (token && !isLoggingOut && !isLoggingIn) {
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð²Ð°Ð»Ð¸Ð´Ð½Ð¾ÑÑ‚ÑŒ Ñ‚Ð¾ÐºÐµÐ½Ð° Ð¿ÐµÑ€ÐµÐ´ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸ÐµÐ¼
      if (isTokenValid(token)) {
        // ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐµÑÐ»Ð¸ Ñƒ Ð½Ð°Ñ Ð½ÐµÑ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
        if (!user) {
          // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÑƒÑŽ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ race condition
          setTimeout(() => {
            if (token && !isLoggingIn && !user) {
              fetchUserData();
            }
          }, 500);
        }
      } else {
        // Ð¢Ð¾ÐºÐµÐ½ Ð¸ÑÑ‚ÐµÐº, Ð¾Ñ‡Ð¸Ñ‰Ð°ÐµÐ¼ ÐµÐ³Ð¾
        console.log('Token expired on startup, clearing session');
        handleLogout();
        showAlert('Ð’Ð°ÑˆÐ° ÑÐµÑÑÐ¸Ñ Ð¸ÑÑ‚ÐµÐºÐ»Ð°. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ð¾Ð¹Ð´Ð¸Ñ‚Ðµ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ ÑÐ½Ð¾Ð²Ð°.', 'warning');
      }
    }
  }, [token]); // Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ user Ð¸Ð· Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹ Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¸Ð·Ð±ÐµÐ¶Ð°Ñ‚ÑŒ Ñ†Ð¸ÐºÐ»Ð°

  // ÐŸÐµÑ€Ð¸Ð¾Ð´Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð²Ð°Ð»Ð¸Ð´Ð½Ð¾ÑÑ‚Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ð°
  useEffect(() => {
    let interval;
    if (token && user && !isLoggingOut && !isLoggingIn) {
      interval = setInterval(() => {
        if (!isTokenValid(token)) {
          console.log('Token expired during session, logging out');
          handleLogout();
        }
      }, 60000); // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÐºÐ°Ð¶Ð´ÑƒÑŽ Ð¼Ð¸Ð½ÑƒÑ‚Ñƒ
    }

    return () => {
      if (interval) {
        clearInterval(interval);
      }
    };
  }, [token, user, isLoggingOut, isLoggingIn]);

  // ÐÐžÐ’Ð«Ð™ USEEFFECT: ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð²Ñ‹Ð±Ð¾Ñ€ ÑÐºÐ»Ð°Ð´Ð° ÐµÑÐ»Ð¸ Ð¾Ð½ Ð¾Ð´Ð¸Ð½ Ñƒ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°
  useEffect(() => {
    if (operatorWarehouses.length === 1 && user?.role === 'warehouse_operator') {
      setOperatorCargoForm(prev => ({
        ...prev,
        warehouse_id: operatorWarehouses[0].id
      }));
    }
  }, [operatorWarehouses, user]);

  // ÐÐžÐ’Ð«Ð™ USEEFFECT: Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÐºÐ»Ð°Ð´Ð¾Ð² Ð¿Ð¾ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñƒ
  useEffect(() => {
    const loadRouteWarehouses = async () => {
      if (operatorCargoForm.route && user) {
        const warehouses = await fetchWarehousesByRoute(operatorCargoForm.route);
        setRouteWarehouses(warehouses);
        
        // Ð¡Ð±Ñ€Ð¾Ñ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð³Ð¾ ÑÐºÐ»Ð°Ð´Ð° Ð¿Ñ€Ð¸ ÑÐ¼ÐµÐ½Ðµ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð°
        if (operatorCargoForm.warehouse_id && !warehouses.find(w => w.id === operatorCargoForm.warehouse_id)) {
          setOperatorCargoForm(prev => ({
            ...prev,
            warehouse_id: ''
          }));
        }
      }
    };
    
    loadRouteWarehouses();
  }, [operatorCargoForm.route, user]);

  // ÐÐžÐ’Ð«Ð™ USEEFFECT: Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÑ…ÐµÐ¼Ñ‹ ÑÐºÐ»Ð°Ð´Ð° Ð¿Ñ€Ð¸ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸ Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÐ½Ð°
  useEffect(() => {
    const loadWarehouseScheme = async () => {
      if (showWarehouseScheme) {
        setWarehouseSchemeLoading(true);
        try {
          // Ð”Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¾Ð±Ñ‰Ð¸Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº warehouses, Ð´Ð»Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° - operatorWarehouses
          const warehousesList = user?.role === 'admin' ? warehouses : operatorWarehouses;
          const warehouse = warehousesList.find(w => w.id === showWarehouseScheme);
          
          if (warehouse && typeof warehouse === 'object') {
            console.log('Loading scheme for warehouse:', warehouse.name, warehouse);
            const scheme = await generateWarehouseScheme(warehouse);
            setWarehouseSchemeData(scheme || []);
          } else {
            console.warn('Warehouse not found for scheme:', showWarehouseScheme);
            setWarehouseSchemeData([]);
          }
        } catch (error) {
          console.error('Error loading warehouse scheme:', error);
          showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÑ…ÐµÐ¼Ñ‹ ÑÐºÐ»Ð°Ð´Ð°', 'error');
          setWarehouseSchemeData([]);
        } finally {
          setWarehouseSchemeLoading(false);
        }
      } else {
        setWarehouseSchemeData([]);
      }
    };

    loadWarehouseScheme();
  }, [showWarehouseScheme, operatorWarehouses, warehouses, user]);

  useEffect(() => {
    if (user) {
      fetchNotifications();
      if (user.role === 'admin') {
        fetchUsers();
        fetchAllCargo();
        fetchWarehouses();
        fetchOperatorCargo();
        fetchUsersByRole();
        fetchUnpaidCargo();
        fetchPaymentHistory();
        fetchCargoRequests();
        fetchTransports();
        fetchOperatorWarehouseBindings();
        fetchAllOperators(); // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ 2 - Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð°
        fetchNewOrdersCount(); // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ð½Ð¾Ð²Ñ‹Ñ… Ð·Ð°ÐºÐ°Ð·Ð¾Ð²
        fetchPlacedCargo(); // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð°
        fetchDebtorsList(); // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÐ¿Ð¸ÑÐºÐ° Ð·Ð°Ð´Ð¾Ð»Ð¶Ð½Ð¸ÐºÐ¾Ð²
        fetchAdminDashboardAnalytics(); // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ð¾Ð¹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð°
      } else if (user.role === 'warehouse_operator') {
        fetchWarehouseCargo();
        fetchWarehouses();
        fetchOperatorCargo('', 1, 25);
        fetchAvailableCargoForPlacement(1, 25); // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ
        fetchPlacedCargo(1, 25); // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÑƒ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð²
        fetchUnpaidCargo();
        fetchPaymentHistory();
        fetchCargoRequests();
        fetchTransportsList(); // ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¾ Ð´Ð»Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²
        fetchArrivedTransports();
        fetchOperatorWarehouses(); // Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¾ Ð´Ð»Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²
        fetchNewOrdersCount(); // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð° Ð½Ð¾Ð²Ñ‹Ñ… Ð·Ð°ÐºÐ°Ð·Ð¾Ð² Ð´Ð»Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²
        fetchOperatorDashboardAnalytics(); // Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°
      } else {
        fetchMyCargo();
        fetchMyRequests();
        fetchNotifications(); // ÐÐ¾Ð²Ð°Ñ ÑÐ¸ÑÑ‚ÐµÐ¼Ð° ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹
        // ÐÐ¾Ð²Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ ÐºÐ»Ð¸ÐµÐ½Ñ‚ÑÐºÐ¾Ð³Ð¾ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð° (Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ 1)
        fetchClientDashboard();
        fetchClientCargo();
        // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¾Ð¿Ñ†Ð¸Ð¸ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ Ð´Ð»Ñ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð¾Ð²
        fetchDeliveryOptions();
      }
    }
  }, [user]);

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð»Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ ÐºÐ°Ð±Ð¸Ð½ÐµÑ‚Ð°
  const fetchPersonalDashboard = async () => {
    setDashboardLoading(true);
    try {
      const response = await apiCall('/api/user/dashboard', 'GET');
      setPersonalDashboardData(response);
    } catch (error) {
      console.error('Error fetching personal dashboard:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð»Ð¸Ñ‡Ð½Ð¾Ð³Ð¾ ÐºÐ°Ð±Ð¸Ð½ÐµÑ‚Ð°', 'error');
    } finally {
      setDashboardLoading(false);
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð°Ð´Ð¼Ð¸Ð½ÑÐºÐ¾Ð³Ð¾ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð°
  const fetchAdminDashboardAnalytics = async () => {
    if (user?.role !== 'admin') return;
    
    setAdminAnalyticsLoading(true);
    try {
      const response = await apiCall('/api/admin/dashboard/analytics', 'GET');
      setAdminDashboardAnalytics(response);
    } catch (error) {
      console.error('Error fetching admin dashboard analytics:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð°', 'error');
    } finally {
      setAdminAnalyticsLoading(false);
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´Ð° Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°
  const fetchOperatorDashboardAnalytics = async () => {
    if (!user || user.role !== 'warehouse_operator') return;
    
    setOperatorAnalyticsLoading(true);
    try {
      const response = await apiCall('/api/operator/dashboard/analytics');
      setOperatorDashboardAnalytics(response);
    } catch (error) {
      console.error('Error fetching operator dashboard analytics:', error);
      showAlert(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸: ${error.message}`, 'error');
    } finally {
      setOperatorAnalyticsLoading(false);
    }
  };

  // QR Codes and Invoice functions - simplified version for now
  const generateBatchQRCodes = async (numbers) => {
    try {
      const response = await apiCall(`/api/cargo/batch/${encodeURIComponent(numbers)}/qr-codes`);
      return response;
    } catch (error) {
      console.error('Error generating QR codes:', error);
      throw error;
    }
  };

  const generateCargoInvoice = async (numbers) => {
    try {
      const response = await apiCall(`/api/cargo/invoice/${encodeURIComponent(numbers)}`);
      return response;
    } catch (error) {
      console.error('Error generating invoice:', error);
      throw error;
    }
  };

  // Generate QR code for application number
  const generateApplicationQR = async (cargoNumber) => {
    if (!cargoNumber.trim()) {
      showAlert('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ð·Ð°ÑÐ²ÐºÐ¸', 'error');
      return;
    }

    setApplicationQRLoading(true);
    try {
      const response = await apiCall(`/api/cargo/generate-application-qr/${encodeURIComponent(cargoNumber)}`);
      setApplicationQRCode(response);
      setShowApplicationQRModal(true);
      showAlert('QR ÐºÐ¾Ð´ Ð·Ð°ÑÐ²ÐºÐ¸ ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!', 'success');
    } catch (error) {
      console.error('Error generating application QR:', error);
      showAlert(`ÐžÑˆÐ¸Ð±ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ QR ÐºÐ¾Ð´Ð°: ${error.message}`, 'error');
    } finally {
      setApplicationQRLoading(false);
    }
  };

  // New function: Generate QR by cargo number with validation
  const generateQRByCargoNumber = async () => {
    if (!qrGenerateCargoNumber.trim()) {
      showAlert('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°', 'error');
      return;
    }

    setQrGenerateLoading(true);
    try {
      // First, check if cargo exists by trying to scan it
      const checkResponse = await apiCall('/api/qr/scan', 'POST', {
        qr_text: qrGenerateCargoNumber.trim()
      });
      
      if (!checkResponse || checkResponse.type !== 'cargo') {
        showAlert(`Ð“Ñ€ÑƒÐ· Ñ Ð½Ð¾Ð¼ÐµÑ€Ð¾Ð¼ "${qrGenerateCargoNumber}" Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ`, 'error');
        return;
      }
      
      // If cargo exists, generate QR code
      const response = await apiCall('/api/cargo/generate-qr-by-number', 'POST', {
        cargo_number: qrGenerateCargoNumber.trim()
      });
      
      if (response && response.success) {
        setGeneratedSingleQR(response);
        showAlert(`QR ÐºÐ¾Ð´ ÑÐ¾Ð·Ð´Ð°Ð½ Ð´Ð»Ñ Ð³Ñ€ÑƒÐ·Ð° ${response.cargo_number}`, 'success');
      }
    } catch (error) {
      console.error('Error generating QR by number:', error);
      
      // Check if error is about cargo not found
      if (error.message && (
          error.message.includes('not found') || 
          error.message.includes('Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½') || 
          error.message.includes('404')
        )) {
        showAlert(`Ð“Ñ€ÑƒÐ· Ñ Ð½Ð¾Ð¼ÐµÑ€Ð¾Ð¼ "${qrGenerateCargoNumber}" Ð½Ðµ ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ`, 'error');
      } else {
        showAlert(`ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ QR ÐºÐ¾Ð´Ð°: ${error.message}`, 'error');
      }
    } finally {
      setQrGenerateLoading(false);
    }
  };

  // New function: Generate QR codes for all cargo from same sender
  const generateBulkQRForSender = async (senderData) => {
    try {
      setBulkQRModal(true);
      setSelectedSender(senderData);
      setBulkQRLoading(true);
      
      // Find all cargo for this sender
      const senderCargoList = operatorCargo.filter(cargo => 
        cargo.sender_phone === senderData.sender_phone || 
        cargo.sender_full_name === senderData.sender_full_name
      );
      
      setSenderCargos(senderCargoList);
      
      // Generate QR codes for each cargo
      const qrResults = [];
      for (const cargo of senderCargoList) {
        try {
          const response = await apiCall('/api/cargo/generate-qr-by-number', 'POST', {
            cargo_number: cargo.cargo_number
          });
          
          if (response && response.success) {
            qrResults.push({
              cargo_number: cargo.cargo_number,
              cargo_name: cargo.cargo_name,
              qr_code: response.qr_code,
              success: true
            });
          } else {
            qrResults.push({
              cargo_number: cargo.cargo_number,
              cargo_name: cargo.cargo_name,
              success: false,
              error: 'ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ ÑÐ¾Ð·Ð´Ð°Ñ‚ÑŒ QR ÐºÐ¾Ð´'
            });
          }
        } catch (error) {
          qrResults.push({
            cargo_number: cargo.cargo_number,
            cargo_name: cargo.cargo_name,
            success: false,
            error: error.message
          });
        }
      }
      
      setBulkQRResults(qrResults);
      showAlert(`Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾ QR ÐºÐ¾Ð´Ð¾Ð²: ${qrResults.filter(r => r.success).length}/${qrResults.length}`, 'success');
      
    } catch (error) {
      console.error('Error generating bulk QR codes:', error);
      showAlert(`ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ QR ÐºÐ¾Ð´Ð¾Ð²: ${error.message}`, 'error');
    } finally {
      setBulkQRLoading(false);
    }
  };

  // New function: Place cargo in cell
  const placeCargoInCell = async (cargoNumber, cellCode) => {
    try {
      const response = await apiCall('/api/cargo/place-in-cell', 'POST', {
        cargo_number: cargoNumber,
        cell_code: cellCode
      });
      
      if (response && response.success) {
        showAlert(`Ð“Ñ€ÑƒÐ· ${cargoNumber} ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½ Ð² ÑÑ‡ÐµÐ¹ÐºÐµ`, 'success');
        await fetchPlacementStatistics(); // Update statistics
        return true;
      }
    } catch (error) {
      console.error('Error placing cargo in cell:', error);
      showAlert(`ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°: ${error.message}`, 'error');
      return false;
    }
  };

  // New function: Get placement statistics
  const fetchPlacementStatistics = async () => {
    try {
      const response = await apiCall('/api/operator/placement-statistics');
      setPlacementStatistics(response);
    } catch (error) {
      console.error('Error fetching placement statistics:', error);
    }
  };

  // Enhanced camera availability check for mobile devices
  const checkCameraAvailability = async () => {
    try {
      console.log('ðŸ” Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ð¼ÐµÑ€Ñ‹ Ð´Ð»Ñ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²...');
      
      // Check basic support
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        console.log('âŒ MediaDevices API Ð½Ðµ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶Ð¸Ð²Ð°ÐµÑ‚ÑÑ');
        return false;
      }
      
      // Mobile-specific camera constraints with multiple fallbacks
      const mobileConstraints = [
        // Primary: Back camera with high quality
        {
          video: {
            facingMode: { exact: "environment" },
            width: { ideal: 1920, max: 1920, min: 640 },
            height: { ideal: 1080, max: 1080, min: 480 },
            frameRate: { ideal: 30, min: 15 }
          }
        },
        // Fallback 1: Back camera with relaxed constraints
        {
          video: {
            facingMode: "environment",
            width: { ideal: 1280, min: 640 },
            height: { ideal: 720, min: 480 }
          }
        },
        // Fallback 2: Any camera with basic constraints
        {
          video: {
            width: { ideal: 1280, min: 640 },
            height: { ideal: 720, min: 480 }
          }
        },
        // Fallback 3: Minimal constraints
        {
          video: true
        }
      ];
      
      console.log('ðŸ” Ð¢ÐµÑÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ°Ð¼ÐµÑ€Ñ‹ Ñ Ñ€Ð°Ð·Ð»Ð¸Ñ‡Ð½Ñ‹Ð¼Ð¸ constraints...');
      
      let stream = null;
      let constraintsUsed = null;
      
      // Try each constraint set until one works
      for (let i = 0; i < mobileConstraints.length; i++) {
        try {
          console.log(`ðŸ”„ ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° ${i + 1}/${mobileConstraints.length}...`);
          
          stream = await Promise.race([
            navigator.mediaDevices.getUserMedia(mobileConstraints[i]),
            new Promise((_, reject) => 
              setTimeout(() => reject(new Error('Timeout')), 15000) // 15 second timeout for mobile
            )
          ]);
          
          constraintsUsed = mobileConstraints[i];
          console.log(`âœ… Ð£ÑÐ¿ÐµÑ… Ñ constraints ${i + 1}`);
          break;
          
        } catch (error) {
          console.log(`âŒ ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° ${i + 1} Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ð°: ${error.name} - ${error.message}`);
          if (i === mobileConstraints.length - 1) {
            throw error; // Last attempt failed
          }
        }
      }
      
      if (!stream) {
        throw new Error('Ð’ÑÐµ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½ÐµÑƒÐ´Ð°Ñ‡Ð½Ñ‹');
      }
      
      // Get detailed camera info
      const videoTrack = stream.getVideoTracks()[0];
      if (videoTrack) {
        const capabilities = videoTrack.getCapabilities?.() || {};
        const settings = videoTrack.getSettings();
        console.log('ðŸ“¹ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÐºÐ°Ð¼ÐµÑ€Ðµ:', {
          label: videoTrack.label,
          facingMode: settings.facingMode || 'unknown',
          width: settings.width,
          height: settings.height,
          frameRate: settings.frameRate,
          capabilities: Object.keys(capabilities)
        });
      }
      
      // Stop test stream
      stream.getTracks().forEach(track => {
        track.stop();
        console.log('â¹ï¸ Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ð¹ Ð¿Ð¾Ñ‚Ð¾Ðº Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½');
      });
      
      // Additional mobile stability wait
      await new Promise(resolve => setTimeout(resolve, 1500));
      
      // Verify Html5Qrcode can detect cameras
      try {
        console.log('ðŸŽ¥ ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Html5Qrcode ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸...');
        const cameras = await Html5Qrcode.getCameras();
        console.log(`ðŸ“± Html5Qrcode Ð½Ð°ÑˆÐµÐ» ÐºÐ°Ð¼ÐµÑ€: ${cameras.length}`);
        
        if (cameras.length === 0) {
          console.log('âš ï¸ Html5Qrcode Ð½Ðµ Ð½Ð°ÑˆÐµÐ» ÐºÐ°Ð¼ÐµÑ€Ñ‹, Ð½Ð¾ getUserMedia Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚');
          return false;
        }
        
        cameras.forEach((camera, index) => {
          console.log(`  ðŸ“· ÐšÐ°Ð¼ÐµÑ€Ð° ${index + 1}: "${camera.label || 'Ð‘ÐµÐ· Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ'}" (${camera.id})`);
        });
        
        return true;
        
      } catch (qrError) {
        console.error('âŒ Html5Qrcode Ð¾ÑˆÐ¸Ð±ÐºÐ°:', qrError);
        return false;
      }
      
    } catch (error) {
      console.error('ðŸ’¥ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ ÐºÐ°Ð¼ÐµÑ€Ñ‹:', error.name, error.message);
      
      // Enhanced mobile error handling with user instructions
      if (error.name === 'NotAllowedError') {
        console.log('ðŸš« Ð˜ÐÐ¡Ð¢Ð Ð£ÐšÐ¦Ð˜Ð¯: Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ÐºÐ°Ð¼ÐµÑ€Ðµ');
        showAlert('ðŸ“± Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ÐºÐ°Ð¼ÐµÑ€Ðµ Ð² Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ðµ:\n1. ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ Ð½Ð° Ð¸ÐºÐ¾Ð½ÐºÑƒ Ð·Ð°Ð¼ÐºÐ°/ÐºÐ°Ð¼ÐµÑ€Ñ‹ Ð² Ð°Ð´Ñ€ÐµÑÐ½Ð¾Ð¹ ÑÑ‚Ñ€Ð¾ÐºÐµ\n2. Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ "Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ" Ð´Ð»Ñ ÐºÐ°Ð¼ÐµÑ€Ñ‹\n3. ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ', 'warning');
      } else if (error.name === 'NotFoundError') {
        console.log('ðŸ“µ ÐšÐ°Ð¼ÐµÑ€Ð° Ð½Ðµ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ð° Ð½Ð° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ');
        showAlert('ðŸ“µ ÐšÐ°Ð¼ÐµÑ€Ð° Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ:\n1. ÐšÐ°Ð¼ÐµÑ€Ð° Ð½Ðµ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ Ð´Ñ€ÑƒÐ³Ð¸Ð¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÐµÐ¼\n2. Ð¤Ð¸Ð·Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ Ðº ÐºÐ°Ð¼ÐµÑ€Ðµ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚\n3. ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚Ðµ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€', 'info');
      } else if (error.name === 'NotReadableError') {
        console.log('ðŸ”’ ÐšÐ°Ð¼ÐµÑ€Ð° Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð° ÑÐ¸ÑÑ‚ÐµÐ¼Ð¾Ð¹ Ð¸Ð»Ð¸ Ð´Ñ€ÑƒÐ³Ð¸Ð¼ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸ÐµÐ¼');
        showAlert('ðŸ”’ ÐšÐ°Ð¼ÐµÑ€Ð° Ð·Ð°Ð½ÑÑ‚Ð°. Ð—Ð°ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ ÐºÐ°Ð¼ÐµÑ€Ñ‹ Ð¸ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.', 'warning');
      } else if (error.message === 'Timeout') {
        console.log('â±ï¸ ÐŸÑ€ÐµÐ²Ñ‹ÑˆÐµÐ½ timeout Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ ÐºÐ°Ð¼ÐµÑ€Ñ‹');
        showAlert('â±ï¸ ÐšÐ°Ð¼ÐµÑ€Ð° ÑÐ»Ð¸ÑˆÐºÐ¾Ð¼ Ð´Ð¾Ð»Ð³Ð¾ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ÑÑ. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ:\n1. ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ\n2. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÑŒ Ð´Ñ€ÑƒÐ³Ð¾Ð¹ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€\n3. ÐŸÐµÑ€ÐµÐ·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð¾', 'info');
      }
      
      return false;
    }
  };

  // Open cargo placement page
  const openCargoPlacementPage = () => {
    console.log('ðŸš€ ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°...');
    setCurrentPage('cargo-placement');
    
    // Reset placement state when opening page
    setPlacementActive(false);
    setPlacementStep('idle');
    setScannerActive(false);
    setManualCargoNumber('');
    setManualCellCode('');
    
    // Initialize placement page with longer delay for React rendering completion
    setTimeout(async () => {
      await startCargoPlacement();
    }, 1500);
  };

  // Close cargo placement page
  const closeCargoPlacementPage = () => {
    console.log('ðŸ”™ Ð—Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñ‹ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°...');
    
    // Stop any active scanners
    if (html5QrCodePlacement) {
      safeStopQrScanner(html5QrCodePlacement, "qr-reader-placement", "Page Close");
      setHtml5QrCodePlacement(null);
    }
    
    // Reset all placement states
    setPlacementActive(false);
    setPlacementStep('idle');
    setScannerActive(false);
    setShowCargoPlacementModal(false);
    
    // Return to main page
    setCurrentPage('main');
  };  
  const startCargoPlacement = async () => {
    try {
      console.log('ðŸš€ Ð—Ð°Ð¿ÑƒÑÐº Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°...');
      
      setPlacementActive(true);
      setPlacementStep('scan-cargo');
      
      // First fetch statistics and available cells
      await fetchPlacementStatistics();
      await getAvailableWarehouseCells();
      
      // Show loading indicator for mobile users
      showAlert('â³ Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÐºÐ°Ð¼ÐµÑ€Ñ‹...', 'info');
      
      // Check camera availability with enhanced mobile support
      console.log('ðŸ“± ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ð¼ÐµÑ€Ñ‹ Ð´Ð»Ñ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ð°...');
      const cameraAvailable = await checkCameraAvailability();
      
      if (cameraAvailable) {
        // Camera is available, proceed with QR scanner
        console.log('âœ… ÐšÐ°Ð¼ÐµÑ€Ð° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°, Ð·Ð°Ð¿ÑƒÑÐº ÑÐºÐ°Ð½ÐµÑ€Ð°...');
        showAlert('ðŸ“¹ ÐšÐ°Ð¼ÐµÑ€Ð° Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°! ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð° QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð°.', 'success');
        
        // Extended wait for modal to fully render on mobile
        console.log('â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ°...');
        await new Promise(resolve => setTimeout(resolve, 1500));
        
        // Then start QR scanner with retry mechanism
        let scannerStarted = false;
        let attempts = 0;
        const maxAttempts = 3;
        
        while (!scannerStarted && attempts < maxAttempts) {
          try {
            attempts++;
            console.log(`ðŸ”„ ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐºÐ°Ð½ÐµÑ€Ð° ${attempts}/${maxAttempts}...`);
            await startQRScannerForPlacement();
            scannerStarted = true;
            console.log('âœ… Ð¡ÐºÐ°Ð½ÐµÑ€ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½');
          } catch (error) {
            console.warn(`âš ï¸ ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° ${attempts} Ð½Ðµ ÑƒÐ´Ð°Ð»Ð°ÑÑŒ:`, error.message);
            if (attempts < maxAttempts) {
              console.log('â³ ÐžÐ¶Ð¸Ð´Ð°Ð½Ð¸Ðµ Ð¿ÐµÑ€ÐµÐ´ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÐµÐ¹ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ¾Ð¹...');
              await new Promise(resolve => setTimeout(resolve, 1000));
            }
          }
        }
        
        if (!scannerStarted) {
          console.error('âŒ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÑÐºÐ°Ð½ÐµÑ€ Ð¿Ð¾ÑÐ»Ðµ Ð²ÑÐµÑ… Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº');
          throw new Error('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð¿Ð¾ÑÐ»Ðµ Ð½ÐµÑÐºÐ¾Ð»ÑŒÐºÐ¸Ñ… Ð¿Ð¾Ð¿Ñ‹Ñ‚Ð¾Ðº');
        }
        
      } else {
        // Camera not available, show manual input mode
        console.log('ðŸ“ ÐšÐ°Ð¼ÐµÑ€Ð° Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°, Ð¿ÐµÑ€ÐµÑ…Ð¾Ð´ Ðº Ñ€ÑƒÑ‡Ð½Ð¾Ð¼Ñƒ Ñ€ÐµÐ¶Ð¸Ð¼Ñƒ');
        showAlert('ðŸ“ ÐšÐ°Ð¼ÐµÑ€Ð° Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð²Ð²Ð¾Ð´ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ð¸Ð¶Ðµ.', 'warning');
        setScannerActive(false); // Ensure scanner is marked as inactive
      }
      
    } catch (error) {
      console.error('ðŸ’¥ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°:', error);
      showAlert(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ°: ${error.message}. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð²Ð²Ð¾Ð´.`, 'error');
      // Don't reset placement active - allow manual input to work
      setScannerActive(false);
    }
  };

  // Completely isolated QR Scanner to prevent React removeChild conflicts
  const startQRScannerForPlacement = async () => {
    try {
      console.log('ðŸ”§ Ð—Ð°Ð¿ÑƒÑÐº Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ QR ÑÐºÐ°Ð½ÐµÑ€Ð° Ð´Ð»Ñ Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ñ… ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²...');
      
      // Prevent multiple simultaneous initializations
      if (isInitializingRef.current) {
        console.log('âš ï¸ Ð¡ÐºÐ°Ð½ÐµÑ€ ÑƒÐ¶Ðµ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÑ‚ÑÑ, Ð¿Ñ€Ð¾Ð¿ÑƒÑÐº...');
        return;
      }
      
      isInitializingRef.current = true;
      
      // Complete cleanup first using isolated method
      await completeQrCleanup("Isolated Scanner Start");
      
      // Create isolated container to avoid React conflicts
      const isolatedElementId = createIsolatedQrContainer();
      
      // Wait for isolated container to be ready
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      // Verify isolated element exists
      const isolatedElement = document.getElementById(isolatedElementId);
      if (!isolatedElement) {
        throw new Error('Ð˜Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½');
      }
      
      console.log('âœ… Ð˜Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ð³Ð¾Ñ‚Ð¾Ð² Ð´Ð»Ñ QR ÑÐºÐ°Ð½ÐµÑ€Ð°');

      // Get cameras with enhanced retry
      let cameras = [];
      let cameraAttempts = 0;
      const maxCameraAttempts = 3;
      
      while (cameras.length === 0 && cameraAttempts < maxCameraAttempts) {
        try {
          cameraAttempts++;
          console.log(`ðŸŽ¥ ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÐºÐ°Ð¼ÐµÑ€ (Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° ${cameraAttempts}/${maxCameraAttempts})...`);
          cameras = await Html5Qrcode.getCameras();
          
          if (cameras.length === 0 && cameraAttempts < maxCameraAttempts) {
            await new Promise(resolve => setTimeout(resolve, 1500));
          }
        } catch (error) {
          console.error(`âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÐºÐ°Ð¼ÐµÑ€ (Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° ${cameraAttempts}):`, error);
          if (cameraAttempts < maxCameraAttempts) {
            await new Promise(resolve => setTimeout(resolve, 1500));
          }
        }
      }
      
      if (!cameras || cameras.length === 0) {
        throw new Error('ÐšÐ°Ð¼ÐµÑ€Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹ Ð´Ð»Ñ Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ ÑÐºÐ°Ð½ÐµÑ€Ð°');
      }

      console.log(`ðŸ“¹ ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ ÐºÐ°Ð¼ÐµÑ€ Ð´Ð»Ñ Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ ÑÐºÐ°Ð½ÐµÑ€Ð°: ${cameras.length}`);
      setAvailablePlacementCameras(cameras);

      // Select best camera
      let selectedCamera = cameras[currentPlacementCameraIndex] || cameras[cameras.length - 1];
      console.log(`ðŸŽ¬ Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð° Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ ÐºÐ°Ð¼ÐµÑ€Ð°: "${selectedCamera.label}"`);

      // Initialize Html5Qrcode with isolated element
      console.log('ðŸš€ Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Html5Qrcode ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€Ð°...');
      const qrCodeInstance = new Html5Qrcode(isolatedElementId);
      
      // Store instance in ref for safe cleanup
      html5QrCodePlacementRef.current = qrCodeInstance;
      setHtml5QrCodePlacement(qrCodeInstance);

      // Mobile-optimized configuration
      const isolatedConfig = {
        fps: 15,
        qrbox: function(viewfinderWidth, viewfinderHeight) {
          const minEdge = Math.min(viewfinderWidth, viewfinderHeight);
          const boxSize = Math.floor(minEdge * 0.8);
          console.log(`ðŸ“ Ð˜Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ QR box: ${boxSize}x${boxSize}`);
          return { width: boxSize, height: boxSize };
        },
        aspectRatio: 1.0,
        disableFlip: false,
        videoConstraints: {
          facingMode: "environment",
          width: { ideal: 1280, max: 1920, min: 640 },
          height: { ideal: 720, max: 1080, min: 480 },
          frameRate: { ideal: 20, min: 10 }
        },
        experimentalFeatures: { useBarCodeDetectorIfSupported: true },
        rememberLastUsedCamera: true
      };

      console.log('ðŸŽ¯ Ð—Ð°Ð¿ÑƒÑÐº Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ ÑÐºÐ°Ð½ÐµÑ€Ð° Ñ Ð·Ð°Ñ‰Ð¸Ñ‚Ð¾Ð¹ Ð¾Ñ‚ React ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ð¾Ð²...');
      
      await qrCodeInstance.start(
        selectedCamera.id,
        isolatedConfig,
        (decodedText, decodedResult) => {
          console.log('ðŸ“± QR ÐºÐ¾Ð´ Ð¾Ñ‚ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¼ ÑÐºÐ°Ð½ÐµÑ€Ð¾Ð¼:', decodedText);
          handlePlacementQRScan(decodedText);
        },
        (errorMessage) => {
          if (!errorMessage.includes('No QR code found') && 
              !errorMessage.includes('NotFoundException')) {
            console.debug('ðŸ” Ð˜Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ðµ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ:', errorMessage);
          }
        }
      );
      
      setScannerActive(true);
      isInitializingRef.current = false;
      
      console.log('âœ… Ð˜Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ QR ÑÐºÐ°Ð½ÐµÑ€ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð±ÐµÐ· React ÐºÐ¾Ð½Ñ„Ð»Ð¸ÐºÑ‚Ð¾Ð²');
      showAlert('ðŸ“± Ð˜Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ ÐºÐ°Ð¼ÐµÑ€Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ð°! ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð° QR ÐºÐ¾Ð´.', 'success');
      
    } catch (error) {
      console.error('ðŸ’¥ ÐšÑ€Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ QR ÑÐºÐ°Ð½ÐµÑ€Ð°:', error);
      
      // Complete cleanup on error
      await completeQrCleanup("Isolated Scanner Error");
      
      let userMessage = 'ðŸ“µ ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½ÑƒÑŽ ÐºÐ°Ð¼ÐµÑ€Ñƒ';
      
      if (error.message.includes('ÐšÐ°Ð¼ÐµÑ€Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹')) {
        userMessage = 'ðŸ“µ ÐšÐ°Ð¼ÐµÑ€Ñ‹ Ð½Ðµ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹. ÐŸÑ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ ÐºÐ°Ð¼ÐµÑ€Ñ‹.';
      } else if (error.message.includes('Ð˜Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€')) {
        userMessage = 'ðŸ”„ ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹ÑÐ°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ.';
      }
      
      showAlert(`${userMessage}\n\nÐ˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð²Ð²Ð¾Ð´ Ð½Ð¸Ð¶Ðµ.`, 'warning');
    }
  };

  // New function: Handle QR scan during placement
  const handlePlacementQRScan = async (scannedData) => {
    try {
      // ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐºÐ°Ð½ÐµÑ€ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾
      if (html5QrCodePlacement) {
        await safeStopQrScanner(html5QrCodePlacement, "qr-reader-placement", "Placement Scanner");
        setHtml5QrCodePlacement(null);
      }
      setScannerActive(false);

      if (placementStep === 'scan-cargo') {
        // Scanned cargo QR code
        const response = await apiCall('/api/qr/scan', 'POST', { qr_text: scannedData });
        
        if (response && response.type === 'cargo') {
          setScannedCargoForPlacement(response);
          setPlacementStep('scan-cell');
          showAlert(`Ð“Ñ€ÑƒÐ· Ð½Ð°Ð¹Ð´ÐµÐ½: ${response.cargo_number}. Ð¢ÐµÐ¿ÐµÑ€ÑŒ Ð¾Ñ‚ÑÐºÐ°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ ÑÑ‡ÐµÐ¹ÐºÑƒ.`, 'success');
          setTimeout(() => startQRScannerForPlacement(), 1000);
        } else {
          showAlert('ÐžÑ‚ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÐºÐ¾Ð´ Ð½Ðµ ÑÐ²Ð»ÑÐµÑ‚ÑÑ ÐºÐ¾Ð´Ð¾Ð¼ Ð³Ñ€ÑƒÐ·Ð°', 'error');
        }
        
      } else if (placementStep === 'scan-cell') {
        // Scanned cell QR code
        const response = await apiCall('/api/qr/scan', 'POST', { qr_text: scannedData });
        
        if (response && response.type === 'warehouse_cell') {
          if (response.is_occupied) {
            showAlert(`Ð¯Ñ‡ÐµÐ¹ÐºÐ° Ð·Ð°Ð½ÑÑ‚Ð° Ð³Ñ€ÑƒÐ·Ð¾Ð¼ ${response.cargo_number}`, 'error');
            setTimeout(() => startQRScannerForPlacement(), 1000);
          } else {
            // Place cargo in cell
            const success = await placeCargoInCell(
              scannedCargoForPlacement.cargo_number,
              scannedData
            );
            
            if (success) {
              // Reset to scan next cargo
              setScannedCargoForPlacement(null);
              setPlacementStep('scan-cargo');
              showAlert('Ð“Ñ€ÑƒÐ· Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½! ÐœÐ¾Ð¶ÐµÑ‚Ðµ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ð¹ Ð³Ñ€ÑƒÐ·.', 'success');
              setTimeout(() => startQRScannerForPlacement(), 1000);
            }
          }
        } else {
          showAlert('ÐžÑ‚ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ ÐºÐ¾Ð´ Ð½Ðµ ÑÐ²Ð»ÑÐµÑ‚ÑÑ ÐºÐ¾Ð´Ð¾Ð¼ ÑÑ‡ÐµÐ¹ÐºÐ¸', 'error');
          setTimeout(() => startQRScannerForPlacement(), 1000);
        }
      }
    } catch (error) {
      console.error('Error handling placement QR scan:', error);
      showAlert(`ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ: ${error.message}`, 'error');
      setTimeout(() => startQRScannerForPlacement(), 1000);
    }
  };

  // New function: Stop placement process
  const stopCargoPlacement = async () => {
    if (html5QrCodePlacement) {
      await safeStopQrScanner(html5QrCodePlacement, "qr-reader-placement", "Placement Scanner");
      setHtml5QrCodePlacement(null);
    }
    
    setPlacementActive(false);
    setPlacementStep('idle');
    setScannedCargoForPlacement(null);
    setScannerActive(false);
  };

  // New function: Switch camera for placement scanner
  const switchPlacementCamera = async () => {
    if (availablePlacementCameras.length <= 1) {
      showAlert('ÐÐ° ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð´Ð½Ð° ÐºÐ°Ð¼ÐµÑ€Ð°', 'info');
      return;
    }

    try {
      // Stop current scanner
      if (html5QrCodePlacement) {
        await safeStopQrScanner(html5QrCodePlacement, "qr-reader-placement", "Placement Scanner");
        setHtml5QrCodePlacement(null);
      }

      // Switch to next camera
      const nextCameraIndex = (currentPlacementCameraIndex + 1) % availablePlacementCameras.length;
      setCurrentPlacementCameraIndex(nextCameraIndex);
      
      // Restart scanner with new camera
      setTimeout(() => {
        startQRScannerForPlacement();
      }, 500);

      showAlert(`ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð½Ð° ÐºÐ°Ð¼ÐµÑ€Ñƒ: ${availablePlacementCameras[nextCameraIndex]?.label || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ'}`, 'info');

    } catch (error) {
      console.error('Error switching camera:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ ÐºÐ°Ð¼ÐµÑ€Ñ‹', 'error');
    }
  };

  // Scan QR code to find cargo
  const scanCargoQRCode = async (qrText) => {
    try {
      const response = await apiCall('/api/cargo/scan-qr', 'POST', { qr_text: qrText });
      
      if (response && response.success) {
        setScannedCargoInfo(response.cargo);
        setShowScannedCargoModal(true);
        showAlert(`Ð“Ñ€ÑƒÐ· Ð½Ð°Ð¹Ð´ÐµÐ½: ${response.cargo.cargo_number}`, 'success');
        return response.cargo;
      }
    } catch (error) {
      console.error('Error scanning cargo QR:', error);
      showAlert(`ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ QR ÐºÐ¾Ð´Ð°: ${error.message}`, 'error');
      return null;
    }
  };

  // Start QR scanner for cargo search
  const startCargoQRScanner = () => {
    setScannerMode('cargo-qr-search');
    setScannerActive(true);
    setScannerError(null);
    setShowQRScannerModal(true);
  };

  // Stop QR scanner
  const stopCargoQRScanner = () => {
    setScannerMode('none');
    setScannerActive(false);
    setScannerError(null);
    setShowQRScannerModal(false);
  };

  // Switch camera for modal QR scanner
  const switchModalCamera = async () => {
    try {
      if (modalCameras.length > 1) {
        // ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ð½Ð° ÑÐ»ÐµÐ´ÑƒÑŽÑ‰ÑƒÑŽ ÐºÐ°Ð¼ÐµÑ€Ñƒ
        const nextIndex = (modalCameraIndex + 1) % modalCameras.length;
        setModalCameraIndex(nextIndex);
        
        // ÐŸÐµÑ€ÐµÐ·Ð°Ð¿ÑƒÑÐºÐ°ÐµÐ¼ ÑÐºÐ°Ð½ÐµÑ€ Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÐºÐ°Ð¼ÐµÑ€Ð¾Ð¹
        setScannerActive(false);
        setTimeout(() => {
          setScannerActive(true);
        }, 500);
        
        const cameraName = modalCameras[nextIndex]?.label || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ ÐºÐ°Ð¼ÐµÑ€Ð°';
        showAlert(`ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¾ Ð½Ð°: ${cameraName}`, 'info');
      } else {
        showAlert('Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð¾Ð´Ð½Ð° ÐºÐ°Ð¼ÐµÑ€Ð°', 'warning');
      }
    } catch (error) {
      console.error('Error switching camera:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ ÐºÐ°Ð¼ÐµÑ€Ñ‹', 'error');
    }
  };

  // useEffect for QR scanner modal - improved with useRef
  useEffect(() => {
    // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð»ÑƒÑ‡ÑˆÐµÐ¹ ÐºÐ°Ð¼ÐµÑ€Ñ‹ (Ð¿Ñ€ÐµÐ´Ð¿Ð¾Ñ‡Ñ‚ÐµÐ½Ð¸Ðµ Ð·Ð°Ð´Ð½ÐµÐ¹ ÐºÐ°Ð¼ÐµÑ€Ðµ)
    const getBestCamera = (cameras) => {
      if (!cameras || cameras.length === 0) return null;

      // Ð˜Ñ‰ÐµÐ¼ Ð·Ð°Ð´Ð½ÑŽÑŽ ÐºÐ°Ð¼ÐµÑ€Ñƒ (environment-facing)
      const backCamera = cameras.find(camera => 
        camera.label.toLowerCase().includes('back') ||
        camera.label.toLowerCase().includes('rear') ||
        camera.label.toLowerCase().includes('environment') ||
        camera.label.toLowerCase().includes('0') // Ð§Ð°ÑÑ‚Ð¾ Ð·Ð°Ð´Ð½ÑÑ ÐºÐ°Ð¼ÐµÑ€Ð° Ð¸Ð¼ÐµÐµÑ‚ Ð¸Ð½Ð´ÐµÐºÑ 0 Ð² Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ð¸
      );

      if (backCamera) {
        console.log('Selected back camera:', backCamera.label);
        return backCamera;
      }

      // Ð•ÑÐ»Ð¸ Ð·Ð°Ð´Ð½ÑÑ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð°, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÑŽÑŽ (Ñ‡Ð°ÑÑ‚Ð¾ ÑÑ‚Ð¾ Ð·Ð°Ð´Ð½ÑÑ)
      console.log('Back camera not found, using camera:', cameras[cameras.length - 1].label);
      return cameras[cameras.length - 1];
    };

    const initializeModalQRScanner = async () => {
      if (showQRScannerModal && scannerMode === 'cargo-qr-search' && scannerActive) {
        try {
          // ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ ÑÐºÐ·ÐµÐ¼Ð¿Ð»ÑÑ€ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾
          if (modalScannerRef.current) {
            await safeStopQrScanner(modalScannerRef.current, "qr-reader-modal", "Modal Scanner");
            modalScannerRef.current = null;
          }

          // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð°
          const modalElement = document.getElementById('qr-reader-modal');
          if (!modalElement) {
            console.log('QR reader modal element not found, waiting...');
            return;
          }

          // Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€ÑƒÐµÐ¼ ÐºÐ°Ð¼ÐµÑ€Ñƒ
          const cameras = await Html5Qrcode.getCameras();
          if (cameras && cameras.length > 0) {
            // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº ÐºÐ°Ð¼ÐµÑ€ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ
            setModalCameras(cameras);
            
            modalScannerRef.current = new Html5Qrcode("qr-reader-modal");
            
            // Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð¿Ð¾ Ð¸Ð½Ð´ÐµÐºÑÑƒ, Ð»Ð¸Ð±Ð¾ Ð»ÑƒÑ‡ÑˆÑƒÑŽ Ð¿Ñ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐµ
            let selectedCamera;
            if (modalCameraIndex < cameras.length) {
              selectedCamera = cameras[modalCameraIndex];
            } else {
              // ÐŸÑ€Ð¸ Ð¿ÐµÑ€Ð²Ð¾Ð¼ Ð·Ð°Ð¿ÑƒÑÐºÐµ Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð»ÑƒÑ‡ÑˆÑƒÑŽ ÐºÐ°Ð¼ÐµÑ€Ñƒ
              selectedCamera = getBestCamera(cameras);
              const selectedIndex = cameras.findIndex(c => c.id === selectedCamera.id);
              setModalCameraIndex(selectedIndex >= 0 ? selectedIndex : 0);
            }
            
            console.log(`Using camera: ${selectedCamera.label} (index: ${modalCameraIndex})`);
            
            const config = {
              fps: 10,
              qrbox: { width: 200, height: 200 },
              aspectRatio: 1.0,
              disableFlip: false,
              // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð½Ð°ÑÑ‚Ñ€Ð¾Ð¹ÐºÐ¸ Ð´Ð»Ñ Ð»ÑƒÑ‡ÑˆÐµÐ³Ð¾ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
              videoConstraints: {
                facingMode: "environment" // ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ Ð·Ð°Ð´Ð½ÑÑ ÐºÐ°Ð¼ÐµÑ€Ð°
              }
            };

            await modalScannerRef.current.start(
              selectedCamera.id, // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½ÑƒÑŽ ÐºÐ°Ð¼ÐµÑ€Ñƒ
              config,
              async (decodedText, decodedResult) => {
                console.log('Cargo QR Code scanned:', decodedText);
                
                // ÐžÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ ÑÐºÐ°Ð½ÐµÑ€ Ð±ÐµÐ·Ð¾Ð¿Ð°ÑÐ½Ð¾
                if (modalScannerRef.current) {
                  await safeStopQrScanner(modalScannerRef.current, "qr-reader-modal", "Modal Scanner");
                  modalScannerRef.current = null;
                }
                
                // ÐžÐ±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð¾Ñ‚ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ QR ÐºÐ¾Ð´
                await scanCargoQRCode(decodedText);
                
                // Ð—Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾
                stopCargoQRScanner();
              },
              (errorMessage) => {
                // Ð˜Ð³Ð½Ð¾Ñ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¿Ð¾ÑÑ‚Ð¾ÑÐ½Ð½Ñ‹Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð´Ð»Ñ ÑƒÐ¼ÐµÐ½ÑŒÑˆÐµÐ½Ð¸Ñ Ð»Ð¾Ð³Ð¾Ð²
                console.debug('Modal QR scan error:', errorMessage);
              }
            );
            
            console.log('Modal QR scanner initialized successfully');
          } else {
            console.error('No cameras available for modal QR scanner');
            setScannerError('ÐšÐ°Ð¼ÐµÑ€Ñ‹ Ð½Ðµ Ð¾Ð±Ð½Ð°Ñ€ÑƒÐ¶ÐµÐ½Ñ‹');
          }
        } catch (error) {
          console.error('Modal QR scanner initialization error:', error);
          setScannerError('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐºÐ°Ð½ÐµÑ€');
        }
      }
    };

    if (showQRScannerModal && scannerMode === 'cargo-qr-search' && scannerActive) {
      // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÑƒÑŽ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ Ð´Ð»Ñ ÐºÐ¾Ñ€Ñ€ÐµÐºÑ‚Ð½Ð¾Ð¹ Ð¸Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ DOM
      setTimeout(initializeModalQRScanner, 500);
    }

    // ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ð¿Ñ€Ð¸ Ñ€Ð°Ð·Ð¼Ð¾Ð½Ñ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ð¸ Ð¸Ð»Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚ÐµÐ¹
    return () => {
      if (modalScannerRef.current) {
        safeStopQrScanner(modalScannerRef.current, "qr-reader-modal", "Modal Scanner").catch(console.error);
        modalScannerRef.current = null;
      }
    };
  }, [showQRScannerModal, scannerMode, scannerActive, modalCameraIndex]);

  const printApplicationQR = () => {
    if (!applicationQRCode) return;

    const printWindow = window.open('', '_blank');
    const printContent = `
      <html>
        <head>
          <title>QR ÐºÐ¾Ð´ Ð·Ð°ÑÐ²ÐºÐ¸ ${applicationQRCode.cargo_number}</title>
          <style>
            body { 
              font-family: Arial, sans-serif; 
              margin: 20px; 
              text-align: center; 
              line-height: 1.6; 
            }
            .qr-container { 
              border: 2px solid #333; 
              padding: 20px; 
              margin: 20px auto; 
              max-width: 400px; 
              border-radius: 10px; 
            }
            .qr-code { 
              margin: 15px 0; 
            }
            .cargo-info { 
              margin: 15px 0; 
              text-align: left; 
            }
            .cargo-info div { 
              margin: 5px 0; 
            }
            .header { 
              font-size: 18px; 
              font-weight: bold; 
              margin-bottom: 15px; 
            }
            @media print {
              .qr-container { page-break-inside: avoid; }
            }
          </style>
        </head>
        <body>
          <div class="qr-container">
            <div class="header">Ð—ÐÐ¯Ð’ÐšÐ TAJLINE.TJ</div>
            <div class="qr-code">
              <img src="${applicationQRCode.qr_code}" alt="QR ÐºÐ¾Ð´ Ð·Ð°ÑÐ²ÐºÐ¸" style="width: 200px; height: 200px;" />
            </div>
            <div class="cargo-info">
              <div><strong>ÐÐ¾Ð¼ÐµÑ€ Ð·Ð°ÑÐ²ÐºÐ¸:</strong> ${applicationQRCode.cargo_number}</div>
              <div><strong>ÐÐ°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ:</strong> ${applicationQRCode.cargo_info.cargo_name}</div>
              <div><strong>Ð’ÐµÑ:</strong> ${applicationQRCode.cargo_info.weight} ÐºÐ³</div>
              <div><strong>ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ:</strong> ${applicationQRCode.cargo_info.sender_name}</div>
              <div><strong>ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ:</strong> ${applicationQRCode.cargo_info.recipient_name}</div>
              <div><strong>Ð”Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ:</strong> ${applicationQRCode.cargo_info.created_at}</div>
            </div>
            <div style="margin-top: 20px; font-size: 12px; color: #666;">
              ÐžÑ‚ÑÐºÐ°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð·Ð°ÑÐ²ÐºÐµ
            </div>
          </div>
        </body>
      </html>
    `;

    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
  };

  const getPaymentMethodText = (method) => {
    const methods = {
      'not_paid': 'ÐÐµ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð¾',
      'cash': 'ÐÐ°Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ',
      'card_transfer': 'ÐŸÐµÑ€ÐµÐ²Ð¾Ð´ Ð½Ð° ÐºÐ°Ñ€Ñ‚Ñƒ',
      'cash_on_delivery': 'ÐŸÑ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸',
      'credit': 'Ð’ Ð´Ð¾Ð»Ð³'
    };
    return methods[method] || method;
  };

  const getStatusText = (status) => {
    const statuses = {
      'accepted': 'ÐŸÑ€Ð¸Ð½ÑÑ‚',
      'placed_in_warehouse': 'ÐÐ° ÑÐºÐ»Ð°Ð´Ðµ',
      'on_transport': 'ÐÐ° Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ðµ',
      'in_transit': 'Ð’ Ð¿ÑƒÑ‚Ð¸',
      'ready_for_delivery': 'Ð“Ð¾Ñ‚Ð¾Ð² Ðº Ð²Ñ‹Ð´Ð°Ñ‡Ðµ',
      'delivered': 'Ð”Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½'
    };
    return statuses[status] || status;
  };

  const getProcessingStatusText = (status) => {
    const statuses = {
      'payment_pending': 'ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹',
      'paid': 'ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½',
      'placed': 'Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½',
      'ready_for_pickup': 'Ð“Ð¾Ñ‚Ð¾Ð² Ðº Ð²Ñ‹Ð´Ð°Ñ‡Ðµ'
    };
    return statuses[status] || status;
  };

  const getPaymentStatusText = (status) => {
    const statuses = {
      'pending': 'ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ÑÑ',
      'paid': 'ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½',
      'unpaid': 'ÐÐµ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½',
      'partial': 'Ð§Ð°ÑÑ‚Ð¸Ñ‡Ð½Ð¾'
    };
    return statuses[status] || status;
  };

  const getOperationText = (operation) => {
    const operations = {
      'view_details': 'ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ÑÑ‚Ð¸',
      'edit_cargo': 'Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ',
      'print_label': 'ÐŸÐµÑ‡Ð°Ñ‚ÑŒ ÑÑ‚Ð¸ÐºÐµÑ‚ÐºÐ¸',
      'generate_qr': 'QR ÐºÐ¾Ð´',
      'track_history': 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ',
      'accept_payment': 'ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ',
      'place_in_warehouse': 'Ð Ð°Ð·Ð¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ',
      'move_cargo': 'ÐŸÐµÑ€ÐµÐ¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ',
      'prepare_delivery': 'ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð¾Ð²Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð´Ð°Ñ‡Ñƒ',
      'deliver_cargo': 'Ð’Ñ‹Ð´Ð°Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·',
      'make_payment': 'ÐžÐ¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ',
      'print_receipt': 'ÐšÐ²Ð¸Ñ‚Ð°Ð½Ñ†Ð¸Ñ'
    };
    return operations[operation] || operation;
  };

  const handleCargoOperation = (operation, cargoInfo) => {
    switch (operation) {
      case 'view_details':
        // ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ
        showAlert(`ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð¾ÑÑ‚Ð¸ Ð³Ñ€ÑƒÐ·Ð° ${cargoInfo.cargo_number}`, 'info');
        break;
      case 'print_label':
        // ÐŸÐµÑ‡Ð°Ñ‚ÑŒ ÑÑ‚Ð¸ÐºÐµÑ‚ÐºÐ¸
        printCargoLabel(cargoInfo);
        break;
      case 'generate_qr':
        // Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ QR ÐºÐ¾Ð´Ð°
        generateApplicationQR(cargoInfo.cargo_number);
        break;
      default:
        showAlert(`ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ñ "${getOperationText(operation)}" Ð±ÑƒÐ´ÐµÑ‚ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð°`, 'info');
    }
  };

  const printCargoLabel = (cargoInfo) => {
    const printWindow = window.open('', '_blank');
    const printContent = `
      <html>
        <head>
          <title>Ð­Ñ‚Ð¸ÐºÐµÑ‚ÐºÐ° Ð³Ñ€ÑƒÐ·Ð° ${cargoInfo.cargo_number}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 10px; }
            .label { border: 2px solid #000; padding: 10px; max-width: 300px; }
            .header { text-align: center; font-weight: bold; font-size: 16px; margin-bottom: 10px; }
            .info { font-size: 12px; line-height: 1.3; }
          </style>
        </head>
        <body>
          <div class="label">
            <div class="header">TAJLINE.TJ</div>
            <div class="info">
              <div><strong>ÐÐ¾Ð¼ÐµÑ€:</strong> ${cargoInfo.cargo_number}</div>
              <div><strong>Ð“Ñ€ÑƒÐ·:</strong> ${cargoInfo.cargo_name}</div>
              <div><strong>Ð’ÐµÑ:</strong> ${cargoInfo.weight} ÐºÐ³</div>
              <div><strong>ÐžÑ‚:</strong> ${cargoInfo.sender_name}</div>
              <div><strong>ÐšÐ¾Ð¼Ñƒ:</strong> ${cargoInfo.recipient_name}</div>
              <div><strong>Ð¢ÐµÐ»:</strong> ${cargoInfo.recipient_phone}</div>
            </div>
          </div>
        </body>
      </html>
    `;
    printWindow.document.write(printContent);
    printWindow.document.close();
    printWindow.print();
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ñ€Ð¾Ð»ÑÐ¼Ð¸
  const handleRoleChange = async () => {
    if (!selectedUserForRole || !newRole) return;
    
    try {
      await apiCall(`/api/admin/users/${selectedUserForRole.id}/role`, 'PUT', {
        user_id: selectedUserForRole.id,
        new_role: newRole
      });
      
      showAlert(`Ð Ð¾Ð»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð° Ð½Ð° ${getRoleLabel(newRole)}`, 'success');
      setShowRoleModal(false);
      setSelectedUserForRole(null);
      setNewRole('');
      fetchUsers(); // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
    } catch (error) {
      showAlert(error.message || 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ñ€Ð¾Ð»Ð¸', 'error');
    }
  };

  // ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÐ½Ð° Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ñ€Ð¾Ð»Ð¸
  const openRoleModal = (user) => {
    setSelectedUserForRole(user);
    setNewRole(user.role);
    setShowRoleModal(true);
  };

  const fetchUserData = async () => {
    // ÐŸÑ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
    if (isLoggingIn || isLoggingOut) {
      console.log('Skipping fetchUserData - login/logout in progress');
      return;
    }

    try {
      console.log('Fetching user data...');
      // Get user data from backend using the token
      const userData = await apiCall('/api/auth/me', 'GET');
      console.log('User data received:', userData.full_name, userData.role);
      setUser(userData);
      
      // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ„Ð»Ð°Ð³ Ð»Ð¾Ð³Ð¸Ð½Ð° ÐµÑÐ»Ð¸ Ð¾Ð½ Ð±Ñ‹Ð» ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½
      if (isLoggingIn) {
        setIsLoggingIn(false);
      }
    } catch (error) {
      console.error('Failed to fetch user data:', error);
      // ÐÐµ Ð¾Ñ‡Ð¸Ñ‰Ð°ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ - Ð¿Ð¾Ð·Ð²Ð¾Ð»ÑÐµÐ¼ apiCall Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚Ð°Ñ‚ÑŒ ÑÑ‚Ð¾
      if (error.message !== 'Session expired') {
        showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ', 'error');
      }
      throw error;
    }
  };

  const fetchNotifications = async () => {
    try {
      const data = await apiCall('/api/notifications?status=all&limit=50');
      setNotifications(data || []);
    } catch (error) {
      console.error('Error fetching notifications:', error);
    }
  };

  const fetchMyCargo = async () => {
    try {
      const data = await apiCall('/api/cargo/my');
      setCargo(data);
    } catch (error) {
      console.error('Error fetching cargo:', error);
    }
  };

  const fetchAllCargo = async () => {
    try {
      const data = await apiCall('/api/cargo/all');
      setCargo(data);
    } catch (error) {
      console.error('Error fetching all cargo:', error);
    }
  };

  const fetchUsers = async (page = usersPage, perPage = usersPerPage) => {
    try {
      const params = {
        page: page,
        per_page: perPage
      };
      
      const response = await apiCall('/api/admin/users', 'GET', null, params);
      
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ñ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸ÐµÐ¹
      if (response.items) {
        setUsers(response.items); // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ items Ð¸Ð· Ð¿Ð°Ð³Ð¸Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð¾Ñ‚Ð²ÐµÑ‚Ð°
        setUsersPagination(response.pagination);
      } else {
        // ÐžÐ±Ñ€Ð°Ñ‚Ð½Ð°Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ ÑÐ¾ ÑÑ‚Ð°Ñ€Ñ‹Ð¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¾Ð¼
        setUsers(response);
        setUsersPagination({});
      }
    } catch (error) {
      console.error('Error fetching users:', error);
      setUsers([]); // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÑƒÑÑ‚Ð¾Ð¹ Ð¼Ð°ÑÑÐ¸Ð² Ð² ÑÐ»ÑƒÑ‡Ð°Ðµ Ð¾ÑˆÐ¸Ð±ÐºÐ¸
      setUsersPagination({});
    }
  };

  const fetchWarehouseCargo = async () => {
    try {
      const data = await apiCall('/api/warehouse/cargo');
      setWarehouseCargo(data);
    } catch (error) {
      console.error('Error fetching warehouse cargo:', error);
    }
  };

  const fetchWarehouses = async () => {
    try {
      const data = await apiCall('/api/warehouses');
      setWarehouses(data);
    } catch (error) {
      console.error('Error fetching warehouses:', error);
    }
  };

  const fetchAvailableCargoForPlacement = async (page = availableCargoPage, perPage = availableCargoPerPage) => {
    try {
      const params = {
        page: page,
        per_page: perPage
      };
      
      const response = await apiCall('/api/operator/cargo/available-for-placement', 'GET', null, params);
      
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ñ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸ÐµÐ¹
      if (response.items) {
        setAvailableCargoForPlacement(response.items);
        setAvailableCargoPagination(response.pagination);
      } else {
        // ÐžÐ±Ñ€Ð°Ñ‚Ð½Ð°Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ ÑÐ¾ ÑÑ‚Ð°Ñ€Ñ‹Ð¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¾Ð¼
        setAvailableCargoForPlacement(response.cargo_list || response);
        setAvailableCargoPagination({});
      }
    } catch (error) {
      console.error('Error fetching available cargo for placement:', error);
      setAvailableCargoForPlacement([]);
      setAvailableCargoPagination({});
    }
  };

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ ÑÐ¿Ð¸ÑÐºÐ° Ð³Ñ€ÑƒÐ·Ð¾Ð²
  const handleOperatorCargoPageChange = (newPage) => {
    setOperatorCargoPage(newPage);
    fetchOperatorCargo(operatorCargoFilter, newPage, operatorCargoPerPage);
  };

  const handleOperatorCargoPerPageChange = (newPerPage) => {
    const perPage = parseInt(newPerPage);
    setOperatorCargoPerPage(perPage);
    setOperatorCargoPage(1); // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ð½Ð° Ð¿ÐµÑ€Ð²ÑƒÑŽ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ
    fetchOperatorCargo(operatorCargoFilter, 1, perPage);
  };

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
  const handleUsersPageChange = (newPage) => {
    setUsersPage(newPage);
    fetchUsers(newPage, usersPerPage);
  };

  const handleUsersPerPageChange = (newPerPage) => {
    const perPage = parseInt(newPerPage);
    setUsersPerPage(perPage);
    setUsersPage(1); // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ð½Ð° Ð¿ÐµÑ€Ð²ÑƒÑŽ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ
    fetchUsers(1, perPage);
  };

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð¾Ð²
  const handleAvailableCargoPageChange = (newPage) => {
    setAvailableCargoPage(newPage);
    fetchAvailableCargoForPlacement(newPage, availableCargoPerPage);
  };

  const handleAvailableCargoPerPageChange = (newPerPage) => {
    const perPage = parseInt(newPerPage);
    setAvailableCargoPerPage(perPage);
    setAvailableCargoPage(1); // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ð½Ð° Ð¿ÐµÑ€Ð²ÑƒÑŽ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ
    fetchAvailableCargoForPlacement(1, perPage);
  };

  const fetchWarehouseLayoutWithCargo = async (warehouseId) => {
    try {
      console.log('Fetching warehouse layout for ID:', warehouseId);
      const response = await apiCall(`/api/warehouses/${warehouseId}/layout-with-cargo`);
      console.log('Warehouse layout response:', response);
      setWarehouseLayout(response);
      setSelectedWarehouseForLayout(warehouseId);
    } catch (error) {
      console.error('Error fetching warehouse layout with cargo:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ ÑÑ…ÐµÐ¼Ñ‹ ÑÐºÐ»Ð°Ð´Ð°: ' + error.message, 'error');
    }
  };

  const handleCargoMove = async () => {
    if (!selectedCargoForWarehouse) return;
    
    try {
      const moveData = {
        cargo_id: selectedCargoForWarehouse.id,
        from_block: selectedCargoForWarehouse.block_number,
        from_shelf: selectedCargoForWarehouse.shelf_number,
        from_cell: selectedCargoForWarehouse.cell_number,
        to_block: cargoMoveForm.to_block,
        to_shelf: cargoMoveForm.to_shelf,
        to_cell: cargoMoveForm.to_cell
      };

      const response = await apiCall(`/api/warehouses/${selectedWarehouseForLayout}/move-cargo`, 'POST', moveData);
      
      showAlert(`Ð“Ñ€ÑƒÐ· ${response.cargo_number} ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½ Ñ ${response.old_location} Ð½Ð° ${response.new_location}`, 'success');
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑ…ÐµÐ¼Ñƒ ÑÐºÐ»Ð°Ð´Ð°
      fetchWarehouseLayoutWithCargo(selectedWarehouseForLayout);
      
      // Ð—Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾
      setCargoMoveModal(false);
      setSelectedCargoForWarehouse(null);
      setCargoMoveForm({
        to_block: 1,
        to_shelf: 1,
        to_cell: 1
      });
      
    } catch (error) {
      console.error('Error moving cargo:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ð¸ Ð³Ñ€ÑƒÐ·Ð°: ' + error.message, 'error');
    }
  };

  const handleCleanupTestData = async () => {
    if (!confirm('âš ï¸ Ð’ÐÐ˜ÐœÐÐÐ˜Ð•!\n\nÐ­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ Ð’Ð¡Ð• Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸Ð· ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹:\n- Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹\n- Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹ Ð¸ Ð·Ð°ÑÐ²ÐºÐ¸\n- Ð¡Ð²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ\n- Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¾ ÑÑ‡ÐµÐ¹ÐºÐ°Ñ…\n\nÐ”ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ ÐÐ•ÐžÐ‘Ð ÐÐ¢Ð˜ÐœÐž!\n\nÐ’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¾Ð´Ð¾Ð»Ð¶Ð¸Ñ‚ÑŒ?')) {
      return;
    }
    
    try {
      const response = await apiCall('/api/admin/cleanup-test-data', 'POST');
      
      // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð¾Ð± Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐµ
      const report = response.cleanup_report;
      const summaryMessage = `
ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚ÐºÐ° Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð°!

ðŸ“Š ÐžÑ‚Ñ‡ÐµÑ‚ Ð¾Ð± ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸:
â€¢ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸: ${report.users_deleted}
â€¢ Ð—Ð°ÑÐ²ÐºÐ¸ Ð½Ð° Ð³Ñ€ÑƒÐ·Ñ‹: ${report.cargo_requests_deleted}  
â€¢ Ð“Ñ€ÑƒÐ·Ñ‹ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²: ${report.operator_cargo_deleted}
â€¢ Ð“Ñ€ÑƒÐ·Ñ‹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹: ${report.user_cargo_deleted}
â€¢ ÐÐµÐ¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð½Ñ‹Ðµ Ð·Ð°ÐºÐ°Ð·Ñ‹: ${report.unpaid_orders_deleted}
â€¢ Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ: ${report.notifications_deleted}
â€¢ Ð¯Ñ‡ÐµÐ¹ÐºÐ¸ ÑÐºÐ»Ð°Ð´Ð°: ${report.warehouse_cells_deleted}

Ð’Ñ€ÐµÐ¼Ñ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¸: ${new Date(response.cleanup_time).toLocaleString('ru-RU')}
      `.trim();
      
      showAlert(summaryMessage, 'success');
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐºÐ¸
      fetchOperatorCargo(operatorCargoFilter, operatorCargoPage, operatorCargoPerPage);
      fetchAvailableCargoForPlacement(availableCargoPage, availableCargoPerPage);
      fetchUsersByRole();
      fetchNotifications();
      fetchUnpaidCargo();
      
    } catch (error) {
      console.error('Error cleaning test data:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐµ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…: ' + error.message, 'error');
    }
  };

  const handleQuickPlacement = async (cargoId) => {
    try {
      const response = await apiCall(`/api/cargo/${cargoId}/quick-placement`, 'POST', quickPlacementForm);
      showAlert(`Ð“Ñ€ÑƒÐ· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½: ${response.location}`, 'success');
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐºÐ¸
      fetchOperatorCargo(operatorCargoFilter);
      fetchAvailableCargoForPlacement();
      
      // Ð—Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¾ÐºÐ½Ð°
      setQuickPlacementModal(false);
      setSelectedCargoForDetailView(null);
      
      // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ„Ð¾Ñ€Ð¼Ñƒ
      setQuickPlacementForm({
        block_number: 1,
        shelf_number: 1,
        cell_number: 1
      });
    } catch (error) {
      console.error('Error placing cargo:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ð¸ Ð³Ñ€ÑƒÐ·Ð°: ' + error.message, 'error');
    }
  };

  const handlePaymentAcceptance = async (cargoId, cargoNumber) => {
    try {
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð½Ð° Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð¾
      await apiCall(`/api/cargo/${cargoId}/processing-status`, 'PUT', { new_status: 'paid' });
      
      showAlert(`âœ… ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð° Ð´Ð»Ñ Ð³Ñ€ÑƒÐ·Ð° ${cargoNumber}`, 'success');
      showAlert('ðŸ“¦ Ð“Ñ€ÑƒÐ· Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½ Ð² Ñ€Ð°Ð·Ð´ÐµÐ» "ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ"', 'info');
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµ ÑÐ¿Ð¸ÑÐºÐ¸ Ð¸ ÑÑ‚Ð°Ñ‚ÑƒÑÑ‹ Ð²Ð¾ Ð’Ð¡Ð•Ð¥ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°Ñ… Ð¸ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑÑ…
      fetchOperatorCargo(operatorCargoFilter);
      fetchAvailableCargoForPlacement();
      fetchAllCargo(); // ÐÐ´Ð¼Ð¸Ð½ÑÐºÐ¸Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº
      fetchUnpaidCargo(); // ÐšÐ°ÑÑÐ°
      fetchPaymentHistory(); // Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹
      fetchPlacedCargo(); // Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹
      
    } catch (error) {
      console.error('Error accepting payment:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð¸Ð¸ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹: ' + error.message, 'error');
    }
  };

  // ÐÐ¾Ð²Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ

  // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ Ð¿Ð¾ ÑÐºÐ»Ð°Ð´Ð°Ð¼
  const fetchWarehouseAnalytics = async () => {
    try {
      const data = await apiCall('/api/warehouses/analytics');
      setWarehouseAnalytics(data);
      return data;
    } catch (error) {
      console.error('Error fetching warehouse analytics:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ ÑÐºÐ»Ð°Ð´Ð¾Ð²', 'error');
      return null;
    }
  };

  // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… ÑÑ‡ÐµÐµÐº Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ (ÑÑ‚Ð°Ñ€Ñ‹Ð¹ Ð¼ÐµÑ‚Ð¾Ð´ Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸)
  const fetchAvailableCellsForEnhancedPlacement = async (warehouseId, blockNumber, shelfNumber) => {
    try {
      const data = await apiCall(`/api/warehouses/${warehouseId}/available-cells/${blockNumber}/${shelfNumber}`);
      setAvailableCellsForPlacement(data.available_cells || []);
      return data.available_cells || [];
    } catch (error) {
      console.error('Error fetching available cells:', error);
      setAvailableCellsForPlacement([]);
      return [];
    }
  };

  // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ ÑÐºÐ»Ð°Ð´Ð°
  const fetchWarehouseDetailedStructure = async (warehouseId) => {
    setStructureLoading(true);
    try {
      const data = await apiCall(`/api/warehouses/${warehouseId}/detailed-structure`);
      setWarehouseDetailedStructure(data);
      return data;
    } catch (error) {
      console.error('Error fetching warehouse detailed structure:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ ÑÐºÐ»Ð°Ð´Ð°', 'error');
      return null;
    } finally {
      setStructureLoading(false);
    }
  };

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð²Ñ‹Ð±Ð¾Ñ€Ð° ÑÐºÐ»Ð°Ð´Ð° Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¾Ð¹ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹
  const handleWarehouseSelectionForPlacement = async (warehouseId) => {
    setSelectedWarehouseForPlacement(warehouseId);
    setSelectedBlockForPlacement(1);
    setSelectedShelfForPlacement(1);
    setSelectedCellForPlacement(1);
    setSelectedCellForVisualization(null);
    
    // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½ÑƒÑŽ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ ÑÐºÐ»Ð°Ð´Ð°
    await fetchWarehouseDetailedStructure(warehouseId);
    
    // Ð¢Ð°ÐºÐ¶Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÑÑ‡ÐµÐ¹ÐºÐ¸ Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸
    await fetchAvailableCellsForEnhancedPlacement(warehouseId, 1, 1);
  };

  // ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ ÑÑ‡ÐµÐ¹ÐºÐ¸
  const isCellAvailable = (blockNumber, shelfNumber, cellNumber) => {
    if (!warehouseDetailedStructure) return true;
    
    const block = warehouseDetailedStructure.blocks?.find(b => b.block_number === blockNumber);
    if (!block) return true;
    
    const shelf = block.shelves?.find(s => s.shelf_number === shelfNumber);
    if (!shelf) return true;
    
    const cell = shelf.cells?.find(c => c.cell_number === cellNumber);
    return cell?.status === 'available';
  };

  // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð·Ð°Ð½ÑÑ‚Ð¾ÑÑ‚Ð¸ ÑÑ‡ÐµÐ¹ÐºÐ¸
  const getCellInfo = (blockNumber, shelfNumber, cellNumber) => {
    if (!warehouseDetailedStructure) return null;
    
    const block = warehouseDetailedStructure.blocks?.find(b => b.block_number === blockNumber);
    if (!block) return null;
    
    const shelf = block.shelves?.find(s => s.shelf_number === shelfNumber);
    if (!shelf) return null;
    
    const cell = shelf.cells?.find(c => c.cell_number === cellNumber);
    return cell;
  };

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð±Ð»Ð¾ÐºÐ° Ð¸ Ð¿Ð¾Ð»ÐºÐ¸ Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¾Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸ ÑÑ‡ÐµÐµÐº
  const handleBlockShelfSelection = async (blockNumber, shelfNumber) => {
    setSelectedBlockForPlacement(blockNumber);
    setSelectedShelfForPlacement(shelfNumber);
    
    if (selectedWarehouseForPlacement) {
      // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÑÑ‡ÐµÐ¹ÐºÐ¸ Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸
      await fetchAvailableCellsForEnhancedPlacement(selectedWarehouseForPlacement, blockNumber, shelfNumber);
      
      // ÐÐ°Ñ…Ð¾Ð´Ð¸Ð¼ Ð¿ÐµÑ€Ð²ÑƒÑŽ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½ÑƒÑŽ ÑÑ‡ÐµÐ¹ÐºÑƒ Ð² Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¼ Ð±Ð»Ð¾ÐºÐµ/Ð¿Ð¾Ð»ÐºÐµ
      if (warehouseDetailedStructure) {
        const block = warehouseDetailedStructure.blocks?.find(b => b.block_number === blockNumber);
        const shelf = block?.shelves?.find(s => s.shelf_number === shelfNumber);
        const firstAvailableCell = shelf?.cells?.find(c => c.status === 'available');
        
        if (firstAvailableCell) {
          setSelectedCellForPlacement(firstAvailableCell.cell_number);
        } else {
          // Ð•ÑÐ»Ð¸ Ð½ÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… ÑÑ‡ÐµÐµÐº, Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿ÐµÑ€Ð²ÑƒÑŽ
          setSelectedCellForPlacement(1);
        }
      } else {
        setSelectedCellForPlacement(1);
      }
    }
  };

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð²Ñ‹Ð±Ð¾Ñ€Ð° ÑÑ‡ÐµÐ¹ÐºÐ¸ Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¾Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸
  const handleCellSelection = (cellNumber) => {
    const cellInfo = getCellInfo(selectedBlockForPlacement, selectedShelfForPlacement, cellNumber);
    
    if (cellInfo && cellInfo.status === 'occupied') {
      showAlert('Ð­Ñ‚Ð° ÑÑ‡ÐµÐ¹ÐºÐ° Ð·Ð°Ð½ÑÑ‚Ð°! Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½ÑƒÑŽ ÑÑ‡ÐµÐ¹ÐºÑƒ.', 'error');
      return;
    }
    
    setSelectedCellForPlacement(cellNumber);
    setSelectedCellForVisualization({
      block: selectedBlockForPlacement,
      shelf: selectedShelfForPlacement,
      cell: cellNumber,
      info: cellInfo
    });
  };

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð° Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¾Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚Ð¸
  const handleEnhancedCargoPlacement = async () => {
    if (!selectedCargoForEnhancedPlacement || !selectedWarehouseForPlacement) {
      showAlert('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð³Ñ€ÑƒÐ· Ð¸ ÑÐºÐ»Ð°Ð´ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ', 'error');
      return;
    }

    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð¾ÑÑ‚ÑŒ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¹ ÑÑ‡ÐµÐ¹ÐºÐ¸
    const isCellFree = isCellAvailable(selectedBlockForPlacement, selectedShelfForPlacement, selectedCellForPlacement);
    if (!isCellFree) {
      showAlert('Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð°Ñ ÑÑ‡ÐµÐ¹ÐºÐ° Ð·Ð°Ð½ÑÑ‚Ð°! ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½ÑƒÑŽ ÑÑ‡ÐµÐ¹ÐºÑƒ.', 'error');
      return;
    }

    setPlacementLoading(true);
    try {
      const response = await apiCall('/api/operator/cargo/place', 'POST', {
        cargo_id: selectedCargoForEnhancedPlacement.id,
        warehouse_id: selectedWarehouseForPlacement,
        block_number: selectedBlockForPlacement,
        shelf_number: selectedShelfForPlacement,
        cell_number: selectedCellForPlacement
      });

      showAlert(
        `âœ… Ð“Ñ€ÑƒÐ· ${selectedCargoForEnhancedPlacement.cargo_number} ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½ Ð² ${response.warehouse_name} (Ð‘Ð»Ð¾Ðº ${selectedBlockForPlacement}, ÐŸÐ¾Ð»ÐºÐ° ${selectedShelfForPlacement}, Ð¯Ñ‡ÐµÐ¹ÐºÐ° ${selectedCellForPlacement})`,
        'success'
      );

      // Ð—Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾
      setEnhancedPlacementModal(false);
      setSelectedCargoForEnhancedPlacement(null);

      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµ ÑÐ¿Ð¸ÑÐºÐ¸
      fetchAvailableCargoForPlacement(); // Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¸Ð· "ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ"
      fetchPlacedCargo(); // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð² "Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹"
      fetchOperatorCargo(operatorCargoFilter);
      
    } catch (error) {
      console.error('Enhanced placement error:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°: ' + error.message, 'error');
    } finally {
      setPlacementLoading(false);
    }
  };

  // ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÐ½Ð° ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ
  const openEnhancedPlacementModal = async (cargo) => {
    setSelectedCargoForEnhancedPlacement(cargo);
    setEnhancedPlacementModal(true);
    
    // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÑƒ ÑÐºÐ»Ð°Ð´Ð¾Ð²
    await fetchWarehouseAnalytics();
    
    // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ð²Ñ‹Ð±Ð¾Ñ€
    setSelectedWarehouseForPlacement('');
    setSelectedBlockForPlacement(1);
    setSelectedShelfForPlacement(1);
    setSelectedCellForPlacement(1);
    setAvailableCellsForPlacement([]);
  };

  // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐ¿Ð¸ÑÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð²
  const fetchPlacedCargo = async (page = placedCargoPage, perPage = placedCargoPerPage) => {
    try {
      const params = {
        page: page,
        per_page: perPage,
        status: 'placed'
      };
      
      const response = await apiCall('/api/warehouses/placed-cargo', 'GET', null, params);
      
      if (response.items) {
        setPlacedCargoList(response.items);
        setPlacedCargoPagination(response.pagination);
      } else {
        setPlacedCargoList(response.cargo_list || response);
        setPlacedCargoPagination({});
      }
    } catch (error) {
      console.error('Error fetching placed cargo:', error);
      setPlacedCargoList([]);
      setPlacedCargoPagination({});
    }
  };

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸ÐºÐ¸ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð²
  const handlePlacedCargoPageChange = (newPage) => {
    setPlacedCargoPage(newPage);
    fetchPlacedCargo(newPage, placedCargoPerPage);
  };

  const handlePlacedCargoPerPageChange = (newPerPage) => {
    const perPage = parseInt(newPerPage);
    setPlacedCargoPerPage(perPage);
    setPlacedCargoPage(1);
    fetchPlacedCargo(1, perPage);
  };

  // ===== Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜ ÐœÐÐ¡Ð¡ÐžÐ’ÐžÐ“Ðž Ð£Ð”ÐÐ›Ð•ÐÐ˜Ð¯ =====

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¼Ð¸ ÑÐºÐ»Ð°Ð´Ð°Ð¼Ð¸
  const handleWarehouseSelect = (warehouseId, isSelected) => {
    if (isSelected) {
      setSelectedWarehouses(prev => [...prev, warehouseId]);
    } else {
      setSelectedWarehouses(prev => prev.filter(id => id !== warehouseId));
    }
  };

  const handleSelectAllWarehouses = (isSelected) => {
    setSelectAllWarehouses(isSelected);
    if (isSelected) {
      const allIds = warehouses.map(warehouse => warehouse.id);
      setSelectedWarehouses(allIds);
    } else {
      setSelectedWarehouses([]);
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð³Ñ€ÑƒÐ·Ð°Ð¼Ð¸
  const handleCargoSelect = (cargoId, isSelected) => {
    if (isSelected) {
      setSelectedCargo(prev => [...prev, cargoId]);
    } else {
      setSelectedCargo(prev => prev.filter(id => id !== cargoId));
    }
  };

  const handleSelectAllCargo = (isSelected, cargoList) => {
    setSelectAllCargo(isSelected);
    if (isSelected) {
      const allIds = cargoList.map(cargo => cargo.id);
      setSelectedCargo(allIds);
    } else {
      setSelectedCargo([]);
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼Ð¸
  const handleUserSelect = (userId, isSelected) => {
    if (isSelected) {
      setSelectedUsers(prev => [...prev, userId]);
    } else {
      setSelectedUsers(prev => prev.filter(id => id !== userId));
    }
  };

  const handleSelectAllUsers = (isSelected, userList) => {
    setSelectAllUsers(isSelected);
    if (isSelected) {
      const allIds = userList.map(user => user.id).filter(id => id !== user.id); // Ð˜ÑÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
      setSelectedUsers(allIds);
    } else {
      setSelectedUsers([]);
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð·Ð°ÑÐ²ÐºÐ°Ð¼Ð¸
  const handleRequestSelect = (requestId, isSelected) => {
    if (isSelected) {
      setSelectedRequests(prev => [...prev, requestId]);
    } else {
      setSelectedRequests(prev => prev.filter(id => id !== requestId));
    }
  };

  const handleSelectAllRequests = (isSelected, requestList) => {
    setSelectAllRequests(isSelected);
    if (isSelected) {
      const allIds = requestList.map(request => request.id);
      setSelectedRequests(allIds);
    } else {
      setSelectedRequests([]);
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°Ð¼Ð¸
  const handleOperatorSelect = (operatorId, isSelected) => {
    if (isSelected) {
      setSelectedOperators(prev => [...prev, operatorId]);
    } else {
      setSelectedOperators(prev => prev.filter(id => id !== operatorId));
    }
  };

  const handleSelectAllOperators = (isSelected, operatorList) => {
    setSelectAllOperators(isSelected);
    if (isSelected) {
      const allIds = operatorList.map(operator => operator.id).filter(id => id !== user.id); // Ð˜ÑÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÐµÐ³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
      setSelectedOperators(allIds);
    } else {
      setSelectedOperators([]);
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð°Ð¼Ð¸
  const handleTransportSelect = (transportId, isSelected) => {
    if (isSelected) {
      setSelectedTransports(prev => [...prev, transportId]);
    } else {
      setSelectedTransports(prev => prev.filter(id => id !== transportId));
    }
  };

  const handleSelectAllTransports = (isSelected, transportList) => {
    setSelectAllTransports(isSelected);
    if (isSelected) {
      const allIds = transportList.map(transport => transport.id);
      setSelectedTransports(allIds);
    } else {
      setSelectedTransports([]);
    }
  };

  // ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÐ½Ð° Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ
  const openDeleteConfirmModal = (type, items, isBulk = false) => {
    setDeleteConfirmData({
      type,
      items: isBulk ? items : [items],
      isBulk,
      count: isBulk ? items.length : 1
    });
    setDeleteConfirmModal(true);
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð¾Ñ‚Ð´ÐµÐ»ÑŒÐ½Ñ‹Ñ… ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð²
  const handleDeleteWarehouse = async (warehouseId) => {
    const warehouse = warehouses.find(w => w.id === warehouseId);
    openDeleteConfirmModal('warehouse', warehouse, false);
  };

  const handleDeleteCargo = async (cargoId, cargoList) => {
    const cargo = cargoList.find(c => c.id === cargoId);
    openDeleteConfirmModal('cargo', cargo, false);
  };

  const handleDeleteUser = async (userId, userList) => {
    const userToDelete = userList.find(u => u.id === userId);
    openDeleteConfirmModal('user', userToDelete, false);
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð¼Ð°ÑÑÐ¾Ð²Ð¾Ð³Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ
  const handleBulkDeleteWarehouses = () => {
    if (selectedWarehouses.length === 0) {
      showAlert('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐºÐ»Ð°Ð´Ñ‹ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ', 'error');
      return;
    }
    openDeleteConfirmModal('warehouse', selectedWarehouses, true);
  };

  const handleBulkDeleteCargo = (cargoList) => {
    if (selectedCargo.length === 0) {
      showAlert('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð³Ñ€ÑƒÐ·Ñ‹ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ', 'error');
      return;
    }
    const selectedCargoItems = cargoList.filter(c => selectedCargo.includes(c.id));
    openDeleteConfirmModal('cargo', selectedCargoItems, true);
  };

  const handleBulkDeleteUsers = (userList) => {
    if (selectedUsers.length === 0) {
      showAlert('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ', 'error');
      return;
    }
    const selectedUserItems = userList.filter(u => selectedUsers.includes(u.id));
    openDeleteConfirmModal('user', selectedUserItems, true);
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð·Ð°ÑÐ²Ð¾Ðº
  const handleDeleteRequest = async (requestId) => {
    const request = cargoRequests.find(r => r.id === requestId);
    openDeleteConfirmModal('request', request, false);
  };

  const handleBulkDeleteRequests = () => {
    if (selectedRequests.length === 0) {
      showAlert('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð·Ð°ÑÐ²ÐºÐ¸ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ', 'error');
      return;
    }
    const selectedRequestItems = cargoRequests.filter(r => selectedRequests.includes(r.id));
    openDeleteConfirmModal('request', selectedRequestItems, true);
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²
  const handleDeleteOperator = async (operatorId) => {
    const operator = usersByRole.warehouse_operator.find(o => o.id === operatorId);
    openDeleteConfirmModal('operator', operator, false);
  };

  const handleBulkDeleteOperators = () => {
    if (selectedOperators.length === 0) {
      showAlert('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ', 'error');
      return;
    }
    const selectedOperatorItems = usersByRole.warehouse_operator.filter(o => selectedOperators.includes(o.id));
    openDeleteConfirmModal('operator', selectedOperatorItems, true);
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð¼Ð°ÑÑÐ¾Ð²Ð¾Ð³Ð¾ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð°
  const handleBulkDeleteTransports = () => {
    if (selectedTransports.length === 0) {
      showAlert('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ', 'error');
      return;
    }
    const selectedTransportItems = transports.filter(t => selectedTransports.includes(t.id));
    openDeleteConfirmModal('transport', selectedTransportItems, true);
  };

  // Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ
  const executeDelete = async () => {
    if (!deleteConfirmData) return;
    
    setBulkDeleteLoading(true);
    try {
      const { type, items, isBulk } = deleteConfirmData;
      
      if (type === 'warehouse') {
        if (isBulk) {
          const ids = items.map(warehouse => warehouse.id);
          const response = await apiCall('/api/admin/warehouses/bulk', 'DELETE', { ids });
          showAlert(response.message, response.errors?.length > 0 ? 'warning' : 'success');
          if (response.errors?.length > 0) {
            response.errors.forEach(error => showAlert(error, 'error'));
          }
        } else {
          const response = await apiCall(`/api/admin/warehouses/${items[0].id}`, 'DELETE');
          showAlert(response.message, 'success');
        }
        setSelectedWarehouses([]);
        setSelectAllWarehouses(false);
        fetchWarehouses();
      }
      
      else if (type === 'cargo') {
        if (isBulk) {
          const ids = items.map(cargo => cargo.id);
          const response = await apiCall('/api/admin/cargo/bulk', 'DELETE', { ids });
          showAlert(response.message, 'success');
        } else {
          const response = await apiCall(`/api/admin/cargo/${items[0].id}`, 'DELETE');
          showAlert(response.message, 'success');
        }
        setSelectedCargo([]);
        setSelectAllCargo(false);
        fetchAllCargo();
        fetchOperatorCargo();
      }
      
      else if (type === 'user') {
        if (isBulk) {
          const ids = items.map(user => user.id);
          const response = await apiCall('/api/admin/users/bulk', 'DELETE', { ids });
          showAlert(response.message, 'success');
          if (response.warnings?.length > 0) {
            response.warnings.forEach(warning => showAlert(warning, 'warning'));
          }
        } else {
          const response = await apiCall(`/api/admin/users/${items[0].id}`, 'DELETE');
          showAlert(response.message, response.warning ? 'warning' : 'success');
        }
        setSelectedUsers([]);
        setSelectAllUsers(false);
        fetchUsers();
      }

      else if (type === 'request') {
        if (isBulk) {
          const ids = items.map(request => request.id);
          const response = await apiCall('/api/admin/cargo-applications/bulk', 'DELETE', { ids });
          showAlert(response.message, 'success');
        } else {
          const response = await apiCall(`/api/admin/cargo-applications/${items[0].id}`, 'DELETE');
          showAlert(response.message, 'success');
        }
        setSelectedRequests([]);
        setSelectAllRequests(false);
        fetchCargoRequests();
      }

      else if (type === 'operator') {
        if (isBulk) {
          const ids = items.map(operator => operator.id);
          const response = await apiCall('/api/admin/operators/bulk', 'DELETE', { ids });
          showAlert(response.message, 'success');
          if (response.warnings?.length > 0) {
            response.warnings.forEach(warning => showAlert(warning, 'warning'));
          }
        } else {
          const response = await apiCall(`/api/admin/operators/${items[0].id}`, 'DELETE');
          showAlert(response.message, response.warning ? 'warning' : 'success');
        }
        setSelectedOperators([]);
        setSelectAllOperators(false);
        fetchUsersByRole(); // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²
      }

      else if (type === 'transport') {
        if (isBulk) {
          const ids = items.map(transport => transport.id);
          const response = await apiCall('/api/admin/transports/bulk', 'DELETE', { ids });
          showAlert(response.message, response.errors?.length > 0 ? 'warning' : 'success');
          if (response.errors?.length > 0) {
            response.errors.forEach(error => showAlert(error, 'error'));
          }
        } else {
          const response = await apiCall(`/api/admin/transports/${items[0].id}`, 'DELETE');
          showAlert(response.message, 'success');
        }
        setSelectedTransports([]);
        setSelectAllTransports(false);
        fetchTransports(); // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð°
        setTransportManagementModal(false); // Ð—Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ ÐµÑÐ»Ð¸ Ð±Ñ‹Ð»Ð¾ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¾
      }
      
      setDeleteConfirmModal(false);
      setDeleteConfirmData(null);
      
    } catch (error) {
      console.error('Delete error:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸: ' + error.message, 'error');
    } finally {
      setBulkDeleteLoading(false);
    }
  };

  const updateCargoProcessingStatus = async (cargoId, newStatus) => {
    try {
      await apiCall(`/api/cargo/${cargoId}/processing-status`, 'PUT', { new_status: newStatus });
      showAlert(`Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð³Ñ€ÑƒÐ·Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½: ${getProcessingStatusLabel(newStatus)}`, 'success');
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð’Ð¡Ð• ÑÐ¿Ð¸ÑÐºÐ¸ Ð´Ð»Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸ ÑÑ‚Ð°Ñ‚ÑƒÑÐ¾Ð² Ð²Ð¾ Ð²ÑÐµÑ… Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°Ñ… Ð¸ ÐºÐ°Ñ‚ÐµÐ³Ð¾Ñ€Ð¸ÑÑ…
      fetchOperatorCargo(operatorCargoFilter, operatorCargoPage, operatorCargoPerPage);
      fetchAvailableCargoForPlacement(availableCargoPage, availableCargoPerPage);
      fetchAllCargo(); // ÐÐ´Ð¼Ð¸Ð½ÑÐºÐ¸Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº Ð³Ñ€ÑƒÐ·Ð¾Ð²
      fetchUnpaidCargo(); // ÐšÐ°ÑÑÐ° - Ð½ÐµÐ¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð¾
      fetchPaymentHistory(); // Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¿Ð»Ð°Ñ‚ÐµÐ¶ÐµÐ¹
      fetchPlacedCargo(); // Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹
      
      // Ð•ÑÐ»Ð¸ Ð³Ñ€ÑƒÐ· ÑÑ‚Ð°Ð» Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð½Ñ‹Ð¼, Ð¿Ð¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ð¸
      if (newStatus === 'paid') {
        showAlert('Ð“Ñ€ÑƒÐ· Ð¿ÐµÑ€ÐµÐ²ÐµÐ´ÐµÐ½ Ð² Ñ€Ð°Ð·Ð´ÐµÐ» "ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ"', 'info');
      }
      // Ð•ÑÐ»Ð¸ Ð³Ñ€ÑƒÐ· Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½, Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰Ð°ÐµÐ¼ Ð² Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ðµ
      else if (newStatus === 'placed') {
        showAlert('Ð“Ñ€ÑƒÐ· Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½ Ð² Ñ€Ð°Ð·Ð´ÐµÐ» "Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹"', 'info');
      }
    } catch (error) {
      console.error('Error updating cargo processing status:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð³Ñ€ÑƒÐ·Ð°: ' + error.message, 'error');
    }
  };

  const getProcessingStatusLabel = (status) => {
    const labels = {
      'payment_pending': 'ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹',
      'paid': 'ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½',
      'invoice_printed': 'ÐÐ°ÐºÐ»Ð°Ð´Ð½Ð°Ñ Ð½Ð°Ð¿ÐµÑ‡Ð°Ñ‚Ð°Ð½Ð°',
      'placed': 'Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ'
    };
    return labels[status] || status;
  };

  const getProcessingStatusBadgeVariant = (status) => {
    const variants = {
      'payment_pending': 'destructive',
      'paid': 'default',
      'invoice_printed': 'secondary',
      'placed': 'outline'
    };
    return variants[status] || 'outline';
  };

  const fetchOperatorCargo = async (filterStatus = '', page = operatorCargoPage, perPage = operatorCargoPerPage) => {
    try {
      const params = { 
        page: page,
        per_page: perPage
      };
      
      if (filterStatus) {
        params.filter_status = filterStatus;
      }
      
      const response = await apiCall('/api/operator/cargo/list', 'GET', null, params);
      
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ñ Ð¿Ð°Ð³Ð¸Ð½Ð°Ñ†Ð¸ÐµÐ¹
      if (response.items) {
        setOperatorCargo(response.items);
        setOperatorCargoPagination(response.pagination);
      } else {
        // ÐžÐ±Ñ€Ð°Ñ‚Ð½Ð°Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ ÑÐ¾ ÑÑ‚Ð°Ñ€Ñ‹Ð¼ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ð¾Ð¼
        setOperatorCargo(response.cargo_list || response);
        setOperatorCargoPagination({});
      }
    } catch (error) {
      console.error('Error fetching operator cargo:', error);
      setOperatorCargo([]);
      setOperatorCargoPagination({});
    }
  };

  const fetchAvailableCargo = async () => {
    try {
      const data = await apiCall('/api/operator/cargo/available');
      setAvailableCargo(data);
    } catch (error) {
      console.error('Error fetching available cargo:', error);
    }
  };

  const fetchCargoHistory = async () => {
    try {
      const params = new URLSearchParams();
      if (historyFilters.status && historyFilters.status !== 'all') {
        params.append('status', historyFilters.status);
      }
      if (historyFilters.search) {
        params.append('search', historyFilters.search);
      }
      const data = await apiCall(`/api/operator/cargo/history?${params}`);
      setCargoHistory(data);
    } catch (error) {
      console.error('Error fetching cargo history:', error);
    }
  };

  const fetchAvailableCells = async (warehouseId) => {
    try {
      const data = await apiCall(`/api/warehouses/${warehouseId}/available-cells`);
      setAvailableCells(data.available_cells || []);
    } catch (error) {
      console.error('Error fetching available cells:', error);
    }
  };

  const fetchUnpaidCargo = async () => {
    try {
      const data = await apiCall('/api/cashier/unpaid-cargo');
      setUnpaidCargo(data);
    } catch (error) {
      console.error('Error fetching unpaid cargo:', error);
    }
  };

  const fetchPaymentHistory = async () => {
    try {
      const data = await apiCall('/api/cashier/payment-history');
      setPaymentHistory(data);
    } catch (error) {
      console.error('Error fetching payment history:', error);
    }
  };

  const fetchUsersByRole = async () => {
    try {
      const roles = ['user', 'admin', 'warehouse_operator'];
      const usersByRoleData = {};
      
      for (const role of roles) {
        const data = await apiCall(`/api/admin/users/by-role/${role}`);
        usersByRoleData[role] = data;
      }
      
      setUsersByRole(usersByRoleData);
    } catch (error) {
      console.error('Error fetching users by role:', error);
    }
  };

  const fetchWarehouseLayout = async (warehouseId) => {
    try {
      const data = await apiCall(`/api/warehouses/${warehouseId}/full-layout`);
      setWarehouseLayout(data);
    } catch (error) {
      console.error('Error fetching warehouse layout:', error);
    }
  };

  const fetchCargoRequests = async () => {
    try {
      const data = await apiCall('/api/admin/cargo-requests');
      setCargoRequests(data);
      setPendingOrders(data); // Ð¢Ð°ÐºÐ¶Ðµ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð»Ñ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»Ð°
    } catch (error) {
      console.error('Error fetching cargo requests:', error);
    }
  };

  const fetchMyRequests = async () => {
    try {
      const data = await apiCall('/api/user/my-requests');
      setMyRequests(data);
    } catch (error) {
      console.error('Error fetching my requests:', error);
    }
  };

  // ÐÐžÐ’Ð«Ð• Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜ Ð”Ð›Ð¯ Ð£ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð¯ Ð—ÐÐšÐÐ—ÐÐœÐ˜ ÐšÐ›Ð˜Ð•ÐÐ¢ÐžÐ’

  const fetchNewOrdersCount = async () => {
    try {
      const data = await apiCall('/api/admin/new-orders-count');
      setNewOrdersCount(data.pending_orders);
    } catch (error) {
      console.error('Error fetching new orders count:', error);
    }
  };

  const fetchOrderDetails = async (orderId) => {
    try {
      const data = await apiCall(`/api/admin/cargo-requests/${orderId}`);
      setSelectedOrder(data);
      return data;
    } catch (error) {
      console.error('Error fetching order details:', error);
      return null;
    }
  };

  const handleOrderDetailsView = async (order) => {
    const details = await fetchOrderDetails(order.id);
    if (details) {
      setOrderDetailsModal(true);
    }
  };

  const handleOrderEdit = async (order) => {
    const details = await fetchOrderDetails(order.id);
    if (details) {
      // Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ñƒ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð·Ð°ÐºÐ°Ð·Ð°
      setOrderEditForm({
        sender_full_name: details.sender_full_name || '',
        sender_phone: details.sender_phone || '',
        recipient_full_name: details.recipient_full_name || '',
        recipient_phone: details.recipient_phone || '',
        recipient_address: details.recipient_address || '',
        pickup_address: details.pickup_address || '',
        cargo_name: details.cargo_name || '',
        weight: details.weight || '',
        declared_value: details.declared_value || '',
        description: details.description || '',
        route: details.route || '',
        admin_notes: details.admin_notes || ''
      });
      setEditOrderModal(true);
    }
  };

  const handleSaveOrderChanges = async () => {
    try {
      const updateData = { ...orderEditForm };
      
      // ÐŸÑ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ñ‚ÑŒ Ñ‡Ð¸ÑÐ»Ð¾Ð²Ñ‹Ðµ Ð¿Ð¾Ð»Ñ
      if (updateData.weight) updateData.weight = parseFloat(updateData.weight);
      if (updateData.declared_value) updateData.declared_value = parseFloat(updateData.declared_value);

      await apiCall(`/api/admin/cargo-requests/${selectedOrder.id}/update`, 'PUT', updateData);
      
      showAlert('Ð—Ð°ÐºÐ°Ð· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½!', 'success');
      setEditOrderModal(false);
      
      // ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ
      fetchCargoRequests();
      fetchNewOrdersCount();
      
    } catch (error) {
      console.error('Error updating order:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð°: ' + (error.message || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°'), 'error');
    }
  };

  const handleAcceptOrder = async (orderId) => {
    try {
      await apiCall(`/api/admin/cargo-requests/${orderId}/accept`, 'POST');
      showAlert('Ð—Ð°ÐºÐ°Ð· Ð¿Ñ€Ð¸Ð½ÑÑ‚ Ð¸ Ð³Ñ€ÑƒÐ· ÑÐ¾Ð·Ð´Ð°Ð½!', 'success');
      
      // ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ
      fetchCargoRequests();
      fetchNewOrdersCount();
      fetchAllCargo();
      setOrderDetailsModal(false);
      
    } catch (error) {
      console.error('Error accepting order:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð°: ' + (error.message || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°'), 'error');
    }
  };

  const handleRejectOrder = async (orderId, reason = '') => {
    try {
      await apiCall(`/api/admin/cargo-requests/${orderId}/reject`, 'POST', { reason });
      showAlert('Ð—Ð°ÐºÐ°Ð· Ð¾Ñ‚ÐºÐ»Ð¾Ð½ÐµÐ½!', 'success');
      
      // ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ
      fetchCargoRequests();
      fetchNewOrdersCount();
      setOrderDetailsModal(false);
      
    } catch (error) {
      console.error('Error rejecting order:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚ÐºÐ»Ð¾Ð½ÐµÐ½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð°: ' + (error.message || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ°'), 'error');
    }
  };

  // Transport functions
  const fetchTransports = async (status = null) => {
    try {
      const params = status ? `?status=${status}` : '';
      const data = await apiCall(`/api/transport/list${params}`);
      setTransports(data);
    } catch (error) {
      console.error('Error fetching transports:', error);
    }
  };

  const fetchTransportCargoList = async (transportId) => {
    try {
      const data = await apiCall(`/api/transport/${transportId}/cargo-list`);
      setTransportCargoList(data);
    } catch (error) {
      console.error('Error fetching transport cargo list:', error);
    }
  };

  const fetchAvailableCargoForTransport = async () => {
    try {
      // ÐŸÐ¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·Ñ‹, ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ðµ Ð½Ð°Ñ…Ð¾Ð´ÑÑ‚ÑÑ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ Ð¸ Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹ Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸
      const data = await apiCall('/api/operator/cargo/available');
      setAvailableCargoForTransport(data.filter(cargo => 
        cargo.status === 'accepted' && cargo.warehouse_location
      ));
    } catch (error) {
      console.error('Error fetching available cargo for transport:', error);
    }
  };

  const handleCreateTransport = async (e) => {
    e.preventDefault();
    try {
      await apiCall('/api/transport/create', 'POST', {
        ...transportForm,
        capacity_kg: parseFloat(transportForm.capacity_kg)
      });
      showAlert('Ð¢Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð´Ð¾Ð±Ð°Ð²Ð»ÐµÐ½!', 'success');
      setTransportForm({
        driver_name: '',
        driver_phone: '',
        transport_number: '',
        capacity_kg: '',
        direction: ''
      });
      fetchTransports();
    } catch (error) {
      console.error('Create transport error:', error);
    }
  };

  const handlePlaceCargoOnTransport = async (transportId, cargoNumbers) => {
    try {
      if (!cargoNumbers || cargoNumbers.length === 0) {
        showAlert('ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ñ‹ Ð½Ð¾Ð¼ÐµÑ€Ð° Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ', 'error');
        return;
      }

      // ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð¾Ð¼ÐµÑ€Ð° Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð½Ð°Ð¿Ñ€ÑÐ¼ÑƒÑŽ, Ð±ÐµÐ· Ð¿Ñ€ÐµÐ¾Ð±Ñ€Ð°Ð·Ð¾Ð²Ð°Ð½Ð¸Ñ Ð² ID
      await apiCall(`/api/transport/${transportId}/place-cargo`, 'POST', {
        transport_id: transportId,
        cargo_numbers: cargoNumbers
      });
      
      showAlert(`Ð“Ñ€ÑƒÐ· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½ Ð½Ð° Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ðµ! (${cargoNumbers.length} Ð¼ÐµÑÑ‚)`, 'success');
      fetchTransports();
      fetchTransportCargoList(transportId);
      fetchAvailableCargoForTransport(); // ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð²
      setSelectedCargoForPlacement([]);
    } catch (error) {
      console.error('Place cargo on transport error:', error);
      // ÐŸÐ¾ÐºÐ°Ð·Ð°Ñ‚ÑŒ Ð±Ð¾Ð»ÐµÐµ Ð¿Ð¾Ð´Ñ€Ð¾Ð±Ð½ÑƒÑŽ Ð¾ÑˆÐ¸Ð±ÐºÑƒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ
      const errorMessage = error.response?.data?.detail || error.message || 'ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°';
      showAlert(errorMessage, 'error');
    }
  };

  const handleDispatchTransport = async (transportId) => {
    if (window.confirm('Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ð¾Ñ‚ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚?')) {
      try {
        await apiCall(`/api/transport/${transportId}/dispatch`, 'POST');
        showAlert('Ð¢Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½!', 'success');
        fetchTransports();
        setTransportManagementModal(false);
      } catch (error) {
        console.error('Dispatch transport error:', error);
      }
    }
  };

  const handleDeleteTransport = async (transportId) => {
    const transport = transports.find(t => t.id === transportId);
    if (transport) {
      openDeleteConfirmModal('transport', transport, false);
    } else {
      showAlert('Ð¢Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½', 'error');
    }
  };

  // Contact functions
  const handleWhatsAppContact = () => {
    // ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ WhatsApp Ñ Ð¿Ñ€ÐµÐ´ÑƒÑÑ‚Ð°Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¼ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸ÐµÐ¼
    const phoneNumber = "79123456789"; // ÐÐ¾Ð¼ÐµÑ€ ÑÐ»ÑƒÐ¶Ð±Ñ‹ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸
    const message = "Ð—Ð´Ñ€Ð°Ð²ÑÑ‚Ð²ÑƒÐ¹Ñ‚Ðµ! Ð£ Ð¼ÐµÐ½Ñ ÐµÑÑ‚ÑŒ Ð²Ð¾Ð¿Ñ€Ð¾Ñ Ð¿Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ°Ð¼ TAJLINE.TJ";
    const whatsappUrl = `https://wa.me/${phoneNumber}?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
  };

  const handleTelegramContact = () => {
    // ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Telegram
    const telegramUsername = "tajline_support"; // Username ÑÐ»ÑƒÐ¶Ð±Ñ‹ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸
    const telegramUrl = `https://t.me/${telegramUsername}`;
    window.open(telegramUrl, '_blank');
  };

  const handleOnlineChat = () => {
    // Ð—Ð´ÐµÑÑŒ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸Ð½Ñ‚ÐµÐ³Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¾Ð½Ð»Ð°Ð¹Ð½ Ñ‡Ð°Ñ‚ (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€, Tawk.to, Intercom, Ð¸Ð»Ð¸ ÑÐ¾Ð±ÑÑ‚Ð²ÐµÐ½Ð½Ð¾Ðµ Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ)
    showAlert('ÐžÐ½Ð»Ð°Ð¹Ð½ Ñ‡Ð°Ñ‚ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½. ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ WhatsApp Ð¸Ð»Ð¸ Telegram.', 'info');
    // ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ð¾ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ñƒ Ð¾Ð±Ñ€Ð°Ñ‚Ð½Ð¾Ð¹ ÑÐ²ÑÐ·Ð¸
  };

  // Search functions
  const handleSearch = async (query) => {
    if (!query || query.length < 2) {
      setSearchResults([]);
      setShowSearchResults(false);
      setShowSuggestions(false);
      return;
    }

    try {
      const results = await apiCall(`/api/cargo/search?query=${encodeURIComponent(query)}&search_type=${searchType}`);
      // Ð£Ð±ÐµÐ¶Ð´Ð°ÐµÐ¼ÑÑ, Ñ‡Ñ‚Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð²ÑÐµÐ³Ð´Ð° ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼
      setSearchResults(Array.isArray(results) ? results : []);
      setShowSearchResults(true);
      setShowSuggestions(false);
    } catch (error) {
      console.error('Search error:', error);
      setSearchResults([]);
      setShowSearchResults(false);
    }
  };

  // Advanced search function
  const handleAdvancedSearch = async (query = searchQuery, filters = searchFilters) => {
    setSearchLoading(true);
    try {
      const searchRequest = {
        query: query.trim(),
        search_type: searchType,
        ...filters
      };

      const response = await apiCall('/api/search/advanced', 'POST', searchRequest);
      
      setSearchResults(Array.isArray(response.results) ? response.results : []);
      setShowSearchResults(true);
      setShowSuggestions(false);
      setSearchTime(response.search_time_ms);
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð´Ð¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
      if (response.suggestions && response.suggestions.length > 0) {
        setSearchSuggestions(response.suggestions);
      }
      
    } catch (error) {
      console.error('Advanced search error:', error);
      setSearchResults([]);
      setShowSearchResults(false);
      setSearchTime(0);
    } finally {
      setSearchLoading(false);
    }
  };

  // Autocomplete suggestions
  const handleSearchInput = async (value) => {
    setSearchQuery(value);
    
    if (value.length >= 2) {
      try {
        // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð¿Ñ€Ð¾ÑÑ‚Ð¾Ð¹ Ð¿Ð¾Ð¸ÑÐº Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ñ€ÐµÐ´Ð»Ð¾Ð¶ÐµÐ½Ð¸Ð¹
        const response = await apiCall('/api/search/advanced', 'POST', {
          query: value.trim(),
          search_type: searchType,
          per_page: 5
        });
        
        if (response.suggestions && response.suggestions.length > 0) {
          setSearchSuggestions(response.suggestions);
          setShowSuggestions(true);
        } else {
          setShowSuggestions(false);
        }
      } catch (error) {
        setShowSuggestions(false);
      }
    } else {
      setShowSuggestions(false);
      setSearchSuggestions([]);
    }
  };

  const selectSearchSuggestion = (suggestion) => {
    setSearchQuery(suggestion);
    setShowSuggestions(false);
    handleAdvancedSearch(suggestion);
  };

  // Profile management functions
  const fetchOperatorProfile = async (operatorId) => {
    setProfileLoading(true);
    try {
      const profile = await apiCall(`/api/admin/operators/profile/${operatorId}`, 'GET');
      setSelectedOperatorProfile(profile);
      setShowOperatorProfile(true);
    } catch (error) {
      console.error('Error fetching operator profile:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°', 'error');
    } finally {
      setProfileLoading(false);
    }
  };

  const fetchUserProfile = async (userId) => {
    setProfileLoading(true);
    try {
      const profile = await apiCall(`/api/admin/users/profile/${userId}`, 'GET');
      setSelectedUserProfile(profile);
      setFrequentRecipients(profile.frequent_recipients || []);
      setShowUserProfile(true);
    } catch (error) {
      console.error('Error fetching user profile:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ', 'error');
    } finally {
      setProfileLoading(false);
    }
  };

  // Quick cargo creation functions
  const openQuickCargoModal = (user) => {
    setQuickCargoForm({
      sender_id: user.id,
      recipient_data: {},
      cargo_items: [{ cargo_name: '', weight: '', price_per_kg: '' }],
      route: 'moscow_to_tajikistan',
      description: ''
    });
    
    // Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ñ‡Ð°ÑÑ‚Ñ‹Ñ… Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÐµÐ¹
    fetchUserProfile(user.id);
    setShowQuickCargoModal(true);
  };

  const selectRecipientFromHistory = (recipient) => {
    setSelectedRecipient(recipient);
    setQuickCargoForm({
      ...quickCargoForm,
      recipient_data: {
        recipient_full_name: recipient.recipient_full_name,
        recipient_phone: recipient.recipient_phone,
        recipient_address: recipient.recipient_address
      }
    });
  };

  const addQuickCargoItem = () => {
    setQuickCargoForm({
      ...quickCargoForm,
      cargo_items: [...quickCargoForm.cargo_items, { cargo_name: '', weight: '', price_per_kg: '' }]
    });
  };

  const removeQuickCargoItem = (index) => {
    if (quickCargoForm.cargo_items.length > 1) {
      const newItems = quickCargoForm.cargo_items.filter((_, i) => i !== index);
      setQuickCargoForm({
        ...quickCargoForm,
        cargo_items: newItems
      });
    }
  };

  const updateQuickCargoItem = (index, field, value) => {
    const newItems = [...quickCargoForm.cargo_items];
    newItems[index] = { ...newItems[index], [field]: value };
    setQuickCargoForm({
      ...quickCargoForm,
      cargo_items: newItems
    });
  };

  const calculateQuickCargoTotals = () => {
    const totalWeight = quickCargoForm.cargo_items.reduce((sum, item) => {
      return sum + (parseFloat(item.weight) || 0);
    }, 0);

    const totalCost = quickCargoForm.cargo_items.reduce((sum, item) => {
      const weight = parseFloat(item.weight) || 0;
      const price = parseFloat(item.price_per_kg) || 0;
      return sum + (weight * price);
    }, 0);

    return { totalWeight, totalCost };
  };

  const submitQuickCargo = async () => {
    try {
      const response = await apiCall(`/api/admin/users/${quickCargoForm.sender_id}/quick-cargo`, 'POST', quickCargoForm);
      showAlert('Ð“Ñ€ÑƒÐ· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½ Ð¸Ð· Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ!', 'success');
      setShowQuickCargoModal(false);
      setShowUserProfile(false);
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð³Ñ€ÑƒÐ·Ð¾Ð²
      fetchOperatorCargo();
      
    } catch (error) {
      console.error('Error creating quick cargo:', error);
      showAlert(error.message || 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°', 'error');
    }
  };

  const clearSearch = () => {
    setSearchQuery('');
    setSearchResults([]);
    setShowSearchResults(false);
  };

  // Operator-warehouse binding functions
  const fetchOperatorWarehouseBindings = async () => {
    try {
      const data = await apiCall('/api/admin/operator-warehouse-bindings');
      setOperatorWarehouseBindings(data);
    } catch (error) {
      console.error('Error fetching operator-warehouse bindings:', error);
    }
  };

  const handleCreateOperatorBinding = async () => {
    if (!selectedOperatorForBinding || !selectedWarehouseForBinding) {
      showAlert('Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° Ð¸ ÑÐºÐ»Ð°Ð´ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¸', 'error');
      return;
    }

    try {
      await apiCall('/api/admin/operator-warehouse-binding', 'POST', {
        operator_id: selectedOperatorForBinding,
        warehouse_id: selectedWarehouseForBinding
      });
      showAlert('ÐŸÑ€Ð¸Ð²ÑÐ·ÐºÐ° Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° Ðº ÑÐºÐ»Ð°Ð´Ñƒ ÑÐ¾Ð·Ð´Ð°Ð½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!', 'success');
      setOperatorBindingModal(false);
      setSelectedOperatorForBinding('');
      setSelectedWarehouseForBinding('');
      fetchOperatorWarehouseBindings();
    } catch (error) {
      console.error('Create operator binding error:', error);
      const errorMessage = error.response?.data?.detail || 'ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¸';
      showAlert(errorMessage, 'error');
    }
  };

  // Warehouse cell and cargo detail functions
  const handleCellClick = async (warehouseId, locationCode) => {
    try {
      const cargoData = await apiCall(`/api/warehouse/${warehouseId}/cell/${locationCode}/cargo`);
      setSelectedCellCargo(cargoData);
      setCargoDetailModal(true);
    } catch (error) {
      if (error.response?.status === 404) {
        showAlert('Ð’ ÑÑ‚Ð¾Ð¹ ÑÑ‡ÐµÐ¹ÐºÐµ Ð½ÐµÑ‚ Ð³Ñ€ÑƒÐ·Ð°', 'info');
      } else {
        console.error('Error fetching cell cargo:', error);
        showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ', 'error');
      }
    }
  };

  const fetchCargoDetails = async (cargoId) => {
    try {
      const cargoData = await apiCall(`/api/cargo/${cargoId}/details`);
      return cargoData;
    } catch (error) {
      console.error('Error fetching cargo details:', error);
      throw error;
    }
  };

  const handleEditCargo = (cargo) => {
    setEditingCargo(cargo);
    setCargoEditForm({
      cargo_name: cargo.cargo_name || '',
      description: cargo.description || '',
      weight: cargo.weight || '',
      declared_value: cargo.declared_value || '',
      sender_full_name: cargo.sender_full_name || '',
      sender_phone: cargo.sender_phone || '',
      recipient_full_name: cargo.recipient_full_name || cargo.recipient_name || '',
      recipient_phone: cargo.recipient_phone || '',
      recipient_address: cargo.recipient_address || ''
    });
    setCargoEditModal(true);
  };

  const handleUpdateCargo = async () => {
    if (!editingCargo) return;

    try {
      await apiCall(`/api/cargo/${editingCargo.id}/update`, 'PUT', cargoEditForm);
      showAlert('Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð°!', 'success');
      setCargoEditModal(false);
      setEditingCargo(null);
      
      // ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ
      if (selectedCellCargo && selectedCellCargo.id === editingCargo.id) {
        const updatedCargo = await fetchCargoDetails(editingCargo.id);
        setSelectedCellCargo(updatedCargo);
      }
      
      // ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐºÐ¸ Ð³Ñ€ÑƒÐ·Ð¾Ð²
      fetchOperatorCargo();
      fetchAllCargo();
    } catch (error) {
      console.error('Update cargo error:', error);
    }
  };

  const handleMoveCargo = (cargo) => {
    setEditingCargo(cargo);
    setCargoMoveForm({
      warehouse_id: cargo.warehouse_id || '',
      block_number: cargo.block_number || '',
      shelf_number: cargo.shelf_number || '',
      cell_number: cargo.cell_number || ''
    });
    setCargoMoveModal(true);
  };

  const handleMoveCargoSubmit = async () => {
    if (!editingCargo) return;

    try {
      await apiCall(`/api/warehouse/cargo/${editingCargo.id}/move`, 'POST', cargoMoveForm);
      showAlert('Ð“Ñ€ÑƒÐ· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½!', 'success');
      setCargoMoveModal(false);
      setEditingCargo(null);
      
      // ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ
      fetchOperatorCargo();
      setCargoDetailModal(false);
    } catch (error) {
      console.error('Move cargo error:', error);
      const errorMessage = error.response?.data?.detail || 'ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°';
      showAlert(errorMessage, 'error');
    }
  };

  const handleRemoveCargoFromCell = async (cargo) => {
    if (window.confirm(`Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ· ${cargo.cargo_number} Ð¸Ð· ÑÑ‡ÐµÐ¹ÐºÐ¸?`)) {
      try {
        await apiCall(`/api/warehouse/cargo/${cargo.id}/remove`, 'DELETE');
        showAlert('Ð“Ñ€ÑƒÐ· ÑƒÐ´Ð°Ð»ÐµÐ½ Ð¸Ð· ÑÑ‡ÐµÐ¹ÐºÐ¸!', 'success');
        setCargoDetailModal(false);
        fetchOperatorCargo();
      } catch (error) {
        console.error('Remove cargo error:', error);
      }
    }
  };

  // Print transport cargo list
  const printTransportCargoList = (transport, cargoList) => {
    const printWindow = window.open('', '_blank');
    const totalWeight = cargoList.reduce((sum, cargo) => sum + cargo.weight, 0);
    
    printWindow.document.write(`
      <html>
        <head>
          <title>Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð³Ñ€ÑƒÐ·Ð¾Ð² - ${transport.transport_number}</title>
          <style>
            body { font-family: Arial, sans-serif; margin: 20px; font-size: 12px; }
            .header { text-align: center; margin-bottom: 20px; }
            .logo { font-size: 24px; font-weight: bold; color: #1f2937; margin-bottom: 10px; }
            .company { font-size: 18px; margin-bottom: 5px; }
            .title { font-size: 16px; font-weight: bold; margin: 20px 0; }
            .info-section { margin-bottom: 15px; padding: 10px; border: 1px solid #ccc; }
            .info-title { font-weight: bold; margin-bottom: 5px; }
            table { width: 100%; border-collapse: collapse; margin-top: 10px; }
            th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
            th { background-color: #f2f2f2; font-weight: bold; }
            .summary { margin-top: 20px; padding: 10px; background-color: #f9f9f9; border: 1px solid #ddd; }
            .footer { margin-top: 30px; text-align: center; font-size: 10px; color: #666; }
          </style>
        </head>
        <body>
          <div class="header">
            <div class="logo" style="text-align: center; margin-bottom: 10px;">
              <img src="/logo.png" alt="TAJLINE.TJ" style="height: 60px; width: auto; margin: 0 auto;" onerror="this.style.display='none'; this.nextSibling.style.display='block';" />
              <div style="display: none; font-size: 24px; font-weight: bold; color: #2563eb;">ðŸ“¦ TAJLINE.TJ</div>
            </div>
            <div class="company">ÐžÐžÐž "Ð¢Ð°Ð´Ð¶Ð»Ð°Ð¹Ð½"</div>
            <div class="title">Ð¡ÐŸÐ˜Ð¡ÐžÐš Ð“Ð Ð£Ð—ÐžÐ’ ÐÐ Ð¢Ð ÐÐÐ¡ÐŸÐžÐ Ð¢Ð•</div>
          </div>

          <div class="info-section">
            <div class="info-title">Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ðµ</div>
            <p><strong>ÐÐ¾Ð¼ÐµÑ€ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð°:</strong> ${transport.transport_number}</p>
            <p><strong>Ð’Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒ:</strong> ${transport.driver_name}</p>
            <p><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ:</strong> ${transport.driver_phone}</p>
            <p><strong>ÐÐ°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ:</strong> ${transport.direction}</p>
            <p><strong>Ð’Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ:</strong> ${transport.capacity_kg} ÐºÐ³</p>
            <p><strong>Ð”Ð°Ñ‚Ð° Ñ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ:</strong> ${new Date().toLocaleDateString('ru-RU')} ${new Date().toLocaleTimeString('ru-RU')}</p>
          </div>

          <table>
            <thead>
              <tr>
                <th>â„–</th>
                <th>ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°</th>
                <th>ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ</th>
                <th>Ð’ÐµÑ (ÐºÐ³)</th>
                <th>ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ</th>
                <th>ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ</th>
                <th>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</th>
                <th>ÐÐ´Ñ€ÐµÑ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸</th>
              </tr>
            </thead>
            <tbody>
              ${cargoList.map((cargo, index) => `
                <tr>
                  <td>${index + 1}</td>
                  <td><strong>${cargo.cargo_number}</strong></td>
                  <td>${cargo.cargo_name || 'Ð“Ñ€ÑƒÐ·'}</td>
                  <td>${cargo.weight}</td>
                  <td>${cargo.sender_full_name || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½'}<br><small>${cargo.sender_phone || ''}</small></td>
                  <td>${cargo.recipient_full_name || cargo.recipient_name}</td>
                  <td>${cargo.recipient_phone || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½'}</td>
                  <td>${cargo.recipient_address || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½'}</td>
                </tr>
              `).join('')}
            </tbody>
          </table>

          <div class="summary">
            <p><strong>Ð’ÑÐµÐ³Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²:</strong> ${cargoList.length} Ð¼ÐµÑÑ‚</p>
            <p><strong>ÐžÐ±Ñ‰Ð¸Ð¹ Ð²ÐµÑ:</strong> ${totalWeight} ÐºÐ³</p>
            <p><strong>Ð—Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð°:</strong> ${Math.round((totalWeight / transport.capacity_kg) * 100)}%</p>
            <p><strong>ÐžÑÑ‚Ð°Ñ‚Ð¾Ðº Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸:</strong> ${transport.capacity_kg - totalWeight} ÐºÐ³</p>
          </div>

          <div class="footer">
            <p>Ð­Ñ‚Ð¾Ñ‚ Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚ ÑÑ„Ð¾Ñ€Ð¼Ð¸Ñ€Ð¾Ð²Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ð¾Ð¹ 
              <img src="/logo.png" alt="TAJLINE.TJ" style="height: 16px; width: auto; vertical-align: middle; margin: 0 5px;" onerror="this.style.display='none'; this.nextSibling.style.display='inline';" />
              <span style="display: none; font-weight: bold;">TAJLINE.TJ</span>
            </p>
            <p>Ð”Ð°Ñ‚Ð° Ð¸ Ð²Ñ€ÐµÐ¼Ñ: ${new Date().toLocaleDateString('ru-RU')} ${new Date().toLocaleTimeString('ru-RU')}</p>
          </div>
        </body>
      </html>
    `);
    
    printWindow.document.close();
    printWindow.print();
  };

  // Print invoice for individual cargo - TAJLINE format
  const printInvoice = (cargo) => {
    // ÐŸÐ¾Ð¿Ñ‹Ñ‚ÐºÐ° Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð½Ð¾Ð²Ð¾Ðµ Ð¾ÐºÐ½Ð¾
    const printWindow = window.open('', '_blank');
    
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð»Ð¸ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¾ÐºÐ½Ð¾ (Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð¾ Ð±Ñ€Ð°ÑƒÐ·ÐµÑ€Ð¾Ð¼)
    if (!printWindow) {
      // Ð•ÑÐ»Ð¸ Ð¾ÐºÐ½Ð¾ Ð½Ðµ Ð¾Ñ‚ÐºÑ€Ñ‹Ð»Ð¾ÑÑŒ, Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð°Ð»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¼ÐµÑ‚Ð¾Ð´
      showAlert('Ð’ÑÐ¿Ð»Ñ‹Ð²Ð°ÑŽÑ‰Ð¸Ðµ Ð¾ÐºÐ½Ð° Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹. ÐÐ°ÐºÐ»Ð°Ð´Ð½Ð°Ñ Ð±ÑƒÐ´ÐµÑ‚ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð° Ð² Ð½Ð¾Ð²Ð¾Ð¹ Ð²ÐºÐ»Ð°Ð´ÐºÐµ.', 'warning');
      
      // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚ Ð´Ð»Ñ Ð¿ÐµÑ‡Ð°Ñ‚Ð¸
      const printContent = createInvoiceHTML(cargo);
      
      // ÐžÑ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð² Ð½Ð¾Ð²Ð¾Ð¹ Ð²ÐºÐ»Ð°Ð´ÐºÐµ Ñ data URL
      const dataUrl = `data:text/html;charset=utf-8,${encodeURIComponent(printContent)}`;
      window.open(dataUrl, '_blank');
      return;
    }
    
    try {
      const invoiceHTML = createInvoiceHTML(cargo);
      printWindow.document.write(invoiceHTML);
      printWindow.document.close();
    } catch (error) {
      console.error('Error creating print window:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð½Ð°ÐºÐ»Ð°Ð´Ð½Ð¾Ð¹. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.', 'error');
      if (printWindow) {
        printWindow.close();
      }
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ HTML Ð´Ð»Ñ Ð½Ð°ÐºÐ»Ð°Ð´Ð½Ð¾Ð¹
  const createInvoiceHTML = (cargo) => {
    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÑƒÑŽ Ð´Ð°Ñ‚Ñƒ Ð² Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚Ðµ dd.mm.yy
    const currentDate = new Date().toLocaleDateString('ru-RU', {
      day: '2-digit',
      month: '2-digit',
      year: '2-digit'
    });
    
    // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð¿ÑƒÐ½ÐºÑ‚ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñƒ
    const getDestination = (route) => {
      switch(route) {
        case 'moscow_dushanbe': return 'Ð”ÑƒÑˆÐ°Ð½Ð±Ðµ';
        case 'moscow_khujand': return 'Ð¥ÑƒÐ´Ð¶Ð°Ð½Ð´';
        case 'moscow_kulob': return 'ÐšÑƒÐ»Ð¾Ð±';
        case 'moscow_kurgantyube': return 'ÐšÑƒÑ€Ð³Ð°Ð½-Ð¢ÑŽÐ±Ðµ';
        default: return 'Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½';
      }
    };
    
    // ÐŸÐ¾Ð´Ð³Ð¾Ñ‚Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ð° Ð´Ð»Ñ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ñ‹
    let cargoItems = [];
    if (cargo.cargo_items && Array.isArray(cargo.cargo_items)) {
      // ÐœÑƒÐ»ÑŒÑ‚Ð¸-Ð³Ñ€ÑƒÐ·
      cargoItems = cargo.cargo_items.map(item => ({
        name: item.cargo_name || 'Ð¢Ð¾Ð²Ð°Ñ€',
        quantity: item.weight || 0,
        unit: 'ÐºÐ³',
        price: item.price_per_kg || 0,
        total: (item.weight || 0) * (item.price_per_kg || 0)
      }));
    } else {
      // ÐžÐ´Ð¸Ð½Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð³Ñ€ÑƒÐ·
      cargoItems = [{
        name: cargo.cargo_name || cargo.description || 'Ð¢Ð¾Ð²Ð°Ñ€',
        quantity: cargo.weight || 0,
        unit: 'ÐºÐ³', 
        price: cargo.price_per_kg || (cargo.total_cost || 0) / (cargo.weight || 1),
        total: cargo.total_cost || cargo.declared_value || 0
      }];
    }
    
    const totalWeight = cargoItems.reduce((sum, item) => sum + item.quantity, 0);
    const totalAmount = cargoItems.reduce((sum, item) => sum + item.total, 0);
    
    return `
      <html>
        <head>
          <title>ÐÐ°ÐºÐ»Ð°Ð´Ð½Ð°Ñ TAJLINE â„– ${cargo.cargo_number}</title>
          <meta charset="utf-8">
          <style>
            @page {
              size: A4;
              margin: 15mm;
            }
            
            body {
              font-family: Arial, sans-serif;
              margin: 0;
              padding: 0;
              font-size: 11px;
              line-height: 1.2;
              color: #000;
            }
            
            .invoice-container {
              max-width: 100%;
              margin: 0 auto;
            }
            
            .header {
              text-align: center;
              margin-bottom: 20px;
              border-bottom: 2px solid #000;
              padding-bottom: 15px;
            }
            
            .logo {
              font-size: 24px;
              font-weight: bold;
              letter-spacing: 2px;
              margin-bottom: 10px;
              color: #000;
            }
            
            .contacts {
              font-size: 9px;
              line-height: 1.3;
              color: #666;
              margin-bottom: 15px;
            }
            
            .invoice-number {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin-bottom: 15px;
            }
            
            .invoice-number .label {
              font-weight: bold;
              font-size: 12px;
            }
            
            .invoice-number .number-box,
            .invoice-number .date-box {
              border: 2px solid #000;
              padding: 8px 15px;
              font-weight: bold;
              font-size: 14px;
              min-width: 120px;
              text-align: center;
            }
            
            .info-row {
              display: flex;
              margin-bottom: 5px;
              border: 1px solid #000;
            }
            
            .info-cell {
              padding: 6px 8px;
              border-right: 1px solid #000;
              font-size: 10px;
            }
            
            .info-cell:last-child {
              border-right: none;
            }
            
            .info-cell.label {
              background-color: #f5f5f5;
              font-weight: bold;
              width: 15%;
              text-align: center;
            }
            
            .info-cell.wide {
              width: 35%;
            }
            
            .cargo-table {
              width: 100%;
              border-collapse: collapse;
              margin: 15px 0;
              border: 2px solid #000;
            }
            
            .cargo-table th,
            .cargo-table td {
              border: 1px solid #000;
              padding: 6px;
              text-align: center;
              font-size: 10px;
            }
            
            .cargo-table th {
              background-color: #f5f5f5;
              font-weight: bold;
            }
            
            .cargo-table .item-name {
              text-align: left;
            }
            
            .total-row {
              font-weight: bold;
              background-color: #f9f9f9;
            }
            
            .cargo-value {
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin: 15px 0;
              font-weight: bold;
              font-size: 12px;
            }
            
            .signatures {
              margin-top: 30px;
              display: flex;
              justify-content: space-between;
            }
            
            .signature-block {
              width: 30%;
              text-align: center;
              border-bottom: 1px solid #000;
              padding-bottom: 2px;
              margin-bottom: 5px;
            }
            
            .signature-label {
              font-size: 9px;
              margin-top: 5px;
            }
            
            .terms {
              font-size: 8px;
              line-height: 1.3;
              margin-top: 20px;
              border-top: 1px solid #ccc;
              padding-top: 10px;
            }
            
            .terms p {
              margin: 5px 0;
              text-align: justify;
            }
            
            @media print {
              body { -webkit-print-color-adjust: exact; }
              .no-print { display: none !important; }
            }
          </style>
        </head>
        <body>
          <div class="invoice-container">
            <!-- Header -->
            <div class="header">
              <div class="logo">TAJLINE</div>
              <div class="contacts">
                <strong>ÐÐ°ÑˆÐ¸ ÐºÐ¾Ð½Ñ‚Ð°ÐºÑ‚Ñ‹</strong><br>
                ÐœÐ¡Ðš: (968) 658-8858<br>
                ÐœÐ¡Ðš: (977) 904-8888<br>
                Ð¡ÐºÐ»Ð°Ð´ Ð² Ð¥ÑƒÐ´Ð¶Ð°Ð½Ð´Ðµ: +992 92 650 5001<br>
                Ð¡ÐºÐ»Ð°Ð´ Ð² Ð¥ÑƒÐ´Ð¶Ð°Ð½Ð´Ðµ: +992 92 913 2442<br>
                Ð¡ÐºÐ»Ð°Ð´ Ð² Ð”ÑƒÑˆÐ°Ð½Ð±Ðµ: +992 91 868 3313
              </div>
            </div>
            
            <!-- Invoice Number and Date -->
            <div class="invoice-number">
              <span class="label">ÐÐ°ÐºÐ»Ð°Ð´Ð½Ð°Ñ â„–</span>
              <div class="number-box">${cargo.cargo_number || 'N/A'}</div>
              <span class="label">Ð¾Ñ‚</span>
              <div class="date-box">${currentDate}</div>
            </div>
            
            <!-- Destination -->
            <div class="info-row">
              <div class="info-cell label">ÐŸÑƒÐ½ÐºÑ‚ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ</div>
              <div class="info-cell" style="flex: 1; text-align: center; font-weight: bold;">
                ${getDestination(cargo.route)}
              </div>
            </div>
            
            <!-- Sender and Recipient -->
            <div class="info-row">
              <div class="info-cell label">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ</div>
              <div class="info-cell wide">${cargo.sender_full_name || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½'}</div>
              <div class="info-cell label">ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ</div>
              <div class="info-cell wide">${cargo.recipient_full_name || cargo.recipient_name || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½'}</div>
            </div>
            
            <div class="info-row">
              <div class="info-cell label">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½</div>
              <div class="info-cell wide">${cargo.sender_phone || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½'}</div>
              <div class="info-cell label">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½</div>
              <div class="info-cell wide">${cargo.recipient_phone || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½'}</div>
            </div>
            
            <!-- Cargo Table -->
            <table class="cargo-table">
              <thead>
                <tr>
                  <th style="width: 5%;">â„–</th>
                  <th style="width: 35%;">ÐÐ°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°</th>
                  <th style="width: 15%;">ÐšÐ¾Ð»-Ð²Ð¾</th>
                  <th style="width: 10%;">Ð•Ð´.</th>
                  <th style="width: 15%;">Ð¦ÐµÐ½Ð° Ð·Ð° ÐºÐ³</th>
                  <th style="width: 20%;">Ð¡ÑƒÐ¼Ð¼Ð°</th>
                </tr>
              </thead>
              <tbody>
                ${cargoItems.map((item, index) => `
                  <tr>
                    <td>${index + 1}</td>
                    <td class="item-name">${item.name || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾'}</td>
                    <td>${item.quantity || 1}</td>
                    <td>${item.unit || 'ÑˆÑ‚'}</td>
                    <td>${(parseFloat(item.price) || 0).toFixed(2)}</td>
                    <td>${(parseFloat(item.total) || 0).toFixed(2)}</td>
                  </tr>
                `).join('')}
                <tr class="total-row">
                  <td colspan="2"><strong>Ð˜Ñ‚Ð¾Ð³Ð¾:</strong></td>
                  <td><strong>${totalWeight}</strong></td>
                  <td><strong>ÐºÐ³</strong></td>
                  <td></td>
                  <td><strong>${totalAmount.toFixed(2)} â‚½</strong></td>
                </tr>
              </tbody>
            </table>
            
            <!-- Volume -->
            <div style="text-align: right; margin: 10px 0;">
              <span style="border: 1px solid #000; padding: 5px 10px;">
                ÐºÑƒÐ±.Ð¼
              </span>
            </div>
            
            <!-- Signatures -->
            <div class="signatures">
              <div>
                <div class="signature-block"></div>
                <div class="signature-label">Ð¼.Ð¿.</div>
              </div>
              <div>
                <div class="signature-block"></div>
                <div class="signature-label"></div>
              </div>
              <div>
                <div class="signature-block">Ð¿Ð¾Ð´Ð¿Ð¸ÑÑŒ</div>
                <div class="signature-label"></div>
              </div>
            </div>
            
            <!-- Cargo Value -->
            <div class="cargo-value">
              <span>Ð¦ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ Ð³Ñ€ÑƒÐ·Ð°:</span>
              <span>${cargo.declared_value || totalAmount.toFixed(0)} Ñ€ÑƒÐ±.</span>
            </div>
            
            <!-- Terms -->
            <div class="terms">
              <p><strong>Ð£ÑÐ»Ð¾Ð²Ð¸Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ¸</strong></p>
              <p>1. Ð¡Ñ€Ð¾Ðº Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÐµÐ¼ Ð² ÐŸÑƒÐ½ÐºÑ‚Ðµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ ÑÐ¾ÑÑ‚Ð°Ð²Ð»ÑÐµÑ‚ 5 Ñ€Ð°Ð±Ð¾Ñ‡Ð¸Ñ… Ð´Ð½ÐµÐ¹ Ñ Ð¼Ð¾Ð¼ÐµÐ½Ñ‚Ð° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾Ð± ÑƒÑÐ¿ÐµÑˆÐ½Ð¾Ð¹ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐµ Ð² ÐŸÑƒÐ½ÐºÑ‚ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ. ÐŸÑ€Ð¸ Ð½ÐµÑÐ²Ð¾ÐµÐ²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾Ð¼ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ¾Ð¼ Ð²Ð¾Ð·Ð½Ð¸ÐºÐ°ÐµÑ‚ Ð¾Ð±ÑÐ·Ð°Ð½Ð½Ð¾ÑÑ‚ÑŒ Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ° ÑƒÐ¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ Ð´Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿ÐµÐ½Ð¸ Ð² Ñ€Ð°Ð·Ð¼ÐµÑ€Ðµ 0,1% Ð·Ð° ÐºÐ°Ð¶Ð´Ñ‹Ð¹ Ð´ÐµÐ½ÑŒ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐµÐ½Ð¸Ñ Ð¡Ñ€Ð¾ÐºÐ° Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð² ÐŸÑƒÐ½ÐºÑ‚Ðµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ</p>
              <p>2. ÐŸÑ€Ð¸ Ð²Ð¾Ð·Ð½Ð¸ÐºÐ½Ð¾Ð²ÐµÐ½Ð¸Ð¸ Ð¾Ð±ÑÑ‚Ð¾ÑÑ‚ÐµÐ»ÑŒÑÑ‚Ð² Ð½ÐµÐ¿Ñ€ÐµÐ¾Ð´Ð¾Ð»Ð¸Ð¼Ð¾Ð¹ ÑÐ¸Ð»Ñ‹ (Ñ‚Ð°ÐºÐ¸Ñ… ÐºÐ°Ðº: Ð¿Ð¾Ð¶Ð°Ñ€Ñ‹, Ð½Ð°Ð²Ð¾Ð´Ð½ÐµÐ½Ð¸Ñ, Ð·ÐµÐ¼Ð»ÐµÑ‚Ñ€ÑÑÐµÐ½Ð¸Ñ, Ð²Ð¾ÐµÐ½Ð½Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ Ð¸ Ð¿Ñ€.) Ð¸ Ð½ÐµÐ²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚Ð¸ ÑÐ¾Ñ…Ñ€Ð°Ð½ÐµÐ½Ð¸Ñ Ñ‚Ð¾Ð²Ð°Ñ€Ð¾Ð² Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ°, Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ Ð¾Ð±ÑÐ·ÑƒÐµÑ‚ÑÑ Ð²ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÑƒ Ð´ÐµÐ½ÐµÐ¶Ð½Ñ‹Ðµ ÑÑ€ÐµÐ´ÑÑ‚Ð²Ð° Ð² Ñ€Ð°Ð·Ð¼ÐµÑ€Ðµ, Ñ‚Ñ€Ñ‘Ñ…ÐºÑ€Ð°Ñ‚Ð½Ð¾ Ð¿Ñ€ÐµÐ²Ñ‹ÑˆÐ°ÑŽÑ‰ÐµÐ¼ ÑÑƒÐ¼Ð¼Ñƒ, Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð½ÑƒÑŽ Ð—Ð°ÐºÐ°Ð·Ñ‡Ð¸ÐºÐ¾Ð¼ Ð·Ð° Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÑƒ Ñ‚Ð¾Ð²Ð°Ñ€Ð° Ð¿Ð¾ ÐÐ°ÐºÐ»Ð°Ð´Ð½Ð¾Ð¹ â„– ${cargo.cargo_number || 'N/A'}.</p>
            </div>
          </div>
          
          <script>
            window.onload = function() {
              setTimeout(function() {
                window.print();
                window.onafterprint = function() {
                  window.close();
                };
              }, 500);
            };
          </script>
        </body>
      </html>
    `;
  };

  const handleDeleteOperatorBinding = async (bindingId) => {
    if (window.confirm('Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÑ‚Ñƒ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÑƒ?')) {
      try {
        await apiCall(`/api/admin/operator-warehouse-binding/${bindingId}`, 'DELETE');
        showAlert('ÐŸÑ€Ð¸Ð²ÑÐ·ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!', 'success');
        fetchOperatorWarehouseBindings();
      } catch (error) {
        console.error('Delete operator binding error:', error);
      }
    }
  };

  // QR Code functions
  const getCargoQrCode = async (cargoId) => {
    try {
      const data = await apiCall(`/api/cargo/${cargoId}/qr-code`);
      return data.qr_code;
    } catch (error) {
      console.error('Error getting cargo QR code:', error);
      return null;
    }
  };

  const getCellQrCode = async (warehouseId, block, shelf, cell) => {
    try {
      const data = await apiCall(`/api/warehouse/${warehouseId}/cell-qr/${block}/${shelf}/${cell}`);
      return data.qr_code;
    } catch (error) {
      console.error('Error getting cell QR code:', error);
      return null;
    }
  };

  const handleQrScan = async (qrText) => {
    try {
      const data = await apiCall('/api/qr/scan', 'POST', { qr_text: qrText });
      setQrScanResult(data);
      setQrScannerModal(false);
      showAlert('QR ÐºÐ¾Ð´ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¾Ñ‚ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½!', 'success');
    } catch (error) {
      console.error('QR scan error:', error);
      setQrScanResult(null);
    }
  };

  const printCargoQrLabel = async (cargo) => {
    try {
      const qrCode = await getCargoQrCode(cargo.id);
      if (!qrCode) {
        showAlert('ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¿Ð¾Ð»ÑƒÑ‡Ð¸Ñ‚ÑŒ QR ÐºÐ¾Ð´', 'error');
        return;
      }

      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>QR Ð­Ñ‚Ð¸ÐºÐµÑ‚ÐºÐ° - ${cargo.cargo_number}</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
              .qr-label { border: 2px solid #000; padding: 20px; margin: 20px auto; width: 300px; }
              .qr-code { margin: 20px 0; }
              .cargo-info { font-size: 14px; font-weight: bold; margin: 10px 0; }
              .cargo-details { font-size: 12px; margin: 5px 0; }
            </style>
          </head>
          <body>
            <div class="qr-label">
              <div style="text-align: center; margin-bottom: 15px;">
                <img src="/logo.png" alt="TAJLINE.TJ" style="height: 40px; width: auto;" onerror="this.style.display='none'; this.nextSibling.style.display='block';" />
                <div style="display: none; font-weight: bold; color: #2563eb; font-size: 18px;">TAJLINE.TJ</div>
              </div>
              <div class="cargo-info">Ð“Ð Ð£Ð— â„–${cargo.cargo_number}</div>
              <div class="qr-code">
                <img src="${qrCode}" alt="QR Code" style="width: 150px; height: 150px;" />
              </div>
              <div class="cargo-details">
                <div><strong>ÐÐ°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ:</strong> ${cargo.cargo_name || 'Ð“Ñ€ÑƒÐ·'}</div>
                <div><strong>Ð’ÐµÑ:</strong> ${cargo.weight} ÐºÐ³</div>
                <div><strong>ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ:</strong> ${cargo.recipient_full_name || cargo.recipient_name}</div>
              </div>
            </div>
          </body>
        </html>
      `);
      
      printWindow.document.close();
      printWindow.print();
    } catch (error) {
      console.error('Error printing QR label:', error);
    }
  };

  const printWarehouseCellsQr = async (warehouse) => {
    try {
      const data = await apiCall(`/api/warehouse/${warehouse.id}/all-cells-qr`);
      
      const printWindow = window.open('', '_blank');
      printWindow.document.write(`
        <html>
          <head>
            <title>QR ÐšÐ¾Ð´Ñ‹ ÑÑ‡ÐµÐµÐº - ${data.warehouse_name}</title>
            <style>
              body { font-family: Arial, sans-serif; margin: 10px; }
              .header { text-align: center; margin-bottom: 20px; }
              .qr-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
              .qr-cell { border: 1px solid #ccc; padding: 10px; text-align: center; page-break-inside: avoid; }
              .qr-code { margin: 10px 0; }
              .cell-info { font-size: 12px; font-weight: bold; }
              @media print { .qr-grid { grid-template-columns: repeat(3, 1fr); } }
            </style>
          </head>
          <body>
            <div class="header">
              <h2>QR ÐšÐ¾Ð´Ñ‹ ÑÑ‡ÐµÐµÐº ÑÐºÐ»Ð°Ð´Ð° "${data.warehouse_name}"</h2>
              <p>Ð’ÑÐµÐ³Ð¾ ÑÑ‡ÐµÐµÐº: ${data.total_cells}</p>
            </div>
            <div class="qr-grid">
              ${data.qr_codes.map(cell => `
                <div class="qr-cell">
                  <div class="cell-info">${cell.location}</div>
                  <div class="qr-code">
                    <img src="${cell.qr_code}" alt="QR Code" style="width: 80px; height: 80px;" />
                  </div>
                  <div class="cell-info">${data.warehouse_name}</div>
                </div>
              `).join('')}
            </div>
          </body>
        </html>
      `);
      
      printWindow.document.close();
      printWindow.print();
    } catch (error) {
      console.error('Error printing warehouse QR codes:', error);
    }
  };

  // Arrived Transport Functions
  const fetchArrivedTransports = async () => {
    try {
      const data = await apiCall('/api/transport/arrived');
      setArrivedTransports(data);
    } catch (error) {
      console.error('Error fetching arrived transports:', error);
    }
  };

  const fetchArrivedTransportCargo = async (transportId) => {
    try {
      const data = await apiCall(`/api/transport/${transportId}/arrived-cargo`);
      setArrivedCargoList(data);
    } catch (error) {
      console.error('Error fetching arrived cargo:', error);
    }
  };

  const handleMarkTransportArrived = async (transportId) => {
    if (window.confirm('ÐžÑ‚Ð¼ÐµÑ‚Ð¸Ñ‚ÑŒ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ ÐºÐ°Ðº Ð¿Ñ€Ð¸Ð±Ñ‹Ð²ÑˆÐ¸Ð¹?')) {
      try {
        await apiCall(`/api/transport/${transportId}/arrive`, 'POST');
        showAlert('Ð¢Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ Ð¾Ñ‚Ð¼ÐµÑ‡ÐµÐ½ ÐºÐ°Ðº Ð¿Ñ€Ð¸Ð±Ñ‹Ð²ÑˆÐ¸Ð¹!', 'success');
        fetchTransports();
        fetchArrivedTransports();
      } catch (error) {
        console.error('Error marking transport as arrived:', error);
        showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚Ð¼ÐµÑ‚ÐºÐµ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð° ÐºÐ°Ðº Ð¿Ñ€Ð¸Ð±Ñ‹Ð²ÑˆÐµÐ³Ð¾', 'error');
      }
    }
  };

  const handlePlaceCargoFromTransport = async (e) => {
    e.preventDefault();
    try {
      const placementData = {
        cargo_id: selectedCargoForWarehouse.id,
        warehouse_id: placementForm.warehouse_id,
        block_number: parseInt(placementForm.block_number),
        shelf_number: parseInt(placementForm.shelf_number),
        cell_number: parseInt(placementForm.cell_number)
      };

      const response = await apiCall(`/api/transport/${selectedArrivedTransport.id}/place-cargo-to-warehouse`, 'POST', placementData);
      
      showAlert(`Ð“Ñ€ÑƒÐ· ${response.cargo_number} ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ ${response.warehouse_name} Ð² ÑÑ‡ÐµÐ¹ÐºÐµ ${response.location}!`, 'success');
      
      // ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ
      fetchArrivedTransportCargo(selectedArrivedTransport.id);
      fetchArrivedTransports();
      
      // Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¼Ð¾Ð´Ð°Ð» Ð¸ ÑÐ±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ñƒ
      setCargoPlacementModal(false);
      setSelectedCargoForWarehouse(null);
      setPlacementForm({
        warehouse_id: '',
        block_number: 1,
        shelf_number: 1,
        cell_number: 1
      });
      
      if (response.transport_status === 'completed') {
        showAlert('Ð’ÑÐµ Ð³Ñ€ÑƒÐ·Ñ‹ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ñ‹! Ð¢Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½.', 'info');
        setArrivedTransportModal(false);
      }
    } catch (error) {
      console.error('Error placing cargo:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð° Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ', 'error');
    }
  };

  // Transport Visualization Functions
  const fetchTransportVisualization = async (transportId) => {
    try {
      const data = await apiCall(`/api/transport/${transportId}/visualization`);
      setTransportVisualizationData(data);
    } catch (error) {
      console.error('Error fetching transport visualization:', error);
    }
  };

  const openTransportVisualization = (transport) => {
    setSelectedTransportForVisualization(transport);
    fetchTransportVisualization(transport.id);
    setTransportVisualizationModal(true);
  };

  // QR/Number Cargo Placement Functions
  const handleQrCargoPlacement = async (e) => {
    e.preventDefault();
    try {
      const placementData = {
        cargo_number: qrPlacementForm.cargo_number,
        qr_data: qrPlacementForm.qr_data,
        cell_qr_data: qrPlacementForm.cell_qr_data,
        block_number: parseInt(qrPlacementForm.block_number),
        shelf_number: parseInt(qrPlacementForm.shelf_number),
        cell_number: parseInt(qrPlacementForm.cell_number)
      };

      const response = await apiCall(`/api/transport/${selectedArrivedTransport.id}/place-cargo-by-number`, 'POST', placementData);
      
      showAlert(
        `Ð“Ñ€ÑƒÐ· ${response.cargo_number} Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ ${response.warehouse_name} Ð² ÑÑ‡ÐµÐ¹ÐºÐµ ${response.location}! ${response.warehouse_auto_selected ? 'Ð¡ÐºÐ»Ð°Ð´ Ð²Ñ‹Ð±Ñ€Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸.' : ''}`, 
        'success'
      );
      
      // ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ
      fetchArrivedTransportCargo(selectedArrivedTransport.id);
      fetchArrivedTransports();
      
      // Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¼Ð¾Ð´Ð°Ð» Ð¸ ÑÐ±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ñƒ
      setQrPlacementModal(false);
      setQrPlacementForm({
        cargo_number: '',
        qr_data: '',
        cell_qr_data: '',
        block_number: 1,
        shelf_number: 1,
        cell_number: 1
      });
      
      if (response.transport_status === 'completed') {
        showAlert('Ð’ÑÐµ Ð³Ñ€ÑƒÐ·Ñ‹ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ñ‹! Ð¢Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ Ð·Ð°Ð²ÐµÑ€ÑˆÐµÐ½.', 'info');
        setArrivedTransportModal(false);
      }
    } catch (error) {
      console.error('Error placing cargo by QR/number:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð° Ð¿Ð¾ Ð½Ð¾Ð¼ÐµÑ€Ñƒ/QR', 'error');
    }
  };

  // Operator Functions
  const fetchOperatorWarehouses = async () => {
    try {
      const data = await apiCall('/api/operator/warehouses');  // ÐžÐ±Ð½Ð¾Ð²Ð»ÐµÐ½Ð½Ñ‹Ð¹ ÑÐ½Ð´Ð¿Ð¾Ð¸Ð½Ñ‚
      setOperatorWarehouses(data || []);
    } catch (error) {
      console.error('Error fetching operator warehouses:', error);
    }
  };

  // ÐÐžÐ’ÐÐ¯ Ð¤Ð£ÐÐšÐ¦Ð˜Ð¯: ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÐºÐ»Ð°Ð´Ð¾Ð² Ð¿Ð¾ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ñƒ
  const fetchWarehousesByRoute = async (route) => {
    try {
      const data = await apiCall(`/api/warehouses/by-route/${route}`);
      return data || [];
    } catch (error) {
      console.error('Error fetching warehouses by route:', error);
      return [];
    }
  };

  // ÐÐžÐ’ÐÐ¯ Ð¤Ð£ÐÐšÐ¦Ð˜Ð¯: Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÐ¿Ð¸ÑÐºÐ° Ð·Ð°Ð´Ð¾Ð»Ð¶Ð½Ð¸ÐºÐ¾Ð² Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð°
  const fetchDebtorsList = async () => {
    if (user?.role !== 'admin') return;
    
    try {
      const data = await apiCall('/api/admin/debts');
      setDebtorsList(data || []);
    } catch (error) {
      console.error('Error fetching debtors list:', error);
    }
  };

  // Ð¤ÐÐ—Ð 3: Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜ Ð”Ð›Ð¯ ÐÐÐÐ›Ð˜Ð¢Ð˜ÐšÐ˜ Ð˜ Ð¡Ð¥Ð•ÐœÐ« Ð¡ÐšÐ›ÐÐ”ÐžÐ’
  
  // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½Ð¾Ð³Ð¾ ÑÐºÐ»Ð°Ð´Ð°
  const fetchWarehouseSpecificAnalytics = async (warehouseId) => {
    try {
      const data = await apiCall(`/api/warehouse/${warehouseId}/analytics`);
      return data || {};
    } catch (error) {
      console.error('Error fetching warehouse analytics:', error);
      return {};
    }
  };

  // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ ÑÑ…ÐµÐ¼Ñ‹ ÑÑ‡ÐµÐµÐº ÑÐºÐ»Ð°Ð´Ð°
  const fetchWarehouseCells = async (warehouseId) => {
    try {
      const data = await apiCall(`/api/warehouse/${warehouseId}/cells`);
      setWarehouseCells(data || []);
      return data || [];
    } catch (error) {
      console.error('Error fetching warehouse cells:', error);
      setWarehouseCells([]);
      return [];
    }
  };

  // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð¾Ð² ÑÐºÐ»Ð°Ð´Ð° Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°Ñ… Ð´Ð»Ñ Ñ†Ð²ÐµÑ‚Ð¾Ð²Ð¾Ð³Ð¾ ÐºÐ¾Ð´Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
  const fetchWarehouseCargoWithClients = async (warehouseId) => {
    try {
      const data = await apiCall(`/api/warehouse/${warehouseId}/cargo-with-clients`);
      return data || {};
    } catch (error) {
      console.error('Error fetching warehouse cargo with clients:', error);
      return {};
    }
  };

  // Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑÑ…ÐµÐ¼Ñ‹ ÑÑ‡ÐµÐµÐº Ð´Ð»Ñ Ð²Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ð¸ Ñ Ñ†Ð²ÐµÑ‚Ð¾Ð²Ð¾Ð¹ Ð¼Ð°Ñ€ÐºÐ¸Ñ€Ð¾Ð²ÐºÐ¾Ð¹ Ð¿Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°Ð¼
  const generateWarehouseScheme = async (warehouse) => {
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð¾Ð±ÑŠÐµÐºÑ‚ ÑÐºÐ»Ð°Ð´Ð° ÑÑƒÑ‰ÐµÑÑ‚Ð²ÑƒÐµÑ‚
    if (!warehouse || typeof warehouse !== 'object') {
      console.error('generateWarehouseScheme: Invalid warehouse object:', warehouse);
      return [];
    }
    
    const blocks = warehouse.blocks_count || 3;
    const shelves_per_block = warehouse.shelves_per_block || 4; // ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð»Ð¾Ðº Ð½Ð° Ð±Ð»Ð¾Ðº
    const cells_per_shelf = warehouse.cells_per_shelf || 5; // ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ‡ÐµÐµÐº Ð½Ð° Ð¿Ð¾Ð»ÐºÑƒ
    const cellsPerBlock = shelves_per_block * cells_per_shelf; // ÐžÐ±Ñ‰ÐµÐµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ‡ÐµÐµÐº Ð½Ð° Ð±Ð»Ð¾Ðº
    
    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾ Ð³Ñ€ÑƒÐ·Ð°Ñ… ÑÐºÐ»Ð°Ð´Ð° Ñ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¾Ð¹ Ð¿Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°Ð¼
    const warehouseCargoData = await fetchWarehouseCargoWithClients(warehouse.id);
    const { sender_groups = {}, recipient_groups = {}, color_assignments = {} } = warehouseCargoData;
    
    const scheme = [];
    
    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ ÑÑ…ÐµÐ¼Ñƒ Ð±Ð»Ð¾ÐºÐ¾Ð²
    for (let block = 1; block <= blocks; block++) {
      const blockCells = [];
      
      for (let shelf = 1; shelf <= shelves_per_block; shelf++) {
        for (let cell = 1; cell <= cells_per_shelf; cell++) {
          const cellNumber = (shelf - 1) * cells_per_shelf + cell;
          const cellId = `${warehouse.id}-${block}-${shelf}-${cell}`;
          
          // Ð˜Ð¼Ð¸Ñ‚Ð¸Ñ€ÑƒÐµÐ¼ Ð·Ð°Ð½ÑÑ‚Ð¾ÑÑ‚ÑŒ ÑÑ‡ÐµÐµÐº (Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¼ Ð¿Ñ€Ð¾ÐµÐºÑ‚Ðµ ÑÑ‚Ð¾ Ð±ÑƒÐ´ÐµÑ‚ Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…)
          const isOccupied = Math.random() < 0.6; // 60% Ð²ÐµÑ€Ð¾ÑÑ‚Ð½Ð¾ÑÑ‚ÑŒ Ð·Ð°Ð½ÑÑ‚Ð¾ÑÑ‚Ð¸
          
          let cellData = {
            id: cellId,
            block_number: block,
            shelf_number: shelf,
            cell_number: cell,
            cell_position: cellNumber,
            is_occupied: isOccupied,
            position: {
              row: shelf,
              col: cell
            }
          };

          if (isOccupied) {
            // Ð’Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ð¹ Ð³Ñ€ÑƒÐ· Ð¸Ð· Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐºÐ»Ð°Ð´Ð°
            const allCargo = warehouseCargoData.cargo || [];
            
            if (allCargo.length > 0) {
              const randomCargo = allCargo[Math.floor(Math.random() * allCargo.length)];
              
              // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° (Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ Ð¸Ð»Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ)
              const senderKey = `${randomCargo.sender_full_name || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½'}-${randomCargo.sender_phone || ''}`;
              const recipientKey = `${randomCargo.recipient_full_name || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½'}-${randomCargo.recipient_phone || ''}`;
              
              let clientGroup = null;
              let groupType = 'single';
              
              // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð¿Ñ€Ð¸Ð½Ð°Ð´Ð»ÐµÐ¶Ð¸Ñ‚ Ð»Ð¸ Ð³Ñ€ÑƒÐ· Ðº Ð³Ñ€ÑƒÐ¿Ð¿Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ¹
              if (sender_groups[senderKey] && sender_groups[senderKey].is_group) {
                clientGroup = sender_groups[senderKey];
                groupType = 'sender';
              }
              // Ð•ÑÐ»Ð¸ Ð½Ðµ Ð² Ð³Ñ€ÑƒÐ¿Ð¿Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ¹, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð³Ñ€ÑƒÐ¿Ð¿Ñƒ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÐµÐ¹
              else if (recipient_groups[recipientKey] && recipient_groups[recipientKey].is_group) {
                clientGroup = recipient_groups[recipientKey];
                groupType = 'recipient';
              }
              
              cellData = {
                ...cellData,
                cargo_number: randomCargo.cargo_number || `TEMP-${Date.now()}`,
                cargo_sender: randomCargo.sender_full_name || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½',
                cargo_sender_phone: randomCargo.sender_phone || '',
                cargo_recipient: randomCargo.recipient_full_name || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½',
                cargo_recipient_phone: randomCargo.recipient_phone || '',
                cargo_weight: randomCargo.weight || 0,
                cargo_value: randomCargo.declared_value || randomCargo.total_cost || 0,
                clientGroup: clientGroup,
                groupType: groupType,
                hasRelatedCargo: clientGroup !== null,
                relatedCargo: clientGroup ? {
                  groupType: groupType,
                  client_name: groupType === 'sender' ? clientGroup.sender_full_name : clientGroup.recipient_full_name,
                  client_phone: groupType === 'sender' ? clientGroup.sender_phone : clientGroup.recipient_phone,
                  totalCargo: clientGroup.cargo_list.length,
                  cargoNumbers: clientGroup.cargo_list.map(c => c.cargo_number),
                  cargoDetails: clientGroup.cargo_list
                } : null
              };
            } else {
              // Fallback Ð´Ð°Ð½Ð½Ñ‹Ðµ ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ Ñ€ÐµÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð²
              cellData = {
                ...cellData,
                cargo_number: `TEMP-${Date.now()}-${cellNumber}`,
                cargo_sender: `ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ ${cellNumber}`,
                cargo_recipient: `ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ ${cellNumber}`,
                hasRelatedCargo: false
              };
            }
          }
          
          blockCells.push(cellData);
        }
      }
      
      scheme.push({
        block_number: block,
        cells: blockCells,
        total_cells: cellsPerBlock,
        occupied_cells: blockCells.filter(c => c.is_occupied).length
      });
    }
    
    return scheme;
  };

  // Ð¤ÐÐ—Ð 4: Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜ Ð”Ð›Ð¯ Ð£ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð¯ Ð“Ð Ð£Ð—ÐžÐœ

  // ÐŸÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° Ð² Ð´Ñ€ÑƒÐ³ÑƒÑŽ ÑÑ‡ÐµÐ¹ÐºÑƒ
  const handleMoveCargoToCell = async (cargoId, newCellId) => {
    try {
      const data = await apiCall(`/api/cargo/${cargoId}/move`, 'POST', { new_cell_id: newCellId });
      console.log('Ð“Ñ€ÑƒÐ· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½!');
      return true;
    } catch (error) {
      console.error('Error moving cargo:', error);
      return false;
    }
  };

  // Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ñ‚Ð¾Ð²Ð°Ñ€Ð°
  const handleReturnCargo = async (cargoId, returnReason) => {
    try {
      const data = await apiCall(`/api/cargo/${cargoId}/return`, 'POST', { reason: returnReason });
      console.log('Ð“Ñ€ÑƒÐ· Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½ Ð½Ð° Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚!');
      return true;
    } catch (error) {
      console.error('Error returning cargo:', error);
      return false;
    }
  };

  // Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° Ð½Ð° Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ (ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¸Ð· ÑÑ‡ÐµÐ¹ÐºÐ¸)
  const handleMoveCargoToTransport = async (cargoId, transportId) => {
    try {
      const data = await apiCall(`/api/cargo/${cargoId}/place-transport`, 'POST', { transport_id: transportId });
      console.log('Ð“Ñ€ÑƒÐ· Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½ Ð½Ð° Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚!');
      return true;
    } catch (error) {
      console.error('Error placing cargo on transport:', error);
      return false;
    }
  };

  // ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÐ½Ð° ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð¾Ð¼
  const openCargoManagementModal = async (cargoInfo) => {
    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ Ñ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð¾ ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð°Ñ…
    const detailedCargo = {
      ...cargoInfo,
      cargo_number: cargoInfo.cargo_number || `CRG${Date.now()}`,
      status: 'placed',
      payment_status: cargoInfo.cargo_value > 0 ? 'paid' : 'pending',
      payment_method: 'cash',
      payment_amount: cargoInfo.cargo_value || 1500.0,
      weight: cargoInfo.cargo_weight || 15.5,
      sender: {
        full_name: cargoInfo.cargo_sender || 'Ð˜Ð²Ð°Ð½Ð¾Ð² Ð˜Ð²Ð°Ð½ Ð˜Ð²Ð°Ð½Ð¾Ð²Ð¸Ñ‡',
        phone: cargoInfo.cargo_sender_phone || '+79991234567',
        address: 'Ð³. ÐœÐ¾ÑÐºÐ²Ð°, ÑƒÐ». ÐšÑ€Ð°ÑÐ½Ð°Ñ Ð¿Ð»Ð¾Ñ‰Ð°Ð´ÑŒ, Ð´. 1',
        email: 'sender@example.com'
      },
      recipient: {
        full_name: cargoInfo.cargo_recipient || 'ÐŸÐµÑ‚Ñ€Ð¾Ð² ÐŸÐµÑ‚Ñ€ ÐŸÐµÑ‚Ñ€Ð¾Ð²Ð¸Ñ‡',
        phone: cargoInfo.cargo_recipient_phone || '+992987654321',
        address: 'Ð³. Ð”ÑƒÑˆÐ°Ð½Ð±Ðµ, Ð¿Ñ€. Ð ÑƒÐ´Ð°ÐºÐ¸, Ð´. 10',
        email: 'recipient@example.com'
      },
      // Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð°Ñ… Ð¾Ñ‚ Ñ‚Ð¾Ð³Ð¾ Ð¶Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ/Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ
      relatedCargo: cargoInfo.hasRelatedCargo && cargoInfo.relatedCargo ? {
        ...cargoInfo.relatedCargo,
        // Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð´ÐµÑ‚Ð°Ð»Ð¸ Ð¾ ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð°Ñ… Ñ Ð¸Ñ… Ð¼ÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸ÐµÐ¼
        detailedCargoList: cargoInfo.relatedCargo.cargoDetails ? cargoInfo.relatedCargo.cargoDetails.map(relatedItem => ({
          cargo_number: relatedItem.cargo_number,
          weight: relatedItem.weight || 0,
          value: relatedItem.declared_value || relatedItem.total_cost || 0,
          // Ð¡Ð¸Ð¼ÑƒÐ»Ð¸Ñ€ÑƒÐµÐ¼ Ð¼ÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ (Ð² Ñ€ÐµÐ°Ð»ÑŒÐ½Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ðµ ÑÑ‚Ð¾ Ð±ÑƒÐ´ÐµÑ‚ Ð¸Ð· Ð±Ð°Ð·Ñ‹ Ð´Ð°Ð½Ð½Ñ‹Ñ…)
          location: relatedItem.warehouse_location ? {
            warehouse: relatedItem.warehouse_location,
            block: Math.floor(Math.random() * 7) + 1,
            shelf: Math.floor(Math.random() * 3) + 1,
            cell: Math.floor(Math.random() * 10) + 1,
            status: 'placed'
          } : {
            warehouse: 'Ð’ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ',
            status: 'pending',
            payment_status: relatedItem.payment_status || 'paid'
          }
        })) : []
      } : null,
      location: {
        warehouse_name: 'Ð¡ÐºÐ»Ð°Ð´ â„–2 Ð¥ÑƒÐ´Ð¶Ð°Ð½Ð´',
        block: cargoInfo.block_number || 1,
        shelf: cargoInfo.shelf_number || 1, 
        cell: cargoInfo.cell_number || 1
      },
      // Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð´Ð²Ð¸Ð¶ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°
      history: [
        { date: new Date().toISOString().split('T')[0], action: 'ÐŸÑ€Ð¸Ð½ÑÑ‚ Ðº Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐµ', user: 'ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ ÑÐºÐ»Ð°Ð´Ð°' },
        { date: new Date(Date.now() - 86400000).toISOString().split('T')[0], action: 'Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ', user: 'ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ ÑÐºÐ»Ð°Ð´Ð°' },
        { date: new Date(Date.now() - 172800000).toISOString().split('T')[0], action: 'Ð“Ñ€ÑƒÐ· ÑÐ¾Ð·Ð´Ð°Ð½', user: 'Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð°' }
      ]
    };
    
    setSelectedCargoForManagement(detailedCargo);
    setShowCargoManagementModal(true);
  };

  // ÐÐžÐ’Ð«Ð• Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜ Ð”Ð›Ð¯ ÐÐÐÐ›Ð˜Ð¢Ð˜ÐšÐ˜ Ð˜ ÐžÐ¢Ð§Ð•Ð¢ÐžÐ’

  // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð¿Ð¾ ÑÐºÐ»Ð°Ð´Ñƒ
  const fetchWarehouseReport = async (warehouseId) => {
    try {
      const data = await apiCall(`/api/warehouse/${warehouseId}/report`);
      return data || [];
    } catch (error) {
      console.error('Error fetching warehouse report:', error);
      return [];
    }
  };

  // ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ðµ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ ÑÐºÐ»Ð°Ð´Ð°
  const fetchWarehouseDetailedAnalytics = async (warehouseId) => {
    try {
      const data = await apiCall(`/api/warehouse/${warehouseId}/detailed-analytics`);
      return data || {};
    } catch (error) {
      console.error('Error fetching warehouse detailed analytics:', error);
      return {};
    }
  };

  // ÐžÑ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð¿Ð¾ ÑÐºÐ»Ð°Ð´Ñƒ
  const openWarehouseReport = async (warehouse) => {
    setShowWarehouseReport(warehouse.id);
    
    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° (ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ñ)
    const reportData = generateWarehouseReportData(warehouse);
    setWarehouseReportData(reportData);
    
    // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÑƒ (ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ñ)
    const analytics = generateWarehouseAnalytics(warehouse);
    setWarehouseDetailedAnalytics(prev => ({
      ...prev,
      [warehouse.id]: analytics
    }));
  };

  // Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° Ð¿Ð¾ ÑÐºÐ»Ð°Ð´Ñƒ (ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ñ)
  const generateWarehouseReportData = (warehouse) => {
    const reportData = [];
    const senders = [
      { name: 'Ð˜Ð²Ð°Ð½Ð¾Ð² Ð˜Ð²Ð°Ð½ Ð˜Ð²Ð°Ð½Ð¾Ð²Ð¸Ñ‡', phone: '+79991234567' },
      { name: 'ÐŸÐµÑ‚Ñ€Ð¾Ð²Ð° ÐœÐ°Ñ€Ð¸Ñ Ð¡ÐµÑ€Ð³ÐµÐµÐ²Ð½Ð°', phone: '+79887654321' },
      { name: 'Ð¡Ð¸Ð´Ð¾Ñ€Ð¾Ð² ÐŸÐµÑ‚Ñ€ ÐÐ¸ÐºÐ¾Ð»Ð°ÐµÐ²Ð¸Ñ‡', phone: '+79776543210' },
      { name: 'ÐšÐ¾Ð·Ð»Ð¾Ð²Ð° ÐÐ½Ð½Ð° Ð’Ð»Ð°Ð´Ð¸Ð¼Ð¸Ñ€Ð¾Ð²Ð½Ð°', phone: '+79665432109' }
    ];
    
    const recipients = [
      { name: 'Ð Ð°Ñ…Ð¸Ð¼Ð¾Ð² Ð¤Ð°Ñ€Ñ…Ð¾Ð´ ÐÐ»Ð¸ÐµÐ²Ð¸Ñ‡', phone: '+992987654321' },
      { name: 'ÐÐ°Ð·Ð°Ñ€Ð¾Ð²Ð° Ð“ÑƒÐ»Ñ ÐœÐ°Ñ…Ð¼ÑƒÐ´Ð¾Ð²Ð½Ð°', phone: '+992988765432' },
      { name: 'Ð˜ÑÐ¼Ð°Ñ‚Ð¾Ð² Ð¡Ð°Ð½Ð¶Ð°Ñ€ Ð ÑƒÑÑ‚Ð°Ð¼Ð¾Ð²Ð¸Ñ‡', phone: '+992987123456' },
      { name: 'Ð®ÑÑƒÐ¿Ð¾Ð²Ð° Ð”Ð¸Ð»Ð¾Ñ€Ð¾Ð¼ ÐšÐ°Ñ€Ð¸Ð¼Ð¾Ð²Ð½Ð°', phone: '+992986543210' }
    ];
    
    const cargoTypes = ['Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹', 'Ð­Ð»ÐµÐºÑ‚Ñ€Ð¾Ð½Ð¸ÐºÐ°', 'ÐžÐ´ÐµÐ¶Ð´Ð°', 'ÐŸÑ€Ð¾Ð´ÑƒÐºÑ‚Ñ‹ Ð¿Ð¸Ñ‚Ð°Ð½Ð¸Ñ', 'ÐšÐ¾ÑÐ¼ÐµÑ‚Ð¸ÐºÐ°', 'Ð˜Ð³Ñ€ÑƒÑˆÐºÐ¸'];
    const paymentStatuses = ['ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½Ð¾', 'ÐŸÐµÑ€ÐµÐ²Ð¾Ð´ Ð½Ð° ÐºÐ°Ñ€Ñ‚Ñƒ', 'ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸', 'ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð² Ð´Ð¾Ð»Ð³'];
    const routes = ['ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð”ÑƒÑˆÐ°Ð½Ð±Ðµ', 'ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð¥ÑƒÐ´Ð¶Ð°Ð½Ð´', 'ÐœÐ¾ÑÐºÐ²Ð° â†’ ÐšÑƒÐ»Ð¾Ð±'];
    
    // Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ 15-25 Ð·Ð°Ð¿Ð¸ÑÐµÐ¹ Ð³Ñ€ÑƒÐ·Ð° Ð´Ð»Ñ ÑÐºÐ»Ð°Ð´Ð°
    const itemCount = Math.floor(Math.random() * 10) + 15;
    
    for (let i = 1; i <= itemCount; i++) {
      const sender = senders[Math.floor(Math.random() * senders.length)];
      const recipient = recipients[Math.floor(Math.random() * recipients.length)];
      const weight = (Math.random() * 50 + 0.5).toFixed(1);
      const amount = Math.floor(Math.random() * 5000) + 500;
      const cargoType = cargoTypes[Math.floor(Math.random() * cargoTypes.length)];
      const paymentStatus = paymentStatuses[Math.floor(Math.random() * paymentStatuses.length)];
      const route = routes[Math.floor(Math.random() * routes.length)];
      
      const date = new Date();
      date.setDate(date.getDate() - Math.floor(Math.random() * 30));
      
      reportData.push({
        id: `${warehouse.id}-cargo-${i}`,
        cargo_number: `CRG${Date.now()}-${i}`,
        cargo_name: cargoType,
        weight: parseFloat(weight),
        total_amount: amount,
        sender: sender.name,
        recipient: recipient.name,
        recipient_phone: recipient.phone,
        route: route,
        destination_warehouse: warehouse.name,
        payment_status: paymentStatus,
        acceptance_date: date.toISOString().split('T')[0],
        created_date: date.toISOString()
      });
    }
    
    return reportData.sort((a, b) => new Date(b.created_date) - new Date(a.created_date));
  };

  // Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ ÑÐºÐ»Ð°Ð´Ð° (ÑÐ¸Ð¼ÑƒÐ»ÑÑ†Ð¸Ñ)
  const generateWarehouseAnalytics = (warehouse) => {
    const blocksCount = warehouse.blocks_count || 3;
    const totalCells = blocksCount * 20;
    const occupiedCells = Math.floor(totalCells * 0.6);
    const freeCells = totalCells - occupiedCells;
    
    const totalWeight = Math.floor(Math.random() * 1000) + 500; // ÐºÐ³
    const totalCargoCount = occupiedCells + Math.floor(Math.random() * 10);
    const uniqueClientsCount = Math.floor(totalCargoCount * 0.7); // 70% ÑƒÐ½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ñ… ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²
    const totalAmount = Math.floor(Math.random() * 100000) + 50000; // Ñ€ÑƒÐ±Ð»Ð¸
    
    return {
      total_blocks: blocksCount,
      total_cells: totalCells,
      occupied_cells: occupiedCells,
      free_cells: freeCells,
      loading_percentage: Math.round((occupiedCells / totalCells) * 100),
      total_weight_kg: totalWeight,
      total_cargo_count: totalCargoCount,
      unique_clients_count: uniqueClientsCount,
      total_amount_rub: totalAmount
    };
  };

  // ÐÐžÐ’Ð«Ð• Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜: Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð´Ð¾Ð»Ð³Ð°Ð¼Ð¸
  const handlePayOffDebt = async (debtId, remainingAmount) => {
    if (window.confirm(`ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»Ð½Ð¾Ðµ Ð¿Ð¾Ð³Ð°ÑˆÐµÐ½Ð¸Ðµ Ð´Ð¾Ð»Ð³Ð° Ð½Ð° ÑÑƒÐ¼Ð¼Ñƒ ${remainingAmount?.toFixed(2)} ÑÐ¾Ð¼`)) {
      try {
        await apiCall(`/api/admin/debts/${debtId}/status`, 'PUT', { status: 'paid' });
        showAlert('Ð”Ð¾Ð»Ð³ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ð¾Ð³Ð°ÑˆÐµÐ½!', 'success');
        fetchDebtorsList(); // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº
      } catch (error) {
        console.error('Error paying off debt:', error);
        showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð³Ð°ÑˆÐµÐ½Ð¸Ð¸ Ð´Ð¾Ð»Ð³Ð°', 'error');
      }
    }
  };

  const handleMarkOverdue = async (debtId) => {
    if (window.confirm('ÐžÑ‚Ð¼ÐµÑ‚Ð¸Ñ‚ÑŒ Ð´Ð¾Ð»Ð³ ÐºÐ°Ðº Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐµÐ½Ð½Ñ‹Ð¹?')) {
      try {
        await apiCall(`/api/admin/debts/${debtId}/status`, 'PUT', { status: 'overdue' });
        showAlert('Ð”Ð¾Ð»Ð³ Ð¾Ñ‚Ð¼ÐµÑ‡ÐµÐ½ ÐºÐ°Ðº Ð¿Ñ€Ð¾ÑÑ€Ð¾Ñ‡ÐµÐ½Ð½Ñ‹Ð¹', 'success');
        fetchDebtorsList(); // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº
      } catch (error) {
        console.error('Error marking debt overdue:', error);
        showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° Ð´Ð¾Ð»Ð³Ð°', 'error');
      }
    }
  };

  // ÐÐžÐ’Ð«Ð• Ð¤Ð£ÐÐšÐ¦Ð˜Ð˜: Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸ÑÐ¼Ð¸
  const handleMarkNotificationAsRead = async (notificationId) => {
    try {
      await apiCall(`/api/notifications/${notificationId}/status`, 'PUT', { status: 'read' });
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ
      setNotifications(prev => 
        prev.map(n => n.id === notificationId ? {...n, status: 'read'} : n)
      );
      showAlert('Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð¾Ñ‚Ð¼ÐµÑ‡ÐµÐ½Ð¾ ÐºÐ°Ðº Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ð¾Ðµ', 'success');
    } catch (error) {
      console.error('Error marking notification as read:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ', 'error');
    }
  };

  const handleDeleteNotification = async (notificationId) => {
    if (window.confirm('Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÑ‚Ð¾ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ?')) {
      try {
        await apiCall(`/api/notifications/${notificationId}`, 'DELETE');
        // Ð£Ð´Ð°Ð»ÑÐµÐ¼ Ð¸Ð· Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ñ
        setNotifications(prev => prev.filter(n => n.id !== notificationId));
        showAlert('Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¾', 'success');
      } catch (error) {
        console.error('Error deleting notification:', error);
        showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ', 'error');
      }
    }
  };

  const handleViewNotificationDetails = async (notificationId) => {
    try {
      const data = await apiCall(`/api/notifications/${notificationId}/details`);
      setSelectedNotificationDetails(data);
      setNotificationDetailsModal(true);
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð² Ð»Ð¾ÐºÐ°Ð»ÑŒÐ½Ð¾Ð¼ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ð¸
      setNotifications(prev => 
        prev.map(n => n.id === notificationId ? {...n, status: 'read'} : n)
      );
    } catch (error) {
      console.error('Error fetching notification details:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐµ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ', 'error');
    }
  };

  const fetchTransportsList = async () => {
    try {
      const data = await apiCall('/api/transport/list');
      setTransports(data);
    } catch (error) {
      console.error('Error fetching transports list:', error);
    }
  };

  const handleCreateInterwarehouseTransport = async (e) => {
    e.preventDefault();
    try {
      const response = await apiCall('/api/transport/create-interwarehouse', 'POST', interwarehouseForm);
      
      showAlert(
        `ÐœÐµÐ¶ÑÐºÐ»Ð°Ð´ÑÐºÐ¾Ð¹ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ ${response.transport_number} ÑÐ¾Ð·Ð´Ð°Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾! ÐÐ°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ: ${response.direction}`, 
        'success'
      );
      
      // ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¼Ð¾Ð´Ð°Ð»
      fetchTransportsList();
      setInterwarehouseTransportModal(false);
      setInterwarehouseForm({
        source_warehouse_id: '',
        destination_warehouse_id: '',
        driver_name: '',
        driver_phone: '',
        capacity_kg: 1000
      });
    } catch (error) {
      console.error('Error creating interwarehouse transport:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¼ÐµÐ¶ÑÐºÐ»Ð°Ð´ÑÐºÐ¾Ð³Ð¾ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð°', 'error');
    }
  };

  const handleLogin = async (e) => {
    e.preventDefault();
    setIsLoggingIn(true);
    try {
      const data = await apiCall('/api/auth/login', 'POST', loginForm);
      
      // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½ Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾
      setToken(data.access_token);
      setUser(data.user);
      localStorage.setItem('token', data.access_token);
      
      showAlert('Ð£ÑÐ¿ÐµÑˆÐ½Ñ‹Ð¹ Ð²Ñ…Ð¾Ð´ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ!', 'success');
      
      // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ„Ð»Ð°Ð³ Ð»Ð¾Ð³Ð¸Ð½Ð° Ð¿Ð¾ÑÐ»Ðµ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸
      setTimeout(() => {
        setIsLoggingIn(false);
      }, 1000);
      
    } catch (error) {
      console.error('Login error:', error);
      setIsLoggingIn(false);
    }
  };

  const handleRegister = async (e) => {
    e.preventDefault();
    setIsLoggingIn(true);
    try {
      const data = await apiCall('/api/auth/register', 'POST', registerForm);
      
      // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ‚Ð¾ÐºÐµÐ½ Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¾Ð´Ð½Ð¾Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾
      setToken(data.access_token);
      setUser(data.user);
      localStorage.setItem('token', data.access_token);
      
      showAlert('Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ Ð¿Ñ€Ð¾ÑˆÐ»Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!', 'success');
      
      // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ„Ð»Ð°Ð³ Ð»Ð¾Ð³Ð¸Ð½Ð° Ð¿Ð¾ÑÐ»Ðµ Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÐ¾Ð¹ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÐ¸
      setTimeout(() => {
        setIsLoggingIn(false);
      }, 1000);
      
    } catch (error) {
      console.error('Registration error:', error);
      setIsLoggingIn(false);
    }
  };

  const handleCreateCargo = async (e) => {
    e.preventDefault();
    try {
      await apiCall('/api/cargo/create', 'POST', {
        ...cargoForm,
        weight: parseFloat(cargoForm.weight),
        declared_value: parseFloat(cargoForm.declared_value)
      });
      showAlert('Ð“Ñ€ÑƒÐ· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½!', 'success');
      setCargoForm({
        recipient_name: '',
        recipient_phone: '',
        route: 'moscow_to_tajikistan',
        weight: '',
        description: '',
        declared_value: '',
        sender_address: '',
        recipient_address: ''
      });
      fetchMyCargo();
    } catch (error) {
      console.error('Create cargo error:', error);
    }
  };

  const handleTrackCargo = async (e) => {
    e.preventDefault();
    try {
      const data = await apiCall(`/api/cargo/track/${trackingNumber}`);
      setTrackingResult(data);
      showAlert('Ð“Ñ€ÑƒÐ· Ð½Ð°Ð¹Ð´ÐµÐ½!', 'success');
    } catch (error) {
      setTrackingResult(null);
      console.error('Track cargo error:', error);
    }
  };

  const handleWarehouseSearch = async () => {
    if (!searchQuery.trim()) return;
    try {
      const data = await apiCall(`/api/warehouse/search?query=${encodeURIComponent(searchQuery)}`);
      // Ð£Ð±ÐµÐ¶Ð´Ð°ÐµÐ¼ÑÑ, Ñ‡Ñ‚Ð¾ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ Ð²ÑÐµÐ³Ð´Ð° ÑÐ²Ð»ÑÐµÑ‚ÑÑ Ð¼Ð°ÑÑÐ¸Ð²Ð¾Ð¼
      setSearchResults(Array.isArray(data) ? data : []);
      setShowSearchResults(true);
    } catch (error) {
      console.error('Search error:', error);
      setSearchResults([]);
      setShowSearchResults(false);
    }
  };

  const handleCreateWarehouse = async (e) => {
    e.preventDefault();
    try {
      await apiCall('/api/warehouses/create', 'POST', {
        ...warehouseForm,
        blocks_count: parseInt(warehouseForm.blocks_count),
        shelves_per_block: parseInt(warehouseForm.shelves_per_block),
        cells_per_shelf: parseInt(warehouseForm.cells_per_shelf)
      });
      showAlert('Ð¡ÐºÐ»Ð°Ð´ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½!', 'success');
      setWarehouseForm({
        name: '',
        location: '',
        blocks_count: 1,
        shelves_per_block: 1,
        cells_per_shelf: 10
      });
      fetchWarehouses();
    } catch (error) {
      console.error('Create warehouse error:', error);
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð³Ñ€ÑƒÐ·Ð°Ð¼Ð¸ Ñ Ð¸Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ñ†ÐµÐ½Ð°Ð¼Ð¸
  const addCargoItem = () => {
    setOperatorCargoForm({
      ...operatorCargoForm,
      cargo_items: [...operatorCargoForm.cargo_items, { cargo_name: '', weight: '', price_per_kg: '' }]
    });
  };

  const removeCargoItem = (index) => {
    if (operatorCargoForm.cargo_items.length > 1) {
      const newItems = operatorCargoForm.cargo_items.filter((_, i) => i !== index);
      setOperatorCargoForm({
        ...operatorCargoForm,
        cargo_items: newItems
      });
      calculateTotalsWithIndividualPrices(newItems);
    }
  };

  const updateCargoItem = (index, field, value) => {
    const newItems = [...operatorCargoForm.cargo_items];
    newItems[index] = { ...newItems[index], [field]: value };
    
    setOperatorCargoForm(prev => ({
      ...prev,
      cargo_items: newItems
    }));
    
    // Debounce Ð¿ÐµÑ€ÐµÑÑ‡ÐµÑ‚ Ð¸Ñ‚Ð¾Ð³Ð¾Ð² Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ñ‡Ð¸ÑÐ»Ð¾Ð²Ñ‹Ñ… Ð¿Ð¾Ð»ÐµÐ¹
    if (field === 'weight' || field === 'price_per_kg') {
      setTimeout(() => calculateTotalsWithIndividualPrices(newItems), 100);
    }
  };

  const calculateTotalsWithIndividualPrices = (cargoItems = operatorCargoForm.cargo_items) => {
    let totalWeightSum = 0;
    let totalCostSum = 0;
    const breakdown = [];
    
    cargoItems.forEach((item, index) => {
      const weight = parseFloat(item.weight) || 0;
      const pricePerKg = parseFloat(item.price_per_kg) || 0;
      const itemCost = weight * pricePerKg;
      
      totalWeightSum += weight;
      totalCostSum += itemCost;
      
      if (weight > 0 && pricePerKg > 0) {
        breakdown.push({
          index: index + 1,
          name: item.cargo_name || `Ð“Ñ€ÑƒÐ· ${index + 1}`,
          weight,
          pricePerKg,
          cost: itemCost
        });
      }
    });
    
    setTotalWeight(totalWeightSum);
    setTotalCost(totalCostSum);
    setCargoBreakdown(breakdown);
  };

  // Ð¡Ñ‚Ð°Ñ€Ð°Ñ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ñ calculateTotals Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ñ Ñ€ÐµÐ¶Ð¸Ð¼Ð¾Ð¼ Ð¾Ð±Ñ‰ÐµÐ¹ Ñ†ÐµÐ½Ñ‹
  const calculateTotals = (cargoItems = operatorCargoForm.cargo_items, pricePerKg = operatorCargoForm.price_per_kg) => {
    const weight = cargoItems.reduce((sum, item) => {
      const itemWeight = parseFloat(item.weight) || 0;
      return sum + itemWeight;
    }, 0);
    
    const cost = weight * (parseFloat(pricePerKg) || 0);
    
    setTotalWeight(weight);
    setTotalCost(cost);
  };

  const handleAcceptCargo = async (e) => {
    e.preventDefault();
    try {
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ð¸ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ warehouse_id
      let selectedWarehouseId = operatorCargoForm.warehouse_id;
      
      // Ð•ÑÐ»Ð¸ Ð½Ðµ Ð²Ñ‹Ð±Ñ€Ð°Ð½ ÑÐºÐ»Ð°Ð´, Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ð¹
      if (!selectedWarehouseId && operatorWarehouses.length > 0) {
        selectedWarehouseId = operatorWarehouses[0].id;
        console.log('Auto-selected warehouse:', selectedWarehouseId);
      }
      
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼ Ñ‡Ñ‚Ð¾ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ ÑÐºÐ»Ð°Ð´ Ð¿Ñ€Ð¸Ð½Ð°Ð´Ð»ÐµÐ¶Ð¸Ñ‚ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñƒ
      if (selectedWarehouseId && !operatorWarehouses.find(w => w.id === selectedWarehouseId)) {
        // Ð•ÑÐ»Ð¸ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ ÑÐºÐ»Ð°Ð´ Ð½Ðµ Ð¿Ñ€Ð¸Ð½Ð°Ð´Ð»ÐµÐ¶Ð¸Ñ‚ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñƒ, Ð²Ñ‹Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ð¹
        selectedWarehouseId = operatorWarehouses.length > 0 ? operatorWarehouses[0].id : null;
        console.log('Corrected warehouse selection:', selectedWarehouseId);
      }
      
      if (!selectedWarehouseId) {
        showAlert('ÐžÑˆÐ¸Ð±ÐºÐ°: ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð¾Ð¿Ñ€ÐµÐ´ÐµÐ»Ð¸Ñ‚ÑŒ ÑÐºÐ»Ð°Ð´ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°. ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ.', 'error');
        return;
      }
      
      let requestData;
      
      if (operatorCargoForm.use_multi_cargo) {
        // ÐÐ¾Ð²Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ Ñ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð³Ñ€ÑƒÐ·Ð°Ð¼Ð¸ Ð¸ Ð¸Ð½Ð´Ð¸Ð²Ð¸Ð´ÑƒÐ°Ð»ÑŒÐ½Ñ‹Ð¼Ð¸ Ñ†ÐµÐ½Ð°Ð¼Ð¸
        requestData = {
          sender_full_name: operatorCargoForm.sender_full_name,
          sender_phone: operatorCargoForm.sender_phone,
          recipient_full_name: operatorCargoForm.recipient_full_name,
          recipient_phone: operatorCargoForm.recipient_phone,
          recipient_address: operatorCargoForm.recipient_address,
          description: operatorCargoForm.description,
          route: operatorCargoForm.route,
          cargo_items: operatorCargoForm.cargo_items.map(item => ({
            cargo_name: item.cargo_name,
            weight: parseFloat(item.weight),
            price_per_kg: parseFloat(item.price_per_kg)
          })),
          // Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐÐžÐ• ÐŸÐžÐ›Ð• Ð¡ÐšÐ›ÐÐ”Ð
          warehouse_id: selectedWarehouseId,
          payment_method: operatorCargoForm.payment_method,
          payment_amount: operatorCargoForm.payment_amount ? parseFloat(operatorCargoForm.payment_amount) : null,
          debt_due_date: operatorCargoForm.debt_due_date || null
        };
      } else {
        // Ð¡Ñ‚Ð°Ñ€Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ Ð´Ð»Ñ ÑÐ¾Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸
        requestData = {
          ...operatorCargoForm,
          weight: parseFloat(operatorCargoForm.weight),
          declared_value: parseFloat(operatorCargoForm.declared_value || operatorCargoForm.price_per_kg),
          price_per_kg: parseFloat(operatorCargoForm.declared_value || operatorCargoForm.price_per_kg),
          // Ð˜Ð¡ÐŸÐ ÐÐ’Ð›Ð•ÐÐÐžÐ• ÐŸÐžÐ›Ð• Ð¡ÐšÐ›ÐÐ”Ð
          warehouse_id: selectedWarehouseId,
          payment_method: operatorCargoForm.payment_method,
          payment_amount: operatorCargoForm.payment_amount ? parseFloat(operatorCargoForm.payment_amount) : null,
          debt_due_date: operatorCargoForm.debt_due_date || null
        };
      }
      
      console.log('Sending cargo data:', requestData);
      const response = await apiCall('/api/operator/cargo/accept', 'POST', requestData);
      console.log('Cargo acceptance response:', response);
      
      // Ð¡Ð¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð·Ð°Ð²Ð¸ÑÐ¸Ñ‚ Ð¾Ñ‚ ÑÐ¿Ð¾ÑÐ¾Ð±Ð° Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹
      const paymentMessages = {
        'not_paid': 'Ð“Ñ€ÑƒÐ· Ð¿Ñ€Ð¸Ð½ÑÑ‚ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½ Ð² ÐºÐ°ÑÑÑƒ Ð´Ð»Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹!',
        'cash': 'Ð“Ñ€ÑƒÐ· Ð¿Ñ€Ð¸Ð½ÑÑ‚ Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ð¾Ð¹ Ð½Ð°Ð»Ð¸Ñ‡Ð½Ñ‹Ð¼Ð¸ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½ Ð½Ð° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ!',
        'card_transfer': 'Ð“Ñ€ÑƒÐ· Ð¿Ñ€Ð¸Ð½ÑÑ‚ Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð´Ð¾Ð¼ Ð½Ð° ÐºÐ°Ñ€Ñ‚Ñƒ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½ Ð½Ð° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ!',
        'cash_on_delivery': 'Ð“Ñ€ÑƒÐ· Ð¿Ñ€Ð¸Ð½ÑÑ‚ Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ð¾Ð¹ Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½ Ð½Ð° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ!',
        'credit': 'Ð“Ñ€ÑƒÐ· Ð¿Ñ€Ð¸Ð½ÑÑ‚ Ð² Ð´Ð¾Ð»Ð³ Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½ Ð½Ð° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ!'
      };
      
      showAlert(paymentMessages[operatorCargoForm.payment_method] || 'Ð“Ñ€ÑƒÐ· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ñ€Ð¸Ð½ÑÑ‚!', 'success');
      
      // ÐÐžÐ’ÐžÐ•: ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ QR ÐºÐ¾Ð´ ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð³Ñ€ÑƒÐ·Ð°
      if (response && response.qr_code) {
        setCreatedCargoQR({
          cargo_number: response.cargo_number,
          qr_code: response.qr_code,
          cargo_info: {
            sender_name: response.sender_full_name,
            recipient_name: response.recipient_full_name,
            weight: response.weight,
            cargo_name: response.cargo_name,
            declared_value: response.declared_value,
            payment_method: response.payment_method
          },
          message: response.qr_display_message || `QR ÐºÐ¾Ð´ Ð´Ð»Ñ Ð³Ñ€ÑƒÐ·Ð° ${response.cargo_number} Ð³Ð¾Ñ‚Ð¾Ð²`
        });
        setShowCreatedCargoQRModal(true);
      }
      
      // Ð¡Ð±Ñ€Ð¾Ñ Ñ„Ð¾Ñ€Ð¼Ñ‹
      const warehouseId = operatorWarehouses.length === 1 ? operatorWarehouses[0].id : '';
      setOperatorCargoForm({
        sender_full_name: '',
        sender_phone: '',
        recipient_full_name: '',
        recipient_phone: '',
        recipient_address: '',
        weight: '',
        cargo_name: '',
        declared_value: '',
        description: '',
        route: 'moscow_to_tajikistan',
        cargo_items: [{ cargo_name: '', weight: '', price_per_kg: '' }],
        price_per_kg: '',
        use_multi_cargo: false,
        // ÐÐžÐ’Ð«Ð• ÐŸÐžÐ›Ð¯ - ÑÐ±Ñ€Ð¾Ñ
        warehouse_id: warehouseId,  // Ð¡Ð¾Ñ…Ñ€Ð°Ð½ÑÐµÐ¼ Ð°Ð²Ñ‚Ð¾Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ð¹ ÑÐºÐ»Ð°Ð´
        payment_method: 'not_paid',
        payment_amount: '',
        debt_due_date: ''
      });
      
      // Ð¡Ð±Ñ€Ð¾Ñ ÐºÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€Ð°
      setTotalWeight(0);
      setTotalCost(0);
      setCargoBreakdown([]);
      
      // Ð¡Ð±Ñ€Ð¾Ñ Ñ„Ð»Ð°Ð³Ð¾Ð² Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
      setIsFilledFromProfile(false);
      setProfileSourceUser(null);
      
      fetchOperatorCargo();
      fetchAvailableCargo();
      
      // ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… ÑˆÐ°Ð³Ð°Ñ… Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹
      if (operatorCargoForm.payment_method === 'not_paid') {
        showAlert('Ð“Ñ€ÑƒÐ· Ñ‚ÐµÐ¿ÐµÑ€ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð² Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ "ÐšÐ°ÑÑÐ°" â†’ "ÐÐµ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð¾" Ð´Ð»Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸ Ð¿Ð»Ð°Ñ‚ÐµÐ¶Ð°', 'info');
      } else {
        showAlert('Ð“Ñ€ÑƒÐ· Ð³Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸ÑŽ! Ð”Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð² Ñ€Ð°Ð·Ð´ÐµÐ»Ðµ "Ð¡ÐºÐ»Ð°Ð´Ñ‹" â†’ "Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°"', 'info');
      }
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐ¾Ðº Ð·Ð°Ð´Ð¾Ð»Ð¶Ð½Ð¸ÐºÐ¾Ð² ÐµÑÐ»Ð¸ Ð±Ñ‹Ð»Ð° Ð¾Ð¿Ð»Ð°Ñ‚Ð° Ð² Ð´Ð¾Ð»Ð³
      if (operatorCargoForm.payment_method === 'credit' && user?.role === 'admin') {
        fetchDebtorsList();
      }
    } catch (error) {
      console.error('Accept cargo error:', error);
    }
  };

  const handlePlaceCargo = async (cargoId, warehouseId, blockNumber, shelfNumber, cellNumber) => {
    try {
      const response = await apiCall('/api/operator/cargo/place', 'POST', {
        cargo_id: cargoId,
        warehouse_id: warehouseId,
        block_number: parseInt(blockNumber),
        shelf_number: parseInt(shelfNumber),
        cell_number: parseInt(cellNumber)
      });

      showAlert(`âœ… Ð“Ñ€ÑƒÐ· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½ Ð½Ð° ${response.warehouse_name}`, 'success');
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÑ‚Ð°Ñ‚ÑƒÑ Ð³Ñ€ÑƒÐ·Ð° Ð½Ð° "Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½" Ð²Ð¾ Ð’Ð¡Ð•Ð¥ Ñ‚Ð°Ð±Ð»Ð¸Ñ†Ð°Ñ…
      await updateCargoProcessingStatus(cargoId, 'placed');
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð²ÑÐµ ÑÐ¿Ð¸ÑÐºÐ¸ Ð´Ð»Ñ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð¸Ð·Ð°Ñ†Ð¸Ð¸
      fetchAvailableCargoForPlacement(); // Ð£Ð±Ð¸Ñ€Ð°ÐµÐ¼ Ð¸Ð· "ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ"
      fetchPlacedCargo(); // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ð² "Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹"
      fetchOperatorCargo(operatorCargoFilter, operatorCargoPage, operatorCargoPerPage);
      fetchAllCargo(); // ÐÐ´Ð¼Ð¸Ð½ÑÐºÐ¸Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº
      
      return response;
    } catch (error) {
      console.error('Error placing cargo:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°: ' + error.message, 'error');
      throw error;
    }
  };

  const handleSearchCargoForPayment = async () => {
    if (!paymentForm.cargo_number.trim()) return;
    
    try {
      const data = await apiCall(`/api/cashier/search-cargo/${paymentForm.cargo_number}`);
      setCargoForPayment(data);
      setPaymentForm({...paymentForm, amount_paid: data.declared_value.toString()});
    } catch (error) {
      setCargoForPayment(null);
      console.error('Search cargo for payment error:', error);
    }
  };

  const handleProcessPayment = async () => {
    try {
      await apiCall('/api/cashier/process-payment', 'POST', {
        cargo_number: paymentForm.cargo_number,
        amount_paid: parseFloat(paymentForm.amount_paid),
        transaction_type: paymentForm.transaction_type,
        notes: paymentForm.notes
      });
      showAlert('ÐžÐ¿Ð»Ð°Ñ‚Ð° ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð°!', 'success');
      setPaymentModal(false);
      setCargoForPayment(null);
      setPaymentForm({
        cargo_number: '',
        amount_paid: '',
        transaction_type: 'cash',
        notes: ''
      });
      fetchUnpaidCargo();
      fetchPaymentHistory();
      fetchOperatorCargo();
    } catch (error) {
      console.error('Process payment error:', error);
    }
  };

  const handleOpenWarehouseLayout = async (warehouse) => {
    console.log('Opening warehouse layout for:', warehouse);
    setSelectedWarehouseForLayout(warehouse);
    
    // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð½Ð¾Ð²Ñ‹Ð¹ API Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ ÑÑ…ÐµÐ¼Ñ‹ Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¾ Ð³Ñ€ÑƒÐ·Ð°Ñ…
    try {
      await fetchWarehouseLayoutWithCargo(warehouse.id);
      console.log('Layout fetched, opening modal...');
      setLayoutModal(true);
    } catch (error) {
      console.error('Error opening warehouse layout:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ð¸ ÑÑ…ÐµÐ¼Ñ‹ ÑÐºÐ»Ð°Ð´Ð°: ' + error.message, 'error');
    }
  };

  const printCargoInvoice = (cargo) => {
    // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ‚Ð¾Ñ‚ Ð¶Ðµ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚, Ñ‡Ñ‚Ð¾ Ð¸ printInvoice
    printInvoice(cargo);
  };

  const handleCreateRequest = async (e) => {
    e.preventDefault();
    try {
      await apiCall('/api/user/cargo-request', 'POST', {
        ...requestForm,
        weight: parseFloat(requestForm.weight),
        declared_value: parseFloat(requestForm.declared_value)
      });
      showAlert('Ð—Ð°ÑÐ²ÐºÐ° Ð½Ð° Ð³Ñ€ÑƒÐ· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ Ð¿Ð¾Ð´Ð°Ð½Ð°!', 'success');
      setRequestForm({
        recipient_full_name: '',
        recipient_phone: '',
        recipient_address: '',
        pickup_address: '',
        cargo_name: '',
        weight: '',
        declared_value: getDefaultDeclaredValue('moscow_to_tajikistan'), // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
        description: '',
        route: 'moscow_to_tajikistan'
      });
      fetchMyRequests();
    } catch (error) {
      console.error('Create request error:', error);
      
      // ÐŸÑ€Ð°Ð²Ð¸Ð»ÑŒÐ½Ð°Ñ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ° Ð¾ÑˆÐ¸Ð±Ð¾Ðº
      let errorMessage = 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð°Ñ Ð¾ÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð´Ð°Ñ‡Ðµ Ð·Ð°ÑÐ²ÐºÐ¸';
      
      if (error.message) {
        errorMessage = error.message;
      } else if (typeof error === 'string') {
        errorMessage = error;
      } else if (error.detail) {
        errorMessage = error.detail;
      }
      
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ð¾Ð´Ð°Ñ‡Ð¸ Ð·Ð°ÑÐ²ÐºÐ¸: ' + errorMessage, 'error');
    }
  };

  const handleAcceptRequest = async (requestId) => {
    try {
      await apiCall(`/api/admin/cargo-requests/${requestId}/accept`, 'POST');
      showAlert('Ð—Ð°ÑÐ²ÐºÐ° Ð¿Ñ€Ð¸Ð½ÑÑ‚Ð° Ð¸ Ð³Ñ€ÑƒÐ· ÑÐ¾Ð·Ð´Ð°Ð½!', 'success');
      fetchCargoRequests();
      fetchOperatorCargo();
      fetchNotifications();
    } catch (error) {
      console.error('Accept request error:', error);
    }
  };

  const handleRejectRequest = async (requestId, reason = '') => {
    try {
      await apiCall(`/api/admin/cargo-requests/${requestId}/reject`, 'POST', { reason });
      showAlert('Ð—Ð°ÑÐ²ÐºÐ° Ð¾Ñ‚ÐºÐ»Ð¾Ð½ÐµÐ½Ð°', 'info');
      fetchCargoRequests();
      fetchNotifications();
    } catch (error) {
      console.error('Reject request error:', error);
    }
  };

  const updateCargoStatus = async (cargoId, status, warehouseLocation = null) => {
    try {
      const params = new URLSearchParams({ status });
      if (warehouseLocation) {
        params.append('warehouse_location', warehouseLocation);
      }
      
      await apiCall(`/api/cargo/${cargoId}/status?${params}`, 'PUT');
      showAlert('Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð³Ñ€ÑƒÐ·Ð° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½!', 'success');
      
      if (user.role === 'admin') {
        fetchAllCargo();
      } else if (user.role === 'warehouse_operator') {
        fetchWarehouseCargo();
      }
    } catch (error) {
      console.error('Update status error:', error);
    }
  };

  const toggleUserStatus = async (userId, isActive) => {
    try {
      await apiCall(`/api/admin/users/${userId}/status`, 'PUT', { is_active: !isActive });
      showAlert('Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½!', 'success');
      fetchUsers();
    } catch (error) {
      console.error('Toggle user status error:', error);
    }
  };

  const deleteUser = async (userId) => {
    if (window.confirm('Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÑ‚Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ?')) {
      try {
        await apiCall(`/api/admin/users/${userId}`, 'DELETE');
        showAlert('ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ´Ð°Ð»ÐµÐ½!', 'success');
        fetchUsers();
      } catch (error) {
        console.error('Delete user error:', error);
      }
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð²Ð°Ð»Ð¸Ð´Ð½Ð¾ÑÑ‚Ð¸ Ñ‚Ð¾ÐºÐµÐ½Ð°
  const isTokenValid = (tokenString) => {
    if (!tokenString) return false;
    
    try {
      // Ð”ÐµÐºÐ¾Ð´Ð¸Ñ€ÑƒÐµÐ¼ JWT Ñ‚Ð¾ÐºÐµÐ½ Ð±ÐµÐ· Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¿Ð¾Ð´Ð¿Ð¸ÑÐ¸ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ exp)
      const base64Url = tokenString.split('.')[1];
      const base64 = base64Url.replace(/-/g, '+').replace(/_/g, '/');
      const jsonPayload = decodeURIComponent(atob(base64).split('').map(function(c) {
        return '%' + ('00' + c.charCodeAt(0).toString(16)).slice(-2);
      }).join(''));
      
      const decoded = JSON.parse(jsonPayload);
      const currentTime = Date.now() / 1000;
      
      // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ðµ Ð¸ÑÑ‚ÐµÐº Ð»Ð¸ Ñ‚Ð¾ÐºÐµÐ½
      return decoded.exp && decoded.exp > currentTime;
    } catch (error) {
      console.error('Token validation error:', error);
      return false;
    }
  };

  const handleLogout = () => {
    // ÐŸÑ€ÐµÐ´Ð¾Ñ‚Ð²Ñ€Ð°Ñ‰Ð°ÐµÐ¼ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ðµ logout'Ñ‹
    if (isLoggingOut) {
      console.log('Logout already in progress, skipping...');
      return;
    }
    
    console.log('Starting logout process...');
    setIsLoggingOut(true);
    
    localStorage.removeItem('token');
    setToken(null);
    setUser(null);
    setCargo([]);
    setUsers([]);
    setWarehouses([]);
    setOperatorCargo([]);
    setAvailableCargo([]);
    setCargoHistory([]);
    setUnpaidCargo([]);
    setPaymentHistory([]);
    setNotifications([]);
    setUsersByRole({ user: [], admin: [], warehouse_operator: [] });
    // Clear transport states
    setTransports([]);
    setSelectedTransport(null);
    setTransportCargoList([]);
    setAvailableCargoForTransport([]);
    setSelectedCargoForPlacement([]);
    setContactModal(false);
    // Clear operator-warehouse binding states
    setOperatorWarehouseBindings([]);
    setOperatorBindingModal(false);
    setSelectedOperatorForBinding('');
    setSelectedWarehouseForBinding('');
    // Clear warehouse cell management states
    setSelectedCellCargo(null);
    setCargoDetailModal(false);
    setCargoEditModal(false);
    setCargoMoveModal(false);
    setEditingCargo(null);
    setCargoEditForm({});
    setCargoMoveForm({
      warehouse_id: '',
      block_number: '',
      shelf_number: '',
      cell_number: ''
    });
    
    // ÐŸÐµÑ€ÐµÐ½Ð°Ð¿Ñ€Ð°Ð²Ð»ÑÐµÐ¼ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ð²Ñ…Ð¾Ð´Ð°
    setActiveTab('login');
    setActiveSection('login');
    
    showAlert('Ð’Ñ‹ Ð²Ñ‹ÑˆÐ»Ð¸ Ð¸Ð· ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹', 'info');
    
    // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ñ„Ð»Ð°Ð³ Ð»Ð¾Ð³Ð°ÑƒÑ‚Ð° Ñ‡ÐµÑ€ÐµÐ· Ð½ÐµÐ±Ð¾Ð»ÑŒÑˆÑƒÑŽ Ð·Ð°Ð´ÐµÑ€Ð¶ÐºÑƒ
    setTimeout(() => {
      setIsLoggingOut(false);
      console.log('Logout process completed');
    }, 1000);
  };

  const getStatusBadge = (status) => {
    const statusConfig = {
      created: { label: 'Ð¡Ð¾Ð·Ð´Ð°Ð½', variant: 'secondary' },
      accepted: { label: 'ÐŸÑ€Ð¸Ð½ÑÑ‚', variant: 'default' },
      in_transit: { label: 'Ð’ Ð¿ÑƒÑ‚Ð¸', variant: 'default' },
      arrived_destination: { label: 'ÐŸÑ€Ð¸Ð±Ñ‹Ð»', variant: 'default' },
      completed: { label: 'Ð”Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½', variant: 'default' }
    };
    
    const config = statusConfig[status] || { label: status, variant: 'secondary' };
    return <Badge variant={config.variant}>{config.label}</Badge>;
  };

  const getRoleIcon = (role) => {
    switch (role) {
      case 'admin':
        return <Shield className="h-4 w-4" />;
      case 'warehouse_operator':
        return <Warehouse className="h-4 w-4" />;
      default:
        return <User className="h-4 w-4" />;
    }
  };

  const getRoleLabel = (role) => {
    const labels = {
      user: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ',
      admin: 'ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€',
      warehouse_operator: 'ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ ÑÐºÐ»Ð°Ð´Ð°'
    };
    return labels[role] || role;
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ñ†Ð²ÐµÑ‚Ð¾Ð² ÑÐºÐ»Ð°Ð´Ð°Ð¼
  const getWarehouseColor = (warehouseName) => {
    if (!warehouseName) return { bg: 'bg-gray-100', border: 'border-gray-300', text: 'text-gray-700' };
    
    // ÐÐ¾Ñ€Ð¼Ð°Ð»Ð¸Ð·ÑƒÐµÐ¼ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ðµ ÑÐºÐ»Ð°Ð´Ð° Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ° ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… ÑÐ»Ð¾Ð²
    const name = warehouseName.toLowerCase();
    
    // Ð¦Ð²ÐµÑ‚Ð¾Ð²Ð°Ñ ÑÑ…ÐµÐ¼Ð° Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ ÐºÐ»ÑŽÑ‡ÐµÐ²Ñ‹Ñ… ÑÐ»Ð¾Ð² Ð² Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ð¸ ÑÐºÐ»Ð°Ð´Ð°
    if (name.includes('Ñ…ÑƒÐ´Ð¶Ð°Ð½Ð´') || name.includes('khujand')) {
      return { bg: 'bg-blue-50', border: 'border-l-blue-500', text: 'text-blue-800', badge: 'bg-blue-100' };
    } else if (name.includes('Ð´ÑƒÑˆÐ°Ð½Ð±Ðµ') || name.includes('dushanbe')) {
      return { bg: 'bg-green-50', border: 'border-l-green-500', text: 'text-green-800', badge: 'bg-green-100' };
    } else if (name.includes('ÐºÑƒÐ»Ð¾Ð±') || name.includes('kulob')) {
      return { bg: 'bg-purple-50', border: 'border-l-purple-500', text: 'text-purple-800', badge: 'bg-purple-100' };
    } else if (name.includes('ÐºÑƒÑ€Ð³Ð°Ð½') || name.includes('kurgan')) {
      return { bg: 'bg-orange-50', border: 'border-l-orange-500', text: 'text-orange-800', badge: 'bg-orange-100' };
    } else if (name.includes('Ð¼Ð¾ÑÐºÐ²Ð°') || name.includes('moscow')) {
      return { bg: 'bg-red-50', border: 'border-l-red-500', text: 'text-red-800', badge: 'bg-red-100' };
    } else {
      // Ð”Ð»Ñ Ð´Ñ€ÑƒÐ³Ð¸Ñ… ÑÐºÐ»Ð°Ð´Ð¾Ð² Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ ÑÐ»ÑƒÑ‡Ð°Ð¹Ð½Ñ‹Ð¹ Ñ†Ð²ÐµÑ‚ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ñ…ÐµÑˆÐ° Ð½Ð°Ð·Ð²Ð°Ð½Ð¸Ñ
      const colors = [
        { bg: 'bg-yellow-50', border: 'border-l-yellow-500', text: 'text-yellow-800', badge: 'bg-yellow-100' },
        { bg: 'bg-pink-50', border: 'border-l-pink-500', text: 'text-pink-800', badge: 'bg-pink-100' },
        { bg: 'bg-indigo-50', border: 'border-l-indigo-500', text: 'text-indigo-800', badge: 'bg-indigo-100' },
        { bg: 'bg-teal-50', border: 'border-l-teal-500', text: 'text-teal-800', badge: 'bg-teal-100' }
      ];
      
      // ÐŸÑ€Ð¾ÑÑ‚Ð¾Ð¹ Ñ…ÐµÑˆ Ð´Ð»Ñ ÐºÐ¾Ð½ÑÐ¸ÑÑ‚ÐµÐ½Ñ‚Ð½Ð¾Ð³Ð¾ Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ñ†Ð²ÐµÑ‚Ð°
      let hash = 0;
      for (let i = 0; i < name.length; i++) {
        hash = ((hash << 5) - hash + name.charCodeAt(i)) & 0xffffffff;
      }
      const colorIndex = Math.abs(hash) % colors.length;
      return colors[colorIndex];
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð»ÐµÐ³ÐµÐ½Ð´Ñ‹ Ñ†Ð²ÐµÑ‚Ð¾Ð² ÑÐºÐ»Ð°Ð´Ð¾Ð²
  const getWarehouseLegend = () => {
    const legend = [
      { name: 'Ð¡ÐºÐ»Ð°Ð´Ñ‹ Ð¥ÑƒÐ´Ð¶Ð°Ð½Ð´Ð°', color: 'bg-blue-500', textColor: 'text-blue-800' },
      { name: 'Ð¡ÐºÐ»Ð°Ð´Ñ‹ Ð”ÑƒÑˆÐ°Ð½Ð±Ðµ', color: 'bg-green-500', textColor: 'text-green-800' },
      { name: 'Ð¡ÐºÐ»Ð°Ð´Ñ‹ ÐšÑƒÐ»Ð¾Ð±Ð°', color: 'bg-purple-500', textColor: 'text-purple-800' },
      { name: 'Ð¡ÐºÐ»Ð°Ð´Ñ‹ ÐšÑƒÑ€Ð³Ð°Ð½-Ð¢ÑŽÐ±Ðµ', color: 'bg-orange-500', textColor: 'text-orange-800' },
      { name: 'Ð¡ÐºÐ»Ð°Ð´Ñ‹ ÐœÐ¾ÑÐºÐ²Ñ‹', color: 'bg-red-500', textColor: 'text-red-800' }
    ];
    return legend;
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  const openEditProfile = () => {
    setEditProfileForm({
      full_name: user.full_name || '',
      phone: user.phone || '',
      email: user.email || '',
      address: user.address || ''
    });
    setShowEditProfile(true);
  };

  const saveProfile = async () => {
    try {
      const updatedUser = await apiCall('/api/user/profile', 'PUT', editProfileForm);
      setUser(updatedUser);
      setShowEditProfile(false);
      showAlert('ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!', 'success');
    } catch (error) {
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ: ' + error.message, 'error');
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¾ÐºÐ½Ð° Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð°
  const openRepeatOrder = (cargo) => {
    setRepeatOrderData(cargo);
    setRepeatOrderForm({
      cargo_items: [{ 
        cargo_name: cargo.cargo_name || cargo.description || 'Ð“Ñ€ÑƒÐ·', 
        weight: cargo.weight || '', 
        price_per_kg: cargo.price_per_kg || '50' 
      }],
      recipient_full_name: cargo.recipient_full_name || '',
      recipient_phone: cargo.recipient_phone || '',
      recipient_address: cargo.recipient_address || '',
      route: cargo.route || 'moscow_dushanbe',
      delivery_type: 'standard',
      insurance_requested: false,
      special_instructions: '',
      use_multi_cargo: true
    });
    setShowRepeatOrderModal(true);
    calculateRepeatOrderTotals([{ 
      cargo_name: cargo.cargo_name || cargo.description || 'Ð“Ñ€ÑƒÐ·', 
      weight: cargo.weight || '', 
      price_per_kg: cargo.price_per_kg || '50' 
    }]);
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° Ð¸Ñ‚Ð¾Ð³Ð¾Ð² Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð°
  const calculateRepeatOrderTotals = (cargoItems) => {
    let totalWeight = 0;
    let totalCost = 0;
    const breakdown = [];

    cargoItems.forEach((item, index) => {
      const weight = parseFloat(item.weight) || 0;
      const pricePerKg = parseFloat(item.price_per_kg) || 0;
      const itemCost = weight * pricePerKg;

      totalWeight += weight;
      totalCost += itemCost;

      breakdown.push({
        index: index,
        cargo_name: item.cargo_name || `Ð“Ñ€ÑƒÐ· ${index + 1}`,
        weight: weight,
        price_per_kg: pricePerKg,
        cost: itemCost
      });
    });

    setRepeatOrderTotalWeight(totalWeight);
    setRepeatOrderTotalCost(totalCost);
    setRepeatOrderBreakdown(breakdown);
  };

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð³Ñ€ÑƒÐ·Ð° Ð² Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð¼ Ð·Ð°ÐºÐ°Ð·Ðµ
  const handleRepeatOrderItemChange = (index, field, value) => {
    const updatedItems = [...repeatOrderForm.cargo_items];
    updatedItems[index] = { ...updatedItems[index], [field]: value };
    setRepeatOrderForm({ ...repeatOrderForm, cargo_items: updatedItems });
    calculateRepeatOrderTotals(updatedItems);
  };

  // Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð° Ð³Ñ€ÑƒÐ·Ð° Ð² Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ñ‹Ð¹ Ð·Ð°ÐºÐ°Ð·
  const addRepeatOrderItem = () => {
    const newItems = [...repeatOrderForm.cargo_items, { cargo_name: '', weight: '', price_per_kg: '50' }];
    setRepeatOrderForm({ ...repeatOrderForm, cargo_items: newItems });
    calculateRepeatOrderTotals(newItems);
  };

  // Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð° Ð³Ñ€ÑƒÐ·Ð° Ð¸Ð· Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð°
  const removeRepeatOrderItem = (index) => {
    if (repeatOrderForm.cargo_items.length > 1) {
      const newItems = repeatOrderForm.cargo_items.filter((_, i) => i !== index);
      setRepeatOrderForm({ ...repeatOrderForm, cargo_items: newItems });
      calculateRepeatOrderTotals(newItems);
    }
  };

  // ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð°
  const submitRepeatOrder = async () => {
    try {
      if (repeatOrderForm.cargo_items.some(item => !item.cargo_name || !item.weight || !item.price_per_kg)) {
        showAlert('ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð²ÑÐµ Ð¿Ð¾Ð»Ñ Ð´Ð»Ñ Ð²ÑÐµÑ… Ð³Ñ€ÑƒÐ·Ð¾Ð²', 'error');
        return;
      }

      if (!repeatOrderForm.recipient_full_name || !repeatOrderForm.recipient_phone) {
        showAlert('ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ', 'error');
        return;
      }

      const orderData = {
        ...repeatOrderForm,
        sender_full_name: user.full_name,
        sender_phone: user.phone,
        total_weight: repeatOrderTotalWeight,
        total_cost: repeatOrderTotalCost
      };

      const result = await apiCall('/api/operator/cargo/accept', 'POST', orderData);
      
      setShowRepeatOrderModal(false);
      setRepeatOrderData(null);
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
      fetchClientDashboard();
      fetchClientCargo();
      
      showAlert(`ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð½Ñ‹Ð¹ Ð·Ð°ÐºÐ°Ð· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½! ÐÐ¾Ð¼ÐµÑ€: ${result.cargo_number}`, 'success');
      
    } catch (error) {
      console.error('Error creating repeat order:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð°: ' + error.message, 'error');
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð°Ð´Ð¼Ð¸Ð½Ð¾Ð¼
  const openAdminEditUser = (user) => {
    setSelectedUserForEdit(user);
    setAdminEditUserForm({
      id: user.id,
      full_name: user.full_name || '',
      phone: user.phone || '',
      email: user.email || '',
      address: user.address || '',
      role: user.role || 'user',
      is_active: user.is_active !== undefined ? user.is_active : true
    });
    setShowAdminEditUser(true);
  };

  const saveAdminUserEdit = async () => {
    try {
      const updatedUser = await apiCall(`/api/admin/users/${adminEditUserForm.id}/update`, 'PUT', adminEditUserForm);
      setShowAdminEditUser(false);
      setSelectedUserForEdit(null);
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ ÑÐ¿Ð¸ÑÐºÐ¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹
      fetchUsers();
      fetchUsersByRole();
      
      showAlert('Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ñ‹ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!', 'success');
    } catch (error) {
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: ' + error.message, 'error');
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð° Ð°Ð´Ð¼Ð¸Ð½Ð¾Ð¼/Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼
  const openAdminRepeatOrder = (cargo) => {
    setAdminRepeatOrderData(cargo);
    setAdminRepeatOrderForm({
      sender_id: cargo.sender_id || '',
      sender_full_name: cargo.sender_full_name || '',
      sender_phone: cargo.sender_phone || '',
      cargo_items: [{ 
        cargo_name: '', // ÐÐ´Ð¼Ð¸Ð½ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð·Ð°Ð½Ð¾Ð²Ð¾
        weight: '', // ÐÐ´Ð¼Ð¸Ð½ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð·Ð°Ð½Ð¾Ð²Ð¾
        price_per_kg: '50' // Ð—Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ
      }],
      recipient_full_name: cargo.recipient_full_name || '',
      recipient_phone: cargo.recipient_phone || '',
      recipient_address: cargo.recipient_address || '',
      route: cargo.route || 'moscow_dushanbe',
      delivery_type: 'standard',
      insurance_requested: false,
      special_instructions: `ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€ Ð³Ñ€ÑƒÐ·Ð° â„–${cargo.cargo_number}`,
      use_multi_cargo: true
    });
    setShowAdminRepeatOrderModal(true);
    calculateAdminRepeatOrderTotals([{ 
      cargo_name: '', 
      weight: '', 
      price_per_kg: '50'
    }]);
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ñ€Ð°ÑÑ‡ÐµÑ‚Ð° Ð¸Ñ‚Ð¾Ð³Ð¾Ð² Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð° Ð°Ð´Ð¼Ð¸Ð½Ð°/Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°
  const calculateAdminRepeatOrderTotals = (cargoItems) => {
    let totalWeight = 0;
    let totalCost = 0;
    const breakdown = [];

    cargoItems.forEach((item, index) => {
      const weight = parseFloat(item.weight) || 0;
      const pricePerKg = parseFloat(item.price_per_kg) || 0;
      const itemCost = weight * pricePerKg;

      totalWeight += weight;
      totalCost += itemCost;

      breakdown.push({
        index: index,
        cargo_name: item.cargo_name || `Ð“Ñ€ÑƒÐ· ${index + 1}`,
        weight: weight,
        price_per_kg: pricePerKg,
        cost: itemCost
      });
    });

    setAdminRepeatOrderTotalWeight(totalWeight);
    setAdminRepeatOrderTotalCost(totalCost);
    setAdminRepeatOrderBreakdown(breakdown);
  };

  // ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚Ñ‡Ð¸Ðº Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð¾Ð² Ð³Ñ€ÑƒÐ·Ð° Ð² Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð¼ Ð·Ð°ÐºÐ°Ð·Ðµ Ð°Ð´Ð¼Ð¸Ð½Ð°
  const handleAdminRepeatOrderItemChange = (index, field, value) => {
    const updatedItems = [...adminRepeatOrderForm.cargo_items];
    updatedItems[index] = { ...updatedItems[index], [field]: value };
    setAdminRepeatOrderForm({ ...adminRepeatOrderForm, cargo_items: updatedItems });
    calculateAdminRepeatOrderTotals(updatedItems);
  };

  // Ð”Ð¾Ð±Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð° Ð³Ñ€ÑƒÐ·Ð° Ð² Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ñ‹Ð¹ Ð·Ð°ÐºÐ°Ð· Ð°Ð´Ð¼Ð¸Ð½Ð°
  const addAdminRepeatOrderItem = () => {
    const newItems = [...adminRepeatOrderForm.cargo_items, { cargo_name: '', weight: '', price_per_kg: '50' }];
    setAdminRepeatOrderForm({ ...adminRepeatOrderForm, cargo_items: newItems });
    calculateAdminRepeatOrderTotals(newItems);
  };

  // Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð° Ð³Ñ€ÑƒÐ·Ð° Ð¸Ð· Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð° Ð°Ð´Ð¼Ð¸Ð½Ð°
  const removeAdminRepeatOrderItem = (index) => {
    if (adminRepeatOrderForm.cargo_items.length > 1) {
      const newItems = adminRepeatOrderForm.cargo_items.filter((_, i) => i !== index);
      setAdminRepeatOrderForm({ ...adminRepeatOrderForm, cargo_items: newItems });
      calculateAdminRepeatOrderTotals(newItems);
    }
  };

  // ÐžÑ‚Ð¿Ñ€Ð°Ð²ÐºÐ° Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð° Ð°Ð´Ð¼Ð¸Ð½Ð¾Ð¼/Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼
  const submitAdminRepeatOrder = async () => {
    try {
      if (adminRepeatOrderForm.cargo_items.some(item => !item.cargo_name || !item.weight || !item.price_per_kg)) {
        showAlert('ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð²ÑÐµ Ð¿Ð¾Ð»Ñ Ð´Ð»Ñ Ð²ÑÐµÑ… Ð³Ñ€ÑƒÐ·Ð¾Ð²', 'error');
        return;
      }

      if (!adminRepeatOrderForm.recipient_full_name || !adminRepeatOrderForm.recipient_phone) {
        showAlert('ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ', 'error');
        return;
      }

      if (!adminRepeatOrderForm.sender_full_name || !adminRepeatOrderForm.sender_phone) {
        showAlert('ÐŸÐ¾Ð¶Ð°Ð»ÑƒÐ¹ÑÑ‚Ð°, Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ', 'error');
        return;
      }

      const orderData = {
        ...adminRepeatOrderForm,
        total_weight: adminRepeatOrderTotalWeight,
        total_cost: adminRepeatOrderTotalCost
      };

      const result = await apiCall('/api/operator/cargo/accept', 'POST', orderData);
      
      setShowAdminRepeatOrderModal(false);
      setAdminRepeatOrderData(null);
      
      // ÐžÐ±Ð½Ð¾Ð²Ð»ÑÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ
      if (user.role === 'admin') {
        fetchAllCargo();
      } else if (user.role === 'warehouse_operator') {
        fetchOperatorCargo();
      }
      
      showAlert(`ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð½Ñ‹Ð¹ Ð·Ð°ÐºÐ°Ð· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½! ÐÐ¾Ð¼ÐµÑ€: ${result.cargo_number}`, 'success');
      
    } catch (error) {
      console.error('Error creating admin repeat order:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð°: ' + error.message, 'error');
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ñ„Ð¾Ñ€Ð¼Ñ‹ Ð¿Ñ€Ð¸ÐµÐ¼Ð° Ð³Ñ€ÑƒÐ·Ð° Ð¸Ð· Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  const openQuickCargoFromProfile = async (userInfo) => {
    try {
      // Ð—Ð°ÐºÑ€Ñ‹Ð²Ð°ÐµÐ¼ Ð¼Ð¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ
      setShowUserProfile(false);
      
      // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
      const historyData = selectedUserProfile?.sent_cargo || [];
      
      let senderData = {
        full_name: userInfo.full_name || '',
        phone: userInfo.phone || '',
        address: userInfo.address || ''
      };
      
      let recipientData = {
        full_name: '',
        phone: '',
        address: ''
      };
      
      // Ð•ÑÐ»Ð¸ ÐµÑÑ‚ÑŒ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹, Ð±ÐµÑ€ÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ³Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
      if (historyData.length > 0) {
        const lastCargo = historyData[0]; // ÐŸÐµÑ€Ð²Ñ‹Ð¹ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚ - ÑÐ°Ð¼Ñ‹Ð¹ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ð¹
        recipientData = {
          full_name: lastCargo.recipient_full_name || lastCargo.recipient_name || '',
          phone: lastCargo.recipient_phone || '',
          address: lastCargo.recipient_address || ''
        };
      }
      
      // Ð—Ð°Ð¿Ð¾Ð»Ð½ÑÐµÐ¼ Ñ„Ð¾Ñ€Ð¼Ñƒ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° Ñ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸
      const formData = {
        sender_full_name: senderData.full_name,
        sender_phone: senderData.phone,
        sender_address: senderData.address,
        recipient_full_name: recipientData.full_name,
        recipient_phone: recipientData.phone,
        recipient_address: recipientData.address,
        cargo_items: [{ cargo_name: '', weight: '', price_per_kg: '50' }],
        route: historyData.length > 0 ? historyData[0].route || 'moscow_dushanbe' : 'moscow_dushanbe',
        delivery_type: 'standard',
        insurance_requested: false,
        special_instructions: `Ð“Ñ€ÑƒÐ· Ð´Ð»Ñ ${userInfo.full_name} (${userInfo.user_number})`,
        use_multi_cargo: true
      };
      
      setOperatorCargoForm(formData);
      
      // Ð£ÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ñ„Ð»Ð°Ð³ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ
      setIsFilledFromProfile(true);
      setProfileSourceUser(userInfo);
      
      // Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€
      calculateTotalsWithIndividualPrices([{ cargo_name: '', weight: '', price_per_kg: '50' }]);
      
      // ÐŸÐµÑ€ÐµÑ…Ð¾Ð´Ð¸Ð¼ Ð½Ð° ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ð¿Ñ€Ð¸ÐµÐ¼Ð° Ð³Ñ€ÑƒÐ·Ð°
      setActiveSection('cargo-management');
      setActiveTab('cargo-accept');
      
      if (historyData.length > 0) {
        showAlert(`Ð¤Ð¾Ñ€Ð¼Ð° Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð° Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: ${userInfo.full_name}. Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ Ð²Ð·ÑÑ‚Ñ‹ Ð¸Ð· Ð¿Ð¾ÑÐ»ÐµÐ´Ð½ÐµÐ¹ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸.`, 'info');
      } else {
        showAlert(`Ð¤Ð¾Ñ€Ð¼Ð° Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð° Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: ${userInfo.full_name}. Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ Ð½ÑƒÐ¶Ð½Ð¾ Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ.`, 'warning');
      }
      
    } catch (error) {
      console.error('Error opening cargo form from profile:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚Ð¸Ñ Ñ„Ð¾Ñ€Ð¼Ñ‹: ' + error.message, 'error');
    }
  };

  // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ð¿ÐµÑ‡Ð°Ñ‚Ð¸ Ð½Ð°ÐºÐ»Ð°Ð´Ð½Ð¾Ð¹ Ð¸ ÑˆÑ‚Ñ€Ð¸Ñ…-ÐºÐ¾Ð´Ð° Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ð·Ð°ÑÐ²ÐºÐ¸
  const canPrintInvoice = () => {
    // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ñ‡Ñ‚Ð¾ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹
    return (
      operatorCargoForm.sender_full_name && 
      operatorCargoForm.sender_phone && 
      operatorCargoForm.recipient_full_name && 
      operatorCargoForm.recipient_phone &&
      totalWeight > 0 &&
      totalCost > 0
    );
  };

  const handlePrintCurrentInvoice = () => {
    if (!canPrintInvoice()) {
      showAlert('Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð²ÑÐµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð´Ð»Ñ Ð¿ÐµÑ‡Ð°Ñ‚Ð¸ Ð½Ð°ÐºÐ»Ð°Ð´Ð½Ð¾Ð¹', 'warning');
      return;
    }

    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ð¾Ð±ÑŠÐµÐºÑ‚ Ð³Ñ€ÑƒÐ·Ð° Ð¸Ð· Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ Ñ„Ð¾Ñ€Ð¼Ñ‹
    const tempCargo = {
      cargo_number: `TEMP-${Date.now()}`, // Ð’Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€
      route: operatorCargoForm.route,
      sender_full_name: operatorCargoForm.sender_full_name,
      sender_phone: operatorCargoForm.sender_phone,
      sender_address: operatorCargoForm.sender_address,
      recipient_full_name: operatorCargoForm.recipient_full_name,
      recipient_phone: operatorCargoForm.recipient_phone,
      recipient_address: operatorCargoForm.recipient_address,
      weight: totalWeight,
      total_cost: totalCost,
      declared_value: totalCost,
      cargo_items: operatorCargoForm.use_multi_cargo ? operatorCargoForm.cargo_items : [{
        cargo_name: operatorCargoForm.description || 'Ð“Ñ€ÑƒÐ·',
        weight: operatorCargoForm.weight,
        price_per_kg: operatorCargoForm.declared_value / operatorCargoForm.weight
      }],
      created_at: new Date().toISOString()
    };

    // ÐŸÐµÑ‡Ð°Ñ‚Ð°ÐµÐ¼ Ð½Ð°ÐºÐ»Ð°Ð´Ð½ÑƒÑŽ
    printInvoice(tempCargo);
  };

  const generateBarcodeData = (cargoData) => {
    // Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ ÑˆÑ‚Ñ€Ð¸Ñ…-ÐºÐ¾Ð´Ð°
    return {
      cargo_number: cargoData.cargo_number,
      sender: cargoData.sender_full_name,
      recipient: cargoData.recipient_full_name,
      weight: cargoData.weight,
      route: cargoData.route,
      date: new Date().toLocaleDateString('ru-RU')
    };
  };

  const handlePrintCurrentBarcode = () => {
    if (!canPrintInvoice()) {
      showAlert('Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð²ÑÐµ Ð¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¿Ð¾Ð»Ñ Ð´Ð»Ñ Ð¿ÐµÑ‡Ð°Ñ‚Ð¸ ÑˆÑ‚Ñ€Ð¸Ñ…-ÐºÐ¾Ð´Ð°', 'warning');
      return;
    }

    // Ð¡Ð¾Ð·Ð´Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ñ‹Ð¹ Ð¾Ð±ÑŠÐµÐºÑ‚ Ð³Ñ€ÑƒÐ·Ð°
    const tempCargo = {
      cargo_number: `TEMP-${Date.now()}`,
      sender_full_name: operatorCargoForm.sender_full_name,
      recipient_full_name: operatorCargoForm.recipient_full_name,
      weight: totalWeight,
      route: operatorCargoForm.route
    };

    // Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÐ¼ Ð¸ Ð¿ÐµÑ‡Ð°Ñ‚Ð°ÐµÐ¼ ÑˆÑ‚Ñ€Ð¸Ñ…-ÐºÐ¾Ð´
    printBarcode(tempCargo);
  };

  const printBarcode = (cargo) => {
    const printWindow = window.open('', '_blank');
    
    if (!printWindow) {
      showAlert('Ð’ÑÐ¿Ð»Ñ‹Ð²Ð°ÑŽÑ‰Ð¸Ðµ Ð¾ÐºÐ½Ð° Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ñ‹. Ð¨Ñ‚Ñ€Ð¸Ñ…-ÐºÐ¾Ð´ Ð±ÑƒÐ´ÐµÑ‚ Ð¾Ñ‚ÐºÑ€Ñ‹Ñ‚ Ð² Ð½Ð¾Ð²Ð¾Ð¹ Ð²ÐºÐ»Ð°Ð´ÐºÐµ.', 'warning');
      const barcodeContent = createBarcodeHTML(cargo);
      const dataUrl = `data:text/html;charset=utf-8,${encodeURIComponent(barcodeContent)}`;
      window.open(dataUrl, '_blank');
      return;
    }

    try {
      const barcodeHTML = createBarcodeHTML(cargo);
      printWindow.document.write(barcodeHTML);
      printWindow.document.close();
    } catch (error) {
      console.error('Error creating barcode print:', error);
      showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ ÑˆÑ‚Ñ€Ð¸Ñ…-ÐºÐ¾Ð´Ð°. ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ ÑÐ½Ð¾Ð²Ð°.', 'error');
      if (printWindow) {
        printWindow.close();
      }
    }
  };

  const createBarcodeHTML = (cargo) => {
    return `
      <html>
        <head>
          <title>Ð¨Ñ‚Ñ€Ð¸Ñ…-ÐºÐ¾Ð´ TAJLINE â„– ${cargo.cargo_number}</title>
          <meta charset="utf-8">
          <style>
            @page {
              size: A5 landscape;
              margin: 10mm;
            }
            
            body {
              font-family: Arial, sans-serif;
              margin: 0;
              padding: 20px;
              text-align: center;
            }
            
            .barcode-container {
              border: 3px solid #000;
              padding: 30px;
              margin: 20px auto;
              max-width: 500px;
              background: white;
            }
            
            .logo {
              font-size: 32px;
              font-weight: bold;
              letter-spacing: 3px;
              margin-bottom: 20px;
              color: #000;
            }
            
            .cargo-number {
              font-size: 24px;
              font-weight: bold;
              margin: 20px 0;
              padding: 15px;
              border: 2px solid #000;
              background: #f0f0f0;
            }
            
            .barcode-visual {
              margin: 30px 0;
              padding: 20px;
              border: 1px solid #ccc;
              background: white;
              font-family: 'Courier New', monospace;
              letter-spacing: 2px;
            }
            
            .barcode-lines {
              height: 60px;
              background: repeating-linear-gradient(
                90deg,
                #000 0px,
                #000 2px,
                #fff 2px,
                #fff 4px
              );
              margin: 10px 0;
            }
            
            .cargo-info {
              margin: 20px 0;
              text-align: left;
              font-size: 14px;
            }
            
            .cargo-info div {
              margin: 8px 0;
              display: flex;
              justify-content: space-between;
              border-bottom: 1px dotted #ccc;
              padding-bottom: 5px;
            }
            
            .cargo-info .label {
              font-weight: bold;
              width: 40%;
            }
            
            .cargo-info .value {
              width: 60%;
              text-align: right;
            }
            
            .print-date {
              font-size: 10px;
              color: #666;
              margin-top: 20px;
              border-top: 1px solid #ccc;
              padding-top: 10px;
            }

            @media print {
              body { -webkit-print-color-adjust: exact; }
            }
          </style>
        </head>
        <body>
          <div class="barcode-container">
            <div class="logo">TAJLINE</div>
            
            <div class="cargo-number">
              ${cargo.cargo_number}
            </div>
            
            <div class="barcode-visual">
              <div class="barcode-lines"></div>
              <div style="font-size: 16px; font-weight: bold;">${cargo.cargo_number}</div>
            </div>
            
            <div class="cargo-info">
              <div>
                <span class="label">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ:</span>
                <span class="value">${cargo.sender_full_name}</span>
              </div>
              <div>
                <span class="label">ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ:</span>
                <span class="value">${cargo.recipient_full_name}</span>
              </div>
              <div>
                <span class="label">Ð’ÐµÑ:</span>
                <span class="value">${cargo.weight} ÐºÐ³</span>
              </div>
              <div>
                <span class="label">ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚:</span>
                <span class="value">${cargo.route === 'moscow_dushanbe' ? 'ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð”ÑƒÑˆÐ°Ð½Ð±Ðµ' : 
                                     cargo.route === 'moscow_khujand' ? 'ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð¥ÑƒÐ´Ð¶Ð°Ð½Ð´' : 
                                     cargo.route === 'moscow_kulob' ? 'ÐœÐ¾ÑÐºÐ²Ð° â†’ ÐšÑƒÐ»Ð¾Ð±' : 
                                     cargo.route === 'moscow_kurgantyube' ? 'ÐœÐ¾ÑÐºÐ²Ð° â†’ ÐšÑƒÑ€Ð³Ð°Ð½-Ð¢ÑŽÐ±Ðµ' : 'Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½'}</span>
              </div>
            </div>
            
            <div class="print-date">
              Ð”Ð°Ñ‚Ð° Ð¿ÐµÑ‡Ð°Ñ‚Ð¸: ${new Date().toLocaleDateString('ru-RU')} ${new Date().toLocaleTimeString('ru-RU')}
            </div>
          </div>
          
          <script>
            window.onload = function() {
              setTimeout(function() {
                window.print();
                window.onafterprint = function() {
                  window.close();
                };
              }, 500);
            };
          </script>
        </body>
      </html>
    `;
  };

  // Ð‘Ð¾ÐºÐ¾Ð²Ð¾Ðµ Ð¼ÐµÐ½ÑŽ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð° Ð¸ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° ÑÐºÐ»Ð°Ð´Ð°
  const SidebarMenu = () => {
    if (user?.role === 'user') return null;

    const menuItems = [
      {
        id: 'dashboard',
        label: 'Ð“Ð»Ð°Ð²Ð½Ð°Ñ',
        icon: <Home className="w-5 h-5" />,
        section: 'dashboard'
      },
      {
        id: 'personal-dashboard',
        label: 'Ð›Ð¸Ñ‡Ð½Ñ‹Ð¹ ÐºÐ°Ð±Ð¸Ð½ÐµÑ‚',
        icon: <User className="w-5 h-5" />,
        section: 'personal-dashboard'
      },
      {
        id: 'users',
        label: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸',
        icon: <Users className="w-5 h-5" />,
        section: 'users',
        adminOnly: true,
        subsections: [
          { id: 'users-regular', label: 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸' },
          { id: 'users-operators', label: 'ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñ‹ ÑÐºÐ»Ð°Ð´Ð°' },
          { id: 'users-admins', label: 'ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñ‹' },
          { id: 'users-create-operator', label: 'Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°' }, // Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ 2
          { id: 'users-operator-bindings', label: 'ÐŸÑ€Ð¸Ð²ÑÐ·ÐºÐ° Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²' },
          { id: 'users-debtors', label: 'Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð·Ð°Ð´Ð¾Ð»Ð¶Ð½Ð¸ÐºÐ¾Ð²' }  // ÐÐžÐ’ÐÐ¯ Ð’ÐšÐ›ÐÐ”ÐšÐ
        ]
      },
      {
        id: 'operations',
        label: 'ÐžÐ¿ÐµÑ€Ð°Ñ†Ð¸Ð¸',
        icon: <Target className="w-5 h-5" />,
        section: 'operations',
        subsections: [
          { id: 'operations-search', label: 'ÐŸÐ¾Ð¸ÑÐº Ð³Ñ€ÑƒÐ·Ð°' },
          { id: 'operations-qr-generate', label: 'Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ QR ÐºÐ¾Ð´Ð¾Ð²' },
          { id: 'operations-placement', label: 'Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ' },
          { id: 'operations-receive', label: 'ÐŸÑ€Ð¸Ñ‘Ð¼ Ð³Ñ€ÑƒÐ·Ð°' }
        ]
      },
      {
        id: 'cargo-management',
        label: 'Ð“Ñ€ÑƒÐ·Ñ‹',
        icon: <Package className="w-5 h-5" />,
        section: 'cargo-management',
        subsections: [
          { id: 'cargo-accept', label: 'ÐŸÑ€Ð¸Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ð¹ Ð³Ñ€ÑƒÐ·' },
          { id: 'cargo-list', label: 'Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð³Ñ€ÑƒÐ·Ð¾Ð²' },
          { id: 'cargo-placement', label: 'Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°' },
          { id: 'cargo-history', label: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð¾Ð²' }
        ]
      },
      {
        id: 'warehouses',
        label: 'Ð¡ÐºÐ»Ð°Ð´Ñ‹',
        icon: <Building className="w-5 h-5" />,
        section: 'warehouses',
        subsections: [
          { id: 'warehouses-list', label: 'Ð¡Ð¿Ð¸ÑÐ¾Ðº ÑÐºÐ»Ð°Ð´Ð¾Ð²' },
          { id: 'warehouses-create', label: 'Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐºÐ»Ð°Ð´' },
          { id: 'warehouses-manage', label: 'Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°Ð¼Ð¸' },
          { id: 'warehouses-placed-cargo', label: 'Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹' }
        ]
      },
      {
        id: 'notifications-management',
        label: 'Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ',
        icon: <Bell className="w-5 h-5" />,
        section: 'notifications-management',
        subsections: [
          { id: 'notifications-client-orders', label: `ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð°ÐºÐ°Ð·Ñ‹ (${newOrdersCount})` },
          { id: 'notifications-requests', label: 'ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð°ÑÐ²ÐºÐ¸' },
          { id: 'notifications-system', label: 'Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ' }
        ]
      },
      {
        id: 'cashier',
        label: 'ÐšÐ°ÑÑÐ°',
        icon: <DollarSign className="w-5 h-5" />,
        section: 'cashier',
        subsections: [
          { id: 'cashier-payment', label: 'ÐŸÑ€Ð¸Ñ‘Ð¼ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹' },
          { id: 'cashier-unpaid', label: 'ÐÐµ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð¾' },
          { id: 'cashier-history', label: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹' }
        ]
      },
      {
        id: 'logistics',
        label: 'Ð›Ð¾Ð³Ð¸ÑÑ‚Ð¸ÐºÐ°',
        icon: <Zap className="w-5 h-5" />,
        section: 'logistics',
        subsections: [
          { id: 'logistics-add-transport', label: 'ÐŸÑ€Ð¸Ñ‘Ð¼ Ð¼Ð°ÑˆÐ¸Ð½Ñƒ' },
          { id: 'logistics-transport-list', label: 'Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð¾Ð²' },
          { id: 'logistics-in-transit', label: 'Ð’ Ð¿ÑƒÑ‚Ð¸' },
          { id: 'logistics-arrived', label: 'ÐÐ° Ð¼ÐµÑÑ‚Ð¾ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ðµ' },
          { id: 'logistics-history', label: 'Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¢Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ¸' }
        ]
      },
      {
        id: 'finances',
        label: 'Ð¤Ð¸Ð½Ð°Ð½ÑÑ‹',
        icon: <DollarSign className="w-5 h-5" />,
        section: 'finances',
        adminOnly: true,
        subsections: [
          { id: 'finances-overview', label: 'ÐžÐ±Ð·Ð¾Ñ€' },
          { id: 'finances-transactions', label: 'Ð¢Ñ€Ð°Ð½Ð·Ð°ÐºÑ†Ð¸Ð¸' }
        ]
      },
      {
        id: 'reports',
        label: 'ÐžÑ‚Ñ‡ÐµÑ‚Ñ‹',
        icon: <FileText className="w-5 h-5" />,
        section: 'reports',
        subsections: [
          { id: 'reports-cargo', label: 'ÐžÑ‚Ñ‡ÐµÑ‚Ñ‹ Ð¿Ð¾ Ð³Ñ€ÑƒÐ·Ð°Ð¼' },
          { id: 'reports-performance', label: 'ÐŸÑ€Ð¾Ð¸Ð·Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾ÑÑ‚ÑŒ' }
        ]
      }
    ];

    const filteredItems = menuItems.filter(item => 
      !item.adminOnly || user?.role === 'admin'
    );

    return (
      <div className={`fixed left-0 top-0 h-full bg-gray-900 text-white transition-all duration-300 z-40 ${
        sidebarOpen ? 'w-64' : 'w-16'
      }`}>
        <div className="p-4">
          <div className="flex items-center justify-between mb-8">
            {sidebarOpen && (
              <h2 className="text-xl font-bold">ÐŸÐ°Ð½ÐµÐ»ÑŒ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ</h2>
            )}
            <Button
              variant="ghost"
              size="sm"
              onClick={() => setSidebarOpen(!sidebarOpen)}
              className="text-white hover:bg-gray-800"
            >
              {sidebarOpen ? <X className="w-5 h-5" /> : <Menu className="w-5 h-5" />}
            </Button>
          </div>

          <nav className="space-y-2">
            {filteredItems.map((item) => (
              <div key={item.id}>
                <button
                  onClick={() => {
                    setActiveSection(item.section);
                    // ÐÐ²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ ÑƒÑÑ‚Ð°Ð½Ð°Ð²Ð»Ð¸Ð²Ð°ÐµÐ¼ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð¿Ð¾Ð´Ñ€Ð°Ð·Ð´ÐµÐ» Ð´Ð»Ñ Ð½ÐµÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ñ… ÑÐµÐºÑ†Ð¸Ð¹
                    if (item.section === 'warehouses' && user?.role === 'admin') {
                      setActiveTab('warehouses-list');
                    } else if (item.section === 'users' && user?.role === 'admin') {
                      setActiveTab('users-regular');
                    }
                  }}
                  className={`w-full flex items-center px-3 py-2 rounded-lg transition-colors ${
                    activeSection === item.section
                      ? 'bg-blue-600 text-white'
                      : 'text-gray-300 hover:bg-gray-800 hover:text-white'
                  }`}
                >
                  {item.icon}
                  {sidebarOpen && <span className="ml-3">{item.label}</span>}
                </button>
                
                {sidebarOpen && item.subsections && activeSection === item.section && (
                  <div className="ml-8 mt-2 space-y-1">
                    {item.subsections.map((sub) => (
                      <button
                        key={sub.id}
                        onClick={() => setActiveTab(sub.id)}
                        className="block w-full text-left px-3 py-1 text-sm text-gray-400 hover:text-white transition-colors"
                      >
                        {sub.label}
                      </button>
                    ))}
                  </div>
                )}
              </div>
            ))}
          </nav>

          {/* ÐšÐ½Ð¾Ð¿ÐºÐ° ÑÐ²ÑÐ·Ð°Ñ‚ÑŒÑÑ Ñ Ð½Ð°Ð¼Ð¸ Ð² ÐºÐ¾Ð½Ñ†Ðµ Ð¼ÐµÐ½ÑŽ */}
          <div className="mt-8 pt-4 border-t border-gray-700">
            <button
              onClick={() => setContactModal(true)}
              className="w-full flex items-center px-3 py-2 rounded-lg transition-colors text-gray-300 hover:bg-gray-800 hover:text-white"
            >
              <MessageCircle className="w-5 h-5" />
              {sidebarOpen && <span className="ml-3">Ð¡Ð²ÑÐ·Ð°Ñ‚ÑŒÑÑ Ñ Ð½Ð°Ð¼Ð¸</span>}
            </button>
          </div>
        </div>
      </div>
    );
  };

  if (!user) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100">
        <div className="container mx-auto px-4 py-8">
          <div className="max-w-md mx-auto">
            <div className="text-center mb-8">
              <div className="flex items-center justify-center mb-4">
                <img 
                  src="/logo.png" 
                  alt="TAJLINE.TJ" 
                  className="h-16 w-auto"
                  onError={(e) => {
                    e.target.style.display = 'none';
                    e.target.nextSibling.style.display = 'block';
                  }}
                />
                <div className="hidden">
                  <div className="bg-blue-600 text-white p-2 rounded-lg">
                    <Truck className="h-12 w-12" />
                  </div>
                  <h1 className="text-3xl font-bold text-blue-600 mt-2">TAJLINE.TJ</h1>
                </div>
              </div>
              <p className="text-gray-600">Ð“Ñ€ÑƒÐ·Ð¾Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ¸ ÐœÐ¾ÑÐºÐ²Ð°-Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½</p>
            </div>

            <Tabs defaultValue="login" className="w-full">
              <TabsList className="grid w-full grid-cols-2">
                <TabsTrigger value="login">Ð’Ñ…Ð¾Ð´</TabsTrigger>
                <TabsTrigger value="register">Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ</TabsTrigger>
              </TabsList>
              
              <TabsContent value="login">
                <Card>
                  <CardHeader>
                    <CardTitle>Ð’Ñ…Ð¾Ð´ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <form onSubmit={handleLogin} className="space-y-4">
                      <div>
                        <Label htmlFor="login-phone">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½</Label>
                        <Input
                          id="login-phone"
                          type="tel"
                          placeholder="+7XXXXXXXXXX"
                          value={loginForm.phone}
                          onChange={(e) => setLoginForm({...loginForm, phone: e.target.value})}
                          required
                        />
                      </div>
                      <div>
                        <Label htmlFor="login-password">ÐŸÐ°Ñ€Ð¾Ð»ÑŒ</Label>
                        <Input
                          id="login-password"
                          type="password"
                          placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿Ð°Ñ€Ð¾Ð»ÑŒ"
                          value={loginForm.password}
                          onChange={(e) => setLoginForm({...loginForm, password: e.target.value})}
                          required
                        />
                      </div>
                      <Button type="submit" className="w-full">Ð’Ð¾Ð¹Ñ‚Ð¸</Button>
                    </form>
                  </CardContent>
                </Card>
              </TabsContent>
              
              <TabsContent value="register">
                <Card>
                  <CardHeader>
                    <CardTitle>Ð ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ñ</CardTitle>
                  </CardHeader>
                  <CardContent>
                    <form onSubmit={handleRegister} className="space-y-4">
                      <div>
                        <Label htmlFor="register-name">Ð¤Ð˜Ðž</Label>
                        <Input
                          id="register-name"
                          placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»Ð½Ð¾Ðµ Ð¸Ð¼Ñ"
                          value={registerForm.full_name}
                          onChange={(e) => setRegisterForm({...registerForm, full_name: e.target.value})}
                          required
                        />
                      </div>
                      <div>
                        <Label htmlFor="register-phone">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½</Label>
                        <Input
                          id="register-phone"
                          type="tel"
                          placeholder="+7XXXXXXXXXX"
                          value={registerForm.phone}
                          onChange={(e) => setRegisterForm({...registerForm, phone: e.target.value})}
                          required
                        />
                      </div>
                      <div>
                        <Label htmlFor="register-password">ÐŸÐ°Ñ€Ð¾Ð»ÑŒ</Label>
                        <Input
                          id="register-password"
                          type="password"
                          placeholder="ÐœÐ¸Ð½Ð¸Ð¼ÑƒÐ¼ 6 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"
                          value={registerForm.password}
                          onChange={(e) => setRegisterForm({...registerForm, password: e.target.value})}
                          required
                        />
                      </div>
                      {/* Ð Ð¾Ð»ÑŒ ÑƒÐ±Ñ€Ð°Ð½Ð° - Ð²ÑÐµÐ³Ð´Ð° USER Ð¿Ð¾ ÑƒÐ¼Ð¾Ð»Ñ‡Ð°Ð½Ð¸ÑŽ (Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ 3) */}
                      <Button type="submit" className="w-full">Ð—Ð°Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒÑÑ</Button>
                    </form>
                  </CardContent>
                </Card>
              </TabsContent>
            </Tabs>

            {/* ÐžÑ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ðµ Ð±ÐµÐ· Ð°Ð²Ñ‚Ð¾Ñ€Ð¸Ð·Ð°Ñ†Ð¸Ð¸ */}
            <Card className="mt-6">
              <CardHeader>
                <CardTitle className="flex items-center">
                  <Search className="mr-2 h-5 w-5" />
                  ÐžÑ‚ÑÐ»ÐµÐ´Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·
                </CardTitle>
                <CardDescription>Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð° Ð´Ð»Ñ Ð¾Ñ‚ÑÐ»ÐµÐ¶Ð¸Ð²Ð°Ð½Ð¸Ñ</CardDescription>
              </CardHeader>
              <CardContent>
                <form onSubmit={handleTrackCargo} className="space-y-4">
                  <Input
                    placeholder="ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°"
                    value={trackingNumber}
                    onChange={(e) => setTrackingNumber(e.target.value)}
                    required
                  />
                  <Button type="submit" className="w-full">
                    <Search className="mr-2 h-4 w-4" />
                    ÐžÑ‚ÑÐ»ÐµÐ´Ð¸Ñ‚ÑŒ
                  </Button>
                </form>
                
                {trackingResult && (
                  <div className="mt-4 p-4 border rounded-lg">
                    <h3 className="font-semibold mb-2">Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ:</h3>
                    <div className="space-y-2 text-sm">
                      <p><strong>ÐÐ¾Ð¼ÐµÑ€:</strong> {trackingResult.cargo_number}</p>
                      <p><strong>ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ:</strong> {trackingResult.recipient_name}</p>
                      <p><strong>Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:</strong> {getStatusBadge(trackingResult.status)}</p>
                      <p><strong>Ð’ÐµÑ:</strong> {trackingResult.weight} ÐºÐ³</p>
                      <p><strong>ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚:</strong> {trackingResult.route === 'moscow_to_tajikistan' ? 'ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½' : 'Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½ â†’ ÐœÐ¾ÑÐºÐ²Ð°'}</p>
                      {trackingResult.warehouse_location && (
                        <p><strong>ÐœÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ:</strong> {trackingResult.warehouse_location}</p>
                      )}
                    </div>
                  </div>
                )}
              </CardContent>
            </Card>
          </div>
        </div>

        {/* Alerts */}
        <div className="fixed top-4 right-4 space-y-2 z-50">
          {alerts.map((alert) => (
            <Alert key={alert.id} className={`max-w-sm ${alert.type === 'error' ? 'border-red-500' : alert.type === 'success' ? 'border-green-500' : 'border-blue-500'}`}>
              <AlertDescription>{alert.message}</AlertDescription>
            </Alert>
          ))}
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gray-50">
      {/* Ð‘Ð¾ÐºÐ¾Ð²Ð¾Ðµ Ð¼ÐµÐ½ÑŽ */}
      {user && (user.role === 'admin' || user.role === 'warehouse_operator') && <SidebarMenu />}
      
      {/* ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ ÐºÐ¾Ð½Ñ‚ÐµÐ½Ñ‚ */}
      <div className={`${
        user && (user.role === 'admin' || user.role === 'warehouse_operator') 
          ? (sidebarOpen ? 'ml-64' : 'ml-16') 
          : ''
      } transition-all duration-300`}>
        
        {/* Header */}
        <header className="bg-white shadow-sm border-b">
          <div className="container mx-auto px-4 py-4">
            <div className="flex items-center justify-between">
              <div className="flex items-center">
                <div className="flex items-center mr-6">
                  <img 
                    src="/logo.png" 
                    alt="TAJLINE.TJ" 
                    className="h-10 w-auto"
                    onError={(e) => {
                      e.target.style.display = 'none';
                      e.target.nextSibling.style.display = 'block';
                    }}
                  />
                  <div className="hidden flex items-center">
                    <div className="bg-blue-600 text-white p-2 rounded-lg mr-3">
                      <Truck className="h-8 w-8" />
                    </div>
                    <div>
                      <h1 className="text-2xl font-bold text-blue-600">TAJLINE.TJ</h1>
                      <p className="text-sm text-gray-600">Ð“Ñ€ÑƒÐ·Ð¾Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ¸ ÐœÐ¾ÑÐºÐ²Ð°-Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½</p>
                    </div>
                  </div>
                </div>
              </div>
              
              <div className="flex items-center space-x-4">
                <div className="flex items-center space-x-2">
                  {getRoleIcon(user.role)}
                  <div className="flex flex-col">
                    <span className="text-sm font-medium">{user.full_name}</span>
                    {user.user_number && (
                      <span className="text-xs text-gray-500">â„– {user.user_number}</span>
                    )}
                  </div>
                  <Badge variant="outline">{getRoleLabel(user.role)}</Badge>
                </div>
                
                <DropdownMenu>
                  <DropdownMenuTrigger asChild>
                    <div className="relative cursor-pointer">
                      <Bell className="h-5 w-5 text-gray-600 hover:text-gray-800 transition-colors" />
                      {notifications.filter(n => n.status === 'unread').length > 0 && (
                        <span className="absolute -top-2 -right-2 bg-red-500 text-white text-xs rounded-full h-5 w-5 flex items-center justify-center">
                          {notifications.filter(n => n.status === 'unread').length}
                        </span>
                      )}
                    </div>
                  </DropdownMenuTrigger>
                  <DropdownMenuContent align="end" className="w-80 max-h-96 overflow-y-auto">
                    <div className="px-3 py-2 border-b">
                      <h3 className="font-semibold text-sm">Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ</h3>
                    </div>
                    
                    {/* Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÑÐ¸ÑÑ‚ÐµÐ¼Ð¾Ð¹ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ */}
                    {notifications.length > 0 && (
                      <>
                        <div className="px-3 py-1 bg-gray-50">
                          <p className="text-xs font-medium text-gray-600">Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ</p>
                        </div>
                        {notifications.slice(0, 8).map((notification) => (
                          <div key={`notification-${notification.id}`} className={`p-3 border-b hover:bg-gray-50 ${notification.status === 'unread' ? 'bg-blue-50 border-l-4 border-l-blue-400' : ''}`}>
                            <div className="w-full">
                              <p className={`text-sm leading-tight ${notification.status === 'unread' ? 'font-medium' : ''}`}>
                                {notification.message}
                              </p>
                              <p className="text-xs text-gray-500 mt-1">
                                {new Date(notification.created_at).toLocaleString('ru-RU')}
                              </p>
                              
                              {/* Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ */}
                              <div className="flex space-x-1 mt-2">
                                {notification.status === 'unread' && (
                                  <button
                                    onClick={(e) => {
                                      e.stopPropagation();
                                      handleMarkNotificationAsRead(notification.id);
                                    }}
                                    className="text-xs px-2 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200 transition-colors"
                                  >
                                    ÐŸÑ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð¾
                                  </button>
                                )}
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    handleViewNotificationDetails(notification.id);
                                  }}
                                  className="text-xs px-2 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200 transition-colors"
                                >
                                  ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ
                                </button>
                                <button
                                  onClick={(e) => {
                                    e.stopPropagation();
                                    handleDeleteNotification(notification.id);
                                  }}
                                  className="text-xs px-2 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200 transition-colors"
                                >
                                  Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ
                                </button>
                              </div>
                            </div>
                          </div>
                        ))}
                        {notifications.length > 8 && (
                          <div className="px-3 py-2 text-xs text-gray-500 text-center border-t">
                            Ð˜ ÐµÑ‰Ðµ {notifications.length - 8} ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹...
                          </div>
                        )}
                      </>
                    )}
                    
                    {/* ÐŸÑƒÑÑ‚Ð¾Ðµ ÑÐ¾ÑÑ‚Ð¾ÑÐ½Ð¸Ðµ */}
                    {notifications.length === 0 && (
                      <div className="p-4 text-center text-gray-500">
                        <Bell className="mx-auto h-8 w-8 text-gray-400 mb-2" />
                        <p className="text-sm">ÐÐµÑ‚ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹</p>
                      </div>
                    )}
                  </DropdownMenuContent>
                </DropdownMenu>
                
                <Button variant="outline" onClick={handleLogout}>
                  Ð’Ñ‹Ð¹Ñ‚Ð¸
                </Button>
              </div>
            </div>
          </div>
        </header>

        {/* Main Content */}
        <main className="container mx-auto px-4 py-8">
          {/* Cargo Placement Page */}
          {currentPage === 'cargo-placement' ? (
            <div className="min-h-screen bg-gray-50">
              {/* Page Header */}
              <div className="bg-white shadow-sm rounded-lg mb-6 p-6">
                <div className="flex items-center justify-between">
                  <div className="flex items-center">
                    <Button
                      variant="ghost"
                      size="sm"
                      onClick={closeCargoPlacementPage}
                      className="mr-4 text-gray-600 hover:text-gray-800"
                    >
                      <ArrowLeft className="h-4 w-4 mr-2" />
                      ÐÐ°Ð·Ð°Ð´
                    </Button>
                    <div>
                      <h1 className="text-2xl font-bold text-gray-900">Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°</h1>
                      <p className="text-gray-600 mt-1">Ð¡ÐºÐ°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ QR ÐºÐ¾Ð´Ñ‹ Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð¸ ÑÑ‡ÐµÐµÐº Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ</p>
                    </div>
                  </div>
                </div>
              </div>

              {/* Cargo Placement Content */}
              <div className="max-w-4xl mx-auto">
                {/* Progress Steps */}
                <div className="mb-8">
                  <div className="flex items-center justify-center space-x-8">
                    <div className={`flex items-center ${placementStep === 'scan-cargo' || placementStep === 'scan-cell' ? 'text-blue-600' : 'text-gray-400'}`}>
                      <div className={`w-8 h-8 rounded-full flex items-center justify-center ${placementStep === 'scan-cargo' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}>
                        1
                      </div>
                      <span className="ml-2 font-medium">Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·</span>
                    </div>
                    <div className="h-px bg-gray-300 flex-1 max-w-32"></div>
                    <div className={`flex items-center ${placementStep === 'scan-cell' ? 'text-blue-600' : 'text-gray-400'}`}>
                      <div className={`w-8 h-8 rounded-full flex items-center justify-center ${placementStep === 'scan-cell' ? 'bg-blue-600 text-white' : 'bg-gray-200'}`}>
                        2
                      </div>
                      <span className="ml-2 font-medium">Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÑ‡ÐµÐ¹ÐºÑƒ</span>
                    </div>
                  </div>
                </div>

                {/* Current Step Content */}
                <>
                <Card 
                  className={`mb-6 ${placementStep === 'scan-cargo' ? 'react-visible' : 'react-hidden'}`}
                >
                  <CardHeader>
                    <CardTitle className="flex items-center">
                      <QrCode className="mr-2 h-5 w-5" />
                      Ð¨Ð°Ð³ 1: Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°
                    </CardTitle>
                    <CardDescription>
                      ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð° Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                      {/* Isolated Camera Scanner Container to prevent React conflicts */}
                      <div className="relative">
                        <div className="bg-black rounded-lg p-4 mb-4">
                          <div 
                            ref={qrContainerRef}
                            className="w-full min-h-[400px] flex items-center justify-center"
                            style={{ 
                              display: 'block', 
                              minHeight: '400px', 
                              backgroundColor: '#000000',
                              borderRadius: '8px' 
                            }}
                          >
                            {!scannerActive && (
                              <div className="text-white text-center p-8">
                                <Camera className="mx-auto h-16 w-16 mb-4 text-gray-400" />
                                <p className="text-lg font-medium mb-2">Ð˜Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ ÐºÐ°Ð¼ÐµÑ€Ð° Ð³Ð¾Ñ‚Ð¾Ð²Ð°</p>
                                <p className="text-sm text-gray-300">
                                  ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ Ð½Ð¸Ð¶Ðµ Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ ÑÐºÐ°Ð½ÐµÑ€Ð°
                                </p>
                              </div>
                            )}
                          </div>
                        </div>
                        
                        {/* Camera Controls - isolated from React lifecycle */}
                        <div className="flex justify-center space-x-4 mb-4">
                          {availablePlacementCameras.length > 1 && scannerActive && (
                            <Button 
                              onClick={switchPlacementCamera}
                              variant="outline"
                              size="sm"
                            >
                              <Camera className="mr-2 h-4 w-4" />
                              ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ
                            </Button>
                          )}
                          
                          {scannerActive && (
                            <Button 
                              onClick={async () => {
                                await completeQrCleanup("User Stop");
                              }}
                              variant="outline"
                              size="sm"
                            >
                              <X className="mr-2 h-4 w-4" />
                              ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ
                            </Button>
                          )}
                        </div>
                      </div>

                      <div 
                        className={`space-y-4 ${!scannerActive ? 'react-visible' : 'react-hidden'}`}
                      >
                          {/* Camera unavailable message with enhanced mobile retry */}
                          <div 
                            className={`space-y-3 ${placementActive ? 'react-visible' : 'react-hidden'}`}
                          >
                              <div className="text-center p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                <div className="text-yellow-800 font-medium mb-2">
                                  ðŸ“± ÐšÐ°Ð¼ÐµÑ€Ð° Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°
                                </div>
                                <p className="text-sm text-yellow-700 mb-4">
                                  Ð”Ð»Ñ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ QR ÐºÐ¾Ð´Ð¾Ð² Ð½Ð° Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð¼ ÑƒÑÑ‚Ñ€Ð¾Ð¹ÑÑ‚Ð²Ðµ Ð¿Ð¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ:
                                </p>
                                
                                {/* Mobile-specific camera retry buttons */}
                                <div className="space-y-2">
                                  <Button 
                                    onClick={async () => {
                                      console.log('ðŸ”„ ÐžÐ±Ñ‹Ñ‡Ð½Ð°Ñ Ð¿Ð¾Ð¿Ñ‹Ñ‚ÐºÐ° Ñ Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð¹ Ð¾Ñ‡Ð¸ÑÑ‚ÐºÐ¾Ð¹...');
                                      await completeQrCleanup("Normal Retry");
                                      
                                      await new Promise(resolve => setTimeout(resolve, 1000));
                                      
                                      const cameraAvailable = await checkCameraAvailability();
                                      if (cameraAvailable) {
                                        showAlert('âœ… ÐšÐ°Ð¼ÐµÑ€Ð° Ð½Ð°Ð¹Ð´ÐµÐ½Ð°! Ð—Ð°Ð¿ÑƒÑÐº Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ ÑÐºÐ°Ð½ÐµÑ€Ð°...', 'success');
                                        await new Promise(resolve => setTimeout(resolve, 2000));
                                        try {
                                          await startQRScannerForPlacement();
                                        } catch (error) {
                                          console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ ÑÐºÐ°Ð½ÐµÑ€Ð°:', error);
                                        }
                                      }
                                    }}
                                    size="sm"
                                    variant="outline"
                                    className="w-full text-xs bg-white text-blue-600 border-blue-300 hover:bg-blue-50"
                                  >
                                    <RefreshCw className="mr-1 h-3 w-3" />
                                    ÐŸÐ¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ½Ð¾Ð²Ð°
                                  </Button>
                                  
                                  <Button 
                                    onClick={async () => {
                                      console.log('ðŸ”§ Ð˜Ð—ÐžÐ›Ð˜Ð ÐžÐ’ÐÐÐÐ«Ð™ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð¼Ð¾Ð±Ð¸Ð»ÑŒÐ½Ð¾Ð¹ ÐºÐ°Ð¼ÐµÑ€Ñ‹...');
                                      showAlert('ðŸ”§ Ð˜Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº...', 'info');
                                      
                                      // Complete isolation cleanup first
                                      await completeQrCleanup("Force Isolated Retry");
                                      
                                      // Wait longer for complete cleanup
                                      await new Promise(resolve => setTimeout(resolve, 3000));
                                      
                                      // Direct isolated scanner start without availability check
                                      try {
                                        console.log('ðŸš€ ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð¸Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð³Ð¾ ÑÐºÐ°Ð½ÐµÑ€Ð°...');
                                        await startQRScannerForPlacement();
                                        showAlert('ðŸŽ‰ Ð˜Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº ÑƒÑÐ¿ÐµÑˆÐµÐ½!', 'success');
                                      } catch (error) {
                                        console.error('âŒ Ð˜Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÑ:', error);
                                        showAlert('âŒ Ð˜Ð·Ð¾Ð»Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð¿Ñ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº Ð½Ðµ ÑƒÐ´Ð°Ð»ÑÑ. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð²Ð²Ð¾Ð´.', 'error');
                                      }
                                    }}
                                    size="sm"
                                    variant="default"
                                    className="w-full text-xs bg-green-600 text-white hover:bg-green-700"
                                  >
                                    <Camera className="mr-1 h-3 w-3" />
                                    ÐŸÑ€Ð¸Ð½ÑƒÐ´Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ð¹ Ð·Ð°Ð¿ÑƒÑÐº
                                  </Button>
                                </div>
                                
                                <div className="mt-4 p-3 bg-blue-50 border border-blue-200 rounded text-xs text-blue-800">
                                  ðŸ’¡ <strong>Ð˜Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ñ Ð´Ð»Ñ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°:</strong>
                                  <br />â€¢ ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ "Ð Ð°Ð·Ñ€ÐµÑˆÐ¸Ñ‚ÑŒ" Ð¿Ñ€Ð¸ Ð·Ð°Ð¿Ñ€Ð¾ÑÐµ ÐºÐ°Ð¼ÐµÑ€Ñ‹
                                  <br />â€¢ Ð—Ð°ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð´Ñ€ÑƒÐ³Ð¸Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ ÐºÐ°Ð¼ÐµÑ€Ñ‹
                                  <br />â€¢ ÐŸÐ¾Ð¿Ñ€Ð¾Ð±ÑƒÐ¹Ñ‚Ðµ Ð¾Ð±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ (F5)
                                  <br />â€¢ Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Chrome Ð¸Ð»Ð¸ Safari
                                </div>
                              </div>
                            </div>

                          {/* Manual Input Section */}
                          {placementActive && (
                          <div className="bg-white border rounded-lg p-4">
                            <h3 className="font-medium mb-4 flex items-center">
                              <Edit3 className="mr-2 h-4 w-4" />
                              Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð²Ð²Ð¾Ð´ Ð´Ð°Ð½Ð½Ñ‹Ñ…
                            </h3>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              {/* Cargo Number Input */}
                              <div>
                                <Label htmlFor="manual-cargo-full">ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°</Label>
                                <Input
                                  id="manual-cargo-full"
                                  placeholder="ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: TEMP-123456"
                                  value={manualCargoNumber}
                                  onChange={(e) => {
                                    setManualCargoNumber(e.target.value);
                                    // Add validation logic here if needed
                                  }}
                                  className="mt-1"
                                />
                              </div>
                              
                              {/* Cell Code Input */}
                              <div>
                                <Label htmlFor="manual-cell-full">ÐšÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸</Label>
                                <Input
                                  id="manual-cell-full"
                                  placeholder="ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: W001-Ð‘1-ÐŸ1-Ð¯1"
                                  value={manualCellCode}
                                  onChange={(e) => setManualCellCode(e.target.value)}
                                  className="mt-1"
                                />
                              </div>
                            </div>
                            
                            {/* Available Cells Display */}
                            {availableCellsForPlacement.length > 0 && (
                              <div className="mt-4">
                                <h4 className="font-medium mb-2">Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ ÑÑ‡ÐµÐ¹ÐºÐ¸:</h4>
                                <div className="max-h-32 overflow-y-auto">
                                  {availableCellsForPlacement.slice(0, 10).map((cell, index) => (
                                    <div 
                                      key={index} 
                                      className="text-sm p-2 bg-gray-50 rounded border mb-1 cursor-pointer hover:bg-gray-100"
                                      onClick={() => setManualCellCode(cell.cell_code)}
                                    >
                                      <div className="font-mono">{cell.cell_code}</div>
                                      <div className="text-gray-600">{cell.location_description}</div>
                                    </div>
                                  ))}
                                  {availableCellsForPlacement.length > 10 && (
                                    <div className="text-sm text-gray-500 text-center">
                                      ... Ð¸ ÐµÑ‰Ðµ {availableCellsForPlacement.length - 10} ÑÑ‡ÐµÐµÐº
                                    </div>
                                  )}
                                </div>
                              </div>
                            )}
                            
                            {/* Manual Placement Button */}
                            <div className="mt-4">
                              <Button 
                                onClick={handleManualPlacement}
                                className="w-full bg-green-600 hover:bg-green-700"
                                disabled={!manualCargoNumber.trim() || !manualCellCode.trim()}
                              >
                                <Package className="mr-2 h-4 w-4" />
                                Ð Ð°Ð·Ð¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
                              </Button>
                            </div>
                          </div>
                          )}
                      </div>
                    </CardContent>
                  </Card>

                  {/* Placement Statistics */}
                  <Card 
                    className={`mb-6 ${placementStatistics ? 'react-visible' : 'react-hidden'}`}
                  >
                    <CardHeader>
                      <CardTitle className="flex items-center">
                        <BarChart3 className="mr-2 h-5 w-5" />
                        Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ
                      </CardTitle>
                    </CardHeader>
                    <CardContent>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div className="text-center p-3 bg-blue-50 rounded-lg">
                          <div className="text-2xl font-bold text-blue-600">{placementStatistics?.today_placements || 0}</div>
                          <div className="text-sm text-gray-600">Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ</div>
                        </div>
                        <div className="text-center p-3 bg-green-50 rounded-lg">
                          <div className="text-2xl font-bold text-green-600">{placementStatistics?.session_placements || 0}</div>
                          <div className="text-sm text-gray-600">Ð—Ð° ÑÐµÑÑÐ¸ÑŽ</div>
                        </div>
                        <div className="text-center p-3 bg-orange-50 rounded-lg">
                          <div className="text-2xl font-bold text-orange-600">{placementStatistics?.recent_placements || 0}</div>
                          <div className="text-sm text-gray-600">ÐÐµÐ´Ð°Ð²Ð½Ð¸Ñ…</div>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                {/* Action Buttons */}
                <div className="flex justify-center space-x-4">
                  <Button 
                    onClick={closeCargoPlacementPage}
                    variant="outline"
                    size="lg"
                  >
                    <X className="mr-2 h-4 w-4" />
                    Ð—Ð°Ð²ÐµÑ€ÑˆÐ¸Ñ‚ÑŒ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ
                  </Button>
                </div>
                </>
              </div>
            </div>
          ) : 
          
          /* Main content for different user roles */
          user?.role === 'user' ? (
            <div className="space-y-6">
              {/* Client Dashboard Header */}
              <div className="flex items-center justify-between">
                <div className="flex items-center space-x-4">
                  <img 
                    src="/logo.png" 
                    alt="TAJLINE.TJ" 
                    className="h-12 w-auto"
                    onError={(e) => {
                      e.target.style.display = 'none';
                      e.target.nextSibling.style.display = 'block';
                    }}
                  />
                  <div className="hidden">
                    <h1 className="text-3xl font-bold text-gray-900">TAJLINE.TJ</h1>
                  </div>
                  <div>
                    <h1 className="text-3xl font-bold text-gray-900">Ð”Ð¾Ð±Ñ€Ð¾ Ð¿Ð¾Ð¶Ð°Ð»Ð¾Ð²Ð°Ñ‚ÑŒ, {user.full_name}!</h1>
                    <p className="text-gray-600 mt-1">Ð’Ð°Ñˆ Ð»Ð¸Ñ‡Ð½Ñ‹Ð¹ ÐºÐ°Ð±Ð¸Ð½ÐµÑ‚ Ð´Ð»Ñ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°Ð¼Ð¸</p>
                  </div>
                </div>
                <div className="flex items-center space-x-4">
                  <Button 
                    variant="outline" 
                    onClick={openEditProfile}
                    className="text-blue-600 hover:text-blue-700"
                  >
                    <Settings className="mr-2 h-4 w-4" />
                    Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ
                  </Button>
                  <Button 
                    variant="outline" 
                    onClick={() => {
                      fetchClientDashboard();
                      fetchClientCargo();
                    }}
                  >
                    <Package className="mr-2 h-4 w-4" />
                    ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ
                  </Button>
                </div>
              </div>

              {/* Client Dashboard Stats */}
              {clientDashboard && (
                <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                  <Card>
                    <CardContent className="p-6">
                      <div className="flex items-center">
                        <Package className="h-8 w-8 text-blue-600" />
                        <div className="ml-4">
                          <p className="text-sm font-medium text-gray-600">Ð’ÑÐµÐ³Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²</p>
                          <p className="text-2xl font-bold text-gray-900">
                            {clientDashboard.cargo_summary?.total_cargo || 0}
                          </p>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  <Card>
                    <CardContent className="p-6">
                      <div className="flex items-center">
                        <Clock className="h-8 w-8 text-yellow-600" />
                        <div className="ml-4">
                          <p className="text-sm font-medium text-gray-600">Ð’ Ð¿ÑƒÑ‚Ð¸</p>
                          <p className="text-2xl font-bold text-gray-900">
                            {clientDashboard.cargo_summary?.status_breakdown?.in_transit || 0}
                          </p>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  <Card>
                    <CardContent className="p-6">
                      <div className="flex items-center">
                        <CheckCircle className="h-8 w-8 text-green-600" />
                        <div className="ml-4">  
                          <p className="text-sm font-medium text-gray-600">Ð”Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð¾</p>
                          <p className="text-2xl font-bold text-gray-900">
                            {clientDashboard.cargo_summary?.status_breakdown?.delivered || 0}
                          </p>
                        </div>
                      </div>
                    </CardContent>
                  </Card>

                  <Card>
                    <CardContent className="p-6">
                      <div className="flex items-center">
                        <CreditCard className="h-8 w-8 text-red-600" />
                        <div className="ml-4">
                          <p className="text-sm font-medium text-gray-600">Ðš Ð¾Ð¿Ð»Ð°Ñ‚Ðµ</p>
                          <p className="text-2xl font-bold text-gray-900">
                            {clientDashboard.cargo_summary?.unpaid_cargo_count || 0}
                          </p>
                        </div>
                      </div>
                    </CardContent>
                  </Card>
                </div>
              )}

              {/* Client Navigation Tabs */}
              <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
                <TabsList className="grid w-full grid-cols-5">
                  <TabsTrigger value="dashboard" className="flex items-center">
                    <Home className="mr-2 h-4 w-4" />
                    Ð“Ð»Ð°Ð²Ð½Ð°Ñ
                  </TabsTrigger>
                  <TabsTrigger value="create-order" className="flex items-center">
                    <Plus className="mr-2 h-4 w-4" />
                    ÐžÑ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·
                  </TabsTrigger>
                  <TabsTrigger value="cargo" className="flex items-center">
                    <Package className="mr-2 h-4 w-4" />
                    ÐœÐ¾Ð¸ Ð³Ñ€ÑƒÐ·Ñ‹
                  </TabsTrigger>
                  <TabsTrigger value="requests" className="flex items-center">
                    <FileText className="mr-2 h-4 w-4" />
                    Ð—Ð°ÑÐ²ÐºÐ¸
                  </TabsTrigger>
                  <TabsTrigger value="contact" className="flex items-center">
                    <MessageCircle className="mr-2 h-4 w-4" />
                    Ð¡Ð²ÑÐ·ÑŒ
                  </TabsTrigger>
                </TabsList>

                {/* Dashboard Tab */}
                <TabsContent value="dashboard" className="space-y-6">
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* Recent Cargo */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Package className="mr-2 h-5 w-5" />
                          ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ñ‹
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {clientDashboard?.recent_cargo && clientDashboard.recent_cargo.length > 0 ? (
                            clientDashboard.recent_cargo.slice(0, 3).map((cargo) => (
                              <div key={cargo.id} className="flex items-center justify-between p-3 border rounded-lg">
                                <div>
                                  <div className="font-medium">#{cargo.cargo_number}</div>
                                  <div className="text-sm text-gray-600">{cargo.cargo_name || 'Ð“Ñ€ÑƒÐ·'}</div>
                                  <div className="text-xs text-gray-500">
                                    {cargo.recipient_full_name}
                                  </div>
                                </div>
                                <Badge variant={cargo.status === 'delivered' ? 'default' : 'outline'}>
                                  {cargo.status}
                                </Badge>
                              </div>
                            ))
                          ) : (
                            <p className="text-gray-500 text-center py-4">ÐÐµÑ‚ Ð¿Ð¾ÑÐ»ÐµÐ´Ð½Ð¸Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð²</p>
                          )}
                        </div>
                        <div className="mt-4">
                          <Button 
                            variant="outline" 
                            className="w-full" 
                            onClick={() => {
                              setActiveTab('cargo');
                              fetchClientCargo();
                            }}
                          >
                            ÐŸÐ¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ Ð²ÑÐµ Ð³Ñ€ÑƒÐ·Ñ‹
                          </Button>
                        </div>
                      </CardContent>
                    </Card>

                    {/* Unpaid Cargo */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <CreditCard className="mr-2 h-5 w-5 text-red-600" />
                          Ðš Ð¾Ð¿Ð»Ð°Ñ‚Ðµ
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {clientDashboard?.unpaid_cargo && clientDashboard.unpaid_cargo.length > 0 ? (
                            clientDashboard.unpaid_cargo.slice(0, 3).map((cargo) => (
                              <div key={cargo.id} className="flex items-center justify-between p-3 border rounded-lg bg-red-50">
                                <div>
                                  <div className="font-medium">#{cargo.cargo_number}</div>
                                  <div className="text-sm text-gray-600">{cargo.cargo_name || 'Ð“Ñ€ÑƒÐ·'}</div>
                                  <div className="text-sm font-medium text-red-600">
                                    {cargo.declared_value} â‚½
                                  </div>
                                </div>
                                <Button size="sm" variant="outline">
                                  ÐžÐ¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ
                                </Button>
                              </div>
                            ))
                          ) : (
                            <p className="text-gray-500 text-center py-4">Ð’ÑÐµ Ð³Ñ€ÑƒÐ·Ñ‹ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ñ‹!</p>
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  </div>

                  {/* Quick Actions */}
                  <Card>
                    <CardHeader>
                      <CardTitle>Ð‘Ñ‹ÑÑ‚Ñ€Ñ‹Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ</CardTitle>
                    </CardHeader>
                    <CardContent>
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <Button 
                          className="h-20 flex-col" 
                          variant="outline"
                          onClick={() => setActiveTab('create-order')}
                        >
                          <Plus className="h-6 w-6 mb-2" />
                          ÐžÑ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·
                        </Button>
                        <Button 
                          className="h-20 flex-col" 
                          variant="outline"
                          onClick={() => setActiveTab('cargo')}
                        >
                          <Package className="h-6 w-6 mb-2" />
                          ÐžÑ‚ÑÐ»ÐµÐ´Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·
                        </Button>
                        <Button 
                          className="h-20 flex-col" 
                          variant="outline"
                          onClick={() => setActiveTab('contact')}
                        >
                          <MessageCircle className="h-6 w-6 mb-2" />
                          Ð¡Ð²ÑÐ·Ð°Ñ‚ÑŒÑÑ Ñ Ð½Ð°Ð¼Ð¸
                        </Button>
                      </div>
                    </CardContent>
                  </Card>
                </TabsContent>

                {/* Create Cargo Order Tab */}
                <TabsContent value="create-order" className="space-y-6">
                  <div className="max-w-4xl mx-auto">
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Plus className="mr-2 h-5 w-5 text-blue-600" />
                          ÐžÑ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°
                        </CardTitle>
                        <CardDescription>
                          Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ð¹Ñ‚Ðµ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð¸ Ð¾Ñ„Ð¾Ñ€Ð¼Ð¸Ñ‚Ðµ Ð³Ñ€ÑƒÐ· Ð´Ð»Ñ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <form onSubmit={handleCreateCargoOrder} className="space-y-6">
                          {/* ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ */}
                          <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div className="space-y-4">
                              <h3 className="text-lg font-semibold text-gray-900 border-b pb-2">
                                Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ
                              </h3>
                              
                              <div>
                                <Label htmlFor="cargo_name">ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° *</Label>
                                <Input
                                  id="cargo_name"
                                  value={cargoOrderForm.cargo_name}
                                  onChange={(e) => setCargoOrderForm({...cargoOrderForm, cargo_name: e.target.value})}
                                  placeholder="Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹, Ð¾Ð´ÐµÐ¶Ð´Ð°, Ð¿Ð¾Ð´Ð°Ñ€ÐºÐ¸..."
                                  required
                                />
                              </div>

                              <div>
                                <Label htmlFor="description">ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ð³Ð¾ *</Label>
                                <Textarea
                                  id="description"
                                  value={cargoOrderForm.description}
                                  onChange={(e) => setCargoOrderForm({...cargoOrderForm, description: e.target.value})}
                                  placeholder="ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ð³Ð¾ Ð³Ñ€ÑƒÐ·Ð°"
                                  required
                                />
                              </div>

                              <div className="grid grid-cols-2 gap-4">
                                <div>
                                  <Label htmlFor="weight">Ð’ÐµÑ (ÐºÐ³) *</Label>
                                  <Input
                                    id="weight"
                                    type="number"
                                    step="0.1"
                                    min="0.1"
                                    max="10000"
                                    value={cargoOrderForm.weight}
                                    onChange={(e) => {
                                      setCargoOrderForm({...cargoOrderForm, weight: e.target.value});
                                      setCostCalculation(null);
                                    }}
                                    placeholder="5.0"
                                    required
                                  />
                                </div>
                                <div>
                                  <Label htmlFor="declared_value">ÐžÐ±ÑŠÑÐ²Ð»ÐµÐ½Ð½Ð°Ñ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ (â‚½) *</Label>
                                  <Input
                                    id="declared_value"
                                    type="number"
                                    min="100"
                                    max="10000000"
                                    value={cargoOrderForm.declared_value}
                                    onChange={(e) => {
                                      setCargoOrderForm({...cargoOrderForm, declared_value: e.target.value});
                                      setCostCalculation(null);
                                    }}
                                    placeholder="25000"
                                    required
                                  />
                                </div>
                              </div>

                              <div className="grid grid-cols-2 gap-4">
                                <div>
                                  <Label htmlFor="route">ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ *</Label>
                                  <Select 
                                    value={cargoOrderForm.route} 
                                    onValueChange={(value) => {
                                      handleRouteChange(value); // Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ð½Ð¾Ð²ÑƒÑŽ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑŽ
                                      setCostCalculation(null);
                                    }}
                                  >
                                    <SelectTrigger>
                                      <SelectValue />
                                    </SelectTrigger>
                                    <SelectContent>
                                      {deliveryOptions?.routes?.map((route) => (
                                        <SelectItem key={route.value} value={route.value}>
                                          {route.label} ({route.base_days} Ð´Ð½ÐµÐ¹)
                                        </SelectItem>
                                      ))}
                                    </SelectContent>
                                  </Select>
                                </div>
                                <div>
                                  <Label htmlFor="delivery_type">Ð¢Ð¸Ð¿ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ *</Label>
                                  <Select 
                                    value={cargoOrderForm.delivery_type} 
                                    onValueChange={(value) => {
                                      setCargoOrderForm({...cargoOrderForm, delivery_type: value});
                                      setCostCalculation(null);
                                    }}
                                  >
                                    <SelectTrigger>
                                      <SelectValue />
                                    </SelectTrigger>
                                    <SelectContent>
                                      {deliveryOptions?.delivery_types?.map((type) => (
                                        <SelectItem key={type.value} value={type.value}>
                                          {type.label}
                                        </SelectItem>
                                      ))}
                                    </SelectContent>
                                  </Select>
                                </div>
                              </div>
                            </div>

                            <div className="space-y-4">
                              <h3 className="text-lg font-semibold text-gray-900 border-b pb-2">
                                Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ðµ
                              </h3>
                              
                              <div>
                                <Label htmlFor="recipient_full_name">Ð¤Ð˜Ðž Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ *</Label>
                                <Input
                                  id="recipient_full_name"
                                  value={cargoOrderForm.recipient_full_name}
                                  onChange={(e) => setCargoOrderForm({...cargoOrderForm, recipient_full_name: e.target.value})}
                                  placeholder="ÐÐ»Ð¸ÐµÐ² Ð¤Ð°Ñ€Ñ…Ð¾Ð´ Ð Ð°Ñ…Ð¸Ð¼Ð¾Ð²Ð¸Ñ‡"
                                  required
                                />
                              </div>

                              <div>
                                <Label htmlFor="recipient_phone">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ *</Label>
                                <Input
                                  id="recipient_phone"
                                  type="tel"
                                  value={cargoOrderForm.recipient_phone}
                                  onChange={(e) => setCargoOrderForm({...cargoOrderForm, recipient_phone: e.target.value})}
                                  placeholder="+992901234567"
                                  required
                                />
                              </div>

                              <div>
                                <Label htmlFor="recipient_address">ÐÐ´Ñ€ÐµÑ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ *</Label>
                                <Input
                                  id="recipient_address"
                                  value={cargoOrderForm.recipient_address}
                                  onChange={(e) => setCargoOrderForm({...cargoOrderForm, recipient_address: e.target.value})}
                                  placeholder="ÑƒÐ». Ð ÑƒÐ´Ð°ÐºÐ¸, 15, ÐºÐ². 25"
                                  required
                                />
                              </div>

                              <div>
                                <Label htmlFor="recipient_city">Ð“Ð¾Ñ€Ð¾Ð´ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ *</Label>
                                <Input
                                  id="recipient_city"
                                  value={cargoOrderForm.recipient_city}
                                  onChange={(e) => setCargoOrderForm({...cargoOrderForm, recipient_city: e.target.value})}
                                  placeholder="Ð”ÑƒÑˆÐ°Ð½Ð±Ðµ"
                                  required
                                />
                              </div>
                            </div>
                          </div>

                          {/* Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑƒÑÐ»ÑƒÐ³Ð¸ */}
                          <div className="border-t pt-6">
                            <h3 className="text-lg font-semibold text-gray-900 mb-4">
                              Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ ÑƒÑÐ»ÑƒÐ³Ð¸
                            </h3>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                              {/* Ð¡Ñ‚Ñ€Ð°Ñ…Ð¾Ð²Ð°Ð½Ð¸Ðµ */}
                              <div className="flex items-center space-x-2 p-4 border rounded-lg">
                                <input
                                  type="checkbox"
                                  id="insurance_requested"
                                  checked={cargoOrderForm.insurance_requested}
                                  onChange={(e) => {
                                    setCargoOrderForm({
                                      ...cargoOrderForm, 
                                      insurance_requested: e.target.checked,
                                      insurance_value: e.target.checked ? cargoOrderForm.declared_value : ''
                                    });
                                    setCostCalculation(null);
                                  }}
                                  className="rounded"
                                />
                                <div className="flex-1">
                                  <Label htmlFor="insurance_requested" className="font-medium">
                                    Ð¡Ñ‚Ñ€Ð°Ñ…Ð¾Ð²Ð°Ð½Ð¸Ðµ
                                  </Label>
                                  <p className="text-sm text-gray-600">
                                    0.5% Ð¾Ñ‚ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸, Ð¼Ð¸Ð½. 500 â‚½
                                  </p>
                                  {cargoOrderForm.insurance_requested && (
                                    <Input
                                      type="number"
                                      value={cargoOrderForm.insurance_value}
                                      onChange={(e) => {
                                        setCargoOrderForm({...cargoOrderForm, insurance_value: e.target.value});
                                        setCostCalculation(null);
                                      }}
                                      placeholder="Ð¡ÑƒÐ¼Ð¼Ð° ÑÑ‚Ñ€Ð°Ñ…Ð¾Ð²Ð°Ð½Ð¸Ñ"
                                      className="mt-2"
                                    />
                                  )}
                                </div>
                              </div>

                              {/* Ð£Ð¿Ð°ÐºÐ¾Ð²ÐºÐ° */}
                              <div className="flex items-center space-x-2 p-4 border rounded-lg">
                                <input
                                  type="checkbox"
                                  id="packaging_service"
                                  checked={cargoOrderForm.packaging_service}
                                  onChange={(e) => {
                                    setCargoOrderForm({...cargoOrderForm, packaging_service: e.target.checked});
                                    setCostCalculation(null);
                                  }}
                                  className="rounded"
                                />
                                <div>
                                  <Label htmlFor="packaging_service" className="font-medium">
                                    Ð£Ð¿Ð°ÐºÐ¾Ð²ÐºÐ°
                                  </Label>
                                  <p className="text-sm text-gray-600">
                                    ÐŸÑ€Ð¾Ñ„ÐµÑÑÐ¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ð°Ñ ÑƒÐ¿Ð°ÐºÐ¾Ð²ÐºÐ° - 800 â‚½
                                  </p>
                                </div>
                              </div>

                              {/* Ð—Ð°Ð±Ð¾Ñ€ Ð½Ð° Ð´Ð¾Ð¼Ñƒ */}
                              <div className="flex items-center space-x-2 p-4 border rounded-lg">
                                <input
                                  type="checkbox"
                                  id="home_pickup"
                                  checked={cargoOrderForm.home_pickup}
                                  onChange={(e) => {
                                    setCargoOrderForm({...cargoOrderForm, home_pickup: e.target.checked});
                                    setCostCalculation(null);
                                  }}
                                  className="rounded"
                                />
                                <div>
                                  <Label htmlFor="home_pickup" className="font-medium">
                                    Ð—Ð°Ð±Ð¾Ñ€ Ð½Ð° Ð´Ð¾Ð¼Ñƒ
                                  </Label>
                                  <p className="text-sm text-gray-600">
                                    Ð—Ð°Ð±ÐµÑ€ÐµÐ¼ Ð³Ñ€ÑƒÐ· Ð¿Ð¾ Ð°Ð´Ñ€ÐµÑÑƒ - 1500 â‚½
                                  </p>
                                </div>
                              </div>

                              {/* Ð”Ð¾ÑÑ‚Ð°Ð²ÐºÐ° Ð½Ð° Ð´Ð¾Ð¼ */}
                              <div className="flex items-center space-x-2 p-4 border rounded-lg">
                                <input
                                  type="checkbox"
                                  id="home_delivery"
                                  checked={cargoOrderForm.home_delivery}
                                  onChange={(e) => {
                                    setCargoOrderForm({...cargoOrderForm, home_delivery: e.target.checked});
                                    setCostCalculation(null);
                                  }}
                                  className="rounded"
                                />
                                <div>
                                  <Label htmlFor="home_delivery" className="font-medium">
                                    Ð”Ð¾ÑÑ‚Ð°Ð²ÐºÐ° Ð½Ð° Ð´Ð¾Ð¼
                                  </Label>
                                  <p className="text-sm text-gray-600">
                                    Ð”Ð¾ÑÑ‚Ð°Ð²Ð¸Ð¼ Ð³Ñ€ÑƒÐ· Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŽ - 1200 â‚½
                                  </p>
                                </div>
                              </div>

                              {/* Ð¥Ñ€ÑƒÐ¿ÐºÐ¸Ð¹ Ð³Ñ€ÑƒÐ· */}
                              <div className="flex items-center space-x-2 p-4 border rounded-lg">
                                <input
                                  type="checkbox"
                                  id="fragile"
                                  checked={cargoOrderForm.fragile}
                                  onChange={(e) => {
                                    setCargoOrderForm({...cargoOrderForm, fragile: e.target.checked});
                                    setCostCalculation(null);
                                  }}
                                  className="rounded"
                                />
                                <div>
                                  <Label htmlFor="fragile" className="font-medium">
                                    Ð¥Ñ€ÑƒÐ¿ÐºÐ¸Ð¹ Ð³Ñ€ÑƒÐ·
                                  </Label>
                                  <p className="text-sm text-gray-600">
                                    ÐžÑÐ¾Ð±Ð°Ñ Ð¾ÑÑ‚Ð¾Ñ€Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒ - 500 â‚½
                                  </p>
                                </div>
                              </div>

                              {/* Ð¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼ */}
                              <div className="flex items-center space-x-2 p-4 border rounded-lg">
                                <input
                                  type="checkbox"
                                  id="temperature_sensitive"
                                  checked={cargoOrderForm.temperature_sensitive}
                                  onChange={(e) => {
                                    setCargoOrderForm({...cargoOrderForm, temperature_sensitive: e.target.checked});
                                    setCostCalculation(null);
                                  }}
                                  className="rounded"
                                />
                                <div>
                                  <Label htmlFor="temperature_sensitive" className="font-medium">
                                    Ð¢ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ð½Ñ‹Ð¹ Ñ€ÐµÐ¶Ð¸Ð¼
                                  </Label>
                                  <p className="text-sm text-gray-600">
                                    ÐšÐ¾Ð½Ñ‚Ñ€Ð¾Ð»ÑŒ Ñ‚ÐµÐ¼Ð¿ÐµÑ€Ð°Ñ‚ÑƒÑ€Ñ‹ - 800 â‚½
                                  </p>
                                </div>
                              </div>
                            </div>
                          </div>

                          {/* Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸ */}
                          <div>
                            <Label htmlFor="special_instructions">Ð¡Ð¿ÐµÑ†Ð¸Ð°Ð»ÑŒÐ½Ñ‹Ðµ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸</Label>
                            <Textarea
                              id="special_instructions"
                              value={cargoOrderForm.special_instructions}
                              onChange={(e) => setCargoOrderForm({...cargoOrderForm, special_instructions: e.target.value})}
                              placeholder="Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ñ‚Ñ€ÐµÐ±Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¸Ð»Ð¸ Ð¸Ð½ÑÑ‚Ñ€ÑƒÐºÑ†Ð¸Ð¸..."
                            />
                          </div>

                          {/* Ð Ð°ÑÑ‡ÐµÑ‚ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸ */}
                          <div className="border-t pt-6">
                            <div className="flex items-center justify-between mb-4">
                              <h3 className="text-lg font-semibold text-gray-900">
                                Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸
                              </h3>
                              <Button 
                                type="button"
                                variant="outline"
                                onClick={calculateCargoCost}
                                disabled={isCalculating || !cargoOrderForm.weight || !cargoOrderForm.declared_value || !cargoOrderForm.cargo_name}
                              >
                                <Calculator className="mr-2 h-4 w-4" />
                                {isCalculating ? 'Ð Ð°ÑÑ‡ÐµÑ‚...' : 'Ð Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ñ‚ÑŒ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ'}
                              </Button>
                            </div>

                            {costCalculation && (
                              <div className="bg-blue-50 p-6 rounded-lg">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                  <div>
                                    <h4 className="font-semibold mb-3">Ð”ÐµÑ‚Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸:</h4>
                                    <div className="space-y-2">
                                      {Object.entries(costCalculation.breakdown).map(([key, value]) => (
                                        <div key={key} className="flex justify-between text-sm">
                                          <span>{key}:</span>
                                          <span className="font-medium">{value}{typeof value === 'number' ? ' â‚½' : ''}</span>
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                  <div className="text-center">
                                    <div className="text-3xl font-bold text-blue-600 mb-2">
                                      {costCalculation.calculation.total_cost} â‚½
                                    </div>
                                    <div className="text-lg text-gray-600 mb-2">
                                      Ð¡Ñ€Ð¾Ðº Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸: {costCalculation.calculation.delivery_time_days} Ð´Ð½ÐµÐ¹
                                    </div>
                                    <div className="text-sm text-gray-500">
                                      ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚: {costCalculation.route_info.route.replace('_', ' â†’ ')}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            )}
                          </div>

                          {/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ */}
                          <div className="flex items-center justify-between pt-6 border-t">
                            <Button 
                              type="button" 
                              variant="outline"
                              onClick={() => {
                                setCargoOrderForm({
                                  cargo_name: '',
                                  description: '',
                                  weight: '',
                                  declared_value: '',
                                  recipient_full_name: '',
                                  recipient_phone: '',
                                  recipient_address: '',
                                  recipient_city: '',
                                  route: 'moscow_dushanbe',
                                  delivery_type: 'standard',
                                  insurance_requested: false,
                                  insurance_value: '',
                                  packaging_service: false,
                                  home_pickup: false,
                                  home_delivery: false,
                                  fragile: false,
                                  temperature_sensitive: false,
                                  special_instructions: ''
                                });
                                setCostCalculation(null);
                              }}
                            >
                              ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ñ„Ð¾Ñ€Ð¼Ñƒ
                            </Button>
                            <Button 
                              type="submit" 
                              className="bg-blue-600 hover:bg-blue-700"
                              disabled={!costCalculation}
                            >
                              <Package className="mr-2 h-4 w-4" />
                              ÐžÑ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·
                            </Button>
                          </div>
                        </form>
                      </CardContent>
                    </Card>
                  </div>
                </TabsContent>

                {/* Cargo Tab */}
                <TabsContent value="cargo" className="space-y-6">
                  <div className="flex items-center justify-between">
                    <h2 className="text-xl font-semibold">ÐœÐ¾Ð¸ Ð³Ñ€ÑƒÐ·Ñ‹</h2>
                    <div className="flex items-center space-x-2">
                      <Select defaultValue="all" onValueChange={(value) => fetchClientCargo(value === 'all' ? null : value)}>
                        <SelectTrigger className="w-40">
                          <SelectValue />
                        </SelectTrigger>
                        <SelectContent>
                          <SelectItem key="all" value="all">Ð’ÑÐµ ÑÑ‚Ð°Ñ‚ÑƒÑÑ‹</SelectItem>
                          <SelectItem key="accepted" value="accepted">ÐŸÑ€Ð¸Ð½ÑÑ‚</SelectItem>
                          <SelectItem key="placed_in_warehouse" value="placed_in_warehouse">ÐÐ° ÑÐºÐ»Ð°Ð´Ðµ</SelectItem>
                          <SelectItem key="on_transport" value="on_transport">ÐÐ° Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ðµ</SelectItem>
                          <SelectItem key="in_transit" value="in_transit">Ð’ Ð¿ÑƒÑ‚Ð¸</SelectItem>
                          <SelectItem key="delivered" value="delivered">Ð”Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½</SelectItem>
                        </SelectContent>
                      </Select>
                      <Button 
                        variant="outline" 
                        onClick={() => fetchClientCargo()}
                      >
                        ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ
                      </Button>
                    </div>
                  </div>

                  <div className="space-y-4">
                    {clientCargo.length === 0 ? (
                      <Card>
                        <CardContent className="p-8 text-center">
                          <Package className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                          <p className="text-gray-500">Ð£ Ð²Ð°Ñ Ð¿Ð¾ÐºÐ° Ð½ÐµÑ‚ Ð³Ñ€ÑƒÐ·Ð¾Ð²</p>
                          <Button 
                            className="mt-4" 
                            onClick={() => setActiveTab('requests')}
                          >
                            ÐŸÐ¾Ð´Ð°Ñ‚ÑŒ Ð·Ð°ÑÐ²ÐºÑƒ Ð½Ð° Ð³Ñ€ÑƒÐ·
                          </Button>
                        </CardContent>
                      </Card>
                    ) : (
                      clientCargo.map((cargo) => (
                        <Card key={cargo.id}>
                          <CardContent className="p-6">
                            <div className="flex items-center justify-between mb-4">
                              <div>
                                <h3 className="font-semibold text-lg">#{cargo.cargo_number}</h3>
                                <p className="text-gray-600">{cargo.cargo_name || 'Ð“Ñ€ÑƒÐ·'}</p>
                              </div>
                              <Badge variant={cargo.status === 'delivered' ? 'default' : 'outline'}>
                                {cargo.status}
                              </Badge>
                            </div>
                            
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                              <div>
                                <p className="text-sm text-gray-600">ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ:</p>
                                <p className="font-medium">{cargo.recipient_full_name}</p>
                                <p className="text-sm text-gray-600">{cargo.recipient_phone}</p>
                              </div>
                              <div>
                                <p className="text-sm text-gray-600">Ð’ÐµÑ:</p>
                                <p className="font-medium">{cargo.weight} ÐºÐ³</p>
                                <p className="text-sm text-gray-600">Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ: {cargo.declared_value} â‚½</p>
                              </div>
                            </div>

                            {cargo.location_description && (
                              <div className="mb-4">
                                <p className="text-sm text-gray-600">ÐœÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ:</p>
                                <p className="font-medium">{cargo.location_description}</p>
                              </div>
                            )}

                            <div className="flex items-center justify-between">
                              <div className="flex items-center space-x-4 text-sm text-gray-600">
                                {cargo.tracking_code && (
                                  <span className="flex items-center">
                                    <QrCode className="mr-1 h-4 w-4" />
                                    Ð¢Ñ€ÐµÐºÐ¸Ð½Ð³: {cargo.tracking_code}
                                  </span>
                                )}
                                {cargo.photo_count > 0 && (
                                  <span className="flex items-center">
                                    <Camera className="mr-1 h-4 w-4" />
                                    {cargo.photo_count} Ñ„Ð¾Ñ‚Ð¾
                                  </span>
                                )}
                                {cargo.comment_count > 0 && (
                                  <span className="flex items-center">
                                    <MessageCircle className="mr-1 h-4 w-4" />
                                    {cargo.comment_count} ÐºÐ¾Ð¼Ð¼ÐµÐ½Ñ‚Ð°Ñ€Ð¸ÐµÐ²
                                  </span>
                                )}
                              </div>
                              <div className="flex space-x-2">
                                <Button 
                                  variant="outline" 
                                  size="sm"
                                  onClick={() => openRepeatOrder(cargo)}
                                  className="text-green-600 hover:text-green-700"
                                  title="ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð· Ñ Ñ‚ÐµÐ¼Ð¸ Ð¶Ðµ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸"
                                >
                                  <Copy className="mr-1 h-4 w-4" />
                                  ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ
                                </Button>
                                <Button 
                                  variant="outline" 
                                  size="sm"
                                  onClick={() => fetchClientCargoDetails(cargo.id)}
                                >
                                  <Eye className="mr-1 h-4 w-4" />
                                  ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ
                                </Button>
                              </div>
                            </div>
                          </CardContent>
                        </Card>
                      ))
                    )}
                  </div>
                </TabsContent>

                {/* Keep existing Requests and Contact tabs */}
                <TabsContent value="requests" className="space-y-6">
                  <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    {/* Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð·Ð°ÑÐ²ÐºÐ¸ */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Plus className="mr-2 h-5 w-5" />
                          ÐŸÐ¾Ð´Ð°Ñ‚ÑŒ Ð·Ð°ÑÐ²ÐºÑƒ Ð½Ð° Ð³Ñ€ÑƒÐ·
                        </CardTitle>
                        <CardDescription>
                          Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ñ„Ð¾Ñ€Ð¼Ñƒ Ð´Ð»Ñ Ð¿Ð¾Ð´Ð°Ñ‡Ð¸ Ð·Ð°ÑÐ²ÐºÐ¸ Ð½Ð° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÑƒ Ð³Ñ€ÑƒÐ·Ð°
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <form onSubmit={handleCreateRequest} className="space-y-4">
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <Label htmlFor="recipient_full_name">Ð¤Ð˜Ðž Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</Label>
                              <Input
                                id="recipient_full_name"
                                value={requestForm.recipient_full_name}
                                onChange={(e) => setRequestForm({...requestForm, recipient_full_name: e.target.value})}
                                required
                              />
                            </div>
                            <div>
                              <Label htmlFor="recipient_phone">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</Label>
                              <Input
                                id="recipient_phone"
                                type="tel"
                                value={requestForm.recipient_phone}
                                onChange={(e) => setRequestForm({...requestForm, recipient_phone: e.target.value})}
                                required
                              />
                            </div>
                          </div>
                          <div>
                            <Label htmlFor="recipient_address">ÐÐ´Ñ€ÐµÑ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</Label>
                            <Input
                              id="recipient_address"
                              value={requestForm.recipient_address}
                              onChange={(e) => setRequestForm({...requestForm, recipient_address: e.target.value})}
                              required
                            />
                          </div>
                          <div>
                            <Label htmlFor="pickup_address">ÐÐ´Ñ€ÐµÑ Ð·Ð°Ð±Ð¾Ñ€Ð° Ð³Ñ€ÑƒÐ·Ð°</Label>
                            <Input
                              id="pickup_address"
                              value={requestForm.pickup_address}
                              onChange={(e) => setRequestForm({...requestForm, pickup_address: e.target.value})}
                              required
                            />
                          </div>
                          <div>
                            <Label htmlFor="cargo_name">ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°</Label>
                            <Input
                              id="cargo_name"
                              value={requestForm.cargo_name}
                              onChange={(e) => setRequestForm({...requestForm, cargo_name: e.target.value})}
                              required
                            />
                          </div>
                          <div className="grid grid-cols-2 gap-4">
                            <div>
                              <Label htmlFor="weight">Ð’ÐµÑ (ÐºÐ³)</Label>
                              <Input
                                id="weight"
                                type="number"
                                step="0.1"
                                value={requestForm.weight}
                                onChange={(e) => setRequestForm({...requestForm, weight: e.target.value})}
                                required
                              />
                            </div>
                            <div>
                              <Label htmlFor="declared_value">ÐžÐ±ÑŠÑÐ²Ð»ÐµÐ½Ð½Ð°Ñ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ (â‚½)</Label>
                              <Input
                                id="declared_value"
                                type="number"
                                value={requestForm.declared_value}
                                onChange={(e) => setRequestForm({...requestForm, declared_value: e.target.value})}
                                required
                              />
                            </div>
                          </div>
                          <div>
                            <Label htmlFor="description">ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°</Label>
                            <Textarea
                              id="description"
                              value={requestForm.description}
                              onChange={(e) => setRequestForm({...requestForm, description: e.target.value})}
                              required
                            />
                          </div>
                          <Button type="submit" className="w-full">
                            ÐŸÐ¾Ð´Ð°Ñ‚ÑŒ Ð·Ð°ÑÐ²ÐºÑƒ
                          </Button>
                        </form>
                      </CardContent>
                    </Card>

                    {/* ÐœÐ¾Ð¸ Ð·Ð°ÑÐ²ÐºÐ¸ */}
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <FileText className="mr-2 h-5 w-5" />
                          ÐœÐ¾Ð¸ Ð·Ð°ÑÐ²ÐºÐ¸
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {myRequests.length === 0 ? (
                            <p className="text-gray-500 text-center py-4">Ð£ Ð²Ð°Ñ Ð¿Ð¾ÐºÐ° Ð½ÐµÑ‚ Ð·Ð°ÑÐ²Ð¾Ðº</p>
                          ) : (
                            myRequests.map((request) => (
                              <div key={request.id} className="border rounded-lg p-4">
                                <div className="flex justify-between items-start mb-2">
                                  <div>
                                    <div className="font-medium">{request.recipient_full_name}</div>
                                    <div className="text-sm text-gray-600">{request.recipient_phone}</div>
                                  </div>
                                  <Badge variant={request.status === 'approved' ? 'default' : 'outline'}>
                                    {request.status}
                                  </Badge>
                                </div>
                                <div className="text-sm text-gray-600 mb-2">
                                  {request.description}
                                </div>
                                <div className="flex justify-between text-sm">
                                  <span>Ð’ÐµÑ: {request.weight} ÐºÐ³</span>
                                  <span>Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ: {request.declared_value} â‚½</span>
                                </div>
                              </div>
                            ))
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  </div>
                </TabsContent>

                <TabsContent value="contact" className="space-y-6">
                  <Card>
                    <CardHeader>
                      <CardTitle className="flex items-center">
                        <MessageCircle className="mr-2 h-5 w-5" />
                        Ð¡Ð²ÑÐ·Ð°Ñ‚ÑŒÑÑ Ñ Ð½Ð°Ð¼Ð¸
                      </CardTitle>
                      <CardDescription>
                        Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑƒÐ´Ð¾Ð±Ð½Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð± ÑÐ²ÑÐ·Ð¸
                      </CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-4">
                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <Button className="h-20 flex-col" variant="outline">
                          <MessageCircle className="h-6 w-6 mb-2" />
                          WhatsApp
                        </Button>
                        <Button className="h-20 flex-col" variant="outline">
                          <MessageCircle className="h-6 w-6 mb-2" />
                          Telegram
                        </Button>
                        <Button className="h-20 flex-col" variant="outline">
                          <MessageCircle className="h-6 w-6 mb-2" />
                          ÐžÐ½Ð»Ð°Ð¹Ð½ Ñ‡Ð°Ñ‚
                        </Button>
                      </div>
                    </CardContent>
                  </Card>
                </TabsContent>
              </Tabs>
            </div>
          ) : (
            /* Ð”Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð° Ð¸ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° ÑÐºÐ»Ð°Ð´Ð° - Ð½Ð¾Ð²Ñ‹Ð¹ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ Ñ Ð±Ð¾ÐºÐ¾Ð²Ñ‹Ð¼ Ð¼ÐµÐ½ÑŽ */
            <div className="space-y-6">
              
              {/* Ð¨Ð°Ð¿ÐºÐ° Ñ Ð¿Ð¾Ð¸ÑÐºÐ¾Ð¼ Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸ÑÐ¼Ð¸ */}
              <Card>
                <CardContent className="p-4">
                  <div className="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                    
                    {/* ÐŸÐ¾Ð¸ÑÐº Ñ Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ñ„ÑƒÐ½ÐºÑ†Ð¸ÑÐ¼Ð¸ */}
                    <div className="flex-1 max-w-md relative">
                      <div className="relative">
                        <Search className="absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400" />
                        <Input
                          placeholder="ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ Ð½Ð¾Ð¼ÐµÑ€Ñƒ, Ð¤Ð˜Ðž, Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ñƒ..."
                          value={searchQuery}
                          onChange={(e) => handleSearchInput(e.target.value)}
                          onKeyPress={(e) => {
                            if (e.key === 'Enter') {
                              handleAdvancedSearch(searchQuery);
                            }
                          }}
                          className="pl-10 pr-20"
                        />
                        
                        {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ñ€Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð¸ÑÐºÐ° */}
                        <Button
                          size="sm"
                          variant="outline"
                          className="absolute right-1 top-1/2 transform -translate-y-1/2"
                          onClick={() => setAdvancedSearchOpen(!advancedSearchOpen)}
                        >
                          <Filter className="h-4 w-4" />
                        </Button>
                        
                        {searchQuery && (
                          <Button
                            size="sm"
                            variant="ghost"
                            className="absolute right-12 top-1/2 transform -translate-y-1/2"
                            onClick={clearSearch}
                          >
                            <X className="h-4 w-4" />
                          </Button>
                        )}
                      </div>

                      {/* ÐÐ²Ñ‚Ð¾Ð´Ð¾Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ */}
                      {showSuggestions && searchSuggestions.length > 0 && (
                        <div className="absolute z-50 mt-1 w-full bg-white border rounded-lg shadow-lg">
                          {searchSuggestions.map((suggestion, index) => (
                            <div
                              key={`search-${index}-${suggestion.id || suggestion.name || index}`}
                              className="p-2 hover:bg-gray-100 cursor-pointer text-sm"
                              onClick={() => selectSearchSuggestion(suggestion)}
                            >
                              <Search className="inline mr-2 h-3 w-3 text-gray-400" />
                              {suggestion}
                            </div>
                          ))}
                        </div>
                      )}

                      {/* Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ */}
                      {advancedSearchOpen && (
                        <div className="absolute z-50 mt-2 w-96 bg-white border rounded-lg shadow-lg p-4">
                          <div className="space-y-4">
                            <h3 className="font-semibold text-sm">Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ñ‹Ðµ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹</h3>
                            
                            {/* Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ Ð´Ð»Ñ Ð³Ñ€ÑƒÐ·Ð¾Ð² */}
                            <div className="grid grid-cols-2 gap-2">
                              <div>
                                <Label className="text-xs">Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð³Ñ€ÑƒÐ·Ð°</Label>
                                <Select 
                                  value={searchFilters.cargo_status} 
                                  onValueChange={(value) => setSearchFilters({...searchFilters, cargo_status: value})}
                                >
                                  <SelectTrigger className="h-8">
                                    <SelectValue placeholder="Ð›ÑŽÐ±Ð¾Ð¹" />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="">Ð›ÑŽÐ±Ð¾Ð¹</SelectItem>
                                    <SelectItem value="accepted">ÐŸÑ€Ð¸Ð½ÑÑ‚</SelectItem>
                                    <SelectItem value="in_transit">Ð’ Ð¿ÑƒÑ‚Ð¸</SelectItem>
                                    <SelectItem value="delivered">Ð”Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½</SelectItem>
                                    <SelectItem value="returned">Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‰ÐµÐ½</SelectItem>
                                  </SelectContent>
                                </Select>
                              </div>
                              
                              <div>
                                <Label className="text-xs">ÐžÐ¿Ð»Ð°Ñ‚Ð°</Label>
                                <Select 
                                  value={searchFilters.payment_status} 
                                  onValueChange={(value) => setSearchFilters({...searchFilters, payment_status: value})}
                                >
                                  <SelectTrigger className="h-8">
                                    <SelectValue placeholder="Ð›ÑŽÐ±Ð°Ñ" />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="">Ð›ÑŽÐ±Ð°Ñ</SelectItem>
                                    <SelectItem value="pending">ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ÑÑ</SelectItem>
                                    <SelectItem value="paid">ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½</SelectItem>
                                  </SelectContent>
                                </Select>
                              </div>
                            </div>

                            <div className="grid grid-cols-2 gap-2">
                              <div>
                                <Label className="text-xs">ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚</Label>
                                <Select 
                                  value={searchFilters.route} 
                                  onValueChange={(value) => setSearchFilters({...searchFilters, route: value})}
                                >
                                  <SelectTrigger className="h-8">
                                    <SelectValue placeholder="Ð›ÑŽÐ±Ð¾Ð¹" />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="">Ð›ÑŽÐ±Ð¾Ð¹</SelectItem>
                                    <SelectItem value="moscow_to_tajikistan">ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½</SelectItem>
                                    <SelectItem value="tajikistan_to_moscow">Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½ â†’ ÐœÐ¾ÑÐºÐ²Ð°</SelectItem>
                                  </SelectContent>
                                </Select>
                              </div>
                              
                              <div>
                                <Label className="text-xs">Ð¡Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ°</Label>
                                <Select 
                                  value={searchFilters.sort_by} 
                                  onValueChange={(value) => setSearchFilters({...searchFilters, sort_by: value})}
                                >
                                  <SelectTrigger className="h-8">
                                    <SelectValue />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="created_at">ÐŸÐ¾ Ð´Ð°Ñ‚Ðµ</SelectItem>
                                    <SelectItem value="relevance_score">ÐŸÐ¾ Ñ€ÐµÐ»ÐµÐ²Ð°Ð½Ñ‚Ð½Ð¾ÑÑ‚Ð¸</SelectItem>
                                    <SelectItem value="weight">ÐŸÐ¾ Ð²ÐµÑÑƒ</SelectItem>
                                    <SelectItem value="declared_value">ÐŸÐ¾ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸</SelectItem>
                                  </SelectContent>
                                </Select>
                              </div>
                            </div>

                            {/* ÐŸÐ¾Ð»Ñ Ð´Ð»Ñ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð¾Ð² */}
                            <div className="grid grid-cols-2 gap-2">
                              <div>
                                <Label className="text-xs">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ</Label>
                                <Input
                                  className="h-8"
                                  placeholder="+7..."
                                  value={searchFilters.sender_phone}
                                  onChange={(e) => setSearchFilters({...searchFilters, sender_phone: e.target.value})}
                                />
                              </div>
                              <div>
                                <Label className="text-xs">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</Label>
                                <Input
                                  className="h-8"
                                  placeholder="+992..."
                                  value={searchFilters.recipient_phone}
                                  onChange={(e) => setSearchFilters({...searchFilters, recipient_phone: e.target.value})}
                                />
                              </div>
                            </div>

                            {/* Ð”Ð¸Ð°Ð¿Ð°Ð·Ð¾Ð½ Ð´Ð°Ñ‚ */}
                            <div className="grid grid-cols-2 gap-2">
                              <div>
                                <Label className="text-xs">ÐžÑ‚ Ð´Ð°Ñ‚Ñ‹</Label>
                                <Input
                                  type="date"
                                  className="h-8"
                                  value={searchFilters.date_from}
                                  onChange={(e) => setSearchFilters({...searchFilters, date_from: e.target.value})}
                                />
                              </div>
                              <div>
                                <Label className="text-xs">Ð”Ð¾ Ð´Ð°Ñ‚Ñ‹</Label>
                                <Input
                                  type="date"
                                  className="h-8"
                                  value={searchFilters.date_to}
                                  onChange={(e) => setSearchFilters({...searchFilters, date_to: e.target.value})}
                                />
                              </div>
                            </div>

                            <div className="flex justify-between">
                              <Button
                                size="sm"
                                variant="outline"
                                onClick={() => {
                                  setSearchFilters({
                                    cargo_status: '',
                                    payment_status: '',
                                    processing_status: '',
                                    route: '',
                                    sender_phone: '',
                                    recipient_phone: '',
                                    date_from: '',
                                    date_to: '',
                                    user_role: '',
                                    user_status: null,
                                    sort_by: 'created_at',
                                    sort_order: 'desc'
                                  });
                                }}
                              >
                                Ð¡Ð±Ñ€Ð¾ÑÐ¸Ñ‚ÑŒ
                              </Button>
                              <Button
                                size="sm"
                                onClick={() => {
                                  handleAdvancedSearch(searchQuery, searchFilters);
                                  setAdvancedSearchOpen(false);
                                }}
                                disabled={searchLoading}
                              >
                                {searchLoading ? 'ÐŸÐ¾Ð¸ÑÐº...' : 'ÐŸÑ€Ð¸Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ'}
                              </Button>
                            </div>
                          </div>
                        </div>
                      )}
                      
                      {/* Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¿Ð¾Ð¸ÑÐºÐ° */}
                      {showSearchResults && (
                        <div className="absolute z-40 mt-2 w-full bg-white border rounded-lg shadow-lg max-h-80 overflow-y-auto">
                          {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¾Ð¸ÑÐºÐµ */}
                          {searchTime > 0 && (
                            <div className="px-3 py-2 bg-gray-50 border-b text-xs text-gray-600">
                              ÐÐ°Ð¹Ð´ÐµÐ½Ð¾ {searchResults.length} Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ð¾Ð² Ð·Ð° {searchTime}Ð¼Ñ
                            </div>
                          )}
                          
                          {!Array.isArray(searchResults) || searchResults.length === 0 ? (
                            <div className="p-4 text-gray-500 text-center">ÐÐ¸Ñ‡ÐµÐ³Ð¾ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ð¾</div>
                          ) : (
                            searchResults.map((result) => (
                              <div
                                key={result.id}
                                className="p-3 border-b hover:bg-gray-50 cursor-pointer"
                                onClick={() => {
                                  if (result.type === 'cargo') {
                                    fetchCargoDetails(result.id).then(cargoDetails => {
                                      setSelectedCellCargo(cargoDetails);
                                      setCargoDetailModal(true);
                                      clearSearch();
                                    });
                                  } else if (result.type === 'user') {
                                    // ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
                                    console.log('Open user profile:', result.id);
                                  } else if (result.type === 'warehouse') {
                                    // ÐžÑ‚ÐºÑ€Ñ‹Ñ‚ÑŒ ÑÐºÐ»Ð°Ð´
                                    console.log('Open warehouse:', result.id);
                                  }
                                }}
                              >
                                <div className="flex items-start justify-between">
                                  <div className="flex-1">
                                    <div className="font-medium text-sm">{result.title}</div>
                                    <div className="text-xs text-gray-600">{result.subtitle}</div>
                                    
                                    {/* Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ñ‚Ð¸Ð¿Ð° */}
                                    {result.type === 'cargo' && (
                                      <div className="mt-1 text-xs text-gray-500">
                                        {result.details.weight && `${result.details.weight} ÐºÐ³`}
                                        {result.details.declared_value && ` â€¢ ${result.details.declared_value} Ñ€ÑƒÐ±`}
                                        {result.details.status && ` â€¢ ${result.details.status}`}
                                      </div>
                                    )}
                                    
                                    {result.type === 'warehouse' && (
                                      <div className="mt-1 text-xs text-gray-500">
                                        {result.details.cargo_count} Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ
                                      </div>
                                    )}
                                  </div>
                                  
                                  <div className="ml-2 text-right">
                                    <Badge variant="outline" className="text-xs">
                                      {result.type === 'cargo' ? 'Ð“Ñ€ÑƒÐ·' : 
                                       result.type === 'user' ? 'ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ' : 'Ð¡ÐºÐ»Ð°Ð´'}
                                    </Badge>
                                    {result.relevance_score && (
                                      <div className="text-xs text-gray-400 mt-1">
                                        {result.relevance_score.toFixed(0)}%
                                      </div>
                                    )}
                                  </div>
                                </div>
                              </div>
                            ))
                          )}
                        </div>
                      )}
                    </div>
                    
                    {/* Ð¤Ð¸Ð»ÑŒÑ‚Ñ€ Ð¿Ð¾Ð¸ÑÐºÐ° */}
                    <Select value={searchType} onValueChange={setSearchType}>
                      <SelectTrigger className="w-40">
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="all">Ð’ÐµÐ·Ð´Ðµ</SelectItem>
                        <SelectItem value="number">ÐŸÐ¾ Ð½Ð¾Ð¼ÐµÑ€Ñƒ</SelectItem>
                        <SelectItem value="sender_name">ÐŸÐ¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŽ</SelectItem>
                        <SelectItem value="recipient_name">ÐŸÐ¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŽ</SelectItem>
                        <SelectItem value="phone">ÐŸÐ¾ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ñƒ</SelectItem>
                        <SelectItem value="cargo_name">ÐŸÐ¾ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÑŽ</SelectItem>
                      </SelectContent>
                    </Select>
                    
                    {/* Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¸ Ð±Ñ‹ÑÑ‚Ñ€Ñ‹Ð¹ Ð´Ð¾ÑÑ‚ÑƒÐ¿ */}
                    <div className="flex items-center space-x-4">
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={startCargoQRScanner}
                        title="Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð°"
                      >
                        <Camera className="h-4 w-4 mr-2" />
                        Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ QR
                      </Button>
                      
                      <div className="text-sm text-gray-600">
                        Ð’ÑÐµÐ³Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²: <span className="font-medium">{cargo.length}</span>
                      </div>
                      <Button
                        variant="outline"
                        size="sm"
                        onClick={() => {
                          fetchNotifications();
                          fetchNotifications();
                        }}
                      >
                        <Bell className="h-4 w-4 mr-2" />
                        ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ
                      </Button>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Dashboard */}
              {activeSection === 'dashboard' && (
                <div className="space-y-6">
                  {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¸ */}
                  <div className="flex justify-between items-center">
                    <h2 className="text-2xl font-bold">ÐÐ½Ð°Ð»Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´</h2>
                    <Button 
                      onClick={fetchAdminDashboardAnalytics}
                      disabled={adminAnalyticsLoading}
                      variant="outline"
                    >
                      <RefreshCw className={`h-4 w-4 mr-2 ${adminAnalyticsLoading ? 'animate-spin' : ''}`} />
                      {adminAnalyticsLoading ? 'Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...' : 'ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÑƒ'}
                    </Button>
                  </div>

                  {adminDashboardAnalytics ? (
                    <>
                      {/* ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° */}
                      <div>
                        <h3 className="text-lg font-semibold mb-4 text-gray-700">ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
                          <Card className="bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">Ð¡ÐºÐ»Ð°Ð´Ñ‹</CardTitle>
                              <Building className="h-4 w-4 text-blue-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-blue-700">{adminDashboardAnalytics.basic_stats.total_warehouses}</div>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-green-50 to-green-100 border-green-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸</CardTitle>
                              <Users className="h-4 w-4 text-green-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-green-700">{adminDashboardAnalytics.basic_stats.total_users}</div>
                              <p className="text-xs text-green-600 mt-1">
                                ÐÐ´Ð¼Ð¸Ð½Ñ‹: {adminDashboardAnalytics.basic_stats.total_admins}, 
                                ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñ‹: {adminDashboardAnalytics.basic_stats.total_operators}
                              </p>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ð¸</CardTitle>
                              <User className="h-4 w-4 text-purple-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-purple-700">{adminDashboardAnalytics.people_stats.unique_senders}</div>
                              <p className="text-xs text-purple-600 mt-1">Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ñ…</p>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-orange-50 to-orange-100 border-orange-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ð¸</CardTitle>
                              <User className="h-4 w-4 text-orange-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-orange-700">{adminDashboardAnalytics.people_stats.unique_recipients}</div>
                              <p className="text-xs text-orange-600 mt-1">Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ñ…</p>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-teal-50 to-teal-100 border-teal-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">Ð’ÑÐµÐ³Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²</CardTitle>
                              <Package className="h-4 w-4 text-teal-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-teal-700">{adminDashboardAnalytics.cargo_stats.total_cargo}</div>
                            </CardContent>
                          </Card>
                        </div>
                      </div>

                      {/* Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð³Ñ€ÑƒÐ·Ð¾Ð² */}
                      <div>
                        <h3 className="text-lg font-semibold mb-4 text-gray-700">Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð³Ñ€ÑƒÐ·Ð¾Ð²</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                          <Card className="bg-gradient-to-br from-indigo-50 to-indigo-100 border-indigo-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">ÐžÐ±Ñ‰Ð¸Ð¹ Ð²ÐµÑ</CardTitle>
                              <Package2 className="h-4 w-4 text-indigo-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-indigo-700">{adminDashboardAnalytics.cargo_stats.total_weight_kg.toLocaleString()}</div>
                              <p className="text-xs text-indigo-600 mt-1">ÐºÐ³</p>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-emerald-50 to-emerald-100 border-emerald-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">ÐžÐ±Ñ‰Ð°Ñ ÑÑƒÐ¼Ð¼Ð°</CardTitle>
                              <DollarSign className="h-4 w-4 text-emerald-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-emerald-700">{adminDashboardAnalytics.cargo_stats.total_sum_rub.toLocaleString()}</div>
                              <p className="text-xs text-emerald-600 mt-1">â‚½</p>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-amber-50 to-amber-100 border-amber-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">ÐžÐ¶Ð¸Ð´Ð°ÑŽÑ‚ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</CardTitle>
                              <Clock className="h-4 w-4 text-amber-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-amber-700">{adminDashboardAnalytics.cargo_stats.awaiting_recipient}</div>
                              <p className="text-xs text-amber-600 mt-1">Ð³Ñ€ÑƒÐ·Ð¾Ð²</p>
                            </CardContent>
                          </Card>
                        </div>
                      </div>

                      {/* Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° */}
                      <div>
                        <h3 className="text-lg font-semibold mb-4 text-gray-700">Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                          <Card className="bg-gradient-to-br from-red-50 to-red-100 border-red-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">Ð”Ð¾Ð»Ð¶Ð½Ð¸ÐºÐ¸</CardTitle>
                              <CreditCard className="h-4 w-4 text-red-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-red-700">{adminDashboardAnalytics.financial_stats.debtors_count}</div>
                              <p className="text-xs text-red-600 mt-1">
                                Ð¡ÑƒÐ¼Ð¼Ð° Ð·Ð°Ð´Ð¾Ð»Ð¶ÐµÐ½Ð½Ð¾ÑÑ‚Ð¸: {adminDashboardAnalytics.financial_stats.total_debt_amount.toLocaleString()} â‚½
                              </p>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-cyan-50 to-cyan-100 border-cyan-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð°ÑÐ²ÐºÐ¸</CardTitle>
                              <FileText className="h-4 w-4 text-cyan-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-cyan-700">{adminDashboardAnalytics.requests_stats.new_requests}</div>
                              <p className="text-xs text-cyan-600 mt-1">Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹</p>
                            </CardContent>
                          </Card>
                        </div>
                      </div>

                      {/* Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð¾Ð² */}
                      <div>
                        <h3 className="text-lg font-semibold mb-4 text-gray-700">Ð¢Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ñ‹ Ð¿Ð¾ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð°Ð¼</h3>
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                          <Card className="bg-gradient-to-br from-violet-50 to-violet-100 border-violet-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">Ð’ÑÐµÐ³Ð¾ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð¾Ð²</CardTitle>
                              <Truck className="h-4 w-4 text-violet-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-violet-700">{adminDashboardAnalytics.transport_stats.total_transports}</div>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-rose-50 to-rose-100 border-rose-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½</CardTitle>
                              <MapPin className="h-4 w-4 text-rose-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-rose-700">{adminDashboardAnalytics.transport_stats.moscow_to_tajikistan}</div>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-lime-50 to-lime-100 border-lime-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½ â†’ ÐœÐ¾ÑÐºÐ²Ð°</CardTitle>
                              <MapPin className="h-4 w-4 text-lime-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-lime-700">{adminDashboardAnalytics.transport_stats.tajikistan_to_moscow}</div>
                            </CardContent>
                          </Card>
                          
                          <Card className="bg-gradient-to-br from-sky-50 to-sky-100 border-sky-200">
                            <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                              <CardTitle className="text-sm font-medium">ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ</CardTitle>
                              <Zap className="h-4 w-4 text-sky-600" />
                            </CardHeader>
                            <CardContent>
                              <div className="text-2xl font-bold text-sky-700">{adminDashboardAnalytics.transport_stats.active_transports}</div>
                              <p className="text-xs text-sky-600 mt-1">Ð² Ð¿ÑƒÑ‚Ð¸</p>
                            </CardContent>
                          </Card>
                        </div>
                      </div>
                    </>
                  ) : (
                    // Ð¡Ñ‚Ð°Ñ€Ñ‹Ð¹ Ð±Ð°Ð·Ð¾Ð²Ñ‹Ð¹ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´, ÐµÑÐ»Ð¸ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ° Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ð°
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                      <Card>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Ð’ÑÐµÐ³Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²</CardTitle>
                          <Package className="h-4 w-4 text-muted-foreground" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">{cargo.length}</div>
                        </CardContent>
                      </Card>
                      
                      <Card>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸</CardTitle>
                          <Users className="h-4 w-4 text-muted-foreground" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">{users && Array.isArray(users) ? users.filter(u => u.is_active !== false).length : 0}</div>
                        </CardContent>
                      </Card>
                      
                      <Card>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">Ð¡ÐºÐ»Ð°Ð´Ñ‹</CardTitle>
                          <Building className="h-4 w-4 text-muted-foreground" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">{warehouses.length}</div>
                        </CardContent>
                      </Card>
                      
                      <Card>
                        <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                          <CardTitle className="text-sm font-medium">ÐÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ñ‹Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ</CardTitle>
                          <Bell className="h-4 w-4 text-muted-foreground" />
                        </CardHeader>
                        <CardContent>
                          <div className="text-2xl font-bold">{notifications.filter(n => !n.is_read).length}</div>
                        </CardContent>
                      </Card>
                    </div>
                  )}
                </div>
              )}

              {/* Ð›Ð¸Ñ‡Ð½Ñ‹Ð¹ ÐºÐ°Ð±Ð¸Ð½ÐµÑ‚ */}
              {activeSection === 'personal-dashboard' && (
                <div className="space-y-6">
                  {/* Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ñ‹Ð¹ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸Ð¹ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´ Ð´Ð»Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² ÑÐºÐ»Ð°Ð´Ð° */}
                  {user?.role === 'warehouse_operator' && (
                    <div className="space-y-6">
                      {/* Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¾Ð± Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ðµ */}
                      <div className="flex justify-between items-center">
                        <div>
                          <h2 className="text-2xl font-bold">ÐœÐ¾Ð¹ Ð´Ð°ÑˆÐ±Ð¾Ñ€Ð´ ÑÐºÐ»Ð°Ð´Ð°</h2>
                          {operatorDashboardAnalytics && (
                            <p className="text-gray-600">
                              {operatorDashboardAnalytics.operator_info?.operator_name} â€¢ 
                              ÐÐ°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¾ ÑÐºÐ»Ð°Ð´Ð¾Ð²: {operatorDashboardAnalytics.operator_info?.assigned_warehouses_count || 0}
                            </p>
                          )}
                        </div>
                        <Button 
                          onClick={fetchOperatorDashboardAnalytics}
                          disabled={operatorAnalyticsLoading}
                          variant="outline"
                        >
                          <RefreshCw className={`h-4 w-4 mr-2 ${operatorAnalyticsLoading ? 'animate-spin' : ''}`} />
                          {operatorAnalyticsLoading ? 'Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...' : 'ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ'}
                        </Button>
                      </div>

                      {operatorDashboardAnalytics ? (
                        <div className="space-y-6">
                          {/* ÐžÐ±Ñ‰Ð°Ñ ÑÐ²Ð¾Ð´ÐºÐ° Ð¿Ð¾ Ð²ÑÐµÐ¼ ÑÐºÐ»Ð°Ð´Ð°Ð¼ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° */}
                          <div>
                            <h3 className="text-lg font-semibold mb-4 text-gray-700">ÐžÐ±Ñ‰Ð°Ñ ÑÐ²Ð¾Ð´ÐºÐ° Ð¿Ð¾ Ð¼Ð¾Ð¸Ð¼ ÑÐºÐ»Ð°Ð´Ð°Ð¼</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                              <Card key="total-cargo-summary" className="bg-gradient-to-br from-blue-50 to-blue-100 border-blue-200">
                                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                                  <CardTitle className="text-sm font-medium">Ð’ÑÐµÐ³Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²</CardTitle>
                                  <Package className="h-4 w-4 text-blue-600" />
                                </CardHeader>
                                <CardContent>
                                  <div className="text-2xl font-bold text-blue-700">
                                    {operatorDashboardAnalytics.summary_stats?.total_cargo_in_my_warehouses || 0}
                                  </div>
                                  <p className="text-xs text-blue-600 mt-1">Ð½Ð° Ð¼Ð¾Ð¸Ñ… ÑÐºÐ»Ð°Ð´Ð°Ñ…</p>
                                </CardContent>
                              </Card>
                              
                              <Card key="total-weight-summary" className="bg-gradient-to-br from-indigo-50 to-indigo-100 border-indigo-200">
                                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                                  <CardTitle className="text-sm font-medium">ÐžÐ±Ñ‰Ð¸Ð¹ Ð²ÐµÑ</CardTitle>
                                  <Package2 className="h-4 w-4 text-indigo-600" />
                                </CardHeader>
                                <CardContent>
                                  <div className="text-2xl font-bold text-indigo-700">
                                    {operatorDashboardAnalytics.summary_stats?.total_weight_kg?.toLocaleString() || '0'}
                                  </div>
                                  <p className="text-xs text-indigo-600 mt-1">ÐºÐ³</p>
                                </CardContent>
                              </Card>
                              
                              <Card key="total-value-summary" className="bg-gradient-to-br from-emerald-50 to-emerald-100 border-emerald-200">
                                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                                  <CardTitle className="text-sm font-medium">ÐžÐ±Ñ‰Ð°Ñ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ</CardTitle>
                                  <DollarSign className="h-4 w-4 text-emerald-600" />
                                </CardHeader>
                                <CardContent>
                                  <div className="text-2xl font-bold text-emerald-700">
                                    {operatorDashboardAnalytics.summary_stats?.total_value_rub?.toLocaleString() || '0'}
                                  </div>
                                  <p className="text-xs text-emerald-600 mt-1">â‚½</p>
                                </CardContent>
                              </Card>
                              
                              <Card key="occupancy-summary" className="bg-gradient-to-br from-purple-50 to-purple-100 border-purple-200">
                                <CardHeader className="flex flex-row items-center justify-between space-y-0 pb-2">
                                  <CardTitle className="text-sm font-medium">Ð—Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ</CardTitle>
                                  <BarChart className="h-4 w-4 text-purple-600" />
                                </CardHeader>
                                <CardContent>
                                  <div className="text-2xl font-bold text-purple-700">
                                    {operatorDashboardAnalytics.summary_stats?.average_occupancy_rate || 0}%
                                  </div>
                                  <p className="text-xs text-purple-600 mt-1">
                                    {operatorDashboardAnalytics.summary_stats?.occupied_cells || 0} Ð¸Ð· {operatorDashboardAnalytics.summary_stats?.total_cells || 0} ÑÑ‡ÐµÐµÐº
                                  </p>
                                </CardContent>
                              </Card>
                            </div>
                          </div>

                          {/* Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¿Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ ÑÐºÐ»Ð°Ð´Ñƒ */}
                          <div>
                            <h3 className="text-lg font-semibold mb-4 text-gray-700">ÐœÐ¾Ð¸ ÑÐºÐ»Ð°Ð´Ñ‹ - Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ</h3>
                            <div className="grid gap-6">
                              {operatorDashboardAnalytics.warehouses_details?.map((warehouse, index) => (
                                <Card key={`warehouse-detail-${warehouse.warehouse_id}`} className="border-l-4 border-l-blue-500">
                                  <CardHeader>
                                    <CardTitle className="flex items-center justify-between">
                                      <div className="flex items-center">
                                        <Building className="mr-3 h-5 w-5 text-blue-600" />
                                        <div>
                                          <h4 className="text-lg font-semibold">{warehouse.warehouse_name}</h4>
                                          <p className="text-sm text-gray-600">{warehouse.warehouse_location}</p>
                                        </div>
                                      </div>
                                      <Badge variant="secondary">
                                        {warehouse.cargo_stats?.occupancy_rate || 0}% Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½
                                      </Badge>
                                    </CardTitle>
                                  </CardHeader>
                                  <CardContent>
                                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                                      {/* Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° ÑÐºÐ»Ð°Ð´Ð° */}
                                      <div className="bg-slate-50 p-3 rounded-lg">
                                        <h5 className="font-semibold text-slate-700 mb-2">Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð°</h5>
                                        <div className="text-sm text-slate-600 space-y-1">
                                          <p>ðŸ“¦ Ð‘Ð»Ð¾ÐºÐ¾Ð²: {warehouse.warehouse_structure?.blocks_count || 0}</p>
                                          <p>ðŸ“š ÐŸÐ¾Ð»Ð¾Ðº/Ð±Ð»Ð¾Ðº: {warehouse.warehouse_structure?.shelves_per_block || 0}</p>
                                          <p>ðŸ”² Ð¯Ñ‡ÐµÐµÐº/Ð¿Ð¾Ð»ÐºÐ°: {warehouse.warehouse_structure?.cells_per_shelf || 0}</p>
                                          <p className="font-semibold">ðŸŽ¯ Ð’ÑÐµÐ³Ð¾ ÑÑ‡ÐµÐµÐº: {warehouse.warehouse_structure?.total_cells || 0}</p>
                                        </div>
                                      </div>

                                      {/* Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð³Ñ€ÑƒÐ·Ð¾Ð² */}
                                      <div className="bg-blue-50 p-3 rounded-lg">
                                        <h5 className="font-semibold text-blue-700 mb-2">Ð“Ñ€ÑƒÐ·Ñ‹</h5>
                                        <div className="text-sm space-y-1">
                                          <p className="text-blue-900 font-bold text-lg">{warehouse.cargo_stats?.total_cargo || 0}</p>
                                          <p className="text-blue-600">ðŸ“¦ Ð’ÑÐµÐ³Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²</p>
                                          <p className="text-blue-600">âš–ï¸ {warehouse.cargo_stats?.total_weight_kg?.toLocaleString() || 0} ÐºÐ³</p>
                                          <p className="text-blue-600">ðŸ’° {warehouse.cargo_stats?.total_value_rub?.toLocaleString() || 0} â‚½</p>
                                        </div>
                                      </div>

                                      {/* Ð—Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ */}
                                      <div className="bg-green-50 p-3 rounded-lg">
                                        <h5 className="font-semibold text-green-700 mb-2">Ð—Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ</h5>
                                        <div className="text-sm space-y-1">
                                          <p className="text-green-900 font-bold text-lg">{warehouse.cargo_stats?.occupancy_rate || 0}%</p>
                                          <p className="text-green-600">ðŸŸ¢ Ð—Ð°Ð½ÑÑ‚Ð¾: {warehouse.cargo_stats?.occupied_cells || 0}</p>
                                          <p className="text-green-600">âšª Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð¾: {warehouse.cargo_stats?.free_cells || 0}</p>
                                        </div>
                                      </div>

                                      {/* ÐšÐ»Ð¸ÐµÐ½Ñ‚Ñ‹ */}
                                      <div className="bg-orange-50 p-3 rounded-lg">
                                        <h5 className="font-semibold text-orange-700 mb-2">ÐšÐ»Ð¸ÐµÐ½Ñ‚Ñ‹</h5>
                                        <div className="text-sm space-y-1">
                                          <p className="text-orange-600">ðŸ“¤ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ¹: {warehouse.clients?.unique_senders || 0}</p>
                                          <p className="text-orange-600">ðŸ“¥ ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÐµÐ¹: {warehouse.clients?.unique_recipients || 0}</p>
                                          <div className="mt-2 pt-2 border-t border-orange-200">
                                            <p className="text-orange-600">ðŸ’³ ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½Ð¾: {warehouse.financial?.paid_cargo || 0}</p>
                                            <p className="text-orange-600">â³ ÐÐµ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð¾: {warehouse.financial?.unpaid_cargo || 0}</p>
                                          </div>
                                        </div>
                                      </div>
                                    </div>

                                    {/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ Ð´Ð»Ñ ÑÐºÐ»Ð°Ð´Ð° */}
                                    <div className="mt-4 flex flex-wrap gap-2">
                                      <Button 
                                        size="sm" 
                                        variant="outline"
                                        onClick={() => setShowWarehouseScheme(warehouse.warehouse_id)}
                                      >
                                        <MapPin className="mr-2 h-4 w-4" />
                                        Ð¡Ñ…ÐµÐ¼Ð° ÑÐºÐ»Ð°Ð´Ð°
                                      </Button>
                                      <Button size="sm" variant="outline">
                                        <FileText className="mr-2 h-4 w-4" />
                                        ÐžÑ‚Ñ‡ÐµÑ‚
                                      </Button>
                                      <Button size="sm" variant="outline">
                                        <Settings className="mr-2 h-4 w-4" />
                                        Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ
                                      </Button>
                                    </div>
                                  </CardContent>
                                </Card>
                              )) || (
                                <Card>
                                  <CardContent className="p-8 text-center">
                                    <Building className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                                    <p className="text-gray-500">Ð£ Ð²Ð°Ñ Ð½ÐµÑ‚ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð½Ñ‹Ñ… ÑÐºÐ»Ð°Ð´Ð¾Ð²</p>
                                  </CardContent>
                                </Card>
                              )}
                            </div>
                          </div>

                          {/* Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² Ð¸ Ñ„Ð¸Ð½Ð°Ð½ÑÑ‹ Ð¿Ð¾ Ð²ÑÐµÐ¼ ÑÐºÐ»Ð°Ð´Ð°Ð¼ */}
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                            {/* ÐšÐ»Ð¸ÐµÐ½Ñ‚Ñ‹ */}
                            <Card key="clients-summary">
                              <CardHeader>
                                <CardTitle className="flex items-center">
                                  <Users className="mr-2 h-5 w-5" />
                                  ÐœÐ¾Ð¸ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñ‹
                                </CardTitle>
                              </CardHeader>
                              <CardContent>
                                <div className="space-y-3">
                                  <div className="flex justify-between items-center">
                                    <span className="text-sm text-gray-600">ðŸ“¤ Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÐµÐ¹</span>
                                    <span className="font-semibold">{operatorDashboardAnalytics.clients_stats?.unique_senders || 0}</span>
                                  </div>
                                  <div className="flex justify-between items-center">
                                    <span className="text-sm text-gray-600">ðŸ“¥ Ð£Ð½Ð¸ÐºÐ°Ð»ÑŒÐ½Ñ‹Ñ… Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÐµÐ¹</span>
                                    <span className="font-semibold">{operatorDashboardAnalytics.clients_stats?.unique_recipients || 0}</span>
                                  </div>
                                </div>
                              </CardContent>
                            </Card>

                            {/* Ð¤Ð¸Ð½Ð°Ð½ÑÑ‹ */}
                            <Card key="financial-summary">
                              <CardHeader>
                                <CardTitle className="flex items-center">
                                  <CreditCard className="mr-2 h-5 w-5" />
                                  Ð¤Ð¸Ð½Ð°Ð½ÑÑ‹
                                </CardTitle>
                              </CardHeader>
                              <CardContent>
                                <div className="space-y-3">
                                  <div className="flex justify-between items-center">
                                    <span className="text-sm text-gray-600">ðŸ’³ ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²</span>
                                    <span className="font-semibold text-green-600">{operatorDashboardAnalytics.financial_stats?.paid_cargo || 0}</span>
                                  </div>
                                  <div className="flex justify-between items-center">
                                    <span className="text-sm text-gray-600">â³ ÐÐµ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð¾</span>
                                    <span className="font-semibold text-red-600">{operatorDashboardAnalytics.financial_stats?.unpaid_cargo || 0}</span>
                                  </div>
                                  <div className="flex justify-between items-center">
                                    <span className="text-sm text-gray-600">ðŸ’¸ Ð¡ÑƒÐ¼Ð¼Ð° Ð´Ð¾Ð»Ð³Ð¾Ð²</span>
                                    <span className="font-semibold text-red-600">{operatorDashboardAnalytics.financial_stats?.debt_amount?.toLocaleString() || 0} â‚½</span>
                                  </div>
                                </div>
                              </CardContent>
                            </Card>
                          </div>

                          {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°Ñ… Ð½Ð° ÑÐºÐ»Ð°Ð´Ð°Ñ… */}
                          <Card key="operators-summary">
                            <CardHeader>
                              <CardTitle className="flex items-center">
                                <UserCheck className="mr-2 h-5 w-5" />
                                ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñ‹ Ð½Ð° Ð¼Ð¾Ð¸Ñ… ÑÐºÐ»Ð°Ð´Ð°Ñ…
                              </CardTitle>
                            </CardHeader>
                            <CardContent>
                              <div className="space-y-3">
                                <div className="flex justify-between items-center">
                                  <span className="text-sm text-gray-600">ðŸ‘¥ Ð’ÑÐµÐ³Ð¾ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð²</span>
                                  <span className="font-semibold">{operatorDashboardAnalytics.operator_info?.total_operators_on_my_warehouses || 0}</span>
                                </div>
                                <div className="flex justify-between items-center">
                                  <span className="text-sm text-gray-600">ðŸ“‹ ÐžÐ±Ñ‰ÐµÐµ ÐºÐ¾Ð»-Ð²Ð¾ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ð¹</span>
                                  <span className="font-semibold">{operatorDashboardAnalytics.operator_info?.total_operators_assignments || 0}</span>
                                </div>
                              </div>
                            </CardContent>
                          </Card>

                          {/* Ð“Ñ€ÑƒÐ·Ñ‹ Ð¿Ð¾ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸ÑÐ¼ */}
                          {operatorDashboardAnalytics.cargo_by_destinations && Object.keys(operatorDashboardAnalytics.cargo_by_destinations).length > 0 && (
                            <Card key="cargo-destinations">
                              <CardHeader>
                                <CardTitle className="flex items-center">
                                  <MapPin className="mr-2 h-5 w-5" />
                                  Ð“Ñ€ÑƒÐ·Ñ‹, Ð¾Ð¶Ð¸Ð´Ð°ÑŽÑ‰Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ Ð¿Ð¾ Ð½Ð°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸ÑÐ¼
                                </CardTitle>
                                <CardDescription>
                                  Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ñ€Ð°Ð·Ð±Ð¸Ð²ÐºÐ° Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð¿Ð¾ Ð¿ÑƒÐ½ÐºÑ‚Ð°Ð¼ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ
                                </CardDescription>
                              </CardHeader>
                              <CardContent>
                                <div className="space-y-4">
                                  {Object.entries(operatorDashboardAnalytics.cargo_by_destinations).map(([destination, data]) => (
                                    <div key={destination} className="border rounded-lg p-4">
                                      <div className="flex justify-between items-center mb-3">
                                        <h4 className="font-semibold text-lg">
                                          {destination === 'ÐœÐ¾ÑÐºÐ²Ð°' && 'ðŸ‡·ðŸ‡º ÐœÐ¾ÑÐºÐ²Ð°'}
                                          {destination === 'Ð”ÑƒÑˆÐ°Ð½Ð±Ðµ' && 'ðŸ‡¹ðŸ‡¯ Ð”ÑƒÑˆÐ°Ð½Ð±Ðµ'}
                                          {destination === 'Ð¥ÑƒÐ´Ð¶Ð°Ð½Ð´' && 'ðŸ‡¹ðŸ‡¯ Ð¥ÑƒÐ´Ð¶Ð°Ð½Ð´'}
                                          {destination === 'ÐšÑƒÐ»Ð¾Ð±' && 'ðŸ‡¹ðŸ‡¯ ÐšÑƒÐ»Ð¾Ð±'}
                                          {destination === 'ÐšÑƒÑ€Ð³Ð°Ð½-Ð¢ÑŽÐ±Ðµ' && 'ðŸ‡¹ðŸ‡¯ ÐšÑƒÑ€Ð³Ð°Ð½-Ð¢ÑŽÐ±Ðµ'}
                                          {!['ÐœÐ¾ÑÐºÐ²Ð°', 'Ð”ÑƒÑˆÐ°Ð½Ð±Ðµ', 'Ð¥ÑƒÐ´Ð¶Ð°Ð½Ð´', 'ÐšÑƒÐ»Ð¾Ð±', 'ÐšÑƒÑ€Ð³Ð°Ð½-Ð¢ÑŽÐ±Ðµ'].includes(destination) && `ðŸ“ ${destination}`}
                                        </h4>
                                      </div>
                                      <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                                        <div className="text-center">
                                          <div className="text-2xl font-bold text-blue-600">
                                            {data.cargo_count || 0}
                                          </div>
                                          <div className="text-sm text-gray-600">Ð³Ñ€ÑƒÐ·Ð¾Ð²</div>
                                        </div>
                                        <div className="text-center">
                                          <div className="text-2xl font-bold text-indigo-600">
                                            {(data.total_weight || 0).toLocaleString()}
                                          </div>
                                          <div className="text-sm text-gray-600">ÐºÐ³</div>
                                        </div>
                                        <div className="text-center">
                                          <div className="text-2xl font-bold text-emerald-600">
                                            {(data.total_value || 0).toLocaleString()}
                                          </div>
                                          <div className="text-sm text-gray-600">â‚½</div>
                                        </div>
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </CardContent>
                            </Card>
                          )}
                        </div>
                      ) : (
                        <Card key="loading-analytics">
                          <CardContent className="p-6">
                            <div className="text-center py-8">
                              <RefreshCw className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500 mb-4">Ð—Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÐ¼ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½ÑƒÑŽ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÑƒ Ð¿Ð¾ Ð²Ð°ÑˆÐ¸Ð¼ ÑÐºÐ»Ð°Ð´Ð°Ð¼...</p>
                              <Button onClick={fetchOperatorDashboardAnalytics} variant="outline">
                                <RefreshCw className="mr-2 h-4 w-4" />
                                Ð—Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÑƒ
                              </Button>
                            </div>
                          </CardContent>
                        </Card>
                      )}
                    </div>
                  )}

                  {/* ÐŸÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ */}
                  <Card>
                    <CardHeader>
                      <CardTitle className="flex items-center">
                        <User className="mr-2 h-5 w-5" />
                        {user?.role === 'warehouse_operator' ? 'ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° ÑÐºÐ»Ð°Ð´Ð°' : 'Ð›Ð¸Ñ‡Ð½Ñ‹Ð¹ ÐºÐ°Ð±Ð¸Ð½ÐµÑ‚'}
                      </CardTitle>
                      <CardDescription>
                        {user?.role === 'warehouse_operator' ? 
                          'Ð’Ð°ÑˆÐ° Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¸ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹' : 
                          'Ð’Ð°ÑˆÐ° Ð¿ÐµÑ€ÑÐ¾Ð½Ð°Ð»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¸ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹'
                        }
                      </CardDescription>
                    </CardHeader>
                    <CardContent>
                      <div className="flex items-center justify-between mb-6">
                        <Button 
                          onClick={fetchPersonalDashboard}
                          disabled={dashboardLoading}
                        >
                          {dashboardLoading ? 'Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°...' : 'ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ'}
                        </Button>
                        
                        {/* ÐÐ¾Ð²Ñ‹Ðµ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ Ð´Ð»Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² Ð¸ Ð°Ð´Ð¼Ð¸Ð½Ð¾Ð² */}
                        {(user?.role === 'admin' || user?.role === 'warehouse_operator') && (
                          <div className="flex gap-2">
                            <Dialog>
                              <DialogTrigger asChild>
                                <Button variant="outline">
                                  <QrCode className="mr-2 h-4 w-4" />
                                  Ð¨Ñ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´Ñ‹
                                </Button>
                              </DialogTrigger>
                              <DialogContent className="max-w-2xl">
                                <DialogHeader>
                                  <DialogTitle>Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´Ð¾Ð² Ð´Ð»Ñ Ð³Ñ€ÑƒÐ·Ð¾Ð²</DialogTitle>
                                  <DialogDescription>
                                    Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€Ð° Ð³Ñ€ÑƒÐ·Ð¾Ð² Ñ‡ÐµÑ€ÐµÐ· Ð·Ð°Ð¿ÑÑ‚ÑƒÑŽ Ð´Ð»Ñ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ QR-ÐºÐ¾Ð´Ð¾Ð²
                                  </DialogDescription>
                                </DialogHeader>
                                <div className="space-y-4">
                                  <div>
                                    <Label htmlFor="cargo-numbers">ÐÐ¾Ð¼ÐµÑ€Ð° Ð³Ñ€ÑƒÐ·Ð¾Ð²</Label>
                                    <Textarea
                                      id="cargo-numbers"
                                      placeholder="CRG-001, CRG-002, CRG-003..."
                                      className="min-h-20"
                                    />
                                  </div>
                                  <div className="flex gap-2">
                                    <Button className="flex-1">
                                      <QrCode className="mr-2 h-4 w-4" />
                                      Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´Ñ‹
                                    </Button>
                                    <Button variant="outline" className="flex-1">
                                      <Printer className="mr-2 h-4 w-4" />
                                      ÐŸÐµÑ‡Ð°Ñ‚ÑŒ ÑˆÑ‚Ñ€Ð¸Ñ…ÐºÐ¾Ð´Ð¾Ð²
                                    </Button>
                                  </div>
                                </div>
                              </DialogContent>
                            </Dialog>

                            <Dialog>
                              <DialogTrigger asChild>
                                <Button variant="outline">
                                  <FileText className="mr-2 h-4 w-4" />
                                  ÐÐ°ÐºÐ»Ð°Ð´Ð½Ð°Ñ
                                </Button>
                              </DialogTrigger>
                              <DialogContent className="max-w-4xl">
                                <DialogHeader>
                                  <DialogTitle>Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ Ð½Ð°ÐºÐ»Ð°Ð´Ð½Ð¾Ð¹</DialogTitle>
                                  <DialogDescription>
                                    Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½Ð°ÐºÐ»Ð°Ð´Ð½Ð¾Ð¹ Ð´Ð»Ñ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ Ð³Ñ€ÑƒÐ·Ð¾Ð²
                                  </DialogDescription>
                                </DialogHeader>
                                <div className="space-y-4">
                                  <div>
                                    <Label htmlFor="invoice-cargo-numbers">ÐÐ¾Ð¼ÐµÑ€Ð° Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð´Ð»Ñ Ð½Ð°ÐºÐ»Ð°Ð´Ð½Ð¾Ð¹</Label>
                                    <Textarea
                                      id="invoice-cargo-numbers"
                                      placeholder="CRG-001, CRG-002, CRG-003..."
                                      className="min-h-20"
                                    />
                                  </div>
                                  <div className="flex gap-2">
                                    <Button className="flex-1">
                                      <FileText className="mr-2 h-4 w-4" />
                                      Ð¡Ð³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð½Ð°ÐºÐ»Ð°Ð´Ð½ÑƒÑŽ
                                    </Button>
                                    <Button variant="outline" className="flex-1">
                                      <Printer className="mr-2 h-4 w-4" />
                                      ÐŸÐµÑ‡Ð°Ñ‚ÑŒ Ð½Ð°ÐºÐ»Ð°Ð´Ð½Ð¾Ð¹
                                    </Button>
                                  </div>
                                </div>
                              </DialogContent>
                            </Dialog>
                          </div>
                        )}
                      </div>
                      
                      {personalDashboardData && (
                        <div className="space-y-6">
                          {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ */}
                          <div className="bg-gray-50 p-6 rounded-lg">
                            <h3 className="text-lg font-semibold mb-4">Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ</h3>
                            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                              <div>
                                <label className="text-sm font-medium text-gray-500">ÐÐ¾Ð¼ÐµÑ€ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ</label>
                                <p className="text-lg">{personalDashboardData.user_info.user_number}</p>
                              </div>
                              <div>
                                <label className="text-sm font-medium text-gray-500">Ð¤Ð˜Ðž</label>
                                <p className="text-lg">{personalDashboardData.user_info.full_name}</p>
                              </div>
                              <div>
                                <label className="text-sm font-medium text-gray-500">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½</label>
                                <p className="text-lg">{personalDashboardData.user_info.phone}</p>
                              </div>
                              <div>
                                <label className="text-sm font-medium text-gray-500">Ð Ð¾Ð»ÑŒ</label>
                                <Badge variant="outline">{getRoleLabel(personalDashboardData.user_info.role)}</Badge>
                              </div>
                              <div>
                                <label className="text-sm font-medium text-gray-500">Ð”Ð°Ñ‚Ð° Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸</label>
                                <p className="text-lg">{new Date(personalDashboardData.user_info.created_at).toLocaleDateString('ru-RU')}</p>
                              </div>
                            </div>
                          </div>

                          {/* Ð—Ð°ÑÐ²ÐºÐ¸ Ð½Ð° Ð³Ñ€ÑƒÐ·Ñ‹ */}
                          <div>
                            <h3 className="text-lg font-semibold mb-4 flex items-center">
                              <FileText className="mr-2 h-5 w-5" />
                              ÐœÐ¾Ð¸ Ð·Ð°ÑÐ²ÐºÐ¸ Ð½Ð° Ð³Ñ€ÑƒÐ·Ñ‹ ({personalDashboardData.cargo_requests.length})
                            </h3>
                            {personalDashboardData.cargo_requests.length > 0 ? (
                              <div className="space-y-3">
                                {personalDashboardData.cargo_requests.slice(0, 10).map((request, index) => (
                                  <div key={`request-${request.id || index}-${request.cargo_name || index}`} className="bg-white border rounded-lg p-4">
                                    <div className="flex justify-between items-start">
                                      <div>
                                        <h4 className="font-medium">{request.cargo_name}</h4>
                                        <p className="text-sm text-gray-600">
                                          Ð’ÐµÑ: {request.weight} ÐºÐ³ | Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ: {request.declared_value} Ñ€ÑƒÐ±
                                        </p>
                                        <p className="text-sm text-gray-600">
                                          ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ: {request.recipient_name} ({request.recipient_phone})
                                        </p>
                                      </div>
                                      <div className="text-right">
                                        <Badge variant="secondary">{request.status}</Badge>
                                        <p className="text-xs text-gray-500 mt-1">
                                          {new Date(request.created_at).toLocaleDateString('ru-RU')}
                                        </p>
                                      </div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <p className="text-gray-500">Ð£ Ð²Ð°Ñ Ð¿Ð¾ÐºÐ° Ð½ÐµÑ‚ Ð·Ð°ÑÐ²Ð¾Ðº Ð½Ð° Ð³Ñ€ÑƒÐ·Ñ‹</p>
                            )}
                          </div>

                          {/* ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹ */}
                          <div>
                            <h3 className="text-lg font-semibold mb-4 flex items-center">
                              <Package className="mr-2 h-5 w-5" />
                              ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹ ({personalDashboardData.sent_cargo.length})
                            </h3>
                            {personalDashboardData.sent_cargo.length > 0 ? (
                              <div className="space-y-3">
                                {personalDashboardData.sent_cargo.slice(0, 10).map((cargo, index) => (
                                  <div key={`sent-cargo-${cargo.id || index}-${cargo.cargo_number || index}`} className="bg-white border rounded-lg p-4">
                                    <div className="flex justify-between items-start">
                                      <div>
                                        <h4 className="font-medium">
                                          {cargo.cargo_number} - {cargo.cargo_name}
                                        </h4>
                                        <p className="text-sm text-gray-600">
                                          Ð’ÐµÑ: {cargo.weight} ÐºÐ³ | Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ: {cargo.declared_value} Ñ€ÑƒÐ±
                                        </p>
                                        <p className="text-sm text-gray-600">
                                          ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ: {cargo.recipient_name} ({cargo.recipient_phone})
                                        </p>
                                        {cargo.created_by_operator && (
                                          <p className="text-sm text-gray-500">
                                            ÐŸÑ€Ð¸Ð½ÑÑ‚Ð¾ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼: {cargo.created_by_operator}
                                          </p>
                                        )}
                                      </div>
                                      <div className="text-right">
                                        <div className="space-y-1">
                                          <Badge variant="default">{cargo.status}</Badge>
                                          {cargo.payment_status && (
                                            <Badge variant="secondary" className="block">
                                              {cargo.payment_status}
                                            </Badge>
                                          )}
                                          {cargo.processing_status && (
                                            <Badge variant="outline" className="block">
                                              {cargo.processing_status}
                                            </Badge>
                                          )}
                                        </div>
                                        <p className="text-xs text-gray-500 mt-1">
                                          {new Date(cargo.created_at).toLocaleDateString('ru-RU')}
                                        </p>
                                      </div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <p className="text-gray-500">Ð£ Ð²Ð°Ñ Ð¿Ð¾ÐºÐ° Ð½ÐµÑ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð²</p>
                            )}
                          </div>

                          {/* ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹ */}
                          <div>
                            <h3 className="text-lg font-semibold mb-4 flex items-center">
                              <Truck className="mr-2 h-5 w-5" />
                              ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹ ({personalDashboardData.received_cargo.length})
                            </h3>
                            {personalDashboardData.received_cargo.length > 0 ? (
                              <div className="space-y-3">
                                {personalDashboardData.received_cargo.slice(0, 10).map((cargo, index) => (
                                  <div key={`received-cargo-${cargo.id || index}-${cargo.cargo_number || index}`} className="bg-white border rounded-lg p-4">
                                    <div className="flex justify-between items-start">
                                      <div>
                                        <h4 className="font-medium">
                                          {cargo.cargo_number} - {cargo.cargo_name}
                                        </h4>
                                        <p className="text-sm text-gray-600">
                                          Ð’ÐµÑ: {cargo.weight} ÐºÐ³ | Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ: {cargo.declared_value} Ñ€ÑƒÐ±
                                        </p>
                                        <p className="text-sm text-gray-600">
                                          ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ: {cargo.sender_name} ({cargo.sender_phone})
                                        </p>
                                        {cargo.created_by_operator && (
                                          <p className="text-sm text-gray-500">
                                            ÐŸÑ€Ð¸Ð½ÑÑ‚Ð¾ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼: {cargo.created_by_operator}
                                          </p>
                                        )}
                                      </div>
                                      <div className="text-right">
                                        <div className="space-y-1">
                                          <Badge variant="default">{cargo.status}</Badge>
                                          {cargo.payment_status && (
                                            <Badge variant="secondary" className="block">
                                              {cargo.payment_status}
                                            </Badge>
                                          )}
                                        </div>
                                        <p className="text-xs text-gray-500 mt-1">
                                          {new Date(cargo.created_at).toLocaleDateString('ru-RU')}
                                        </p>
                                      </div>
                                    </div>
                                  </div>
                                ))}
                              </div>
                            ) : (
                              <p className="text-gray-500">Ð£ Ð²Ð°Ñ Ð¿Ð¾ÐºÐ° Ð½ÐµÑ‚ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð²</p>
                            )}
                          </div>
                        </div>
                      )}
                      
                      {!personalDashboardData && !dashboardLoading && (
                        <div className="text-center py-8">
                          <User className="mx-auto h-12 w-12 text-gray-400" />
                          <h3 className="mt-4 text-sm font-medium text-gray-900">Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶ÐµÐ½Ñ‹</h3>
                          <p className="mt-1 text-sm text-gray-500">
                            ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ ÐºÐ½Ð¾Ð¿ÐºÑƒ "ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ð´Ð°Ð½Ð½Ñ‹Ðµ" Ð´Ð»Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸
                          </p>
                        </div>
                      )}
                    </CardContent>
                  </Card>
                </div>
              )}

              {/* ÐœÐ¾Ð±Ð¸Ð»ÑŒÐ½Ñ‹Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸ */}
              {activeSection === 'operations' && (
                <div className="space-y-6">
                  {/* ÐŸÐ¾Ð¸ÑÐº Ð³Ñ€ÑƒÐ·Ð° */}
                  {activeTab === 'operations-search' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Search className="mr-2 h-5 w-5" />
                          ÐŸÐ¾Ð¸ÑÐº Ð³Ñ€ÑƒÐ·Ð° Ð¿Ð¾ QR ÐºÐ¾Ð´Ñƒ
                        </CardTitle>
                        <CardDescription>Ð¡ÐºÐ°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð° Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {/* QR ÑÐºÐ°Ð½ÐµÑ€ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ Ñ Ð¿Ð»ÐµÐ¹ÑÑ…Ð¾Ð»Ð´ÐµÑ€Ð¾Ð¼ */}
                          <div className="relative">
                            <div 
                              id="qr-reader-placement" 
                              className="w-full bg-black rounded-lg"
                              style={{
                                aspectRatio: '1',
                                maxWidth: '400px',
                                margin: '0 auto'
                              }}
                            />
                            
                            {/* ÐŸÐ»ÐµÐ¹ÑÑ…Ð¾Ð»Ð´ÐµÑ€ Ð¾Ñ‚Ð¾Ð±Ñ€Ð°Ð¶Ð°ÐµÑ‚ÑÑ ÐºÐ¾Ð³Ð´Ð° ÐºÐ°Ð¼ÐµÑ€Ð° Ð½Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð° */}
                            {!searchScannerActive && (
                              <div 
                                className="absolute inset-0 bg-black rounded-lg camera-placeholder"
                                style={{
                                  display: 'flex',
                                  alignItems: 'center',
                                  justifyContent: 'center',
                                  color: '#a0aec0',
                                  fontSize: '14px',
                                  fontWeight: '500'
                                }}
                              >
                                ðŸ“· ÐšÐ°Ð¼ÐµÑ€Ð° Ð±ÑƒÐ´ÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð° Ð·Ð´ÐµÑÑŒ
                              </div>
                            )}
                          </div>

                          {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð²Ð½Ð¸Ð·Ñƒ */}
                          <div className="text-center">
                            <Button 
                              onClick={() => startCargoSearch()}
                              className="w-full bg-blue-600 hover:bg-blue-700 text-white"
                              size="lg"
                              disabled={searchScannerActive}
                            >
                              <Camera className="mr-2 h-5 w-5" />
                              {searchScannerActive ? 'Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾...' : 'ÐÐ°Ñ‡Ð°Ñ‚ÑŒ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°'}
                            </Button>
                          </div>

                          {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ ÐºÐ°Ð¼ÐµÑ€Ñ‹ */}
                          {searchScannerActive && availableCameras.length > 1 && (
                            <div className="text-center">
                              <Button 
                                onClick={() => switchCamera()}
                                variant="outline"
                                size="sm"
                              >
                                <RefreshCw className="mr-2 h-4 w-4" />
                                ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ ({availableCameras.length > currentCameraIndex ? 
                                  (availableCameras[currentCameraIndex].label?.includes('back') || 
                                   availableCameras[currentCameraIndex].label?.includes('rear') ||
                                   availableCameras[currentCameraIndex].label?.includes('environment') ? 'Ð·Ð°Ð´Ð½ÑÑ' : 'Ð¿ÐµÑ€ÐµÐ´Ð½ÑÑ') 
                                  : 'Ð½ÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ð¾'})
                              </Button>
                            </div>
                          )}

                          {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ */}
                          {searchScannerActive && (
                            <div className="text-center mt-3">
                              <Button 
                                onClick={stopMobileScanning}
                                variant="destructive"
                                size="sm"
                              >
                                <X className="mr-2 h-4 w-4" />
                                Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
                              </Button>
                            </div>
                          )}

                          {/* Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð¿Ð¾Ð¸ÑÐºÐ° */}
                          {searchResult && (
                            <Card className="mt-4">
                              <CardHeader>
                                <CardTitle className="text-lg text-green-600">
                                  Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ
                                </CardTitle>
                              </CardHeader>
                              <CardContent className="space-y-4">
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                  <div>
                                    <Label className="font-semibold">ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°</Label>
                                    <p>{searchResult.cargo_number}</p>
                                  </div>
                                  <div>
                                    <Label className="font-semibold">Ð¡Ñ‚Ð°Ñ‚ÑƒÑ</Label>
                                    <Badge className={
                                      searchResult.status === 'delivered' ? 'bg-green-100 text-green-800' :
                                      searchResult.status === 'in_transit' ? 'bg-blue-100 text-blue-800' :
                                      'bg-yellow-100 text-yellow-800'
                                    }>
                                      {searchResult.status === 'delivered' ? 'Ð”Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½' :
                                       searchResult.status === 'in_transit' ? 'Ð’ Ð¿ÑƒÑ‚Ð¸' :
                                       'ÐŸÑ€Ð¸Ð½ÑÑ‚'}
                                    </Badge>
                                  </div>
                                  <div>
                                    <Label className="font-semibold">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ</Label>
                                    <p>{searchResult.sender_full_name}</p>
                                    <p className="text-sm text-gray-600">{searchResult.sender_phone}</p>
                                  </div>
                                  <div>
                                    <Label className="font-semibold">ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ</Label>
                                    <p>{searchResult.recipient_full_name}</p>
                                    <p className="text-sm text-gray-600">{searchResult.recipient_phone}</p>
                                  </div>
                                  <div>
                                    <Label className="font-semibold">Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹</Label>
                                    <Badge className={
                                      searchResult.payment_status === 'paid' ? 'bg-green-100 text-green-800' :
                                      'bg-red-100 text-red-800'
                                    }>
                                      {searchResult.payment_status === 'paid' ? 'ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½Ð¾' : 'ÐÐµ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð¾'}
                                    </Badge>
                                  </div>
                                  <div>
                                    <Label className="font-semibold">ÐœÐµÑÑ‚Ð¾Ð½Ð°Ñ…Ð¾Ð¶Ð´ÐµÐ½Ð¸Ðµ</Label>
                                    <p>{searchResult.current_location || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾'}</p>
                                  </div>
                                </div>

                                {/* Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð° */}
                                {searchResult.history && searchResult.history.length > 0 && (
                                  <div className="mt-4">
                                    <Label className="font-semibold">Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°</Label>
                                    <div className="mt-2 space-y-2">
                                      {searchResult.history.map((item, index) => (
                                        <div key={index} className="flex items-center text-sm bg-gray-50 p-2 rounded">
                                          <Clock className="mr-2 h-4 w-4 text-gray-500" />
                                          <span className="text-gray-600">{item.date}</span>
                                          <span className="ml-2">{item.action}</span>
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                )}
                              </CardContent>
                            </Card>
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ QR ÐºÐ¾Ð´Ð¾Ð² */}
                  {activeTab === 'operations-qr-generate' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <QrCode className="mr-2 h-5 w-5" />
                          Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ QR ÐºÐ¾Ð´Ð¾Ð²
                        </CardTitle>
                        <CardDescription>Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ QR ÐºÐ¾Ð´Ð¾Ð² Ð´Ð»Ñ Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð¸ ÑÑ‡ÐµÐµÐº</CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-4">
                        <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                          {/* Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ QR ÐºÐ¾Ð´Ð° Ð´Ð»Ñ Ð³Ñ€ÑƒÐ·Ð° */}
                          <div className="space-y-4">
                            <h3 className="font-semibold">QR ÐºÐ¾Ð´ Ð´Ð»Ñ Ð³Ñ€ÑƒÐ·Ð°</h3>
                            <div>
                              <Label htmlFor="cargo-number-qr">ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°</Label>
                              <Input
                                id="cargo-number-qr"
                                placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°"
                                value={qrCargoNumber}
                                onChange={(e) => setQrCargoNumber(e.target.value)}
                              />
                            </div>
                            <Button 
                              onClick={() => generateCargoQR()}
                              className="w-full bg-green-600 hover:bg-green-700"
                              disabled={!qrCargoNumber.trim()}
                            >
                              <QrCode className="mr-2 h-4 w-4" />
                              Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð°
                            </Button>
                          </div>

                          {/* Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ QR ÐºÐ¾Ð´Ð° Ð´Ð»Ñ ÑÑ‡ÐµÐ¹ÐºÐ¸ */}
                          <div className="space-y-4">
                            <h3 className="font-semibold">QR ÐºÐ¾Ð´ Ð´Ð»Ñ ÑÑ‡ÐµÐ¹ÐºÐ¸</h3>
                            <div>
                              <Label htmlFor="cell-code-qr">ÐšÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸</Label>
                              <Input
                                id="cell-code-qr"
                                placeholder="ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: W001-Ð‘1-ÐŸ1-Ð¯1"
                                value={qrCellCode}
                                onChange={(e) => setQrCellCode(e.target.value)}
                              />
                            </div>
                            <Button 
                              onClick={() => generateCellQR()}
                              className="w-full bg-purple-600 hover:bg-purple-700"
                              disabled={!qrCellCode.trim()}
                            >
                              <QrCode className="mr-2 h-4 w-4" />
                              Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ QR ÐºÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸
                            </Button>
                          </div>
                        </div>

                        {/* ÐŸÐ¾ÐºÐ°Ð· ÑÐ³ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ñ… QR ÐºÐ¾Ð´Ð¾Ð² */}
                        {(generatedCargoQR || generatedCellQR) && (
                          <div className="mt-6 grid grid-cols-1 md:grid-cols-2 gap-6">
                            {generatedCargoQR && (
                              <div className="text-center space-y-2">
                                <h4 className="font-semibold">QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð°</h4>
                                <div className="bg-white p-4 rounded border inline-block">
                                  <img src={generatedCargoQR} alt="QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð°" className="w-48 h-48" />
                                </div>
                                <Button 
                                  onClick={() => printQR(generatedCargoQR, `Ð“Ñ€ÑƒÐ·: ${qrCargoNumber}`)}
                                  variant="outline"
                                  size="sm"
                                >
                                  <Printer className="mr-2 h-4 w-4" />
                                  ÐŸÐµÑ‡Ð°Ñ‚ÑŒ
                                </Button>
                              </div>
                            )}

                            {generatedCellQR && (
                              <div className="text-center space-y-2">
                                <h4 className="font-semibold">QR ÐºÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸</h4>
                                <div className="bg-white p-4 rounded border inline-block">
                                  <img src={generatedCellQR} alt="QR ÐºÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸" className="w-48 h-48" />
                                </div>
                                <Button 
                                  onClick={() => printQR(generatedCellQR, `Ð¯Ñ‡ÐµÐ¹ÐºÐ°: ${qrCellCode}`)}
                                  variant="outline" 
                                  size="sm"
                                >
                                  <Printer className="mr-2 h-4 w-4" />
                                  ÐŸÐµÑ‡Ð°Ñ‚ÑŒ
                                </Button>
                              </div>
                            )}
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  )}

                  {/* Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° */}
                  {activeTab === 'operations-placement' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Target className="mr-2 h-5 w-5" />
                          Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°
                        </CardTitle>
                        <CardDescription>Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ QR ÐºÐ¾Ð´Ð° Ð³Ñ€ÑƒÐ·Ð° Ð¸ ÑÑ‡ÐµÐ¹ÐºÐ¸ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ</CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-4">
                        {mobilePlacementStep === 'start' && (
                          <div className="space-y-4">
                            {/* ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ ÐºÐ°Ð¼ÐµÑ€Ñ‹ ÑÐ½Ð°Ñ‡Ð°Ð»Ð° */}
                            <div 
                              id="qr-reader-placement" 
                              className="camera-placeholder w-full bg-black rounded-lg flex items-center justify-center"
                              style={{
                                aspectRatio: '1',
                                maxWidth: '400px',
                                margin: '0 auto',
                                minHeight: '250px',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                color: '#a0aec0',
                                fontSize: '14px',
                                fontWeight: '500'
                              }}
                            >
                              ðŸ“· ÐšÐ°Ð¼ÐµÑ€Ð° Ð±ÑƒÐ´ÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð° Ð·Ð´ÐµÑÑŒ
                            </div>

                            {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð²Ð½Ð¸Ð·Ñƒ */}
                            <div className="text-center">
                              <Button 
                                onClick={() => startMobilePlacement()}
                                className="w-full bg-blue-600 hover:bg-blue-700 text-white"
                                size="lg"
                              >
                                <Camera className="mr-2 h-5 w-5" />
                                ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ
                              </Button>
                            </div>
                          </div>
                        )}

                        {mobilePlacementStep === 'scan-cargo' && (
                          <div className="space-y-4">
                            <div className="text-center">
                              <h3 className="font-semibold text-blue-600">Ð¨Ð°Ð³ 1: Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°</h3>
                              <p className="text-sm text-gray-600">ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð°</p>
                            </div>
                            
                            <div 
                              id="qr-reader-placement" 
                              className="w-full bg-black rounded-lg"
                              style={{
                                aspectRatio: '1',
                                maxWidth: '400px',
                                margin: '0 auto'
                              }}
                            />

                            {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ ÐºÐ°Ð¼ÐµÑ€Ñ‹ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ */}
                            {availableCameras.length > 1 && (
                              <div className="text-center mt-2">
                                <Button 
                                  onClick={() => switchCamera()}
                                  variant="outline"
                                  size="sm"
                                >
                                  <RefreshCw className="mr-2 h-4 w-4" />
                                  ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ
                                </Button>
                              </div>
                            )}

                            {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð°Ñ Ð¿Ð°Ð½ÐµÐ»ÑŒ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ */}
                            {placementInfoMessage && (
                              <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                <p className="text-sm text-blue-800 text-center">
                                  {placementInfoMessage}
                                </p>
                              </div>
                            )}

                            {scannedCargo && (
                              <div className="p-3 bg-green-50 border border-green-200 rounded">
                                <p className="text-sm text-green-800">
                                  âœ“ Ð“Ñ€ÑƒÐ· Ð¾Ñ‚ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½: {scannedCargo.cargo_number}
                                </p>
                              </div>
                            )}
                          </div>
                        )}

                        {mobilePlacementStep === 'scan-cell' && (
                          <div className="space-y-4">
                            <div className="text-center">
                              <h3 className="font-semibold text-purple-600">Ð¨Ð°Ð³ 2: Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÑ‡ÐµÐ¹ÐºÐ¸</h3>
                              <p className="text-sm text-gray-600">ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° QR ÐºÐ¾Ð´ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾Ð¹ ÑÑ‡ÐµÐ¹ÐºÐ¸</p>
                            </div>
                            
                            <div 
                              id="qr-reader-placement" 
                              className="w-full bg-black rounded-lg"
                              style={{
                                aspectRatio: '1',
                                maxWidth: '400px',
                                margin: '0 auto'
                              }}
                            />

                            {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ ÐºÐ°Ð¼ÐµÑ€Ñ‹ Ð´Ð»Ñ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ ÑÑ‡ÐµÐ¹ÐºÐ¸ */}
                            {availableCameras.length > 1 && (
                              <div className="text-center mt-2">
                                <Button 
                                  onClick={() => switchCamera()}
                                  variant="outline"
                                  size="sm"
                                >
                                  <RefreshCw className="mr-2 h-4 w-4" />
                                  ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ
                                </Button>
                              </div>
                            )}

                            {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ */}
                            {scannerActive && (
                              <div className="text-center mt-3">
                                <Button 
                                  onClick={stopMobileScanning}
                                  variant="destructive"
                                  size="sm"
                                >
                                  <X className="mr-2 h-4 w-4" />
                                  Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
                                </Button>
                              </div>
                            )}

                            {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¾Ð½Ð½Ð°Ñ Ð¿Ð°Ð½ÐµÐ»ÑŒ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð´Ð»Ñ ÑˆÐ°Ð³Ð° 2 */}
                            {placementInfoMessage && (
                              <div className="p-4 bg-purple-50 border border-purple-200 rounded-lg">
                                <p className="text-sm text-purple-800 text-center">
                                  {placementInfoMessage}
                                </p>
                              </div>
                            )}

                            {scannedCargo && (
                              <div className="p-3 bg-blue-50 border border-blue-200 rounded">
                                <p className="text-sm text-blue-800">
                                  Ð“Ñ€ÑƒÐ· Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ: {scannedCargo.cargo_number}
                                </p>
                              </div>
                            )}
                          </div>
                        )}

                        {mobilePlacementStep === 'confirm' && (
                          <div className="space-y-4">
                            <div className="text-center">
                              <h3 className="font-semibold text-green-600">ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ</h3>
                            </div>
                            
                            <div className="bg-gray-50 p-4 rounded space-y-2">
                              <div className="flex justify-between">
                                <span>Ð“Ñ€ÑƒÐ·:</span>
                                <span className="font-medium">{scannedCargo?.cargo_number}</span>
                              </div>
                              <div className="flex justify-between">
                                <span>Ð¯Ñ‡ÐµÐ¹ÐºÐ°:</span>
                                <span className="font-medium">{scannedCell?.cell_code}</span>
                              </div>
                            </div>

                            <div className="flex space-x-2">
                              <Button 
                                onClick={() => confirmMobilePlacement()}
                                className="flex-1 bg-green-600 hover:bg-green-700"
                              >
                                <CheckCircle className="mr-2 h-4 w-4" />
                                ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚ÑŒ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ
                              </Button>
                              <Button 
                                onClick={() => resetMobilePlacement()}
                                variant="outline"
                                className="flex-1"
                              >
                                <X className="mr-2 h-4 w-4" />
                                ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ
                              </Button>
                            </div>
                          </div>
                        )}

                        {/* ÐŸÐ°Ð½ÐµÐ»ÑŒ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸ ÑÐµÑÑÐ¸Ð¸ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ */}
                        {(sessionPlacementCount > 0 || sessionPlacements.length > 0 || placementStatistics) && (
                          <div className="mt-6 p-4 bg-gray-50 border border-gray-200 rounded-lg">
                            <h4 className="font-semibold text-gray-800 mb-3 flex items-center">
                              <BarChart className="mr-2 h-4 w-4" />
                              Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ
                            </h4>
                            
                            <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                              <div className="text-center">
                                <div className="text-2xl font-bold text-blue-600">
                                  {sessionPlacementCount}
                                </div>
                                <div className="text-sm text-gray-600">Ð—Ð° ÑÑ‚Ñƒ ÑÐµÑÑÐ¸ÑŽ</div>
                              </div>
                              <div className="text-center">
                                <div className="text-2xl font-bold text-green-600">
                                  {placementStatistics?.today_placements || 0}
                                </div>
                                <div className="text-sm text-gray-600">Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¾</div>
                              </div>
                              <div className="text-center">
                                <div className="text-2xl font-bold text-purple-600">
                                  {placementStatistics?.session_placements || sessionPlacementCount}
                                </div>
                                <div className="text-sm text-gray-600">ÐžÐ±Ñ‰ÐµÐµ Ð·Ð° ÑÐµÑÑÐ¸ÑŽ</div>
                              </div>
                            </div>

                            {/* Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð² Ñ‚ÐµÐºÑƒÑ‰ÐµÐ¹ ÑÐµÑÑÐ¸Ð¸ */}
                            {sessionPlacements.length > 0 && (
                              <div>
                                <h5 className="font-medium text-gray-700 mb-2">Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¾ Ð² ÑÑ‚Ð¾Ð¹ ÑÐµÑÑÐ¸Ð¸:</h5>
                                <div className="max-h-32 overflow-y-auto space-y-1">
                                  {sessionPlacements.map((placement, index) => (
                                    <div key={index} className="text-xs bg-white p-2 rounded border">
                                      {placement}
                                    </div>
                                  ))}
                                </div>
                              </div>
                            )}
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  )}

                  {/* ÐŸÑ€Ð¸Ñ‘Ð¼ Ð³Ñ€ÑƒÐ·Ð° */}
                  {activeTab === 'operations-receive' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Package className="mr-2 h-5 w-5" />
                          ÐŸÑ€Ð¸Ñ‘Ð¼ Ð³Ñ€ÑƒÐ·Ð° Ð½Ð° Ð½Ð¾Ð²Ñ‹Ð¹ ÑÐºÐ»Ð°Ð´
                        </CardTitle>
                        <CardDescription>Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° Ð¸ ÑÑ‡ÐµÐ¹ÐºÐ¸ Ð´Ð»Ñ Ð¾Ð±Ð½Ð¾Ð²Ð»ÐµÐ½Ð¸Ñ Ð¼ÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ</CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-4">
                        {receiveStep === 'start' && (
                          <div className="space-y-4">
                            {/* ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÐºÐ¾Ð½Ñ‚ÐµÐ¹Ð½ÐµÑ€ ÐºÐ°Ð¼ÐµÑ€Ñ‹ ÑÐ½Ð°Ñ‡Ð°Ð»Ð° */}
                            <div 
                              id="qr-reader-placement" 
                              className="w-full bg-black rounded-lg camera-placeholder"
                              style={{
                                aspectRatio: '1',
                                maxWidth: '400px',
                                margin: '0 auto',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                color: '#a0aec0',
                                fontSize: '14px',
                                fontWeight: '500'
                              }}
                            >
                              ðŸ“· ÐšÐ°Ð¼ÐµÑ€Ð° Ð±ÑƒÐ´ÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð° Ð·Ð´ÐµÑÑŒ
                            </div>

                            {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð²Ð½Ð¸Ð·Ñƒ */}
                            <div className="text-center">
                              <Button 
                                onClick={() => startMobileReceive()}
                                className="w-full bg-orange-600 hover:bg-orange-700 text-white"
                                size="lg"
                              >
                                <Camera className="mr-2 h-5 w-5" />
                                ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¸Ñ‘Ð¼ Ð³Ñ€ÑƒÐ·Ð°
                              </Button>
                            </div>
                          </div>
                        )}

                        {receiveStep === 'scan-cargo' && (
                          <div className="space-y-4">
                            <div className="text-center">
                              <h3 className="font-semibold text-orange-600">Ð¨Ð°Ð³ 1: Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°</h3>
                              <p className="text-sm text-gray-600">ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð° Ð´Ð»Ñ Ð¿Ñ€Ð¸Ñ‘Ð¼Ð°</p>
                            </div>
                            
                            <div 
                              id="qr-reader-placement" 
                              className="w-full bg-black rounded-lg"
                              style={{
                                aspectRatio: '1',
                                maxWidth: '400px',
                                margin: '0 auto'
                              }}
                            />

                            {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ ÐºÐ°Ð¼ÐµÑ€Ñ‹ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð³Ñ€ÑƒÐ·Ð° */}
                            {availableCameras.length > 1 && (
                              <div className="text-center mt-2">
                                <Button 
                                  onClick={() => switchCamera()}
                                  variant="outline"
                                  size="sm"
                                >
                                  <RefreshCw className="mr-2 h-4 w-4" />
                                  ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ
                                </Button>
                              </div>
                            )}

                            {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ñ‘Ð¼Ð° Ð³Ñ€ÑƒÐ·Ð° */}
                            {scannerActive && (
                              <div className="text-center mt-3">
                                <Button 
                                  onClick={stopMobileScanning}
                                  variant="destructive"
                                  size="sm"
                                >
                                  <X className="mr-2 h-4 w-4" />
                                  Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
                                </Button>
                              </div>
                            )}

                            {receivedCargo && (
                              <div className="p-3 bg-orange-50 border border-orange-200 rounded">
                                <p className="text-sm text-orange-800">
                                  âœ“ Ð“Ñ€ÑƒÐ· Ð´Ð»Ñ Ð¿Ñ€Ð¸Ñ‘Ð¼Ð°: {receivedCargo.cargo_number}
                                </p>
                              </div>
                            )}
                          </div>
                        )}

                        {receiveStep === 'scan-new-cell' && (
                          <div className="space-y-4">
                            <div className="text-center">
                              <h3 className="font-semibold text-green-600">Ð¨Ð°Ð³ 2: Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð¹ ÑÑ‡ÐµÐ¹ÐºÐ¸</h3>
                              <p className="text-sm text-gray-600">ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° QR ÐºÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸ Ð½Ð¾Ð²Ð¾Ð³Ð¾ ÑÐºÐ»Ð°Ð´Ð°</p>
                            </div>
                            
                            <div 
                              id="qr-reader-placement" 
                              className="w-full bg-black rounded-lg"
                              style={{
                                aspectRatio: '1',
                                maxWidth: '400px',
                                margin: '0 auto'
                              }}
                            />

                            {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¿ÐµÑ€ÐµÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ñ ÐºÐ°Ð¼ÐµÑ€Ñ‹ Ð´Ð»Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÑÑ‡ÐµÐ¹ÐºÐ¸ */}
                            {availableCameras.length > 1 && (
                              <div className="text-center mt-2">
                                <Button 
                                  onClick={() => switchCamera()}
                                  variant="outline"
                                  size="sm"
                                >
                                  <RefreshCw className="mr-2 h-4 w-4" />
                                  ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ
                                </Button>
                              </div>
                            )}

                            {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð´Ð»Ñ Ð½Ð¾Ð²Ð¾Ð¹ ÑÑ‡ÐµÐ¹ÐºÐ¸ */}
                            {scannerActive && (
                              <div className="text-center mt-3">
                                <Button 
                                  onClick={stopMobileScanning}
                                  variant="destructive"
                                  size="sm"
                                >
                                  <X className="mr-2 h-4 w-4" />
                                  Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
                                </Button>
                              </div>
                            )}

                            {receivedCargo && (
                              <div className="p-3 bg-blue-50 border border-blue-200 rounded">
                                <p className="text-sm text-blue-800">
                                  Ð“Ñ€ÑƒÐ· Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ: {receivedCargo.cargo_number}
                                </p>
                              </div>
                            )}
                          </div>
                        )}

                        {receiveStep === 'confirm' && (
                          <div className="space-y-4">
                            <div className="text-center">
                              <h3 className="font-semibold text-green-600">ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸Ñ‘Ð¼Ð°</h3>
                            </div>
                            
                            <div className="bg-gray-50 p-4 rounded space-y-2">
                              <div className="flex justify-between">
                                <span>Ð“Ñ€ÑƒÐ·:</span>
                                <span className="font-medium">{receivedCargo?.cargo_number}</span>
                              </div>
                              <div className="flex justify-between">
                                <span>ÐÐ¾Ð²Ð°Ñ ÑÑ‡ÐµÐ¹ÐºÐ°:</span>
                                <span className="font-medium">{newCell?.cell_code}</span>
                              </div>
                              <div className="flex justify-between">
                                <span>ÐÐ¾Ð²Ñ‹Ð¹ ÑÐºÐ»Ð°Ð´:</span>
                                <span className="font-medium">{newCell?.warehouse_name}</span>
                              </div>
                            </div>

                            <div className="flex space-x-2">
                              <Button 
                                onClick={() => confirmMobileReceive()}
                                className="flex-1 bg-green-600 hover:bg-green-700"
                              >
                                <CheckCircle className="mr-2 h-4 w-4" />
                                ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚ÑŒ Ð¿Ñ€Ð¸Ñ‘Ð¼
                              </Button>
                              <Button 
                                onClick={() => resetMobileReceive()}
                                variant="outline"
                                className="flex-1"
                              >
                                <X className="mr-2 h-4 w-4" />
                                ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ
                              </Button>
                            </div>
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}

              {/* Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°Ð¼Ð¸ */}
              {activeSection === 'cargo-management' && (
                <div className="space-y-6">
                  {/* ÐŸÑ€Ð¸Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ð¹ Ð³Ñ€ÑƒÐ· */}
                  {activeTab === 'cargo-accept' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Plus className="mr-2 h-5 w-5" />
                          ÐŸÑ€Ð¸Ð½Ð¸Ð¼Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ð¹ Ð³Ñ€ÑƒÐ·
                        </CardTitle>
                        <CardDescription>
                          Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ñ„Ð¾Ñ€Ð¼Ñƒ Ð´Ð»Ñ Ð¿Ñ€Ð¸ÐµÐ¼Ð° Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð³Ñ€ÑƒÐ·Ð° Ð¾Ñ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
                        </CardDescription>
                        {isFilledFromProfile && profileSourceUser && (
                          <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                            <div className="flex items-center text-blue-800">
                              <User className="mr-2 h-4 w-4" />
                              <span className="text-sm font-medium">
                                Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹ Ð¸Ð· Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ: {profileSourceUser.full_name} ({profileSourceUser.user_number})
                              </span>
                            </div>
                            <p className="text-xs text-blue-600 mt-1">
                              Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸. Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð³Ñ€ÑƒÐ·Ñ‹.
                            </p>
                          </div>
                        )}
                      </CardHeader>
                      <CardContent>
                        <form onSubmit={handleAcceptCargo} className="space-y-4 max-w-2xl">
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                              <Label htmlFor="sender_full_name">Ð¤Ð˜Ðž Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ</Label>
                              <Input
                                id="sender_full_name"
                                value={operatorCargoForm.sender_full_name}
                                onChange={(e) => setOperatorCargoForm({...operatorCargoForm, sender_full_name: e.target.value})}
                                placeholder="Ð˜Ð²Ð°Ð½Ð¾Ð² Ð˜Ð²Ð°Ð½ Ð˜Ð²Ð°Ð½Ð¾Ð²Ð¸Ñ‡"
                                required
                              />
                            </div>
                            <div>
                              <Label htmlFor="sender_phone">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ</Label>
                              <Input
                                id="sender_phone"
                                type="tel"
                                value={operatorCargoForm.sender_phone}
                                onChange={(e) => setOperatorCargoForm({...operatorCargoForm, sender_phone: e.target.value})}
                                placeholder="+7XXXXXXXXXX"
                                required
                              />
                            </div>
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                              <Label htmlFor="recipient_full_name">Ð¤Ð˜Ðž Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</Label>
                              <Input
                                id="recipient_full_name"
                                value={operatorCargoForm.recipient_full_name}
                                onChange={(e) => setOperatorCargoForm({...operatorCargoForm, recipient_full_name: e.target.value})}
                                placeholder="ÐŸÐµÑ‚Ñ€Ð¾Ð² ÐŸÐµÑ‚Ñ€ ÐŸÐµÑ‚Ñ€Ð¾Ð²Ð¸Ñ‡"
                                required
                              />
                            </div>
                            <div>
                              <Label htmlFor="recipient_phone">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</Label>
                              <Input
                                id="recipient_phone"
                                type="tel"
                                value={operatorCargoForm.recipient_phone}
                                onChange={(e) => setOperatorCargoForm({...operatorCargoForm, recipient_phone: e.target.value})}
                                placeholder="+992XXXXXXXXX"
                                required
                              />
                            </div>
                          </div>

                          <div>
                            <Label htmlFor="recipient_address">ÐÐ´Ñ€ÐµÑ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°</Label>
                            <Input
                              id="recipient_address"
                              value={operatorCargoForm.recipient_address}
                              onChange={(e) => setOperatorCargoForm({...operatorCargoForm, recipient_address: e.target.value})}
                              placeholder="Ð”ÑƒÑˆÐ°Ð½Ð±Ðµ, ÑƒÐ». Ð ÑƒÐ´Ð°ÐºÐ¸, 10, ÐºÐ². 5"
                              required
                            />
                          </div>

                          {/* ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°Ñ‚ÐµÐ»ÑŒ Ð¼ÐµÐ¶Ð´Ñƒ Ñ€ÐµÐ¶Ð¸Ð¼Ð°Ð¼Ð¸ */}
                          <div className="mb-4 p-4 bg-gray-50 rounded-lg">
                            <Label className="flex items-center space-x-2 cursor-pointer">
                              <input
                                type="checkbox"
                                checked={operatorCargoForm.use_multi_cargo}
                                onChange={(e) => {
                                  setOperatorCargoForm({
                                    ...operatorCargoForm,
                                    use_multi_cargo: e.target.checked
                                  });
                                  if (!e.target.checked) {
                                    setTotalWeight(0);
                                    setTotalCost(0);
                                  }
                                }}
                                className="rounded"
                              />
                              <span className="text-sm font-medium">
                                ÐÐµÑÐºÐ¾Ð»ÑŒÐºÐ¾ Ð²Ð¸Ð´Ð¾Ð² Ð³Ñ€ÑƒÐ·Ð° (Ñ ÐºÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€Ð¾Ð¼)
                              </span>
                            </Label>
                          </div>

                          {!operatorCargoForm.use_multi_cargo ? (
                            // Ð¡Ñ‚Ð°Ñ€Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° Ð´Ð»Ñ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð³Ñ€ÑƒÐ·Ð°
                            <>
                              <div>
                                <Label htmlFor="cargo_name">ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°</Label>
                                <Input
                                  id="cargo_name"
                                  value={operatorCargoForm.cargo_name}
                                  onChange={(e) => setOperatorCargoForm({...operatorCargoForm, cargo_name: e.target.value})}
                                  placeholder="Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹, Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ Ð²ÐµÑ‰Ð¸, ÑÐ»ÐµÐºÑ‚Ñ€Ð¾Ð½Ð¸ÐºÐ°"
                                  required
                                />
                              </div>

                              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                  <Label htmlFor="weight">Ð’ÐµÑ Ð³Ñ€ÑƒÐ·Ð° (ÐºÐ³)</Label>
                                  <Input
                                    id="weight"
                                    type="number"
                                    step="0.1"
                                    value={operatorCargoForm.weight}
                                    onChange={(e) => setOperatorCargoForm({...operatorCargoForm, weight: e.target.value})}
                                    placeholder="10.5"
                                    required
                                  />
                                </div>
                                <div>
                                  <Label htmlFor="declared_value">Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ Ð³Ñ€ÑƒÐ·Ð° (Ñ€ÑƒÐ±.)</Label>
                                  <Input
                                    id="declared_value"
                                    type="number"
                                    step="0.01"
                                    value={operatorCargoForm.declared_value}
                                    onChange={(e) => setOperatorCargoForm({...operatorCargoForm, declared_value: e.target.value})}
                                    placeholder="5000"
                                    required
                                  />
                                </div>
                              </div>
                            </>
                          ) : (
                            // ÐÐ¾Ð²Ð°Ñ Ñ„Ð¾Ñ€Ð¼Ð° Ñ Ð¼Ð½Ð¾Ð¶ÐµÑÑ‚Ð²ÐµÐ½Ð½Ñ‹Ð¼Ð¸ Ð³Ñ€ÑƒÐ·Ð°Ð¼Ð¸ Ð¸ ÐºÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€Ð¾Ð¼
                            <>
                              <div className="bg-blue-50 p-4 rounded-lg">
                                <h3 className="font-semibold text-lg mb-3 flex items-center">
                                  <Package className="mr-2 h-5 w-5" />
                                  Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð³Ñ€ÑƒÐ·Ð¾Ð²
                                </h3>
                                
                                {operatorCargoForm.cargo_items.map((item, index) => (
                                  <div key={`cargo-item-${index}`} className="mb-4 p-4 bg-white rounded border">
                                    <div className="flex items-center justify-between mb-2">
                                      <span className="font-medium text-sm text-gray-600">
                                        Ð“Ñ€ÑƒÐ· #{index + 1}
                                      </span>
                                      {operatorCargoForm.cargo_items.length > 1 && (
                                        <Button
                                          type="button"
                                          variant="outline"
                                          size="sm"
                                          onClick={() => removeCargoItem(index)}
                                        >
                                          <X className="h-4 w-4" />
                                        </Button>
                                      )}
                                    </div>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                                      <div>
                                        <Label>ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°</Label>
                                        <Input
                                          key={`cargo-name-${index}`}
                                          value={item.cargo_name || ''}
                                          onChange={(e) => {
                                            const newItems = [...operatorCargoForm.cargo_items];
                                            newItems[index] = { ...newItems[index], cargo_name: e.target.value };
                                            setOperatorCargoForm(prev => ({
                                              ...prev,
                                              cargo_items: newItems
                                            }));
                                          }}
                                          placeholder="Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹, Ð¾Ð´ÐµÐ¶Ð´Ð°, ÑÐ»ÐµÐºÑ‚Ñ€Ð¾Ð½Ð¸ÐºÐ°"
                                          required
                                        />
                                      </div>
                                      <div>
                                        <Label>Ð’ÐµÑ (ÐºÐ³)</Label>
                                        <Input
                                          type="number"
                                          step="0.1"
                                          min="0"
                                          value={item.weight}
                                          onChange={(e) => updateCargoItem(index, 'weight', e.target.value)}
                                          placeholder="10.5"
                                          required
                                        />
                                      </div>
                                      <div>
                                        <Label>Ð¦ÐµÐ½Ð° Ð·Ð° ÐºÐ³ (Ñ€ÑƒÐ±.)</Label>
                                        <Input
                                          type="number"
                                          step="0.01"
                                          min="0"
                                          value={item.price_per_kg}
                                          onChange={(e) => updateCargoItem(index, 'price_per_kg', e.target.value)}
                                          placeholder="100"
                                          required
                                        />
                                      </div>
                                    </div>
                                    
                                    {/* ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ Ð¿Ñ€Ð¾Ð¼ÐµÐ¶ÑƒÑ‚Ð¾Ñ‡Ð½Ñ‹Ð¹ Ñ€Ð°ÑÑ‡ÐµÑ‚ Ð´Ð»Ñ ÐºÐ°Ð¶Ð´Ð¾Ð³Ð¾ Ð³Ñ€ÑƒÐ·Ð° */}
                                    {item.weight && item.price_per_kg && (
                                      <div className="mt-2 p-2 bg-gray-50 rounded text-sm">
                                        <span className="text-gray-600">
                                          Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ: {parseFloat(item.weight)} ÐºÐ³ Ã— {parseFloat(item.price_per_kg)} Ñ€ÑƒÐ±/ÐºÐ³ = 
                                          <span className="font-semibold text-green-600 ml-1">
                                            {(parseFloat(item.weight) * parseFloat(item.price_per_kg)).toFixed(2)} Ñ€ÑƒÐ±
                                          </span>
                                        </span>
                                      </div>
                                    )}
                                  </div>
                                ))}
                                
                                <Button
                                  type="button"
                                  variant="outline"
                                  onClick={addCargoItem}
                                  className="w-full"
                                >
                                  <Plus className="mr-2 h-4 w-4" />
                                  Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐµÑ‰Ðµ Ð³Ñ€ÑƒÐ·
                                </Button>
                              </div>

                              {/* ÐšÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸ Ñ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ñ€Ð°Ð·Ð±Ð¸Ð²ÐºÐ¾Ð¹ */}
                              <div className="bg-green-50 p-4 rounded-lg">
                                <h3 className="font-semibold text-lg mb-3 flex items-center">
                                  <Calculator className="mr-2 h-5 w-5" />
                                  ÐšÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸
                                </h3>
                                
                                {/* Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ñ€Ð°Ð·Ð±Ð¸Ð²ÐºÐ° Ð¿Ð¾ ÐºÐ°Ð¶Ð´Ð¾Ð¼Ñƒ Ð³Ñ€ÑƒÐ·Ñƒ */}
                                {cargoBreakdown.length > 0 && (
                                  <div className="mb-4">
                                    <h4 className="font-medium text-sm text-gray-700 mb-2">Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ñ€Ð°Ð·Ð±Ð¸Ð²ÐºÐ°:</h4>
                                    <div className="space-y-2">
                                      {cargoBreakdown.map((item, index) => (
                                        <div key={`breakdown-${index}-${item.name}`} className="bg-white p-3 rounded border-l-4 border-blue-400">
                                          <div className="flex justify-between items-center">
                                            <span className="text-sm font-medium text-gray-700">
                                              Ð“Ñ€ÑƒÐ· #{item.index}: {item.name}
                                            </span>
                                            <span className="text-sm font-bold text-green-600">
                                              {item.cost.toFixed(2)} Ñ€ÑƒÐ±
                                            </span>
                                          </div>
                                          <div className="text-xs text-gray-500 mt-1">
                                            {item.weight.toFixed(1)} ÐºÐ³ Ã— {item.pricePerKg.toFixed(2)} Ñ€ÑƒÐ±/ÐºÐ³
                                          </div>
                                        </div>
                                      ))}
                                    </div>
                                  </div>
                                )}

                                {/* ÐžÐ±Ñ‰Ð¸Ðµ Ð¸Ñ‚Ð¾Ð³Ð¸ */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                  <div className="bg-white p-3 rounded border">
                                    <div className="text-sm text-gray-600">ÐžÐ±Ñ‰Ð¸Ð¹ Ð²ÐµÑ</div>
                                    <div className="text-2xl font-bold text-blue-600">
                                      {totalWeight.toFixed(1)} ÐºÐ³
                                    </div>
                                  </div>
                                  <div className="bg-white p-3 rounded border">
                                    <div className="text-sm text-gray-600">ÐžÐ±Ñ‰Ð°Ñ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ</div>
                                    <div className="text-2xl font-bold text-green-600">
                                      {totalCost.toFixed(2)} Ñ€ÑƒÐ±
                                    </div>
                                  </div>
                                </div>

                                {/* Ð¡Ð²Ð¾Ð´ÐºÐ° Ñ€Ð°ÑÑ‡ÐµÑ‚Ð¾Ð² */}
                                {cargoBreakdown.length > 1 && (
                                  <div className="mt-3 p-2 bg-white rounded text-sm border-t-2 border-green-400">
                                    <div className="font-medium text-gray-700 mb-1">Ð˜Ð¢ÐžÐ“Ðž:</div>
                                    {cargoBreakdown.map((item, index) => (
                                      <div key={`cost-${index}-${item.name}`} className="flex justify-between text-xs text-gray-600">
                                        <span>{item.name}: {item.weight.toFixed(1)}ÐºÐ³ Ã— {item.pricePerKg.toFixed(2)}Ñ€ÑƒÐ±</span>
                                        <span>{item.cost.toFixed(2)}Ñ€ÑƒÐ±</span>
                                      </div>
                                    ))}
                                    <div className="flex justify-between font-bold text-sm text-green-700 mt-1 pt-1 border-t">
                                      <span>Ð’ÑÐµÐ³Ð¾: {totalWeight.toFixed(1)} ÐºÐ³</span>
                                      <span>{totalCost.toFixed(2)} Ñ€ÑƒÐ±</span>
                                    </div>
                                  </div>
                                )}
                              </div>
                            </>
                          )}

                          <div>
                            <Label htmlFor="route">ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚</Label>
                            <Select 
                              key="old-route-select"
                              value={operatorCargoForm.route} 
                              onValueChange={(value) => {
                                setOperatorCargoForm(prev => ({
                                  ...prev, 
                                  route: value
                                }));
                              }}
                            >
                              <SelectTrigger key="old-route-trigger">
                                <SelectValue placeholder="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚" />
                              </SelectTrigger>
                              <SelectContent key="old-route-content">
                                <SelectItem key="old-moscow-to-tajikistan" value="moscow_to_tajikistan">ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½</SelectItem>
                                <SelectItem key="old-tajikistan-to-moscow" value="tajikistan_to_moscow">Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½ â†’ ÐœÐ¾ÑÐºÐ²Ð°</SelectItem>
                              </SelectContent>
                            </Select>
                          </div>

                          <div>
                            <Label htmlFor="description">ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°</Label>
                            <Textarea
                              id="description"
                              value={operatorCargoForm.description}
                              onChange={(e) => setOperatorCargoForm({...operatorCargoForm, description: e.target.value})}
                              placeholder="Ð›Ð¸Ñ‡Ð½Ñ‹Ðµ Ð²ÐµÑ‰Ð¸, Ð´Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹, Ð¿Ð¾Ð´Ð°Ñ€ÐºÐ¸..."
                              required
                            />
                          </div>

                          {/* ÐÐžÐ’Ð«Ð• ÐŸÐžÐ›Ð¯ Ð”Ð›Ð¯ Ð£Ð›Ð£Ð§Ð¨Ð•ÐÐÐžÐ™ Ð¡Ð˜Ð¡Ð¢Ð•ÐœÐ« */}
                          
                          {/* Ð’Ñ‹Ð±Ð¾Ñ€ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚Ð° */}
                          <div>
                            <Label htmlFor="route">ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸</Label>
                            <Select 
                              key="route-select"
                              value={operatorCargoForm.route} 
                              onValueChange={(value) => {
                                setOperatorCargoForm(prev => ({
                                  ...prev, 
                                  route: value, 
                                  warehouse_id: ''
                                }));
                                fetchWarehousesByRoute(value);
                              }}
                            >
                              <SelectTrigger key="route-trigger">
                                <SelectValue placeholder="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚" />
                              </SelectTrigger>
                              <SelectContent key="route-content">
                                <SelectItem key="route-moscow-to-tajikistan" value="moscow_to_tajikistan">ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½</SelectItem>
                                <SelectItem key="route-tajikistan-to-moscow" value="tajikistan_to_moscow">Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½ â†’ ÐœÐ¾ÑÐºÐ²Ð°</SelectItem>
                              </SelectContent>
                            </Select>
                          </div>

                          {/* Ð’Ñ‹Ð±Ð¾Ñ€ ÑÐºÐ»Ð°Ð´Ð° */}
                          <div>
                            <Label htmlFor="warehouse_id">Ð¡ÐºÐ»Ð°Ð´ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ</Label>
                            <Select 
                              key="warehouse-select"
                              value={operatorCargoForm.warehouse_id} 
                              onValueChange={(value) => {
                                setOperatorCargoForm(prev => ({
                                  ...prev, 
                                  warehouse_id: value
                                }));
                              }}
                            >
                              <SelectTrigger key="warehouse-trigger">
                                <SelectValue placeholder={
                                  !operatorCargoForm.route 
                                    ? "Ð¡Ð½Ð°Ñ‡Ð°Ð»Ð° Ð²Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚" 
                                    : routeWarehouses.length === 0 
                                      ? "Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÐºÐ»Ð°Ð´Ð¾Ð²..." 
                                      : "Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐºÐ»Ð°Ð´ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ"
                                } />
                              </SelectTrigger>
                              <SelectContent key="warehouse-content">
                                {routeWarehouses.map((warehouse) => (
                                  <SelectItem key={`warehouse-${warehouse.id}`} value={warehouse.id}>
                                    {warehouse.name} - {warehouse.location}
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                            {operatorCargoForm.route && (
                              <p className="text-xs text-gray-500 mt-1">
                                {operatorCargoForm.route === 'moscow_to_tajikistan' 
                                  ? 'Ð¡ÐºÐ»Ð°Ð´Ñ‹ Ð² Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½Ðµ Ð´Ð»Ñ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ Ð¸Ð· ÐœÐ¾ÑÐºÐ²Ñ‹' 
                                  : 'Ð¡ÐºÐ»Ð°Ð´Ñ‹ Ð² ÐœÐ¾ÑÐºÐ²Ðµ Ð´Ð»Ñ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ Ð¸Ð· Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½Ð°'}
                              </p>
                            )}
                          </div>

                          {/* Ð¡Ð¿Ð¾ÑÐ¾Ð± Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ */}
                          <div>
                            <Label htmlFor="payment_method">Ð¡Ð¿Ð¾ÑÐ¾Ð± Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹</Label>
                            <Select 
                              key="payment-method-select"
                              value={operatorCargoForm.payment_method} 
                              onValueChange={(value) => {
                                const newForm = { ...operatorCargoForm };
                                newForm.payment_method = value;
                                
                                // Ð¡Ð±Ñ€Ð¾Ñ Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ñ‹Ñ… Ð¿Ð¾Ð»ÐµÐ¹
                                if (value !== 'cash' && value !== 'card_transfer') {
                                  newForm.payment_amount = '';
                                }
                                if (value !== 'credit') {
                                  newForm.debt_due_date = '';
                                }
                                
                                setOperatorCargoForm(newForm);
                              }}
                            >
                              <SelectTrigger key="payment-method-trigger">
                                <SelectValue placeholder="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐ¿Ð¾ÑÐ¾Ð± Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹" />
                              </SelectTrigger>
                              <SelectContent key="payment-method-content">
                                <SelectItem key="payment-not_paid" value="not_paid">ÐÐµ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð¾</SelectItem>
                                <SelectItem key="payment-cash" value="cash">ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð½Ð°Ð»Ð¸Ñ‡Ð½Ñ‹Ð¼Ð¸</SelectItem>
                                <SelectItem key="payment-card_transfer" value="card_transfer">ÐŸÐµÑ€ÐµÐ²Ð¾Ð´ Ð½Ð° ÐºÐ°Ñ€Ñ‚Ñƒ</SelectItem>
                                <SelectItem key="payment-cash_on_delivery" value="cash_on_delivery">ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸</SelectItem>
                                <SelectItem key="payment-credit" value="credit">ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð² Ð´Ð¾Ð»Ð³</SelectItem>
                              </SelectContent>
                            </Select>
                          </div>

                          {/* ÐŸÐ¾Ð»Ðµ ÑÑƒÐ¼Ð¼Ñ‹ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð½Ð°Ð»Ð¸Ñ‡Ð½Ñ‹Ñ… Ð¸ ÐºÐ°Ñ€Ñ‚Ñ‹) */}
                          {(operatorCargoForm.payment_method === 'cash' || operatorCargoForm.payment_method === 'card_transfer') && (
                            <div>
                              <Label htmlFor="payment_amount">Ð¡ÑƒÐ¼Ð¼Ð° Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ (ÑÐ¾Ð¼)</Label>
                              <Input
                                id="payment_amount"
                                type="number"
                                step="0.01"
                                value={operatorCargoForm.payment_amount}
                                onChange={(e) => setOperatorCargoForm({...operatorCargoForm, payment_amount: e.target.value})}
                                placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÑƒÐ¼Ð¼Ñƒ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹"
                                required={operatorCargoForm.payment_method === 'cash' || operatorCargoForm.payment_method === 'card_transfer'}
                              />
                            </div>
                          )}

                          {/* Ð”Ð°Ñ‚Ð° Ð¿Ð¾Ð³Ð°ÑˆÐµÐ½Ð¸Ñ Ð´Ð¾Ð»Ð³Ð° (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ Ð² Ð´Ð¾Ð»Ð³) */}
                          {operatorCargoForm.payment_method === 'credit' && (
                            <div>
                              <Label htmlFor="debt_due_date">Ð”Ð°Ñ‚Ð° Ð¿Ð¾Ð³Ð°ÑˆÐµÐ½Ð¸Ñ Ð´Ð¾Ð»Ð³Ð°</Label>
                              <Input
                                id="debt_due_date"
                                type="date"
                                value={operatorCargoForm.debt_due_date}
                                onChange={(e) => setOperatorCargoForm({...operatorCargoForm, debt_due_date: e.target.value})}
                                required
                                min={new Date().toISOString().split('T')[0]}
                              />
                            </div>
                          )}

                          {/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ */}
                          <div className="flex flex-col gap-4">
                            {/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð¿ÐµÑ‡Ð°Ñ‚Ð¸ */}
                            <div className="flex gap-2">
                              <Button 
                                type="button" 
                                variant="outline"
                                onClick={handlePrintCurrentInvoice}
                                disabled={!canPrintInvoice()}
                                className="flex-1"
                              >
                                <Printer className="mr-2 h-4 w-4" />
                                ÐŸÐµÑ‡Ð°Ñ‚ÑŒ Ð½Ð°ÐºÐ»Ð°Ð´Ð½Ð¾Ð¹
                              </Button>
                              <Button 
                                type="button" 
                                variant="outline"
                                onClick={handlePrintCurrentBarcode}
                                disabled={!canPrintInvoice()}
                                className="flex-1"
                              >
                                <QrCode className="mr-2 h-4 w-4" />
                                Ð¨Ñ‚Ñ€Ð¸Ñ…-ÐºÐ¾Ð´
                              </Button>
                            </div>
                            
                            {/* Ð“Ð»Ð°Ð²Ð½Ð°Ñ ÐºÐ½Ð¾Ð¿ÐºÐ° Ð¿Ñ€Ð¸ÐµÐ¼Ð° Ð³Ñ€ÑƒÐ·Ð° */}
                            <Button type="submit" className="w-full" size="lg">
                              <Plus className="mr-2 h-4 w-4" />
                              ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ Ð³Ñ€ÑƒÐ·
                            </Button>
                            
                            {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÑ‚Ð°Ñ‚ÑƒÑÐµ */}
                            <div className="text-sm text-gray-600 text-center bg-blue-50 p-3 rounded-lg">
                              <div className="flex items-center justify-center mb-2">
                                <Clock className="mr-2 h-4 w-4" />
                                <span className="font-medium">ÐŸÐ¾ÑÐ»Ðµ Ð¿Ñ€Ð¸ÐµÐ¼Ð° Ð³Ñ€ÑƒÐ· Ð¿Ð¾ÑÑ‚ÑƒÐ¿Ð°ÐµÑ‚ Ð²:</span>
                              </div>
                              <div className="text-blue-800 font-semibold">
                                ÐšÐ°ÑÑÐ° â†’ ÐÐµ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð¾
                              </div>
                              <div className="text-xs text-gray-500 mt-1">
                                ÐŸÐ¾ÑÐ»Ðµ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ Ð³Ñ€ÑƒÐ· Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÑÑ‚Ð¸Ñ‚ÑÑ Ð² "Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°"
                              </div>
                            </div>
                          </div>
                        </form>
                      </CardContent>
                    </Card>
                  )}

                  {/* Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð³Ñ€ÑƒÐ·Ð¾Ð² */}
                  {(activeTab === 'cargo-list' || !activeTab || activeTab === 'cargo-management') && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Package className="mr-2 h-5 w-5" />
                            Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð³Ñ€ÑƒÐ·Ð¾Ð²
                          </div>
                          <div className="flex space-x-2">
                            {user?.role === 'admin' && selectedCargo.length > 0 && (
                              <Button
                                onClick={() => handleBulkDeleteCargo(operatorCargo)}
                                variant="outline"
                                className="text-red-600 border-red-300 hover:bg-red-50"
                              >
                                <Trash2 className="mr-2 h-4 w-4" />
                                Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ ({selectedCargo.length})
                              </Button>
                            )}
                            <Button onClick={() => {setActiveTab('cargo-accept'); fetchOperatorCargo();}}>
                              <Plus className="mr-2 h-4 w-4" />
                              ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ Ð³Ñ€ÑƒÐ·
                            </Button>
                          </div>
                        </CardTitle>
                        
                        {/* Ð§ÐµÐºÐ±Ð¾ÐºÑ "Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð²ÑÐµ" Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð° */}
                        {user?.role === 'admin' && operatorCargo.length > 0 && (
                          <div className="flex items-center space-x-2 mt-4 p-3 bg-gray-50 rounded-lg">
                            <input
                              type="checkbox"
                              checked={selectAllCargo}
                              onChange={(e) => handleSelectAllCargo(e.target.checked, operatorCargo)}
                              className="rounded border-gray-300"
                            />
                            <label className="text-sm font-medium text-gray-700">
                              Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð²ÑÐµ ({operatorCargo.length})
                            </label>
                          </div>
                        )}
                        
                        {/* Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ */}
                        <div className="flex items-center space-x-4 mt-4">
                          <div className="flex items-center space-x-2">
                            <span className="text-sm font-medium">Ð¤Ð¸Ð»ÑŒÑ‚Ñ€:</span>
                            <select 
                              value={operatorCargoFilter}
                              onChange={(e) => {
                                setOperatorCargoFilter(e.target.value);
                                setOperatorCargoPage(1); // Ð¡Ð±Ñ€Ð°ÑÑ‹Ð²Ð°ÐµÐ¼ Ð½Ð° Ð¿ÐµÑ€Ð²ÑƒÑŽ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ Ð¿Ñ€Ð¸ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ð¸ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°
                                fetchOperatorCargo(e.target.value, 1, operatorCargoPerPage);
                              }}
                              className="border border-gray-300 rounded-md px-3 py-1 text-sm"
                            >
                              <option value="">Ð’ÑÐµ Ð³Ñ€ÑƒÐ·Ñ‹</option>
                              <option value="new_request">ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð°ÑÐ²ÐºÐ¸</option>
                              <option value="awaiting_payment">ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ÑÑ Ð¾Ð¿Ð»Ð°Ñ‚Ð°</option>
                              <option value="awaiting_placement">ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ</option>
                            </select>
                          </div>
                          <Button 
                            variant="outline" 
                            size="sm"
                            onClick={() => fetchOperatorCargo(operatorCargoFilter, operatorCargoPage, operatorCargoPerPage)}
                          >
                            <RefreshCw className="mr-2 h-4 w-4" />
                            ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ
                          </Button>
                        </div>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {operatorCargo.length === 0 ? (
                            <div className="text-center py-8">
                              <Package className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500 mb-4">
                                {operatorCargoFilter 
                                  ? `ÐÐµÑ‚ Ð³Ñ€ÑƒÐ·Ð¾Ð² Ñ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð¾Ð¼ "${operatorCargoFilter === 'new_request' ? 'ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð°ÑÐ²ÐºÐ¸' : operatorCargoFilter === 'awaiting_payment' ? 'ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ÑÑ Ð¾Ð¿Ð»Ð°Ñ‚Ð°' : 'ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ'}"` 
                                  : 'ÐÐµÑ‚ Ð¿Ñ€Ð¸Ð½ÑÑ‚Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð²'
                                }
                              </p>
                              <Button onClick={() => setActiveTab('cargo-accept')}>
                                <Plus className="mr-2 h-4 w-4" />
                                ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ Ð³Ñ€ÑƒÐ·
                              </Button>
                            </div>
                          ) : (
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  {user?.role === 'admin' && (
                                    <TableHead className="w-12">
                                      <input
                                        type="checkbox"
                                        checked={selectAllCargo}
                                        onChange={(e) => handleSelectAllCargo(e.target.checked, operatorCargo)}
                                        className="rounded border-gray-300"
                                      />
                                    </TableHead>
                                  )}
                                  <TableHead>ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°</TableHead>
                                  <TableHead>ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ</TableHead>
                                  <TableHead>ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ</TableHead>
                                  <TableHead>Ð’ÐµÑ</TableHead>
                                  <TableHead>Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ</TableHead>
                                  <TableHead>Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸</TableHead>
                                  <TableHead>Ð Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ</TableHead>
                                  <TableHead>Ð”Ð°Ñ‚Ð° Ð¿Ñ€Ð¸ÐµÐ¼Ð°</TableHead>
                                  <TableHead>Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {operatorCargo.map((item) => (
                                  <TableRow key={item.id}>
                                    {user?.role === 'admin' && (
                                      <TableCell>
                                        <input
                                          type="checkbox"
                                          checked={selectedCargo.includes(item.id)}
                                          onChange={(e) => handleCargoSelect(item.id, e.target.checked)}
                                          className="rounded border-gray-300"
                                        />
                                      </TableCell>
                                    )}
                                    <TableCell className="font-medium">{item.cargo_number}</TableCell>
                                    <TableCell>
                                      <div>
                                        <div className="font-medium flex items-center justify-between">
                                          <span>{item.sender_full_name}</span>
                                          {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ QR Ð´Ð»Ñ Ð²ÑÐµÑ… Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ */}
                                          {(user?.role === 'admin' || user?.role === 'warehouse_operator') && (
                                            <Button
                                              size="sm"
                                              variant="ghost"
                                              onClick={() => generateBulkQRForSender({
                                                sender_full_name: item.sender_full_name,
                                                sender_phone: item.sender_phone
                                              })}
                                              className="ml-2 text-blue-600 hover:bg-blue-50 p-1 h-auto"
                                              title="Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ QR ÐºÐ¾Ð´Ñ‹ Ð´Ð»Ñ Ð²ÑÐµÑ… Ð³Ñ€ÑƒÐ·Ð¾Ð² ÑÑ‚Ð¾Ð³Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ"
                                            >
                                              <QrCode className="h-3 w-3" />
                                            </Button>
                                          )}
                                        </div>
                                        <div className="text-sm text-gray-500">{item.sender_phone}</div>
                                      </div>
                                    </TableCell>
                                    <TableCell>
                                      <div>
                                        <div className="font-medium">{item.recipient_full_name}</div>
                                        <div className="text-sm text-gray-500">{item.recipient_phone}</div>
                                        <div className="text-sm text-gray-500">{item.recipient_address}</div>
                                      </div>
                                    </TableCell>
                                    <TableCell>{item.weight} ÐºÐ³</TableCell>
                                    <TableCell>{item.declared_value} â‚½</TableCell>
                                    <TableCell>
                                      <div className="flex flex-col space-y-1">
                                        <Badge variant={getProcessingStatusBadgeVariant(item.processing_status || 'payment_pending')}>
                                          {getProcessingStatusLabel(item.processing_status || 'payment_pending')}
                                        </Badge>
                                        {/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð´Ð»Ñ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ ÑÑ‚Ð°Ñ‚ÑƒÑÐ° */}
                                        <div className="flex space-x-1">
                                          {item.processing_status === 'payment_pending' && (
                                            <Button
                                              size="sm"
                                              onClick={() => handlePaymentAcceptance(item.id, item.cargo_number)}
                                              className="text-xs px-3 py-1 bg-green-600 hover:bg-green-700 text-white font-medium"
                                            >
                                              ðŸ’° ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½
                                            </Button>
                                          )}
                                          {item.processing_status === 'paid' && (
                                            <Button
                                              size="sm"
                                              variant="outline"
                                              onClick={() => updateCargoProcessingStatus(item.id, 'invoice_printed')}
                                              className="text-xs px-2 py-1"
                                            >
                                              ðŸ“„ ÐÐ°ÐºÐ»Ð°Ð´Ð½Ð°Ñ
                                            </Button>
                                          )}
                                          {item.processing_status === 'invoice_printed' && (
                                            <Button
                                              size="sm"
                                              variant="outline"
                                              onClick={() => updateCargoProcessingStatus(item.id, 'placed')}
                                              className="text-xs px-2 py-1"
                                            >
                                              ðŸ“¦ Ð Ð°Ð·Ð¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ
                                            </Button>
                                          )}
                                        </div>
                                      </div>
                                    </TableCell>
                                    <TableCell>
                                      {item.warehouse_location ? (
                                        <div className="text-sm">
                                          <div className="font-medium">{warehouses.find(w => w.id === item.warehouse_id)?.name || 'Ð¡ÐºÐ»Ð°Ð´'}</div>
                                          <div className="text-blue-600">{item.warehouse_location}</div>
                                        </div>
                                      ) : (
                                        <Badge variant="outline">ÐÐµ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½</Badge>
                                      )}
                                    </TableCell>
                                    <TableCell>
                                      {new Date(item.created_at).toLocaleDateString('ru-RU')} {new Date(item.created_at).toLocaleTimeString('ru-RU')}
                                    </TableCell>
                                    <TableCell>
                                      <div className="flex flex-col space-y-1">
                                        <Button
                                          size="sm"
                                          variant="outline"
                                          onClick={() => printCargoInvoice(item)}
                                          className="flex items-center"
                                          disabled={!item.processing_status || item.processing_status === 'payment_pending'}
                                        >
                                          <Printer className="mr-1 h-4 w-4" />
                                          ÐÐ°ÐºÐ»Ð°Ð´Ð½Ð°Ñ
                                        </Button>
                                        {/* QR ÐºÐ¾Ð´ Ð´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð²ÑÐµÐ³Ð´Ð° */}
                                        <Button
                                          size="sm"
                                          variant="outline"
                                          onClick={() => {
                                            setQrGenerateCargoNumber(item.cargo_number);
                                            setShowQRGenerateModal(true);
                                          }}
                                          className="flex items-center text-xs px-2 py-1 text-blue-600 border-blue-300 hover:bg-blue-50"
                                        >
                                          <QrCode className="mr-1 h-3 w-3" />
                                          QR ÐºÐ¾Ð´
                                        </Button>
                                        
                                        {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð´Ð»Ñ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð² */}
                                        {(item.processing_status === 'paid' || item.processing_status === 'invoice_printed') && !item.warehouse_location && (
                                          <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => {
                                              setSelectedCargoForDetailView(item);
                                              setQuickPlacementModal(true);
                                            }}
                                            className="flex items-center text-xs px-2 py-1 bg-green-50 hover:bg-green-100"
                                          >
                                            <Grid3X3 className="mr-1 h-3 w-3" />
                                            Ð Ð°Ð·Ð¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ
                                          </Button>
                                        )}
                                        
                                        {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð° Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¾Ð² Ð¸ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² */}
                                        {(user.role === 'admin' || user.role === 'warehouse_operator') && (
                                          <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => openAdminRepeatOrder(item)}
                                            className="flex items-center text-xs px-2 py-1 bg-blue-50 hover:bg-blue-100 text-blue-600 hover:text-blue-700"
                                            title="ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð· Ñ Ñ‚ÐµÐ¼Ð¸ Ð¶Ðµ Ð´Ð°Ð½Ð½Ñ‹Ð¼Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ"
                                          >
                                            <Copy className="mr-1 h-3 w-3" />
                                            ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ
                                          </Button>
                                        )}

                                        {/* ÐšÐ½Ð¾Ð¿ÐºÐ° ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð° (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°) */}
                                        {user?.role === 'admin' && (
                                          <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => handleDeleteCargo(item.id, operatorCargo)}
                                            className="flex items-center text-xs px-2 py-1 text-red-600 border-red-300 hover:bg-red-50"
                                            title="Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·"
                                          >
                                            <Trash2 className="mr-1 h-3 w-3" />
                                            Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ
                                          </Button>
                                        )}
                                      </div>
                                    </TableCell>
                                  </TableRow>
                                ))}
                              </TableBody>
                            </Table>
                          )}
                        </div>
                        
                        {/* ÐŸÐ°Ð³Ð¸Ð½Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ ÑÐ¿Ð¸ÑÐºÐ° Ð³Ñ€ÑƒÐ·Ð¾Ð² */}
                        {operatorCargo.length > 0 && operatorCargoPagination && (
                          <DataPagination
                            pagination={operatorCargoPagination}
                            onPageChange={handleOperatorCargoPageChange}
                            onPerPageChange={handleOperatorCargoPerPageChange}
                          />
                        )}
                      </CardContent>
                    </Card>
                  )}

                  {/* Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° - Ð£Ð»ÑƒÑ‡ÑˆÐµÐ½Ð½Ñ‹Ð¹ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ ÑÐ¾ ÑÐºÐ°Ð½ÐµÑ€Ð¾Ð¼ */}
                  {activeTab === 'cargo-placement' && (
                    <div className="space-y-6">
                      {/* Ð˜Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ */}
                      {(scannerActive || scannedCargoData || placementInProgress) && (
                        <Card className="border-2 border-blue-500 bg-blue-50">
                          <CardHeader>
                            <CardTitle className="flex items-center justify-between">
                              <div className="flex items-center">
                                <Camera className="mr-2 h-5 w-5 text-blue-600" />
                                {scannerMode === 'cargo-barcode' ? 'Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑˆÑ‚Ñ€Ð¸Ñ…-ÐºÐ¾Ð´Ð° Ð³Ñ€ÑƒÐ·Ð°' :
                                 scannerMode === 'cell-qr' ? 'Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ QR-ÐºÐ¾Ð´Ð° ÑÑ‡ÐµÐ¹ÐºÐ¸' :
                                 placementInProgress ? 'Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°...' : 'Ð“Ð¾Ñ‚Ð¾Ð²Ð¾ Ðº ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸ÑŽ'}
                              </div>
                              {(scannerActive || scannedCargoData) && (
                                <Button 
                                  variant="outline" 
                                  size="sm"
                                  onClick={resetScannerState}
                                  className="text-red-600 hover:text-red-700"
                                >
                                  <X className="h-4 w-4" />
                                  ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ
                                </Button>
                              )}
                            </CardTitle>
                            <CardDescription>
                              {scannerMode === 'cargo-barcode' && 'ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° ÑˆÑ‚Ñ€Ð¸Ñ…-ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð° Ð´Ð»Ñ ÐµÐ³Ð¾ Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸'}
                              {scannerMode === 'cell-qr' && 'ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° QR-ÐºÐ¾Ð´ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾Ð¹ ÑÑ‡ÐµÐ¹ÐºÐ¸ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ'}
                              {placementInProgress && 'Ð’Ñ‹Ð¿Ð¾Ð»Ð½ÑÐµÑ‚ÑÑ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° Ð² Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½ÑƒÑŽ ÑÑ‡ÐµÐ¹ÐºÑƒ...'}
                              {scannerMode === 'none' && scannedCargoData && !placementInProgress && 'Ð“Ñ€ÑƒÐ· Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½, Ð¾Ð¶Ð¸Ð´Ð°ÐµÑ‚ÑÑ Ð²Ñ‹Ð±Ð¾Ñ€ ÑÑ‡ÐµÐ¹ÐºÐ¸'}
                            </CardDescription>
                          </CardHeader>
                          <CardContent>
                            {/* Ð˜Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ ÐºÐ°Ð¼ÐµÑ€Ñ‹ */}
                            {scannerActive && (
                              <div className="mb-6">
                                <div className="bg-black rounded-lg overflow-hidden" style={{maxWidth: '500px', margin: '0 auto'}}>
                                  <div 
                                    id="qr-reader" 
                                    className="w-full"
                                    style={{
                                      width: '100%',
                                      maxWidth: '500px',
                                      minHeight: '300px'
                                    }}
                                  />
                                </div>
                                <div className="text-center mt-4 space-y-2">
                                  <p className="text-sm text-gray-600">
                                    {scannerMode === 'cargo-barcode' ? 
                                      'ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° ÑˆÑ‚Ñ€Ð¸Ñ…-ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð°' : 
                                      'ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° QR-ÐºÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸'}
                                  </p>
                                  {cameraPermission === false && (
                                    <p className="text-sm text-red-600">
                                      Ð”Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ ÑÐºÐ°Ð½ÐµÑ€Ð° Ð½ÐµÐ¾Ð±Ñ…Ð¾Ð´Ð¸Ð¼Ð¾ Ñ€Ð°Ð·Ñ€ÐµÑˆÐµÐ½Ð¸Ðµ Ð½Ð° Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ð½Ð¸Ðµ ÐºÐ°Ð¼ÐµÑ€Ñ‹
                                    </p>
                                  )}
                                </div>
                              </div>
                            )}

                            {/* Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ */}
                            <div className="space-y-4">
                              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                                {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¾Ñ‚ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð¾Ð¼ Ð³Ñ€ÑƒÐ·Ðµ */}
                                {scannedCargoData && (
                                  <div className="p-4 bg-green-50 border border-green-200 rounded-lg">
                                    <h4 className="font-medium text-green-800 mb-2 flex items-center">
                                      <CheckCircle className="mr-2 h-4 w-4" />
                                      Ð“Ñ€ÑƒÐ· Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸Ñ†Ð¸Ñ€Ð¾Ð²Ð°Ð½
                                    </h4>
                                    <p><strong>ÐÐ¾Ð¼ÐµÑ€:</strong> {scannedCargoData.cargo_number}</p>
                                    <p><strong>ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ:</strong> {scannedCargoData.description || scannedCargoData.cargo_name}</p>
                                    <p><strong>Ð’ÐµÑ:</strong> {scannedCargoData.weight} ÐºÐ³</p>
                                    <p><strong>ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ:</strong> {scannedCargoData.sender_full_name}</p>
                                  </div>
                                )}
                                
                                {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¹ ÑÑ‡ÐµÐ¹ÐºÐµ */}
                                {scannedCellData && (
                                  <div className="p-4 bg-blue-50 border border-blue-200 rounded-lg">
                                    <h4 className="font-medium text-blue-800 mb-2 flex items-center">
                                      <Grid3X3 className="mr-2 h-4 w-4" />
                                      Ð¯Ñ‡ÐµÐ¹ÐºÐ° Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð°
                                    </h4>
                                    <p><strong>Ð¡ÐºÐ»Ð°Ð´:</strong> {scannedCellData.warehouse_id}</p>
                                    <p><strong>Ð‘Ð»Ð¾Ðº:</strong> {scannedCellData.block_number}</p>
                                    <p><strong>ÐŸÐ¾Ð»ÐºÐ°:</strong> {scannedCellData.shelf_number}</p>
                                    <p><strong>Ð¯Ñ‡ÐµÐ¹ÐºÐ°:</strong> {scannedCellData.cell_number}</p>
                                  </div>
                                )}
                              </div>
                              
                              {/* ÐžÑˆÐ¸Ð±ÐºÐ¸ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ */}
                              {scannerError && (
                                <div className="p-4 bg-red-50 border border-red-200 rounded-lg">
                                  <p className="text-red-800 flex items-center">
                                    <XCircle className="mr-2 h-4 w-4" />
                                    {scannerError}
                                  </p>
                                </div>
                              )}
                              
                              {/* ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ */}
                              {placementInProgress && (
                                <div className="p-4 bg-yellow-50 border border-yellow-200 rounded-lg">
                                  <p className="text-yellow-800 flex items-center">
                                    <RefreshCw className="mr-2 h-4 w-4 animate-spin" />
                                    Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° Ð² Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐµ...
                                  </p>
                                </div>
                              )}
                              
                              {/* Ð¢ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ (Ð´Ð»Ñ Ð¾Ñ‚Ð»Ð°Ð´ÐºÐ¸) */}
                              {process.env.NODE_ENV === 'development' && (
                                <div className="flex flex-wrap gap-2 p-3 bg-gray-100 rounded-lg border-2 border-dashed">
                                  <Button 
                                    size="sm" 
                                    variant="outline"
                                    onClick={() => simulateBarcodeScan('2501999271')}
                                  >
                                    Ð¢ÐµÑÑ‚ ÑˆÑ‚Ñ€Ð¸Ñ…-ÐºÐ¾Ð´Ð° Ð³Ñ€ÑƒÐ·Ð°
                                  </Button>
                                  <Button 
                                    size="sm" 
                                    variant="outline"
                                    onClick={() => simulateBarcodeScan('WH001:1:2:5')}
                                  >
                                    Ð¢ÐµÑÑ‚ QR-ÐºÐ¾Ð´Ð° ÑÑ‡ÐµÐ¹ÐºÐ¸
                                  </Button>
                                </div>
                              )}
                            </div>
                          </CardContent>
                        </Card>
                      )}

                      {/* ÐžÑÐ½Ð¾Ð²Ð½Ð¾Ð¹ Ð¸Ð½Ñ‚ÐµÑ€Ñ„ÐµÐ¹Ñ */}
                      <Card>
                        <CardHeader>
                          <CardTitle className="flex items-center justify-between">
                            <div className="flex items-center">
                              <Grid3X3 className="mr-2 h-5 w-5" />
                              Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°
                            </div>
                            <div className="flex space-x-2">
                              {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ QR ÐºÐ¾Ð´Ð° */}
                              <Button 
                                onClick={() => setShowQRGenerateModal(true)}
                                variant="outline"
                                size="sm"
                                className="text-blue-600 border-blue-300 hover:bg-blue-50"
                              >
                                <QrCode className="mr-2 h-4 w-4" />
                                Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ QR
                              </Button>
                              
                              {/* ÐšÐ½Ð¾Ð¿ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð° - Ð¾Ñ‚ÐºÑ€Ñ‹Ð²Ð°ÐµÑ‚ ÑÑ‚Ñ€Ð°Ð½Ð¸Ñ†Ñƒ */}
                              <Button 
                                onClick={openCargoPlacementPage}
                                className="bg-green-600 hover:bg-green-700"
                                size="sm"
                              >
                                <Package className="mr-2 h-4 w-4" />
                                Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°
                              </Button>
                            </div>
                          </CardTitle>
                          <CardDescription>
                            ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹, Ð³Ð¾Ñ‚Ð¾Ð²Ñ‹Ðµ Ðº Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸ÑŽ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ ÑÐºÐ°Ð½ÐµÑ€ Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ.
                          </CardDescription>
                        </CardHeader>
                        <CardContent>
                          <Button onClick={() => fetchAvailableCargoForPlacement(availableCargoPage, availableCargoPerPage)} className="mb-4">
                            <RefreshCw className="mr-2 h-4 w-4" />
                            ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº Ð³Ñ€ÑƒÐ·Ð¾Ð²
                          </Button>
                          
                          {/* Ð›ÐµÐ³ÐµÐ½Ð´Ð° Ñ†Ð²ÐµÑ‚Ð¾Ð² ÑÐºÐ»Ð°Ð´Ð¾Ð² */}
                          {availableCargoForPlacement.length > 0 && (
                            <div className="mb-6 p-4 bg-gray-50 rounded-lg border">
                              <h4 className="font-semibold text-sm text-gray-700 mb-3 flex items-center">
                                <Palette className="mr-2 h-4 w-4" />
                                Ð¦Ð²ÐµÑ‚Ð¾Ð²Ð°Ñ ÑÑ…ÐµÐ¼Ð° Ð¿Ð¾ ÑÐºÐ»Ð°Ð´Ð°Ð¼
                              </h4>
                              <div className="flex flex-wrap gap-3">
                                {getWarehouseLegend().map((item, index) => (
                                  <div key={index} className="flex items-center space-x-2">
                                    <div className={`w-4 h-4 ${item.color} rounded`}></div>
                                    <span className={`text-sm font-medium ${item.textColor}`}>
                                      {item.name}
                                    </span>
                                  </div>
                                ))}
                              </div>
                              <p className="text-xs text-gray-500 mt-2">
                                ÐšÐ°Ð¶Ð´Ñ‹Ð¹ Ð³Ñ€ÑƒÐ· Ð¾ÐºÑ€Ð°ÑˆÐµÐ½ Ð² Ñ†Ð²ÐµÑ‚ ÑÐ²Ð¾ÐµÐ³Ð¾ ÑÐºÐ»Ð°Ð´Ð° Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ð´Ð»Ñ ÑƒÐ´Ð¾Ð±ÑÑ‚Ð²Ð° Ð¸Ð´ÐµÐ½Ñ‚Ð¸Ñ„Ð¸ÐºÐ°Ñ†Ð¸Ð¸
                              </p>
                            </div>
                          )}
                          
                          <div className="space-y-4">
                            {availableCargoForPlacement.length === 0 ? (
                              <div className="text-center py-8">
                                <Package className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                                <p className="text-gray-500">ÐÐµÑ‚ Ð³Ñ€ÑƒÐ·Ð¾Ð², Ð¾Ð¶Ð¸Ð´Ð°ÑŽÑ‰Ð¸Ñ… Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ</p>
                                <p className="text-sm text-gray-400 mt-2">ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹ Ð¸Ð· "Ð¡Ð¿Ð¸ÑÐºÐ° Ð³Ñ€ÑƒÐ·Ð¾Ð²" Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð¿Ð¾ÑÐ²ÑÑ‚ÑÑ Ð·Ð´ÐµÑÑŒ</p>
                                <Button 
                                  variant="outline" 
                                  className="mt-4"
                                  onClick={() => setActiveTab('cargo-list')}
                                >
                                  ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ðº ÑÐ¿Ð¸ÑÐºÑƒ Ð³Ñ€ÑƒÐ·Ð¾Ð²
                                </Button>
                              </div>
                            ) : (
                              <div className="grid gap-6">
                                {availableCargoForPlacement.map((item) => {
                                  const warehouseColors = getWarehouseColor(item.warehouse_name);
                                  return (
                                    <Card key={item.id} className={`${warehouseColors.border} ${warehouseColors.bg} border-l-4`}>
                                      <CardContent className="p-6">
                                        <div className="flex justify-between items-start">
                                          {/* ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ */}
                                          <div className="flex-1">
                                            <div className="flex items-center space-x-4 mb-4">
                                              <h3 className="font-bold text-xl text-blue-600">{item.cargo_number}</h3>
                                              <Badge variant={getProcessingStatusBadgeVariant(item.processing_status)}>
                                                {getProcessingStatusLabel(item.processing_status)}
                                              </Badge>
                                              {/* Ð‘ÐµÐ¹Ð´Ð¶ Ñ Ð½Ð°Ð·Ð²Ð°Ð½Ð¸ÐµÐ¼ ÑÐºÐ»Ð°Ð´Ð° */}
                                              {item.warehouse_name && (
                                                <Badge className={`${warehouseColors.badge} ${warehouseColors.text} border-0`}>
                                                  ðŸ­ {item.warehouse_name}
                                                </Badge>
                                              )}
                                            </div>
                                          
                                          <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                            {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ */}
                                            <div className="space-y-2">
                                              <h4 className="font-semibold text-lg text-gray-700 mb-3">ðŸ“¦ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ</h4>
                                              <div className="space-y-1 text-sm">
                                                <p><strong>ÐÐ°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ:</strong> {item.cargo_name}</p>
                                                <p><strong>Ð’ÐµÑ:</strong> {item.weight} ÐºÐ³</p>
                                                <p><strong>Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ:</strong> {item.declared_value} â‚½</p>
                                                <p><strong>Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:</strong> {getProcessingStatusLabel(item.processing_status)}</p>
                                              </div>
                                            </div>
                                            
                                            {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ðµ */}
                                            <div className="space-y-2">
                                              <h4 className="font-semibold text-lg text-gray-700 mb-3">ðŸ‘¤ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ</h4>
                                              <div className="space-y-1 text-sm">
                                                <p><strong>Ð˜Ð¼Ñ:</strong> {item.sender_full_name}</p>
                                                <p><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:</strong> {item.sender_phone}</p>
                                                <p><strong>ÐŸÑ€Ð¸Ð½ÑÐ»:</strong> {item.accepting_operator}</p>
                                              </div>
                                            </div>
                                            
                                            {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ðµ */}
                                            <div className="space-y-2">
                                              <h4 className="font-semibold text-lg text-gray-700 mb-3">ðŸ“ ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ</h4>
                                              <div className="space-y-1 text-sm">
                                                <p><strong>Ð˜Ð¼Ñ:</strong> {item.recipient_name}</p>
                                                <p><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:</strong> {item.recipient_phone}</p>
                                                <p><strong>ÐÐ´Ñ€ÐµÑ:</strong> {item.recipient_address}</p>
                                              </div>
                                            </div>
                                            
                                            {/* Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ */}
                                            <div className="space-y-2">
                                              <h4 className="font-semibold text-lg text-gray-700 mb-3">â„¹ï¸ Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾</h4>
                                              <div className="space-y-1 text-sm">
                                                <p><strong>ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ:</strong> {item.description}</p>
                                                <p><strong>ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚:</strong> {item.route}</p>
                                                <p><strong>Ð¡Ð¾Ð·Ð´Ð°Ð½:</strong> {new Date(item.created_at).toLocaleDateString('ru-RU')}</p>
                                              </div>
                                            </div>
                                          </div>
                                        </div>
                                        
                                        {/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ */}
                                        <div className="ml-6 flex flex-col space-y-2">
                                          <Button
                                            onClick={() => {
                                              setSelectedCargoForDetailView(item);
                                              setCargoDetailsModal(true);
                                            }}
                                            variant="outline"
                                            className="flex items-center"
                                          >
                                            <Eye className="mr-2 h-4 w-4" />
                                            ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ
                                          </Button>
                                          
                                          <Button
                                            onClick={() => {
                                              setQrGenerateCargoNumber(item.cargo_number);
                                              setShowQRGenerateModal(true);
                                            }}
                                            variant="outline"
                                            className="flex items-center text-blue-600 border-blue-300 hover:bg-blue-50"
                                          >
                                            <QrCode className="mr-2 h-4 w-4" />
                                            QR ÐºÐ¾Ð´
                                          </Button>
                                          
                                          <Button
                                            onClick={() => openEnhancedPlacementModal(item)}
                                            className="bg-green-600 hover:bg-green-700 text-white flex items-center"
                                          >
                                            <Grid3X3 className="mr-2 h-4 w-4" />
                                            Ð Ð°Ð·Ð¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ
                                          </Button>
                                        </div>
                                      </div>
                                    </CardContent>
                                  </Card>
                                )})}
                              </div>
                            )}
                          </div>
                        </CardContent>
                        
                        {/* ÐŸÐ°Ð³Ð¸Ð½Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð¾Ð² */}
                        {availableCargoForPlacement.length > 0 && availableCargoPagination && (
                          <DataPagination
                            pagination={availableCargoPagination}
                            onPageChange={handleAvailableCargoPageChange}
                            onPerPageChange={handleAvailableCargoPerPageChange}
                          />
                        )}
                      </Card>
                    </div>
                  )}

                  {/* Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹ */}
                  {activeTab === 'warehouses-placed-cargo' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Package className="mr-2 h-5 w-5" />
                          Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹
                        </CardTitle>
                        <p className="text-sm text-gray-600">
                          Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð²ÑÐµÑ… Ð³Ñ€ÑƒÐ·Ð¾Ð², Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ñ… Ð½Ð° ÑÐºÐ»Ð°Ð´Ð°Ñ… Ñ ÑƒÐºÐ°Ð·Ð°Ð½Ð¸ÐµÐ¼ Ñ‚Ð¾Ñ‡Ð½Ð¾Ð³Ð¾ Ð¼ÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
                        </p>
                      </CardHeader>
                      <CardContent>
                        {placedCargoList.length === 0 ? (
                          <div className="text-center py-8">
                            <Package className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                            <p className="text-gray-500 mb-4">Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð¿Ð¾ÐºÐ° Ð½ÐµÑ‚</p>
                            <p className="text-sm text-gray-400">Ð“Ñ€ÑƒÐ·Ñ‹ Ð¿Ð¾ÑÐ²ÑÑ‚ÑÑ Ð·Ð´ÐµÑÑŒ Ð¿Ð¾ÑÐ»Ðµ Ð¸Ñ… Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð² ÑÑ‡ÐµÐ¹ÐºÐ¸ ÑÐºÐ»Ð°Ð´Ð¾Ð²</p>
                          </div>
                        ) : (
                          <div className="space-y-4">
                            {placedCargoList.map((item) => (
                              <Card key={item.id} className="border-l-4 border-l-green-500">
                                <CardContent className="p-6">
                                  <div className="flex justify-between items-start">
                                    {/* ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ */}
                                    <div className="flex-1">
                                      <div className="flex items-center space-x-4 mb-4">
                                        <h3 className="font-bold text-xl text-green-600">{item.cargo_number}</h3>
                                        <Badge variant="success">Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½</Badge>
                                        {item.placement_date && (
                                          <Badge variant="outline">
                                            <Calendar className="mr-1 h-3 w-3" />
                                            {new Date(item.placement_date).toLocaleDateString('ru-RU')}
                                          </Badge>
                                        )}
                                      </div>
                                      
                                      <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ */}
                                        <div className="space-y-2">
                                          <h4 className="font-semibold text-lg text-gray-700 mb-3">ðŸ“¦ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ</h4>
                                          <div className="space-y-1 text-sm">
                                            <p><strong>ÐÐ°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ:</strong> {item.cargo_name}</p>
                                            <p><strong>ÐžÐ±Ñ‰Ð¸Ð¹ Ð²ÐµÑ:</strong> {item.total_weight} ÐºÐ³</p>
                                            <p><strong>Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ:</strong> {item.total_cost} Ñ€ÑƒÐ±</p>
                                            <p><strong>ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ:</strong> {item.sender_name}</p>
                                            <p><strong>ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ:</strong> {item.receiver_name}</p>
                                          </div>
                                        </div>

                                        {/* ÐœÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ */}
                                        <div className="space-y-2">
                                          <h4 className="font-semibold text-lg text-gray-700 mb-3 flex items-center">
                                            <MapPin className="mr-2 h-4 w-4" />
                                            ÐœÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ
                                          </h4>
                                          <div className="space-y-1 text-sm bg-green-50 border border-green-200 rounded-lg p-3">
                                            <p><strong>Ð¡ÐºÐ»Ð°Ð´:</strong> {item.warehouse_name || item.warehouse_id}</p>
                                            <p><strong>Ð‘Ð»Ð¾Ðº:</strong> {item.block_number}</p>
                                            <p><strong>ÐŸÐ¾Ð»ÐºÐ°:</strong> {item.shelf_number}</p>
                                            <p><strong>Ð¯Ñ‡ÐµÐ¹ÐºÐ°:</strong> {item.cell_number}</p>
                                            <div className="mt-2 p-2 bg-green-100 rounded border">
                                              <p className="font-mono text-xs">
                                                <strong>ÐÐ´Ñ€ÐµÑ:</strong> {item.warehouse_name || item.warehouse_id}-{item.block_number}-{item.shelf_number}-{item.cell_number}
                                              </p>
                                            </div>
                                          </div>
                                        </div>

                                        {/* Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ */}
                                        <div className="space-y-2">
                                          <h4 className="font-semibold text-lg text-gray-700 mb-3">â„¹ï¸ Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð¾</h4>
                                          <div className="space-y-1 text-sm">
                                            <p><strong>Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:</strong> {getProcessingStatusLabel(item.processing_status)}</p>
                                            <p><strong>ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚:</strong> {item.route}</p>
                                            {item.placement_operator && (
                                              <p><strong>Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼:</strong> {item.placement_operator}</p>
                                            )}
                                            <p><strong>Ð¡Ð¾Ð·Ð´Ð°Ð½:</strong> {new Date(item.created_at).toLocaleDateString('ru-RU')}</p>
                                          </div>
                                        </div>
                                      </div>
                                    </div>
                                    
                                    {/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ */}
                                    <div className="ml-6 flex flex-col space-y-2">
                                      <Button
                                        onClick={() => {
                                          setSelectedCargoForDetailView(item);
                                          setCargoDetailsModal(true);
                                        }}
                                        variant="outline"
                                        className="flex items-center"
                                      >
                                        <Eye className="mr-2 h-4 w-4" />
                                        ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½ÐµÐµ
                                      </Button>
                                      
                                      <Button
                                        onClick={() => printInvoice(item)}
                                        variant="outline"
                                        className="flex items-center"
                                      >
                                        <Printer className="mr-2 h-4 w-4" />
                                        ÐŸÐµÑ‡Ð°Ñ‚ÑŒ
                                      </Button>
                                    </div>
                                  </div>
                                </CardContent>
                              </Card>
                            ))}
                          </div>
                        )}
                        
                        {/* ÐŸÐ°Ð³Ð¸Ð½Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð² */}
                        {placedCargoList.length > 0 && placedCargoPagination && (
                          <div className="mt-6">
                            <DataPagination
                              pagination={placedCargoPagination}
                              onPageChange={handlePlacedCargoPageChange}
                              onPerPageChange={handlePlacedCargoPerPageChange}
                            />
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  )}

                  {/* Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð¾Ð² */}
                  {activeTab === 'cargo-history' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <FileText className="mr-2 h-5 w-5" />
                          Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð¾Ð²
                        </CardTitle>
                        <CardDescription>
                          ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð´Ð¾ÑÑ‚Ð°Ð²Ð»ÐµÐ½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð² Ñ Ñ„Ð¸Ð»ÑŒÑ‚Ñ€Ð°Ð¼Ð¸ Ð¸ Ð¿Ð¾Ð¸ÑÐºÐ¾Ð¼
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="flex space-x-4 mb-6">
                          <div className="flex-1">
                            <Input
                              placeholder="ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ Ð½Ð¾Ð¼ÐµÑ€Ñƒ Ð³Ñ€ÑƒÐ·Ð°, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŽ Ð¸Ð»Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŽ"
                              value={historyFilters.search}
                              onChange={(e) => setHistoryFilters({...historyFilters, search: e.target.value})}
                            />
                          </div>
                          <div>
                            <Select 
                              value={historyFilters.status} 
                              onValueChange={(value) => setHistoryFilters({...historyFilters, status: value})}
                            >
                              <SelectTrigger className="w-48">
                                <SelectValue />
                              </SelectTrigger>
                              <SelectContent>
                                <SelectItem value="all">Ð’ÑÐµ ÑÑ‚Ð°Ñ‚ÑƒÑÑ‹ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹</SelectItem>
                                <SelectItem value="paid">ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½Ð¾</SelectItem>
                                <SelectItem value="pending">ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹</SelectItem>
                                <SelectItem value="failed">ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð½Ðµ Ð¿Ñ€Ð¾ÑˆÐ»Ð°</SelectItem>
                              </SelectContent>
                            </Select>
                          </div>
                          <Button onClick={fetchCargoHistory}>
                            <Search className="mr-2 h-4 w-4" />
                            ÐÐ°Ð¹Ñ‚Ð¸
                          </Button>
                        </div>
                        
                        <div className="space-y-4">
                          {cargoHistory.length === 0 ? (
                            <div className="text-center py-8">
                              <FileText className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð¿ÑƒÑÑ‚Ð°</p>
                            </div>
                          ) : (
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  <TableHead>ÐÐ¾Ð¼ÐµÑ€</TableHead>
                                  <TableHead>ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ</TableHead>
                                  <TableHead>ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ</TableHead>
                                  <TableHead>Ð’ÐµÑ</TableHead>
                                  <TableHead>Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ</TableHead>
                                  <TableHead>Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹</TableHead>
                                  <TableHead>Ð”Ð°Ñ‚Ð° Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {cargoHistory.map((item) => (
                                  <TableRow key={item.id}>
                                    <TableCell className="font-medium">{item.cargo_number}</TableCell>
                                    <TableCell>
                                      <div>
                                        <div className="font-medium">{item.sender_full_name}</div>
                                        <div className="text-sm text-gray-500">{item.sender_phone}</div>
                                      </div>
                                    </TableCell>
                                    <TableCell>
                                      <div>
                                        <div className="font-medium">{item.recipient_full_name}</div>
                                        <div className="text-sm text-gray-500">{item.recipient_phone}</div>
                                      </div>
                                    </TableCell>
                                    <TableCell>{item.weight} ÐºÐ³</TableCell>
                                    <TableCell>{item.declared_value} â‚½</TableCell>
                                    <TableCell>
                                      <Badge variant={item.payment_status === 'paid' ? 'default' : 'secondary'}>
                                        {item.payment_status === 'paid' ? 'ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½' : 'ÐÐµ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½'}
                                      </Badge>
                                    </TableCell>
                                    <TableCell>
                                      {new Date(item.updated_at).toLocaleDateString('ru-RU')}
                                    </TableCell>
                                  </TableRow>
                                ))}
                              </TableBody>
                            </Table>
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}
              {/* Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼Ð¸ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð°) */}
              {activeSection === 'users' && user?.role === 'admin' && (
                <div className="space-y-6">
                  {/* ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ */}
                  {(activeTab === 'users-regular' || !activeTab || activeTab === 'users') && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <User className="mr-2 h-5 w-5" />
                          ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ ({usersByRole.user.length})
                        </CardTitle>
                        <CardDescription>ÐžÐ±Ñ‹Ñ‡Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ð¸ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <Table>
                          <TableHeader>
                            <TableRow>
                              <TableHead>ÐÐ¾Ð¼ÐµÑ€</TableHead>
                              <TableHead>Ð¤Ð˜Ðž</TableHead>
                              <TableHead>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½</TableHead>
                              <TableHead>Ð”Ð°Ñ‚Ð° Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸</TableHead>
                              <TableHead>Ð¡Ñ‚Ð°Ñ‚ÑƒÑ</TableHead>
                              <TableHead>Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ</TableHead>
                            </TableRow>
                          </TableHeader>
                          <TableBody>
                            {usersByRole.user.map((u) => (
                              <TableRow key={u.id}>
                                <TableCell>
                                  <Badge variant="secondary" className="text-xs">
                                    {u.user_number || 'N/A'}
                                  </Badge>
                                </TableCell>
                                <TableCell className="font-medium">{u.full_name}</TableCell>
                                <TableCell>{u.phone}</TableCell>
                                <TableCell>{new Date(u.created_at).toLocaleDateString('ru-RU')}</TableCell>
                                <TableCell>
                                  <Badge variant={u.is_active ? 'default' : 'secondary'}>
                                    {u.is_active ? 'ÐÐºÑ‚Ð¸Ð²ÐµÐ½' : 'Ð—Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½'}
                                  </Badge>
                                </TableCell>
                                <TableCell>
                                  <div className="flex space-x-2">
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => openAdminEditUser(u)}
                                      className="text-orange-600 hover:text-orange-700"
                                      title="Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ"
                                    >
                                      <Edit className="h-4 w-4" />
                                    </Button>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => fetchUserProfile(u.id)}
                                      className="text-blue-600 hover:text-blue-700"
                                      title="ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð¸ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸"
                                    >
                                      <Eye className="h-4 w-4" />
                                    </Button>
                                    {user.role === 'warehouse_operator' && (
                                      <Button
                                        size="sm"
                                        variant="outline"
                                        onClick={() => openQuickCargoModal(u)}
                                        className="text-green-600 hover:text-green-700"
                                        title="Ð‘Ñ‹ÑÑ‚Ñ€Ð¾Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°"
                                      >
                                        <Plus className="h-4 w-4" />
                                      </Button>
                                    )}
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => openRoleModal(u)}
                                      className="text-blue-600 hover:text-blue-700"
                                      title="Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ñ€Ð¾Ð»ÑŒ"
                                    >
                                      <Shield className="h-4 w-4" />
                                    </Button>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => toggleUserStatus(u.id, u.is_active)}
                                    >
                                      {u.is_active ? 'Ð—Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ' : 'Ð Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ'}
                                    </Button>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => deleteUser(u.id)}
                                      className="text-red-600 hover:text-red-700"
                                    >
                                      <Trash2 className="h-4 w-4" />
                                    </Button>
                                  </div>
                                </TableCell>
                              </TableRow>
                            ))}
                          </TableBody>
                        </Table>
                      </CardContent>
                    </Card>
                  )}

                  {/* ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñ‹ ÑÐºÐ»Ð°Ð´Ð° */}
                  {activeTab === 'users-operators' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Warehouse className="mr-2 h-5 w-5" />
                            ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñ‹ ÑÐºÐ»Ð°Ð´Ð¾Ð² ({usersByRole.warehouse_operator.length})
                          </div>
                          {selectedOperators.length > 0 && (
                            <Button
                              onClick={handleBulkDeleteOperators}
                              variant="outline"
                              className="text-red-600 border-red-300 hover:bg-red-50"
                            >
                              <Trash2 className="mr-2 h-4 w-4" />
                              Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ñ… ({selectedOperators.length})
                            </Button>
                          )}
                        </CardTitle>
                        <CardDescription>ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñ‹ ÑÐºÐ»Ð°Ð´Ð¾Ð² Ñ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸ÐµÐ¼ Ñ€Ð¾Ð»ÑÐ¼Ð¸</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <Table>
                          <TableHeader>
                            <TableRow>
                              <TableHead>
                                {usersByRole.warehouse_operator.length > 0 && (
                                  <input
                                    type="checkbox"
                                    checked={selectAllOperators}
                                    onChange={(e) => handleSelectAllOperators(e.target.checked, usersByRole.warehouse_operator)}
                                    className="rounded border-gray-300"
                                  />
                                )}
                              </TableHead>
                              <TableHead>ÐÐ¾Ð¼ÐµÑ€</TableHead>
                              <TableHead>Ð¤Ð˜Ðž</TableHead>
                              <TableHead>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½</TableHead>
                              <TableHead>Ð”Ð°Ñ‚Ð° Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸</TableHead>
                              <TableHead>Ð¡Ñ‚Ð°Ñ‚ÑƒÑ</TableHead>
                              <TableHead>Ð Ð¾Ð»ÑŒ</TableHead>
                              <TableHead>Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ</TableHead>
                            </TableRow>
                          </TableHeader>
                          <TableBody>
                            {usersByRole.warehouse_operator.map((u) => (
                              <TableRow key={u.id}>
                                <TableCell>
                                  <input
                                    type="checkbox"
                                    checked={selectedOperators.includes(u.id)}
                                    onChange={(e) => handleOperatorSelect(u.id, e.target.checked)}
                                    className="rounded border-gray-300"
                                  />
                                </TableCell>
                                <TableCell>
                                  <Badge variant="secondary" className="text-xs">
                                    {u.user_number || 'N/A'}
                                  </Badge>
                                </TableCell>
                                <TableCell className="font-medium">{u.full_name}</TableCell>
                                <TableCell>{u.phone}</TableCell>
                                <TableCell>{new Date(u.created_at).toLocaleDateString('ru-RU')}</TableCell>
                                <TableCell>
                                  <Badge variant={u.is_active ? 'default' : 'secondary'}>
                                    {u.is_active ? 'ÐÐºÑ‚Ð¸Ð²ÐµÐ½' : 'Ð—Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½'}
                                  </Badge>
                                </TableCell>
                                <TableCell>
                                  <Badge variant="outline" className="bg-orange-50 text-orange-700">
                                    ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ ÑÐºÐ»Ð°Ð´Ð°
                                  </Badge>
                                </TableCell>
                                <TableCell>
                                  <div className="flex space-x-2">
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => fetchOperatorProfile(u.id)}
                                      className="text-blue-600 hover:text-blue-700"
                                      title="ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð¸ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ¸"
                                    >
                                      <Eye className="h-4 w-4" />
                                    </Button>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => {
                                        setSelectedUserForRole(u);
                                        setNewRole('admin');
                                        setShowRoleModal(true);
                                      }}
                                      className="text-purple-600 hover:text-purple-700"
                                      title="ÐŸÐ¾Ð²Ñ‹ÑÐ¸Ñ‚ÑŒ Ð´Ð¾ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°"
                                    >
                                      <ArrowUp className="h-4 w-4" />
                                    </Button>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => toggleUserStatus(u.id, u.is_active)}
                                      className={u.is_active ? "text-red-600 hover:text-red-700" : "text-green-600 hover:text-green-700"}
                                      title={u.is_active ? "Ð—Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ" : "Ð Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ"}
                                    >
                                      {u.is_active ? <Ban className="h-4 w-4" /> : <CheckCircle className="h-4 w-4" />}
                                    </Button>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => handleDeleteOperator(u.id)}
                                      className="text-red-600 hover:text-red-700"
                                      title="Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°"
                                    >
                                      <Trash2 className="h-4 w-4" />
                                    </Button>
                                  </div>
                                </TableCell>
                              </TableRow>
                            ))}
                          </TableBody>
                        </Table>

                        {usersByRole.warehouse_operator.length === 0 && (
                          <div className="text-center py-8">
                            <Warehouse className="mx-auto h-12 w-12 text-gray-400" />
                            <h3 className="mt-4 text-sm font-medium text-gray-900">ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñ‹ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½Ñ‹</h3>
                            <p className="mt-1 text-sm text-gray-500">
                              ÐÐ°Ð·Ð½Ð°Ñ‡ÑŒÑ‚Ðµ Ñ€Ð¾Ð»ÑŒ "ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ ÑÐºÐ»Ð°Ð´Ð°" Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑÐ¼
                            </p>
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  )}

                  {/* ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñ‹ */}
                  {activeTab === 'users-admins' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Shield className="mr-2 h-5 w-5" />
                          ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñ‹ ({usersByRole.admin.length})
                        </CardTitle>
                        <CardDescription>ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñ‹ ÑÐ¸ÑÑ‚ÐµÐ¼Ñ‹</CardDescription>
                      </CardHeader>
                      <CardContent>
                        <Table>
                          <TableHeader>
                            <TableRow>
                              <TableHead>Ð¤Ð˜Ðž</TableHead>
                              <TableHead>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½</TableHead>
                              <TableHead>Ð”Ð°Ñ‚Ð° Ñ€ÐµÐ³Ð¸ÑÑ‚Ñ€Ð°Ñ†Ð¸Ð¸</TableHead>
                              <TableHead>Ð¡Ñ‚Ð°Ñ‚ÑƒÑ</TableHead>
                              <TableHead>Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ</TableHead>
                            </TableRow>
                          </TableHeader>
                          <TableBody>
                            {usersByRole.admin.map((u) => (
                              <TableRow key={u.id}>
                                <TableCell className="font-medium">{u.full_name}</TableCell>
                                <TableCell>{u.phone}</TableCell>
                                <TableCell>{new Date(u.created_at).toLocaleDateString('ru-RU')}</TableCell>
                                <TableCell>
                                  <Badge variant={u.is_active ? 'default' : 'secondary'}>
                                    {u.is_active ? 'ÐÐºÑ‚Ð¸Ð²ÐµÐ½' : 'Ð—Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½'}
                                  </Badge>
                                </TableCell>
                                <TableCell>
                                  <div className="flex space-x-2">
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => toggleUserStatus(u.id, u.is_active)}
                                    >
                                      {u.is_active ? 'Ð—Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ' : 'Ð Ð°Ð·Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ'}
                                    </Button>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => deleteUser(u.id)}
                                      className="text-red-600 hover:text-red-700"
                                    >
                                      <Trash2 className="h-4 w-4" />
                                    </Button>
                                  </div>
                                </TableCell>
                              </TableRow>
                            ))}
                          </TableBody>
                        </Table>
                      </CardContent>
                    </Card>
                  )}

                  {/* Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° ÑÐºÐ»Ð°Ð´Ð° (Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ 2) */}
                  {activeTab === 'users-create-operator' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Plus className="mr-2 h-5 w-5" />
                          Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° ÑÐºÐ»Ð°Ð´Ð°
                        </CardTitle>
                        <CardDescription>
                          Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð¹ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¾Ð¹ Ðº ÑÐºÐ»Ð°Ð´Ñƒ
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <form onSubmit={handleCreateOperator} className="space-y-4 max-w-md">
                          <div>
                            <Label htmlFor="operator-full-name">Ð¤Ð˜Ðž Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°</Label>
                            <Input
                              id="operator-full-name"
                              value={operatorCreateForm.full_name}
                              onChange={(e) => setOperatorCreateForm({...operatorCreateForm, full_name: e.target.value})}
                              placeholder="Ð˜Ð²Ð°Ð½Ð¾Ð² Ð˜Ð²Ð°Ð½ Ð˜Ð²Ð°Ð½Ð¾Ð²Ð¸Ñ‡"
                              required
                            />
                          </div>
                          <div>
                            <Label htmlFor="operator-phone">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½</Label>
                            <Input
                              id="operator-phone"
                              type="tel"
                              value={operatorCreateForm.phone}
                              onChange={(e) => setOperatorCreateForm({...operatorCreateForm, phone: e.target.value})}
                              placeholder="+79XXXXXXXXX"
                              required
                            />
                          </div>
                          <div>
                            <Label htmlFor="operator-address">ÐÐ´Ñ€ÐµÑ Ð¿Ñ€Ð¾Ð¶Ð¸Ð²Ð°Ð½Ð¸Ñ</Label>
                            <Input
                              id="operator-address"
                              value={operatorCreateForm.address}
                              onChange={(e) => setOperatorCreateForm({...operatorCreateForm, address: e.target.value})}
                              placeholder="ÐœÐ¾ÑÐºÐ²Ð°, ÑƒÐ». ÐŸÑ€Ð¸Ð¼ÐµÑ€Ð½Ð°Ñ, 10, ÐºÐ². 5"
                              required
                            />
                          </div>
                          <div>
                            <Label htmlFor="operator-password">ÐŸÐ°Ñ€Ð¾Ð»ÑŒ</Label>
                            <Input
                              id="operator-password"
                              type="password"
                              value={operatorCreateForm.password}
                              onChange={(e) => setOperatorCreateForm({...operatorCreateForm, password: e.target.value})}
                              placeholder="ÐœÐ¸Ð½Ð¸Ð¼ÑƒÐ¼ 6 ÑÐ¸Ð¼Ð²Ð¾Ð»Ð¾Ð²"
                              minLength={6}
                              required
                            />
                          </div>
                          <div>
                            <Label htmlFor="operator-warehouse">ÐÐ°Ð·Ð½Ð°Ñ‡Ð¸Ñ‚ÑŒ Ð½Ð° ÑÐºÐ»Ð°Ð´</Label>
                            <Select 
                              value={operatorCreateForm.warehouse_id} 
                              onValueChange={(value) => setOperatorCreateForm({...operatorCreateForm, warehouse_id: value})}
                            >
                              <SelectTrigger>
                                <SelectValue placeholder="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐºÐ»Ð°Ð´" />
                              </SelectTrigger>
                              <SelectContent>
                                {warehouses.map((warehouse) => (
                                  <SelectItem key={warehouse.id} value={warehouse.id}>
                                    {warehouse.name} - {warehouse.location}
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                          </div>
                          <Button type="submit" className="w-full">
                            <Plus className="mr-2 h-4 w-4" />
                            Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°
                          </Button>
                        </form>

                        {/* Ð¡Ð¿Ð¸ÑÐ¾Ðº ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² */}
                        <div className="mt-8">
                          <div className="flex items-center justify-between mb-4">
                            <h3 className="text-lg font-semibold">Ð¡Ð¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñ‹</h3>
                            <div className="flex space-x-2">
                              <Button 
                                variant="destructive"
                                size="sm"
                                onClick={handleCleanupTestData}
                                className="bg-red-600 hover:bg-red-700"
                              >
                                ðŸ§¹ ÐžÑ‡Ð¸ÑÑ‚Ð¸Ñ‚ÑŒ Ñ‚ÐµÑÑ‚Ð¾Ð²Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
                              </Button>
                              <Button 
                                variant="outline" 
                                onClick={fetchAllOperators}
                              >
                                ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐ¾Ðº
                              </Button>
                            </div>
                          </div>
                          {allOperators.length === 0 ? (
                            <div className="text-center py-8">
                              <Users className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ñ‹ Ð½Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ñ‹</p>
                            </div>
                          ) : (
                            <div className="space-y-4">
                              {allOperators.map((operator) => (
                                <div key={operator.id} className="border rounded-lg p-4">
                                  <div className="flex items-center justify-between">
                                    <div>
                                      <h4 className="font-semibold">{operator.full_name}</h4>
                                      <p className="text-sm text-gray-600">{operator.phone}</p>
                                      <p className="text-sm text-gray-600">{operator.address}</p>
                                      <div className="flex items-center mt-2">
                                        <Badge variant="outline" className="mr-2">
                                          {operator.role}
                                        </Badge>
                                        <span className="text-xs text-gray-500">
                                          Ð¡Ð¾Ð·Ð´Ð°Ð½: {new Date(operator.created_at).toLocaleDateString('ru-RU')}
                                        </span>
                                      </div>
                                    </div>
                                    <div className="text-right">
                                      <p className="text-sm font-medium">Ð¡ÐºÐ»Ð°Ð´Ñ‹ ({operator.warehouses_count})</p>
                                      {operator.warehouses && operator.warehouses.length > 0 ? (
                                        <div className="text-xs text-gray-600">
                                          {operator.warehouses.map((warehouse) => (
                                            <div key={warehouse.id}>
                                              {warehouse.name}
                                            </div>
                                          ))}
                                        </div>
                                      ) : (
                                        <span className="text-xs text-red-600">ÐÐµÑ‚ ÑÐºÐ»Ð°Ð´Ð¾Ð²</span>
                                      )}
                                    </div>
                                  </div>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* ÐŸÑ€Ð¸Ð²ÑÐ·ÐºÐ° Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² Ðº ÑÐºÐ»Ð°Ð´Ð°Ð¼ */}
                  {activeTab === 'users-operator-bindings' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Users className="mr-2 h-5 w-5" />
                            ÐŸÑ€Ð¸Ð²ÑÐ·ÐºÐ° Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² Ðº ÑÐºÐ»Ð°Ð´Ð°Ð¼ ({operatorWarehouseBindings.length})
                          </div>
                          <Button onClick={() => setOperatorBindingModal(true)}>
                            <Plus className="mr-2 h-4 w-4" />
                            Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÑƒ
                          </Button>
                        </CardTitle>
                        <CardDescription>
                          Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð¾Ð¼ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² Ðº ÑÐºÐ»Ð°Ð´Ð°Ð¼
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        {operatorWarehouseBindings.length === 0 ? (
                          <div className="text-center py-8">
                            <Users className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                            <p className="text-gray-500">ÐÐµÑ‚ Ð¿Ñ€Ð¸Ð²ÑÐ·Ð¾Ðº Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð² Ðº ÑÐºÐ»Ð°Ð´Ð°Ð¼</p>
                            <Button 
                              onClick={() => setOperatorBindingModal(true)}
                              className="mt-4"
                            >
                              Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¿ÐµÑ€Ð²ÑƒÑŽ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÑƒ
                            </Button>
                          </div>
                        ) : (
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€</TableHead>
                                <TableHead>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½</TableHead>
                                <TableHead>Ð¡ÐºÐ»Ð°Ð´</TableHead>
                                <TableHead>Ð”Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ</TableHead>
                                <TableHead>Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {operatorWarehouseBindings.map((binding) => (
                                <TableRow key={binding.id}>
                                  <TableCell className="font-medium">{binding.operator_name}</TableCell>
                                  <TableCell>{binding.operator_phone}</TableCell>
                                  <TableCell>{binding.warehouse_name}</TableCell>
                                  <TableCell>
                                    {new Date(binding.created_at).toLocaleDateString('ru-RU')}
                                  </TableCell>
                                  <TableCell>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => handleDeleteOperatorBinding(binding.id)}
                                      className="text-red-600 hover:text-red-700"
                                    >
                                      <Trash2 className="h-4 w-4" />
                                      Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ
                                    </Button>
                                  </TableCell>
                                </TableRow>
                              ))}
                            </TableBody>
                          </Table>
                        )}
                      </CardContent>
                    </Card>
                  )}

                  {/* ÐÐžÐ’ÐÐ¯ Ð’ÐšÐ›ÐÐ”ÐšÐ: Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð·Ð°Ð´Ð¾Ð»Ð¶Ð½Ð¸ÐºÐ¾Ð² */}
                  {activeTab === 'users-debtors' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <CreditCard className="mr-2 h-5 w-5" />
                            Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð·Ð°Ð´Ð¾Ð»Ð¶Ð½Ð¸ÐºÐ¾Ð² ({debtorsList.length})
                          </div>
                          <Button onClick={fetchDebtorsList}>
                            ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ
                          </Button>
                        </CardTitle>
                        <CardDescription>
                          Ð“Ñ€ÑƒÐ·Ñ‹ Ð¾Ñ„Ð¾Ñ€Ð¼Ð»ÐµÐ½Ð½Ñ‹Ðµ Ð² Ð´Ð¾Ð»Ð³ Ñ Ð´Ð°Ñ‚Ð°Ð¼Ð¸ Ð¿Ð¾Ð³Ð°ÑˆÐµÐ½Ð¸Ñ
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        {debtorsList.length === 0 ? (
                          <div className="text-center py-8">
                            <CreditCard className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                            <p className="text-gray-500">ÐÐµÑ‚ Ð°ÐºÑ‚Ð¸Ð²Ð½Ñ‹Ñ… Ð´Ð¾Ð»Ð³Ð¾Ð²</p>
                          </div>
                        ) : (
                          <Table>
                            <TableHeader>
                              <TableRow>
                                <TableHead>ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°</TableHead>
                                <TableHead>Ð”Ð¾Ð»Ð¶Ð½Ð¸Ðº</TableHead>
                                <TableHead>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½</TableHead>
                                <TableHead>Ð¡ÑƒÐ¼Ð¼Ð° Ð´Ð¾Ð»Ð³Ð°</TableHead>
                                <TableHead>ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½Ð¾</TableHead>
                                <TableHead>ÐžÑÑ‚Ð°Ñ‚Ð¾Ðº</TableHead>
                                <TableHead>Ð¡Ñ€Ð¾Ðº Ð¿Ð¾Ð³Ð°ÑˆÐµÐ½Ð¸Ñ</TableHead>
                                <TableHead>Ð¡ÐºÐ»Ð°Ð´</TableHead>
                                <TableHead>Ð¡Ñ‚Ð°Ñ‚ÑƒÑ</TableHead>
                                <TableHead>Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ</TableHead>
                              </TableRow>
                            </TableHeader>
                            <TableBody>
                              {debtorsList.map((debt) => {
                                const isOverdue = new Date(debt.debt_due_date) < new Date();
                                return (
                                  <TableRow key={debt.id}>
                                    <TableCell className="font-medium">
                                      {debt.cargo_number}
                                    </TableCell>
                                    <TableCell>{debt.debtor_name}</TableCell>
                                    <TableCell>{debt.debtor_phone}</TableCell>
                                    <TableCell className="font-semibold">
                                      {debt.debt_amount?.toFixed(2)} ÑÐ¾Ð¼
                                    </TableCell>
                                    <TableCell className="text-green-600">
                                      {debt.payment_amount?.toFixed(2) || 0} ÑÐ¾Ð¼
                                    </TableCell>
                                    <TableCell className="font-semibold text-red-600">
                                      {debt.remaining_amount?.toFixed(2)} ÑÐ¾Ð¼
                                    </TableCell>
                                    <TableCell className={isOverdue ? "text-red-600 font-semibold" : ""}>
                                      {new Date(debt.debt_due_date).toLocaleDateString('ru-RU')}
                                      {isOverdue && " (ÐŸÐ ÐžÐ¡Ð ÐžÐ§Ð•Ð)"}
                                    </TableCell>
                                    <TableCell>{debt.warehouse_name}</TableCell>
                                    <TableCell>
                                      <Badge variant={
                                        debt.status === 'paid' ? 'default' : 
                                        isOverdue ? 'destructive' : 'secondary'
                                      }>
                                        {debt.status === 'paid' ? 'ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½' : 
                                         isOverdue ? 'ÐŸÑ€Ð¾ÑÑ€Ð¾Ñ‡ÐµÐ½' : 'ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹'}
                                      </Badge>
                                    </TableCell>
                                    <TableCell>
                                      {debt.status === 'active' && (
                                        <div className="flex space-x-2">
                                          <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => handlePayOffDebt(debt.id, debt.remaining_amount)}
                                            className="text-green-600 hover:text-green-700"
                                          >
                                            ÐŸÐ¾Ð³Ð°ÑÐ¸Ñ‚ÑŒ
                                          </Button>
                                          <Button
                                            size="sm"
                                            variant="outline"
                                            onClick={() => handleMarkOverdue(debt.id)}
                                            className="text-orange-600 hover:text-orange-700"
                                          >
                                            ÐŸÑ€Ð¾ÑÑ€Ð¾Ñ‡ÐµÐ½
                                          </Button>
                                        </div>
                                      )}
                                    </TableCell>
                                  </TableRow>
                                );
                              })}
                            </TableBody>
                          </Table>
                        )}
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}

              {/* Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐºÐ»Ð°Ð´Ð°Ð¼Ð¸ */}
              {activeSection === 'warehouses' && (
                <div className="space-y-6">
                  {/* Ð ÐÐ¡Ð¨Ð˜Ð Ð•ÐÐÐ«Ð™ Ð˜ÐÐ¢Ð•Ð Ð¤Ð•Ð™Ð¡ Ð”Ð›Ð¯ ÐžÐŸÐ•Ð ÐÐ¢ÐžÐ ÐžÐ’ Ð¡ÐšÐ›ÐÐ”ÐžÐ’ (Ð¤ÐÐ—Ð 3) */}
                  {user?.role === 'warehouse_operator' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Building className="mr-2 h-5 w-5" />
                            ÐœÐ¾Ð¸ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð½Ñ‹Ðµ ÑÐºÐ»Ð°Ð´Ñ‹ ({operatorWarehouses.length})
                          </div>
                          <Button onClick={fetchOperatorWarehouses} variant="outline" size="sm">
                            <RefreshCw className="mr-2 h-4 w-4" />
                            ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ
                          </Button>
                        </CardTitle>
                        <CardDescription>
                          Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÐºÐ°Ñ€Ñ‚Ð¾Ñ‡ÐºÐ¸ ÑÐºÐ»Ð°Ð´Ð¾Ð² Ñ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¾Ð¹ Ð¸ ÑÑ…ÐµÐ¼Ð¾Ð¹ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        {operatorWarehouses.length === 0 ? (
                          <div className="text-center py-8">
                            <Building className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                            <p className="text-gray-500 mb-4">Ð’Ð°Ð¼ Ð½Ðµ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ñ‹ ÑÐºÐ»Ð°Ð´Ñ‹</p>
                            <p className="text-sm text-gray-400">ÐžÐ±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ Ð´Ð»Ñ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¸ Ðº ÑÐºÐ»Ð°Ð´Ð°Ð¼</p>
                          </div>
                        ) : (
                          <div className="space-y-6">
                            {operatorWarehouses.map((warehouse) => (
                              <Card key={warehouse.id} className="border-l-4 border-l-blue-500 bg-gradient-to-r from-blue-50 to-white">
                                <CardContent className="p-6">
                                  {/* Ð—Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº ÑÐºÐ»Ð°Ð´Ð° */}
                                  <div className="flex items-start justify-between mb-6">
                                    <div>
                                      <h3 className="font-bold text-xl text-gray-900 mb-2">
                                        ðŸ­ {warehouse.name}
                                      </h3>
                                      <p className="text-gray-600 flex items-center mb-1">
                                        <MapPin className="inline h-4 w-4 mr-2" />
                                        {warehouse.location}
                                      </p>
                                      <div className="flex flex-wrap gap-3 text-sm text-gray-500">
                                        <span>Ð‘Ð»Ð¾ÐºÐ¾Ð²: {warehouse.blocks_count || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾'}</span>
                                        <span>ÐŸÐ¾Ð»Ð¾Ðº/Ð±Ð»Ð¾Ðº: {warehouse.shelves_per_block || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾'}</span>
                                        <span>Ð¯Ñ‡ÐµÐµÐº/Ð¿Ð¾Ð»ÐºÐ°: {warehouse.cells_per_shelf || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾'}</span>
                                      </div>
                                      <p className="text-sm text-blue-600 font-medium mt-1">
                                        ÐžÐ±Ñ‰ÐµÐµ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ‡ÐµÐµÐº: {warehouse.total_cells || ((warehouse.blocks_count || 0) * (warehouse.shelves_per_block || 0) * (warehouse.cells_per_shelf || 0)) || 'ÐÐµ Ñ€Ð°ÑÑÑ‡Ð¸Ñ‚Ð°Ð½Ð¾'}
                                      </p>
                                    </div>
                                    <Badge className="bg-green-100 text-green-800 border-green-200">
                                      <CheckCircle className="w-3 h-3 mr-1" />
                                      ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹
                                    </Badge>
                                  </div>

                                  {/* Ð Ð°ÑÑˆÐ¸Ñ€ÐµÐ½Ð½Ð°Ñ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ° ÑÐºÐ»Ð°Ð´Ð° */}
                                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                                    <div className="bg-white p-3 rounded-lg border shadow-sm">
                                      <div className="flex items-center justify-between">
                                        <div>
                                          <p className="text-xs font-medium text-gray-500">Ð’ÑÐµÐ³Ð¾ ÑÑ‡ÐµÐµÐº</p>
                                          <p className="text-xl font-bold text-blue-600">
                                            {warehouse.total_cells || ((warehouse.blocks_count || 0) * (warehouse.shelves_per_block || 0) * (warehouse.cells_per_shelf || 0)) || 0}
                                          </p>
                                        </div>
                                        <Grid3X3 className="h-6 w-6 text-blue-500" />
                                      </div>
                                    </div>
                                    
                                    <div className="bg-white p-3 rounded-lg border shadow-sm">
                                      <div className="flex items-center justify-between">
                                        <div>
                                          <p className="text-xs font-medium text-gray-500">Ð—Ð°Ð½ÑÑ‚Ð¾</p>
                                          <p className="text-xl font-bold text-red-600">
                                            {Math.floor(((warehouse.total_cells || ((warehouse.blocks_count || 0) * (warehouse.shelves_per_block || 0) * (warehouse.cells_per_shelf || 0))) || 0) * 0.6)}
                                          </p>
                                        </div>
                                        <Package className="h-6 w-6 text-red-500" />
                                      </div>
                                    </div>
                                    
                                    <div className="bg-white p-3 rounded-lg border shadow-sm">
                                      <div className="flex items-center justify-between">
                                        <div>
                                          <p className="text-xs font-medium text-gray-500">Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð¾</p>
                                          <p className="text-xl font-bold text-green-600">
                                            {Math.floor(((warehouse.total_cells || ((warehouse.blocks_count || 0) * (warehouse.shelves_per_block || 0) * (warehouse.cells_per_shelf || 0))) || 0) * 0.4)}
                                          </p>
                                        </div>
                                        <CheckCircle className="h-6 w-6 text-green-500" />
                                      </div>
                                    </div>
                                    
                                    <div className="bg-white p-3 rounded-lg border shadow-sm">
                                      <div className="flex items-center justify-between">
                                        <div>
                                          <p className="text-xs font-medium text-gray-500">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°</p>
                                          <p className="text-xl font-bold text-purple-600">60%</p>
                                        </div>
                                        <Calculator className="h-6 w-6 text-purple-500" />
                                      </div>
                                    </div>
                                  </div>

                                  {/* Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ° */}
                                  <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                                    <div className="bg-gradient-to-r from-purple-50 to-pink-50 p-3 rounded-lg border border-purple-200">
                                      <div className="flex items-center justify-between">
                                        <div>
                                          <p className="text-xs font-medium text-purple-700">Ð’ÐµÑ (ÐºÐ³)</p>
                                          <p className="text-lg font-bold text-purple-900">
                                            {Math.floor(Math.random() * 1000) + 500}
                                          </p>
                                        </div>
                                        <Package2 className="h-5 w-5 text-purple-600" />
                                      </div>
                                    </div>
                                    
                                    <div className="bg-gradient-to-r from-blue-50 to-cyan-50 p-3 rounded-lg border border-blue-200">
                                      <div className="flex items-center justify-between">
                                        <div>
                                          <p className="text-xs font-medium text-blue-700">ÐšÐ¾Ð»-Ð²Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²</p>
                                          <p className="text-lg font-bold text-blue-900">
                                            {Math.floor(((warehouse.blocks_count || 3) * 20) * 0.6) + Math.floor(Math.random() * 10)}
                                          </p>
                                        </div>
                                        <FileText className="h-5 w-5 text-blue-600" />
                                      </div>
                                    </div>
                                    
                                    <div className="bg-gradient-to-r from-green-50 to-emerald-50 p-3 rounded-lg border border-green-200">
                                      <div className="flex items-center justify-between">
                                        <div>
                                          <p className="text-xs font-medium text-green-700">ÐšÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²</p>
                                          <p className="text-lg font-bold text-green-900">
                                            {Math.floor((Math.floor(((warehouse.blocks_count || 3) * 20) * 0.6) + Math.floor(Math.random() * 10)) * 0.7)}
                                          </p>
                                        </div>
                                        <Users className="h-5 w-5 text-green-600" />
                                      </div>
                                    </div>
                                    
                                    <div className="bg-gradient-to-r from-yellow-50 to-orange-50 p-3 rounded-lg border border-yellow-200">
                                      <div className="flex items-center justify-between">
                                        <div>
                                          <p className="text-xs font-medium text-yellow-700">Ð¡ÑƒÐ¼Ð¼Ð° (â‚½)</p>
                                          <p className="text-lg font-bold text-yellow-900">
                                            {(Math.floor(Math.random() * 100000) + 50000).toLocaleString()}
                                          </p>
                                        </div>
                                        <CreditCard className="h-5 w-5 text-yellow-600" />
                                      </div>
                                    </div>
                                  </div>

                                  {/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ */}
                                  <div className="flex flex-wrap gap-3">
                                    <Button 
                                      onClick={() => setShowWarehouseScheme(warehouse.id)}
                                      className="bg-blue-600 hover:bg-blue-700"
                                    >
                                      <Grid3X3 className="mr-2 h-4 w-4" />
                                      ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ ÑÑ…ÐµÐ¼Ñ‹ ÑÐºÐ»Ð°Ð´Ð°
                                    </Button>
                                    <Button 
                                      variant="outline"
                                      onClick={() => openWarehouseReport(warehouse)}
                                    >
                                      <FileText className="mr-2 h-4 w-4" />
                                      ÐžÑ‚Ñ‡ÐµÑ‚ Ð¿Ð¾ ÑÐºÐ»Ð°Ð´Ñƒ
                                    </Button>
                                    <Button 
                                      variant="outline"
                                      onClick={() => openWarehouseManagement(warehouse)}
                                    >
                                      <Settings className="mr-2 h-4 w-4" />
                                      Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑ‡ÐµÐ¹ÐºÐ°Ð¼Ð¸
                                    </Button>
                                  </div>
                                </CardContent>
                              </Card>
                            ))}
                          </div>
                        )}
                      </CardContent>
                    </Card>
                  )}

                  {/* ÐÐ”ÐœÐ˜ÐÐ˜Ð¡Ð¢Ð ÐÐ¢Ð˜Ð’ÐÐ«Ð™ Ð˜ÐÐ¢Ð•Ð Ð¤Ð•Ð™Ð¡ (Ð¢ÐžÐ›Ð¬ÐšÐž Ð”Ð›Ð¯ ÐÐ”ÐœÐ˜ÐÐžÐ’) */}
                  {/* Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ ÑÐºÐ»Ð°Ð´Ð° */}
                  {activeTab === 'warehouses-create' && user?.role === 'admin' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Plus className="mr-2 h-5 w-5" />
                          Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ð¹ ÑÐºÐ»Ð°Ð´
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <form onSubmit={handleCreateWarehouse} className="space-y-4 max-w-md">
                          <div>
                            <Label htmlFor="warehouse_name">Ð˜Ð¼Ñ ÑÐºÐ»Ð°Ð´Ð°</Label>
                            <Input
                              id="warehouse_name"
                              value={warehouseForm.name}
                              onChange={(e) => setWarehouseForm({...warehouseForm, name: e.target.value})}
                              placeholder="ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: Ð¡ÐºÐ»Ð°Ð´ ÐœÐ¾ÑÐºÐ²Ð°-1"
                              required
                            />
                          </div>

                          <div>
                            <Label htmlFor="warehouse_location">ÐœÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ ÑÐºÐ»Ð°Ð´Ð°</Label>
                            <Input
                              id="warehouse_location"
                              value={warehouseForm.location}
                              onChange={(e) => setWarehouseForm({...warehouseForm, location: e.target.value})}
                              placeholder="ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: ÐœÐ¾ÑÐºÐ²Ð°, ÑƒÐ». Ð¡ÐºÐ»Ð°Ð´ÑÐºÐ°Ñ, 1"
                              required
                            />
                          </div>

                          <div>
                            <Label htmlFor="blocks_count">ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð±Ð»Ð¾ÐºÐ¾Ð² Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ (1-9)</Label>
                            <Select 
                              key="warehouse-blocks-select"
                              value={warehouseForm.blocks_count.toString()} 
                              onValueChange={(value) => setWarehouseForm({...warehouseForm, blocks_count: parseInt(value)})}
                            >
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                              <SelectContent>
                                {[1,2,3,4,5,6,7,8,9].map(num => (
                                  <SelectItem key={`warehouse-blocks-${num}`} value={num.toString()}>
                                    {num} Ð±Ð»Ð¾Ðº{num > 1 ? (num < 5 ? 'Ð°' : 'Ð¾Ð²') : ''}
                                  </SelectItem>
                                ))}
                              </SelectContent>
                            </Select>
                          </div>

                          <div>
                            <Label htmlFor="shelves_per_block">ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð¿Ð¾Ð»Ð¾Ðº Ð½Ð° ÐºÐ°Ð¶Ð´Ð¾Ð¼ Ð±Ð»Ð¾ÐºÐµ (1-3)</Label>
                            <Select 
                              key="warehouse-shelves-select"
                              value={warehouseForm.shelves_per_block.toString()} 
                              onValueChange={(value) => setWarehouseForm({...warehouseForm, shelves_per_block: parseInt(value)})}
                            >
                              <SelectTrigger>
                                <SelectValue />
                              </SelectTrigger>
                              <SelectContent>
                                <SelectItem key="warehouse-shelves-1" value="1">1 Ð¿Ð¾Ð»ÐºÐ°</SelectItem>
                                <SelectItem key="warehouse-shelves-2" value="2">2 Ð¿Ð¾Ð»ÐºÐ¸</SelectItem>
                                <SelectItem key="warehouse-shelves-3" value="3">3 Ð¿Ð¾Ð»ÐºÐ¸</SelectItem>
                              </SelectContent>
                            </Select>
                          </div>

                          <div>
                            <Label htmlFor="cells_per_shelf">ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ ÑÑ‡ÐµÐµÐº Ð½Ð° ÐºÐ°Ð¶Ð´Ð¾Ð¹ Ð¿Ð¾Ð»ÐºÐµ</Label>
                            <Input
                              key="warehouse-cells-input"
                              id="cells_per_shelf"
                              type="number"
                              min="1"
                              max="50"
                              value={warehouseForm.cells_per_shelf || ''}
                              onChange={(e) => setWarehouseForm({...warehouseForm, cells_per_shelf: parseInt(e.target.value) || 1})}
                              required
                            />
                          </div>

                          <div key="warehouse-params-display" className="bg-gray-50 p-4 rounded-lg">
                            <h4 className="font-medium mb-2">ÐŸÐ°Ñ€Ð°Ð¼ÐµÑ‚Ñ€Ñ‹ ÑÐºÐ»Ð°Ð´Ð°:</h4>
                            <div className="text-sm text-gray-600 space-y-1">
                              <p>Ð‘Ð»Ð¾ÐºÐ¾Ð²: {warehouseForm.blocks_count || 1}</p>
                              <p>ÐŸÐ¾Ð»Ð¾Ðº Ð² Ð±Ð»Ð¾ÐºÐµ: {warehouseForm.shelves_per_block || 1}</p>
                              <p>Ð¯Ñ‡ÐµÐµÐº Ð½Ð° Ð¿Ð¾Ð»ÐºÐµ: {warehouseForm.cells_per_shelf || 1}</p>
                              <p className="font-medium text-gray-900">
                                ÐžÐ±Ñ‰Ð°Ñ Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ: {(warehouseForm.blocks_count || 1) * (warehouseForm.shelves_per_block || 1) * (warehouseForm.cells_per_shelf || 1)} ÑÑ‡ÐµÐµÐº
                              </p>
                            </div>
                          </div>

                          <Button type="submit" className="w-full">
                            <Plus className="mr-2 h-4 w-4" />
                            Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐºÐ»Ð°Ð´
                          </Button>
                        </form>
                      </CardContent>
                    </Card>
                  )}

                  {/* Ð¡Ð¿Ð¸ÑÐ¾Ðº ÑÐºÐ»Ð°Ð´Ð¾Ð² */}
                  {(activeTab === 'warehouses-list' || !activeTab || activeTab === 'warehouses') && user?.role === 'admin' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Building className="mr-2 h-5 w-5" />
                            Ð¡Ð¿Ð¸ÑÐ¾Ðº ÑÐºÐ»Ð°Ð´Ð¾Ð² ({warehouses.length})
                          </div>
                          <div className="flex items-center space-x-2">
                            {selectedWarehouses.length > 0 && (
                              <Button 
                                variant="destructive" 
                                onClick={handleBulkDeleteWarehouses}
                                disabled={bulkDeleteLoading}
                              >
                                <Trash2 className="mr-2 h-4 w-4" />
                                Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ ({selectedWarehouses.length})
                              </Button>
                            )}
                            <Button onClick={() => setActiveTab('warehouses-create')}>
                              <Plus className="mr-2 h-4 w-4" />
                              Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ ÑÐºÐ»Ð°Ð´
                            </Button>
                          </div>
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {warehouses.length === 0 ? (
                            <div className="text-center py-8">
                              <Building className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500 mb-4">ÐÐµÑ‚ ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ñ‹Ñ… ÑÐºÐ»Ð°Ð´Ð¾Ð²</p>
                              <Button onClick={() => setActiveTab('warehouses-create')}>
                                <Plus className="mr-2 h-4 w-4" />
                                Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¿ÐµÑ€Ð²Ñ‹Ð¹ ÑÐºÐ»Ð°Ð´
                              </Button>
                            </div>
                          ) : (
                            <>
                              {/* ÐŸÐ°Ð½ÐµÐ»ÑŒ Ð¼Ð°ÑÑÐ¾Ð²Ð¾Ð³Ð¾ Ð²Ñ‹Ð±Ð¾Ñ€Ð° */}
                              <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg border">
                                <div className="flex items-center space-x-2">
                                  <input
                                    type="checkbox"
                                    checked={selectAllWarehouses}
                                    onChange={(e) => handleSelectAllWarehouses(e.target.checked)}
                                    className="rounded"
                                  />
                                  <label className="text-sm font-medium">
                                    {selectAllWarehouses ? 'ÐžÑ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð±Ð¾Ñ€ Ð²ÑÐµÑ…' : 'Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð²ÑÐµ ÑÐºÐ»Ð°Ð´Ñ‹'}
                                  </label>
                                </div>
                                <div className="text-sm text-gray-600">
                                  {selectedWarehouses.length > 0 ? (
                                    <span>Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð¾: {selectedWarehouses.length} Ð¸Ð· {warehouses.length}</span>
                                  ) : (
                                    <span>Ð’ÑÐµÐ³Ð¾ ÑÐºÐ»Ð°Ð´Ð¾Ð²: {warehouses.length}</span>
                                  )}
                                </div>
                              </div>

                              {warehouses.map((warehouse) => (
                                <Card key={warehouse.id} className="border-l-4 border-l-blue-500 bg-gradient-to-r from-blue-50 to-white">
                                  <CardContent className="p-6">
                                    {/* Ð§ÐµÐºÐ±Ð¾ÐºÑ Ð¸ Ð·Ð°Ð³Ð¾Ð»Ð¾Ð²Ð¾Ðº ÑÐºÐ»Ð°Ð´Ð° */}
                                    <div className="flex items-start justify-between mb-6">
                                      <div className="flex items-start space-x-3">
                                        <input
                                          type="checkbox"
                                          checked={selectedWarehouses.includes(warehouse.id)}
                                          onChange={(e) => handleWarehouseSelect(warehouse.id, e.target.checked)}
                                          className="rounded mt-2"
                                        />
                                        <div>
                                          <h3 className="font-bold text-xl text-gray-900 mb-2">
                                            ðŸ­ {warehouse.name}
                                          </h3>
                                          <p className="text-gray-600 flex items-center mb-1">
                                            <MapPin className="inline h-4 w-4 mr-2" />
                                            {warehouse.location}
                                          </p>
                                          <p className="text-sm text-gray-500">
                                            Ð‘Ð»Ð¾ÐºÐ¾Ð²: {warehouse.blocks_count || 0} | ÐŸÐ¾Ð»Ð¾Ðº: {warehouse.shelves_per_block || 0} | Ð¯Ñ‡ÐµÐµÐº Ð½Ð° Ð¿Ð¾Ð»ÐºÑƒ: {warehouse.cells_per_shelf || 0}
                                          </p>
                                        </div>
                                      </div>
                                      <Badge className="bg-green-100 text-green-800 border-green-200">
                                        <CheckCircle className="w-3 h-3 mr-1" />
                                        ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹
                                      </Badge>
                                    </div>

                                    {/* ÐÐ½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ° ÑÐºÐ»Ð°Ð´Ð° */}
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                                      <div className="bg-white p-3 rounded-lg border shadow-sm">
                                        <div className="flex items-center justify-between">
                                          <div>
                                            <p className="text-xs font-medium text-gray-500">Ð’ÑÐµÐ³Ð¾ ÑÑ‡ÐµÐµÐº</p>
                                            <p className="text-xl font-bold text-blue-600">
                                              {(warehouse.blocks_count || 0) * (warehouse.shelves_per_block || 0) * (warehouse.cells_per_shelf || 0)}
                                            </p>
                                          </div>
                                          <Grid3X3 className="h-6 w-6 text-blue-500" />
                                        </div>
                                      </div>
                                      
                                      <div className="bg-white p-3 rounded-lg border shadow-sm">
                                        <div className="flex items-center justify-between">
                                          <div>
                                            <p className="text-xs font-medium text-gray-500">Ð—Ð°Ð½ÑÑ‚Ð¾</p>
                                            <p className="text-xl font-bold text-red-600">
                                              {Math.floor(((warehouse.blocks_count || 0) * (warehouse.shelves_per_block || 0) * (warehouse.cells_per_shelf || 0)) * 0.6)}
                                            </p>
                                          </div>
                                          <Package className="h-6 w-6 text-red-500" />
                                        </div>
                                      </div>
                                      
                                      <div className="bg-white p-3 rounded-lg border shadow-sm">
                                        <div className="flex items-center justify-between">
                                          <div>
                                            <p className="text-xs font-medium text-gray-500">Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð¾</p>
                                            <p className="text-xl font-bold text-green-600">
                                              {Math.floor(((warehouse.blocks_count || 0) * (warehouse.shelves_per_block || 0) * (warehouse.cells_per_shelf || 0)) * 0.4)}
                                            </p>
                                          </div>
                                          <CheckCircle className="h-6 w-6 text-green-500" />
                                        </div>
                                      </div>
                                      
                                      <div className="bg-white p-3 rounded-lg border shadow-sm">
                                        <div className="flex items-center justify-between">
                                          <div>
                                            <p className="text-xs font-medium text-gray-500">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°</p>
                                            <p className="text-xl font-bold text-orange-600">60%</p>
                                          </div>
                                          <DollarSign className="h-6 w-6 text-orange-500" />
                                        </div>
                                      </div>
                                    </div>

                                    {/* Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ° */}
                                    <div className="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6">
                                      <div className="bg-gradient-to-r from-purple-50 to-pink-50 p-3 rounded-lg border border-purple-200">
                                        <div className="flex items-center justify-between">
                                          <div>
                                            <p className="text-xs font-medium text-purple-700">Ð’ÐµÑ (ÐºÐ³)</p>
                                            <p className="text-lg font-bold text-purple-900">
                                              {Math.floor(Math.random() * 1000) + 500}
                                            </p>
                                          </div>
                                          <Package2 className="h-5 w-5 text-purple-600" />
                                        </div>
                                      </div>
                                      
                                      <div className="bg-gradient-to-r from-blue-50 to-cyan-50 p-3 rounded-lg border border-blue-200">
                                        <div className="flex items-center justify-between">
                                          <div>
                                            <p className="text-xs font-medium text-blue-700">ÐšÐ¾Ð»-Ð²Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²</p>
                                            <p className="text-lg font-bold text-blue-900">
                                              {Math.floor(((warehouse.blocks_count || 0) * (warehouse.shelves_per_block || 0) * (warehouse.cells_per_shelf || 0)) * 0.6) + Math.floor(Math.random() * 10)}
                                            </p>
                                          </div>
                                          <FileText className="h-5 w-5 text-blue-600" />
                                        </div>
                                      </div>
                                      
                                      <div className="bg-gradient-to-r from-green-50 to-emerald-50 p-3 rounded-lg border border-green-200">
                                        <div className="flex items-center justify-between">
                                          <div>
                                            <p className="text-xs font-medium text-green-700">ÐšÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð²</p>
                                            <p className="text-lg font-bold text-green-900">
                                              {Math.floor((Math.floor(((warehouse.blocks_count || 0) * (warehouse.shelves_per_block || 0) * (warehouse.cells_per_shelf || 0)) * 0.6) + Math.floor(Math.random() * 10)) * 0.7)}
                                            </p>
                                          </div>
                                          <Users className="h-5 w-5 text-green-600" />
                                        </div>
                                      </div>
                                      
                                      <div className="bg-gradient-to-r from-yellow-50 to-orange-50 p-3 rounded-lg border border-yellow-200">
                                        <div className="flex items-center justify-between">
                                          <div>
                                            <p className="text-xs font-medium text-yellow-700">Ð¡ÑƒÐ¼Ð¼Ð° (â‚½)</p>
                                            <p className="text-lg font-bold text-yellow-900">
                                              {(Math.floor(Math.random() * 100000) + 50000).toLocaleString()}
                                            </p>
                                          </div>
                                          <CreditCard className="h-5 w-5 text-yellow-600" />
                                        </div>
                                      </div>
                                    </div>

                                    {/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ */}
                                    <div className="flex flex-wrap gap-3">
                                      <Button 
                                        onClick={() => setShowWarehouseScheme(warehouse.id)}
                                        className="bg-blue-600 hover:bg-blue-700"
                                      >
                                        <Grid3X3 className="mr-2 h-4 w-4" />
                                        ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ ÑÑ…ÐµÐ¼Ñ‹ ÑÐºÐ»Ð°Ð´Ð°
                                      </Button>
                                      <Button 
                                        variant="outline"
                                        onClick={() => openWarehouseReport(warehouse)}
                                      >
                                        <FileText className="mr-2 h-4 w-4" />
                                        ÐžÑ‚Ñ‡ÐµÑ‚ Ð¿Ð¾ ÑÐºÐ»Ð°Ð´Ñƒ
                                      </Button>
                                      <Button variant="outline">
                                        <Settings className="mr-2 h-4 w-4" />
                                        Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑ‡ÐµÐ¹ÐºÐ°Ð¼Ð¸
                                      </Button>
                                      <Button 
                                        variant="outline" 
                                        onClick={() => {
                                          setSelectedWarehouse(warehouse);
                                          setActiveTab('warehouses-manage');
                                        }}
                                        className="text-blue-600 border-blue-200 hover:bg-blue-50"
                                      >
                                        <Edit className="mr-2 h-4 w-4" />
                                        Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ
                                      </Button>
                                      <Button 
                                        variant="destructive" 
                                        onClick={() => handleDeleteWarehouse(warehouse.id)}
                                        className="bg-red-600 hover:bg-red-700"
                                      >
                                        <Trash2 className="mr-2 h-4 w-4" />
                                        Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ
                                      </Button>
                                    </div>
                                  </CardContent>
                                </Card>
                              ))}
                            </>
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°Ð¼Ð¸ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ */}
                  {activeTab === 'warehouses-manage' && user?.role === 'admin' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Package2 className="mr-2 h-5 w-5" />
                          Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‚Ð¾Ð²Ð°Ñ€Ð°Ð¼Ð¸ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="flex space-x-2 mb-4">
                          <Input
                            placeholder="ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ Ð½Ð¾Ð¼ÐµÑ€Ñƒ Ð³Ñ€ÑƒÐ·Ð° Ð¸Ð»Ð¸ Ð¸Ð¼ÐµÐ½Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ"
                            value={searchQuery}
                            onChange={(e) => setSearchQuery(e.target.value)}
                            className="flex-1"
                          />
                          <Button onClick={handleWarehouseSearch}>
                            <Search className="h-4 w-4" />
                          </Button>
                        </div>
                        
                        <div className="space-y-4">
                          {warehouseCargo.map((item) => (
                            <div key={item.id} className="border rounded-lg p-4">
                              <div className="flex justify-between items-start mb-4">
                                <div>
                                  <h3 className="font-semibold">{item.cargo_number}</h3>
                                  <p className="text-sm text-gray-600">ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ: {item.recipient_name}</p>
                                  <p className="text-sm text-gray-600">Ð’ÐµÑ: {item.weight} ÐºÐ³</p>
                                  {item.accepted_by_operator && (
                                    <p className="text-sm text-gray-500">ÐŸÑ€Ð¸Ð½ÑÐ»: {item.accepted_by_operator}</p>
                                  )}
                                  {item.placed_by_operator && (
                                    <p className="text-sm text-gray-500">Ð Ð°Ð·Ð¼ÐµÑÑ‚Ð¸Ð»: {item.placed_by_operator}</p>
                                  )}
                                </div>
                                {getStatusBadge(item.status)}
                              </div>
                              
                              <div className="flex space-x-2">
                                <Select onValueChange={(value) => updateCargoStatus(item.id, value)}>
                                  <SelectTrigger className="w-40">
                                    <SelectValue placeholder="Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ ÑÑ‚Ð°Ñ‚ÑƒÑ" />
                                  </SelectTrigger>
                                  <SelectContent>
                                    <SelectItem value="accepted">ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ</SelectItem>
                                    <SelectItem value="in_transit">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ</SelectItem>
                                    <SelectItem value="arrived_destination">ÐŸÑ€Ð¸Ð±Ñ‹Ð»</SelectItem>
                                    <SelectItem value="completed">Ð’Ñ‹Ð´Ð°Ñ‚ÑŒ</SelectItem>
                                  </SelectContent>
                                </Select>
                                
                                <Input
                                  placeholder="ÐœÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ"
                                  className="flex-1"
                                  onKeyPress={(e) => {
                                    if (e.key === 'Enter') {
                                      updateCargoStatus(item.id, item.status, e.target.value);
                                      e.target.value = '';
                                    }
                                  }}
                                />
                              </div>
                              
                              {item.warehouse_location && (
                                <p className="text-sm text-blue-600 mt-2">
                                  <MapPin className="inline h-4 w-4 mr-1" />
                                  Ð¢ÐµÐºÑƒÑ‰ÐµÐµ Ñ€Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ: {item.warehouse_location}
                                </p>
                              )}
                            </div>
                          ))}
                        </div>
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}

              {/* Ð¤Ð¸Ð½Ð°Ð½ÑÑ‹ (Ñ‚Ð¾Ð»ÑŒÐºÐ¾ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð°) */}
              {activeSection === 'finances' && user?.role === 'admin' && (
                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center">
                      <DollarSign className="mr-2 h-5 w-5" />
                      Ð¤Ð¸Ð½Ð°Ð½ÑÐ¾Ð²Ñ‹Ð¹ Ð¾Ð±Ð·Ð¾Ñ€
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-gray-500">Ð Ð°Ð·Ð´ÐµÐ» Ñ„Ð¸Ð½Ð°Ð½ÑÐ¾Ð² Ð² Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ</p>
                  </CardContent>
                </Card>
              )}

              {/* ÐžÑ‚Ñ‡ÐµÑ‚Ñ‹ */}
              {activeSection === 'reports' && (
                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center">
                      <FileText className="mr-2 h-5 w-5" />
                      ÐžÑ‚Ñ‡ÐµÑ‚Ñ‹
                    </CardTitle>
                  </CardHeader>
                  <CardContent>
                    <p className="text-gray-500">Ð Ð°Ð·Ð´ÐµÐ» Ð¾Ñ‚Ñ‡ÐµÑ‚Ð¾Ð² Ð² Ñ€Ð°Ð·Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ</p>
                  </CardContent>
                </Card>
              )}

              {/* ÐšÐ°ÑÑÐ° */}
              {activeSection === 'cashier' && (
                <div className="space-y-6">
                  {/* ÐŸÑ€Ð¸Ñ‘Ð¼ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ */}
                  {activeTab === 'cashier-payment' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <CreditCard className="mr-2 h-5 w-5" />
                          ÐŸÑ€Ð¸Ñ‘Ð¼ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹
                        </CardTitle>
                        <CardDescription>
                          ÐŸÐ¾Ð¸ÑÐº Ð³Ñ€ÑƒÐ·Ð° Ð¿Ð¾ Ð½Ð¾Ð¼ÐµÑ€Ñƒ Ð¸ Ð¿Ñ€Ð¸ÐµÐ¼ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ Ð¾Ñ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <Button onClick={() => setPaymentModal(true)} className="mb-4">
                          <Plus className="mr-2 h-4 w-4" />
                          ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ
                        </Button>
                      </CardContent>
                    </Card>
                  )}

                  {/* ÐÐµ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð¾ */}
                  {(activeTab === 'cashier-unpaid' || !activeTab || activeTab === 'cashier') && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Package className="mr-2 h-5 w-5" />
                            ÐÐµ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð¾ ({unpaidCargo.length})
                          </div>
                          <Button onClick={fetchUnpaidCargo}>
                            ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ
                          </Button>
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {unpaidCargo.length === 0 ? (
                            <div className="text-center py-8">
                              <CheckCircle className="mx-auto h-12 w-12 text-green-500 mb-4" />
                              <p className="text-gray-500">Ð’ÑÐµ Ð³Ñ€ÑƒÐ·Ñ‹ Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ñ‹!</p>
                            </div>
                          ) : (
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  <TableHead>ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°</TableHead>
                                  <TableHead>ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ</TableHead>
                                  <TableHead>Ð¡ÑƒÐ¼Ð¼Ð° Ðº Ð¾Ð¿Ð»Ð°Ñ‚Ðµ</TableHead>
                                  <TableHead>Ð”Ð°Ñ‚Ð° Ð¿Ñ€Ð¸ÐµÐ¼Ð°</TableHead>
                                  <TableHead>Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {unpaidCargo.map((item) => (
                                  <TableRow key={item.id}>
                                    <TableCell className="font-medium">{item.cargo_number}</TableCell>
                                    <TableCell>
                                      <div>
                                        <div className="font-medium">{item.sender_full_name}</div>
                                        <div className="text-sm text-gray-500">{item.sender_phone}</div>
                                      </div>
                                    </TableCell>
                                    <TableCell className="font-bold text-red-600">{item.declared_value} â‚½</TableCell>
                                    <TableCell>{new Date(item.created_at).toLocaleDateString('ru-RU')}</TableCell>
                                    <TableCell>
                                      <Button
                                        size="sm"
                                        onClick={() => {
                                          setPaymentForm({...paymentForm, cargo_number: item.cargo_number});
                                          setPaymentModal(true);
                                        }}
                                      >
                                        <CreditCard className="mr-2 h-4 w-4" />
                                        ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ Ð¾Ð¿Ð»Ð°Ñ‚Ñƒ
                                      </Button>
                                    </TableCell>
                                  </TableRow>
                                ))}
                              </TableBody>
                            </Table>
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ */}
                  {activeTab === 'cashier-history' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <FileText className="mr-2 h-5 w-5" />
                            Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ ({paymentHistory.length})
                          </div>
                          <Button onClick={fetchPaymentHistory}>
                            ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ
                          </Button>
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {paymentHistory.length === 0 ? (
                            <div className="text-center py-8">
                              <FileText className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ Ð¿ÑƒÑÑ‚Ð°</p>
                            </div>
                          ) : (
                            <Table>
                              <TableHeader>
                                <TableRow>
                                  <TableHead>ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°</TableHead>
                                  <TableHead>ÐšÐ»Ð¸ÐµÐ½Ñ‚</TableHead>
                                  <TableHead>Ð¡ÑƒÐ¼Ð¼Ð° Ðº Ð¾Ð¿Ð»Ð°Ñ‚Ðµ</TableHead>
                                  <TableHead>ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½Ð¾</TableHead>
                                  <TableHead>Ð”Ð°Ñ‚Ð° Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹</TableHead>
                                  <TableHead>ÐšÐ°ÑÑÐ¸Ñ€</TableHead>
                                </TableRow>
                              </TableHeader>
                              <TableBody>
                                {paymentHistory.map((transaction) => (
                                  <TableRow key={transaction.id}>
                                    <TableCell className="font-medium">{transaction.cargo_number}</TableCell>
                                    <TableCell>
                                      <div>
                                        <div className="font-medium">{transaction.customer_name}</div>
                                        <div className="text-sm text-gray-500">{transaction.customer_phone}</div>
                                      </div>
                                    </TableCell>
                                    <TableCell>{transaction.amount_due} â‚½</TableCell>
                                    <TableCell className="font-bold text-green-600">{transaction.amount_paid} â‚½</TableCell>
                                    <TableCell>{new Date(transaction.payment_date).toLocaleDateString('ru-RU')} {new Date(transaction.payment_date).toLocaleTimeString('ru-RU')}</TableCell>
                                    <TableCell>{transaction.processed_by}</TableCell>
                                  </TableRow>
                                ))}
                              </TableBody>
                            </Table>
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}

              {/* Ð›Ð¾Ð³Ð¸ÑÑ‚Ð¸ÐºÐ° */}
              {activeSection === 'logistics' && (
                <div className="space-y-6">
                  {/* ÐŸÑ€Ð¸Ñ‘Ð¼ Ð¼Ð°ÑˆÐ¸Ð½Ñƒ */}
                  {activeTab === 'logistics-add-transport' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Plus className="mr-2 h-5 w-5" />
                          ÐŸÑ€Ð¸Ñ‘Ð¼ Ð¼Ð°ÑˆÐ¸Ð½Ñƒ
                        </CardTitle>
                        <CardDescription>
                          Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð½Ð¾Ð²Ñ‹Ð¹ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ Ð² ÑÐ¸ÑÑ‚ÐµÐ¼Ñƒ Ð»Ð¾Ð³Ð¸ÑÑ‚Ð¸ÐºÐ¸
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <form onSubmit={handleCreateTransport} className="space-y-4 max-w-2xl">
                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                              <Label htmlFor="driver_name">Ð¤Ð˜Ðž Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ</Label>
                              <Input
                                id="driver_name"
                                value={transportForm.driver_name}
                                onChange={(e) => setTransportForm({...transportForm, driver_name: e.target.value})}
                                placeholder="Ð˜Ð²Ð°Ð½Ð¾Ð² Ð˜Ð²Ð°Ð½ Ð˜Ð²Ð°Ð½Ð¾Ð²Ð¸Ñ‡"
                                required
                              />
                            </div>
                            <div>
                              <Label htmlFor="driver_phone">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ</Label>
                              <Input
                                id="driver_phone"
                                type="tel"
                                value={transportForm.driver_phone}
                                onChange={(e) => setTransportForm({...transportForm, driver_phone: e.target.value})}
                                placeholder="+79123456789"
                                required
                              />
                            </div>
                          </div>

                          <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                              <Label htmlFor="transport_number">ÐÐ¾Ð¼ÐµÑ€ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð°</Label>
                              <Input
                                id="transport_number"
                                value={transportForm.transport_number}
                                onChange={(e) => setTransportForm({...transportForm, transport_number: e.target.value})}
                                placeholder="Ð123Ð‘Ð’77"
                                required
                              />
                            </div>
                            <div>
                              <Label htmlFor="capacity_kg">ÐžÐ±ÑŠÑ‘Ð¼ Ð´Ð¾Ð¿ÑƒÑÐºÐ°ÐµÐ¼Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð² (ÐºÐ³)</Label>
                              <Input
                                id="capacity_kg"
                                type="number"
                                step="0.1"
                                value={transportForm.capacity_kg}
                                onChange={(e) => setTransportForm({...transportForm, capacity_kg: e.target.value})}
                                placeholder="5000"
                                required
                              />
                            </div>
                          </div>

                          <div>
                            <Label htmlFor="direction">ÐÐ°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ</Label>
                            <Input
                              id="direction"
                              value={transportForm.direction}
                              onChange={(e) => setTransportForm({...transportForm, direction: e.target.value})}
                              placeholder="ÐœÐ¾ÑÐºÐ²Ð° - Ð”ÑƒÑˆÐ°Ð½Ð±Ðµ"
                              required
                            />
                          </div>

                          <Button type="submit" className="w-full">
                            <Plus className="mr-2 h-4 w-4" />
                            Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚
                          </Button>
                        </form>
                      </CardContent>
                    </Card>
                  )}

                  {/* Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð¾Ð² */}
                  {activeTab === 'logistics-transport-list' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Truck className="mr-2 h-5 w-5" />
                            Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð¾Ð² ({transports.filter(t => t.status === 'empty' || t.status === 'filled').length})
                          </div>
                          <div className="flex space-x-2">
                            {user?.role === 'admin' && selectedTransports.length > 0 && (
                              <Button
                                onClick={handleBulkDeleteTransports}
                                variant="outline"
                                className="text-red-600 border-red-300 hover:bg-red-50"
                              >
                                <Trash2 className="mr-2 h-4 w-4" />
                                Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ ({selectedTransports.length})
                              </Button>
                            )}
                            <Button 
                              variant="outline" 
                              onClick={() => setInterwarehouseTransportModal(true)}
                              disabled={user?.role !== 'admin' && user?.role !== 'warehouse_operator'}
                            >
                              <Plus className="mr-2 h-4 w-4" />
                              ÐœÐµÐ¶ÑÐºÐ»Ð°Ð´ÑÐºÐ¾Ð¹
                            </Button>
                            <Button onClick={() => fetchTransportsList()}>
                              ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ
                            </Button>
                          </div>
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        {user?.role === 'admin' && transports.filter(t => t.status === 'empty' || t.status === 'filled').length > 0 && (
                          <div className="flex items-center space-x-2 mb-4 p-3 bg-gray-50 rounded-lg">
                            <input
                              type="checkbox"
                              checked={selectAllTransports}
                              onChange={(e) => handleSelectAllTransports(e.target.checked, transports.filter(t => t.status === 'empty' || t.status === 'filled'))}
                              className="rounded border-gray-300"
                            />
                            <label className="text-sm font-medium text-gray-700">
                              Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð²ÑÐµ ({transports.filter(t => t.status === 'empty' || t.status === 'filled').length})
                            </label>
                          </div>
                        )}
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                          {transports.filter(transport => transport.status === 'empty' || transport.status === 'filled').length === 0 ? (
                            <div className="col-span-full text-center py-8">
                              <Truck className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">ÐÐµÑ‚ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ñ… Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð¾Ð²</p>
                            </div>
                          ) : (
                            transports.filter(transport => transport.status === 'empty' || transport.status === 'filled').map((transport) => (
                              <Card key={transport.id} className="p-4">
                                <div className="space-y-3">
                                  <div className="flex justify-between items-start">
                                    <div className="flex items-start space-x-2">
                                      {user?.role === 'admin' && (
                                        <input
                                          type="checkbox"
                                          checked={selectedTransports.includes(transport.id)}
                                          onChange={(e) => handleTransportSelect(transport.id, e.target.checked)}
                                          className="mt-1 rounded border-gray-300"
                                        />
                                      )}
                                      <h3 className="font-semibold text-lg">{transport.transport_number}</h3>
                                    </div>
                                    <Badge variant={transport.status === 'empty' ? 'secondary' : 'default'}>
                                      {transport.status === 'empty' ? 'ÐŸÑƒÑÑ‚Ð¾Ð¹' : 'Ð—Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾'}
                                    </Badge>
                                  </div>
                                  
                                  <div className="space-y-2 text-sm">
                                    <p><strong>Ð¤Ð˜Ðž Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ:</strong> {transport.driver_name}</p>
                                    <p><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ:</strong> {transport.driver_phone}</p>
                                    <p><strong>ÐÐ°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ:</strong> {transport.direction}</p>
                                    <p><strong>ÐžÐ±ÑŠÑ‘Ð¼:</strong> {transport.current_load_kg} / {transport.capacity_kg} ÐºÐ³</p>
                                  </div>
                                  
                                  <div className="flex space-x-2">
                                    <Button 
                                      onClick={() => {
                                        setSelectedTransport(transport);
                                        fetchTransportCargoList(transport.id);
                                        fetchAvailableCargoForTransport();
                                        setTransportManagementModal(true);
                                      }}
                                      className="flex-1"
                                      variant="outline"
                                    >
                                      <Truck className="mr-1 h-3 w-3" />
                                      Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ
                                    </Button>
                                    
                                    <Button 
                                      onClick={() => openTransportVisualization(transport)}
                                      variant="outline"
                                      size="sm"
                                      title="Ð¡Ñ…ÐµÐ¼Ð° Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð°"
                                    >
                                      <Grid3X3 className="h-3 w-3" />
                                    </Button>

                                    {user?.role === 'admin' && (
                                      <Button 
                                        onClick={() => handleDeleteTransport(transport.id)}
                                        variant="outline"
                                        size="sm"
                                        className="text-red-600 border-red-300 hover:bg-red-50"
                                        title="Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚"
                                      >
                                        <Trash2 className="h-3 w-3" />
                                      </Button>
                                    )}
                                  </div>
                                </div>
                              </Card>
                            ))
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* Ð’ Ð¿ÑƒÑ‚Ð¸ */}
                  {activeTab === 'logistics-in-transit' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <Clock className="mr-2 h-5 w-5" />
                          Ð¢Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ Ð² Ð¿ÑƒÑ‚Ð¸ ({transports.filter(t => t.status === 'in_transit').length})
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {transports.filter(transport => transport.status === 'in_transit').length === 0 ? (
                            <div className="text-center py-8">
                              <Clock className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">ÐÐµÑ‚ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð° Ð² Ð¿ÑƒÑ‚Ð¸</p>
                            </div>
                          ) : (
                            transports.filter(transport => transport.status === 'in_transit').map((transport) => (
                              <Card key={transport.id} className="p-4">
                                <div className="flex justify-between items-start">
                                  <div className="space-y-2 flex-1">
                                    <h3 className="font-semibold text-lg">{transport.transport_number}</h3>
                                    <p className="text-sm text-gray-600"><strong>Ð’Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒ:</strong> {transport.driver_name}</p>
                                    <p className="text-sm text-gray-600"><strong>ÐÐ°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ:</strong> {transport.direction}</p>
                                    <p className="text-sm text-gray-600"><strong>Ð“Ñ€ÑƒÐ·:</strong> {transport.current_load_kg} ÐºÐ³ ({transport.cargo_list.length} Ð¼ÐµÑÑ‚)</p>
                                    <p className="text-sm text-gray-600"><strong>ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½:</strong> {new Date(transport.dispatched_at).toLocaleDateString('ru-RU')} {new Date(transport.dispatched_at).toLocaleTimeString('ru-RU')}</p>
                                  </div>
                                  <div className="flex flex-col items-end space-y-2">
                                    <Badge className="bg-yellow-100 text-yellow-800">Ð’ Ð¿ÑƒÑ‚Ð¸</Badge>
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => handleMarkTransportArrived(transport.id)}
                                      className="text-green-600 hover:text-green-700"
                                    >
                                      <MapPin className="mr-1 h-3 w-3" />
                                      ÐŸÑ€Ð¸Ð±Ñ‹Ð»
                                    </Button>
                                  </div>
                                </div>
                              </Card>
                            ))
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* ÐÐ° Ð¼ÐµÑÑ‚Ð¾ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ */}
                  {activeTab === 'logistics-arrived' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <MapPin className="mr-2 h-5 w-5" />
                          ÐŸÑ€Ð¸Ð±Ñ‹Ð²ÑˆÐ¸Ðµ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ñ‹ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ ({arrivedTransports.length})
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {arrivedTransports.length === 0 ? (
                            <div className="text-center py-8">
                              <MapPin className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">ÐÐµÑ‚ Ð¿Ñ€Ð¸Ð±Ñ‹Ð²ÑˆÐ¸Ñ… Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð¾Ð² Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ</p>
                            </div>
                          ) : (
                            arrivedTransports.map((transport) => (
                              <Card key={transport.id} className="p-4 border-green-200">
                                <div className="flex justify-between items-start">
                                  <div className="space-y-2 flex-1">
                                    <h3 className="font-semibold text-lg text-green-800">{transport.transport_number}</h3>
                                    <p className="text-sm text-gray-600"><strong>Ð’Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒ:</strong> {transport.driver_name}</p>
                                    <p className="text-sm text-gray-600"><strong>ÐÐ°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ:</strong> {transport.direction}</p>
                                    <p className="text-sm text-gray-600"><strong>Ð“Ñ€ÑƒÐ·:</strong> {transport.current_load_kg} ÐºÐ³ ({transport.cargo_count} Ð¼ÐµÑÑ‚)</p>
                                    <p className="text-sm text-gray-600"><strong>ÐŸÑ€Ð¸Ð±Ñ‹Ð»:</strong> {new Date(transport.arrived_at).toLocaleDateString('ru-RU')} {new Date(transport.arrived_at).toLocaleTimeString('ru-RU')}</p>
                                  </div>
                                  <div className="flex flex-col items-end space-y-2">
                                    <Badge className="bg-green-100 text-green-800">ÐŸÑ€Ð¸Ð±Ñ‹Ð»</Badge>
                                    <Button
                                      size="sm"
                                      onClick={() => {
                                        setSelectedArrivedTransport(transport);
                                        fetchArrivedTransportCargo(transport.id);
                                        setArrivedTransportModal(true);
                                      }}
                                      className="bg-blue-600 hover:bg-blue-700 text-white"
                                    >
                                      <Package className="mr-1 h-3 w-3" />
                                      Ð Ð°Ð·Ð¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·Ñ‹
                                    </Button>
                                  </div>
                                </div>
                              </Card>
                            ))
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ¸ */}
                  {activeTab === 'logistics-history' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center">
                          <FileText className="mr-2 h-5 w-5" />
                          Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð¸Ñ€Ð¾Ð²ÐºÐ¸
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {transports.filter(transport => transport.status === 'completed').map((transport) => (
                            <Card key={transport.id} className="p-4 bg-gray-50">
                              <div className="space-y-2">
                                <div className="flex justify-between items-start">
                                  <h3 className="font-semibold text-lg">{transport.transport_number}</h3>
                                  <Badge variant="outline">Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½Ð¾</Badge>
                                </div>
                                <p className="text-sm text-gray-600"><strong>Ð’Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒ:</strong> {transport.driver_name}</p>
                                <p className="text-sm text-gray-600"><strong>ÐÐ°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ:</strong> {transport.direction}</p>
                                <p className="text-sm text-gray-600"><strong>Ð“Ñ€ÑƒÐ·:</strong> {transport.current_load_kg} ÐºÐ³ ({transport.cargo_list.length} Ð¼ÐµÑÑ‚)</p>
                                <p className="text-sm text-gray-600"><strong>Ð—Ð°Ð²ÐµÑ€ÑˆÐµÐ½:</strong> {transport.completed_at && new Date(transport.completed_at).toLocaleDateString('ru-RU')} {transport.completed_at && new Date(transport.completed_at).toLocaleTimeString('ru-RU')}</p>
                              </div>
                            </Card>
                          ))}
                        </div>
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}

              {/* Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ */}
              {activeSection === 'notifications-management' && (
                <div className="space-y-6">
                  {/* ÐÐžÐ’Ð«Ð• Ð—ÐÐšÐÐ—Ð« ÐžÐ¢ ÐšÐ›Ð˜Ð•ÐÐ¢ÐžÐ’ */}
                  {(activeTab === 'notifications-client-orders' || !activeTab || activeTab === 'notifications-management') && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <ShoppingCart className="mr-2 h-5 w-5 text-orange-600" />
                            ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð°ÐºÐ°Ð·Ñ‹ Ð¾Ñ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² ({newOrdersCount})
                          </div>
                          <div className="space-x-2">
                            <Button onClick={fetchNewOrdersCount} variant="outline" size="sm">
                              <RefreshCw className="w-4 h-4 mr-1" />
                              ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ
                            </Button>
                          </div>
                        </CardTitle>
                        <CardDescription>
                          Ð—Ð°ÐºÐ°Ð·Ñ‹ Ð¾Ñ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² Ñ‡ÐµÑ€ÐµÐ· Ñ„Ð¾Ñ€Ð¼Ñƒ Ð¾Ð½Ð»Ð°Ð¹Ð½-Ð·Ð°ÐºÐ°Ð·Ð° Ñ Ð²Ð¾Ð·Ð¼Ð¾Ð¶Ð½Ð¾ÑÑ‚ÑŒÑŽ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {pendingOrders.length === 0 ? (
                            <div className="text-center py-8">
                              <ShoppingCart className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">ÐÐ¾Ð²Ñ‹Ñ… Ð·Ð°ÐºÐ°Ð·Ð¾Ð² Ð¾Ñ‚ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð² Ð½ÐµÑ‚</p>
                            </div>
                          ) : (
                            pendingOrders.map((order) => (
                              <div key={order.id} className="border rounded-lg p-6 bg-orange-50 hover:bg-orange-100 transition-colors">
                                <div className="flex justify-between items-start mb-4">
                                  <div>
                                    <h3 className="text-lg font-semibold text-orange-800">
                                      Ð—Ð°ÐºÐ°Ð· â„–{order.request_number}
                                    </h3>
                                    <p className="text-sm text-gray-600">
                                      Ð¡Ð¾Ð·Ð´Ð°Ð½: {new Date(order.created_at).toLocaleDateString('ru-RU')} {new Date(order.created_at).toLocaleTimeString('ru-RU')}
                                    </p>
                                  </div>
                                  <div className="flex flex-col items-end space-y-2">
                                    <Badge variant="destructive" className="bg-orange-100 text-orange-800 border-orange-200">
                                      ÐÐ¾Ð²Ñ‹Ð¹ Ð·Ð°ÐºÐ°Ð·
                                    </Badge>
                                    {order.admin_notes && (
                                      <Badge variant="outline" className="text-blue-600 border-blue-200">
                                        Ð•ÑÑ‚ÑŒ Ð·Ð°Ð¼ÐµÑ‚ÐºÐ¸
                                      </Badge>
                                    )}
                                  </div>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-4">
                                  <div className="space-y-3">
                                    <h4 className="font-medium text-gray-900 flex items-center">
                                      <User className="w-4 h-4 mr-1" />
                                      ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ
                                    </h4>
                                    <div className="text-sm text-gray-600 space-y-1 pl-5">
                                      <p><strong>Ð¤Ð˜Ðž:</strong> {order.sender_full_name}</p>
                                      <p><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:</strong> {order.sender_phone}</p>
                                      <p><strong>ÐÐ´Ñ€ÐµÑ Ð·Ð°Ð±Ð¾Ñ€Ð°:</strong> {order.pickup_address}</p>
                                    </div>
                                  </div>
                                  
                                  <div className="space-y-3">
                                    <h4 className="font-medium text-gray-900 flex items-center">
                                      <MapPin className="w-4 h-4 mr-1" />
                                      ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ
                                    </h4>
                                    <div className="text-sm text-gray-600 space-y-1 pl-5">
                                      <p><strong>Ð¤Ð˜Ðž:</strong> {order.recipient_full_name}</p>
                                      <p><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:</strong> {order.recipient_phone}</p>
                                      <p><strong>ÐÐ´Ñ€ÐµÑ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸:</strong> {order.recipient_address}</p>
                                    </div>
                                  </div>
                                </div>

                                <div className="mb-4 p-4 bg-white/50 rounded-lg">
                                  <h4 className="font-medium text-gray-900 mb-2 flex items-center">
                                    <Package className="w-4 h-4 mr-1" />
                                    Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ
                                  </h4>
                                  <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm text-gray-600">
                                    <div>
                                      <p><strong>ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ:</strong> {order.cargo_name}</p>
                                      <p><strong>ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ:</strong> {order.description}</p>
                                    </div>
                                    <div>
                                      <p><strong>Ð’ÐµÑ:</strong> {order.weight} ÐºÐ³</p>
                                      <p><strong>Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ:</strong> {order.declared_value} â‚½</p>
                                    </div>
                                    <div>
                                      <p><strong>ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚:</strong> {order.route === 'moscow_to_tajikistan' ? 'ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½' : 'Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½ â†’ ÐœÐ¾ÑÐºÐ²Ð°'}</p>
                                    </div>
                                  </div>
                                </div>

                                {order.admin_notes && (
                                  <div className="mb-4 p-3 bg-blue-50 border-l-4 border-blue-400 rounded">
                                    <p className="text-sm text-blue-800">
                                      <strong>Ð—Ð°Ð¼ÐµÑ‚ÐºÐ¸ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°:</strong> {order.admin_notes}
                                    </p>
                                  </div>
                                )}

                                <div className="flex flex-wrap gap-2 pt-4 border-t border-orange-200">
                                  <Button 
                                    onClick={() => handleOrderDetailsView(order)}
                                    variant="outline" 
                                    size="sm"
                                    className="flex items-center"
                                  >
                                    <Eye className="w-4 h-4 mr-1" />
                                    ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ÐµÑ‚ÑŒ
                                  </Button>
                                  <Button 
                                    onClick={() => handleOrderEdit(order)}
                                    variant="outline" 
                                    size="sm"
                                    className="flex items-center text-blue-600 border-blue-200 hover:bg-blue-50"
                                  >
                                    <Edit className="w-4 h-4 mr-1" />
                                    Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ
                                  </Button>
                                  <Button 
                                    onClick={() => handleAcceptOrder(order.id)}
                                    size="sm"
                                    className="flex items-center bg-green-600 hover:bg-green-700"
                                  >
                                    <CheckCircle className="w-4 h-4 mr-1" />
                                    ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ Ð·Ð°ÐºÐ°Ð·
                                  </Button>
                                  <Button 
                                    onClick={() => handleRejectOrder(order.id, 'Ð—Ð°ÐºÐ°Ð· Ð¾Ñ‚ÐºÐ»Ð¾Ð½ÐµÐ½ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼')}
                                    variant="destructive" 
                                    size="sm"
                                    className="flex items-center"
                                  >
                                    <XCircle className="w-4 h-4 mr-1" />
                                    ÐžÑ‚ÐºÐ»Ð¾Ð½Ð¸Ñ‚ÑŒ
                                  </Button>
                                </div>
                              </div>
                            ))
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð°ÑÐ²ÐºÐ¸ */}
                  {(activeTab === 'notifications-requests' || !activeTab || activeTab === 'notifications-management') && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Bell className="mr-2 h-5 w-5" />
                            ÐÐ¾Ð²Ñ‹Ðµ Ð·Ð°ÑÐ²ÐºÐ¸ ({cargoRequests.length})
                          </div>
                          <div className="flex space-x-2">
                            {selectedRequests.length > 0 && (
                              <Button
                                onClick={handleBulkDeleteRequests}
                                variant="outline"
                                className="text-red-600 border-red-300 hover:bg-red-50"
                              >
                                <Trash2 className="mr-2 h-4 w-4" />
                                Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ñ‹Ðµ ({selectedRequests.length})
                              </Button>
                            )}
                            <Button onClick={fetchCargoRequests}>
                              ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ
                            </Button>
                          </div>
                        </CardTitle>
                        <CardDescription>
                          Ð—Ð°ÑÐ²ÐºÐ¸ Ð¾Ñ‚ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÐµÐ¹ Ð½Ð° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÑƒ Ð³Ñ€ÑƒÐ·Ð¾Ð²
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        {cargoRequests.length > 0 && (
                          <div className="flex items-center space-x-2 mb-4 p-3 bg-gray-50 rounded-lg">
                            <input
                              type="checkbox"
                              checked={selectAllRequests}
                              onChange={(e) => handleSelectAllRequests(e.target.checked, cargoRequests)}
                              className="rounded border-gray-300"
                            />
                            <label className="text-sm font-medium text-gray-700">
                              Ð’Ñ‹Ð±Ñ€Ð°Ñ‚ÑŒ Ð²ÑÐµ ({cargoRequests.length})
                            </label>
                          </div>
                        )}
                        <div className="space-y-4">
                          {cargoRequests.length === 0 ? (
                            <div className="text-center py-8">
                              <Bell className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">ÐÐ¾Ð²Ñ‹Ñ… Ð·Ð°ÑÐ²Ð¾Ðº Ð½ÐµÑ‚</p>
                            </div>
                          ) : (
                            cargoRequests.map((request) => (
                              <div key={request.id} className="border rounded-lg p-6 bg-blue-50">
                                <div className="flex justify-between items-start mb-4">
                                  <div className="flex items-start space-x-3">
                                    <input
                                      type="checkbox"
                                      checked={selectedRequests.includes(request.id)}
                                      onChange={(e) => handleRequestSelect(request.id, e.target.checked)}
                                      className="mt-1 rounded border-gray-300"
                                    />
                                    <div>
                                      <h3 className="text-lg font-semibold text-blue-800">{request.request_number}</h3>
                                      <p className="text-sm text-gray-600">ÐŸÐ¾Ð´Ð°Ð½Ð°: {new Date(request.created_at).toLocaleDateString('ru-RU')} {new Date(request.created_at).toLocaleTimeString('ru-RU')}</p>
                                    </div>
                                  </div>
                                  <div className="flex items-center space-x-2">
                                    <Button
                                      size="sm"
                                      variant="outline"
                                      onClick={() => handleDeleteRequest(request.id)}
                                      className="text-red-600 border-red-300 hover:bg-red-50"
                                      title="Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð·Ð°ÑÐ²ÐºÑƒ"
                                    >
                                      <Trash2 className="h-4 w-4" />
                                    </Button>
                                    <Badge variant="secondary">ÐÐ¾Ð²Ð°Ñ Ð·Ð°ÑÐ²ÐºÐ°</Badge>
                                  </div>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                  <div className="space-y-2">
                                    <h4 className="font-medium text-gray-900">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ</h4>
                                    <div className="text-sm text-gray-600">
                                      <p><strong>Ð¤Ð˜Ðž:</strong> {request.sender_full_name}</p>
                                      <p><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:</strong> {request.sender_phone}</p>
                                      <p><strong>ÐÐ´Ñ€ÐµÑ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸:</strong> {request.pickup_address}</p>
                                    </div>
                                  </div>
                                  
                                  <div className="space-y-2">
                                    <h4 className="font-medium text-gray-900">ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ</h4>
                                    <div className="text-sm text-gray-600">
                                      <p><strong>Ð¤Ð˜Ðž:</strong> {request.recipient_full_name}</p>
                                      <p><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:</strong> {request.recipient_phone}</p>
                                      <p><strong>ÐÐ´Ñ€ÐµÑ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ:</strong> {request.recipient_address}</p>
                                    </div>
                                  </div>
                                </div>

                                <div className="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                  <div>
                                    <h4 className="font-medium text-gray-900">Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ</h4>
                                    <div className="text-sm text-gray-600">
                                      <p><strong>ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ:</strong> {request.cargo_name}</p>
                                      <p><strong>Ð’ÐµÑ:</strong> {request.weight} ÐºÐ³</p>
                                      <p><strong>Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ:</strong> {request.declared_value} â‚½</p>
                                    </div>
                                  </div>
                                  
                                  <div>
                                    <h4 className="font-medium text-gray-900">ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚</h4>
                                    <div className="text-sm text-gray-600">
                                      <p>{request.route === 'moscow_to_tajikistan' ? 'ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½' : 'Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½ â†’ ÐœÐ¾ÑÐºÐ²Ð°'}</p>
                                    </div>
                                  </div>
                                  
                                  <div>
                                    <h4 className="font-medium text-gray-900">ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ</h4>
                                    <div className="text-sm text-gray-600">
                                      <p>{request.description}</p>
                                    </div>
                                  </div>
                                </div>

                                <div className="flex space-x-3 pt-4 border-t">
                                  <Button
                                    onClick={() => handleAcceptRequest(request.id)}
                                    className="flex-1 bg-green-600 hover:bg-green-700"
                                  >
                                    <CheckCircle className="mr-2 h-4 w-4" />
                                    ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ Ð·Ð°ÑÐ²ÐºÑƒ
                                  </Button>
                                  <Button
                                    variant="outline"
                                    onClick={() => {
                                      const reason = prompt('ÐŸÑ€Ð¸Ñ‡Ð¸Ð½Ð° Ð¾Ñ‚ÐºÐ»Ð¾Ð½ÐµÐ½Ð¸Ñ (Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾):');
                                      handleRejectRequest(request.id, reason || '');
                                    }}
                                    className="flex-1 text-red-600 border-red-300 hover:bg-red-50"
                                  >
                                    <X className="mr-2 h-4 w-4" />
                                    ÐžÑ‚ÐºÐ»Ð¾Ð½Ð¸Ñ‚ÑŒ
                                  </Button>
                                </div>
                              </div>
                            ))
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ */}
                  {activeTab === 'notifications-system' && (
                    <Card>
                      <CardHeader>
                        <CardTitle className="flex items-center justify-between">
                          <div className="flex items-center">
                            <Bell className="mr-2 h-5 w-5" />
                            Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ðµ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ ({notifications.length})
                          </div>
                          <Button onClick={fetchNotifications}>
                            ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ
                          </Button>
                        </CardTitle>
                        <CardDescription>
                          Ð£Ð²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ Ð¾Ð± Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸ÑÑ… ÑÑ‚Ð°Ñ‚ÑƒÑÐ¾Ð² Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð¸ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸ÑÑ…
                        </CardDescription>
                      </CardHeader>
                      <CardContent>
                        <div className="space-y-4">
                          {notifications.length === 0 ? (
                            <div className="text-center py-8">
                              <Bell className="mx-auto h-12 w-12 text-gray-400 mb-4" />
                              <p className="text-gray-500">Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð½Ñ‹Ñ… ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ð¹ Ð½ÐµÑ‚</p>
                            </div>
                          ) : (
                            notifications.map((notification) => (
                              <div
                                key={notification.id}
                                className={`border rounded-lg p-4 ${
                                  !notification.is_read ? 'bg-blue-50 border-blue-200' : 'bg-gray-50'
                                }`}
                              >
                                <div className="flex justify-between items-start">
                                  <div className="flex-1">
                                    <h4 className="font-semibold text-gray-900">{notification.title}</h4>
                                    <p className="text-sm text-gray-600 mt-1">{notification.message}</p>
                                    <div className="flex items-center mt-2 text-xs text-gray-500">
                                      <span>Ð¢Ð¸Ð¿: {
                                        notification.notification_type === 'request' ? 'Ð—Ð°ÑÐ²ÐºÐ°' :
                                        notification.notification_type === 'cargo_status' ? 'Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð³Ñ€ÑƒÐ·Ð°' :
                                        notification.notification_type === 'payment' ? 'ÐžÐ¿Ð»Ð°Ñ‚Ð°' : 'Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð°'
                                      }</span>
                                      <span className="ml-4">
                                        {new Date(notification.created_at).toLocaleDateString('ru-RU')} {new Date(notification.created_at).toLocaleTimeString('ru-RU')}
                                      </span>
                                    </div>
                                  </div>
                                  {!notification.is_read && (
                                    <Badge variant="secondary" className="ml-2">ÐÐ¾Ð²Ð¾Ðµ</Badge>
                                  )}
                                </div>
                              </div>
                            ))
                          )}
                        </div>
                      </CardContent>
                    </Card>
                  )}
                </div>
              )}
            </div>
          )}
        </main>
      </div>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð¿Ñ€Ð¸ÐµÐ¼Ð° Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ */}
      <Dialog open={paymentModal} onOpenChange={setPaymentModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>ÐŸÑ€Ð¸Ñ‘Ð¼ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹</DialogTitle>
            <DialogDescription>
              Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð° Ð´Ð»Ñ Ð¿Ð¾Ð¸ÑÐºÐ° Ð¸ Ð¿Ñ€Ð¸ÐµÐ¼Ð° Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <Label htmlFor="cargo_search">ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°</Label>
              <div className="flex space-x-2">
                <Input
                  id="cargo_search"
                  value={paymentForm.cargo_number}
                  onChange={(e) => setPaymentForm({...paymentForm, cargo_number: e.target.value})}
                  placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°"
                />
                <Button onClick={handleSearchCargoForPayment}>
                  <Search className="h-4 w-4" />
                </Button>
              </div>
            </div>

            {cargoForPayment && (
              <div className="border rounded-lg p-4 bg-gray-50">
                <h4 className="font-semibold mb-2">Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ:</h4>
                <div className="space-y-2 text-sm">
                  <p><strong>ÐÐ¾Ð¼ÐµÑ€:</strong> {cargoForPayment.cargo_number}</p>
                  <p><strong>ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ:</strong> {cargoForPayment.sender_full_name}</p>
                  <p><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:</strong> {cargoForPayment.sender_phone}</p>
                  <p><strong>Ð’ÐµÑ:</strong> {cargoForPayment.weight} ÐºÐ³</p>
                  <p><strong>ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ:</strong> {cargoForPayment.description}</p>
                  <p><strong>Ð¡ÑƒÐ¼Ð¼Ð° Ðº Ð¾Ð¿Ð»Ð°Ñ‚Ðµ:</strong> <span className="text-red-600 font-bold">{cargoForPayment.declared_value} â‚½</span></p>
                  <p><strong>Ð”Ð°Ñ‚Ð° Ð¿Ñ€Ð¸ÐµÐ¼Ð°:</strong> {new Date(cargoForPayment.created_at).toLocaleDateString('ru-RU')} {new Date(cargoForPayment.created_at).toLocaleTimeString('ru-RU')}</p>
                </div>
              </div>
            )}

            {cargoForPayment && (
              <>
                <div>
                  <Label htmlFor="amount_paid">Ð¡ÑƒÐ¼Ð¼Ð° Ð¾Ð¿Ð»Ð°Ñ‡ÐµÐ½Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð¾Ð¼</Label>
                  <Input
                    id="amount_paid"
                    type="number"
                    step="0.01"
                    value={paymentForm.amount_paid}
                    onChange={(e) => setPaymentForm({...paymentForm, amount_paid: e.target.value})}
                    placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÑÑƒÐ¼Ð¼Ñƒ"
                  />
                </div>

                <div>
                  <Label htmlFor="transaction_type">Ð¡Ð¿Ð¾ÑÐ¾Ð± Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹</Label>
                  <Select value={paymentForm.transaction_type} onValueChange={(value) => setPaymentForm({...paymentForm, transaction_type: value})}>
                    <SelectTrigger>
                      <SelectValue />
                    </SelectTrigger>
                    <SelectContent>
                      <SelectItem value="cash">ÐÐ°Ð»Ð¸Ñ‡Ð½Ñ‹Ð¼Ð¸</SelectItem>
                      <SelectItem value="card">ÐšÐ°Ñ€Ñ‚Ð¾Ð¹</SelectItem>
                      <SelectItem value="transfer">ÐŸÐµÑ€ÐµÐ²Ð¾Ð´Ð¾Ð¼</SelectItem>
                    </SelectContent>
                  </Select>
                </div>

                <div>
                  <Label htmlFor="notes">ÐŸÑ€Ð¸Ð¼ÐµÑ‡Ð°Ð½Ð¸Ñ (Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾)</Label>
                  <Textarea
                    id="notes"
                    value={paymentForm.notes}
                    onChange={(e) => setPaymentForm({...paymentForm, notes: e.target.value})}
                    placeholder="Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð·Ð°Ð¼ÐµÑ‚ÐºÐ¸..."
                  />
                </div>

                <div className="flex space-x-2 pt-4">
                  <Button onClick={handleProcessPayment} className="flex-1">
                    <CreditCard className="mr-2 h-4 w-4" />
                    ÐžÐ¿Ð»Ð°Ñ‚Ð¸Ñ‚ÑŒ
                  </Button>
                  <Button variant="outline" onClick={() => {
                    setPaymentModal(false);
                    setCargoForPayment(null);
                    setPaymentForm({cargo_number: '', amount_paid: '', transaction_type: 'cash', notes: ''});
                  }}>
                    ÐžÑ‚Ð¼ÐµÐ½Ð°
                  </Button>
                </div>
              </>
            )}
          </div>
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ ÑÑ…ÐµÐ¼Ñ‹ ÑÐºÐ»Ð°Ð´Ð° */}
      <Dialog open={layoutModal} onOpenChange={setLayoutModal}>
        <DialogContent className="max-w-4xl">
          <DialogHeader>
            <DialogTitle>
              Ð¡Ñ…ÐµÐ¼Ð° ÑÐºÐ»Ð°Ð´Ð°: {selectedWarehouseForLayout?.name}
            </DialogTitle>
            <DialogDescription>
              ÐšÐ°Ñ€Ñ‚Ð° Ñ€Ð°ÑÐ¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ Ð±Ð»Ð¾ÐºÐ¾Ð², Ð¿Ð¾Ð»Ð¾Ðº Ð¸ ÑÑ‡ÐµÐµÐº ÑÐºÐ»Ð°Ð´Ð°
            </DialogDescription>
          </DialogHeader>
          
          {warehouseLayout ? (
            <div className="space-y-4">
              {/* Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° ÑÐºÐ»Ð°Ð´Ð° */}
              <div className="grid grid-cols-4 gap-4">
                <div className="text-center p-4 bg-blue-50 rounded">
                  <div className="text-2xl font-bold text-blue-600">{warehouseLayout.total_cells}</div>
                  <div className="text-sm">Ð’ÑÐµÐ³Ð¾ ÑÑ‡ÐµÐµÐº</div>
                </div>
                <div className="text-center p-4 bg-red-50 rounded">
                  <div className="text-2xl font-bold text-red-600">{warehouseLayout.occupied_cells}</div>
                  <div className="text-sm">Ð—Ð°Ð½ÑÑ‚Ð¾</div>
                </div>
                <div className="text-center p-4 bg-green-50 rounded">
                  <div className="text-2xl font-bold text-green-600">{warehouseLayout.total_cells - warehouseLayout.occupied_cells}</div>
                  <div className="text-sm">Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð¾</div>
                </div>
                <div className="text-center p-4 bg-gray-50 rounded">
                  <div className="text-2xl font-bold text-gray-600">{warehouseLayout.occupancy_percentage}%</div>
                  <div className="text-sm">Ð—Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ð¾ÑÑ‚ÑŒ</div>
                </div>
              </div>

              {/* Ð¡Ñ…ÐµÐ¼Ð° ÑÐºÐ»Ð°Ð´Ð° Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÐµÐ¹ Ð¾ Ð³Ñ€ÑƒÐ·Ð°Ñ… */}
              <div className="max-h-96 overflow-auto border rounded-lg p-4">
                <div className="space-y-6">
                  {warehouseLayout.layout && Object.entries(warehouseLayout.layout).map(([blockKey, block]) => (
                    <div key={blockKey} className="border rounded-lg p-4">
                      <h3 className="font-bold mb-3 text-center bg-gray-100 p-2 rounded">
                        Ð‘Ð»Ð¾Ðº {block.block_number}
                      </h3>
                      <div className="space-y-4">
                        {block.shelves && Object.entries(block.shelves).map(([shelfKey, shelf]) => (
                          <div key={shelfKey}>
                            <h4 className="font-semibold mb-2 text-sm bg-gray-50 p-1 rounded">
                              ÐŸÐ¾Ð»ÐºÐ° {shelf.shelf_number}
                            </h4>
                            <div className="grid grid-cols-5 gap-2">
                              {shelf.cells && Object.entries(shelf.cells).slice(0, 10).map(([cellKey, cell]) => (
                                <div
                                  key={cellKey}
                                  className={`p-2 text-xs text-center rounded border-2 transition-all cursor-pointer hover:scale-105 ${
                                    cell.is_occupied 
                                      ? 'bg-red-100 border-red-300 text-red-800 hover:bg-red-200' 
                                      : 'bg-green-100 border-green-300 text-green-800 hover:bg-green-200'
                                  }`}
                                  title={cell.cargo ? `${cell.cargo.cargo_number} - ${cell.cargo.sender_full_name}` : 'Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð°Ñ ÑÑ‡ÐµÐ¹ÐºÐ°'}
                                  onClick={() => {
                                    if (cell.is_occupied && cell.cargo) {
                                      setSelectedCargoForWarehouse(cell.cargo);
                                      setCargoDetailsModal(true);
                                    } else {
                                      showAlert('Ð¯Ñ‡ÐµÐ¹ÐºÐ° ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð°', 'info');
                                    }
                                  }}
                                >
                                  <div className="font-bold">Ð¯{cell.cell_number}</div>
                                  {cell.cargo && (
                                    <div className="mt-1">
                                      <div className="font-semibold text-[9px]">{cell.cargo.cargo_number}</div>
                                      <div className="text-[8px]">{cell.cargo.weight}ÐºÐ³</div>
                                    </div>
                                  )}
                                </div>
                              ))}
                            </div>
                          </div>
                        ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>

              <div className="flex items-center justify-center space-x-4 text-sm">
                <div className="flex items-center">
                  <div className="w-4 h-4 bg-green-100 border-2 border-green-300 rounded mr-2"></div>
                  <span>Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð°Ñ ÑÑ‡ÐµÐ¹ÐºÐ°</span>
                </div>
                <div className="flex items-center">
                  <div className="w-4 h-4 bg-red-100 border-2 border-red-300 rounded mr-2"></div>
                  <span>Ð—Ð°Ð½ÑÑ‚Ð°Ñ ÑÑ‡ÐµÐ¹ÐºÐ°</span>
                </div>
              </div>
            </div>
          ) : (
            <div className="text-center py-8">
              <Package className="mx-auto h-12 w-12 text-gray-400 mb-4" />
              <p className="text-gray-500 mb-4">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÑ…ÐµÐ¼Ñ‹ ÑÐºÐ»Ð°Ð´Ð°...</p>
              <p className="text-sm text-gray-400">
                Ð•ÑÐ»Ð¸ ÑÑ…ÐµÐ¼Ð° Ð½Ðµ Ð·Ð°Ð³Ñ€ÑƒÐ¶Ð°ÐµÑ‚ÑÑ, Ð¿Ñ€Ð¾Ð²ÐµÑ€ÑŒÑ‚Ðµ Ð¿Ð¾Ð´ÐºÐ»ÑŽÑ‡ÐµÐ½Ð¸Ðµ Ð¸Ð»Ð¸ Ð¾Ð±Ñ€Ð°Ñ‚Ð¸Ñ‚ÐµÑÑŒ Ðº Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ñƒ.
              </p>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð¾Ð¼ */}
      <Dialog open={transportManagementModal} onOpenChange={setTransportManagementModal}>
        <DialogContent className="max-w-6xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð¾Ð¼ {selectedTransport?.transport_number}
            </DialogTitle>
            <DialogDescription>
              ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð¾Ð¼
            </DialogDescription>
          </DialogHeader>
          
          {selectedTransport && (
            <div className="space-y-6">
              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ðµ */}
              <div className="bg-gray-50 p-4 rounded-lg">
                <h3 className="font-semibold mb-2">Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ðµ</h3>
                <div className="grid grid-cols-3 gap-4 text-sm">
                  <p><strong>ÐÐ¾Ð¼ÐµÑ€:</strong> {selectedTransport.transport_number}</p>
                  <p><strong>Ð’Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒ:</strong> {selectedTransport.driver_name}</p>
                  <p><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:</strong> {selectedTransport.driver_phone}</p>
                  <p><strong>ÐÐ°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ:</strong> {selectedTransport.direction}</p>
                  <p><strong>Ð’Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚ÑŒ:</strong> {selectedTransport.capacity_kg} ÐºÐ³</p>
                  <p><strong>Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ°:</strong> {selectedTransport.current_load_kg} ÐºÐ³</p>
                  <p><strong>ÐŸÑ€Ð¾Ñ†ÐµÐ½Ñ‚ Ð·Ð°Ð³Ñ€ÑƒÐ·ÐºÐ¸:</strong> {Math.round((selectedTransport.current_load_kg / selectedTransport.capacity_kg) * 100)}%</p>
                  <p><strong>Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:</strong> 
                    <Badge className="ml-2" variant={selectedTransport.status === 'empty' ? 'secondary' : 'default'}>
                      {selectedTransport.status === 'empty' ? 'ÐŸÑƒÑÑ‚Ð¾Ð¹' : selectedTransport.status === 'filled' ? 'Ð—Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾' : selectedTransport.status}
                    </Badge>
                  </p>
                  <p><strong>ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²:</strong> {transportCargoList.cargo_count || 0} Ð¼ÐµÑÑ‚</p>
                </div>
              </div>

              {/* Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð² */}
              <Card className="p-4">
                <div className="flex justify-between items-center mb-4">
                  <h4 className="font-semibold">Ð“Ñ€ÑƒÐ·Ñ‹ Ð½Ð° Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ðµ ({transportCargoList.cargo_count || 0} Ð¼ÐµÑÑ‚)</h4>
                  <div className="flex space-x-2">
                    <Button
                      variant="outline"
                      size="sm"
                      onClick={() => {
                        if (transportCargoList.cargo_list && transportCargoList.cargo_list.length > 0) {
                          printTransportCargoList(selectedTransport, transportCargoList.cargo_list);
                        }
                      }}
                    >
                      <Printer className="h-4 w-4 mr-2" />
                      ÐŸÐµÑ‡Ð°Ñ‚ÑŒ ÑÐ¿Ð¸ÑÐºÐ°
                    </Button>
                  </div>
                </div>
                
                <div className="max-h-60 overflow-y-auto border rounded">
                  {!transportCargoList.cargo_list || transportCargoList.cargo_list.length === 0 ? (
                    <p className="p-4 text-gray-500 text-center">Ð“Ñ€ÑƒÐ· Ð½Ðµ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½</p>
                  ) : (
                    <div className="space-y-2 p-2">
                      {transportCargoList.cargo_list.map((cargo, index) => (
                        <div key={cargo.id} className="flex justify-between items-center p-3 bg-gray-50 rounded border">
                          <div className="flex-1">
                            <div className="flex items-center space-x-4">
                              <div>
                                <p className="font-medium">{cargo.cargo_number}</p>
                                <p className="text-sm text-gray-600">{cargo.cargo_name || 'Ð“Ñ€ÑƒÐ·'}</p>
                              </div>
                              <div>
                                <p className="text-sm"><strong>Ð’ÐµÑ:</strong> {cargo.weight} ÐºÐ³</p>
                                <p className="text-sm"><strong>ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ:</strong> {cargo.recipient_name}</p>
                              </div>
                            </div>
                            <div className="mt-2 text-xs text-gray-500">
                              <p><strong>ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ:</strong> {cargo.sender_full_name || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½'} - {cargo.sender_phone || 'ÐÐµÑ‚ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°'}</p>
                              <p><strong>ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ:</strong> {cargo.recipient_full_name || cargo.recipient_name} - {cargo.recipient_phone || 'ÐÐµÑ‚ Ñ‚ÐµÐ»ÐµÑ„Ð¾Ð½Ð°'}</p>
                              {cargo.recipient_address && (
                                <p><strong>ÐÐ´Ñ€ÐµÑ:</strong> {cargo.recipient_address}</p>
                              )}
                            </div>
                          </div>
                          
                          <div className="flex space-x-2">
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={async () => {
                                try {
                                  const fullCargoDetails = await fetchCargoDetails(cargo.id);
                                  setSelectedCellCargo(fullCargoDetails);
                                  setCargoDetailModal(true);
                                } catch (error) {
                                  console.error('Error fetching cargo details:', error);
                                }
                              }}
                            >
                              <User className="h-4 w-4" />
                            </Button>
                            
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={() => printCargoQrLabel(cargo)}
                              title="ÐŸÐµÑ‡Ð°Ñ‚ÑŒ QR ÑÑ‚Ð¸ÐºÐµÑ‚ÐºÐ¸"
                            >
                              <QrCode className="h-4 w-4" />
                            </Button>
                            
                            <Button
                              size="sm"
                              variant="outline"
                              onClick={async () => {
                                if (window.confirm(`Ð’ÐµÑ€Ð½ÑƒÑ‚ÑŒ Ð³Ñ€ÑƒÐ· ${cargo.cargo_number} Ð² Ð¸ÑÑ…Ð¾Ð´Ð½Ð¾Ðµ Ð¼ÐµÑÑ‚Ð¾ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ?`)) {
                                  try {
                                    // Return cargo to its original warehouse location
                                    await apiCall(`/api/transport/${selectedTransport.id}/remove-cargo/${cargo.id}`, 'DELETE');
                                    showAlert(`Ð“Ñ€ÑƒÐ· ${cargo.cargo_number} Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‰ÐµÐ½ Ð½Ð° ÑÐºÐ»Ð°Ð´!`, 'success');
                                    fetchTransportCargoList(selectedTransport.id);
                                    fetchTransports();
                                  } catch (error) {
                                    console.error('Error returning cargo:', error);
                                    showAlert('ÐžÑˆÐ¸Ð±ÐºÐ° Ð¿Ñ€Ð¸ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ðµ Ð³Ñ€ÑƒÐ·Ð° Ð½Ð° ÑÐºÐ»Ð°Ð´', 'error');
                                  }
                                }
                              }}
                              className="text-orange-600 hover:text-orange-700"
                            >
                              <Package className="h-4 w-4" />
                            </Button>
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
                
                {transportCargoList.cargo_list && transportCargoList.cargo_list.length > 0 && (
                  <div className="mt-4 p-3 bg-blue-50 rounded">
                    <p className="text-sm"><strong>ÐžÐ±Ñ‰Ð¸Ð¹ Ð²ÐµÑ:</strong> {transportCargoList.total_weight || 0} ÐºÐ³</p>
                    <p className="text-sm"><strong>ÐžÑÑ‚Ð°Ñ‚Ð¾Ðº Ð²Ð¼ÐµÑÑ‚Ð¸Ð¼Ð¾ÑÑ‚Ð¸:</strong> {selectedTransport.capacity_kg - (transportCargoList.total_weight || 0)} ÐºÐ³</p>
                  </div>
                )}
              </Card>

              {/* Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð³Ñ€ÑƒÐ·Ð° */}
              <Card className="p-4">
                <h4 className="font-semibold mb-3">Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð³Ñ€ÑƒÐ·Ð°</h4>
                <p className="text-sm text-gray-600 mb-4">
                  Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€Ð° Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð½Ð° Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚
                </p>
                
                <div className="mb-4">
                  <Label htmlFor="cargo-numbers">ÐÐ¾Ð¼ÐµÑ€Ð° Ð³Ñ€ÑƒÐ·Ð¾Ð² (Ñ‡ÐµÑ€ÐµÐ· Ð·Ð°Ð¿ÑÑ‚ÑƒÑŽ):</Label>
                  <Input
                    id="cargo-numbers"
                    placeholder="ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: 1001, 1002, 1003"
                    value={selectedCargoForPlacement.join(', ')}
                    onChange={(e) => {
                      const cargoNumbers = e.target.value.split(',').map(num => num.trim()).filter(num => num);
                      setSelectedCargoForPlacement(cargoNumbers);
                    }}
                    className="mt-2"
                  />
                  <p className="text-xs text-gray-500 mt-1">
                    Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€Ð° Ð³Ñ€ÑƒÐ·Ð¾Ð² Ñ‡ÐµÑ€ÐµÐ· Ð·Ð°Ð¿ÑÑ‚ÑƒÑŽ. Ð“Ñ€ÑƒÐ·Ñ‹ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ Ð½Ð°Ñ…Ð¾Ð´Ð¸Ñ‚ÑŒÑÑ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ.
                  </p>
                </div>
                
                <Button 
                  onClick={() => handlePlaceCargoOnTransport(selectedTransport.id, selectedCargoForPlacement)}
                  disabled={selectedCargoForPlacement.length === 0}
                  className="w-full"
                >
                  Ð Ð°Ð·Ð¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·
                </Button>
              </Card>

              {/* Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ Ñ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð¾Ð¼ */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                
                {/* ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ */}
                <Card className="p-4">
                  <h4 className="font-semibold mb-3">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚</h4>
                  <p className="text-sm text-gray-600 mb-4">
                    ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ Ð² Ð¼ÐµÑÑ‚Ð¾ Ð½Ð°Ð·Ð½Ð°Ñ‡ÐµÐ½Ð¸Ñ Ñ Ð»ÑŽÐ±Ñ‹Ð¼ ÐºÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾Ð¼ Ð³Ñ€ÑƒÐ·Ð°
                  </p>
                  <Button 
                    onClick={() => handleDispatchTransport(selectedTransport.id)}
                    disabled={selectedTransport.status === 'in_transit'}
                    className="w-full"
                  >
                    {selectedTransport.status === 'in_transit' ? 'Ð¢Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ ÑƒÐ¶Ðµ Ð² Ð¿ÑƒÑ‚Ð¸' : 'ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÑŒ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚'}
                  </Button>
                </Card>

                {/* Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ */}
                <Card className="p-4">
                  <h4 className="font-semibold mb-3">Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚</h4>
                  <p className="text-sm text-gray-600 mb-4">
                    Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ Ð¸ Ð¿ÐµÑ€ÐµÐ¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ Ð² Ð¸ÑÑ‚Ð¾Ñ€Ð¸ÑŽ
                  </p>
                  <Button 
                    onClick={() => handleDeleteTransport(selectedTransport.id)}
                    variant="destructive"
                    className="w-full"
                  >
                    Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚
                  </Button>
                </Card>

              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ "Ð¡Ð²ÑÐ·Ð°Ñ‚ÑŒÑÑ Ñ Ð½Ð°Ð¼Ð¸" */}
      <Dialog open={contactModal} onOpenChange={setContactModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <MessageCircle className="mr-2 h-5 w-5" />
              Ð¡Ð²ÑÐ·Ð°Ñ‚ÑŒÑÑ Ñ Ð½Ð°Ð¼Ð¸
            </DialogTitle>
            <DialogDescription>
              Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑƒÐ´Ð¾Ð±Ð½Ñ‹Ð¹ ÑÐ¿Ð¾ÑÐ¾Ð± ÑÐ²ÑÐ·Ð¸ Ñ Ð½Ð°ÑˆÐµÐ¹ ÑÐ»ÑƒÐ¶Ð±Ð¾Ð¹ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4">
            {/* WhatsApp */}
            <Card className="p-4 hover:bg-green-50 cursor-pointer transition-colors" onClick={handleWhatsAppContact}>
              <div className="flex items-center space-x-4">
                <div className="w-12 h-12 bg-green-500 rounded-full flex items-center justify-center">
                  <MessageCircle className="w-6 h-6 text-white" />
                </div>
                <div className="flex-1">
                  <h3 className="font-semibold text-green-700">WhatsApp</h3>
                  <p className="text-sm text-gray-600">Ð‘Ñ‹ÑÑ‚Ñ€Ð°Ñ ÑÐ²ÑÐ·ÑŒ Ñ‡ÐµÑ€ÐµÐ· Ð¼ÐµÑÑÐµÐ½Ð´Ð¶ÐµÑ€</p>
                  <p className="text-xs text-gray-500">+7 (912) 345-67-89</p>
                </div>
                <div className="text-green-500">
                  <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
                  </svg>
                </div>
              </div>
            </Card>

            {/* Telegram */}
            <Card className="p-4 hover:bg-blue-50 cursor-pointer transition-colors" onClick={handleTelegramContact}>
              <div className="flex items-center space-x-4">
                <div className="w-12 h-12 bg-blue-500 rounded-full flex items-center justify-center">
                  <MessageCircle className="w-6 h-6 text-white" />
                </div>
                <div className="flex-1">
                  <h3 className="font-semibold text-blue-700">Telegram</h3>
                  <p className="text-sm text-gray-600">ÐžÐ±Ñ‰ÐµÐ½Ð¸Ðµ Ð² Ð¼ÐµÑÑÐµÐ½Ð´Ð¶ÐµÑ€Ðµ</p>
                  <p className="text-xs text-gray-500">@tajline_support</p>
                </div>
                <div className="text-blue-500">
                  <svg className="w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
                    <path d="M11.944 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0a12 12 0 0 0-.056 0zm4.962 7.224c.1-.002.321.023.465.14a.506.506 0 0 1 .171.325c.016.093.036.306.02.472-.18 1.898-.962 6.502-1.36 8.627-.168.9-.499 1.201-.82 1.23-.696.065-1.225-.46-1.9-.902-1.056-.693-1.653-1.124-2.678-1.8-1.185-.78-.417-1.21.258-1.91.177-.184 3.247-2.977 3.307-3.23.007-.032.014-.15-.056-.212s-.174-.041-.249-.024c-.106.024-1.793 1.14-5.061 3.345-.48.33-.913.49-1.302.48-.428-.008-1.252-.241-1.865-.44-.752-.245-1.349-.374-1.297-.789.027-.216.325-.437.893-.663 3.498-1.524 5.83-2.529 6.998-3.014 3.332-1.386 4.025-1.627 4.476-1.635z"/>
                  </svg>
                </div>
              </div>
            </Card>

            {/* ÐžÐ½Ð»Ð°Ð¹Ð½ Ñ‡Ð°Ñ‚ */}
            <Card className="p-4 hover:bg-purple-50 cursor-pointer transition-colors" onClick={handleOnlineChat}>
              <div className="flex items-center space-x-4">
                <div className="w-12 h-12 bg-purple-500 rounded-full flex items-center justify-center">
                  <MessageCircle className="w-6 h-6 text-white" />
                </div>
                <div className="flex-1">
                  <h3 className="font-semibold text-purple-700">ÐžÐ½Ð»Ð°Ð¹Ð½ Ñ‡Ð°Ñ‚</h3>
                  <p className="text-sm text-gray-600">ÐŸÑ€ÑÐ¼Ð°Ñ ÑÐ²ÑÐ·ÑŒ Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼</p>
                  <p className="text-xs text-gray-500">ÐœÐ³Ð½Ð¾Ð²ÐµÐ½Ð½Ñ‹Ðµ Ð¾Ñ‚Ð²ÐµÑ‚Ñ‹</p>
                </div>
                <div className="text-purple-500">
                  <MessageCircle className="w-5 h-5" />
                </div>
              </div>
            </Card>

            {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ */}
            <div className="bg-gray-50 p-3 rounded-lg">
              <div className="flex items-center space-x-2 mb-2">
                <Clock className="w-4 h-4 text-gray-500" />
                <span className="text-sm font-medium text-gray-700">Ð’Ñ€ÐµÐ¼Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ð¿Ð¾Ð´Ð´ÐµÑ€Ð¶ÐºÐ¸</span>
              </div>
              <p className="text-xs text-gray-600">ÐŸÐ¾Ð½ÐµÐ´ÐµÐ»ÑŒÐ½Ð¸Ðº - ÐŸÑÑ‚Ð½Ð¸Ñ†Ð°: 9:00 - 18:00 (ÐœÐ¡Ðš)</p>
              <p className="text-xs text-gray-600">Ð¡ÑƒÐ±Ð±Ð¾Ñ‚Ð° - Ð’Ð¾ÑÐºÑ€ÐµÑÐµÐ½ÑŒÐµ: 10:00 - 16:00 (ÐœÐ¡Ðš)</p>
              <p className="text-xs text-green-600 mt-1">WhatsApp Ð¸ Telegram Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ 24/7</p>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¸ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° Ðº ÑÐºÐ»Ð°Ð´Ñƒ */}
      <Dialog open={operatorBindingModal} onOpenChange={setOperatorBindingModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>ÐŸÑ€Ð¸Ð²ÑÐ·Ð°Ñ‚ÑŒ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° Ðº ÑÐºÐ»Ð°Ð´Ñƒ</DialogTitle>
            <DialogDescription>
              Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° Ð¸ ÑÐºÐ»Ð°Ð´ Ð´Ð»Ñ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÐ¸
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4">
            <div>
              <Label htmlFor="operator-select">Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°</Label>
              <Select value={selectedOperatorForBinding} onValueChange={setSelectedOperatorForBinding}>
                <SelectTrigger id="operator-select">
                  <SelectValue placeholder="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° ÑÐºÐ»Ð°Ð´Ð°" />
                </SelectTrigger>
                <SelectContent>
                  {usersByRole.warehouse_operator.map((operator) => (
                    <SelectItem key={operator.id} value={operator.id}>
                      {operator.full_name} ({operator.phone})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div>
              <Label htmlFor="warehouse-select">Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐºÐ»Ð°Ð´</Label>
              <Select value={selectedWarehouseForBinding} onValueChange={setSelectedWarehouseForBinding}>
                <SelectTrigger id="warehouse-select">
                  <SelectValue placeholder="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐºÐ»Ð°Ð´" />
                </SelectTrigger>
                <SelectContent>
                  {warehouses.map((warehouse) => (
                    <SelectItem key={warehouse.id} value={warehouse.id}>
                      {warehouse.name} ({warehouse.location})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div className="flex justify-end space-x-2 pt-4">
              <Button
                variant="outline"
                onClick={() => {
                  setOperatorBindingModal(false);
                  setSelectedOperatorForBinding('');
                  setSelectedWarehouseForBinding('');
                }}
              >
                ÐžÑ‚Ð¼ÐµÐ½Ð°
              </Button>
              <Button onClick={handleCreateOperatorBinding}>
                Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð¿Ñ€Ð¸Ð²ÑÐ·ÐºÑƒ
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð³Ñ€ÑƒÐ·Ð° */}
      <Dialog open={cargoDetailModal} onOpenChange={setCargoDetailModal}>
        <DialogContent className="max-w-2xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ {selectedCellCargo?.cargo_number}
            </DialogTitle>
          </DialogHeader>
          
          {selectedCellCargo && (
            <div className="space-y-4">
              {/* ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ */}
              <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                <div>
                  <p><strong>ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°:</strong> {selectedCellCargo.cargo_number}</p>
                  <p><strong>ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ:</strong> {selectedCellCargo.cargo_name || 'ÐÐµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¾'}</p>
                  <p><strong>Ð’ÐµÑ:</strong> {selectedCellCargo.weight} ÐºÐ³</p>
                  <p><strong>Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ:</strong> {selectedCellCargo.declared_value} Ñ€ÑƒÐ±.</p>
                </div>
                <div>
                  <p><strong>Ð”Ð°Ñ‚Ð° Ð¿Ñ€Ð¸Ñ‘Ð¼Ð°:</strong> {new Date(selectedCellCargo.created_at).toLocaleDateString('ru-RU')}</p>
                  <p><strong>Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:</strong> {selectedCellCargo.status}</p>
                  <p><strong>Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹:</strong> {selectedCellCargo.payment_status || 'pending'}</p>
                  {selectedCellCargo.warehouse_location && (
                    <p><strong>ÐœÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ:</strong> {selectedCellCargo.warehouse_location}</p>
                  )}
                </div>
              </div>

              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ðµ */}
              <div className="p-4 border rounded-lg">
                <h3 className="font-semibold mb-2">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ</h3>
                <p><strong>Ð¤Ð˜Ðž:</strong> {selectedCellCargo.sender_full_name}</p>
                <p><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:</strong> {selectedCellCargo.sender_phone}</p>
              </div>

              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ðµ */}
              <div className="p-4 border rounded-lg">
                <h3 className="font-semibold mb-2">ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ</h3>
                <p><strong>Ð¤Ð˜Ðž:</strong> {selectedCellCargo.recipient_full_name || selectedCellCargo.recipient_name}</p>
                <p><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:</strong> {selectedCellCargo.recipient_phone}</p>
                <p><strong>ÐÐ´Ñ€ÐµÑ:</strong> {selectedCellCargo.recipient_address}</p>
              </div>

              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð°Ñ… */}
              <div className="p-4 bg-blue-50 rounded-lg">
                <h3 className="font-semibold mb-2">ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°</h3>
                {selectedCellCargo.created_by_operator && (
                  <p><strong>ÐŸÑ€Ð¸Ð½ÑÐ» Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€:</strong> {selectedCellCargo.created_by_operator}</p>
                )}
                {selectedCellCargo.placed_by_operator && (
                  <p><strong>Ð Ð°Ð·Ð¼ÐµÑÑ‚Ð¸Ð» Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€:</strong> {selectedCellCargo.placed_by_operator}</p>
                )}
              </div>

              {/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ */}
              <div className="flex flex-wrap gap-2 pt-4">
                <Button onClick={() => handleEditCargo(selectedCellCargo)}>
                  <Edit className="mr-2 h-4 w-4" />
                  Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ
                </Button>
                
                {selectedCellCargo.warehouse_location && (
                  <>
                    <Button
                      variant="outline"
                      onClick={() => handleMoveCargo(selectedCellCargo)}
                    >
                      <Package className="mr-2 h-4 w-4" />
                      ÐŸÐµÑ€ÐµÐ¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ
                    </Button>
                    
                    <Button
                      variant="destructive"
                      onClick={() => handleRemoveCargoFromCell(selectedCellCargo)}
                    >
                      <Trash2 className="mr-2 h-4 w-4" />
                      Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¸Ð· ÑÑ‡ÐµÐ¹ÐºÐ¸
                    </Button>
                  </>
                )}
                
                <div className="flex space-x-2">
                  <Button variant="outline" onClick={() => printInvoice(selectedCellCargo)}>
                    <Printer className="mr-2 h-4 w-4" />
                    ÐŸÐµÑ‡Ð°Ñ‚ÑŒ Ð½Ð°ÐºÐ»Ð°Ð´Ð½Ð¾Ð¹
                  </Button>
                  
                  <Button variant="outline" onClick={() => printCargoQrLabel(selectedCellCargo)}>
                    <QrCode className="mr-2 h-4 w-4" />
                    QR ÑÑ‚Ð¸ÐºÐµÑ‚ÐºÐ°
                  </Button>
                </div>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð° */}
      <Dialog open={cargoEditModal} onOpenChange={setCargoEditModal}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle>Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° {editingCargo?.cargo_number}</DialogTitle>
          </DialogHeader>
          
          <div className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="edit_cargo_name">ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°</Label>
                <Input
                  id="edit_cargo_name"
                  value={cargoEditForm.cargo_name || ''}
                  onChange={(e) => setCargoEditForm({...cargoEditForm, cargo_name: e.target.value})}
                />
              </div>
              <div>
                <Label htmlFor="edit_weight">Ð’ÐµÑ (ÐºÐ³)</Label>
                <Input
                  id="edit_weight"
                  type="number"
                  step="0.1"
                  value={cargoEditForm.weight || ''}
                  onChange={(e) => setCargoEditForm({...cargoEditForm, weight: parseFloat(e.target.value)})}
                />
              </div>
            </div>

            <div>
              <Label htmlFor="edit_description">ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ</Label>
              <Textarea
                id="edit_description"
                value={cargoEditForm.description || ''}
                onChange={(e) => setCargoEditForm({...cargoEditForm, description: e.target.value})}
              />
            </div>

            <div className="grid grid-cols-2 gap-4">
              <div>
                <Label htmlFor="edit_sender_name">Ð¤Ð˜Ðž Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ</Label>
                <Input
                  id="edit_sender_name"
                  value={cargoEditForm.sender_full_name || ''}
                  onChange={(e) => setCargoEditForm({...cargoEditForm, sender_full_name: e.target.value})}
                />
              </div>
              <div>
                <Label htmlFor="edit_sender_phone">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ</Label>
                <Input
                  id="edit_sender_phone"
                  value={cargoEditForm.sender_phone || ''}
                  onChange={(e) => setCargoEditForm({...cargoEditForm, sender_phone: e.target.value})}
                />
              </div>
            </div>

            <div className="flex justify-end space-x-2 pt-4">
              <Button variant="outline" onClick={() => setCargoEditModal(false)}>
                ÐžÑ‚Ð¼ÐµÐ½Ð°
              </Button>
              <Button onClick={handleUpdateCargo}>
                Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð° */}
      <Dialog open={cargoMoveModal} onOpenChange={setCargoMoveModal}>
        <DialogContent>
          <DialogHeader>
            <DialogTitle>ÐŸÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° {editingCargo?.cargo_number}</DialogTitle>
          </DialogHeader>
          
          <div className="space-y-4">
            <div>
              <Label htmlFor="move_warehouse">Ð¡ÐºÐ»Ð°Ð´</Label>
              <Select
                value={cargoMoveForm.warehouse_id}
                onValueChange={(value) => setCargoMoveForm({...cargoMoveForm, warehouse_id: value})}
              >
                <SelectTrigger>
                  <SelectValue placeholder="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐºÐ»Ð°Ð´" />
                </SelectTrigger>
                <SelectContent>
                  {warehouses.map((warehouse) => (
                    <SelectItem key={warehouse.id} value={warehouse.id}>
                      {warehouse.name}
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div className="grid grid-cols-3 gap-4">
              <div>
                <Label htmlFor="move_block">Ð‘Ð»Ð¾Ðº</Label>
                <Input
                  id="move_block"
                  type="number"
                  min="1"
                  value={cargoMoveForm.block_number}
                  onChange={(e) => setCargoMoveForm({...cargoMoveForm, block_number: parseInt(e.target.value)})}
                />
              </div>
              <div>
                <Label htmlFor="move_shelf">ÐŸÐ¾Ð»ÐºÐ°</Label>
                <Input
                  id="move_shelf"
                  type="number"
                  min="1"
                  value={cargoMoveForm.shelf_number}
                  onChange={(e) => setCargoMoveForm({...cargoMoveForm, shelf_number: parseInt(e.target.value)})}
                />
              </div>
              <div>
                <Label htmlFor="move_cell">Ð¯Ñ‡ÐµÐ¹ÐºÐ°</Label>
                <Input
                  id="move_cell"
                  type="number"
                  min="1"
                  value={cargoMoveForm.cell_number}
                  onChange={(e) => setCargoMoveForm({...cargoMoveForm, cell_number: parseInt(e.target.value)})}
                />
              </div>
            </div>

            <div className="flex justify-end space-x-2 pt-4">
              <Button variant="outline" onClick={() => setCargoMoveModal(false)}>
                ÐžÑ‚Ð¼ÐµÐ½Ð°
              </Button>
              <Button onClick={handleMoveCargoSubmit}>
                ÐŸÐµÑ€ÐµÐ¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* Alerts */}
      <div className="fixed top-4 right-4 space-y-2 z-50">
        {alerts.map((alert) => (
          <Alert key={alert.id} className={`max-w-sm ${alert.type === 'error' ? 'border-red-500' : alert.type === 'success' ? 'border-green-500' : 'border-blue-500'}`}>
            <AlertDescription>{alert.message}</AlertDescription>
          </Alert>
        ))}
      </div>

      {/* QR Scanner Modal */}
      <Dialog open={qrScannerModal} onOpenChange={setQrScannerModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>
              <Camera className="mr-2 h-5 w-5 inline" />
              Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ QR ÐºÐ¾Ð´
            </DialogTitle>
          </DialogHeader>
          
          <div className="space-y-4">
            <div className="text-center">
              <div className="w-64 h-64 bg-gray-100 border-2 border-dashed border-gray-300 rounded-lg flex items-center justify-center mx-auto mb-4">
                <div className="text-center">
                  <Camera className="w-12 h-12 text-gray-400 mx-auto mb-2" />
                  <p className="text-sm text-gray-500">QR ÑÐºÐ°Ð½ÐµÑ€</p>
                  <p className="text-xs text-gray-400 mt-1">ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° QR ÐºÐ¾Ð´</p>
                </div>
              </div>
              
              <p className="text-sm text-gray-600 mb-4">
                ÐžÑ‚ÑÐºÐ°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð° Ð¸Ð»Ð¸ ÑÑ‡ÐµÐ¹ÐºÐ¸ ÑÐºÐ»Ð°Ð´Ð° Ð´Ð»Ñ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ Ð´Ð¾ÑÑ‚ÑƒÐ¿Ð° Ðº Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸
              </p>
              
              {/* Manual input for testing */}
              <div className="text-left">
                <Label htmlFor="manual-qr">Ð˜Ð»Ð¸ Ð²Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ QR ÐºÐ¾Ð´Ð° Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ:</Label>
                <textarea
                  id="manual-qr"
                  className="w-full mt-2 p-3 border rounded-md"
                  rows="4"
                  placeholder="Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ ÑÐ¾Ð´ÐµÑ€Ð¶Ð¸Ð¼Ð¾Ðµ QR ÐºÐ¾Ð´Ð° Ð·Ð´ÐµÑÑŒ..."
                  onChange={(e) => {
                    if (e.target.value.trim()) {
                      handleQrScan(e.target.value.trim());
                      e.target.value = '';
                    }
                  }}
                />
              </div>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* QR Scan Result Modal */}
      {qrScanResult && (
        <Dialog open={!!qrScanResult} onOpenChange={() => setQrScanResult(null)}>
          <DialogContent className="max-w-md">
            <DialogHeader>
              <DialogTitle>
                <QrCode className="mr-2 h-5 w-5 inline" />
                Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ
              </DialogTitle>
            </DialogHeader>
            
            <div className="space-y-4">
              {qrScanResult.type === 'cargo' && (
                <div className="space-y-3">
                  <div className="flex items-center justify-between p-3 bg-blue-50 rounded-lg">
                    <div>
                      <h3 className="font-semibold text-blue-800">Ð“Ñ€ÑƒÐ· Ð½Ð°Ð¹Ð´ÐµÐ½!</h3>
                      <p className="text-sm text-blue-600">â„–{qrScanResult.cargo_number}</p>
                    </div>
                    <Package className="h-8 w-8 text-blue-600" />
                  </div>
                  
                  <div className="space-y-2">
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">ÐÐ°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ:</span>
                      <span className="text-sm">{qrScanResult.cargo_name}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">Ð’ÐµÑ:</span>
                      <span className="text-sm">{qrScanResult.weight} ÐºÐ³</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:</span>
                      <Badge variant="outline">{qrScanResult.status}</Badge>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ:</span>
                      <span className="text-sm">{qrScanResult.sender}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ:</span>
                      <span className="text-sm">{qrScanResult.recipient}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">ÐœÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ:</span>
                      <span className="text-sm">{qrScanResult.location}</span>
                    </div>
                  </div>
                  
                  <Button 
                    className="w-full" 
                    onClick={async () => {
                      try {
                        const cargoDetails = await fetchCargoDetails(qrScanResult.cargo_id);
                        setSelectedCellCargo(cargoDetails);
                        setCargoDetailModal(true);
                        setQrScanResult(null);
                      } catch (error) {
                        console.error('Error fetching cargo details:', error);
                      }
                    }}
                  >
                    ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ
                  </Button>
                </div>
              )}
              
              {qrScanResult.type === 'warehouse_cell' && (
                <div className="space-y-3">
                  <div className="flex items-center justify-between p-3 bg-green-50 rounded-lg">
                    <div>
                      <h3 className="font-semibold text-green-800">Ð¯Ñ‡ÐµÐ¹ÐºÐ° ÑÐºÐ»Ð°Ð´Ð°</h3>
                      <p className="text-sm text-green-600">{qrScanResult.location}</p>
                    </div>
                    <Building className="h-8 w-8 text-green-600" />
                  </div>
                  
                  <div className="space-y-2">
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">Ð¡ÐºÐ»Ð°Ð´:</span>
                      <span className="text-sm">{qrScanResult.warehouse_name}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">Ð‘Ð»Ð¾Ðº:</span>
                      <span className="text-sm">{qrScanResult.block}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">ÐŸÐ¾Ð»ÐºÐ°:</span>
                      <span className="text-sm">{qrScanResult.shelf}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">Ð¯Ñ‡ÐµÐ¹ÐºÐ°:</span>
                      <span className="text-sm">{qrScanResult.cell}</span>
                    </div>
                    <div className="flex justify-between">
                      <span className="text-sm font-medium">Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:</span>
                      <Badge variant={qrScanResult.is_occupied ? "destructive" : "default"}>
                        {qrScanResult.is_occupied ? "Ð—Ð°Ð½ÑÑ‚Ð°" : "Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð°"}
                      </Badge>
                    </div>
                    
                    {qrScanResult.cargo && (
                      <div className="mt-3 p-3 bg-gray-50 rounded-lg">
                        <h4 className="font-medium text-sm mb-2">Ð“Ñ€ÑƒÐ· Ð² ÑÑ‡ÐµÐ¹ÐºÐµ:</h4>
                        <div className="space-y-1">
                          <div className="flex justify-between">
                            <span className="text-xs">ÐÐ¾Ð¼ÐµÑ€:</span>
                            <span className="text-xs font-medium">{qrScanResult.cargo.cargo_number}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-xs">ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ:</span>
                            <span className="text-xs">{qrScanResult.cargo.cargo_name}</span>
                          </div>
                          <div className="flex justify-between">
                            <span className="text-xs">Ð’ÐµÑ:</span>
                            <span className="text-xs">{qrScanResult.cargo.weight} ÐºÐ³</span>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                  
                  <Button 
                    className="w-full" 
                    variant="outline"
                    onClick={() => {
                      // Navigate to warehouse management
                      const warehouse = warehouses.find(w => w.id === qrScanResult.warehouse_id);
                      if (warehouse) {
                        handleOpenWarehouseLayout(warehouse);
                        setQrScanResult(null);
                      }
                    }}
                  >
                    ÐŸÐµÑ€ÐµÐ¹Ñ‚Ð¸ Ðº ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸ÑŽ ÑÐºÐ»Ð°Ð´Ð¾Ð¼
                  </Button>
                </div>
              )}
            </div>
          </DialogContent>
        </Dialog>
      )}

      {/* Arrived Transport Modal */}
      <Dialog open={arrivedTransportModal} onOpenChange={setArrivedTransportModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              <Truck className="mr-2 h-5 w-5 inline" />
              Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð¸Ð· Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð° {selectedArrivedTransport?.transport_number}
            </DialogTitle>
          </DialogHeader>
          
          {selectedArrivedTransport && (
            <div className="space-y-6">
              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ðµ */}
              <div className="p-4 bg-green-50 rounded-lg">
                <h4 className="font-semibold text-green-800 mb-2">Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ðµ</h4>
                <div className="grid grid-cols-2 gap-4 text-sm">
                  <p><strong>ÐÐ¾Ð¼ÐµÑ€:</strong> {selectedArrivedTransport.transport_number}</p>
                  <p><strong>Ð’Ð¾Ð´Ð¸Ñ‚ÐµÐ»ÑŒ:</strong> {selectedArrivedTransport.driver_name}</p>
                  <p><strong>ÐÐ°Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ:</strong> {selectedArrivedTransport.direction}</p>
                  <p><strong>ÐŸÑ€Ð¸Ð±Ñ‹Ð»:</strong> {new Date(selectedArrivedTransport.arrived_at).toLocaleString('ru-RU')}</p>
                </div>
              </div>

              {/* Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ */}
              <Card className="p-4">
                <div className="flex justify-between items-center mb-4">
                  <h4 className="font-semibold">Ð“Ñ€ÑƒÐ·Ñ‹ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ ({arrivedCargoList.placeable_cargo_count || 0} Ð¸Ð· {arrivedCargoList.cargo_count || 0})</h4>
                  <div className="flex items-center space-x-4">
                    <Button
                      size="sm"
                      variant="outline"
                      onClick={() => setQrPlacementModal(true)}
                      className="text-purple-600 hover:text-purple-700"
                    >
                      <QrCode className="h-4 w-4 mr-1" />
                      QR Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ
                    </Button>
                    <div className="text-sm text-gray-600">
                      ÐžÐ±Ñ‰Ð¸Ð¹ Ð²ÐµÑ: {arrivedCargoList.total_weight || 0} ÐºÐ³
                    </div>
                  </div>
                </div>
                
                <div className="max-h-80 overflow-y-auto border rounded">
                  {!arrivedCargoList.cargo_list || arrivedCargoList.cargo_list.length === 0 ? (
                    <p className="p-4 text-gray-500 text-center">ÐÐµÑ‚ Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ</p>
                  ) : (
                    <div className="space-y-2 p-2">
                      {arrivedCargoList.cargo_list.map((cargo) => (
                        <div key={cargo.id} className={`flex justify-between items-center p-3 rounded border ${cargo.can_be_placed ? 'bg-green-50 border-green-200' : 'bg-gray-50 border-gray-200'}`}>
                          <div className="flex-1">
                            <div className="flex items-center space-x-4">
                              <div>
                                <p className="font-medium">{cargo.cargo_number}</p>
                                <p className="text-sm text-gray-600">{cargo.cargo_name}</p>
                              </div>
                              <div>
                                <p className="text-sm"><strong>Ð’ÐµÑ:</strong> {cargo.weight} ÐºÐ³</p>
                                <p className="text-sm"><strong>ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ:</strong> {cargo.recipient_full_name}</p>
                              </div>
                              <div>
                                <Badge variant={cargo.can_be_placed ? "default" : "secondary"}>
                                  {cargo.status === 'arrived_destination' ? 'Ð“Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸ÑŽ' : cargo.status}
                                </Badge>
                              </div>
                            </div>
                          </div>
                          
                          <div className="flex space-x-2">
                            {cargo.can_be_placed && (
                              <Button
                                size="sm"
                                onClick={() => {
                                  setSelectedCargoForWarehouse(cargo);
                                  setCargoPlacementModal(true);
                                }}
                                className="bg-blue-600 hover:bg-blue-700 text-white"
                              >
                                <Building className="h-4 w-4 mr-1" />
                                Ð Ð°Ð·Ð¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ
                              </Button>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </Card>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* Cargo Placement Modal */}
      <Dialog open={cargoPlacementModal} onOpenChange={setCargoPlacementModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>
              <Building className="mr-2 h-5 w-5 inline" />
              Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° {selectedCargoForWarehouse?.cargo_number}
            </DialogTitle>
          </DialogHeader>
          
          <form onSubmit={handlePlaceCargoFromTransport} className="space-y-4">
            {selectedCargoForWarehouse && (
              <div className="p-3 bg-blue-50 rounded-lg">
                <h5 className="font-medium text-blue-800">Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ</h5>
                <p className="text-sm"><strong>ÐÐ¾Ð¼ÐµÑ€:</strong> {selectedCargoForWarehouse.cargo_number}</p>
                <p className="text-sm"><strong>ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ:</strong> {selectedCargoForWarehouse.cargo_name}</p>
                <p className="text-sm"><strong>Ð’ÐµÑ:</strong> {selectedCargoForWarehouse.weight} ÐºÐ³</p>
                <p className="text-sm"><strong>ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ:</strong> {selectedCargoForWarehouse.recipient_full_name}</p>
              </div>
            )}

            <div>
              <Label htmlFor="placement_warehouse">Ð¡ÐºÐ»Ð°Ð´</Label>
              <Select 
                value={placementForm.warehouse_id} 
                onValueChange={(value) => setPlacementForm({...placementForm, warehouse_id: value})}
                required
              >
                <SelectTrigger>
                  <SelectValue placeholder="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ ÑÐºÐ»Ð°Ð´" />
                </SelectTrigger>
                <SelectContent>
                  {warehouses.map((warehouse) => (
                    <SelectItem key={warehouse.id} value={warehouse.id}>
                      {warehouse.name} ({warehouse.location})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div className="grid grid-cols-3 gap-3">
              <div>
                <Label htmlFor="placement_block">Ð‘Ð»Ð¾Ðº</Label>
                <Select 
                  value={placementForm.block_number.toString()} 
                  onValueChange={(value) => setPlacementForm({...placementForm, block_number: parseInt(value)})}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {placementForm.warehouse_id && warehouses.find(w => w.id === placementForm.warehouse_id) && 
                      Array.from({length: warehouses.find(w => w.id === placementForm.warehouse_id).blocks_count}, (_, i) => (
                        <SelectItem key={i+1} value={(i+1).toString()}>{i+1}</SelectItem>
                      ))
                    }
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label htmlFor="placement_shelf">ÐŸÐ¾Ð»ÐºÐ°</Label>
                <Select 
                  value={placementForm.shelf_number.toString()} 
                  onValueChange={(value) => setPlacementForm({...placementForm, shelf_number: parseInt(value)})}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {placementForm.warehouse_id && warehouses.find(w => w.id === placementForm.warehouse_id) && 
                      Array.from({length: warehouses.find(w => w.id === placementForm.warehouse_id).shelves_per_block}, (_, i) => (
                        <SelectItem key={i+1} value={(i+1).toString()}>{i+1}</SelectItem>
                      ))
                    }
                  </SelectContent>
                </Select>
              </div>

              <div>
                <Label htmlFor="placement_cell">Ð¯Ñ‡ÐµÐ¹ÐºÐ°</Label>
                <Select 
                  value={placementForm.cell_number.toString()} 
                  onValueChange={(value) => setPlacementForm({...placementForm, cell_number: parseInt(value)})}
                >
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    {placementForm.warehouse_id && warehouses.find(w => w.id === placementForm.warehouse_id) && 
                      Array.from({length: warehouses.find(w => w.id === placementForm.warehouse_id).cells_per_shelf}, (_, i) => (
                        <SelectItem key={i+1} value={(i+1).toString()}>{i+1}</SelectItem>
                      ))
                    }
                  </SelectContent>
                </Select>
              </div>
            </div>

            <div className="flex space-x-2 pt-4">
              <Button type="submit" className="flex-1">
                <Building className="mr-2 h-4 w-4" />
                Ð Ð°Ð·Ð¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·
              </Button>
              <Button 
                type="button" 
                variant="outline" 
                onClick={() => {
                  setCargoPlacementModal(false);
                  setSelectedCargoForWarehouse(null);
                }}
              >
                ÐžÑ‚Ð¼ÐµÐ½Ð°
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* Transport Visualization Modal */}
      <Dialog open={transportVisualizationModal} onOpenChange={setTransportVisualizationModal}>
        <DialogContent className="max-w-6xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>
              <Truck className="mr-2 h-5 w-5 inline" />
              Ð¡Ñ…ÐµÐ¼Ð° Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð° {selectedTransportForVisualization?.transport_number}
            </DialogTitle>
          </DialogHeader>
          
          {transportVisualizationData && (
            <div className="space-y-6">
              {/* Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð° */}
              <div className="grid grid-cols-4 gap-4">
                <div className="text-center p-4 bg-blue-50 rounded-lg">
                  <div className="text-2xl font-bold text-blue-600">{transportVisualizationData.cargo_summary.total_items}</div>
                  <div className="text-sm">Ð“Ñ€ÑƒÐ·Ð¾Ð²</div>
                </div>
                <div className="text-center p-4 bg-green-50 rounded-lg">
                  <div className="text-2xl font-bold text-green-600">{transportVisualizationData.cargo_summary.total_weight} ÐºÐ³</div>
                  <div className="text-sm">ÐžÐ±Ñ‰Ð¸Ð¹ Ð²ÐµÑ</div>
                </div>
                <div className="text-center p-4 bg-purple-50 rounded-lg">
                  <div className="text-2xl font-bold text-purple-600">{transportVisualizationData.cargo_summary.fill_percentage_weight}%</div>
                  <div className="text-sm">Ð—Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¿Ð¾ Ð²ÐµÑÑƒ</div>
                </div>
                <div className="text-center p-4 bg-orange-50 rounded-lg">
                  <div className="text-2xl font-bold text-orange-600">{transportVisualizationData.cargo_summary.total_volume_estimate} Ð¼Â³</div>
                  <div className="text-sm">ÐŸÑ€Ð¸Ð¼ÐµÑ€Ð½Ñ‹Ð¹ Ð¾Ð±ÑŠÑ‘Ð¼</div>
                </div>
              </div>

              {/* ÐŸÑ€Ð¾Ð³Ñ€ÐµÑÑ Ð±Ð°Ñ€ Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ñ */}
              <div className="space-y-2">
                <div className="flex justify-between text-sm">
                  <span>Ð—Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸Ðµ Ð¿Ð¾ Ð²ÐµÑÑƒ</span>
                  <span>{transportVisualizationData.cargo_summary.fill_percentage_weight}%</span>
                </div>
                <div className="w-full bg-gray-200 rounded-full h-3">
                  <div 
                    className={`h-3 rounded-full ${
                      transportVisualizationData.cargo_summary.fill_percentage_weight > 100 ? 'bg-red-500' :
                      transportVisualizationData.cargo_summary.fill_percentage_weight > 90 ? 'bg-orange-500' :
                      transportVisualizationData.cargo_summary.fill_percentage_weight > 70 ? 'bg-yellow-500' : 'bg-green-500'
                    }`}
                    style={{width: `${Math.min(transportVisualizationData.cargo_summary.fill_percentage_weight, 100)}%`}}
                  />
                </div>
              </div>

              {/* Ð¡Ñ…ÐµÐ¼Ð° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð¾Ð² */}
              <div className="space-y-4">
                <h4 className="font-semibold text-lg">Ð¡Ñ…ÐµÐ¼Ð° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð² Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ðµ</h4>
                <div className="border-2 border-gray-300 rounded-lg p-4 bg-gray-50">
                  <div className="text-center mb-2 text-sm font-medium text-gray-600">
                    â† ÐŸÐµÑ€ÐµÐ´Ð½ÑÑ Ñ‡Ð°ÑÑ‚ÑŒ ({transportVisualizationData.transport.dimensions.length}Ð¼ x {transportVisualizationData.transport.dimensions.width}Ð¼)
                  </div>
                  <div className="grid grid-cols-6 gap-2">
                    {transportVisualizationData.visualization.placement_grid.map((row, rowIndex) =>
                      row.map((cell, cellIndex) => (
                        <div 
                          key={`${rowIndex}-${cellIndex}`}
                          className={`
                            relative h-16 border-2 rounded transition-all
                            ${cell.occupied 
                              ? 'bg-blue-100 border-blue-300 hover:bg-blue-200' 
                              : 'bg-white border-gray-300 border-dashed'
                            }
                          `}
                          title={cell.occupied ? `Ð“Ñ€ÑƒÐ· ${cell.cargo_number}: ${cell.cargo_name} (${cell.weight}ÐºÐ³)` : 'Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð¾Ðµ Ð¼ÐµÑÑ‚Ð¾'}
                        >
                          {cell.occupied && (
                            <div className="absolute inset-0 p-1 flex flex-col justify-center items-center text-xs">
                              <div className="font-bold text-blue-800">{cell.cargo_number}</div>
                              <div className="text-blue-600 text-center leading-tight">{cell.weight}ÐºÐ³</div>
                            </div>
                          )}
                          <div className="absolute bottom-0 right-0 text-xs text-gray-400 p-1">
                            {cell.position}
                          </div>
                        </div>
                      ))
                    )}
                  </div>
                  <div className="text-center mt-2 text-sm font-medium text-gray-600">
                    Ð—Ð°Ð´Ð½ÑÑ Ñ‡Ð°ÑÑ‚ÑŒ â†’
                  </div>
                </div>
              </div>

              {/* Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº Ð³Ñ€ÑƒÐ·Ð¾Ð² */}
              <div className="space-y-4">
                <h4 className="font-semibold text-lg">Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ð¹ ÑÐ¿Ð¸ÑÐ¾Ðº Ð³Ñ€ÑƒÐ·Ð¾Ð² ({transportVisualizationData.cargo_summary.total_items})</h4>
                <div className="max-h-64 overflow-y-auto border rounded-lg">
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead>â„– Ð“Ñ€ÑƒÐ·Ð°</TableHead>
                        <TableHead>ÐÐ°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ</TableHead>
                        <TableHead>Ð’ÐµÑ (ÐºÐ³)</TableHead>
                        <TableHead>ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ</TableHead>
                        <TableHead>ÐŸÐ¾Ð·Ð¸Ñ†Ð¸Ñ</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {transportVisualizationData.cargo_summary.cargo_list.map((cargo, index) => (
                        <TableRow key={cargo.id}>
                          <TableCell className="font-medium">{cargo.cargo_number}</TableCell>
                          <TableCell>{cargo.cargo_name}</TableCell>
                          <TableCell>{cargo.weight}</TableCell>
                          <TableCell>{cargo.recipient_name}</TableCell>
                          <TableCell>{Math.floor(index / 6) + 1}-{(index % 6) + 1}</TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                </div>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* QR/Number Cargo Placement Modal */}
      <Dialog open={qrPlacementModal} onOpenChange={setQrPlacementModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>
              <QrCode className="mr-2 h-5 w-5 inline" />
              Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° Ð¿Ð¾ Ð½Ð¾Ð¼ÐµÑ€Ñƒ/QR
            </DialogTitle>
          </DialogHeader>
          
          <form onSubmit={handleQrCargoPlacement} className="space-y-4">
            <div className="p-3 bg-purple-50 rounded-lg">
              <h5 className="font-medium text-purple-800 mb-2">Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°</h5>
              <p className="text-sm text-purple-700">
                Ð¡ÐºÐ»Ð°Ð´ Ð±ÑƒÐ´ÐµÑ‚ Ð²Ñ‹Ð±Ñ€Ð°Ð½ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¸ Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð²Ð°ÑˆÐ¸Ñ… Ð¿Ñ€Ð¸Ð²ÑÐ·Ð¾Ðº. Ð’Ñ‹ Ð´Ð¾Ð»Ð¶Ð½Ñ‹ ÑƒÐºÐ°Ð·Ð°Ñ‚ÑŒ ÐºÐ¾Ð½ÐºÑ€ÐµÑ‚Ð½ÑƒÑŽ ÑÑ‡ÐµÐ¹ÐºÑƒ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ Ð¸Ð»Ð¸ Ñ‡ÐµÑ€ÐµÐ· QR ÐºÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸.
              </p>
            </div>

            <div>
              <Label htmlFor="cargo_number">ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°</Label>
              <Input
                id="cargo_number"
                value={qrPlacementForm.cargo_number}
                onChange={(e) => setQrPlacementForm({...qrPlacementForm, cargo_number: e.target.value})}
                placeholder="1234"
                required={!qrPlacementForm.qr_data}
              />
            </div>

            <div className="text-center text-sm text-gray-500">Ð¸Ð»Ð¸</div>

            <div>
              <Label htmlFor="qr_data">QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð°</Label>
              <textarea
                id="qr_data"
                className="w-full mt-2 p-3 border rounded-md"
                rows="3"
                value={qrPlacementForm.qr_data}
                onChange={(e) => setQrPlacementForm({...qrPlacementForm, qr_data: e.target.value})}
                placeholder="Ð’ÑÑ‚Ð°Ð²ÑŒÑ‚Ðµ QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð°..."
                required={!qrPlacementForm.cargo_number}
              />
            </div>

            <div className="border-t pt-4">
              <Label>Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð² ÑÑ‡ÐµÐ¹ÐºÐµ</Label>
              
              <div className="mt-2">
                <Label htmlFor="cell_qr_data">QR ÐºÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸ ÑÐºÐ»Ð°Ð´Ð°</Label>
                <textarea
                  id="cell_qr_data"
                  className="w-full mt-2 p-3 border rounded-md"
                  rows="3"
                  value={qrPlacementForm.cell_qr_data}
                  onChange={(e) => setQrPlacementForm({...qrPlacementForm, cell_qr_data: e.target.value})}
                  placeholder="ÐžÑ‚ÑÐºÐ°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ QR ÐºÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸ ÑÐºÐ»Ð°Ð´Ð°..."
                />
              </div>

              <div className="text-center text-sm text-gray-500 my-2">Ð¸Ð»Ð¸ ÑƒÐºÐ°Ð¶Ð¸Ñ‚Ðµ ÐºÐ¾Ð¾Ñ€Ð´Ð¸Ð½Ð°Ñ‚Ñ‹ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ</div>

              <div className="grid grid-cols-3 gap-3">
                <div>
                  <Label htmlFor="manual_block">Ð‘Ð»Ð¾Ðº</Label>
                  <Input
                    id="manual_block"
                    type="number"
                    min="1"
                    value={qrPlacementForm.block_number}
                    onChange={(e) => setQrPlacementForm({...qrPlacementForm, block_number: e.target.value})}
                    placeholder="1"
                  />
                </div>
                <div>
                  <Label htmlFor="manual_shelf">ÐŸÐ¾Ð»ÐºÐ°</Label>
                  <Input
                    id="manual_shelf"
                    type="number"
                    min="1"
                    value={qrPlacementForm.shelf_number}
                    onChange={(e) => setQrPlacementForm({...qrPlacementForm, shelf_number: e.target.value})}
                    placeholder="1"
                  />
                </div>
                <div>
                  <Label htmlFor="manual_cell">Ð¯Ñ‡ÐµÐ¹ÐºÐ°</Label>
                  <Input
                    id="manual_cell"
                    type="number"
                    min="1"
                    value={qrPlacementForm.cell_number}
                    onChange={(e) => setQrPlacementForm({...qrPlacementForm, cell_number: e.target.value})}
                    placeholder="1"
                  />
                </div>
              </div>
            </div>

            <div className="flex space-x-2 pt-4">
              <Button type="submit" className="flex-1">
                <Building className="mr-2 h-4 w-4" />
                Ð Ð°Ð·Ð¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·
              </Button>
              <Button 
                type="button" 
                variant="outline" 
                onClick={() => {
                  setQrPlacementModal(false);
                  setQrPlacementForm({
                    cargo_number: '',
                    qr_data: '',
                    cell_qr_data: '',
                    block_number: 1,
                    shelf_number: 1,
                    cell_number: 1
                  });
                }}
              >
                ÐžÑ‚Ð¼ÐµÐ½Ð°
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* Interwarehouse Transport Modal */}
      <Dialog open={interwarehouseTransportModal} onOpenChange={setInterwarehouseTransportModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>
              <Truck className="mr-2 h-5 w-5 inline" />
              Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð¼ÐµÐ¶ÑÐºÐ»Ð°Ð´ÑÐºÐ¾Ð³Ð¾ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð°
            </DialogTitle>
          </DialogHeader>
          
          <form onSubmit={handleCreateInterwarehouseTransport} className="space-y-4">
            <div className="p-3 bg-blue-50 rounded-lg">
              <h5 className="font-medium text-blue-800 mb-2">ÐœÐµÐ¶ÑÐºÐ»Ð°Ð´ÑÐºÐ°Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ°</h5>
              <p className="text-sm text-blue-700">
                Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ²Ð¾Ð·ÐºÐ¸ Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð¼ÐµÐ¶Ð´Ñƒ Ð²Ð°ÑˆÐ¸Ð¼Ð¸ ÑÐºÐ»Ð°Ð´Ð°Ð¼Ð¸. Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÑÐºÐ»Ð°Ð´Ñ‹, Ðº ÐºÐ¾Ñ‚Ð¾Ñ€Ñ‹Ð¼ Ñƒ Ð²Ð°Ñ ÐµÑÑ‚ÑŒ Ð´Ð¾ÑÑ‚ÑƒÐ¿.
              </p>
            </div>

            <div>
              <Label htmlFor="source_warehouse">Ð˜ÑÑ…Ð¾Ð´Ð½Ñ‹Ð¹ ÑÐºÐ»Ð°Ð´</Label>
              <Select 
                value={interwarehouseForm.source_warehouse_id} 
                onValueChange={(value) => setInterwarehouseForm({...interwarehouseForm, source_warehouse_id: value})}
                required
              >
                <SelectTrigger>
                  <SelectValue placeholder="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¸ÑÑ…Ð¾Ð´Ð½Ñ‹Ð¹ ÑÐºÐ»Ð°Ð´" />
                </SelectTrigger>
                <SelectContent>
                  {(user?.role === 'admin' ? warehouses : operatorWarehouses).map((warehouse) => (
                    <SelectItem key={warehouse.id} value={warehouse.id}>
                      {warehouse.name} ({warehouse.location})
                    </SelectItem>
                  ))}
                </SelectContent>
              </Select>
            </div>

            <div>
              <Label htmlFor="destination_warehouse">Ð¦ÐµÐ»ÐµÐ²Ð¾Ð¹ ÑÐºÐ»Ð°Ð´</Label>
              <Select 
                value={interwarehouseForm.destination_warehouse_id} 
                onValueChange={(value) => setInterwarehouseForm({...interwarehouseForm, destination_warehouse_id: value})}
                required
              >
                <SelectTrigger>
                  <SelectValue placeholder="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ†ÐµÐ»ÐµÐ²Ð¾Ð¹ ÑÐºÐ»Ð°Ð´" />
                </SelectTrigger>
                <SelectContent>
                  {(user?.role === 'admin' ? warehouses : operatorWarehouses)
                    .filter(w => w.id !== interwarehouseForm.source_warehouse_id)
                    .map((warehouse) => (
                      <SelectItem key={warehouse.id} value={warehouse.id}>
                        {warehouse.name} ({warehouse.location})
                      </SelectItem>
                    ))}
                </SelectContent>
              </Select>
            </div>

            <div>
              <Label htmlFor="iw_driver_name">Ð¤Ð˜Ðž Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ</Label>
              <Input
                id="iw_driver_name"
                value={interwarehouseForm.driver_name}
                onChange={(e) => setInterwarehouseForm({...interwarehouseForm, driver_name: e.target.value})}
                placeholder="Ð˜Ð²Ð°Ð½ Ð˜Ð²Ð°Ð½Ð¾Ð²"
                required
              />
            </div>

            <div>
              <Label htmlFor="iw_driver_phone">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð²Ð¾Ð´Ð¸Ñ‚ÐµÐ»Ñ</Label>
              <Input
                id="iw_driver_phone"
                value={interwarehouseForm.driver_phone}
                onChange={(e) => setInterwarehouseForm({...interwarehouseForm, driver_phone: e.target.value})}
                placeholder="+7 (999) 123-45-67"
                required
              />
            </div>

            <div>
              <Label htmlFor="iw_capacity">Ð“Ñ€ÑƒÐ·Ð¾Ð¿Ð¾Ð´ÑŠÐµÐ¼Ð½Ð¾ÑÑ‚ÑŒ (ÐºÐ³)</Label>
              <Input
                id="iw_capacity"
                type="number"
                min="100"
                step="50"
                value={interwarehouseForm.capacity_kg}
                onChange={(e) => setInterwarehouseForm({...interwarehouseForm, capacity_kg: parseInt(e.target.value)})}
                required
              />
            </div>

            <div className="flex space-x-2 pt-4">
              <Button type="submit" className="flex-1">
                <Truck className="mr-2 h-4 w-4" />
                Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚
              </Button>
              <Button 
                type="button" 
                variant="outline" 
                onClick={() => {
                  setInterwarehouseTransportModal(false);
                  setInterwarehouseForm({
                    source_warehouse_id: '',
                    destination_warehouse_id: '',
                    driver_name: '',
                    driver_phone: '',
                    capacity_kg: 1000
                  });
                }}
              >
                ÐžÑ‚Ð¼ÐµÐ½Ð°
              </Button>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* ÐÐžÐ’Ð«Ð• ÐœÐžÐ”ÐÐ›Ð« Ð”Ð›Ð¯ Ð£ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð¯ Ð—ÐÐšÐÐ—ÐÐœÐ˜ ÐšÐ›Ð˜Ð•ÐÐ¢ÐžÐ’ */}

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð·Ð°ÐºÐ°Ð·Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° */}
      <Dialog open={orderDetailsModal} onOpenChange={setOrderDetailsModal}>
        <DialogContent className="max-w-3xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <ShoppingCart className="w-5 h-5 mr-2 text-orange-600" />
              Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð·Ð°ÐºÐ°Ð·Ð° â„–{selectedOrder?.request_number}
            </DialogTitle>
            <DialogDescription>
              ÐŸÑ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð¿Ð¾Ð»Ð½Ð¾Ð¹ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð·Ð°ÐºÐ°Ð·Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
            </DialogDescription>
          </DialogHeader>
          
          {selectedOrder && (
            <div className="space-y-6">
              {/* ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ */}
              <div className="grid grid-cols-2 gap-4 p-4 bg-gray-50 rounded-lg">
                <div>
                  <p className="text-sm text-gray-600"><strong>ÐÐ¾Ð¼ÐµÑ€ Ð·Ð°ÐºÐ°Ð·Ð°:</strong></p>
                  <p className="font-medium">{selectedOrder.request_number}</p>
                </div>
                <div>
                  <p className="text-sm text-gray-600"><strong>Ð”Ð°Ñ‚Ð° ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ:</strong></p>
                  <p className="font-medium">
                    {new Date(selectedOrder.created_at).toLocaleDateString('ru-RU')} {' '}
                    {new Date(selectedOrder.created_at).toLocaleTimeString('ru-RU')}
                  </p>
                </div>
                <div>
                  <p className="text-sm text-gray-600"><strong>Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:</strong></p>
                  <Badge variant={selectedOrder.status === 'pending' ? 'destructive' : 'default'}>
                    {selectedOrder.status === 'pending' ? 'ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸' : selectedOrder.status}
                  </Badge>
                </div>
                <div>
                  <p className="text-sm text-gray-600"><strong>ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚:</strong></p>
                  <p className="font-medium">
                    {selectedOrder.route === 'moscow_to_tajikistan' ? 'ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½' : 'Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½ â†’ ÐœÐ¾ÑÐºÐ²Ð°'}
                  </p>
                </div>
              </div>

              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ðµ */}
              <div className="border rounded-lg p-4">
                <h3 className="font-semibold text-lg mb-3 flex items-center">
                  <User className="w-5 h-5 mr-2 text-blue-600" />
                  ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600"><strong>Ð¤Ð˜Ðž:</strong></p>
                    <p className="font-medium">{selectedOrder.sender_full_name}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:</strong></p>
                    <p className="font-medium">{selectedOrder.sender_phone}</p>
                  </div>
                  <div className="md:col-span-2">
                    <p className="text-sm text-gray-600"><strong>ÐÐ´Ñ€ÐµÑ Ð·Ð°Ð±Ð¾Ñ€Ð°:</strong></p>
                    <p className="font-medium">{selectedOrder.pickup_address}</p>
                  </div>
                </div>
              </div>

              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ðµ */}
              <div className="border rounded-lg p-4">
                <h3 className="font-semibold text-lg mb-3 flex items-center">
                  <MapPin className="w-5 h-5 mr-2 text-green-600" />
                  ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600"><strong>Ð¤Ð˜Ðž:</strong></p>
                    <p className="font-medium">{selectedOrder.recipient_full_name}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:</strong></p>
                    <p className="font-medium">{selectedOrder.recipient_phone}</p>
                  </div>
                  <div className="md:col-span-2">
                    <p className="text-sm text-gray-600"><strong>ÐÐ´Ñ€ÐµÑ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸:</strong></p>
                    <p className="font-medium">{selectedOrder.recipient_address}</p>
                  </div>
                </div>
              </div>

              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ */}
              <div className="border rounded-lg p-4">
                <h3 className="font-semibold text-lg mb-3 flex items-center">
                  <Package className="w-5 h-5 mr-2 text-purple-600" />
                  Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600"><strong>ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°:</strong></p>
                    <p className="font-medium">{selectedOrder.cargo_name}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>Ð’ÐµÑ:</strong></p>
                    <p className="font-medium">{selectedOrder.weight} ÐºÐ³</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>ÐžÐ±ÑŠÑÐ²Ð»ÐµÐ½Ð½Ð°Ñ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ:</strong></p>
                    <p className="font-medium">{selectedOrder.declared_value} â‚½</p>
                  </div>
                  <div className="md:col-span-2">
                    <p className="text-sm text-gray-600"><strong>ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ:</strong></p>
                    <p className="font-medium">{selectedOrder.description}</p>
                  </div>
                </div>
              </div>

              {/* Ð—Ð°Ð¼ÐµÑ‚ÐºÐ¸ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° */}
              {selectedOrder.admin_notes && (
                <div className="border rounded-lg p-4 bg-blue-50">
                  <h3 className="font-semibold text-lg mb-3 flex items-center">
                    <FileText className="w-5 h-5 mr-2 text-blue-600" />
                    Ð—Ð°Ð¼ÐµÑ‚ÐºÐ¸ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°
                  </h3>
                  <p className="text-gray-700">{selectedOrder.admin_notes}</p>
                </div>
              )}

              {/* Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ */}
              <div className="flex justify-between items-center pt-4 border-t">
                <div className="space-x-2">
                  <Button 
                    onClick={() => {
                      handleOrderEdit(selectedOrder);
                      setOrderDetailsModal(false);
                    }}
                    variant="outline"
                    className="flex items-center"
                  >
                    <Edit className="w-4 h-4 mr-2" />
                    Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ
                  </Button>
                </div>
                <div className="space-x-2">
                  <Button 
                    onClick={() => handleAcceptOrder(selectedOrder.id)}
                    className="bg-green-600 hover:bg-green-700"
                  >
                    <CheckCircle className="w-4 h-4 mr-2" />
                    ÐŸÑ€Ð¸Ð½ÑÑ‚ÑŒ Ð·Ð°ÐºÐ°Ð·
                  </Button>
                  <Button 
                    onClick={() => handleRejectOrder(selectedOrder.id, 'Ð—Ð°ÐºÐ°Ð· Ð¾Ñ‚ÐºÐ»Ð¾Ð½ÐµÐ½ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼')}
                    variant="destructive"
                  >
                    <XCircle className="w-4 h-4 mr-2" />
                    ÐžÑ‚ÐºÐ»Ð¾Ð½Ð¸Ñ‚ÑŒ
                  </Button>
                </div>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð·Ð°ÐºÐ°Ð·Ð° ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð° */}
      <Dialog open={editOrderModal} onOpenChange={setEditOrderModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Edit className="w-5 h-5 mr-2 text-blue-600" />
              Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð·Ð°ÐºÐ°Ð·Ð° â„–{selectedOrder?.request_number}
            </DialogTitle>
            <DialogDescription>
              Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ðµ, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ðµ Ð¸ Ð³Ñ€ÑƒÐ·Ðµ
            </DialogDescription>
          </DialogHeader>
          
          <form onSubmit={(e) => { e.preventDefault(); handleSaveOrderChanges(); }}>
            <div className="space-y-6">
              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ðµ */}
              <div className="border rounded-lg p-4">
                <h3 className="font-semibold text-lg mb-4 flex items-center">
                  <User className="w-5 h-5 mr-2 text-blue-600" />
                  ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="sender_full_name">Ð¤Ð˜Ðž Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ</Label>
                    <Input
                      id="sender_full_name"
                      value={orderEditForm.sender_full_name}
                      onChange={(e) => setOrderEditForm({...orderEditForm, sender_full_name: e.target.value})}
                      placeholder="Ð˜Ð²Ð°Ð½ Ð˜Ð²Ð°Ð½Ð¾Ð²Ð¸Ñ‡ ÐŸÐµÑ‚Ñ€Ð¾Ð²"
                    />
                  </div>
                  <div>
                    <Label htmlFor="sender_phone">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ</Label>
                    <Input
                      id="sender_phone"
                      value={orderEditForm.sender_phone}
                      onChange={(e) => setOrderEditForm({...orderEditForm, sender_phone: e.target.value})}
                      placeholder="+7 900 123-45-67"
                    />
                  </div>
                  <div className="md:col-span-2">
                    <Label htmlFor="pickup_address">ÐÐ´Ñ€ÐµÑ Ð·Ð°Ð±Ð¾Ñ€Ð°</Label>
                    <Input
                      id="pickup_address"
                      value={orderEditForm.pickup_address}
                      onChange={(e) => setOrderEditForm({...orderEditForm, pickup_address: e.target.value})}
                      placeholder="Ð³. ÐœÐ¾ÑÐºÐ²Ð°, ÑƒÐ». Ð¢Ð²ÐµÑ€ÑÐºÐ°Ñ, Ð´. 1"
                    />
                  </div>
                </div>
              </div>

              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ðµ */}
              <div className="border rounded-lg p-4">
                <h3 className="font-semibold text-lg mb-4 flex items-center">
                  <MapPin className="w-5 h-5 mr-2 text-green-600" />
                  ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="recipient_full_name">Ð¤Ð˜Ðž Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</Label>
                    <Input
                      id="recipient_full_name"
                      value={orderEditForm.recipient_full_name}
                      onChange={(e) => setOrderEditForm({...orderEditForm, recipient_full_name: e.target.value})}
                      placeholder="ÐŸÐµÑ‚Ñ€ ÐŸÐµÑ‚Ñ€Ð¾Ð²Ð¸Ñ‡ Ð˜Ð²Ð°Ð½Ð¾Ð²"
                    />
                  </div>
                  <div>
                    <Label htmlFor="recipient_phone">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</Label>
                    <Input
                      id="recipient_phone"
                      value={orderEditForm.recipient_phone}
                      onChange={(e) => setOrderEditForm({...orderEditForm, recipient_phone: e.target.value})}
                      placeholder="+992 900 123456"
                    />
                  </div>
                  <div className="md:col-span-2">
                    <Label htmlFor="recipient_address">ÐÐ´Ñ€ÐµÑ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸</Label>
                    <Input
                      id="recipient_address"
                      value={orderEditForm.recipient_address}
                      onChange={(e) => setOrderEditForm({...orderEditForm, recipient_address: e.target.value})}
                      placeholder="Ð³. Ð”ÑƒÑˆÐ°Ð½Ð±Ðµ, ÑƒÐ». Ð ÑƒÐ´Ð°ÐºÐ¸, Ð´. 10"
                    />
                  </div>
                </div>
              </div>

              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ */}
              <div className="border rounded-lg p-4">
                <h3 className="font-semibold text-lg mb-4 flex items-center">
                  <Package className="w-5 h-5 mr-2 text-purple-600" />
                  Ð“Ñ€ÑƒÐ·
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                  <div>
                    <Label htmlFor="cargo_name">ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°</Label>
                    <Input
                      id="cargo_name"
                      value={orderEditForm.cargo_name}
                      onChange={(e) => setOrderEditForm({...orderEditForm, cargo_name: e.target.value})}
                      placeholder="Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹"
                    />
                  </div>
                  <div>
                    <Label htmlFor="route">ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚</Label>
                    <Select value={orderEditForm.route} onValueChange={(value) => setOrderEditForm({...orderEditForm, route: value})}>
                      <SelectTrigger>
                        <SelectValue placeholder="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¼Ð°Ñ€ÑˆÑ€ÑƒÑ‚" />
                      </SelectTrigger>
                      <SelectContent>
                        <SelectItem value="moscow_to_tajikistan">ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½</SelectItem>
                        <SelectItem value="tajikistan_to_moscow">Ð¢Ð°Ð´Ð¶Ð¸ÐºÐ¸ÑÑ‚Ð°Ð½ â†’ ÐœÐ¾ÑÐºÐ²Ð°</SelectItem>
                      </SelectContent>
                    </Select>
                  </div>
                  <div>
                    <Label htmlFor="weight">Ð’ÐµÑ (ÐºÐ³)</Label>
                    <Input
                      id="weight"
                      type="number"
                      value={orderEditForm.weight}
                      onChange={(e) => setOrderEditForm({...orderEditForm, weight: e.target.value})}
                      placeholder="1.5"
                      step="0.1"
                    />
                  </div>
                  <div>
                    <Label htmlFor="declared_value">ÐžÐ±ÑŠÑÐ²Ð»ÐµÐ½Ð½Ð°Ñ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ (â‚½)</Label>
                    <Input
                      id="declared_value"
                      type="number"
                      value={orderEditForm.declared_value}
                      onChange={(e) => setOrderEditForm({...orderEditForm, declared_value: e.target.value})}
                      placeholder="10000"
                    />
                  </div>
                  <div className="md:col-span-2">
                    <Label htmlFor="description">ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°</Label>
                    <Textarea
                      id="description"
                      value={orderEditForm.description}
                      onChange={(e) => setOrderEditForm({...orderEditForm, description: e.target.value})}
                      placeholder="ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð¾Ðµ Ð¾Ð¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°"
                      rows={3}
                    />
                  </div>
                </div>
              </div>

              {/* Ð—Ð°Ð¼ÐµÑ‚ÐºÐ¸ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð° */}
              <div className="border rounded-lg p-4 bg-blue-50">
                <h3 className="font-semibold text-lg mb-4 flex items-center">
                  <FileText className="w-5 h-5 mr-2 text-blue-600" />
                  Ð—Ð°Ð¼ÐµÑ‚ÐºÐ¸ Ð°Ð´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€Ð°
                </h3>
                <Textarea
                  value={orderEditForm.admin_notes}
                  onChange={(e) => setOrderEditForm({...orderEditForm, admin_notes: e.target.value})}
                  placeholder="Ð”Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð·Ð°Ð¼ÐµÑ‚ÐºÐ¸ Ð¿Ð¾ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐµ Ð·Ð°ÐºÐ°Ð·Ð°..."
                  rows={3}
                />
              </div>

              {/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ */}
              <div className="flex justify-between items-center pt-4 border-t">
                <Button 
                  type="button" 
                  variant="outline" 
                  onClick={() => {
                    setEditOrderModal(false);
                    setOrderEditForm({
                      sender_full_name: '',
                      sender_phone: '',
                      recipient_full_name: '',
                      recipient_phone: '',
                      recipient_address: '',
                      pickup_address: '',
                      cargo_name: '',
                      weight: '',
                      declared_value: '',
                      description: '',
                      route: '',
                      admin_notes: ''
                    });
                  }}
                >
                  ÐžÑ‚Ð¼ÐµÐ½Ð°
                </Button>
                <div className="space-x-2">
                  <Button type="submit" className="bg-blue-600 hover:bg-blue-700">
                    <Save className="w-4 h-4 mr-2" />
                    Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
                  </Button>
                </div>
              </div>
            </div>
          </form>
        </DialogContent>
      </Dialog>

      {/* ÐœÐžÐ”ÐÐ›Ð¬ÐÐ«Ð• ÐžÐšÐÐ Ð”Ð›Ð¯ Ð£ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð¯ Ð ÐÐ—ÐœÐ•Ð©Ð•ÐÐ˜Ð•Ðœ Ð“Ð Ð£Ð—ÐžÐ’ */}

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€Ð° Ð³Ñ€ÑƒÐ·Ð° */}
      <Dialog open={cargoDetailsModal} onOpenChange={setCargoDetailsModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Package className="w-5 h-5 mr-2 text-blue-600" />
              ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ â„–{selectedCargoForDetailView?.cargo_number}
            </DialogTitle>
            <DialogDescription>
              ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ, Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ðµ, Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ðµ Ð¸ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ðµ
            </DialogDescription>
          </DialogHeader>
          
          {selectedCargoForDetailView && (
            <div className="space-y-6">
              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ */}
              <div className="p-4 bg-blue-50 rounded-lg">
                <h3 className="font-bold text-lg text-blue-700 mb-3">ðŸ“¦ Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600"><strong>ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°:</strong></p>
                    <p className="font-medium text-lg">{selectedCargoForDetailView.cargo_number}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>ÐÐ°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.cargo_name}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>Ð’ÐµÑ:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.weight} ÐºÐ³</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>ÐžÐ±ÑŠÑÐ²Ð»ÐµÐ½Ð½Ð°Ñ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.declared_value} â‚½</p>
                  </div>
                  <div className="col-span-2">
                    <p className="text-sm text-gray-600"><strong>ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.description}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.route}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¾Ð±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ¸:</strong></p>
                    <Badge variant={getProcessingStatusBadgeVariant(selectedCargoForDetailView.processing_status)}>
                      {getProcessingStatusLabel(selectedCargoForDetailView.processing_status)}
                    </Badge>
                  </div>
                </div>
              </div>

              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ðµ */}
              <div className="p-4 bg-green-50 rounded-lg">
                <h3 className="font-bold text-lg text-green-700 mb-3">ðŸ‘¤ ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600"><strong>ÐŸÐ¾Ð»Ð½Ð¾Ðµ Ð¸Ð¼Ñ:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.sender_full_name}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.sender_phone}</p>
                  </div>
                  <div className="col-span-2">
                    <p className="text-sm text-gray-600"><strong>ÐÐ´Ñ€ÐµÑ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.sender_address}</p>
                  </div>
                </div>
              </div>

              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ðµ */}
              <div className="p-4 bg-yellow-50 rounded-lg">
                <h3 className="font-bold text-lg text-yellow-700 mb-3">ðŸ“ ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600"><strong>ÐŸÐ¾Ð»Ð½Ð¾Ðµ Ð¸Ð¼Ñ:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.recipient_name}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.recipient_phone}</p>
                  </div>
                  <div className="col-span-2">
                    <p className="text-sm text-gray-600"><strong>ÐÐ´Ñ€ÐµÑ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.recipient_address}</p>
                  </div>
                </div>
              </div>

              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ðµ */}
              <div className="p-4 bg-purple-50 rounded-lg">
                <h3 className="font-bold text-lg text-purple-700 mb-3">ðŸ‘¨â€ðŸ’¼ ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€</h3>
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="text-sm text-gray-600"><strong>ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€, Ð¿Ñ€Ð¸Ð½ÑÐ²ÑˆÐ¸Ð¹ Ð³Ñ€ÑƒÐ·:</strong></p>
                    <p className="font-medium">{selectedCargoForDetailView.accepting_operator}</p>
                  </div>
                  <div>
                    <p className="text-sm text-gray-600"><strong>Ð”Ð°Ñ‚Ð° Ð¿Ñ€Ð¸ÐµÐ¼Ð°:</strong></p>
                    <p className="font-medium">
                      {new Date(selectedCargoForDetailView.created_at).toLocaleDateString('ru-RU')} {' '}
                      {new Date(selectedCargoForDetailView.created_at).toLocaleTimeString('ru-RU')}
                    </p>
                  </div>
                  {selectedCargoForDetailView.warehouse_location && (
                    <>
                      <div>
                        <p className="text-sm text-gray-600"><strong>Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ:</strong></p>
                        <p className="font-medium text-blue-600">{selectedCargoForDetailView.warehouse_location}</p>
                      </div>
                      <div>
                        <p className="text-sm text-gray-600"><strong>Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð¾Ð¼:</strong></p>
                        <p className="font-medium">{selectedCargoForDetailView.placed_by_operator || 'ÐÐµ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½'}</p>
                      </div>
                    </>
                  )}
                </div>
              </div>

              {/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ */}
              <div className="flex justify-end space-x-4">
                <Button variant="outline" onClick={() => setCargoDetailsModal(false)}>
                  Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ
                </Button>
                {(selectedCargoForDetailView.processing_status === 'paid' || selectedCargoForDetailView.processing_status === 'invoice_printed') && !selectedCargoForDetailView.warehouse_location && (
                  <Button
                    onClick={() => {
                      setCargoDetailsModal(false);
                      setCargoMoveModal(true);
                    }}
                    className="bg-blue-600 hover:bg-blue-700 text-white"
                  >
                    <Grid3X3 className="mr-2 h-4 w-4" />
                    ÐŸÐµÑ€ÐµÐ¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·
                  </Button>
                )}
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð° */}
      <Dialog open={cargoMoveModal} onOpenChange={setCargoMoveModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Grid3X3 className="w-5 h-5 mr-2 text-blue-600" />
              ÐŸÐµÑ€ÐµÐ¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·
            </DialogTitle>
            <DialogDescription>
              Ð“Ñ€ÑƒÐ· â„–{selectedCargoForWarehouse?.cargo_number}
              <br />
              Ð¢ÐµÐºÑƒÑ‰ÐµÐµ Ð¼ÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ: {selectedCargoForWarehouse?.warehouse_location}
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4">
            {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ */}
            {selectedCargoForWarehouse && (
              <div className="p-3 bg-gray-50 rounded-lg">
                <p className="font-medium text-lg">{selectedCargoForWarehouse.cargo_number}</p>
                <p className="text-sm text-gray-600">{selectedCargoForWarehouse.cargo_name}</p>
                <p className="text-sm text-gray-600">Ð’ÐµÑ: {selectedCargoForWarehouse.weight} ÐºÐ³</p>
              </div>
            )}

            {/* Ð¤Ð¾Ñ€Ð¼Ð° Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ */}
            <div className="grid grid-cols-3 gap-4">
              <div>
                <Label>ÐÐ¾Ð²Ñ‹Ð¹ Ð±Ð»Ð¾Ðº</Label>
                <Input
                  type="number"
                  min="1"
                  max="9"
                  value={cargoMoveForm.to_block}
                  onChange={(e) => setCargoMoveForm({
                    ...cargoMoveForm,
                    to_block: parseInt(e.target.value) || 1
                  })}
                />
              </div>
              <div>
                <Label>ÐÐ¾Ð²Ð°Ñ Ð¿Ð¾Ð»ÐºÐ°</Label>
                <Input
                  type="number"
                  min="1"
                  max="3"
                  value={cargoMoveForm.to_shelf}
                  onChange={(e) => setCargoMoveForm({
                    ...cargoMoveForm,
                    to_shelf: parseInt(e.target.value) || 1
                  })}
                />
              </div>
              <div>
                <Label>ÐÐ¾Ð²Ð°Ñ ÑÑ‡ÐµÐ¹ÐºÐ°</Label>
                <Input
                  type="number"
                  min="1"
                  max="50"
                  value={cargoMoveForm.to_cell}
                  onChange={(e) => setCargoMoveForm({
                    ...cargoMoveForm,
                    to_cell: parseInt(e.target.value) || 1
                  })}
                />
              </div>
            </div>

            <div className="p-2 bg-blue-50 rounded text-sm text-blue-700">
              <strong>ÐÐ¾Ð²Ð¾Ðµ Ð¼ÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ:</strong> Ð‘{cargoMoveForm.to_block}-ÐŸ{cargoMoveForm.to_shelf}-Ð¯{cargoMoveForm.to_cell}
            </div>

            {/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ */}
            <div className="flex justify-end space-x-4 pt-4">
              <Button variant="outline" onClick={() => {
                setCargoMoveModal(false);
                setCargoMoveForm({
                  to_block: 1,
                  to_shelf: 1,
                  to_cell: 1
                });
              }}>
                ÐžÑ‚Ð¼ÐµÐ½Ð°
              </Button>
              <Button
                onClick={handleCargoMove}
                className="bg-blue-600 hover:bg-blue-700 text-white"
              >
                <Grid3X3 className="mr-2 h-4 w-4" />
                ÐŸÐµÑ€ÐµÐ¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ Ñ€Ð¾Ð»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ */}
      <Dialog open={showRoleModal} onOpenChange={setShowRoleModal}>
        <DialogContent className="sm:max-w-md">
          <DialogHeader>
            <DialogTitle>Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ñ€Ð¾Ð»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ</DialogTitle>
            <DialogDescription>
              Ð˜Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ðµ Ñ€Ð¾Ð»Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ {selectedUserForRole?.full_name}
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            {selectedUserForRole && (
              <div className="bg-gray-50 p-3 rounded-lg">
                <div className="text-sm">
                  <p><strong>ÐÐ¾Ð¼ÐµÑ€:</strong> {selectedUserForRole.user_number || 'N/A'}</p>
                  <p><strong>Ð¤Ð˜Ðž:</strong> {selectedUserForRole.full_name}</p>
                  <p><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:</strong> {selectedUserForRole.phone}</p>
                  <p><strong>Ð¢ÐµÐºÑƒÑ‰Ð°Ñ Ñ€Ð¾Ð»ÑŒ:</strong> {getRoleLabel(selectedUserForRole.role)}</p>
                </div>
              </div>
            )}
            
            <div>
              <Label htmlFor="role-select">ÐÐ¾Ð²Ð°Ñ Ñ€Ð¾Ð»ÑŒ</Label>
              <Select value={newRole} onValueChange={setNewRole}>
                <SelectTrigger>
                  <SelectValue placeholder="Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ñ€Ð¾Ð»ÑŒ" />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="user">ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ</SelectItem>
                  <SelectItem value="warehouse_operator">ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ ÑÐºÐ»Ð°Ð´Ð°</SelectItem>
                  <SelectItem value="admin">ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€</SelectItem>
                </SelectContent>
              </Select>
            </div>
          </div>
          
          <div className="flex justify-end space-x-2 mt-6">
            <Button 
              variant="outline" 
              onClick={() => {
                setShowRoleModal(false);
                setSelectedUserForRole(null);
                setNewRole('');
              }}
            >
              ÐžÑ‚Ð¼ÐµÐ½Ð°
            </Button>
            <Button 
              onClick={handleRoleChange}
              disabled={!newRole || newRole === selectedUserForRole?.role}
            >
              Ð˜Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ñ€Ð¾Ð»ÑŒ
            </Button>
          </div>
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° */}
      <Dialog open={showOperatorProfile} onOpenChange={setShowOperatorProfile}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° ÑÐºÐ»Ð°Ð´Ð°</DialogTitle>
            <DialogDescription>
              Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ñ€Ð°Ð±Ð¾Ñ‚Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° Ð¸ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ°
            </DialogDescription>
          </DialogHeader>
          
          {profileLoading ? (
            <div className="text-center py-8">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
              <p className="mt-2 text-gray-500">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ...</p>
            </div>
          ) : selectedOperatorProfile && (
            <div className="space-y-6">
              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ðµ */}
              <div className="bg-blue-50 p-4 rounded-lg">
                <h3 className="font-semibold text-lg mb-3">Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ðµ</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div>
                    <label className="text-sm font-medium text-gray-500">ÐÐ¾Ð¼ÐµÑ€</label>
                    <p className="text-lg">{selectedOperatorProfile.user_info.user_number}</p>
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-500">Ð¤Ð˜Ðž</label>
                    <p className="text-lg">{selectedOperatorProfile.user_info.full_name}</p>
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-500">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½</label>
                    <p className="text-lg">{selectedOperatorProfile.user_info.phone}</p>
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-500">Ð¡Ñ‚Ð°Ñ‚ÑƒÑ</label>
                    <Badge variant={selectedOperatorProfile.user_info.is_active ? 'default' : 'secondary'}>
                      {selectedOperatorProfile.user_info.is_active ? 'ÐÐºÑ‚Ð¸Ð²ÐµÐ½' : 'Ð—Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½'}
                    </Badge>
                  </div>
                </div>
              </div>

              {/* Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ */}
              <div className="bg-green-50 p-4 rounded-lg">
                <h3 className="font-semibold text-lg mb-3">Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="bg-white p-3 rounded border text-center">
                    <div className="text-2xl font-bold text-blue-600">
                      {selectedOperatorProfile.work_statistics.total_cargo_accepted}
                    </div>
                    <div className="text-sm text-gray-600">Ð’ÑÐµÐ³Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²</div>
                  </div>
                  <div className="bg-white p-3 rounded border text-center">
                    <div className="text-2xl font-bold text-green-600">
                      {selectedOperatorProfile.work_statistics.recent_cargo_count}
                    </div>
                    <div className="text-sm text-gray-600">Ð—Ð° 30 Ð´Ð½ÐµÐ¹</div>
                  </div>
                  <div className="bg-white p-3 rounded border text-center">
                    <div className="text-2xl font-bold text-orange-600">
                      {selectedOperatorProfile.work_statistics.avg_cargo_per_day}
                    </div>
                    <div className="text-sm text-gray-600">Ð’ Ð´ÐµÐ½ÑŒ (ÑÑ€ÐµÐ´Ð½.)</div>
                  </div>
                  <div className="bg-white p-3 rounded border text-center">
                    <div className="text-2xl font-bold text-purple-600">
                      {selectedOperatorProfile.associated_warehouses.length}
                    </div>
                    <div className="text-sm text-gray-600">Ð¡ÐºÐ»Ð°Ð´Ð¾Ð²</div>
                  </div>
                </div>
              </div>

              {/* Ð¡Ð²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ ÑÐºÐ»Ð°Ð´Ñ‹ */}
              {selectedOperatorProfile.associated_warehouses.length > 0 && (
                <div>
                  <h3 className="font-semibold text-lg mb-3">Ð¡Ð²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ ÑÐºÐ»Ð°Ð´Ñ‹</h3>
                  <div className="space-y-2">
                    {selectedOperatorProfile.associated_warehouses.map((warehouse, index) => (
                      <div key={`operator-warehouse-${warehouse.id || index}-${warehouse.name}`} className="bg-white border rounded-lg p-3">
                        <div className="flex justify-between items-center">
                          <div>
                            <h4 className="font-medium">{warehouse.name}</h4>
                            <p className="text-sm text-gray-600">{warehouse.location}</p>
                          </div>
                          <div className="text-right">
                            <div className="text-sm font-medium">{warehouse.cargo_count} Ð³Ñ€ÑƒÐ·Ð¾Ð²</div>
                            <div className="text-xs text-gray-500">
                              {warehouse.binding_date && new Date(warehouse.binding_date).toLocaleDateString('ru-RU')}
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÑÑ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ */}
              {selectedOperatorProfile.recent_activity.length > 0 && (
                <div>
                  <h3 className="font-semibold text-lg mb-3">ÐŸÐ¾ÑÐ»ÐµÐ´Ð½ÑÑ Ð°ÐºÑ‚Ð¸Ð²Ð½Ð¾ÑÑ‚ÑŒ</h3>
                  <div className="space-y-2 max-h-64 overflow-y-auto">
                    {selectedOperatorProfile.recent_activity.map((activity, index) => (
                      <div key={`activity-${activity.cargo_number || index}-${activity.cargo_name}`} className="bg-white border rounded-lg p-3">
                        <div className="flex justify-between items-start">
                          <div>
                            <h4 className="font-medium">{activity.cargo_number}</h4>
                            <p className="text-sm text-gray-600">{activity.cargo_name}</p>
                            <p className="text-sm text-gray-500">ÐžÑ‚: {activity.sender_full_name}</p>
                          </div>
                          <div className="text-right">
                            <Badge variant="outline">{activity.processing_status}</Badge>
                            <div className="text-xs text-gray-500 mt-1">
                              {new Date(activity.created_at).toLocaleDateString('ru-RU')}
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ */}
      <Dialog open={showUserProfile} onOpenChange={setShowUserProfile}>
        <DialogContent className="max-w-5xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>ÐŸÑ€Ð¾Ñ„Ð¸Ð»ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ</DialogTitle>
            <DialogDescription>
              Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ Ð¸ Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹
            </DialogDescription>
          </DialogHeader>
          
          {profileLoading ? (
            <div className="text-center py-8">
              <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600 mx-auto"></div>
              <p className="mt-2 text-gray-500">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ...</p>
            </div>
          ) : selectedUserProfile && (
            <div className="space-y-6">
              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ */}
              <div className="bg-blue-50 p-4 rounded-lg">
                <div className="flex justify-between items-start mb-3">
                  <h3 className="font-semibold text-lg">Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ðµ</h3>
                  {(user.role === 'warehouse_operator' || user.role === 'admin') && (
                    <Button
                      size="sm"
                      onClick={() => openQuickCargoFromProfile(selectedUserProfile.user_info)}
                      className="bg-green-600 hover:bg-green-700"
                    >
                      <Plus className="mr-2 h-4 w-4" />
                      ÐžÑ„Ð¾Ñ€Ð¼Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·Ñ‹
                    </Button>
                  )}
                </div>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div>
                    <label className="text-sm font-medium text-gray-500">ÐÐ¾Ð¼ÐµÑ€</label>
                    <p className="text-lg">{selectedUserProfile.user_info.user_number}</p>
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-500">Ð¤Ð˜Ðž</label>
                    <p className="text-lg">{selectedUserProfile.user_info.full_name}</p>
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-500">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½</label>
                    <p className="text-lg">{selectedUserProfile.user_info.phone}</p>
                  </div>
                  <div>
                    <label className="text-sm font-medium text-gray-500">Ð Ð¾Ð»ÑŒ</label>
                    <Badge variant="outline">{getRoleLabel(selectedUserProfile.user_info.role)}</Badge>
                  </div>
                </div>
              </div>

              {/* Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹ */}
              <div className="bg-green-50 p-4 rounded-lg">
                <h3 className="font-semibold text-lg mb-3">Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹</h3>
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="bg-white p-3 rounded border text-center">
                    <div className="text-2xl font-bold text-blue-600">
                      {selectedUserProfile.shipping_statistics.total_sent_cargo}
                    </div>
                    <div className="text-sm text-gray-600">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¾</div>
                  </div>
                  <div className="bg-white p-3 rounded border text-center">
                    <div className="text-2xl font-bold text-green-600">
                      {selectedUserProfile.shipping_statistics.total_received_cargo}
                    </div>
                    <div className="text-sm text-gray-600">ÐŸÐ¾Ð»ÑƒÑ‡ÐµÐ½Ð¾</div>
                  </div>
                  <div className="bg-white p-3 rounded border text-center">
                    <div className="text-2xl font-bold text-orange-600">
                      {selectedUserProfile.shipping_statistics.total_cargo_requests}
                    </div>
                    <div className="text-sm text-gray-600">Ð—Ð°ÑÐ²Ð¾Ðº</div>
                  </div>
                  <div className="bg-white p-3 rounded border text-center">
                    <div className="text-2xl font-bold text-purple-600">
                      {selectedUserProfile.frequent_recipients.length}
                    </div>
                    <div className="text-sm text-gray-600">ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÐµÐ¹</div>
                  </div>
                </div>
              </div>

              {/* Ð§Ð°ÑÑ‚Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ð¸ */}
              {selectedUserProfile.frequent_recipients.length > 0 && (
                <div>
                  <h3 className="font-semibold text-lg mb-3">Ð§Ð°ÑÑ‚Ð¾ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼Ñ‹Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ð¸</h3>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-3 max-h-48 overflow-y-auto">
                    {selectedUserProfile.frequent_recipients.slice(0, 6).map((recipient, index) => (
                      <div key={`recipient-${index}-${recipient.recipient_full_name}`} className="bg-white border rounded-lg p-3">
                        <div className="flex justify-between items-start">
                          <div>
                            <h4 className="font-medium">{recipient.recipient_full_name}</h4>
                            <p className="text-sm text-gray-600">{recipient.recipient_phone}</p>
                            <p className="text-xs text-gray-500">{recipient.recipient_address}</p>
                          </div>
                          <div className="text-right">
                            <div className="text-sm font-medium">{recipient.shipment_count} Ñ€Ð°Ð·</div>
                            <div className="text-xs text-gray-500">
                              {recipient.last_sent && new Date(recipient.last_sent).toLocaleDateString('ru-RU')}
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}

              {/* ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ */}
              {selectedUserProfile.recent_shipments.length > 0 && (
                <div>
                  <h3 className="font-semibold text-lg mb-3">ÐŸÐ¾ÑÐ»ÐµÐ´Ð½Ð¸Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ</h3>
                  <div className="space-y-2 max-h-64 overflow-y-auto">
                    {selectedUserProfile.recent_shipments.slice(0, 8).map((shipment, index) => (
                      <div key={`shipment-${shipment.cargo_number || index}-${shipment.cargo_name}`} className="bg-white border rounded-lg p-3">
                        <div className="flex justify-between items-start">
                          <div>
                            <h4 className="font-medium">{shipment.cargo_number} - {shipment.cargo_name}</h4>
                            <p className="text-sm text-gray-600">
                              {shipment.weight} ÐºÐ³ â€¢ {shipment.declared_value} Ñ€ÑƒÐ±
                            </p>
                            <p className="text-sm text-gray-500">
                              ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ: {shipment.recipient_full_name}
                            </p>
                          </div>
                          <div className="text-right">
                            <Badge variant="outline">{shipment.status}</Badge>
                            <div className="text-xs text-gray-500 mt-1">
                              {new Date(shipment.created_at).toLocaleDateString('ru-RU')}
                            </div>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </div>
              )}
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð±Ñ‹ÑÑ‚Ñ€Ð¾Ð³Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð° */}
      <Dialog open={showQuickCargoModal} onOpenChange={setShowQuickCargoModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>Ð‘Ñ‹ÑÑ‚Ñ€Ð¾Ðµ ÑÐ¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°</DialogTitle>
            <DialogDescription>
              Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° Ñ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¸ÐµÐ¼ Ð¸Ð· Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-6">
            {/* Ð’Ñ‹Ð±Ð¾Ñ€ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ Ð¸Ð· Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸ */}
            {frequentRecipients.length > 0 && (
              <div className="bg-blue-50 p-4 rounded-lg">
                <h3 className="font-semibold text-lg mb-3">Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ Ð¸Ð· Ð¸ÑÑ‚Ð¾Ñ€Ð¸Ð¸</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-2 max-h-32 overflow-y-auto">
                  {frequentRecipients.slice(0, 6).map((recipient, index) => (
                    <button
                      key={`frequent-recipient-${index}-${recipient.recipient_phone}`}
                      className={`p-2 text-left rounded border ${
                        selectedRecipient?.recipient_phone === recipient.recipient_phone
                          ? 'bg-blue-100 border-blue-300'
                          : 'bg-white hover:bg-gray-50'
                      }`}
                      onClick={() => selectRecipientFromHistory(recipient)}
                    >
                      <div className="font-medium text-sm">{recipient.recipient_full_name}</div>
                      <div className="text-xs text-gray-600">{recipient.recipient_phone}</div>
                      <div className="text-xs text-gray-500">{recipient.shipment_count} Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ð¹</div>
                    </button>
                  ))}
                </div>
              </div>
            )}

            {/* Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ */}
            <div>
              <h3 className="font-semibold text-lg mb-3">Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</h3>
              <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                <div>
                  <Label>Ð¤Ð˜Ðž Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</Label>
                  <Input
                    value={quickCargoForm.recipient_data.recipient_full_name || ''}
                    onChange={(e) => setQuickCargoForm({
                      ...quickCargoForm,
                      recipient_data: {
                        ...quickCargoForm.recipient_data,
                        recipient_full_name: e.target.value
                      }
                    })}
                    required
                  />
                </div>
                <div>
                  <Label>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</Label>
                  <Input
                    value={quickCargoForm.recipient_data.recipient_phone || ''}
                    onChange={(e) => setQuickCargoForm({
                      ...quickCargoForm,
                      recipient_data: {
                        ...quickCargoForm.recipient_data,
                        recipient_phone: e.target.value
                      }
                    })}
                    required
                  />
                </div>
                <div>
                  <Label>ÐÐ´Ñ€ÐµÑ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</Label>
                  <Input
                    value={quickCargoForm.recipient_data.recipient_address || ''}
                    onChange={(e) => setQuickCargoForm({
                      ...quickCargoForm,
                      recipient_data: {
                        ...quickCargoForm.recipient_data,
                        recipient_address: e.target.value
                      }
                    })}
                    required
                  />
                </div>
              </div>
            </div>

            {/* Ð“Ñ€ÑƒÐ·Ñ‹ */}
            <div className="bg-green-50 p-4 rounded-lg">
              <h3 className="font-semibold text-lg mb-3">Ð“Ñ€ÑƒÐ·Ñ‹</h3>
              {quickCargoForm.cargo_items.map((item, index) => (
                <div key={`quick-cargo-${index}-${item.cargo_name || 'empty'}`} className="mb-4 p-3 bg-white rounded border">
                  <div className="flex items-center justify-between mb-2">
                    <span className="font-medium text-sm">Ð“Ñ€ÑƒÐ· #{index + 1}</span>
                    {quickCargoForm.cargo_items.length > 1 && (
                      <Button
                        type="button"
                        variant="outline"
                        size="sm"
                        onClick={() => removeQuickCargoItem(index)}
                      >
                        <X className="h-4 w-4" />
                      </Button>
                    )}
                  </div>
                  
                  <div className="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                      <Label>ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ</Label>
                      <Input
                        value={item.cargo_name}
                        onChange={(e) => updateQuickCargoItem(index, 'cargo_name', e.target.value)}
                        placeholder="Ð”Ð¾ÐºÑƒÐ¼ÐµÐ½Ñ‚Ñ‹, Ð¾Ð´ÐµÐ¶Ð´Ð°..."
                        required
                      />
                    </div>
                    <div>
                      <Label>Ð’ÐµÑ (ÐºÐ³)</Label>
                      <Input
                        type="number"
                        step="0.1"
                        value={item.weight}
                        onChange={(e) => updateQuickCargoItem(index, 'weight', e.target.value)}
                        required
                      />
                    </div>
                    <div>
                      <Label>Ð¦ÐµÐ½Ð° Ð·Ð° ÐºÐ³ (Ñ€ÑƒÐ±.)</Label>
                      <Input
                        type="number"
                        step="0.01"
                        value={item.price_per_kg}
                        onChange={(e) => updateQuickCargoItem(index, 'price_per_kg', e.target.value)}
                        required
                      />
                    </div>
                  </div>
                  
                  {item.weight && item.price_per_kg && (
                    <div className="mt-2 p-2 bg-gray-50 rounded text-sm">
                      Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ: {parseFloat(item.weight)} ÐºÐ³ Ã— {parseFloat(item.price_per_kg)} Ñ€ÑƒÐ±/ÐºÐ³ = 
                      <span className="font-semibold text-green-600 ml-1">
                        {(parseFloat(item.weight) * parseFloat(item.price_per_kg)).toFixed(2)} Ñ€ÑƒÐ±
                      </span>
                    </div>
                  )}
                </div>
              ))}
              
              <Button
                type="button"
                variant="outline"
                onClick={addQuickCargoItem}
                className="w-full"
              >
                <Plus className="mr-2 h-4 w-4" />
                Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ ÐµÑ‰Ðµ Ð³Ñ€ÑƒÐ·
              </Button>
            </div>

            {/* Ð˜Ñ‚Ð¾Ð³Ð¸ */}
            <div className="bg-gray-50 p-4 rounded-lg">
              <h3 className="font-semibold text-lg mb-2">Ð˜Ñ‚Ð¾Ð³Ð¾</h3>
              <div className="grid grid-cols-2 gap-4">
                <div>
                  <span className="text-sm text-gray-600">ÐžÐ±Ñ‰Ð¸Ð¹ Ð²ÐµÑ:</span>
                  <div className="text-xl font-bold text-blue-600">
                    {calculateQuickCargoTotals().totalWeight.toFixed(1)} ÐºÐ³
                  </div>
                </div>
                <div>
                  <span className="text-sm text-gray-600">ÐžÐ±Ñ‰Ð°Ñ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ:</span>
                  <div className="text-xl font-bold text-green-600">
                    {calculateQuickCargoTotals().totalCost.toFixed(2)} Ñ€ÑƒÐ±
                  </div>
                </div>
              </div>
            </div>

            {/* ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ */}
            <div>
              <Label>ÐžÐ¿Ð¸ÑÐ°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°</Label>
              <textarea
                className="w-full p-2 border rounded-md"
                rows="3"
                value={quickCargoForm.description}
                onChange={(e) => setQuickCargoForm({...quickCargoForm, description: e.target.value})}
                placeholder="Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ..."
                required
              />
            </div>

            <div className="flex justify-end space-x-2">
              <Button 
                variant="outline" 
                onClick={() => setShowQuickCargoModal(false)}
              >
                ÐžÑ‚Ð¼ÐµÐ½Ð°
              </Button>
              <Button 
                onClick={submitQuickCargo}
                disabled={
                  !quickCargoForm.recipient_data.recipient_full_name ||
                  !quickCargoForm.recipient_data.recipient_phone ||
                  !quickCargoForm.description ||
                  quickCargoForm.cargo_items.some(item => !item.cargo_name || !item.weight || !item.price_per_kg)
                }
              >
                Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ */}
      <Dialog open={showEditProfile} onOpenChange={setShowEditProfile}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ</DialogTitle>
            <DialogDescription>
              ÐžÐ±Ð½Ð¾Ð²Ð¸Ñ‚Ðµ ÑÐ²Ð¾Ð¸ Ð»Ð¸Ñ‡Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <Label htmlFor="edit_full_name">ÐŸÐ¾Ð»Ð½Ð¾Ðµ Ð¸Ð¼Ñ</Label>
              <Input
                id="edit_full_name"
                value={editProfileForm.full_name}
                onChange={(e) => setEditProfileForm({...editProfileForm, full_name: e.target.value})}
                placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»Ð½Ð¾Ðµ Ð¸Ð¼Ñ"
              />
            </div>
            <div>
              <Label htmlFor="edit_phone">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½</Label>
              <Input
                id="edit_phone"
                value={editProfileForm.phone}
                onChange={(e) => setEditProfileForm({...editProfileForm, phone: e.target.value})}
                placeholder="+7XXXXXXXXXX"
              />
            </div>
            <div>
              <Label htmlFor="edit_email">Email (Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾)</Label>
              <Input
                id="edit_email"
                type="email"
                value={editProfileForm.email}
                onChange={(e) => setEditProfileForm({...editProfileForm, email: e.target.value})}
                placeholder="example@email.com"
              />
            </div>
            <div>
              <Label htmlFor="edit_address">ÐÐ´Ñ€ÐµÑ (Ð½ÐµÐ¾Ð±ÑÐ·Ð°Ñ‚ÐµÐ»ÑŒÐ½Ð¾)</Label>
              <Textarea
                id="edit_address"
                value={editProfileForm.address}
                onChange={(e) => setEditProfileForm({...editProfileForm, address: e.target.value})}
                placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð²Ð°Ñˆ Ð°Ð´Ñ€ÐµÑ"
                rows={3}
              />
            </div>
            <div className="flex justify-end space-x-2">
              <Button variant="outline" onClick={() => setShowEditProfile(false)}>
                ÐžÑ‚Ð¼ÐµÐ½Ð°
              </Button>
              <Button onClick={saveProfile}>
                <Save className="mr-2 h-4 w-4" />
                Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð° */}
      <Dialog open={showRepeatOrderModal} onOpenChange={setShowRepeatOrderModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð·</DialogTitle>
            <DialogDescription>
              Ð¡Ð¾Ð·Ð´Ð°Ð¹Ñ‚Ðµ Ð½Ð¾Ð²Ñ‹Ð¹ Ð·Ð°ÐºÐ°Ð· Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð° #{repeatOrderData?.cargo_number}
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-6">
            {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ðµ */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <Label htmlFor="repeat_recipient_name">ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ</Label>
                <Input
                  id="repeat_recipient_name"
                  value={repeatOrderForm.recipient_full_name}
                  onChange={(e) => setRepeatOrderForm({...repeatOrderForm, recipient_full_name: e.target.value})}
                  placeholder="Ð¤Ð˜Ðž Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ"
                />
              </div>
              <div>
                <Label htmlFor="repeat_recipient_phone">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</Label>
                <Input
                  id="repeat_recipient_phone"
                  value={repeatOrderForm.recipient_phone}
                  onChange={(e) => setRepeatOrderForm({...repeatOrderForm, recipient_phone: e.target.value})}
                  placeholder="+992XXXXXXXXX"
                />
              </div>
            </div>

            <div>
              <Label htmlFor="repeat_recipient_address">ÐÐ´Ñ€ÐµÑ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</Label>
              <Textarea
                id="repeat_recipient_address"
                value={repeatOrderForm.recipient_address}
                onChange={(e) => setRepeatOrderForm({...repeatOrderForm, recipient_address: e.target.value})}
                placeholder="ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð°Ð´Ñ€ÐµÑ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸"
                rows={2}
              />
            </div>

            {/* ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <Label htmlFor="repeat_route">ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚</Label>
                <Select value={repeatOrderForm.route} onValueChange={(value) => setRepeatOrderForm({...repeatOrderForm, route: value})}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="moscow_dushanbe">ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð”ÑƒÑˆÐ°Ð½Ð±Ðµ</SelectItem>
                    <SelectItem value="moscow_khujand">ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð¥ÑƒÐ´Ð¶Ð°Ð½Ð´</SelectItem>
                    <SelectItem value="moscow_kulob">ÐœÐ¾ÑÐºÐ²Ð° â†’ ÐšÑƒÐ»Ð¾Ð±</SelectItem>
                    <SelectItem value="moscow_kurgantyube">ÐœÐ¾ÑÐºÐ²Ð° â†’ ÐšÑƒÑ€Ð³Ð°Ð½-Ð¢ÑŽÐ±Ðµ</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label htmlFor="repeat_delivery_type">Ð¢Ð¸Ð¿ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸</Label>
                <Select value={repeatOrderForm.delivery_type} onValueChange={(value) => setRepeatOrderForm({...repeatOrderForm, delivery_type: value})}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="standard">Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð°Ñ</SelectItem>
                    <SelectItem value="express">Ð­ÐºÑÐ¿Ñ€ÐµÑÑ</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            {/* ÐœÑƒÐ»ÑŒÑ‚Ð¸-Ð³Ñ€ÑƒÐ· Ñ„Ð¾Ñ€Ð¼Ð° Ñ ÐºÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€Ð¾Ð¼ */}
            <div className="border rounded-lg p-4">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-medium">Ð“Ñ€ÑƒÐ·Ñ‹ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸</h3>
                <Button
                  type="button"
                  variant="outline"
                  size="sm"
                  onClick={addRepeatOrderItem}
                >
                  <Plus className="mr-1 h-4 w-4" />
                  Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·
                </Button>
              </div>

              {/* Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð³Ñ€ÑƒÐ·Ð¾Ð² */}
              <div className="space-y-4">
                {repeatOrderForm.cargo_items.map((item, index) => (
                  <div key={`repeat-cargo-${index}-${item.cargo_name || 'empty'}`} className="grid grid-cols-12 gap-4 items-end border rounded p-3 bg-gray-50">
                    <div className="col-span-4">
                      <Label>ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°</Label>
                      <Input
                        value={item.cargo_name}
                        onChange={(e) => handleRepeatOrderItemChange(index, 'cargo_name', e.target.value)}
                        placeholder="ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°"
                      />
                    </div>
                    <div className="col-span-3">
                      <Label>Ð’ÐµÑ (ÐºÐ³)</Label>
                      <Input
                        type="number"
                        value={item.weight}
                        onChange={(e) => handleRepeatOrderItemChange(index, 'weight', e.target.value)}
                        placeholder="0.0"
                        step="0.1"
                      />
                    </div>
                    <div className="col-span-3">
                      <Label>Ð¦ÐµÐ½Ð° Ð·Ð° ÐºÐ³ (â‚½)</Label>
                      <Input
                        type="number"
                        value={item.price_per_kg}
                        onChange={(e) => handleRepeatOrderItemChange(index, 'price_per_kg', e.target.value)}
                        placeholder="50"
                        step="0.01"
                      />
                    </div>
                    <div className="col-span-1">
                      <Label className="text-xs text-gray-600">Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ</Label>
                      <div className="text-sm font-medium">
                        {((parseFloat(item.weight) || 0) * (parseFloat(item.price_per_kg) || 0)).toFixed(2)} â‚½
                      </div>
                    </div>
                    <div className="col-span-1">
                      {repeatOrderForm.cargo_items.length > 1 && (
                        <Button
                          type="button"
                          variant="outline"
                          size="sm"
                          onClick={() => removeRepeatOrderItem(index)}
                          className="text-red-600 hover:text-red-700"
                        >
                          <Minus className="h-4 w-4" />
                        </Button>
                      )}
                    </div>
                  </div>
                ))}
              </div>

              {/* ÐšÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€ Ð¸Ñ‚Ð¾Ð³Ð¾Ð² */}
              <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                <h4 className="font-medium mb-3">Ð Ð°ÑÑ‡ÐµÑ‚ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸</h4>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="text-center">
                    <div className="text-2xl font-bold text-blue-600">
                      {repeatOrderTotalWeight.toFixed(2)} ÐºÐ³
                    </div>
                    <div className="text-sm text-gray-600">ÐžÐ±Ñ‰Ð¸Ð¹ Ð²ÐµÑ</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-bold text-green-600">
                      {repeatOrderTotalCost.toFixed(2)} â‚½
                    </div>
                    <div className="text-sm text-gray-600">ÐžÐ±Ñ‰Ð°Ñ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-bold text-purple-600">
                      {repeatOrderForm.cargo_items.length}
                    </div>
                    <div className="text-sm text-gray-600">ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²</div>
                  </div>
                </div>

                {/* Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ñ€Ð°Ð·Ð±Ð¸Ð²ÐºÐ° */}
                {repeatOrderBreakdown.length > 0 && (
                  <div className="mt-4">
                    <h5 className="text-sm font-medium mb-2">Ð”ÐµÑ‚Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð¾ Ð³Ñ€ÑƒÐ·Ð°Ð¼:</h5>
                    <div className="space-y-1">
                      {repeatOrderBreakdown.map((item, index) => (
                        <div key={`repeat-breakdown-${index}-${item.name}`} className="flex justify-between text-sm">
                          <span>{item.cargo_name}: {item.weight}ÐºÐ³ Ã— {item.price_per_kg}â‚½</span>
                          <span className="font-medium">{item.cost.toFixed(2)} â‚½</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¾Ð¿Ñ†Ð¸Ð¸ */}
            <div>
              <Label htmlFor="repeat_special_instructions">ÐžÑÐ¾Ð±Ñ‹Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¸Ñ</Label>
              <Textarea
                id="repeat_special_instructions"
                value={repeatOrderForm.special_instructions}
                onChange={(e) => setRepeatOrderForm({...repeatOrderForm, special_instructions: e.target.value})}
                placeholder="Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸"
                rows={2}
              />
            </div>

            {/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ */}
            <div className="flex justify-end space-x-2">
              <Button variant="outline" onClick={() => setShowRepeatOrderModal(false)}>
                ÐžÑ‚Ð¼ÐµÐ½Ð°
              </Button>
              <Button 
                onClick={submitRepeatOrder}
                disabled={
                  !repeatOrderForm.recipient_full_name ||
                  !repeatOrderForm.recipient_phone ||
                  repeatOrderForm.cargo_items.some(item => !item.cargo_name || !item.weight || !item.price_per_kg)
                }
              >
                <ShoppingCart className="mr-2 h-4 w-4" />
                Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð· ({repeatOrderTotalCost.toFixed(2)} â‚½)
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð¾Ð¼ */}
      <Dialog open={showAdminEditUser} onOpenChange={setShowAdminEditUser}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle>Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ</DialogTitle>
            <DialogDescription>
              Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¿Ñ€Ð¾Ñ„Ð¸Ð»Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ: {selectedUserForEdit?.full_name}
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <Label htmlFor="admin_edit_full_name">ÐŸÐ¾Ð»Ð½Ð¾Ðµ Ð¸Ð¼Ñ</Label>
              <Input
                id="admin_edit_full_name"
                value={adminEditUserForm.full_name}
                onChange={(e) => setAdminEditUserForm({...adminEditUserForm, full_name: e.target.value})}
                placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð¿Ð¾Ð»Ð½Ð¾Ðµ Ð¸Ð¼Ñ"
              />
            </div>
            <div>
              <Label htmlFor="admin_edit_phone">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½</Label>
              <Input
                id="admin_edit_phone"
                value={adminEditUserForm.phone}
                onChange={(e) => setAdminEditUserForm({...adminEditUserForm, phone: e.target.value})}
                placeholder="+7XXXXXXXXXX"
              />
            </div>
            <div>
              <Label htmlFor="admin_edit_email">Email</Label>
              <Input
                id="admin_edit_email"
                type="email"
                value={adminEditUserForm.email}
                onChange={(e) => setAdminEditUserForm({...adminEditUserForm, email: e.target.value})}
                placeholder="example@email.com"
              />
            </div>
            <div>
              <Label htmlFor="admin_edit_address">ÐÐ´Ñ€ÐµÑ</Label>
              <Textarea
                id="admin_edit_address"
                value={adminEditUserForm.address}
                onChange={(e) => setAdminEditUserForm({...adminEditUserForm, address: e.target.value})}
                placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð°Ð´Ñ€ÐµÑ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ"
                rows={3}
              />
            </div>
            <div>
              <Label htmlFor="admin_edit_role">Ð Ð¾Ð»ÑŒ</Label>
              <Select value={adminEditUserForm.role} onValueChange={(value) => setAdminEditUserForm({...adminEditUserForm, role: value})}>
                <SelectTrigger>
                  <SelectValue />
                </SelectTrigger>
                <SelectContent>
                  <SelectItem value="user">ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ</SelectItem>
                  <SelectItem value="warehouse_operator">ÐžÐ¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€ ÑÐºÐ»Ð°Ð´Ð°</SelectItem>
                  <SelectItem value="admin">ÐÐ´Ð¼Ð¸Ð½Ð¸ÑÑ‚Ñ€Ð°Ñ‚Ð¾Ñ€</SelectItem>
                </SelectContent>
              </Select>
            </div>
            <div className="flex items-center space-x-2">
              <input
                type="checkbox"
                id="admin_edit_active"
                checked={adminEditUserForm.is_active}
                onChange={(e) => setAdminEditUserForm({...adminEditUserForm, is_active: e.target.checked})}
              />
              <Label htmlFor="admin_edit_active">ÐÐºÑ‚Ð¸Ð²Ð½Ñ‹Ð¹ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ</Label>
            </div>
            <div className="flex justify-end space-x-2">
              <Button variant="outline" onClick={() => setShowAdminEditUser(false)}>
                ÐžÑ‚Ð¼ÐµÐ½Ð°
              </Button>
              <Button onClick={saveAdminUserEdit}>
                <Save className="mr-2 h-4 w-4" />
                Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ð¸Ð·Ð¼ÐµÐ½ÐµÐ½Ð¸Ñ
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð½Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð° Ð°Ð´Ð¼Ð¸Ð½Ð°/Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° */}
      <Dialog open={showAdminRepeatOrderModal} onOpenChange={setShowAdminRepeatOrderModal}>
        <DialogContent className="max-w-5xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle>ÐŸÐ¾Ð²Ñ‚Ð¾Ñ€Ð¸Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð· (Admin/Operator)</DialogTitle>
            <DialogDescription>
              Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¸Ðµ Ð½Ð¾Ð²Ð¾Ð³Ð¾ Ð·Ð°ÐºÐ°Ð·Ð° Ð½Ð° Ð¾ÑÐ½Ð¾Ð²Ðµ Ð³Ñ€ÑƒÐ·Ð° #{adminRepeatOrderData?.cargo_number}
              <br />
              <span className="text-xs text-gray-500">
                Ð”Ð°Ð½Ð½Ñ‹Ðµ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ñ‹. Ð—Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ð¾Ð².
              </span>
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-6">
            {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ðµ (Ð·Ð°Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ð°Ñ) */}
            <div className="bg-gray-50 p-4 rounded-lg">
              <h3 className="text-lg font-medium mb-3 flex items-center">
                <User className="mr-2 h-5 w-5" />
                ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ (Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾)
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <Label>Ð¤Ð˜Ðž Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ</Label>
                  <Input
                    value={adminRepeatOrderForm.sender_full_name}
                    onChange={(e) => setAdminRepeatOrderForm({...adminRepeatOrderForm, sender_full_name: e.target.value})}
                    placeholder="Ð¤Ð˜Ðž Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ"
                  />
                </div>
                <div>
                  <Label>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ</Label>
                  <Input
                    value={adminRepeatOrderForm.sender_phone}
                    onChange={(e) => setAdminRepeatOrderForm({...adminRepeatOrderForm, sender_phone: e.target.value})}
                    placeholder="+7XXXXXXXXXX"
                  />
                </div>
              </div>
            </div>

            {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ðµ (Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð½Ð°Ñ) */}
            <div className="bg-blue-50 p-4 rounded-lg">
              <h3 className="text-lg font-medium mb-3 flex items-center">
                <MapPin className="mr-2 h-5 w-5" />
                ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ (Ð°Ð²Ñ‚Ð¾Ð·Ð°Ð¿Ð¾Ð»Ð½ÐµÐ½Ð¾)
              </h3>
              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <Label>Ð¤Ð˜Ðž Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</Label>
                  <Input
                    value={adminRepeatOrderForm.recipient_full_name}
                    onChange={(e) => setAdminRepeatOrderForm({...adminRepeatOrderForm, recipient_full_name: e.target.value})}
                    placeholder="Ð¤Ð˜Ðž Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ"
                  />
                </div>
                <div>
                  <Label>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</Label>
                  <Input
                    value={adminRepeatOrderForm.recipient_phone}
                    onChange={(e) => setAdminRepeatOrderForm({...adminRepeatOrderForm, recipient_phone: e.target.value})}
                    placeholder="+992XXXXXXXXX"
                  />
                </div>
              </div>
              <div className="mt-4">
                <Label>ÐÐ´Ñ€ÐµÑ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ</Label>
                <Textarea
                  value={adminRepeatOrderForm.recipient_address}
                  onChange={(e) => setAdminRepeatOrderForm({...adminRepeatOrderForm, recipient_address: e.target.value})}
                  placeholder="ÐŸÐ¾Ð»Ð½Ñ‹Ð¹ Ð°Ð´Ñ€ÐµÑ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸"
                  rows={2}
                />
              </div>
            </div>

            {/* ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚ Ð¸ Ñ‚Ð¸Ð¿ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸ */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <Label>ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚</Label>
                <Select value={adminRepeatOrderForm.route} onValueChange={(value) => setAdminRepeatOrderForm({...adminRepeatOrderForm, route: value})}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="moscow_dushanbe">ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð”ÑƒÑˆÐ°Ð½Ð±Ðµ</SelectItem>
                    <SelectItem value="moscow_khujand">ÐœÐ¾ÑÐºÐ²Ð° â†’ Ð¥ÑƒÐ´Ð¶Ð°Ð½Ð´</SelectItem>
                    <SelectItem value="moscow_kulob">ÐœÐ¾ÑÐºÐ²Ð° â†’ ÐšÑƒÐ»Ð¾Ð±</SelectItem>
                    <SelectItem value="moscow_kurgantyube">ÐœÐ¾ÑÐºÐ²Ð° â†’ ÐšÑƒÑ€Ð³Ð°Ð½-Ð¢ÑŽÐ±Ðµ</SelectItem>
                  </SelectContent>
                </Select>
              </div>
              <div>
                <Label>Ð¢Ð¸Ð¿ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸</Label>
                <Select value={adminRepeatOrderForm.delivery_type} onValueChange={(value) => setAdminRepeatOrderForm({...adminRepeatOrderForm, delivery_type: value})}>
                  <SelectTrigger>
                    <SelectValue />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="standard">Ð¡Ñ‚Ð°Ð½Ð´Ð°Ñ€Ñ‚Ð½Ð°Ñ</SelectItem>
                    <SelectItem value="express">Ð­ÐºÑÐ¿Ñ€ÐµÑÑ</SelectItem>
                  </SelectContent>
                </Select>
              </div>
            </div>

            {/* ÐœÑƒÐ»ÑŒÑ‚Ð¸-Ð³Ñ€ÑƒÐ· Ñ„Ð¾Ñ€Ð¼Ð° Ñ ÐºÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€Ð¾Ð¼ Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð° */}
            <div className="border rounded-lg p-4">
              <div className="flex items-center justify-between mb-4">
                <h3 className="text-lg font-medium flex items-center">
                  <Package className="mr-2 h-5 w-5" />
                  Ð“Ñ€ÑƒÐ·Ñ‹ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²ÐºÐ¸ (Ð·Ð°Ð¿Ð¾Ð»Ð½Ð¸Ñ‚Ðµ Ð·Ð°Ð½Ð¾Ð²Ð¾)
                </h3>
                <Button
                  type="button"
                  variant="outline"
                  size="sm"
                  onClick={addAdminRepeatOrderItem}
                >
                  <Plus className="mr-1 h-4 w-4" />
                  Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·
                </Button>
              </div>

              {/* Ð¡Ð¿Ð¸ÑÐ¾Ðº Ð³Ñ€ÑƒÐ·Ð¾Ð² */}
              <div className="space-y-4">
                {adminRepeatOrderForm.cargo_items.map((item, index) => (
                  <div key={`repeat-cargo-${index}-${item.cargo_name || 'empty'}`} className="grid grid-cols-12 gap-4 items-end border rounded p-3 bg-gray-50">
                    <div className="col-span-4">
                      <Label>ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° *</Label>
                      <Input
                        value={item.cargo_name}
                        onChange={(e) => handleAdminRepeatOrderItemChange(index, 'cargo_name', e.target.value)}
                        placeholder="ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°"
                      />
                    </div>
                    <div className="col-span-3">
                      <Label>Ð’ÐµÑ (ÐºÐ³) *</Label>
                      <Input
                        type="number"
                        value={item.weight}
                        onChange={(e) => handleAdminRepeatOrderItemChange(index, 'weight', e.target.value)}
                        placeholder="0.0"
                        step="0.1"
                      />
                    </div>
                    <div className="col-span-3">
                      <Label>Ð¦ÐµÐ½Ð° Ð·Ð° ÐºÐ³ (â‚½) *</Label>
                      <Input
                        type="number"
                        value={item.price_per_kg}
                        onChange={(e) => handleAdminRepeatOrderItemChange(index, 'price_per_kg', e.target.value)}
                        placeholder="50"
                        step="0.01"
                      />
                    </div>
                    <div className="col-span-1">
                      <Label className="text-xs text-gray-600">Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ</Label>
                      <div className="text-sm font-medium">
                        {((parseFloat(item.weight) || 0) * (parseFloat(item.price_per_kg) || 0)).toFixed(2)} â‚½
                      </div>
                    </div>
                    <div className="col-span-1">
                      {adminRepeatOrderForm.cargo_items.length > 1 && (
                        <Button
                          type="button"
                          variant="outline"
                          size="sm"
                          onClick={() => removeAdminRepeatOrderItem(index)}
                          className="text-red-600 hover:text-red-700"
                        >
                          <Minus className="h-4 w-4" />
                        </Button>
                      )}
                    </div>
                  </div>
                ))}
              </div>

              {/* ÐšÐ°Ð»ÑŒÐºÑƒÐ»ÑÑ‚Ð¾Ñ€ Ð¸Ñ‚Ð¾Ð³Ð¾Ð² Ð´Ð»Ñ Ð°Ð´Ð¼Ð¸Ð½Ð° */}
              <div className="mt-4 p-4 bg-green-50 rounded-lg">
                <h4 className="font-medium mb-3 flex items-center">
                  <Calculator className="mr-2 h-4 w-4" />
                  Ð Ð°ÑÑ‡ÐµÑ‚ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚Ð¸
                </h4>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="text-center">
                    <div className="text-2xl font-bold text-blue-600">
                      {adminRepeatOrderTotalWeight.toFixed(2)} ÐºÐ³
                    </div>
                    <div className="text-sm text-gray-600">ÐžÐ±Ñ‰Ð¸Ð¹ Ð²ÐµÑ</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-bold text-green-600">
                      {adminRepeatOrderTotalCost.toFixed(2)} â‚½
                    </div>
                    <div className="text-sm text-gray-600">ÐžÐ±Ñ‰Ð°Ñ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ</div>
                  </div>
                  <div className="text-center">
                    <div className="text-2xl font-bold text-purple-600">
                      {adminRepeatOrderForm.cargo_items.length}
                    </div>
                    <div className="text-sm text-gray-600">ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²</div>
                  </div>
                </div>

                {/* Ð”ÐµÑ‚Ð°Ð»ÑŒÐ½Ð°Ñ Ñ€Ð°Ð·Ð±Ð¸Ð²ÐºÐ° */}
                {adminRepeatOrderBreakdown.length > 0 && (
                  <div className="mt-4">
                    <h5 className="text-sm font-medium mb-2">Ð”ÐµÑ‚Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð¾ Ð³Ñ€ÑƒÐ·Ð°Ð¼:</h5>
                    <div className="space-y-1">
                      {adminRepeatOrderBreakdown.map((item, index) => (
                        <div key={`admin-repeat-breakdown-${index}-${item.cargo_name || index}`} className="flex justify-between text-sm">
                          <span>{item.cargo_name || `Ð“Ñ€ÑƒÐ· ${index + 1}`}: {item.weight}ÐºÐ³ Ã— {item.price_per_kg}â‚½</span>
                          <span className="font-medium">{item.cost.toFixed(2)} â‚½</span>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </div>
            </div>

            {/* Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ñ‹Ðµ Ð¾Ð¿Ñ†Ð¸Ð¸ */}
            <div>
              <Label>ÐžÑÐ¾Ð±Ñ‹Ðµ ÑƒÐºÐ°Ð·Ð°Ð½Ð¸Ñ</Label>
              <Textarea
                value={adminRepeatOrderForm.special_instructions}
                onChange={(e) => setAdminRepeatOrderForm({...adminRepeatOrderForm, special_instructions: e.target.value})}
                placeholder="Ð”Ð¾Ð¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒÐ½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð´Ð»Ñ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸"
                rows={2}
              />
            </div>

            {/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ */}
            <div className="flex justify-end space-x-2">
              <Button variant="outline" onClick={() => setShowAdminRepeatOrderModal(false)}>
                ÐžÑ‚Ð¼ÐµÐ½Ð°
              </Button>
              <Button 
                onClick={submitAdminRepeatOrder}
                disabled={
                  !adminRepeatOrderForm.recipient_full_name ||
                  !adminRepeatOrderForm.recipient_phone ||
                  !adminRepeatOrderForm.sender_full_name ||
                  !adminRepeatOrderForm.sender_phone ||
                  adminRepeatOrderForm.cargo_items.some(item => !item.cargo_name || !item.weight || !item.price_per_kg)
                }
                className="bg-orange-600 hover:bg-orange-700 text-white"
              >
                <ShoppingCart className="mr-2 h-4 w-4" />
                Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ Ð·Ð°ÐºÐ°Ð· ({adminRepeatOrderTotalCost.toFixed(2)} â‚½)
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð½Ð¾Ð³Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð° Ñ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¾Ð¹ */}
      <Dialog open={enhancedPlacementModal} onOpenChange={setEnhancedPlacementModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Grid3X3 className="mr-2 h-5 w-5" />
              Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° Ñ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ¾Ð¹ ÑÐºÐ»Ð°Ð´Ð¾Ð²
            </DialogTitle>
            <DialogDescription>
              {selectedCargoForEnhancedPlacement && (
                <span>Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°: <strong>{selectedCargoForEnhancedPlacement.cargo_number}</strong> - {selectedCargoForEnhancedPlacement.cargo_name}</span>
              )}
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-6">
            {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ */}
            {selectedCargoForEnhancedPlacement && (
              <div className="bg-blue-50 border border-blue-200 rounded-lg p-4">
                <h3 className="font-semibold text-blue-800 mb-3 flex items-center">
                  <Package className="mr-2 h-4 w-4" />
                  Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰Ð°ÐµÐ¼Ð¾Ð¼ Ð³Ñ€ÑƒÐ·Ðµ
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div>
                    <p><strong>ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°:</strong> {selectedCargoForEnhancedPlacement.cargo_number}</p>
                    <p><strong>ÐÐ°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ:</strong> {selectedCargoForEnhancedPlacement.cargo_name}</p>
                    <p><strong>ÐžÐ±Ñ‰Ð¸Ð¹ Ð²ÐµÑ:</strong> {selectedCargoForEnhancedPlacement.total_weight} ÐºÐ³</p>
                  </div>
                  <div>
                    <p><strong>Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ:</strong> {selectedCargoForEnhancedPlacement.total_cost} Ñ€ÑƒÐ±</p>
                    <p><strong>ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ:</strong> {selectedCargoForEnhancedPlacement.sender_name}</p>
                    <p><strong>ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ:</strong> {selectedCargoForEnhancedPlacement.receiver_name}</p>
                  </div>
                </div>
              </div>
            )}

            {/* ÐÐ½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ° ÑÐºÐ»Ð°Ð´Ð¾Ð² */}
            {warehouseAnalytics && (
              <div className="bg-green-50 border border-green-200 rounded-lg p-4">
                <h3 className="font-semibold text-green-800 mb-3 flex items-center">
                  <Warehouse className="mr-2 h-4 w-4" />
                  ÐÐ½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ° ÑÐºÐ»Ð°Ð´Ð¾Ð²
                </h3>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  <div className="text-center p-3 bg-white rounded border">
                    <div className="text-2xl font-bold text-blue-600">{warehouseAnalytics.total_warehouses || 0}</div>
                    <div className="text-sm text-gray-600">Ð’ÑÐµÐ³Ð¾ ÑÐºÐ»Ð°Ð´Ð¾Ð²</div>
                  </div>
                  <div className="text-center p-3 bg-white rounded border">
                    <div className="text-2xl font-bold text-green-600">{warehouseAnalytics.available_cells || 0}</div>
                    <div className="text-sm text-gray-600">Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ñ‹Ñ… ÑÑ‡ÐµÐµÐº</div>
                  </div>
                  <div className="text-center p-3 bg-white rounded border">
                    <div className="text-2xl font-bold text-orange-600">{warehouseAnalytics.occupied_cells || 0}</div>
                    <div className="text-sm text-gray-600">Ð—Ð°Ð½ÑÑ‚Ñ‹Ñ… ÑÑ‡ÐµÐµÐº</div>
                  </div>
                </div>
              </div>
            )}

            {/* Ð’Ñ‹Ð±Ð¾Ñ€ ÑÐºÐ»Ð°Ð´Ð° */}
            <div className="space-y-4">
              <h3 className="font-semibold text-lg flex items-center">
                <Building className="mr-2 h-5 w-5" />
                Ð’Ñ‹Ð±Ð¾Ñ€ ÑÐºÐ»Ð°Ð´Ð°
              </h3>
              
              <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {warehouses.map((warehouse) => (
                  <div
                    key={warehouse.id}
                    className={`border-2 rounded-lg p-4 cursor-pointer transition-all ${
                      selectedWarehouseForPlacement === warehouse.id
                        ? 'border-blue-500 bg-blue-50'
                        : 'border-gray-200 hover:border-gray-300'
                    }`}
                    onClick={() => handleWarehouseSelectionForPlacement(warehouse.id)}
                  >
                    <div className="flex justify-between items-start mb-2">
                      <h4 className="font-medium">{warehouse.name}</h4>
                      {selectedWarehouseForPlacement === warehouse.id && (
                        <CheckCircle className="h-5 w-5 text-blue-500" />
                      )}
                    </div>
                    <p className="text-sm text-gray-600 mb-2">{warehouse.address}</p>
                    <div className="flex justify-between text-xs">
                      <span>Ð‘Ð»Ð¾ÐºÐ¸: {warehouse.blocks_count || 10}</span>
                      <span>ÐŸÐ¾Ð»ÐºÐ¸: {warehouse.shelves_per_block || 10}</span>
                      <span>Ð¯Ñ‡ÐµÐ¹ÐºÐ¸: {warehouse.cells_per_shelf || 10}</span>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            {/* Ð’Ñ‹Ð±Ð¾Ñ€ Ð±Ð»Ð¾ÐºÐ°, Ð¿Ð¾Ð»ÐºÐ¸ Ð¸ ÑÑ‡ÐµÐ¹ÐºÐ¸ */}
            {selectedWarehouseForPlacement && (
              <div className="space-y-4 bg-gray-50 border border-gray-200 rounded-lg p-4">
                <h3 className="font-semibold text-lg flex items-center">
                  <MapPin className="mr-2 h-5 w-5" />
                  Ð’Ñ‹Ð±Ð¾Ñ€ Ð¼ÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ñ
                  {structureLoading && (
                    <RefreshCw className="ml-2 h-4 w-4 animate-spin text-blue-500" />
                  )}
                </h3>
                
                {/* ÐŸÐ¾ÐºÐ°Ð·Ñ‹Ð²Ð°ÐµÐ¼ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÑƒ ÑÐºÐ»Ð°Ð´Ð° */}
                {warehouseDetailedStructure?.statistics && (
                  <div className="bg-white border border-gray-200 rounded-lg p-3 mb-4">
                    <div className="grid grid-cols-3 gap-4 text-center">
                      <div>
                        <div className="text-lg font-bold text-blue-600">{warehouseDetailedStructure.statistics.total_cells}</div>
                        <div className="text-xs text-gray-600">Ð’ÑÐµÐ³Ð¾ ÑÑ‡ÐµÐµÐº</div>
                      </div>
                      <div>
                        <div className="text-lg font-bold text-green-600">{warehouseDetailedStructure.statistics.available_cells}</div>
                        <div className="text-xs text-gray-600">Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ñ‹Ñ…</div>
                      </div>
                      <div>
                        <div className="text-lg font-bold text-red-600">{warehouseDetailedStructure.statistics.occupied_cells}</div>
                        <div className="text-xs text-gray-600">Ð—Ð°Ð½ÑÑ‚Ñ‹Ñ…</div>
                      </div>
                    </div>
                    <div className="mt-2 text-center">
                      <div className="text-sm text-gray-600">
                        Ð—Ð°Ð½ÑÑ‚Ð¾ÑÑ‚ÑŒ: {warehouseDetailedStructure.statistics.occupancy_rate}%
                      </div>
                    </div>
                  </div>
                )}

                {/* Ð¡ÐµÐ»ÐµÐºÑ‚Ð¾Ñ€Ñ‹ Ð´Ð»Ñ Ð²Ñ‹Ð±Ð¾Ñ€Ð° Ð¼ÐµÑÑ‚Ð° */}
                <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
                  {/* Ð’Ñ‹Ð±Ð¾Ñ€ Ð±Ð»Ð¾ÐºÐ° */}
                  <div>
                    <Label>Ð‘Ð»Ð¾Ðº</Label>
                    <Select 
                      value={selectedBlockForPlacement.toString()} 
                      onValueChange={(value) => {
                        const blockNumber = parseInt(value);
                        handleBlockShelfSelection(blockNumber, selectedShelfForPlacement);
                      }}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        {warehouseDetailedStructure?.blocks?.map(block => (
                          <SelectItem key={block.block_number} value={block.block_number.toString()}>
                            Ð‘Ð»Ð¾Ðº {block.block_number}
                          </SelectItem>
                        )) || 
                        Array.from({length: 10}, (_, i) => i + 1).map(blockNum => (
                          <SelectItem key={blockNum} value={blockNum.toString()}>
                            Ð‘Ð»Ð¾Ðº {blockNum}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  {/* Ð’Ñ‹Ð±Ð¾Ñ€ Ð¿Ð¾Ð»ÐºÐ¸ */}
                  <div>
                    <Label>ÐŸÐ¾Ð»ÐºÐ°</Label>
                    <Select 
                      value={selectedShelfForPlacement.toString()} 
                      onValueChange={(value) => {
                        const shelfNumber = parseInt(value);
                        handleBlockShelfSelection(selectedBlockForPlacement, shelfNumber);
                      }}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        {warehouseDetailedStructure?.blocks?.find(b => b.block_number === selectedBlockForPlacement)?.shelves?.map(shelf => (
                          <SelectItem key={shelf.shelf_number} value={shelf.shelf_number.toString()}>
                            ÐŸÐ¾Ð»ÐºÐ° {shelf.shelf_number}
                          </SelectItem>
                        )) ||
                        Array.from({length: 10}, (_, i) => i + 1).map(shelfNum => (
                          <SelectItem key={shelfNum} value={shelfNum.toString()}>
                            ÐŸÐ¾Ð»ÐºÐ° {shelfNum}
                          </SelectItem>
                        ))}
                      </SelectContent>
                    </Select>
                  </div>

                  {/* Ð’Ñ‹Ð±Ð¾Ñ€ ÑÑ‡ÐµÐ¹ÐºÐ¸ */}
                  <div>
                    <Label>Ð¯Ñ‡ÐµÐ¹ÐºÐ°</Label>
                    <Select 
                      value={selectedCellForPlacement.toString()} 
                      onValueChange={(value) => handleCellSelection(parseInt(value))}
                    >
                      <SelectTrigger>
                        <SelectValue />
                      </SelectTrigger>
                      <SelectContent>
                        {warehouseDetailedStructure?.blocks
                          ?.find(b => b.block_number === selectedBlockForPlacement)?.shelves
                          ?.find(s => s.shelf_number === selectedShelfForPlacement)?.cells
                          ?.map(cell => (
                            <SelectItem 
                              key={cell.cell_number} 
                              value={cell.cell_number.toString()}
                              disabled={cell.status === 'occupied'}
                              className={cell.status === 'occupied' ? 'text-red-500' : 'text-green-600'}
                            >
                              Ð¯Ñ‡ÐµÐ¹ÐºÐ° {cell.cell_number} {cell.status === 'occupied' ? '(Ð—ÐÐÐ¯Ð¢Ð)' : '(ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð°)'}
                              {cell.cargo_info && (
                                <span className="text-xs block text-red-600">
                                  {cell.cargo_info.cargo_number}
                                </span>
                              )}
                            </SelectItem>
                          )) ||
                          availableCellsForPlacement.map(cellNum => (
                            <SelectItem key={cellNum} value={cellNum.toString()}>
                              Ð¯Ñ‡ÐµÐ¹ÐºÐ° {cellNum} (ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð°)
                            </SelectItem>
                          )) ||
                          Array.from({length: 10}, (_, i) => i + 1).map(cellNum => (
                            <SelectItem key={cellNum} value={cellNum.toString()}>
                              Ð¯Ñ‡ÐµÐ¹ÐºÐ° {cellNum}
                            </SelectItem>
                          ))
                        }
                      </SelectContent>
                    </Select>
                  </div>
                </div>

                {/* Ð’Ð¸Ð·ÑƒÐ°Ð»ÑŒÐ½Ð°Ñ ÑÐµÑ‚ÐºÐ° ÑÑ‡ÐµÐµÐº Ð´Ð»Ñ Ð²Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð¾Ð¹ Ð¿Ð¾Ð»ÐºÐ¸ */}
                {warehouseDetailedStructure && (
                  <div className="mt-6">
                    <h4 className="font-medium mb-3 flex items-center">
                      <Grid3X3 className="mr-2 h-4 w-4" />
                      Ð’Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð¿Ð¾Ð»ÐºÐ¸ {selectedShelfForPlacement} (Ð‘Ð»Ð¾Ðº {selectedBlockForPlacement})
                    </h4>
                    <div className="border border-gray-300 rounded-lg p-4 bg-white">
                      <div className="grid grid-cols-5 gap-2 max-w-lg">
                        {warehouseDetailedStructure.blocks
                          ?.find(b => b.block_number === selectedBlockForPlacement)?.shelves
                          ?.find(s => s.shelf_number === selectedShelfForPlacement)?.cells
                          ?.map(cell => (
                            <button
                              key={cell.cell_number}
                              onClick={() => handleCellSelection(cell.cell_number)}
                              disabled={cell.status === 'occupied'}
                              className={`
                                w-12 h-12 rounded border-2 text-xs font-medium transition-all
                                ${cell.cell_number === selectedCellForPlacement 
                                  ? 'border-blue-500 bg-blue-100 text-blue-700 shadow-md' 
                                  : cell.status === 'occupied' 
                                  ? 'border-red-300 bg-red-100 text-red-600 cursor-not-allowed opacity-60'
                                  : 'border-gray-300 bg-green-50 text-green-700 hover:border-green-400 hover:bg-green-100'
                                }
                              `}
                              title={cell.status === 'occupied' 
                                ? `Ð—Ð°Ð½ÑÑ‚Ð°: ${cell.cargo_info?.cargo_number || 'Ð“Ñ€ÑƒÐ·'}`
                                : `Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð°: Ð¯Ñ‡ÐµÐ¹ÐºÐ° ${cell.cell_number}`
                              }
                            >
                              {cell.cell_number}
                            </button>
                          )) ||
                          // Fallback ÐµÑÐ»Ð¸ Ð½ÐµÑ‚ Ð´ÐµÑ‚Ð°Ð»ÑŒÐ½Ñ‹Ñ… Ð´Ð°Ð½Ð½Ñ‹Ñ…
                          Array.from({length: 10}, (_, i) => i + 1).map(cellNum => (
                            <button
                              key={cellNum}
                              onClick={() => handleCellSelection(cellNum)}
                              className={`
                                w-12 h-12 rounded border-2 text-xs font-medium transition-all
                                ${cellNum === selectedCellForPlacement 
                                  ? 'border-blue-500 bg-blue-100 text-blue-700 shadow-md' 
                                  : 'border-gray-300 bg-green-50 text-green-700 hover:border-green-400 hover:bg-green-100'
                                }
                              `}
                            >
                              {cellNum}
                            </button>
                          ))
                        }
                      </div>
                      
                      {/* Ð›ÐµÐ³ÐµÐ½Ð´Ð° */}
                      <div className="flex flex-wrap gap-4 mt-4 text-xs">
                        <div className="flex items-center">
                          <div className="w-4 h-4 bg-green-50 border border-gray-300 rounded mr-2"></div>
                          <span>Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð°Ñ</span>
                        </div>
                        <div className="flex items-center">
                          <div className="w-4 h-4 bg-red-100 border border-red-300 rounded mr-2"></div>
                          <span>Ð—Ð°Ð½ÑÑ‚Ð°Ñ</span>
                        </div>
                        <div className="flex items-center">
                          <div className="w-4 h-4 bg-blue-100 border-2 border-blue-500 rounded mr-2"></div>
                          <span>Ð’Ñ‹Ð±Ñ€Ð°Ð½Ð½Ð°Ñ</span>
                        </div>
                      </div>
                    </div>
                  </div>
                )}

                {/* ÐŸÑ€ÐµÐ´Ð¿Ñ€Ð¾ÑÐ¼Ð¾Ñ‚Ñ€ Ð°Ð´Ñ€ÐµÑÐ° */}
                <div className="mt-4 p-3 bg-white border rounded-lg">
                  <p className="text-sm text-gray-600 mb-1">ÐÐ´Ñ€ÐµÑ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ:</p>
                  <p className="font-mono text-lg font-bold">
                    {warehouses.find(w => w.id === selectedWarehouseForPlacement)?.name || 'Ð¡ÐºÐ»Ð°Ð´'} - 
                    Ð‘Ð»Ð¾Ðº {selectedBlockForPlacement} - 
                    ÐŸÐ¾Ð»ÐºÐ° {selectedShelfForPlacement} - 
                    Ð¯Ñ‡ÐµÐ¹ÐºÐ° {selectedCellForPlacement}
                    {!isCellAvailable(selectedBlockForPlacement, selectedShelfForPlacement, selectedCellForPlacement) && (
                      <span className="text-red-600 ml-2">âš ï¸ Ð—ÐÐÐ¯Ð¢Ð</span>
                    )}
                  </p>
                  {selectedCellForVisualization?.info?.cargo_info && (
                    <div className="mt-2 text-sm text-red-600">
                      <strong>Ð’Ð½Ð¸Ð¼Ð°Ð½Ð¸Ðµ!</strong> Ð¯Ñ‡ÐµÐ¹ÐºÐ° Ð·Ð°Ð½ÑÑ‚Ð° Ð³Ñ€ÑƒÐ·Ð¾Ð¼: {selectedCellForVisualization.info.cargo_info.cargo_number}
                    </div>
                  )}
                </div>
              </div>
            )}

            {/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ð¹ */}
            <div className="flex justify-end space-x-2 pt-4 border-t">
              <Button 
                variant="outline" 
                onClick={() => setEnhancedPlacementModal(false)}
                disabled={placementLoading}
              >
                ÐžÑ‚Ð¼ÐµÐ½Ð°
              </Button>
              <Button
                onClick={handleEnhancedCargoPlacement}
                disabled={
                  !selectedCargoForEnhancedPlacement || 
                  !selectedWarehouseForPlacement || 
                  placementLoading ||
                  !isCellAvailable(selectedBlockForPlacement, selectedShelfForPlacement, selectedCellForPlacement)
                }
                className={`${
                  isCellAvailable(selectedBlockForPlacement, selectedShelfForPlacement, selectedCellForPlacement)
                    ? 'bg-green-600 hover:bg-green-700 text-white'
                    : 'bg-red-500 hover:bg-red-600 text-white'
                }`}
              >
                {placementLoading ? (
                  <>
                    <RefreshCw className="mr-2 h-4 w-4 animate-spin" />
                    Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ...
                  </>
                ) : !isCellAvailable(selectedBlockForPlacement, selectedShelfForPlacement, selectedCellForPlacement) ? (
                  <>
                    <Ban className="mr-2 h-4 w-4" />
                    Ð¯Ñ‡ÐµÐ¹ÐºÐ° Ð·Ð°Ð½ÑÑ‚Ð°
                  </>
                ) : (
                  <>
                    <Grid3X3 className="mr-2 h-4 w-4" />
                    Ð¡Ð¾Ñ…Ñ€Ð°Ð½Ð¸Ñ‚ÑŒ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ
                  </>
                )}
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð¿Ð¾Ð´Ñ‚Ð²ÐµÑ€Ð¶Ð´ÐµÐ½Ð¸Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ */}
      <Dialog open={deleteConfirmModal} onOpenChange={setDeleteConfirmModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="text-red-600">
              <Trash2 className="mr-2 h-5 w-5 inline" />
              ÐŸÐ¾Ð´Ñ‚Ð²ÐµÑ€Ð´Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ
            </DialogTitle>
          </DialogHeader>
          
          {deleteConfirmData && (
            <div className="space-y-4">
              <div className="p-4 bg-red-50 rounded-lg border border-red-200">
                <h4 className="font-medium text-red-800 mb-2">
                  {deleteConfirmData.isBulk 
                    ? `Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ${deleteConfirmData.count} ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚(Ð¾Ð²)` 
                    : 'Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ ÑÐ»ÐµÐ¼ÐµÐ½Ñ‚Ð°'
                  }
                </h4>
                <p className="text-sm text-red-700">
                  {deleteConfirmData.type === 'warehouse' && (
                    deleteConfirmData.isBulk 
                      ? `Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ${deleteConfirmData.count} ÑÐºÐ»Ð°Ð´(Ð¾Ð²)? Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾.`
                      : `Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ÑÐºÐ»Ð°Ð´ "${deleteConfirmData.items[0]?.name}"? Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾.`
                  )}
                  {deleteConfirmData.type === 'cargo' && (
                    deleteConfirmData.isBulk 
                      ? `Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ${deleteConfirmData.count} Ð³Ñ€ÑƒÐ·(Ð¾Ð²)? Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: Ð•ÑÐ»Ð¸ Ð³Ñ€ÑƒÐ· Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ Ð¸Ð»Ð¸ Ð² Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ðµ, ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ð¾Ð²Ð»Ð¸ÑÑ‚ÑŒ Ð½Ð° Ð»Ð¾Ð³Ð¸ÑÑ‚Ð¸ÐºÑƒ. Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾.`
                      : `Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ· "${deleteConfirmData.items[0]?.cargo_number}"? Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: Ð•ÑÐ»Ð¸ Ð³Ñ€ÑƒÐ· Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ Ð¸Ð»Ð¸ Ð² Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ðµ, ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ðµ Ð¼Ð¾Ð¶ÐµÑ‚ Ð¿Ð¾Ð²Ð»Ð¸ÑÑ‚ÑŒ Ð½Ð° Ð»Ð¾Ð³Ð¸ÑÑ‚Ð¸ÐºÑƒ. Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾.`
                  )}
                  {deleteConfirmData.type === 'user' && (
                    deleteConfirmData.isBulk 
                      ? `Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ${deleteConfirmData.count} Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»(ÐµÐ¹)? Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾.`
                      : `Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ "${deleteConfirmData.items[0]?.full_name}"? Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾.`
                  )}
                  {deleteConfirmData.type === 'request' && (
                    deleteConfirmData.isBulk 
                      ? `Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ${deleteConfirmData.count} Ð·Ð°ÑÐ²Ðº(Ð¸)? Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾.`
                      : `Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð·Ð°ÑÐ²ÐºÑƒ "${deleteConfirmData.items[0]?.request_number}"? Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾.`
                  )}
                  {deleteConfirmData.type === 'operator' && (
                    deleteConfirmData.isBulk 
                      ? `Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ${deleteConfirmData.count} Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€(Ð¾Ð²)? Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾.`
                      : `Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð¾Ð¿ÐµÑ€Ð°Ñ‚Ð¾Ñ€Ð° "${deleteConfirmData.items[0]?.full_name}"? Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾.`
                  )}
                  {deleteConfirmData.type === 'transport' && (
                    deleteConfirmData.isBulk 
                      ? `Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ ${deleteConfirmData.count} Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚(Ð¾Ð²)? Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: Ð£Ð´Ð°Ð»ÑÑŽÑ‚ÑÑ Ñ‚Ð¾Ð»ÑŒÐºÐ¾ ÐŸÐ£Ð¡Ð¢Ð«Ð• Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ñ‹. Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾.`
                      : `Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹, Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ "${deleteConfirmData.items[0]?.transport_number}"? Ð’ÐÐ˜ÐœÐÐÐ˜Ð•: Ð¢Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ Ð´Ð¾Ð»Ð¶ÐµÐ½ Ð±Ñ‹Ñ‚ÑŒ ÐŸÐ£Ð¡Ð¢ÐžÐ™. Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ¾Ð±Ñ€Ð°Ñ‚Ð¸Ð¼Ð¾.`
                  )}
                </p>
              </div>

              <div className="flex justify-end space-x-2">
                <Button
                  variant="outline"
                  onClick={() => setDeleteConfirmModal(false)}
                  disabled={bulkDeleteLoading}
                >
                  ÐžÑ‚Ð¼ÐµÐ½Ð°
                </Button>
                <Button
                  onClick={executeDelete}
                  disabled={bulkDeleteLoading}
                  className="bg-red-600 hover:bg-red-700 text-white"
                >
                  {bulkDeleteLoading ? (
                    <>
                      <RefreshCw className="mr-2 h-4 w-4 animate-spin" />
                      Ð£Ð´Ð°Ð»ÐµÐ½Ð¸Ðµ...
                    </>
                  ) : (
                    <>
                      <Trash2 className="mr-2 h-4 w-4" />
                      Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ
                    </>
                  )}
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* ÐœÐ¾Ð´Ð°Ð»ÑŒÐ½Ð¾Ðµ Ð¾ÐºÐ½Ð¾ Ð´ÐµÑ‚Ð°Ð»ÐµÐ¹ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ */}
      <Dialog open={notificationDetailsModal} onOpenChange={setNotificationDetailsModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Bell className="mr-2 h-5 w-5 text-blue-600" />
              Ð”ÐµÑ‚Ð°Ð»Ð¸ ÑƒÐ²ÐµÐ´Ð¾Ð¼Ð»ÐµÐ½Ð¸Ñ
            </DialogTitle>
          </DialogHeader>
          
          {selectedNotificationDetails && (
            <div className="space-y-4">
              <div className="p-4 bg-blue-50 rounded-lg border border-blue-200">
                <p className="text-sm text-gray-800 leading-relaxed mb-2">
                  {selectedNotificationDetails.notification.message}
                </p>
                <p className="text-xs text-gray-500">
                  ðŸ“… {new Date(selectedNotificationDetails.notification.created_at).toLocaleString('ru-RU')}
                </p>
                {selectedNotificationDetails.notification.status === 'unread' && (
                  <div className="mt-2">
                    <span className="inline-block px-2 py-1 text-xs bg-red-100 text-red-600 rounded">
                      ÐÐµÐ¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ð¾Ðµ
                    </span>
                  </div>
                )}
              </div>

              {/* Ð¡Ð²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ */}
              {selectedNotificationDetails.related_data && (
                <div className="p-4 bg-gray-50 rounded-lg border border-gray-200">
                  <h4 className="font-medium text-gray-800 mb-2">ðŸ“¦ Ð¡Ð²ÑÐ·Ð°Ð½Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ</h4>
                  {selectedNotificationDetails.related_data.type === 'cargo' && (
                    <div className="space-y-2 text-sm">
                      <p><strong>ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°:</strong> {selectedNotificationDetails.related_data.data.cargo_number}</p>
                      <p><strong>ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ:</strong> {selectedNotificationDetails.related_data.data.sender_full_name}</p>
                      <p><strong>ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ:</strong> {selectedNotificationDetails.related_data.data.recipient_full_name}</p>
                      <p><strong>Ð’ÐµÑ:</strong> {selectedNotificationDetails.related_data.data.weight} ÐºÐ³</p>
                      <p><strong>Ð¡Ñ‚Ð°Ñ‚ÑƒÑ:</strong> {selectedNotificationDetails.related_data.data.status}</p>
                    </div>
                  )}
                </div>
              )}

              <div className="flex justify-end space-x-2">
                <Button
                  variant="outline"
                  onClick={() => setNotificationDetailsModal(false)}
                >
                  Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ
                </Button>
                {selectedNotificationDetails.notification.status === 'unread' && (
                  <Button
                    onClick={() => {
                      handleMarkNotificationAsRead(selectedNotificationDetails.notification.id);
                      setNotificationDetailsModal(false);
                    }}
                    className="bg-green-600 hover:bg-green-700 text-white"
                  >
                    ÐžÑ‚Ð¼ÐµÑ‚Ð¸Ñ‚ÑŒ ÐºÐ°Ðº Ð¿Ñ€Ð¾Ñ‡Ð¸Ñ‚Ð°Ð½Ð½Ð¾Ðµ
                  </Button>
                )}
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* ÐœÐžÐ”ÐÐ›Ð¬ÐÐžÐ• ÐžÐšÐÐž Ð¡Ð¥Ð•ÐœÐ« Ð¡ÐšÐ›ÐÐ”Ð (Ð¤ÐÐ—Ð 3) */}
      <Dialog open={!!showWarehouseScheme} onOpenChange={() => setShowWarehouseScheme(null)}>
        <DialogContent className="max-w-6xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Grid3X3 className="mr-2 h-5 w-5" />
              Ð¡Ñ…ÐµÐ¼Ð° ÑÐºÐ»Ð°Ð´Ð°
            </DialogTitle>
            <DialogDescription>
              {showWarehouseScheme && (
                <span>
                  Ð’Ð¸Ð·ÑƒÐ°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ ÑÑ‡ÐµÐµÐº ÑÐºÐ»Ð°Ð´Ð°: <strong>
                    {(() => {
                      const warehousesList = user?.role === 'admin' ? warehouses : operatorWarehouses;
                      return warehousesList.find(w => w.id === showWarehouseScheme)?.name || 'ÐÐµÐ¸Ð·Ð²ÐµÑÑ‚Ð½Ñ‹Ð¹ ÑÐºÐ»Ð°Ð´';
                    })()}
                  </strong>
                </span>
              )}
            </DialogDescription>
          </DialogHeader>
          
          {showWarehouseScheme && (
            <div className="space-y-6">
              {/* ÐžÐ±Ñ‰Ð°Ñ ÑÑ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° */}
              <div className="grid grid-cols-4 gap-4">
                <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-blue-700">Ð’ÑÐµÐ³Ð¾ Ð±Ð»Ð¾ÐºÐ¾Ð²</p>
                      <p className="text-2xl font-bold text-blue-900">
                        {(() => {
                          const warehousesList = user?.role === 'admin' ? warehouses : operatorWarehouses;
                          return warehousesList.find(w => w.id === showWarehouseScheme)?.blocks_count || 0;
                        })()}
                      </p>
                    </div>
                    <Building className="h-8 w-8 text-blue-600" />
                  </div>
                </div>
                
                <div className="bg-gray-50 p-4 rounded-lg border border-gray-200">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-gray-700">Ð’ÑÐµÐ³Ð¾ ÑÑ‡ÐµÐµÐº</p>
                      <p className="text-2xl font-bold text-gray-900">
                        {(() => {
                          const warehousesList = user?.role === 'admin' ? warehouses : operatorWarehouses;
                          const warehouse = warehousesList.find(w => w.id === showWarehouseScheme);
                          return warehouse?.total_cells || 
                                 ((warehouse?.blocks_count || 0) * (warehouse?.shelves_per_block || 0) * (warehouse?.cells_per_shelf || 0)) || 0;
                        })()}
                      </p>
                    </div>
                    <Grid3X3 className="h-8 w-8 text-gray-600" />
                  </div>
                </div>
                
                <div className="bg-red-50 p-4 rounded-lg border border-red-200">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-red-700">Ð—Ð°Ð½ÑÑ‚Ð¾</p>
                      <p className="text-2xl font-bold text-red-900">
                        {(() => {
                          const warehousesList = user?.role === 'admin' ? warehouses : operatorWarehouses;
                          const warehouse = warehousesList.find(w => w.id === showWarehouseScheme);
                          const totalCells = warehouse?.total_cells || 
                                           ((warehouse?.blocks_count || 0) * (warehouse?.shelves_per_block || 0) * (warehouse?.cells_per_shelf || 0)) || 0;
                          return Math.floor(totalCells * 0.6);
                        })()}
                      </p>
                    </div>
                    <Package className="h-8 w-8 text-red-600" />
                  </div>
                </div>
                
                <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                  <div className="flex items-center justify-between">
                    <div>
                      <p className="text-sm font-medium text-green-700">Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð¾</p>
                      <p className="text-2xl font-bold text-green-900">
                        {(() => {
                          const warehousesList = user?.role === 'admin' ? warehouses : operatorWarehouses;
                          const warehouse = warehousesList.find(w => w.id === showWarehouseScheme);
                          const totalCells = warehouse?.total_cells || 
                                           ((warehouse?.blocks_count || 0) * (warehouse?.shelves_per_block || 0) * (warehouse?.cells_per_shelf || 0)) || 0;
                          return Math.floor(totalCells * 0.4);
                        })()}
                      </p>
                    </div>
                    <CheckCircle className="h-8 w-8 text-green-600" />
                  </div>
                </div>
              </div>

              {/* Ð›ÐµÐ³ÐµÐ½Ð´Ð° */}
              <div className="bg-gray-50 p-4 rounded-lg border">
                <h4 className="font-semibold text-sm text-gray-700 mb-3">ðŸŽ¨ Ð›ÐµÐ³ÐµÐ½Ð´Ð° ÑÑ‡ÐµÐµÐº Ð¸ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¸ Ð³Ñ€ÑƒÐ·Ð¾Ð²</h4>
                <div className="grid grid-cols-2 gap-4">
                  <div className="space-y-2">
                    <p className="font-medium text-gray-700 mb-2">Ð¡Ñ‚Ð°Ñ‚ÑƒÑ ÑÑ‡ÐµÐµÐº:</p>
                    <div className="flex items-center space-x-2">
                      <div className="w-6 h-6 bg-green-200 border border-green-400 rounded"></div>
                      <span className="text-sm font-medium text-green-700">Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð°Ñ ÑÑ‡ÐµÐ¹ÐºÐ°</span>
                    </div>
                    <div className="flex items-center space-x-2">
                      <div className="w-6 h-6 bg-red-200 border border-red-400 rounded"></div>
                      <span className="text-sm font-medium text-red-700">ÐžÐ´Ð¸Ð½Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð³Ñ€ÑƒÐ·</span>
                    </div>
                  </div>
                  
                  <div className="space-y-2">
                    <p className="font-medium text-gray-700 mb-2">Ð“Ñ€ÑƒÐ¿Ð¿Ñ‹ Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð¾Ð´Ð½Ð¾Ð³Ð¾ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°:</p>
                    <div className="flex items-center space-x-2">
                      <div className="w-6 h-6 bg-blue-200 border border-blue-400 rounded"></div>
                      <span className="text-sm font-medium text-blue-700">Ð“Ñ€ÑƒÐ¿Ð¿Ð° 1</span>
                    </div>
                    <div className="flex items-center space-x-2">
                      <div className="w-6 h-6 bg-purple-200 border border-purple-400 rounded"></div>
                      <span className="text-sm font-medium text-purple-700">Ð“Ñ€ÑƒÐ¿Ð¿Ð° 2</span>
                    </div>
                    <div className="flex items-center space-x-2">
                      <div className="w-6 h-6 bg-orange-200 border border-orange-400 rounded"></div>
                      <span className="text-sm font-medium text-orange-700">Ð“Ñ€ÑƒÐ¿Ð¿Ð° 3+</span>
                    </div>
                  </div>
                </div>
                <p className="text-xs text-gray-500 mt-3">
                  Ð¯Ñ‡ÐµÐ¹ÐºÐ¸ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ñ†Ð²ÐµÑ‚Ð° ÑÐ¾Ð´ÐµÑ€Ð¶Ð°Ñ‚ Ð³Ñ€ÑƒÐ·Ñ‹ Ð¾Ñ‚ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ Ð¸Ð»Ð¸ Ð´Ð»Ñ Ð¾Ð´Ð½Ð¾Ð³Ð¾ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ
                </p>
              </div>

              {/* Ð¡Ñ…ÐµÐ¼Ð° Ð±Ð»Ð¾ÐºÐ¾Ð² Ð¸ ÑÑ‡ÐµÐµÐº */}
              <div className="space-y-6">
                {warehouseSchemeLoading ? (
                  <div className="flex justify-center items-center py-8">
                    <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"></div>
                    <span className="ml-2 text-gray-600">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÑ…ÐµÐ¼Ñ‹ ÑÐºÐ»Ð°Ð´Ð°...</span>
                  </div>
                ) : (
                  warehouseSchemeData.map((block) => (
                    <div key={block.block_number} className="border rounded-lg p-4 bg-white">
                      <div className="flex justify-between items-center mb-4">
                        <h3 className="font-bold text-lg text-gray-800">
                          ðŸ“¦ Ð‘Ð»Ð¾Ðº {block.block_number}
                        </h3>
                        <div className="text-sm text-gray-600">
                          Ð—Ð°Ð½ÑÑ‚Ð¾: {block.occupied_cells}/{block.total_cells} ÑÑ‡ÐµÐµÐº 
                          ({Math.round((block.occupied_cells / block.total_cells) * 100)}%)
                        </div>
                      </div>
                      
                      {/* Ð¡ÐµÑ‚ÐºÐ° ÑÑ‡ÐµÐµÐº Ñ Ñ†Ð²ÐµÑ‚Ð¾Ð²Ð¾Ð¹ Ð³Ñ€ÑƒÐ¿Ð¿Ð¸Ñ€Ð¾Ð²ÐºÐ¾Ð¹ - Ð°Ð´Ð°Ð¿Ñ‚Ð¸Ð²Ð½Ð°Ñ ÑÐµÑ‚ÐºÐ° */}
                      <div className={`grid gap-2`} style={{
                        gridTemplateColumns: `repeat(${
                          (() => {
                            const warehousesList = user?.role === 'admin' ? warehouses : operatorWarehouses;
                            return warehousesList.find(w => w.id === showWarehouseScheme)?.cells_per_shelf || 5;
                          })()
                        }, 1fr)`
                      }}>
                        {block.cells.map((cell) => {
                          // ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÑÐµÐ¼ Ñ†Ð²ÐµÑ‚ ÑÑ‡ÐµÐ¹ÐºÐ¸
                          let cellStyle = '';
                          if (!cell.is_occupied) {
                            cellStyle = 'bg-green-100 border-green-300 hover:bg-green-200';
                          } else if (cell.hasRelatedCargo && cell.clientGroup && cell.clientGroup.color) {
                            // Ð“Ñ€ÑƒÐ· Ð¸Ð· Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ - Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ Ñ†Ð²ÐµÑ‚ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹
                            const color = cell.clientGroup.color;
                            cellStyle = `${color.bg} ${color.border} hover:opacity-80`;
                          } else {
                            // ÐžÐ´Ð¸Ð½Ð¾Ñ‡Ð½Ñ‹Ð¹ Ð³Ñ€ÑƒÐ·
                            cellStyle = 'bg-red-100 border-red-300 hover:bg-red-200';
                          }
                          
                          return (
                            <div
                              key={cell.id}
                              className={`
                                relative border-2 rounded-lg p-2 text-center cursor-pointer transition-all hover:scale-105 min-h-20
                                ${cellStyle}
                              `}
                              onClick={() => {
                                if (cell.is_occupied) {
                                  openCargoManagementModal(cell);
                                }
                              }}
                              title={cell.is_occupied ? 
                                (cell.hasRelatedCargo && cell.relatedCargo ? 
                                  `Ð“Ñ€ÑƒÐ· Ð¸Ð· Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ ${cell.groupType === 'sender' ? 'Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ' : 'Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ'}: ${cell.relatedCargo.client_name} (Ð²ÑÐµÐ³Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²: ${cell.relatedCargo.totalCargo})` :
                                  `Ð“Ñ€ÑƒÐ·: ${cell.cargo_number} Ð¾Ñ‚ ${cell.cargo_sender}`
                                ) : 
                                'Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð°Ñ ÑÑ‡ÐµÐ¹ÐºÐ°'
                              }
                            >
                              <div className="text-xs font-medium text-gray-700 mb-1">
                                {cell.shelf_number ? `ÐŸ${cell.shelf_number}Ð¯${cell.cell_number}` : `Ð¯Ñ‡ÐµÐ¹ÐºÐ° ${cell.cell_position}`}
                              </div>
                              {cell.is_occupied ? (
                                <div className="space-y-1">
                                  <div className={`text-xs font-bold ${
                                    cell.hasRelatedCargo && cell.clientGroup && cell.clientGroup.color ? 
                                      cell.clientGroup.color.text : 
                                      'text-red-800'
                                  }`}>
                                    {cell.hasRelatedCargo ? 'Ð“Ð Ð£ÐŸÐŸÐ' : 'Ð—ÐÐÐ¯Ð¢Ðž'}
                                  </div>
                                  <div className={`text-xs truncate ${
                                    cell.hasRelatedCargo && cell.clientGroup && cell.clientGroup.color ? 
                                      cell.clientGroup.color.text : 
                                      'text-red-700'
                                  }`} title={cell.cargo_number}>
                                    {cell.cargo_number?.substring(0, 8)}...
                                  </div>
                                  {cell.hasRelatedCargo && cell.relatedCargo && (
                                    <div className={`text-xs ${cell.clientGroup && cell.clientGroup.color ? cell.clientGroup.color.text : 'text-blue-700'}`}>
                                      {cell.groupType === 'sender' ? 'ðŸ“¤' : 'ðŸ“¥'} {cell.relatedCargo.totalCargo} ÑˆÑ‚
                                    </div>
                                  )}
                                  {cell.cargo_weight && (
                                    <div className="text-xs text-gray-600">
                                      {cell.cargo_weight} ÐºÐ³
                                    </div>
                                  )}
                                </div>
                              ) : (
                                <div className="text-xs font-bold text-green-800">Ð¡Ð’ÐžÐ‘ÐžÐ”ÐÐž</div>
                              )}
                              
                              {/* Ð˜Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð¿Ð¾Ð·Ð¸Ñ†Ð¸Ð¸ */}
                              <div className="absolute top-1 right-1 text-xs text-gray-400">
                                {cell.position.row},{cell.position.col}
                              </div>
                              
                              {/* Ð˜Ð½Ð´Ð¸ÐºÐ°Ñ‚Ð¾Ñ€ Ð³Ñ€ÑƒÐ¿Ð¿Ñ‹ */}
                              {cell.hasRelatedCargo && cell.clientGroup && cell.clientGroup.color && (
                                <div className="absolute top-1 left-1">
                                  <div className={`w-3 h-3 rounded-full ${cell.clientGroup.color.bg} ${cell.clientGroup.color.border} border`}></div>
                                </div>
                              )}
                            </div>
                          );
                        })}
                      </div>
                    </div>
                  ))
                )}
              </div>

              {/* Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ */}
              <div className="flex justify-end space-x-2">
                <Button variant="outline" onClick={() => setShowWarehouseScheme(null)}>
                  Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ
                </Button>
                <Button className="bg-blue-600 hover:bg-blue-700 text-white">
                  <FileText className="mr-2 h-4 w-4" />
                  Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ ÑÑ…ÐµÐ¼Ñ‹
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* ÐœÐžÐ”ÐÐ›Ð¬ÐÐžÐ• ÐžÐšÐÐž Ð£ÐŸÐ ÐÐ’Ð›Ð•ÐÐ˜Ð¯ Ð“Ð Ð£Ð—ÐžÐœ (Ð¤ÐÐ—Ð 4 - Ð¤Ð˜ÐÐÐ›Ð¬ÐÐÐ¯) */}
      <Dialog open={showCargoManagementModal} onOpenChange={setShowCargoManagementModal}>
        <DialogContent className="max-w-4xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Package className="mr-2 h-5 w-5" />
              Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð¾Ð¼: {selectedCargoForManagement?.cargo_number}
            </DialogTitle>
            <DialogDescription>
              ÐŸÐ¾Ð»Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ Ð¸ Ñ„ÑƒÐ½ÐºÑ†Ð¸Ð¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ
            </DialogDescription>
          </DialogHeader>
          
          {selectedCargoForManagement && (
            <div className="space-y-6">
              {/* ÐžÑÐ½Ð¾Ð²Ð½Ð°Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ */}
              <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                {/* Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð³Ñ€ÑƒÐ·Ð° */}
                <Card className="border-l-4 border-l-blue-500">
                  <CardContent className="p-4">
                    <div className="flex items-center space-x-3">
                      <Package className="h-8 w-8 text-blue-600" />
                      <div>
                        <p className="text-sm font-medium text-gray-500">Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð³Ñ€ÑƒÐ·Ð°</p>
                        <p className="text-lg font-bold text-blue-900">Ð ÐÐ—ÐœÐ•Ð©Ð•Ð</p>
                      </div>
                    </div>
                  </CardContent>
                </Card>

                {/* Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹ */}
                <Card className="border-l-4 border-l-green-500">
                  <CardContent className="p-4">
                    <div className="flex items-center space-x-3">
                      <CreditCard className="h-8 w-8 text-green-600" />
                      <div>
                        <p className="text-sm font-medium text-gray-500">ÐžÐ¿Ð»Ð°Ñ‚Ð°</p>
                        <p className="text-lg font-bold text-green-900">ÐžÐŸÐ›ÐÐ§Ð•Ð</p>
                      </div>
                    </div>
                  </CardContent>
                </Card>

                {/* Ð’ÐµÑ Ð¸ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ */}
                <Card className="border-l-4 border-l-orange-500">
                  <CardContent className="p-4">
                    <div className="flex items-center space-x-3">
                      <DollarSign className="h-8 w-8 text-orange-600" />
                      <div>
                        <p className="text-sm font-medium text-gray-500">Ð’ÐµÑ / Ð¡ÑƒÐ¼Ð¼Ð°</p>
                        <p className="text-lg font-bold text-orange-900">
                          {selectedCargoForManagement.weight || 'Ð/Ð”'} ÐºÐ³ / {selectedCargoForManagement.payment_amount}â‚½
                        </p>
                      </div>
                    </div>
                  </CardContent>
                </Card>
              </div>

              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾Ð± Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ðµ Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ðµ */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                {/* ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ */}
                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center text-lg">
                      <User className="mr-2 h-5 w-5" />
                      ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-3">
                    <div>
                      <p className="text-sm text-gray-500">Ð¤Ð˜Ðž</p>
                      <p className="font-semibold">{selectedCargoForManagement.sender.full_name}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½</p>
                      <p className="font-semibold">{selectedCargoForManagement.sender.phone}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">ÐÐ´Ñ€ÐµÑ</p>
                      <p className="font-semibold">{selectedCargoForManagement.sender.address}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Email</p>
                      <p className="font-semibold text-blue-600">{selectedCargoForManagement.sender.email}</p>
                    </div>
                  </CardContent>
                </Card>

                {/* ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ */}
                <Card>
                  <CardHeader>
                    <CardTitle className="flex items-center text-lg">
                      <Users className="mr-2 h-5 w-5" />
                      ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ
                    </CardTitle>
                  </CardHeader>
                  <CardContent className="space-y-3">
                    <div>
                      <p className="text-sm text-gray-500">Ð¤Ð˜Ðž</p>
                      <p className="font-semibold">{selectedCargoForManagement.recipient.full_name}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½</p>
                      <p className="font-semibold">{selectedCargoForManagement.recipient.phone}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">ÐÐ´Ñ€ÐµÑ</p>
                      <p className="font-semibold">{selectedCargoForManagement.recipient.address}</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Email</p>
                      <p className="font-semibold text-blue-600">{selectedCargoForManagement.recipient.email}</p>
                    </div>
                  </CardContent>
                </Card>
              </div>

              {/* Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð³Ñ€ÑƒÐ·Ð° */}
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center text-lg">
                    <FileText className="mr-2 h-5 w-5" />
                    Ð”ÐµÑ‚Ð°Ð»Ð¸ Ð³Ñ€ÑƒÐ·Ð°
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div>
                      <p className="text-sm text-gray-500">Ð’ÐµÑ</p>
                      <p className="font-semibold">{selectedCargoForManagement.weight || 'Ð/Ð”'} ÐºÐ³</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">ÐžÐ±ÑŠÑÐ²Ð»ÐµÐ½Ð½Ð°Ñ ÑÑ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ</p>
                      <p className="font-semibold">{selectedCargoForManagement.payment_amount || 'Ð/Ð”'}â‚½</p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">ÐœÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ</p>
                      <p className="font-semibold">
                        Ð‘Ð»Ð¾Ðº {selectedCargoForManagement.location?.block}, 
                        ÐŸÐ¾Ð»ÐºÐ° {selectedCargoForManagement.location?.shelf}, 
                        Ð¯Ñ‡ÐµÐ¹ÐºÐ° {selectedCargoForManagement.location?.cell}
                      </p>
                    </div>
                    <div>
                      <p className="text-sm text-gray-500">Ð¡ÐºÐ»Ð°Ð´</p>
                      <p className="font-semibold">{selectedCargoForManagement.location?.warehouse_name}</p>
                    </div>
                  </div>
                </CardContent>
              </Card>

              {/* Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹ */}
              <Card>
                <CardHeader>
                  <CardTitle className="flex items-center text-lg">
                    <Clock className="mr-2 h-5 w-5" />
                    Ð˜ÑÑ‚Ð¾Ñ€Ð¸Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹
                  </CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-3">
                    {selectedCargoForManagement.history.map((item, index) => (
                      <div key={index} className="flex items-start space-x-4 p-3 bg-gray-50 rounded-lg">
                        <div className="w-2 h-2 bg-blue-500 rounded-full mt-2 flex-shrink-0"></div>
                        <div className="flex-1">
                          <div className="flex justify-between items-start">
                            <div>
                              <p className="font-semibold text-gray-900">{item.action}</p>
                              <p className="text-sm text-gray-500">Ð˜ÑÐ¿Ð¾Ð»Ð½Ð¸Ñ‚ÐµÐ»ÑŒ: {item.user}</p>
                            </div>
                            <p className="text-xs text-gray-400 whitespace-nowrap">{item.date}</p>
                          </div>
                        </div>
                      </div>
                    ))}
                  </div>
                </CardContent>
              </Card>

              {/* Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ ÑÐ²ÑÐ·Ð°Ð½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð°Ñ… (ÐµÑÐ»Ð¸ ÐµÑÑ‚ÑŒ) */}
              {selectedCargoForManagement?.hasRelatedCargo && (
                <Card className="bg-gradient-to-r from-indigo-50 to-purple-50 border-indigo-200">
                  <CardHeader>
                    <CardTitle className="flex items-center text-lg text-indigo-900">
                      <Package2 className="mr-2 h-5 w-5" />
                      Ð¡Ð²ÑÐ·Ð°Ð½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹ Ñ‚Ð¾Ð³Ð¾ Ð¶Ðµ ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°
                    </CardTitle>
                    <CardDescription className="text-indigo-700">
                      Ð”Ñ€ÑƒÐ³Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ñ‹ Ð¾Ñ‚ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ: <strong>{selectedCargoForManagement.relatedCargo?.sender}</strong>
                    </CardDescription>
                  </CardHeader>
                  <CardContent>
                    <div className="space-y-4">
                      {/* Ð¡Ð²Ð¾Ð´ÐºÐ° */}
                      <div className="bg-white p-4 rounded-lg border border-indigo-200">
                        <div className="grid grid-cols-2 md:grid-cols-3 gap-4">
                          <div>
                            <p className="text-sm text-indigo-600">Ð’ÑÐµÐ³Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð² ÐºÐ»Ð¸ÐµÐ½Ñ‚Ð°</p>
                            <p className="text-2xl font-bold text-indigo-900">
                              {selectedCargoForManagement.relatedCargo?.totalCargo || 0}
                            </p>
                          </div>
                          <div>
                            <p className="text-sm text-indigo-600">Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¾ Ð½Ð° ÑÐºÐ»Ð°Ð´Ðµ</p>
                            <p className="text-2xl font-bold text-green-900">
                              {selectedCargoForManagement.relatedCargo?.cargoNumbers?.length || 0}
                            </p>
                          </div>
                          <div>
                            <p className="text-sm text-indigo-600">ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ</p>
                            <p className="text-2xl font-bold text-orange-900">
                              {Math.max(0, (selectedCargoForManagement.relatedCargo?.totalCargo || 0) - (selectedCargoForManagement.relatedCargo?.cargoNumbers?.length || 0))}
                            </p>
                          </div>
                        </div>
                      </div>

                      {/* Ð¡Ð¿Ð¸ÑÐ¾Ðº Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ñ… Ð³Ñ€ÑƒÐ·Ð¾Ð² */}
                      <div>
                        <h4 className="font-semibold text-indigo-800 mb-3">ðŸ“¦ Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹:</h4>
                        <div className="space-y-2">
                          {selectedCargoForManagement.relatedCargo?.cargoNumbers?.map((cargoNumber, index) => {
                            const blockNum = Math.floor(Math.random() * 3) + 1;
                            const cellNum = Math.floor(Math.random() * 20) + 1;
                            const isCurrentCargo = cargoNumber === selectedCargoForManagement.cargo_number;
                            
                            return (
                              <div key={index} className={`flex items-center justify-between p-3 rounded-lg border ${
                                isCurrentCargo ? 'bg-yellow-50 border-yellow-300' : 'bg-gray-50 border-gray-200'
                              }`}>
                                <div className="flex items-center space-x-3">
                                  <div className={`w-3 h-3 rounded-full ${
                                    isCurrentCargo ? 'bg-yellow-500' : 'bg-indigo-500'
                                  }`}></div>
                                  <div>
                                    <p className="font-semibold text-gray-900">
                                      {cargoNumber}
                                      {isCurrentCargo && <span className="ml-2 text-yellow-600">(Ñ‚ÐµÐºÑƒÑ‰Ð¸Ð¹)</span>}
                                    </p>
                                    <p className="text-sm text-gray-600">
                                      ðŸ“ Ð‘Ð»Ð¾Ðº {blockNum}, Ð¯Ñ‡ÐµÐ¹ÐºÐ° {cellNum}
                                    </p>
                                  </div>
                                </div>
                                <div className="text-right">
                                  <div className="flex items-center space-x-2">
                                    <span className="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                      Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½
                                    </span>
                                    <span className="px-2 py-1 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                                      ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½
                                    </span>
                                  </div>
                                  <p className="text-xs text-gray-500 mt-1">
                                    {new Date(Date.now() - Math.random() * 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0]}
                                  </p>
                                </div>
                              </div>
                            );
                          })}
                        </div>
                      </div>

                      {/* ÐÐµÑ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð½Ñ‹Ðµ Ð³Ñ€ÑƒÐ·Ñ‹ */}
                      {(selectedCargoForManagement.relatedCargo?.totalCargo || 0) > (selectedCargoForManagement.relatedCargo?.cargoNumbers?.length || 0) && (
                        <div>
                          <h4 className="font-semibold text-orange-800 mb-3">â³ ÐžÐ¶Ð¸Ð´Ð°ÑŽÑ‚ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ:</h4>
                          <div className="space-y-2">
                            {Array.from({
                              length: Math.max(0, (selectedCargoForManagement.relatedCargo?.totalCargo || 0) - (selectedCargoForManagement.relatedCargo?.cargoNumbers?.length || 0))
                            }, (_, index) => (
                              <div key={index} className="flex items-center justify-between p-3 rounded-lg border bg-orange-50 border-orange-200">
                                <div className="flex items-center space-x-3">
                                  <div className="w-3 h-3 rounded-full bg-orange-500"></div>
                                  <div>
                                    <p className="font-semibold text-gray-900">
                                      CRG{Date.now()}-PENDING-{index + 1}
                                    </p>
                                    <p className="text-sm text-gray-600">
                                      ðŸ“ ÐÐ° ÑÐºÐ»Ð°Ð´Ðµ: ÐœÐ¾ÑÐºÐ²Ð° (Ð¦ÐµÐ½Ñ‚Ñ€Ð°Ð»ÑŒÐ½Ñ‹Ð¹)
                                    </p>
                                  </div>
                                </div>
                                <div className="text-right">
                                  <div className="flex items-center space-x-2">
                                    <span className="px-2 py-1 rounded-full text-xs font-medium bg-orange-100 text-orange-800">
                                      ÐžÐ¶Ð¸Ð´Ð°ÐµÑ‚
                                    </span>
                                    <span className="px-2 py-1 rounded-full text-xs font-medium bg-green-100 text-green-800">
                                      ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½
                                    </span>
                                  </div>
                                  <p className="text-xs text-gray-500 mt-1">
                                    ÐŸÐ¾ÑÑ‚ÑƒÐ¿Ð¸Ð»: {new Date().toISOString().split('T')[0]}
                                  </p>
                                </div>
                              </div>
                            ))}
                          </div>
                        </div>
                      )}
                    </div>
                  </CardContent>
                </Card>
              )}

              {/* Ð¤ÑƒÐ½ÐºÑ†Ð¸Ð¾Ð½Ð°Ð»ÑŒÐ½Ñ‹Ðµ ÐºÐ½Ð¾Ð¿ÐºÐ¸ ÑƒÐ¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ñ */}
              <Card className="bg-gradient-to-r from-blue-50 to-indigo-50 border-blue-200">
                <CardHeader>
                  <CardTitle className="flex items-center text-lg text-blue-900">
                    <Settings className="mr-2 h-5 w-5" />
                    Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð¾Ð¼
                  </CardTitle>
                  <CardDescription className="text-blue-700">
                    Ð’Ñ‹Ð±ÐµÑ€Ð¸Ñ‚Ðµ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð´Ð»Ñ Ñ€Ð°Ð±Ð¾Ñ‚Ñ‹ Ñ Ð³Ñ€ÑƒÐ·Ð¾Ð¼
                  </CardDescription>
                </CardHeader>
                <CardContent>
                  <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    {/* ÐŸÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° */}
                    <Button
                      className="h-16 flex-col space-y-1 bg-blue-600 hover:bg-blue-700 text-white"
                      onClick={() => {
                        const newCell = prompt('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ID Ð½Ð¾Ð²Ð¾Ð¹ ÑÑ‡ÐµÐ¹ÐºÐ¸ Ð´Ð»Ñ Ð¿ÐµÑ€ÐµÐ¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°:');
                        if (newCell) {
                          handleMoveCargoToCell(selectedCargoForManagement.id, newCell);
                          setShowCargoManagementModal(false);
                        }
                      }}
                    >
                      <ArrowUp className="h-5 w-5" />
                      <span className="text-sm font-medium">ÐŸÐµÑ€ÐµÐ¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·</span>
                      <span className="text-xs opacity-90">Ð² Ð´Ñ€ÑƒÐ³ÑƒÑŽ ÑÑ‡ÐµÐ¹ÐºÑƒ</span>
                    </Button>

                    {/* Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ñ‚Ð¾Ð²Ð°Ñ€Ð° */}
                    <Button
                      className="h-16 flex-col space-y-1 bg-red-600 hover:bg-red-700 text-white"
                      onClick={() => {
                        const reason = prompt('Ð£ÐºÐ°Ð¶Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¸Ñ‡Ð¸Ð½Ñƒ Ð²Ð¾Ð·Ð²Ñ€Ð°Ñ‚Ð°:');
                        if (reason) {
                          handleReturnCargo(selectedCargoForManagement.id, reason);
                          setShowCargoManagementModal(false);
                        }
                      }}
                    >
                      <Ban className="h-5 w-5" />
                      <span className="text-sm font-medium">Ð’Ð¾Ð·Ð²Ñ€Ð°Ñ‚ Ñ‚Ð¾Ð²Ð°Ñ€Ð°</span>
                      <span className="text-xs opacity-90">Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŽ</span>
                    </Button>

                    {/* Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð½Ð° Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚ */}
                    <Button
                      className="h-16 flex-col space-y-1 bg-green-600 hover:bg-green-700 text-white"
                      onClick={() => {
                        const transportId = prompt('Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ ID Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚Ð°:');
                        if (transportId) {
                          handleMoveCargoToTransport(selectedCargoForManagement.id, transportId);
                          setShowCargoManagementModal(false);
                        }
                      }}
                    >
                      <Truck className="h-5 w-5" />
                      <span className="text-sm font-medium">ÐÐ° Ñ‚Ñ€Ð°Ð½ÑÐ¿Ð¾Ñ€Ñ‚</span>
                      <span className="text-xs opacity-90">Ð´Ð»Ñ Ð´Ð¾ÑÑ‚Ð°Ð²ÐºÐ¸</span>
                    </Button>

                    {/* Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸ */}
                    <Button
                      className="h-16 flex-col space-y-1 bg-orange-600 hover:bg-orange-700 text-white"
                      onClick={() => {
                        alert('Ð¤ÑƒÐ½ÐºÑ†Ð¸Ñ Ñ€ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð° Ð±ÑƒÐ´ÐµÑ‚ Ñ€ÐµÐ°Ð»Ð¸Ð·Ð¾Ð²Ð°Ð½Ð° Ð² ÑÐ»ÐµÐ´ÑƒÑŽÑ‰Ð¸Ñ… Ð²ÐµÑ€ÑÐ¸ÑÑ…');
                      }}
                    >
                      <Edit className="h-5 w-5" />
                      <span className="text-sm font-medium">Ð ÐµÐ´Ð°ÐºÑ‚Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ</span>
                      <span className="text-xs opacity-90">Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ</span>
                    </Button>
                  </div>
                </CardContent>
              </Card>

              {/* ÐšÐ½Ð¾Ð¿ÐºÐ¸ Ð·Ð°ÐºÑ€Ñ‹Ñ‚Ð¸Ñ */}
              <div className="flex justify-end space-x-2">
                <Button variant="outline" onClick={() => setShowCargoManagementModal(false)}>
                  Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ
                </Button>
                <Button className="bg-blue-600 hover:bg-blue-700 text-white">
                  <Printer className="mr-2 h-4 w-4" />
                  ÐŸÐµÑ‡Ð°Ñ‚ÑŒ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* ÐœÐžÐ”ÐÐ›Ð¬ÐÐžÐ• ÐžÐšÐÐž ÐžÐ¢Ð§Ð•Ð¢Ð ÐŸÐž Ð¡ÐšÐ›ÐÐ”Ð£ */}
      <Dialog open={!!showWarehouseReport} onOpenChange={() => setShowWarehouseReport(null)}>
        <DialogContent className="max-w-7xl max-h-[90vh] overflow-y-auto">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <FileText className="mr-2 h-5 w-5" />
              ÐžÑ‚Ñ‡ÐµÑ‚ Ð¿Ð¾ ÑÐºÐ»Ð°Ð´Ñƒ
            </DialogTitle>
            <DialogDescription>
              {showWarehouseReport && (
                <span>
                  ÐŸÐ¾Ð´Ñ€Ð¾Ð±Ð½Ñ‹Ð¹ Ð¾Ñ‚Ñ‡ÐµÑ‚ Ð¾ Ð³Ñ€ÑƒÐ·Ð°Ñ… ÑÐºÐ»Ð°Ð´Ð°: <strong>
                    {operatorWarehouses.find(w => w.id === showWarehouseReport)?.name}
                  </strong>
                </span>
              )}
            </DialogDescription>
          </DialogHeader>
          
          {showWarehouseReport && (
            <div className="space-y-6">
              {/* Ð¡Ð²Ð¾Ð´Ð½Ð°Ñ Ð°Ð½Ð°Ð»Ð¸Ñ‚Ð¸ÐºÐ° */}
              <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div className="bg-blue-50 p-4 rounded-lg border border-blue-200">
                  <div className="text-center">
                    <Package className="mx-auto h-8 w-8 text-blue-600 mb-2" />
                    <p className="text-sm font-medium text-blue-700">Ð’ÑÐµÐ³Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²</p>
                    <p className="text-2xl font-bold text-blue-900">{warehouseReportData.length}</p>
                  </div>
                </div>
                
                <div className="bg-green-50 p-4 rounded-lg border border-green-200">
                  <div className="text-center">
                    <DollarSign className="mx-auto h-8 w-8 text-green-600 mb-2" />
                    <p className="text-sm font-medium text-green-700">ÐžÐ±Ñ‰Ð°Ñ ÑÑƒÐ¼Ð¼Ð°</p>
                    <p className="text-2xl font-bold text-green-900">
                      {warehouseReportData.reduce((sum, item) => sum + item.total_amount, 0).toLocaleString()} â‚½
                    </p>
                  </div>
                </div>
                
                <div className="bg-purple-50 p-4 rounded-lg border border-purple-200">
                  <div className="text-center">
                    <Package2 className="mx-auto h-8 w-8 text-purple-600 mb-2" />
                    <p className="text-sm font-medium text-purple-700">ÐžÐ±Ñ‰Ð¸Ð¹ Ð²ÐµÑ</p>
                    <p className="text-2xl font-bold text-purple-900">
                      {warehouseReportData.reduce((sum, item) => sum + item.weight, 0).toFixed(1)} ÐºÐ³
                    </p>
                  </div>
                </div>
                
                <div className="bg-orange-50 p-4 rounded-lg border border-orange-200">
                  <div className="text-center">
                    <Users className="mx-auto h-8 w-8 text-orange-600 mb-2" />
                    <p className="text-sm font-medium text-orange-700">Ð£Ð½Ð¸Ðº. ÐºÐ»Ð¸ÐµÐ½Ñ‚Ñ‹</p>
                    <p className="text-2xl font-bold text-orange-900">
                      {new Set(warehouseReportData.map(item => item.sender)).size}
                    </p>
                  </div>
                </div>
              </div>

              {/* Ð¤Ð¸Ð»ÑŒÑ‚Ñ€Ñ‹ Ð¸ Ð¿Ð¾Ð¸ÑÐº */}
              <div className="flex justify-between items-center">
                <div className="flex space-x-4">
                  <input
                    type="text"
                    placeholder="ÐŸÐ¾Ð¸ÑÐº Ð¿Ð¾ Ð½Ð¾Ð¼ÐµÑ€Ñƒ Ð³Ñ€ÑƒÐ·Ð° Ð¸Ð»Ð¸ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŽ..."
                    className="px-4 py-2 border border-gray-300 rounded-lg w-80"
                  />
                  <select className="px-4 py-2 border border-gray-300 rounded-lg">
                    <option value="">Ð’ÑÐµ ÑÑ‚Ð°Ñ‚ÑƒÑÑ‹ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹</option>
                    <option value="paid">ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½Ð¾</option>
                    <option value="transfer">ÐŸÐµÑ€ÐµÐ²Ð¾Ð´ Ð½Ð° ÐºÐ°Ñ€Ñ‚Ñƒ</option>
                    <option value="cod">ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸</option>
                    <option value="debt">ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð² Ð´Ð¾Ð»Ð³</option>
                  </select>
                </div>
                
                <Button className="bg-green-600 hover:bg-green-700">
                  <Download className="mr-2 h-4 w-4" />
                  Ð­ÐºÑÐ¿Ð¾Ñ€Ñ‚ Ð² Excel
                </Button>
              </div>

              {/* Ð¢Ð°Ð±Ð»Ð¸Ñ†Ð° Ð¾Ñ‚Ñ‡ÐµÑ‚Ð° */}
              <div className="overflow-x-auto">
                <table className="w-full border-collapse border border-gray-300">
                  <thead className="bg-gray-50">
                    <tr>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        ÐÐ°Ð¸Ð¼ÐµÐ½Ð¾Ð²Ð°Ð½Ð¸Ðµ
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        Ð’ÐµÑ (ÐºÐ³)
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        Ð¡ÑƒÐ¼Ð¼Ð° (â‚½)
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½ Ð¿Ð¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»Ñ
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        ÐœÐ°Ñ€ÑˆÑ€ÑƒÑ‚
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð¾Ð¿Ð»Ð°Ñ‚Ñ‹
                      </th>
                      <th className="border border-gray-300 px-3 py-2 text-left text-sm font-medium text-gray-700">
                        Ð”Ð°Ñ‚Ð° Ð¿Ñ€Ð¸ÐµÐ¼Ð°
                      </th>
                    </tr>
                  </thead>
                  <tbody>
                    {warehouseReportData.map((item, index) => (
                      <tr key={item.id} className={index % 2 === 0 ? 'bg-white' : 'bg-gray-50'}>
                        <td className="border border-gray-300 px-3 py-2 text-sm font-semibold text-blue-600">
                          {item.cargo_number}
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm">
                          {item.cargo_name}
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm text-center">
                          {item.weight}
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm font-semibold text-green-600">
                          {item.total_amount.toLocaleString()}
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm">
                          {item.sender}
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm">
                          {item.recipient}
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm font-mono">
                          {item.recipient_phone}
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm">
                          {item.route}
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm">
                          <span className={`px-2 py-1 rounded-full text-xs font-medium ${
                            item.payment_status === 'ÐžÐ¿Ð»Ð°Ñ‡ÐµÐ½Ð¾' ? 'bg-green-100 text-green-800' :
                            item.payment_status === 'ÐŸÐµÑ€ÐµÐ²Ð¾Ð´ Ð½Ð° ÐºÐ°Ñ€Ñ‚Ñƒ' ? 'bg-blue-100 text-blue-800' :
                            item.payment_status === 'ÐžÐ¿Ð»Ð°Ñ‚Ð° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ð¸' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-red-100 text-red-800'
                          }`}>
                            {item.payment_status}
                          </span>
                        </td>
                        <td className="border border-gray-300 px-3 py-2 text-sm">
                          {item.acceptance_date}
                        </td>
                      </tr>
                    ))}
                  </tbody>
                </table>
              </div>

              {/* Ð”ÐµÐ¹ÑÑ‚Ð²Ð¸Ñ */}
              <div className="flex justify-end space-x-2">
                <Button variant="outline" onClick={() => setShowWarehouseReport(null)}>
                  Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ
                </Button>
                <Button className="bg-blue-600 hover:bg-blue-700">
                  <Printer className="mr-2 h-4 w-4" />
                  ÐŸÐµÑ‡Ð°Ñ‚ÑŒ Ð¾Ñ‚Ñ‡ÐµÑ‚Ð°
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* QR ÐºÐ¾Ð´ ÑÐ¾Ð·Ð´Ð°Ð½Ð½Ð¾Ð³Ð¾ Ð³Ñ€ÑƒÐ·Ð° */}
      <Dialog open={showCreatedCargoQRModal} onOpenChange={setShowCreatedCargoQRModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <QrCode className="mr-2 h-5 w-5" />
              QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð° Ð³Ð¾Ñ‚Ð¾Ð²!
            </DialogTitle>
            <DialogDescription>
              Ð“Ñ€ÑƒÐ· ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð·Ð´Ð°Ð½. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ QR ÐºÐ¾Ð´ Ð´Ð»Ñ Ð²ÑÐµÑ… Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹ Ñ Ð³Ñ€ÑƒÐ·Ð¾Ð¼.
            </DialogDescription>
          </DialogHeader>
          {createdCargoQR && (
            <div className="space-y-4">
              <div className="text-center">
                <img 
                  src={createdCargoQR.qr_code} 
                  alt={`QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð° ${createdCargoQR.cargo_number}`}
                  className="mx-auto max-w-[200px] border rounded-lg"
                />
                <p className="mt-2 font-bold text-lg">{createdCargoQR.cargo_number}</p>
                <p className="text-sm text-green-600">{createdCargoQR.message}</p>
              </div>
              
              <div className="bg-gray-50 p-3 rounded-lg text-sm space-y-1">
                <div><strong>ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ:</strong> {createdCargoQR.cargo_info?.sender_name}</div>
                <div><strong>ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ:</strong> {createdCargoQR.cargo_info?.recipient_name}</div>
                <div><strong>Ð“Ñ€ÑƒÐ·:</strong> {createdCargoQR.cargo_info?.cargo_name}</div>
                <div><strong>Ð’ÐµÑ:</strong> {createdCargoQR.cargo_info?.weight} ÐºÐ³</div>
                <div><strong>ÐžÐ¿Ð»Ð°Ñ‚Ð°:</strong> {getPaymentMethodText(createdCargoQR.cargo_info?.payment_method)}</div>
              </div>
              
              <div className="flex gap-2">
                <Button 
                  className="flex-1" 
                  onClick={() => {
                    const printWindow = window.open('', '_blank');
                    const printContent = `
                      <html>
                        <head>
                          <title>QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð° ${createdCargoQR.cargo_number}</title>
                          <style>
                            body { font-family: Arial, sans-serif; margin: 20px; text-align: center; }
                            .qr-container { border: 2px solid #333; padding: 20px; max-width: 400px; margin: 0 auto; }
                            .qr-code img { width: 200px; height: 200px; margin: 10px 0; }
                            .info { text-align: left; margin-top: 15px; line-height: 1.4; }
                          </style>
                        </head>
                        <body>
                          <div class="qr-container">
                            <h2>Ð“Ð Ð£Ð— TAJLINE.TJ</h2>
                            <div class="qr-code">
                              <img src="${createdCargoQR.qr_code}" alt="QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð°" />
                            </div>
                            <div class="info">
                              <div><strong>ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°:</strong> ${createdCargoQR.cargo_number}</div>
                              <div><strong>ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ:</strong> ${createdCargoQR.cargo_info?.sender_name}</div>
                              <div><strong>ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ:</strong> ${createdCargoQR.cargo_info?.recipient_name}</div>
                              <div><strong>Ð“Ñ€ÑƒÐ·:</strong> ${createdCargoQR.cargo_info?.cargo_name}</div>
                              <div><strong>Ð’ÐµÑ:</strong> ${createdCargoQR.cargo_info?.weight} ÐºÐ³</div>
                            </div>
                            <div style="margin-top: 15px; font-size: 12px;">
                              Ð¡ÐºÐ°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ Ð´Ð»Ñ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¹ Ñ Ð³Ñ€ÑƒÐ·Ð¾Ð¼
                            </div>
                          </div>
                        </body>
                      </html>
                    `;
                    printWindow.document.write(printContent);
                    printWindow.document.close();
                    printWindow.print();
                  }}
                >
                  <Printer className="mr-2 h-4 w-4" />
                  ÐŸÐµÑ‡Ð°Ñ‚ÑŒ QR ÐºÐ¾Ð´Ð°
                </Button>
                <Button 
                  variant="outline"
                  onClick={() => setShowCreatedCargoQRModal(false)}
                >
                  Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð½Ñ‹Ð¹ Ð³Ñ€ÑƒÐ· */}
      <Dialog open={showScannedCargoModal} onOpenChange={setShowScannedCargoModal}>
        <DialogContent className="max-w-2xl">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Package className="mr-2 h-5 w-5" />
              Ð˜Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ñ Ð¾ Ð³Ñ€ÑƒÐ·Ðµ
            </DialogTitle>
            <DialogDescription>
              Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ñ QR ÐºÐ¾Ð´Ð°
            </DialogDescription>
          </DialogHeader>
          {scannedCargoInfo && (
            <div className="space-y-4">
              <div className="bg-blue-50 p-4 rounded-lg">
                <h3 className="font-bold text-lg mb-2">{scannedCargoInfo.cargo_number}</h3>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                  <div>
                    <p><strong>Ð“Ñ€ÑƒÐ·:</strong> {scannedCargoInfo.cargo_name}</p>
                    <p><strong>Ð’ÐµÑ:</strong> {scannedCargoInfo.weight} ÐºÐ³</p>
                    <p><strong>Ð¡Ñ‚Ð¾Ð¸Ð¼Ð¾ÑÑ‚ÑŒ:</strong> {scannedCargoInfo.declared_value} â‚½</p>
                  </div>
                  <div>
                    <p><strong>ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ:</strong> {scannedCargoInfo.sender_name}</p>
                    <p><strong>ÐŸÐ¾Ð»ÑƒÑ‡Ð°Ñ‚ÐµÐ»ÑŒ:</strong> {scannedCargoInfo.recipient_name}</p>
                    <p><strong>Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½:</strong> {scannedCargoInfo.recipient_phone}</p>
                  </div>
                </div>
              </div>
              
              <div className="grid grid-cols-1 md:grid-cols-3 gap-4 text-sm">
                <div className="bg-gray-50 p-3 rounded-lg">
                  <p className="font-medium">Ð¡Ñ‚Ð°Ñ‚ÑƒÑ Ð³Ñ€ÑƒÐ·Ð°</p>
                  <p className="text-blue-600">{getStatusText(scannedCargoInfo.status)}</p>
                </div>
                <div className="bg-gray-50 p-3 rounded-lg">
                  <p className="font-medium">ÐžÐ±Ñ€Ð°Ð±Ð¾Ñ‚ÐºÐ°</p>
                  <p className="text-green-600">{getProcessingStatusText(scannedCargoInfo.processing_status)}</p>
                </div>
                <div className="bg-gray-50 p-3 rounded-lg">
                  <p className="font-medium">ÐžÐ¿Ð»Ð°Ñ‚Ð°</p>
                  <p className="text-orange-600">{getPaymentStatusText(scannedCargoInfo.payment_status)}</p>
                </div>
              </div>
              
              {(scannedCargoInfo.block_number || scannedCargoInfo.warehouse_name) && (
                <div className="bg-green-50 p-3 rounded-lg">
                  <p className="font-medium mb-1">ÐœÐµÑÑ‚Ð¾Ð¿Ð¾Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ</p>
                  <p className="text-sm">
                    {scannedCargoInfo.warehouse_name}
                    {scannedCargoInfo.block_number && `, Ð‘Ð»Ð¾Ðº ${scannedCargoInfo.block_number}`}
                    {scannedCargoInfo.shelf_number && `, ÐŸÐ¾Ð»ÐºÐ° ${scannedCargoInfo.shelf_number}`}
                    {scannedCargoInfo.cell_number && `, Ð¯Ñ‡ÐµÐ¹ÐºÐ° ${scannedCargoInfo.cell_number}`}
                  </p>
                </div>
              )}
              
              {scannedCargoInfo.available_operations && scannedCargoInfo.available_operations.length > 0 && (
                <div>
                  <p className="font-medium mb-2">Ð”Ð¾ÑÑ‚ÑƒÐ¿Ð½Ñ‹Ðµ Ð¾Ð¿ÐµÑ€Ð°Ñ†Ð¸Ð¸:</p>
                  <div className="flex flex-wrap gap-2">
                    {scannedCargoInfo.available_operations.map((operation, index) => (
                      <Button 
                        key={index}
                        variant="outline" 
                        size="sm"
                        onClick={() => handleCargoOperation(operation, scannedCargoInfo)}
                      >
                        {getOperationText(operation)}
                      </Button>
                    ))}
                  </div>
                </div>
              )}
              
              <div className="flex justify-end">
                <Button onClick={() => setShowScannedCargoModal(false)}>
                  Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ
                </Button>
              </div>
            </div>
          )}
        </DialogContent>
      </Dialog>

      {/* QR ÑÐºÐ°Ð½ÐµÑ€ */}
      <Dialog open={showQRScannerModal} onOpenChange={setShowQRScannerModal}>
        <DialogContent className="max-w-md">
          <DialogHeader>
            <DialogTitle className="flex items-center">
              <Camera className="mr-2 h-5 w-5" />
              Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ QR ÐºÐ¾Ð´Ð° Ð³Ñ€ÑƒÐ·Ð°
            </DialogTitle>
            <DialogDescription>
              ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð° Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸Ð¸
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div className="bg-black rounded-lg overflow-hidden" style={{aspectRatio: '1/1'}}>
              <div id="qr-reader-modal" style={{width: '100%', height: '100%'}}></div>
            </div>
            <div className="flex gap-2">
              <Button 
                variant="outline" 
                onClick={() => {
                  // ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð°ÐµÐ¼ ÐºÐ°Ð¼ÐµÑ€Ñƒ
                  switchModalCamera();
                }}
                className="flex-1"
              >
                <RefreshCw className="mr-2 h-4 w-4" />
                ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ
              </Button>
              <Button 
                variant="outline" 
                onClick={stopCargoQRScanner}
                className="flex-1"
              >
                ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ ÑÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* New QR Generation Modal - Mobile Adapted */}
      <Dialog open={showQRGenerateModal} onOpenChange={setShowQRGenerateModal}>
        <DialogContent className="w-full max-w-[95vw] max-h-[95vh] p-3 sm:p-6 overflow-y-auto">
          <DialogHeader className="pb-2">
            <DialogTitle className="flex items-center text-lg">
              <QrCode className="mr-2 h-5 w-5" />
              Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ QR ÐºÐ¾Ð´Ð°
            </DialogTitle>
            <DialogDescription className="text-sm">
              Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð° Ð´Ð»Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ¸ Ð¸ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ QR ÐºÐ¾Ð´Ð°
            </DialogDescription>
          </DialogHeader>
          <div className="space-y-4">
            <div>
              <Label htmlFor="cargo-number-input">ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°</Label>
              <Input
                id="cargo-number-input"
                type="text"
                placeholder="Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð° (Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: TEMP-123456)"
                value={qrGenerateCargoNumber}
                onChange={(e) => {
                  setQrGenerateCargoNumber(e.target.value);
                  // Clear previous QR when user changes input
                  if (generatedSingleQR) {
                    setGeneratedSingleQR(null);
                  }
                }}
                disabled={qrGenerateLoading}
                className="mt-1"
              />
              <p className="text-xs text-gray-500 mt-1">
                Ð¡Ð¸ÑÑ‚ÐµÐ¼Ð° Ð¿Ñ€Ð¾Ð²ÐµÑ€Ð¸Ñ‚ ÑÑƒÑ‰ÐµÑÑ‚Ð²Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð° Ð¿ÐµÑ€ÐµÐ´ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸ÐµÐ¹ QR ÐºÐ¾Ð´Ð°
              </p>
            </div>
            
            {generatedSingleQR && (
              <div className="space-y-3">
                <div className="text-center">
                  <p className="text-sm font-medium text-green-600 mb-2">
                    QR ÐºÐ¾Ð´ Ð´Ð»Ñ Ð³Ñ€ÑƒÐ·Ð°: {generatedSingleQR.cargo_number}
                  </p>
                  <div className="bg-white p-4 rounded-lg border inline-block">
                    <img 
                      src={generatedSingleQR.qr_code} 
                      alt={`QR ÐºÐ¾Ð´ ${generatedSingleQR.cargo_number}`}
                      className="w-48 h-48 mx-auto"
                    />
                  </div>
                </div>
                <div className="flex gap-2">
                  <Button
                    variant="outline"
                    onClick={() => {
                      const link = document.createElement('a');
                      link.href = generatedSingleQR.qr_code;
                      link.download = `qr-${generatedSingleQR.cargo_number}.png`;
                      link.click();
                    }}
                    className="flex-1"
                  >
                    <Download className="mr-2 h-4 w-4" />
                    Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ
                  </Button>
                  <Button
                    variant="outline"
                    onClick={() => {
                      const printWindow = window.open('', '_blank');
                      printWindow.document.write(`
                        <html>
                          <head><title>QR ÐºÐ¾Ð´ ${generatedSingleQR.cargo_number}</title></head>
                          <body style="text-align: center; padding: 20px;">
                            <h2>QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð°: ${generatedSingleQR.cargo_number}</h2>
                            <img src="${generatedSingleQR.qr_code}" style="width: 300px; height: 300px;" />
                            <p>Ð“Ñ€ÑƒÐ·: ${generatedSingleQR.cargo_name}</p>
                          </body>
                        </html>
                      `);
                      printWindow.document.close();
                      printWindow.print();
                    }}
                    className="flex-1"
                  >
                    <Printer className="mr-2 h-4 w-4" />
                    ÐŸÐµÑ‡Ð°Ñ‚ÑŒ
                  </Button>
                </div>
              </div>
            )}
            
            <div className="flex gap-2">
              <Button 
                onClick={generateQRByCargoNumber}
                disabled={!qrGenerateCargoNumber.trim() || qrGenerateLoading}
                className="flex-1"
              >
                {qrGenerateLoading ? (
                  <>
                    <RefreshCw className="mr-2 h-4 w-4 animate-spin" />
                    Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ...
                  </>
                ) : (
                  <>
                    <QrCode className="mr-2 h-4 w-4" />
                    Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ QR ÐºÐ¾Ð´
                  </>
                )}
              </Button>
              <Button 
                variant="outline" 
                onClick={() => {
                  setShowQRGenerateModal(false);
                  setQrGenerateCargoNumber('');
                  setGeneratedSingleQR(null);
                }}
              >
                Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* New Cargo Placement Modal - Mobile Adapted */}
      <Dialog open={showCargoPlacementModal} onOpenChange={setShowCargoPlacementModal}>
        <DialogContent className="w-full max-w-[95vw] max-h-[95vh] p-3 sm:p-6 overflow-y-auto">
          <DialogHeader className="pb-2">
            <DialogTitle className="flex items-center text-lg">
              <Package className="mr-2 h-5 w-5" />
              Ð Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°
            </DialogTitle>
            <DialogDescription className="text-sm">
              Ð¡ÐºÐ°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ QR ÐºÐ¾Ð´Ñ‹ Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð¸ ÑÑ‡ÐµÐµÐº Ð´Ð»Ñ Ð°Ð²Ñ‚Ð¾Ð¼Ð°Ñ‚Ð¸Ñ‡ÐµÑÐºÐ¾Ð³Ð¾ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4">
            {/* Placement Steps Indicator */}
            <div className="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
              <div className={`flex items-center space-x-2 ${placementStep === 'scan-cargo' ? 'text-blue-600 font-medium' : 'text-gray-500'}`}>
                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${placementStep === 'scan-cargo' ? 'border-blue-600 bg-blue-100' : 'border-gray-300'}`}>
                  1
                </div>
                <span className="text-sm">Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ Ð³Ñ€ÑƒÐ·</span>
              </div>
              <div className={`flex items-center space-x-2 ${placementStep === 'scan-cell' ? 'text-blue-600 font-medium' : 'text-gray-500'}`}>
                <div className={`w-6 h-6 rounded-full border-2 flex items-center justify-center ${placementStep === 'scan-cell' ? 'border-blue-600 bg-blue-100' : 'border-gray-300'}`}>
                  2
                </div>
                <span className="text-sm">Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ ÑÑ‡ÐµÐ¹ÐºÑƒ</span>
              </div>
            </div>

            {/* Current Step Information */}
            <div className="p-4 border rounded-lg">
              {placementStep === 'idle' && (
                <div className="text-center">
                  <h4 className="font-medium text-gray-700 mb-2">Ð“Ð¾Ñ‚Ð¾Ð² Ðº Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸ÑŽ</h4>
                  <p className="text-sm text-gray-500">ÐÐ°Ð¶Ð¼Ð¸Ñ‚Ðµ "ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ" Ð´Ð»Ñ Ð·Ð°Ð¿ÑƒÑÐºÐ° Ð¿Ñ€Ð¾Ñ†ÐµÑÑÐ°</p>
                </div>
              )}
              
              <div 
                className={`text-center ${placementStep === 'scan-cargo' ? 'react-visible' : 'react-hidden'}`}
              >
                <h4 className="font-medium text-blue-600 mb-2">Ð¨Ð°Ð³ 1: Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ Ð³Ñ€ÑƒÐ·Ð°</h4>
                <p className="text-sm text-gray-600">ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð°</p>
                {scannedCargoForPlacement && (
                  <div className="mt-2 p-2 bg-green-50 border border-green-200 rounded">
                    <p className="text-sm text-green-800">
                      âœ“ Ð“Ñ€ÑƒÐ· Ð½Ð°Ð¹Ð´ÐµÐ½: {scannedCargoForPlacement.cargo_number}
                    </p>
                  </div>
                )}
              </div>
              
              <div 
                className={`text-center ${placementStep === 'scan-cell' ? 'react-visible' : 'react-hidden'}`}
              >
                <h4 className="font-medium text-blue-600 mb-2">Ð¨Ð°Ð³ 2: Ð¡ÐºÐ°Ð½Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð¸Ðµ ÑÑ‡ÐµÐ¹ÐºÐ¸</h4>
                <p className="text-sm text-gray-600">ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° QR ÐºÐ¾Ð´ ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ð¾Ð¹ ÑÑ‡ÐµÐ¹ÐºÐ¸</p>
                {scannedCargoForPlacement && (
                  <div className="mt-2 p-2 bg-blue-50 border border-blue-200 rounded">
                    <p className="text-sm text-blue-800">
                      Ð“Ñ€ÑƒÐ· Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ: {scannedCargoForPlacement.cargo_number}
                    </p>
                  </div>
                )}
              </div>
            </div>

            {/* Camera Scanner - Mobile Adapted Full screen mode */}
            <div 
              className={`space-y-2 ${placementActive && scannerActive ? 'react-visible' : 'react-hidden'}`}
            >
              {/* Mobile-optimized scanner container */}
              <div className="relative bg-black rounded-lg overflow-hidden">
                <div 
                  key="qr-reader-placement-container"
                  id="qr-reader-placement" 
                  className="w-full"
                  style={{
                    width: '100%',
                    height: 'min(70vh, 400px)', // Responsive height for mobile
                    minHeight: '250px', // Smaller minimum for mobile
                    display: 'flex',
                    justifyContent: 'center',
                    alignItems: 'center'
                  }}
                />
                  
                  {/* Mobile-optimized overlay instructions */}
                  <div className="absolute top-2 left-2 right-2 z-10">
                    <div className="bg-black bg-opacity-80 text-white p-2 rounded text-center">
                      <div className="text-xs sm:text-sm font-medium">
                        {placementStep === 'scan-cargo' ? 
                          'ðŸ“¦ ÐžÑ‚ÑÐºÐ°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ QR ÐºÐ¾Ð´ Ð³Ñ€ÑƒÐ·Ð°' : 
                          'ðŸ  ÐžÑ‚ÑÐºÐ°Ð½Ð¸Ñ€ÑƒÐ¹Ñ‚Ðµ QR ÐºÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸'}
                      </div>
                      <div className="text-xs text-gray-300 mt-1">
                        ÐÐ°Ð²ÐµÐ´Ð¸Ñ‚Ðµ ÐºÐ°Ð¼ÐµÑ€Ñƒ Ð½Ð° QR ÐºÐ¾Ð´
                      </div>
                    </div>
                  </div>

                  {/* Mobile-optimized camera controls */}
                  <div className="absolute top-2 right-2 z-10 flex flex-col space-y-1">
                    {/* Camera switch button */}
                    {availablePlacementCameras.length > 1 && (
                      <Button
                        onClick={switchPlacementCamera}
                        size="sm"
                        variant="outline"
                        className="bg-black bg-opacity-70 text-white border-gray-600 hover:bg-gray-800 h-8 w-8 p-0"
                        title={`ÐŸÐµÑ€ÐµÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ ÐºÐ°Ð¼ÐµÑ€Ñƒ (${currentPlacementCameraIndex + 1}/${availablePlacementCameras.length})`}
                      >
                        <RefreshCw className="h-3 w-3" />
                      </Button>
                    )}

                    {/* Full screen toggle button */}
                    <Button
                      onClick={() => {
                        const element = document.getElementById("qr-reader-placement");
                        if (element) {
                          if (document.fullscreenElement) {
                            document.exitFullscreen();
                          } else {
                            element.parentElement.requestFullscreen();
                          }
                        }
                      }}
                      size="sm"
                      variant="outline"
                      className="bg-black bg-opacity-70 text-white border-gray-600 hover:bg-gray-800 h-8 w-8 p-0"
                    >
                      <Maximize className="h-3 w-3" />
                    </Button>
                  </div>
                </div>
                
                <div className="text-center">
                  <p className="text-xs sm:text-sm text-green-600 font-medium flex items-center justify-center">
                    <div className="w-2 h-2 bg-green-500 rounded-full mr-2 animate-pulse"></div>
                    ÐšÐ°Ð¼ÐµÑ€Ð° Ð°ÐºÑ‚Ð¸Ð²Ð½Ð° - Ð½Ð°Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð° QR ÐºÐ¾Ð´
                  </p>
                </div>
              </div>

            {/* Camera unavailable message with retry option */}
            <div 
              className={`space-y-2 ${placementActive && !scannerActive ? 'react-visible' : 'react-hidden'}`}
            >
                <div className="text-center p-3 bg-yellow-50 rounded-lg">
                  <div className="text-yellow-800 font-medium mb-2 text-sm">
                    ðŸ“± ÐšÐ°Ð¼ÐµÑ€Ð° Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð°
                  </div>
                  <p className="text-xs text-yellow-700 mb-3">
                    Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ñ€ÑƒÑ‡Ð½Ð¾Ð¹ Ð²Ð²Ð¾Ð´ Ð´Ð°Ð½Ð½Ñ‹Ñ… Ð½Ð¸Ð¶Ðµ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°
                  </p>
                  
                  {/* Retry camera button */}
                  <Button 
                    onClick={async () => {
                      console.log('ðŸ”„ ÐŸÐ¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð·Ð°Ð¿Ñ€Ð¾ÑÐ¸Ð» Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€ ÐºÐ°Ð¼ÐµÑ€Ñ‹...');
                      
                      // Reset scanner state silently
                      setScannerActive(false);
                      
                      // Stop any existing scanner
                      if (html5QrCodePlacement) {
                        console.log('ðŸ›‘ Ð¢Ð¸Ñ…Ð°Ñ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ° ÑÐºÐ°Ð½ÐµÑ€Ð°...');
                        try {
                          await safeStopQrScanner(html5QrCodePlacement, "qr-reader-placement", "Silent Retry Stop");
                          setHtml5QrCodePlacement(null);
                        } catch (error) {
                          console.warn('âš ï¸ ÐŸÑ€ÐµÐ´ÑƒÐ¿Ñ€ÐµÐ¶Ð´ÐµÐ½Ð¸Ðµ Ð¿Ñ€Ð¸ Ð¾ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐµ:', error);
                        }
                      }
                      
                      // Wait briefly for UI stabilization
                      await new Promise(resolve => setTimeout(resolve, 500));
                      
                      // Check camera availability silently
                      console.log('ðŸ” Ð¢Ð¸Ñ…Ð°Ñ Ð¿Ñ€Ð¾Ð²ÐµÑ€ÐºÐ° ÐºÐ°Ð¼ÐµÑ€Ñ‹...');
                      const cameraAvailable = await checkCameraAvailability();
                      
                      if (cameraAvailable) {
                        console.log('âœ… ÐšÐ°Ð¼ÐµÑ€Ð° Ð½Ð°Ð¹Ð´ÐµÐ½Ð° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ðµ - Ð·Ð°Ð¿ÑƒÑÐº ÑÐºÐ°Ð½ÐµÑ€Ð°');
                        // Only show success message if camera actually works
                        showAlert('ðŸ“¹ ÐšÐ°Ð¼ÐµÑ€Ð° Ð°ÐºÑ‚Ð¸Ð²Ð¸Ñ€Ð¾Ð²Ð°Ð½Ð°!', 'success');
                        
                        // Wait for modal stability
                        await new Promise(resolve => setTimeout(resolve, 1500));
                        
                        try {
                          await startQRScannerForPlacement();
                          console.log('âœ… Ð¡ÐºÐ°Ð½ÐµÑ€ Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½ Ð¿Ð¾ÑÐ»Ðµ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ð°');
                        } catch (error) {
                          console.error('âŒ ÐžÑˆÐ¸Ð±ÐºÐ° Ð·Ð°Ð¿ÑƒÑÐºÐ° ÑÐºÐ°Ð½ÐµÑ€Ð° Ð¿Ñ€Ð¸ Ð¿Ð¾Ð²Ñ‚Ð¾Ñ€Ðµ:', error);
                          // Don't show error - just stay in manual mode
                          console.log('ðŸ“ ÐžÑÑ‚Ð°ÐµÑ‚ÑÑ Ð² Ñ€ÑƒÑ‡Ð½Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ');
                        }
                      } else {
                        console.log('ðŸ“µ ÐšÐ°Ð¼ÐµÑ€Ð° Ð¿Ð¾-Ð¿Ñ€ÐµÐ¶Ð½ÐµÐ¼Ñƒ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿Ð½Ð° - Ð¾ÑÑ‚Ð°ÐµÐ¼ÑÑ Ð² Ñ€ÑƒÑ‡Ð½Ð¾Ð¼ Ñ€ÐµÐ¶Ð¸Ð¼Ðµ');
                        // Don't show any alert - just keep manual input visible
                        // User can see manual input is still there, no need for notification
                      }
                    }}
                    size="sm"
                    variant="outline"
                    className="text-xs bg-white text-blue-600 border-blue-300 hover:bg-blue-50"
                  >
                    <RefreshCw className="mr-1 h-3 w-3" />
                    ÐŸÐ¾Ð¿Ñ€Ð¾Ð±Ð¾Ð²Ð°Ñ‚ÑŒ ÑÐ½Ð¾Ð²Ð°
                  </Button>
                </div>
              </div>
            </div>

            {/* Manual input - Mobile adapted with validation */}
            {placementActive && (
              <div className="p-3 sm:p-4 border rounded-lg bg-blue-50">
                <h5 className="font-medium text-blue-800 mb-2 flex items-center text-sm sm:text-base">
                  <Edit className="mr-2 h-4 w-4" />
                  Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð²Ð²Ð¾Ð´ Ð´Ð°Ð½Ð½Ñ‹Ñ…
                </h5>
                <p className="text-xs sm:text-sm text-blue-700 mb-3">
                  {!scannerActive ? 
                    'Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð´Ð»Ñ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ Ð³Ñ€ÑƒÐ·Ð°:' : 
                    'ÐÐ»ÑŒÑ‚ÐµÑ€Ð½Ð°Ñ‚Ð¸Ð²Ð½Ð¾ Ð¼Ð¾Ð¶ÐµÑ‚Ðµ Ð²Ð²ÐµÑÑ‚Ð¸ Ð´Ð°Ð½Ð½Ñ‹Ðµ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ:'}
                </p>
                <div className="space-y-3">
                  {/* Cargo Number Input with Validation */}
                  <div>
                    <Label htmlFor="manual-cargo" className="text-sm font-medium">ÐÐ¾Ð¼ÐµÑ€ Ð³Ñ€ÑƒÐ·Ð°</Label>
                    <Input
                      id="manual-cargo"
                      placeholder="ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: TEMP-123456"
                      value={manualCargoNumber}
                      onChange={(e) => {
                        setManualCargoNumber(e.target.value);
                        // Debounced validation
                        clearTimeout(window.cargoValidationTimeout);
                        window.cargoValidationTimeout = setTimeout(() => {
                          validateCargoNumber(e.target.value);
                        }, 500);
                      }}
                      className={`text-sm ${cargoValidation.isValid ? 'border-green-500' : ''}`}
                    />
                    
                    {/* Cargo Validation Results */}
                    {cargoValidation.isLoading && (
                      <div className="flex items-center mt-1 text-xs text-gray-600">
                        <RefreshCw className="animate-spin h-3 w-3 mr-1" />
                        ÐŸÑ€Ð¾Ð²ÐµÑ€ÐºÐ° Ð³Ñ€ÑƒÐ·Ð°...
                      </div>
                    )}
                    
                    {cargoValidation.isValid && cargoValidation.cargoInfo && (
                      <div className="mt-2 p-2 bg-green-50 border border-green-200 rounded text-xs">
                        <div className="font-medium text-green-800">âœ“ Ð“Ñ€ÑƒÐ· Ð½Ð°Ð¹Ð´ÐµÐ½:</div>
                        <div className="text-green-700">
                          <div><strong>ÐÐ°Ð·Ð²Ð°Ð½Ð¸Ðµ:</strong> {cargoValidation.cargoInfo.cargo_name}</div>
                          <div><strong>Ð’ÐµÑ:</strong> {cargoValidation.cargoInfo.weight} ÐºÐ³</div>
                          <div><strong>ÐžÑ‚:</strong> {cargoValidation.cargoInfo.sender}</div>
                          <div><strong>Ð”Ð»Ñ:</strong> {cargoValidation.cargoInfo.recipient}</div>
                        </div>
                      </div>
                    )}
                    
                    {!cargoValidation.isValid && manualCargoNumber.trim() && !cargoValidation.isLoading && (
                      <div className="mt-1 text-xs text-red-600">
                        âŒ Ð“Ñ€ÑƒÐ· Ñ Ñ‚Ð°ÐºÐ¸Ð¼ Ð½Ð¾Ð¼ÐµÑ€Ð¾Ð¼ Ð½Ðµ Ð½Ð°Ð¹Ð´ÐµÐ½
                      </div>
                    )}
                  </div>

                  {/* Cell Code Input with Available Cells */}
                  <div>
                    <Label htmlFor="manual-cell" className="text-sm font-medium">ÐšÐ¾Ð´ ÑÑ‡ÐµÐ¹ÐºÐ¸</Label>
                    <Input
                      id="manual-cell"
                      placeholder="ÐÐ°Ð¿Ñ€Ð¸Ð¼ÐµÑ€: W001-Ð‘1-ÐŸ1-Ð¯1"
                      value={manualCellCode}
                      onChange={(e) => setManualCellCode(e.target.value)}
                      className="text-sm"
                    />
                    
                    {/* Available Cells Display */}
                    {cellValidation.isLoading && (
                      <div className="flex items-center mt-1 text-xs text-gray-600">
                        <RefreshCw className="animate-spin h-3 w-3 mr-1" />
                        Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÐ²Ð¾Ð±Ð¾Ð´Ð½Ñ‹Ñ… ÑÑ‡ÐµÐµÐº...
                      </div>
                    )}
                    
                    {cellValidation.availableCells.length > 0 && (
                      <div className="mt-2">
                        <div className="text-xs font-medium text-gray-700 mb-1">
                          Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ñ‹Ðµ ÑÑ‡ÐµÐ¹ÐºÐ¸ ({cellValidation.selectedWarehouse?.name}):
                        </div>
                        <div className="max-h-32 overflow-y-auto">
                          <div className="grid grid-cols-1 gap-1">
                            {cellValidation.availableCells.slice(0, 10).map((cell, index) => (
                              <button
                                key={index}
                                onClick={() => setManualCellCode(cell.code)}
                                className="text-left p-2 text-xs bg-gray-50 hover:bg-gray-100 border rounded"
                              >
                                <div className="font-medium">{cell.code}</div>
                                <div className="text-gray-600">{cell.display}</div>
                              </button>
                            ))}
                          </div>
                          {cellValidation.availableCells.length > 10 && (
                            <div className="text-xs text-gray-500 mt-1">
                              ... Ð¸ ÐµÑ‰Ðµ {cellValidation.availableCells.length - 10} ÑÑ‡ÐµÐµÐº
                            </div>
                          )}
                        </div>
                      </div>
                    )}
                  </div>

                  <Button 
                    onClick={handleManualPlacement}
                    disabled={!cargoValidation.isValid || !manualCellCode.trim()}
                    className="w-full bg-blue-600 hover:bg-blue-700 text-sm"
                    size="sm"
                  >
                    <Package className="mr-2 h-4 w-4" />
                    Ð Ð°Ð·Ð¼ÐµÑÑ‚Ð¸Ñ‚ÑŒ Ð²Ñ€ÑƒÑ‡Ð½ÑƒÑŽ
                  </Button>
                </div>
              </div>
            )}

            {/* Statistics */}
            <div 
              className={`bg-gray-50 p-3 rounded-lg ${placementStatistics ? 'react-visible' : 'react-hidden'}`}
            >
              <h5 className="font-medium text-gray-700 mb-2">Ð¡Ñ‚Ð°Ñ‚Ð¸ÑÑ‚Ð¸ÐºÐ° Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ñ</h5>
              <div className="grid grid-cols-3 gap-2 text-sm">
                <div className="text-center">
                  <div className="font-medium text-blue-600">{placementStatistics?.today_placements || 0}</div>
                  <div className="text-gray-500">Ð¡ÐµÐ³Ð¾Ð´Ð½Ñ</div>
                </div>
                <div className="text-center">
                  <div className="font-medium text-green-600">{placementStatistics?.session_placements || 0}</div>
                  <div className="text-gray-500">Ð—Ð° ÑÐµÑÑÐ¸ÑŽ</div>
                </div>
                <div className="text-center">
                  <div className="font-medium text-orange-600">{placementStatistics?.recent_placements || 0}</div>
                  <div className="text-gray-500">ÐÐµÐ´Ð°Ð²Ð½Ð¸Ñ…</div>
                </div>
              </div>
            </div>

            {/* Action Buttons */}
            <div className="flex gap-2">
              {!placementActive && (
                <Button 
                  onClick={startCargoPlacement}
                  className="flex-1 bg-green-600 hover:bg-green-700"
                >
                  <Camera className="mr-2 h-4 w-4" />
                  ÐÐ°Ñ‡Ð°Ñ‚ÑŒ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ
                </Button>
              )}
              
              {placementActive && (
                <Button 
                  onClick={stopCargoPlacement}
                  variant="outline"
                  className="flex-1 text-red-600 border-red-300 hover:bg-red-50"
                >
                  <X className="mr-2 h-4 w-4" />
                  ÐžÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚ÑŒ Ñ€Ð°Ð·Ð¼ÐµÑ‰ÐµÐ½Ð¸Ðµ
                </Button>
              )}
              
              <Button 
                variant="outline" 
                onClick={() => {
                  stopCargoPlacement();
                  setShowCargoPlacementModal(false);
                  setPlacementStep('idle');
                  setScannedCargoForPlacement(null);
                  setManualCargoNumber('');
                  setManualCellCode('');
                }}
              >
                Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ
              </Button>
            </div>
        </DialogContent>
      </Dialog>

      {/* Bulk QR Generation Modal for Sender - Mobile Adapted */}
      <Dialog open={showBulkQRModal} onOpenChange={setBulkQRModal}>
        <DialogContent className="w-full max-w-[95vw] max-h-[95vh] p-3 sm:p-6 overflow-y-auto">
          <DialogHeader className="pb-2">
            <DialogTitle className="flex items-center text-lg">
              <QrCode className="mr-2 h-5 w-5" />
              QR ÐºÐ¾Ð´Ñ‹ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ
            </DialogTitle>
            <DialogDescription className="text-sm">
              Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ QR ÐºÐ¾Ð´Ð¾Ð² Ð´Ð»Ñ Ð²ÑÐµÑ… Ð³Ñ€ÑƒÐ·Ð¾Ð² Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ: {selectedSender?.sender_full_name}
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-4">
            {/* Information about sender and cargo count */}
            {selectedSender && (
              <div className="p-4 bg-blue-50 rounded-lg">
                <div className="grid grid-cols-2 gap-4">
                  <div>
                    <p className="font-medium text-blue-800">ÐžÑ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»ÑŒ: {selectedSender.sender_full_name}</p>
                    <p className="text-sm text-blue-600">Ð¢ÐµÐ»ÐµÑ„Ð¾Ð½: {selectedSender.sender_phone}</p>
                  </div>
                  <div>
                    <p className="font-medium text-blue-800">ÐšÐ¾Ð»Ð¸Ñ‡ÐµÑÑ‚Ð²Ð¾ Ð³Ñ€ÑƒÐ·Ð¾Ð²: {senderCargos.length}</p>
                    <p className="text-sm text-blue-600">
                      Ð¡Ð¾Ð·Ð´Ð°Ð½Ð¾ QR ÐºÐ¾Ð´Ð¾Ð²: {bulkQRResults.filter(r => r.success).length}/{bulkQRResults.length}
                    </p>
                  </div>
                </div>
              </div>
            )}

            {/* Loading state */}
            {bulkQRLoading && (
              <div className="text-center py-4">
                <RefreshCw className="animate-spin h-8 w-8 mx-auto text-blue-600" />
                <p className="mt-2 text-gray-600">Ð“ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ QR ÐºÐ¾Ð´Ð¾Ð²...</p>
              </div>
            )}

            {/* Results grid */}
            {bulkQRResults.length > 0 && (
              <div className="space-y-4">
                <h4 className="font-medium">Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸:</h4>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
                  {bulkQRResults.map((result, index) => (
                    <div 
                      key={index} 
                      className={`p-3 border rounded-lg ${result.success ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}`}
                    >
                      <div className="flex items-start justify-between">
                        <div>
                          <p className="font-medium text-sm">{result.cargo_number}</p>
                          <p className="text-xs text-gray-600">{result.cargo_name}</p>
                          {!result.success && (
                            <p className="text-xs text-red-600 mt-1">{result.error}</p>
                          )}
                        </div>
                        {result.success ? (
                          <div className="flex flex-col items-end space-y-1">
                            <img 
                              src={result.qr_code} 
                              alt={`QR ${result.cargo_number}`}
                              className="w-16 h-16"
                            />
                            <Button
                              size="sm"
                              variant="ghost"
                              onClick={() => {
                                const link = document.createElement('a');
                                link.href = result.qr_code;
                                link.download = `qr-${result.cargo_number}.png`;
                                link.click();
                              }}
                              className="text-xs p-1 h-auto"
                            >
                              <Download className="h-3 w-3" />
                            </Button>
                          </div>
                        ) : (
                          <XCircle className="h-5 w-5 text-red-500" />
                        )}
                      </div>
                    </div>
                  ))}
                </div>

                {/* Bulk actions */}
                <div className="flex gap-2 pt-4 border-t">
                  <Button
                    onClick={() => {
                      const successfulResults = bulkQRResults.filter(r => r.success);
                      successfulResults.forEach(result => {
                        const link = document.createElement('a');
                        link.href = result.qr_code;
                        link.download = `qr-${result.cargo_number}.png`;
                        link.click();
                      });
                    }}
                    disabled={bulkQRResults.filter(r => r.success).length === 0}
                    className="flex-1"
                  >
                    <Download className="mr-2 h-4 w-4" />
                    Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð²ÑÐµ ÑƒÑÐ¿ÐµÑˆÐ½Ñ‹Ðµ ({bulkQRResults.filter(r => r.success).length})
                  </Button>
                  <Button
                    variant="outline"
                    onClick={() => {
                      const printWindow = window.open('', '_blank');
                      const successfulResults = bulkQRResults.filter(r => r.success);
                      const qrHtml = successfulResults.map(result => `
                        <div style="margin: 20px; text-align: center; page-break-inside: avoid;">
                          <h3>Ð“Ñ€ÑƒÐ·: ${result.cargo_number}</h3>
                          <p>${result.cargo_name}</p>
                          <img src="${result.qr_code}" style="width: 200px; height: 200px;" />
                        </div>
                      `).join('');
                      
                      printWindow.document.write(`
                        <html>
                          <head><title>QR ÐºÐ¾Ð´Ñ‹ Ð´Ð»Ñ Ð¾Ñ‚Ð¿Ñ€Ð°Ð²Ð¸Ñ‚ÐµÐ»Ñ: ${selectedSender?.sender_full_name}</title></head>
                          <body>${qrHtml}</body>
                        </html>
                      `);
                      printWindow.document.close();
                      printWindow.print();
                    }}
                    disabled={bulkQRResults.filter(r => r.success).length === 0}
                    className="flex-1"
                  >
                    <Printer className="mr-2 h-4 w-4" />
                    ÐŸÐµÑ‡Ð°Ñ‚ÑŒ Ð²ÑÐµÑ…
                  </Button>
                </div>
              </div>
            )}

            {/* Close button */}
            <div className="flex justify-end pt-4">
              <Button 
                variant="outline" 
                onClick={() => {
                  setBulkQRModal(false);
                  setSelectedSender(null);
                  setSenderCargos([]);
                  setBulkQRResults([]);
                }}
              >
                Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>

      {/* Warehouse Management Modal - Mobile Adapted */}
      <Dialog open={showWarehouseManagementModal} onOpenChange={setShowWarehouseManagementModal}>
        <DialogContent className="w-full max-w-[95vw] max-h-[95vh] p-3 sm:p-6 overflow-y-auto">
          <DialogHeader className="pb-2">
            <DialogTitle className="flex items-center text-lg">
              <Settings className="mr-2 h-5 w-5" />
              Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÐºÐ»Ð°Ð´Ð¾Ð¼: {selectedWarehouseForManagement?.name}
            </DialogTitle>
            <DialogDescription className="text-sm">
              Ð£Ð¿Ñ€Ð°Ð²Ð»ÐµÐ½Ð¸Ðµ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð¾Ð¹ ÑÐºÐ»Ð°Ð´Ð°, Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ñ QR ÐºÐ¾Ð´Ð¾Ð² Ð´Ð»Ñ ÑÑ‡ÐµÐµÐº
            </DialogDescription>
          </DialogHeader>
          
          <div className="space-y-6">
            {warehouseManagementLoading ? (
              <div className="text-center py-8">
                <RefreshCw className="animate-spin h-8 w-8 mx-auto text-blue-600" />
                <p className="mt-2 text-gray-600">Ð—Ð°Ð³Ñ€ÑƒÐ·ÐºÐ° ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñ‹ ÑÐºÐ»Ð°Ð´Ð°...</p>
              </div>
            ) : warehouseStructure ? (
              <>
                {/* Warehouse Statistics */}
                <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                  <div className="p-4 bg-blue-50 rounded-lg">
                    <div className="text-2xl font-bold text-blue-600">{warehouseStructure.blocks}</div>
                    <div className="text-sm text-blue-600">Ð‘Ð»Ð¾ÐºÐ¾Ð²</div>
                  </div>
                  <div className="p-4 bg-green-50 rounded-lg">
                    <div className="text-2xl font-bold text-green-600">{warehouseStructure.total_cells}</div>
                    <div className="text-sm text-green-600">Ð’ÑÐµÐ³Ð¾ ÑÑ‡ÐµÐµÐº</div>
                  </div>
                  <div className="p-4 bg-orange-50 rounded-lg">
                    <div className="text-2xl font-bold text-orange-600">{warehouseStructure.occupied_cells}</div>
                    <div className="text-sm text-orange-600">Ð—Ð°Ð½ÑÑ‚Ð¾</div>
                  </div>
                  <div className="p-4 bg-gray-50 rounded-lg">
                    <div className="text-2xl font-bold text-gray-600">{warehouseStructure.free_cells}</div>
                    <div className="text-sm text-gray-600">Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð¾</div>
                  </div>
                </div>

                {/* Management Actions */}
                <div className="flex flex-wrap gap-2 p-4 bg-gray-50 rounded-lg">
                  <Button
                    onClick={() => generateCellQRCodes()}
                    disabled={cellQRLoading}
                    className="bg-blue-600 hover:bg-blue-700"
                  >
                    {cellQRLoading ? (
                      <RefreshCw className="mr-2 h-4 w-4 animate-spin" />
                    ) : (
                      <QrCode className="mr-2 h-4 w-4" />
                    )}
                    Ð¡Ð¾Ð·Ð´Ð°Ñ‚ÑŒ QR Ð´Ð»Ñ Ð²ÑÐµÑ… ÑÑ‡ÐµÐµÐº
                  </Button>
                  
                  <Button
                    onClick={addWarehouseBlock}
                    variant="outline"
                    className="text-green-600 border-green-300 hover:bg-green-50"
                  >
                    <Plus className="mr-2 h-4 w-4" />
                    Ð”Ð¾Ð±Ð°Ð²Ð¸Ñ‚ÑŒ Ð±Ð»Ð¾Ðº
                  </Button>
  
                  <Button
                    onClick={() => {
                      const blockToDelete = prompt(`Ð’Ð²ÐµÐ´Ð¸Ñ‚Ðµ Ð½Ð¾Ð¼ÐµÑ€ Ð±Ð»Ð¾ÐºÐ° Ð´Ð»Ñ ÑƒÐ´Ð°Ð»ÐµÐ½Ð¸Ñ (1-${warehouseStructure.blocks}):`);
                      if (blockToDelete && !isNaN(blockToDelete)) {
                        const blockNum = parseInt(blockToDelete);
                        if (blockNum >= 1 && blockNum <= warehouseStructure.blocks) {
                          if (confirm(`Ð’Ñ‹ ÑƒÐ²ÐµÑ€ÐµÐ½Ñ‹ Ñ‡Ñ‚Ð¾ Ñ…Ð¾Ñ‚Ð¸Ñ‚Ðµ ÑƒÐ´Ð°Ð»Ð¸Ñ‚ÑŒ Ð±Ð»Ð¾Ðº ${blockNum}? Ð­Ñ‚Ð¾ Ð´ÐµÐ¹ÑÑ‚Ð²Ð¸Ðµ Ð½ÐµÐ»ÑŒÐ·Ñ Ð¾Ñ‚Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ.`)) {
                            deleteWarehouseBlock(blockNum);
                          }
                        } else {
                          showAlert('ÐÐµÐ²ÐµÑ€Ð½Ñ‹Ð¹ Ð½Ð¾Ð¼ÐµÑ€ Ð±Ð»Ð¾ÐºÐ°', 'error');
                        }
                      }
                    }}
                    variant="outline"
                    className="text-red-600 border-red-300 hover:bg-red-50"
                  >
                    <Trash2 className="mr-2 h-4 w-4" />
                    Ð£Ð´Ð°Ð»Ð¸Ñ‚ÑŒ Ð±Ð»Ð¾Ðº
                  </Button>
                </div>

                {/* QR Generation Results */}
                {cellQRResults.length > 0 && (
                  <div className="space-y-4">
                    <h4 className="font-medium">Ð ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚Ñ‹ Ð³ÐµÐ½ÐµÑ€Ð°Ñ†Ð¸Ð¸ QR ÐºÐ¾Ð´Ð¾Ð²:</h4>
                    <div className="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3 max-h-64 overflow-y-auto p-4 border rounded-lg">
                      {cellQRResults.map((result, index) => (
                        <div 
                          key={index} 
                          className={`p-2 border rounded text-center ${result.success ? 'border-green-200 bg-green-50' : 'border-red-200 bg-red-50'}`}
                        >
                          <div className="text-xs font-medium mb-1">{result.location}</div>
                          {result.success ? (
                            <div className="space-y-1">
                              <img 
                                src={result.qr_code} 
                                alt={`QR ${result.location}`}
                                className="w-12 h-12 mx-auto"
                              />
                              <Button
                                size="sm"
                                variant="ghost"
                                onClick={() => {
                                  const link = document.createElement('a');
                                  link.href = result.qr_code;
                                  link.download = `cell-${result.location}.png`;
                                  link.click();
                                }}
                                className="text-xs p-1 h-auto"
                              >
                                <Download className="h-3 w-3" />
                              </Button>
                            </div>
                          ) : (
                            <div className="space-y-1">
                              <XCircle className="h-6 w-6 mx-auto text-red-500" />
                              <p className="text-xs text-red-600">{result.error}</p>
                            </div>
                          )}
                        </div>
                      ))}
                    </div>

                    {/* Bulk actions for cells */}
                    <div className="flex gap-2">
                      <Button
                        onClick={() => {
                          const successfulResults = cellQRResults.filter(r => r.success);
                          successfulResults.forEach(result => {
                            const link = document.createElement('a');
                            link.href = result.qr_code;
                            link.download = `cell-${result.location}.png`;
                            link.click();
                          });
                        }}
                        disabled={cellQRResults.filter(r => r.success).length === 0}
                        variant="outline"
                      >
                        <Download className="mr-2 h-4 w-4" />
                        Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ Ð²ÑÐµ QR ({cellQRResults.filter(r => r.success).length})
                      </Button>
                      <Button
                        variant="outline"
                        onClick={() => {
                          const printWindow = window.open('', '_blank');
                          const successfulResults = cellQRResults.filter(r => r.success);
                          const qrHtml = successfulResults.map(result => `
                            <div style="margin: 10px; text-align: center; display: inline-block; page-break-inside: avoid;">
                              <h4>${warehouseStructure.warehouse_name}</h4>
                              <p>Ð¯Ñ‡ÐµÐ¹ÐºÐ°: ${result.location}</p>
                              <img src="${result.qr_code}" style="width: 150px; height: 150px;" />
                            </div>
                          `).join('');
                          
                          printWindow.document.write(`
                            <html>
                              <head><title>QR ÐºÐ¾Ð´Ñ‹ ÑÑ‡ÐµÐµÐº ÑÐºÐ»Ð°Ð´Ð°: ${warehouseStructure.warehouse_name}</title></head>
                              <body style="display: flex; flex-wrap: wrap;">${qrHtml}</body>
                            </html>
                          `);
                          printWindow.document.close();
                          printWindow.print();
                        }}
                        disabled={cellQRResults.filter(r => r.success).length === 0}
                      >
                        <Printer className="mr-2 h-4 w-4" />
                        ÐŸÐµÑ‡Ð°Ñ‚ÑŒ Ð²ÑÐµÑ… QR
                      </Button>
                    </div>
                  </div>
                )}

                {/* Warehouse Structure Visualization */}
                <div className="space-y-4">
                  <h4 className="font-medium">Ð¡Ñ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ð° ÑÐºÐ»Ð°Ð´Ð°:</h4>
                  <div className="text-sm text-gray-600">
                    Ð‘Ð»Ð¾ÐºÐ¾Ð²: {warehouseStructure.blocks} | 
                    ÐŸÐ¾Ð»Ð¾Ðº Ð½Ð° Ð±Ð»Ð¾Ðº: {warehouseStructure.shelves_per_block} | 
                    Ð¯Ñ‡ÐµÐµÐº Ð½Ð° Ð¿Ð¾Ð»ÐºÑƒ: {warehouseStructure.cells_per_shelf}
                  </div>
                  
                  <div className="p-4 border rounded-lg bg-gray-50">
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                      {Array.from({length: warehouseStructure.blocks}, (_, blockIndex) => (
                        <div key={blockIndex} className="border rounded p-3 bg-white">
                          <h5 className="font-medium mb-2">Ð‘Ð»Ð¾Ðº {blockIndex + 1}</h5>
                          <div className="text-xs text-gray-600 mb-2">
                            ÐŸÐ¾Ð»Ð¾Ðº: {warehouseStructure.shelves_per_block} | 
                            Ð¯Ñ‡ÐµÐµÐº: {warehouseStructure.shelves_per_block * warehouseStructure.cells_per_shelf}
                          </div>
                          <div className="grid grid-cols-5 gap-1">
                            {Array.from({length: Math.min(warehouseStructure.shelves_per_block * warehouseStructure.cells_per_shelf, 20)}, (_, cellIndex) => {
                              const shelf = Math.floor(cellIndex / warehouseStructure.cells_per_shelf) + 1;
                              const cell = (cellIndex % warehouseStructure.cells_per_shelf) + 1;
                              const isOccupied = warehouseStructure.cells.some(c => 
                                c.block === (blockIndex + 1) && c.shelf === shelf && c.cell === cell && c.is_occupied
                              );
                              
                              return (
                                <div 
                                  key={cellIndex}
                                  className={`w-4 h-4 border text-xs flex items-center justify-center ${
                                    isOccupied ? 'bg-red-200 border-red-400' : 'bg-green-200 border-green-400'
                                  }`}
                                  title={`Ð‘Ð»Ð¾Ðº ${blockIndex + 1}, ÐŸÐ¾Ð»ÐºÐ° ${shelf}, Ð¯Ñ‡ÐµÐ¹ÐºÐ° ${cell} - ${isOccupied ? 'Ð—Ð°Ð½ÑÑ‚Ð°' : 'Ð¡Ð²Ð¾Ð±Ð¾Ð´Ð½Ð°'}`}
                                >
                                  {isOccupied ? 'â—' : 'â—‹'}
                                </div>
                              );
                            })}
                            {warehouseStructure.shelves_per_block * warehouseStructure.cells_per_shelf > 20 && (
                              <div className="text-xs text-gray-500 col-span-5">
                                ... ÐµÑ‰Ñ‘ {warehouseStructure.shelves_per_block * warehouseStructure.cells_per_shelf - 20} ÑÑ‡ÐµÐµÐº
                              </div>
                            )}
                          </div>
                        </div>
                      ))}
                    </div>
                  </div>
                </div>
              </>
            ) : (
              <div className="text-center py-8 text-gray-500">
                ÐÐµ ÑƒÐ´Ð°Ð»Ð¾ÑÑŒ Ð·Ð°Ð³Ñ€ÑƒÐ·Ð¸Ñ‚ÑŒ ÑÑ‚Ñ€ÑƒÐºÑ‚ÑƒÑ€Ñƒ ÑÐºÐ»Ð°Ð´Ð°
              </div>
            )}

            {/* Close button */}
            <div className="flex justify-end pt-4 border-t">
              <Button 
                variant="outline" 
                onClick={() => {
                  setShowWarehouseManagementModal(false);
                  setSelectedWarehouseForManagement(null);
                  setWarehouseStructure(null);
                  setSelectedCells([]);
                  setCellQRResults([]);
                }}
              >
                Ð—Ð°ÐºÑ€Ñ‹Ñ‚ÑŒ
              </Button>
            </div>
          </div>
        </DialogContent>
      </Dialog>
    </div>
  );
}

export default App;