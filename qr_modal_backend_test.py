#!/usr/bin/env python3
"""
Backend Stability Testing After QR Code Modal JavaScript Fix for TAJLINE.TJ
Tests backend stability after fixing JavaScript error "Cannot read properties of null (reading 'document')" 
when printing QR codes in modal window for accepting warehouse notifications by operators.
"""

import requests
import sys
import json
from datetime import datetime
from typing import Dict, Any, Optional

class QRModalBackendTester:
    def __init__(self, base_url="https://tajline-cargo-5.preview.emergentagent.com"):
        self.base_url = base_url
        self.tokens = {}
        self.users = {}
        self.tests_run = 0
        self.tests_passed = 0
        
        print(f"üéØ TAJLINE.TJ QR Modal Backend Stability Tester")
        print(f"üì° Base URL: {self.base_url}")
        print(f"üîß Testing backend stability after QR code modal JavaScript fix")
        print("=" * 80)

    def run_test(self, name: str, method: str, endpoint: str, expected_status: int, 
                 data: Optional[Dict] = None, token: Optional[str] = None, 
                 params: Optional[Dict] = None) -> tuple[bool, Dict]:
        """Run a single API test"""
        url = f"{self.base_url}{endpoint}"
        headers = {'Content-Type': 'application/json'}
        
        if token:
            headers['Authorization'] = f'Bearer {token}'

        self.tests_run += 1
        print(f"\nüîç Test {self.tests_run}: {name}")
        print(f"   {method} {endpoint}")
        
        try:
            if method == 'GET':
                response = requests.get(url, headers=headers, params=params)
            elif method == 'POST':
                response = requests.post(url, json=data, headers=headers)
            elif method == 'PUT':
                response = requests.put(url, json=data, headers=headers, params=params)
            elif method == 'DELETE':
                response = requests.delete(url, json=data, headers=headers)

            success = response.status_code == expected_status
            
            if success:
                self.tests_passed += 1
                print(f"   ‚úÖ PASSED - Status: {response.status_code}")
                try:
                    result = response.json()
                    if isinstance(result, dict) and len(str(result)) < 300:
                        print(f"   üìÑ Response: {result}")
                    elif isinstance(result, list) and len(result) > 0:
                        print(f"   üìÑ Response: Found {len(result)} items")
                    return True, result
                except:
                    return True, {}
            else:
                print(f"   ‚ùå FAILED - Expected {expected_status}, got {response.status_code}")
                try:
                    error_detail = response.json()
                    print(f"   üìÑ Error: {error_detail}")
                except:
                    print(f"   üìÑ Raw response: {response.text[:200]}")
                return False, {}

        except Exception as e:
            print(f"   ‚ùå FAILED - Exception: {str(e)}")
            return False, {}

    def test_warehouse_operator_qr_modal_backend_stability(self):
        """
        Test backend stability after fixing JavaScript QR code modal error for warehouse operators
        
        –ö–û–ù–¢–ï–ö–°–¢: –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –æ—à–∏–±–∫–∞ "Cannot read properties of null (reading 'document')" 
        –ø—Ä–∏ –Ω–∞–∂–∞—Ç–∏–∏ –∫–Ω–æ–ø–∫–∏ "QR –∫–æ–¥" –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –≥—Ä—É–∑–∞ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–∫–∏.
        –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ null –¥–ª—è —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∞ window.open().
        
        –¢–ï–°–¢–û–í–´–ô –ü–õ–ê–ù:
        1. –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ —Å–∫–ª–∞–¥–∞ (+79777888999/warehouse123)
        2. –ü—Ä–æ–≤–µ—Ä–∫–∞ API endpoints –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π —Å–∫–ª–∞–¥–∞ (/api/operator/warehouse-notifications)
        3. –¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –ø—Ä–∏–Ω—è—Ç–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è (/api/operator/warehouse-notifications/{id}/accept)
        4. –ü—Ä–æ–≤–µ—Ä–∫–∞ endpoint –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è (/api/operator/warehouse-notifications/{id}/complete)
        5. –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ç–æ—Ä—Å–∫–∏—Ö endpoints –ø–æ—Å–ª–µ frontend –∏–∑–º–µ–Ω–µ–Ω–∏–π
        """
        print("\nüéØ BACKEND STABILITY AFTER QR MODAL JAVASCRIPT FIX TESTING")
        print("   üìã –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç—å backend –ø–æ—Å–ª–µ –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è JavaScript –æ—à–∏–±–∫–∏")
        print("   üîß –ø—Ä–∏ –ø–µ—á–∞—Ç–∏ QR –∫–æ–¥–æ–≤ –≤ –º–æ–¥–∞–ª—å–Ω–æ–º –æ–∫–Ω–µ –ø—Ä–∏–Ω—è—Ç–∏—è –∑–∞—è–≤–∫–∏ –æ–ø–µ—Ä–∞—Ç–æ—Ä–æ–º")
        
        all_success = True
        
        # Test 1: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –û–ü–ï–†–ê–¢–û–†–ê –°–ö–õ–ê–î–ê (+79777888999/warehouse123)
        print("\n   üîê Test 1: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –û–ü–ï–†–ê–¢–û–†–ê –°–ö–õ–ê–î–ê (+79777888999/warehouse123)...")
        
        operator_login_data = {
            "phone": "+79777888999",
            "password": "warehouse123"
        }
        
        success, login_response = self.run_test(
            "Warehouse Operator Authentication",
            "POST",
            "/api/auth/login",
            200,
            operator_login_data
        )
        all_success &= success
        
        operator_token = None
        if success and 'access_token' in login_response:
            operator_token = login_response['access_token']
            operator_user = login_response.get('user', {})
            operator_role = operator_user.get('role')
            operator_name = operator_user.get('full_name')
            operator_phone = operator_user.get('phone')
            operator_user_number = operator_user.get('user_number')
            
            print(f"   ‚úÖ Operator login successful: {operator_name}")
            print(f"   üëë Role: {operator_role}")
            print(f"   üìû Phone: {operator_phone}")
            print(f"   üÜî User Number: {operator_user_number}")
            print(f"   üîë JWT Token received: {operator_token[:50]}...")
            
            # Verify role is warehouse_operator
            if operator_role == 'warehouse_operator':
                print("   ‚úÖ Operator role correctly set to 'warehouse_operator'")
            else:
                print(f"   ‚ùå Operator role incorrect: expected 'warehouse_operator', got '{operator_role}'")
                all_success = False
            
            self.tokens['warehouse_operator'] = operator_token
            self.users['warehouse_operator'] = operator_user
        else:
            print("   ‚ùå Operator login failed - no access token received")
            print(f"   üìÑ Response: {login_response}")
            all_success = False
            return False
        
        # Test 2: –ü–†–û–í–ï–†–ö–ê API ENDPOINTS –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –°–ö–õ–ê–î–ê (/api/operator/warehouse-notifications)
        print("\n   üì¨ Test 2: API ENDPOINTS –î–õ–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–ô –°–ö–õ–ê–î–ê...")
        
        success, notifications_response = self.run_test(
            "Get Warehouse Notifications",
            "GET",
            "/api/operator/warehouse-notifications",
            200,
            token=operator_token
        )
        all_success &= success
        
        notification_id = None
        if success:
            print("   ‚úÖ /api/operator/warehouse-notifications endpoint working")
            
            # Verify response structure
            if isinstance(notifications_response, list):
                notification_count = len(notifications_response)
                print(f"   üìä Found {notification_count} warehouse notifications")
                
                # Find a notification that can be tested
                for notification in notifications_response:
                    if notification.get('status') in ['pending_acceptance', 'pending']:
                        notification_id = notification.get('id')
                        notification_type = notification.get('type', 'unknown')
                        notification_status = notification.get('status', 'unknown')
                        
                        print(f"   üìã Test notification found: {notification_id}")
                        print(f"   üìã Type: {notification_type}")
                        print(f"   üìã Status: {notification_status}")
                        break
                
                if not notification_id:
                    print("   ‚ö†Ô∏è  No pending notifications found for testing")
                    # Create a test notification by creating a pickup request first
                    print("   üîß Creating test pickup request to generate notification...")
                    
                    # Create test pickup request to generate notification
                    pickup_data = {
                        "sender_full_name": "–¢–µ—Å—Ç QR Modal –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å",
                        "sender_phone": "+79991234567",
                        "pickup_address": "–ú–æ—Å–∫–≤–∞, —É–ª. QR Modal –¢–µ—Å—Ç, 1",
                        "pickup_date": "2025-01-20",
                        "pickup_time_from": "10:00",
                        "pickup_time_to": "18:00",
                        "route": "moscow_to_tajikistan",
                        "courier_fee": 500.0,
                        "cargo_name": "–¢–µ—Å—Ç–æ–≤—ã–π –≥—Ä—É–∑ –¥–ª—è QR Modal",
                        "destination": "–î—É—à–∞–Ω–±–µ"
                    }
                    
                    success_pickup, pickup_response = self.run_test(
                        "Create Test Pickup Request",
                        "POST",
                        "/api/admin/courier/pickup-request",
                        200,
                        pickup_data,
                        operator_token
                    )
                    
                    if success_pickup:
                        pickup_id = pickup_response.get('id')
                        pickup_number = pickup_response.get('request_number')
                        print(f"   ‚úÖ Test pickup request created: {pickup_number} (ID: {pickup_id})")
                        
                        # Now check for notifications again
                        success, notifications_response = self.run_test(
                            "Get Warehouse Notifications (After Pickup Creation)",
                            "GET",
                            "/api/operator/warehouse-notifications",
                            200,
                            token=operator_token
                        )
                        
                        if success and isinstance(notifications_response, list):
                            for notification in notifications_response:
                                if notification.get('status') in ['pending_acceptance', 'pending']:
                                    notification_id = notification.get('id')
                                    break
                    
            elif isinstance(notifications_response, dict):
                notifications = notifications_response.get('notifications', [])
                notification_count = len(notifications)
                print(f"   üìä Found {notification_count} warehouse notifications")
                
                # Find a notification that can be tested
                for notification in notifications:
                    if notification.get('status') in ['pending_acceptance', 'pending']:
                        notification_id = notification.get('id')
                        break
            else:
                print("   ‚ùå Unexpected response format for warehouse notifications")
                all_success = False
        else:
            print("   ‚ùå /api/operator/warehouse-notifications endpoint failed")
            all_success = False
        
        # Test 3: –¢–ï–°–¢–ò–†–û–í–ê–ù–ò–ï –ü–†–ò–ù–Ø–¢–ò–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø (/api/operator/warehouse-notifications/{id}/accept)
        print("\n   ‚úÖ Test 3: –ü–†–ò–ù–Ø–¢–ò–ï –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø...")
        
        if notification_id:
            success, accept_response = self.run_test(
                f"Accept Warehouse Notification ({notification_id})",
                "POST",
                f"/api/operator/warehouse-notifications/{notification_id}/accept",
                200,
                token=operator_token
            )
            all_success &= success
            
            if success:
                print("   ‚úÖ /api/operator/warehouse-notifications/{id}/accept endpoint working")
                
                # Verify acceptance response
                if isinstance(accept_response, dict):
                    message = accept_response.get('message', '')
                    status = accept_response.get('status', '')
                    
                    if 'accept' in message.lower() or '–ø—Ä–∏–Ω—è—Ç' in message.lower():
                        print("   ‚úÖ Notification acceptance successful")
                    else:
                        print(f"   ‚ö†Ô∏è  Acceptance message: {message}")
                    
                    if status:
                        print(f"   üìä New status: {status}")
                else:
                    print("   ‚úÖ Notification accepted (non-dict response)")
            else:
                print("   ‚ùå /api/operator/warehouse-notifications/{id}/accept endpoint failed")
                all_success = False
        else:
            print("   ‚ö†Ô∏è  No notification ID available for acceptance testing")
        
        # Test 4: –ü–†–û–í–ï–†–ö–ê ENDPOINT –ó–ê–í–ï–†–®–ï–ù–ò–Ø –û–§–û–†–ú–õ–ï–ù–ò–Ø (/api/operator/warehouse-notifications/{id}/complete)
        print("\n   üèÅ Test 4: –ó–ê–í–ï–†–®–ï–ù–ò–ï –û–§–û–†–ú–õ–ï–ù–ò–Ø –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø...")
        
        if notification_id:
            # Prepare completion data
            completion_data = {
                "sender_full_name": "QR Modal –¢–µ—Å—Ç –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å",
                "cargo_items": [
                    {
                        "name": "–¢–µ—Å—Ç–æ–≤—ã–π –≥—Ä—É–∑ QR Modal",
                        "weight": "2.5",
                        "price": "1000"
                    }
                ],
                "payment_method": "cash",
                "delivery_method": "pickup"
            }
            
            success, complete_response = self.run_test(
                f"Complete Warehouse Notification ({notification_id})",
                "POST",
                f"/api/operator/warehouse-notifications/{notification_id}/complete",
                200,
                completion_data,
                operator_token
            )
            all_success &= success
            
            if success:
                print("   ‚úÖ /api/operator/warehouse-notifications/{id}/complete endpoint working")
                
                # Verify completion response
                if isinstance(complete_response, dict):
                    message = complete_response.get('message', '')
                    cargo_number = complete_response.get('cargo_number', '')
                    
                    if cargo_number:
                        print(f"   ‚úÖ Cargo created from notification: {cargo_number}")
                    
                    if 'complete' in message.lower() or '–∑–∞–≤–µ—Ä—à–µ–Ω' in message.lower():
                        print("   ‚úÖ Notification completion successful")
                    else:
                        print(f"   üìÑ Completion message: {message}")
                else:
                    print("   ‚úÖ Notification completed (non-dict response)")
            else:
                print("   ‚ùå /api/operator/warehouse-notifications/{id}/complete endpoint failed")
                all_success = False
        else:
            print("   ‚ö†Ô∏è  No notification ID available for completion testing")
        
        # Test 5: –ü–†–û–í–ï–†–ö–ê –°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–ò –í–°–ï–• –û–ü–ï–†–ê–¢–û–†–°–ö–ò–• ENDPOINTS –ü–û–°–õ–ï FRONTEND –ò–ó–ú–ï–ù–ï–ù–ò–ô
        print("\n   üîß Test 5: –°–¢–ê–ë–ò–õ–¨–ù–û–°–¢–¨ –í–°–ï–• –û–ü–ï–†–ê–¢–û–†–°–ö–ò–• ENDPOINTS...")
        
        # List of critical operator endpoints that should remain stable
        operator_endpoints = [
            ("/api/auth/me", "User Profile"),
            ("/api/operator/warehouses", "Operator Warehouses"),
            ("/api/operator/cargo/list", "Operator Cargo List"),
            ("/api/operator/placement-statistics", "Placement Statistics"),
            ("/api/warehouses", "All Warehouses"),
            ("/api/operator/cargo/available-for-placement", "Available Cargo for Placement")
        ]
        
        endpoint_results = []
        
        for endpoint, description in operator_endpoints:
            print(f"\n   üîç Testing {description} ({endpoint})...")
            
            success, response = self.run_test(
                f"Operator Endpoint: {description}",
                "GET",
                endpoint,
                200,
                token=operator_token
            )
            
            endpoint_results.append({
                'endpoint': endpoint,
                'description': description,
                'success': success,
                'response': response
            })
            
            if success:
                print(f"   ‚úÖ {description} working")
                
                # Check for JSON serialization issues (no ObjectId errors)
                if isinstance(response, (dict, list)):
                    response_str = str(response)
                    if 'ObjectId' in response_str:
                        print(f"   ‚ö†Ô∏è  Potential ObjectId serialization issue in {description}")
                        all_success = False
                    else:
                        print(f"   ‚úÖ JSON serialization correct for {description}")
            else:
                print(f"   ‚ùå {description} failing")
                all_success = False
        
        # Test 6: CHECK FOR 500 INTERNAL SERVER ERRORS
        print("\n   üö® Test 6: 500 INTERNAL SERVER ERROR CHECK...")
        
        error_500_count = 0
        for result in endpoint_results:
            if not result['success']:
                # Check if it was a 500 error by making the request again and checking status
                try:
                    url = f"{self.base_url}{result['endpoint']}"
                    headers = {'Authorization': f'Bearer {operator_token}', 'Content-Type': 'application/json'}
                    response = requests.get(url, headers=headers)
                    if response.status_code == 500:
                        error_500_count += 1
                        print(f"   ‚ùå 500 Error in {result['description']} ({result['endpoint']})")
                except:
                    pass
        
        if error_500_count == 0:
            print("   ‚úÖ No 500 Internal Server Errors found!")
        else:
            print(f"   ‚ùå Found {error_500_count} endpoints with 500 Internal Server Errors")
            all_success = False
        
        # Test 7: SESSION MANAGEMENT STABILITY
        print("\n   üîê Test 7: SESSION MANAGEMENT STABILITY...")
        
        # Test multiple requests with the same token to ensure session stability
        session_tests = [
            ("/api/auth/me", "User Profile Check"),
            ("/api/operator/warehouses", "Warehouses Access"),
            ("/api/operator/cargo/list", "Cargo List Access")
        ]
        
        session_stable = True
        for endpoint, description in session_tests:
            success, _ = self.run_test(
                f"Session Stability: {description}",
                "GET",
                endpoint,
                200,
                token=operator_token
            )
            
            if not success:
                session_stable = False
                print(f"   ‚ùå Session instability detected in {description}")
            else:
                print(f"   ‚úÖ Session stable for {description}")
        
        if session_stable:
            print("   ‚úÖ Session management stable - no premature 401 errors")
        else:
            print("   ‚ùå Session management issues detected")
            all_success = False
        
        # SUMMARY
        print("\n   üìä QR MODAL BACKEND STABILITY SUMMARY:")
        
        successful_endpoints = sum(1 for result in endpoint_results if result['success'])
        total_endpoints = len(endpoint_results)
        success_rate = (successful_endpoints / total_endpoints * 100) if total_endpoints > 0 else 0
        
        print(f"   üìà Endpoint Success Rate: {successful_endpoints}/{total_endpoints} ({success_rate:.1f}%)")
        
        if all_success:
            print("   üéâ ALL TESTS PASSED - Backend stable after QR modal JavaScript fix!")
            print("   ‚úÖ Warehouse operator authentication working (+79777888999/warehouse123)")
            print("   ‚úÖ /api/operator/warehouse-notifications endpoint accessible")
            print("   ‚úÖ /api/operator/warehouse-notifications/{id}/accept working")
            print("   ‚úÖ /api/operator/warehouse-notifications/{id}/complete working")
            print("   ‚úÖ All operator endpoints stable after frontend changes")
            print("   ‚úÖ No 500 Internal Server Errors")
            print("   ‚úÖ Session management stable")
            print("   üéØ EXPECTED RESULT ACHIEVED: Backend should work stably, all endpoints")
            print("      should be available, no backend errors after frontend fixes")
        else:
            print("   ‚ùå SOME TESTS FAILED - Backend stability needs attention")
            print("   üîç Check the specific failed tests above for details")
            
            # List failed endpoints
            failed_endpoints = [result for result in endpoint_results if not result['success']]
            if failed_endpoints:
                print("   ‚ùå Failed endpoints:")
                for result in failed_endpoints:
                    print(f"     - {result['description']} ({result['endpoint']})")
        
        return all_success

    def run_all_tests(self):
        """Run all QR modal backend stability tests"""
        print("üöÄ Starting QR Modal Backend Stability Tests...")
        
        # Run the main test
        success = self.test_warehouse_operator_qr_modal_backend_stability()
        
        # Final summary
        print("\n" + "=" * 80)
        print("üìä FINAL TEST SUMMARY")
        print("=" * 80)
        print(f"Tests Run: {self.tests_run}")
        print(f"Tests Passed: {self.tests_passed}")
        print(f"Success Rate: {(self.tests_passed/self.tests_run*100):.1f}%" if self.tests_run > 0 else "0%")
        
        if success:
            print("\nüéâ ALL QR MODAL BACKEND STABILITY TESTS PASSED!")
            print("‚úÖ Backend is stable after QR code modal JavaScript fix")
            print("‚úÖ All warehouse operator endpoints working")
            print("‚úÖ Warehouse notifications system functional")
            print("‚úÖ No backend errors after frontend improvements")
        else:
            print("\n‚ùå SOME TESTS FAILED")
            print("üîß Backend stability may need attention after QR modal fix")
        
        return success

if __name__ == "__main__":
    tester = QRModalBackendTester()
    success = tester.run_all_tests()
    sys.exit(0 if success else 1)