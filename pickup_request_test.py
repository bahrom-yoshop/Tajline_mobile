#!/usr/bin/env python3
"""
TAJLINE.TJ Improved Pickup Request Modal Testing
Testing the improved pickup request processing modal functionality according to review request
"""

import requests
import json
import sys
import os

class PickupRequestTester:
    def __init__(self, base_url="https://tajline-logistics-1.preview.emergentagent.com"):
        self.base_url = base_url
        self.session = requests.Session()
        self.tests_run = 0
        self.tests_passed = 0
        
    def run_test(self, test_name, method, endpoint, expected_status, data=None, token=None):
        """Run a single test"""
        self.tests_run += 1
        
        url = f"{self.base_url}{endpoint}"
        headers = {'Content-Type': 'application/json'}
        
        if token:
            headers['Authorization'] = f'Bearer {token}'
        
        try:
            if method == 'GET':
                response = self.session.get(url, headers=headers)
            elif method == 'POST':
                response = self.session.post(url, json=data, headers=headers)
            elif method == 'PUT':
                response = self.session.put(url, json=data, headers=headers)
            elif method == 'DELETE':
                response = self.session.delete(url, headers=headers)
            else:
                raise ValueError(f"Unsupported method: {method}")
            
            print(f"\nüîç Test {self.tests_run}: {test_name}")
            print(f"   {method} {endpoint}")
            
            if response.status_code == expected_status:
                print(f"   ‚úÖ PASSED - Status: {response.status_code}")
                self.tests_passed += 1
                
                try:
                    response_data = response.json()
                    print(f"   üìÑ Response: {response_data}")
                    return True, response_data
                except:
                    return True, response.text
            else:
                print(f"   ‚ùå FAILED - Expected: {expected_status}, Got: {response.status_code}")
                try:
                    error_data = response.json()
                    print(f"   üìÑ Error: {error_data}")
                    return False, error_data
                except:
                    print(f"   üìÑ Error: {response.text}")
                    return False, response.text
                    
        except Exception as e:
            print(f"   ‚ùå EXCEPTION: {str(e)}")
            return False, str(e)

    def test_pickup_request_system_fixes(self):
        """Test pickup request system fixes according to review request"""
        print("\nüöö PICKUP REQUEST SYSTEM FIXES TESTING")
        print("   üéØ –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è —Å–∏—Å—Ç–µ–º—ã –∑–∞—è–≤–æ–∫ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞ –≤ TAJLINE.TJ")
        print("   üîß –ü–†–û–ë–õ–ï–ú–ê: –û–ø–µ—Ä–∞—Ç–æ—Ä –∑–∞–ø–æ–ª–Ω—è–µ—Ç –∑–∞—è–≤–∫—É –¥–ª—è –∑–∞–±–æ—Ä–∞ –≥—Ä—É–∑–∞, –Ω–æ –≤ –ª–∏—á–Ω–æ–º –∫–∞–±–∏–Ω–µ—Ç–µ –∫—É—Ä—å–µ—Ä–∞ –∑–∞—è–≤–∫–∏ –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è")
        print("   üîß –ò–°–ü–†–ê–í–õ–ï–ù–ò–Ø –°–î–ï–õ–ê–ù–ù–´–ï:")
        print("   1) –û–±–Ω–æ–≤–ª–µ–Ω endpoint /api/courier/requests/new - —Ç–µ–ø–µ—Ä—å –≤–∫–ª—é—á–∞–µ—Ç –∑–∞—è–≤–∫–∏ –∏–∑ –∫–æ–ª–ª–µ–∫—Ü–∏–∏ courier_pickup_requests")
        print("   2) –û–±–Ω–æ–≤–ª–µ–Ω endpoint /api/courier/requests/{request_id}/accept - —Ç–µ–ø–µ—Ä—å –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –ø—Ä–∏–Ω—è—Ç–∏–µ –∑–∞—è–≤–æ–∫ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞")
        print("   3) –ó–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞ –ø–æ–º–µ—á–∞—é—Ç—Å—è –∫–∞–∫ request_type: 'pickup', –æ–±—ã—á–Ω—ã–µ –∫–∞–∫ request_type: 'delivery'")
        
        all_success = True
        
        # Test 1: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –û–ü–ï–†–ê–¢–û–†–ê (+79777888999/warehouse123)
        print("\n   üîê Test 1: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –û–ü–ï–†–ê–¢–û–†–ê (+79777888999/warehouse123)...")
        
        operator_login_data = {
            "phone": "+79777888999",
            "password": "warehouse123"
        }
        
        success, login_response = self.run_test(
            "Operator Login Authentication",
            "POST",
            "/api/auth/login",
            200,
            operator_login_data
        )
        all_success &= success
        
        operator_token = None
        if success and 'access_token' in login_response:
            operator_token = login_response['access_token']
            operator_user = login_response.get('user', {})
            operator_role = operator_user.get('role')
            operator_name = operator_user.get('full_name')
            
            print(f"   ‚úÖ Operator login successful: {operator_name}")
            print(f"   üëë Role: {operator_role}")
            print(f"   üìû Phone: {operator_user.get('phone')}")
        else:
            print("   ‚ùå Operator login failed")
            all_success = False
            return False
        
        # Test 2: –°–û–ó–î–ê–¢–¨ –¢–ï–°–¢–û–í–£–Æ –ó–ê–Ø–í–ö–£ –ù–ê –ó–ê–ë–û–† –ì–†–£–ó–ê —á–µ—Ä–µ–∑ POST /api/admin/courier/pickup-request
        print("\n   üì¶ Test 2: –°–û–ó–î–ê–¢–¨ –¢–ï–°–¢–û–í–£–Æ –ó–ê–Ø–í–ö–£ –ù–ê –ó–ê–ë–û–† –ì–†–£–ó–ê...")
        
        pickup_request_data = {
            "sender_full_name": "–¢–µ—Å—Ç –û—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—å",
            "sender_phone": "+7999123456",
            "pickup_address": "–ú–æ—Å–∫–≤–∞, —É–ª. –¢–µ—Å—Ç–æ–≤–∞—è, 1",
            "pickup_date": "2025-01-15",
            "pickup_time_from": "10:00",
            "pickup_time_to": "12:00",
            "route": "moscow_to_tajikistan",
            "courier_fee": 500,
            "payment_method": "not_paid"
        }
        
        success, pickup_response = self.run_test(
            "Create Pickup Request via POST /api/admin/courier/pickup-request",
            "POST",
            "/api/admin/courier/pickup-request",
            200,
            pickup_request_data,
            operator_token
        )
        all_success &= success
        
        pickup_request_id = None
        if success and ('id' in pickup_response or 'request_id' in pickup_response):
            pickup_request_id = pickup_response.get('id') or pickup_response.get('request_id')
            request_number = pickup_response.get('request_number')
            print(f"   ‚úÖ Pickup request created successfully: {request_number}")
            print(f"   üÜî Request ID: {pickup_request_id}")
            
            # Verify response contains expected fields
            expected_fields = ['request_number']
            if 'id' in pickup_response:
                expected_fields.append('id')
            if 'request_id' in pickup_response:
                expected_fields.append('request_id')
            
            missing_fields = [field for field in expected_fields if field not in pickup_response]
            
            if not missing_fields:
                print("   ‚úÖ Pickup request response contains all expected fields")
            else:
                print(f"   ‚ùå Missing fields in pickup request response: {missing_fields}")
                all_success = False
        else:
            print("   ‚ùå Failed to create pickup request")
            print(f"   üìÑ Response: {pickup_response}")
            all_success = False
            return False
        
        # Test 3: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ö–£–†–¨–ï–†–ê (+79991234567/courier123)
        print("\n   üö¥ Test 3: –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø –ö–£–†–¨–ï–†–ê (+79991234567/courier123)...")
        
        courier_login_data = {
            "phone": "+79991234567",
            "password": "courier123"
        }
        
        success, courier_login_response = self.run_test(
            "Courier Login Authentication",
            "POST",
            "/api/auth/login",
            200,
            courier_login_data
        )
        all_success &= success
        
        courier_token = None
        if success and 'access_token' in courier_login_response:
            courier_token = courier_login_response['access_token']
            courier_user = courier_login_response.get('user', {})
            courier_role = courier_user.get('role')
            courier_name = courier_user.get('full_name')
            
            print(f"   ‚úÖ Courier login successful: {courier_name}")
            print(f"   üëë Role: {courier_role}")
            print(f"   üìû Phone: {courier_user.get('phone')}")
        else:
            print("   ‚ùå Courier login failed")
            all_success = False
            return False
        
        # Test 4: –í–´–ó–í–ê–¢–¨ GET /api/courier/requests/new –∏ —É–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –∑–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞ –ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è
        print("\n   üìã Test 4: GET /api/courier/requests/new - –ü–†–û–í–ï–†–ò–¢–¨ –ó–ê–Ø–í–ö–ò –ù–ê –ó–ê–ë–û–† –ì–†–£–ó–ê...")
        
        success, new_requests_response = self.run_test(
            "Get New Courier Requests (Including Pickup Requests)",
            "GET",
            "/api/courier/requests/new",
            200,
            token=courier_token
        )
        all_success &= success
        
        pickup_request_found = False
        if success:
            print("   ‚úÖ /api/courier/requests/new endpoint working")
            
            # Check response structure
            if isinstance(new_requests_response, dict):
                new_requests = new_requests_response.get('new_requests', [])
                total_count = new_requests_response.get('total_count', 0)
                
                print(f"   üìä Total new requests: {total_count}")
                print(f"   üìã Requests in response: {len(new_requests)}")
                
                # Look for pickup requests
                pickup_requests = []
                delivery_requests = []
                
                for request in new_requests:
                    request_type = request.get('request_type', 'unknown')
                    if request_type == 'pickup':
                        pickup_requests.append(request)
                        if request.get('id') == pickup_request_id or request.get('request_id') == pickup_request_id:
                            pickup_request_found = True
                    elif request_type == 'delivery':
                        delivery_requests.append(request)
                
                print(f"   üöö Pickup requests found: {len(pickup_requests)}")
                print(f"   üöõ Delivery requests found: {len(delivery_requests)}")
                
                if pickup_requests:
                    print("   ‚úÖ Pickup requests are now showing in courier's new requests list!")
                    
                    # Verify pickup request structure
                    sample_pickup = pickup_requests[0]
                    required_pickup_fields = ['id', 'sender_full_name', 'sender_phone', 'pickup_address', 'pickup_date', 'pickup_time_from', 'pickup_time_to', 'request_type']
                    missing_pickup_fields = [field for field in required_pickup_fields if field not in sample_pickup]
                    
                    if not missing_pickup_fields:
                        print("   ‚úÖ Pickup request contains all necessary fields")
                        print(f"   üìç Sample pickup address: {sample_pickup.get('pickup_address')}")
                        print(f"   üìÖ Sample pickup date: {sample_pickup.get('pickup_date')}")
                        print(f"   üïê Sample pickup time: {sample_pickup.get('pickup_time_from')} - {sample_pickup.get('pickup_time_to')}")
                        print(f"   üè∑Ô∏è Request type: {sample_pickup.get('request_type')}")
                    else:
                        print(f"   ‚ùå Missing fields in pickup request: {missing_pickup_fields}")
                        all_success = False
                    
                    if pickup_request_found:
                        print("   ‚úÖ Our test pickup request found in the list!")
                    else:
                        print("   ‚ö†Ô∏è Our test pickup request not found in the list (may be filtered by courier assignment)")
                else:
                    print("   ‚ùå No pickup requests found in courier's new requests list")
                    print("   üîç This indicates the fix may not be working correctly")
                    all_success = False
                    
            elif isinstance(new_requests_response, list):
                print(f"   üìä Direct list response with {len(new_requests_response)} requests")
                # Handle direct list response
                pickup_requests = [req for req in new_requests_response if req.get('request_type') == 'pickup']
                if pickup_requests:
                    print(f"   ‚úÖ Found {len(pickup_requests)} pickup requests in direct list")
                else:
                    print("   ‚ùå No pickup requests found in direct list response")
                    all_success = False
            else:
                print("   ‚ùå Unexpected response format")
                all_success = False
        else:
            print("   ‚ùå /api/courier/requests/new endpoint failed")
            all_success = False
        
        # Test 5: –ü–†–û–í–ï–†–ò–¢–¨ –ß–¢–û –ó–ê–Ø–í–ö–ò –ò–ú–ï–Æ–¢ request_type: 'pickup' –ò –°–û–î–ï–†–ñ–ê–¢ –ù–ï–û–ë–•–û–î–ò–ú–´–ï –ü–û–õ–Ø
        print("\n   üè∑Ô∏è Test 5: –ü–†–û–í–ï–†–ò–¢–¨ request_type: 'pickup' –ò –ù–ï–û–ë–•–û–î–ò–ú–´–ï –ü–û–õ–Ø...")
        
        if pickup_request_found or (success and new_requests_response):
            # We already checked this in Test 4, but let's summarize
            if isinstance(new_requests_response, dict):
                new_requests = new_requests_response.get('new_requests', [])
            else:
                new_requests = new_requests_response if isinstance(new_requests_response, list) else []
            
            pickup_requests_with_correct_type = [req for req in new_requests if req.get('request_type') == 'pickup']
            
            if pickup_requests_with_correct_type:
                print(f"   ‚úÖ Found {len(pickup_requests_with_correct_type)} requests with request_type: 'pickup'")
                
                # Verify all necessary fields are present
                sample_request = pickup_requests_with_correct_type[0]
                necessary_fields = [
                    'id', 'sender_full_name', 'sender_phone', 'pickup_address', 
                    'pickup_date', 'pickup_time_from', 'pickup_time_to', 'request_type'
                ]
                
                field_check_results = {}
                for field in necessary_fields:
                    field_check_results[field] = field in sample_request
                    if field in sample_request:
                        print(f"   ‚úÖ {field}: {sample_request.get(field)}")
                    else:
                        print(f"   ‚ùå Missing field: {field}")
                        all_success = False
                
                all_fields_present = all(field_check_results.values())
                if all_fields_present:
                    print("   ‚úÖ All necessary fields present in pickup requests")
                else:
                    missing_fields = [field for field, present in field_check_results.items() if not present]
                    print(f"   ‚ùå Missing necessary fields: {missing_fields}")
                    all_success = False
            else:
                print("   ‚ùå No pickup requests found with correct request_type")
                all_success = False
        else:
            print("   ‚ö†Ô∏è Cannot verify request_type due to previous test failures")
        
        # Test 6: –ü–†–û–¢–ï–°–¢–ò–†–û–í–ê–¢–¨ –ü–†–ò–ù–Ø–¢–ò–ï –ó–ê–Ø–í–ö–ò –ù–ê –ó–ê–ë–û–† –ì–†–£–ó–ê —á–µ—Ä–µ–∑ POST /api/courier/requests/{request_id}/accept
        print("\n   ‚úÖ Test 6: –ü–†–ò–ù–Ø–¢–ò–ï –ó–ê–Ø–í–ö–ò –ù–ê –ó–ê–ë–û–† –ì–†–£–ó–ê...")
        
        if pickup_request_id:
            success, accept_response = self.run_test(
                f"Accept Pickup Request via POST /api/courier/requests/{pickup_request_id}/accept",
                "POST",
                f"/api/courier/requests/{pickup_request_id}/accept",
                200,
                {},  # Empty body for accept request
                courier_token
            )
            all_success &= success
            
            if success:
                print("   ‚úÖ Pickup request acceptance endpoint working")
                
                # Verify response contains expected information
                if 'message' in accept_response:
                    print(f"   üìÑ Response message: {accept_response.get('message')}")
                
                if 'request_id' in accept_response:
                    print(f"   üÜî Accepted request ID: {accept_response.get('request_id')}")
                
                # Check if response indicates the request type
                if 'request_type' in accept_response:
                    response_request_type = accept_response.get('request_type')
                    print(f"   üè∑Ô∏è Response request_type: {response_request_type}")
                    
                    if response_request_type == 'pickup':
                        print("   ‚úÖ Response correctly indicates pickup request type")
                    else:
                        print(f"   ‚ùå Response request_type incorrect: expected 'pickup', got '{response_request_type}'")
                        all_success = False
                else:
                    print("   ‚ö†Ô∏è Response does not include request_type (may be acceptable)")
                
                print("   ‚úÖ Pickup request acceptance working correctly")
            else:
                print("   ‚ùå Failed to accept pickup request")
                all_success = False
        else:
            print("   ‚ö†Ô∏è Cannot test pickup request acceptance - no pickup request ID available")
            all_success = False
        
        # Test 7: –£–ë–ï–î–ò–¢–¨–°–Ø –ß–¢–û –í –û–¢–í–ï–¢–ï –£–ö–ê–ó–ê–ù –ü–†–ê–í–ò–õ–¨–ù–´–ô request_type
        print("\n   üè∑Ô∏è Test 7: –ü–†–û–í–ï–†–ò–¢–¨ –ü–†–ê–í–ò–õ–¨–ù–´–ô request_type –í –û–¢–í–ï–¢–ï...")
        
        if success and accept_response:
            # We already checked this in Test 6, but let's be explicit
            response_request_type = accept_response.get('request_type')
            
            if response_request_type == 'pickup':
                print("   ‚úÖ Accept response correctly returns request_type: 'pickup'")
            elif response_request_type is None:
                print("   ‚ö†Ô∏è Accept response does not include request_type field")
                print("   ‚ÑπÔ∏è This may be acceptable if the endpoint doesn't return this field")
            else:
                print(f"   ‚ùå Accept response has incorrect request_type: expected 'pickup', got '{response_request_type}'")
                all_success = False
        else:
            print("   ‚ö†Ô∏è Cannot verify request_type in response due to previous test failures")
        
        # SUMMARY
        print("\n   üìä PICKUP REQUEST SYSTEM FIXES SUMMARY:")
        
        if all_success:
            print("   üéâ ALL PICKUP REQUEST SYSTEM TESTS PASSED!")
            print("   ‚úÖ Operator authentication working (+79777888999/warehouse123)")
            print("   ‚úÖ Pickup request creation via POST /api/admin/courier/pickup-request working")
            print("   ‚úÖ Courier authentication working (+79991234567/courier123)")
            print("   ‚úÖ GET /api/courier/requests/new now includes pickup requests from courier_pickup_requests collection")
            print("   ‚úÖ Pickup requests have request_type: 'pickup' and contain necessary fields")
            print("   ‚úÖ POST /api/courier/requests/{request_id}/accept supports pickup request acceptance")
            print("   ‚úÖ Accept response indicates correct request_type")
            print("   üéØ –û–ñ–ò–î–ê–ï–ú–´–ô –†–ï–ó–£–õ–¨–¢–ê–¢ –î–û–°–¢–ò–ì–ù–£–¢: –ó–∞—è–≤–∫–∏ –Ω–∞ –∑–∞–±–æ—Ä –≥—Ä—É–∑–∞ –æ—Ç–æ–±—Ä–∞–∂–∞—é—Ç—Å—è –≤ —Å–ø–∏—Å–∫–µ –Ω–æ–≤—ã—Ö –∑–∞—è–≤–æ–∫ –¥–ª—è –∫—É—Ä—å–µ—Ä–∞ –∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ –ø—Ä–∏–Ω–∏–º–∞—é—Ç—Å—è!")
        else:
            print("   ‚ùå SOME PICKUP REQUEST SYSTEM TESTS FAILED")
            print("   üîç Check the specific failed tests above for details")
            print("   ‚ö†Ô∏è The pickup request system fixes may need attention")
        
        return all_success

if __name__ == "__main__":
    # Get the backend URL from environment variable
    backend_url = os.environ.get('REACT_APP_BACKEND_URL', 'https://tajline-logistics-1.preview.emergentagent.com')
    
    # Initialize tester with the correct URL
    tester = PickupRequestTester(base_url=backend_url)
    
    # Run only the pickup request system fixes test
    print("üéØ RUNNING SPECIFIC TEST: PICKUP REQUEST SYSTEM FIXES")
    print("=" * 80)
    
    result = tester.test_pickup_request_system_fixes()
    
    print("\n" + "=" * 80)
    print("üèÅ FINAL TEST RESULT")
    print("=" * 80)
    print(f"üìä Total tests run: {tester.tests_run}")
    print(f"‚úÖ Tests passed: {tester.tests_passed}")
    print(f"‚ùå Tests failed: {tester.tests_run - tester.tests_passed}")
    print(f"üìà Success rate: {(tester.tests_passed/tester.tests_run*100):.1f}%" if tester.tests_run > 0 else "0%")
    
    if result:
        print("\nüéâ PICKUP REQUEST SYSTEM FIXES TEST PASSED!")
        print("‚úÖ Pickup request system fixes working correctly")
        sys.exit(0)
    else:
        print("\n‚ùå PICKUP REQUEST SYSTEM FIXES TEST FAILED")
        print("üîç Check test results above for details")
        sys.exit(1)