#!/usr/bin/env python3
"""
üî¨ –ì–õ–£–ë–û–ö–û–ï –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï: API layout-with-cargo –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã

**–û–ë–ù–ê–†–£–ñ–ï–ù–ù–ê–Ø –ü–†–û–ë–õ–ï–ú–ê:**
- –ì—Ä—É–∑—ã 25082235/01/01 –∏ 25082235/01/02 –ø–æ–º–µ—á–µ–Ω—ã –∫–∞–∫ —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- –ù–û API /api/warehouses/{warehouse_id}/layout-with-cargo –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç:
  - occupied_cells: 0
  - total_cargo: 0  
  - blocks: [] (–ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤)

**–ì–õ–£–ë–û–ö–û–ï –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï:**
1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É –¥–∞–Ω–Ω—ã—Ö –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É API layout-with-cargo
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å –º–µ–∂–¥—É placement_records –∏ warehouse layout
4. –ù–∞–π—Ç–∏ –≥–¥–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç —Ä–∞–∑—Ä—ã–≤ –≤ —Ü–µ–ø–æ—á–∫–µ –¥–∞–Ω–Ω—ã—Ö
"""

import requests
import json
import sys
from datetime import datetime
import time

# Configuration
BACKEND_URL = "https://cargo-sync.preview.emergentagent.com/api"

# Test credentials
WAREHOUSE_OPERATOR_PHONE = "+79777888999"
WAREHOUSE_OPERATOR_PASSWORD = "warehouse123"

class LayoutAPIDeepInvestigation:
    def __init__(self):
        self.session = requests.Session()
        self.token = None
        self.warehouse_id = None
        self.test_results = []
        self.start_time = time.time()
        
    def log_result(self, test_name: str, success: bool, details: str, response_time: float = 0):
        """Log test result with timing"""
        status = "‚úÖ PASS" if success else "‚ùå FAIL"
        self.test_results.append({
            "test": test_name,
            "status": status,
            "success": success,
            "details": details,
            "response_time": f"{response_time:.0f}ms"
        })
        print(f"{status} {test_name}: {details} ({response_time:.0f}ms)")
        
    def make_request(self, method: str, endpoint: str, **kwargs):
        """Make HTTP request with timing"""
        start_time = time.time()
        
        headers = kwargs.get('headers', {})
        if self.token:
            headers['Authorization'] = f'Bearer {self.token}'
        kwargs['headers'] = headers
        
        try:
            url = f"{BACKEND_URL}{endpoint}"
            response = self.session.request(method, url, **kwargs)
            response_time = (time.time() - start_time) * 1000
            
            return response, response_time
        except Exception as e:
            response_time = (time.time() - start_time) * 1000
            print(f"‚ùå Request failed: {e}")
            return None, response_time
    
    def authenticate_and_get_warehouse(self):
        """Authenticate and get warehouse ID"""
        print("\nüîê Authenticating and getting warehouse...")
        
        # Authenticate
        login_data = {
            "phone": WAREHOUSE_OPERATOR_PHONE,
            "password": WAREHOUSE_OPERATOR_PASSWORD
        }
        
        response, response_time = self.make_request('POST', '/auth/login', json=login_data)
        
        if response and response.status_code == 200:
            data = response.json()
            self.token = data.get('access_token')
            
            # Get warehouse
            response, response_time2 = self.make_request('GET', '/operator/warehouses')
            
            if response and response.status_code == 200:
                warehouses = response.json()
                for warehouse in warehouses:
                    if "–ú–æ—Å–∫–≤–∞ –°–∫–ª–∞–¥ ‚Ññ1" in warehouse.get('name', ''):
                        self.warehouse_id = warehouse['id']
                        self.log_result(
                            "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–∫–ª–∞–¥–∞",
                            True,
                            f"–°–∫–ª–∞–¥ –Ω–∞–π–¥–µ–Ω: {warehouse['name']} (ID: {self.warehouse_id})",
                            response_time + response_time2
                        )
                        return True
        
        self.log_result(
            "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –∏ –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–∫–ª–∞–¥–∞",
            False,
            "–ù–µ —É–¥–∞–ª–æ—Å—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞—Ç—å—Å—è –∏–ª–∏ –Ω–∞–π—Ç–∏ —Å–∫–ª–∞–¥",
            response_time
        )
        return False
    
    def check_warehouse_structure(self):
        """Check if warehouse has proper structure (blocks, shelves, cells)"""
        print("\nüèóÔ∏è Checking warehouse structure...")
        
        # Try to get warehouse layout structure
        response, response_time = self.make_request('GET', f'/warehouses/{self.warehouse_id}/layout')
        
        if response and response.status_code == 200:
            data = response.json()
            blocks = data.get('blocks', [])
            total_cells = data.get('total_cells', 0)
            
            self.log_result(
                "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–∫–ª–∞–¥–∞",
                len(blocks) > 0,
                f"–ù–∞–π–¥–µ–Ω–æ –±–ª–æ–∫–æ–≤: {len(blocks)}, –≤—Å–µ–≥–æ —è—á–µ–µ–∫: {total_cells}",
                response_time
            )
            return data
        else:
            # Try alternative endpoint
            response, response_time = self.make_request('GET', f'/warehouses/{self.warehouse_id}/statistics')
            
            if response and response.status_code == 200:
                data = response.json()
                total_cells = data.get('total_cells', 0)
                occupied_cells = data.get('occupied_cells', 0)
                
                self.log_result(
                    "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–∫–ª–∞–¥–∞ (—á–µ—Ä–µ–∑ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É)",
                    total_cells > 0,
                    f"–í—Å–µ–≥–æ —è—á–µ–µ–∫: {total_cells}, –∑–∞–Ω—è—Ç–æ: {occupied_cells}",
                    response_time
                )
                return data
            else:
                self.log_result(
                    "–ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–∫–ª–∞–¥–∞",
                    False,
                    "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Å–∫–ª–∞–¥–∞",
                    response_time
                )
                return None
    
    def check_placement_records_direct(self):
        """Check placement records more directly"""
        print("\nüìã Checking placement records directly...")
        
        # Check through admin endpoint if available
        response, response_time = self.make_request('GET', '/operator/cargo/fully-placed', params={'per_page': 100})
        
        if response and response.status_code == 200:
            data = response.json()
            items = data.get('items', [])
            
            # Look for cargo 25082235
            target_cargo = None
            for item in items:
                if item.get('cargo_number') == '25082235':
                    target_cargo = item
                    break
            
            if target_cargo:
                individual_units = target_cargo.get('individual_units', [])
                placed_units = [u for u in individual_units if u.get('status') == 'placed']
                
                details = f"–ó–∞—è–≤–∫–∞ 25082235 –Ω–∞–π–¥–µ–Ω–∞ —Å {len(individual_units)} –µ–¥–∏–Ω–∏—Ü, –∏–∑ –Ω–∏—Ö —Ä–∞–∑–º–µ—â–µ–Ω–æ: {len(placed_units)}"
                for unit in placed_units:
                    details += f"\n  - {unit.get('individual_number')}: {unit.get('placement_info')}"
                
                self.log_result(
                    "–ü—Ä–æ–≤–µ—Ä–∫–∞ placement_records",
                    len(placed_units) > 0,
                    details,
                    response_time
                )
                return placed_units
            else:
                self.log_result(
                    "–ü—Ä–æ–≤–µ—Ä–∫–∞ placement_records",
                    False,
                    f"–ó–∞—è–≤–∫–∞ 25082235 –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ —Å—Ä–µ–¥–∏ {len(items)} –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã—Ö –∑–∞—è–≤–æ–∫",
                    response_time
                )
                return []
        else:
            error_msg = response.json().get('detail', 'Unknown error') if response else 'Connection failed'
            self.log_result(
                "–ü—Ä–æ–≤–µ—Ä–∫–∞ placement_records",
                False,
                f"–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö: {error_msg}",
                response_time
            )
            return []
    
    def test_layout_with_cargo_detailed(self):
        """Test layout-with-cargo API in detail"""
        print("\nüè≠ Testing layout-with-cargo API in detail...")
        
        response, response_time = self.make_request('GET', f'/warehouses/{self.warehouse_id}/layout-with-cargo')
        
        if response and response.status_code == 200:
            data = response.json()
            
            # Extract all key information
            total_cells = data.get('total_cells', 0)
            occupied_cells = data.get('occupied_cells', 0)
            total_cargo = data.get('total_cargo', 0)
            loading_percentage = data.get('loading_percentage', 0)
            blocks = data.get('blocks', [])
            
            # Count actual occupied cells in blocks
            actual_occupied = 0
            actual_cargo = 0
            
            for block in blocks:
                shelves = block.get('shelves', [])
                for shelf in shelves:
                    cells = shelf.get('cells', [])
                    for cell in cells:
                        if cell.get('is_occupied', False):
                            actual_occupied += 1
                            if cell.get('cargo'):
                                actual_cargo += 1
            
            details = f"API –¥–∞–Ω–Ω—ã–µ: occupied_cells={occupied_cells}, total_cargo={total_cargo}, blocks={len(blocks)}"
            details += f"\n–§–∞–∫—Ç–∏—á–µ—Å–∫–∏–π –ø–æ–¥—Å—á–µ—Ç: occupied_cells={actual_occupied}, cargo={actual_cargo}"
            
            # Check for discrepancy
            discrepancy = (occupied_cells != actual_occupied) or (total_cargo != actual_cargo)
            
            self.log_result(
                "–î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ layout-with-cargo",
                not discrepancy and occupied_cells > 0,
                details,
                response_time
            )
            
            return data
        else:
            error_msg = response.json().get('detail', 'Unknown error') if response else 'Connection failed'
            self.log_result(
                "–î–µ—Ç–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ layout-with-cargo",
                False,
                f"–û—à–∏–±–∫–∞ API: {error_msg}",
                response_time
            )
            return None
    
    def check_warehouse_cells_creation(self):
        """Check if warehouse cells are properly created"""
        print("\nüîß Checking warehouse cells creation...")
        
        # Try to create warehouse layout if it doesn't exist
        response, response_time = self.make_request('POST', f'/warehouses/{self.warehouse_id}/create-layout')
        
        if response and response.status_code == 200:
            data = response.json()
            self.log_result(
                "–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–∫–ª–∞–¥–∞",
                True,
                f"–°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å–∫–ª–∞–¥–∞ —Å–æ–∑–¥–∞–Ω–∞/–æ–±–Ω–æ–≤–ª–µ–Ω–∞: {data.get('message', 'Success')}",
                response_time
            )
            return True
        else:
            # This might be expected if layout already exists
            error_msg = response.json().get('detail', 'Unknown error') if response else 'Connection failed'
            self.log_result(
                "–°–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–∫–ª–∞–¥–∞",
                False,
                f"–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É: {error_msg}",
                response_time
            )
            return False
    
    def test_specific_cell_lookup(self):
        """Test looking up specific cells where cargo should be"""
        print("\nüéØ Testing specific cell lookup...")
        
        # Test cells –ë1-–ü3-–Ø2 and –ë1-–ü3-–Ø3
        target_positions = [
            {"block": 1, "shelf": 3, "cell": 2, "cargo": "25082235/01/02"},
            {"block": 1, "shelf": 3, "cell": 3, "cargo": "25082235/01/01"}
        ]
        
        for pos in target_positions:
            # Try to verify cell directly
            response, response_time = self.make_request(
                'POST', 
                '/operator/placement/verify-cell',
                json={
                    "qr_code": f"001-{pos['block']:02d}-{pos['shelf']:02d}-{pos['cell']:03d}",
                    "warehouse_id": self.warehouse_id
                }
            )
            
            if response and response.status_code == 200:
                data = response.json()
                cell_info = data.get('cell_info', {})
                is_occupied = cell_info.get('is_occupied', False)
                
                self.log_result(
                    f"–ü—Ä–æ–≤–µ—Ä–∫–∞ —è—á–µ–π–∫–∏ –ë{pos['block']}-–ü{pos['shelf']}-–Ø{pos['cell']}",
                    True,
                    f"–Ø—á–µ–π–∫–∞ –Ω–∞–π–¥–µ–Ω–∞, –∑–∞–Ω—è—Ç–∞: {is_occupied}, –¥–∞–Ω–Ω—ã–µ: {cell_info}",
                    response_time
                )
            else:
                error_msg = response.json().get('detail', 'Unknown error') if response else 'Connection failed'
                self.log_result(
                    f"–ü—Ä–æ–≤–µ—Ä–∫–∞ —è—á–µ–π–∫–∏ –ë{pos['block']}-–ü{pos['shelf']}-–Ø{pos['cell']}",
                    False,
                    f"–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ —è—á–µ–π–∫–∏: {error_msg}",
                    response_time
                )
    
    def run_deep_investigation(self):
        """Run complete deep investigation"""
        print("üî¨ –ì–õ–£–ë–û–ö–û–ï –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï: API layout-with-cargo –Ω–µ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–∞–∑–º–µ—â–µ–Ω–Ω—ã–µ –≥—Ä—É–∑—ã")
        print("=" * 100)
        
        # Step 1: Authenticate and get warehouse
        if not self.authenticate_and_get_warehouse():
            return self.generate_report()
        
        # Step 2: Check warehouse structure
        warehouse_structure = self.check_warehouse_structure()
        
        # Step 3: Check placement records
        placement_records = self.check_placement_records_direct()
        
        # Step 4: Test layout-with-cargo in detail
        layout_data = self.test_layout_with_cargo_detailed()
        
        # Step 5: Try to create warehouse cells if needed
        self.check_warehouse_cells_creation()
        
        # Step 6: Test specific cell lookup
        self.test_specific_cell_lookup()
        
        # Step 7: Re-test layout after potential fixes
        print("\nüîÑ Re-testing layout-with-cargo after potential fixes...")
        final_layout_data = self.test_layout_with_cargo_detailed()
        
        return self.generate_report()
    
    def generate_report(self):
        """Generate final test report"""
        total_time = time.time() - self.start_time
        total_tests = len(self.test_results)
        passed_tests = len([r for r in self.test_results if r['success']])
        success_rate = (passed_tests / total_tests * 100) if total_tests > 0 else 0
        
        print("\n" + "=" * 100)
        print("üî¨ –ì–õ–£–ë–û–ö–û–ï –ò–°–°–õ–ï–î–û–í–ê–ù–ò–ï –ó–ê–í–ï–†–®–ï–ù–û")
        print("=" * 100)
        
        print(f"\nüìä –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:")
        print(f"- –í—Å–µ–≥–æ —Ç–µ—Å—Ç–æ–≤: {total_tests}")
        print(f"- –£—Å–ø–µ—à–Ω—ã—Ö: {passed_tests}")
        print(f"- –ù–µ—É—Å–ø–µ—à–Ω—ã—Ö: {total_tests - passed_tests}")
        print(f"- Success Rate: {success_rate:.1f}%")
        print(f"- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è: {total_time:.1f} —Å–µ–∫—É–Ω–¥")
        
        print(f"\nüìã –î–ï–¢–ê–õ–¨–ù–´–ï –†–ï–ó–£–õ–¨–¢–ê–¢–´:")
        for result in self.test_results:
            print(f"{result['status']} {result['test']}: {result['details']} ({result['response_time']})")
        
        print(f"\nüéØ –ö–†–ò–¢–ò–ß–ï–°–ö–ò–ô –í–´–í–û–î:")
        if success_rate >= 70:
            print("‚úÖ –ü–†–û–ë–õ–ï–ú–ê –†–ï–®–ï–ù–ê –ò–õ–ò –î–ò–ê–ì–ù–û–°–¢–ò–†–û–í–ê–ù–ê! Layout-with-cargo API —Ä–∞–±–æ—Ç–∞–µ—Ç –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ.")
        else:
            print("‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –ü–†–û–ë–õ–ï–ú–ê –ü–û–î–¢–í–ï–†–ñ–î–ï–ù–ê! Layout-with-cargo API –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –ø—Ä–∞–≤–∏–ª—å–Ω–æ.")
        
        print(f"\nüîß –¢–ï–•–ù–ò–ß–ï–°–ö–ò–ï –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:")
        print("1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã —Å–∫–ª–∞–¥–∞ (–±–ª–æ–∫–∏, –ø–æ–ª–∫–∏, —è—á–µ–π–∫–∏)")
        print("2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–≤—è–∑—å –º–µ–∂–¥—É placement_records –∏ warehouse_cells")
        print("3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏–∫—É API layout-with-cargo –≤ backend –∫–æ–¥–µ")
        print("4. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é –ø–æ warehouse_id –≤ –∑–∞–ø—Ä–æ—Å–∞—Ö –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö")
        
        return {
            'success_rate': success_rate,
            'total_tests': total_tests,
            'passed_tests': passed_tests,
            'execution_time': total_time,
            'results': self.test_results
        }

def main():
    """Main execution function"""
    investigation = LayoutAPIDeepInvestigation()
    results = investigation.run_deep_investigation()
    
    # Exit with appropriate code
    if results['success_rate'] >= 70:
        sys.exit(0)
    else:
        sys.exit(1)

if __name__ == "__main__":
    main()